var lp=Object.defineProperty;var hp=(n,e,t)=>e in n?lp(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var y=(n,e,t)=>hp(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const w={currentView:Symbol("currentView"),cursorTagStart:Symbol("cursorTagStart"),computedKeys:Symbol("computedKeys"),destroy:Symbol("destroy"),getChildren:Symbol("getChildren"),holder:Symbol("holder"),id:Symbol("id"),identifier:Symbol("identifier"),index:Symbol("index"),init:Symbol("init"),inputEvents:Symbol("inputEvents"),intervals:Symbol("intervals"),launched:Symbol("launched"),level:Symbol("level"),methodKeys:Symbol("methodKeys"),originalState:Symbol("originalState"),propKeys:Symbol("propKeys"),raw:Symbol("raw"),ready:Symbol("ready"),renderer:Symbol("renderer"),routes:Symbol("routes"),routerHooks:Symbol("routerHooks"),settings:Symbol("settings"),state:Symbol("state"),stateKeys:Symbol("stateKeys"),textnode:Symbol("textnode"),timeouts:Symbol("timeouts"),type:Symbol("type"),watchers:Symbol("watchers"),watchKeys:Symbol("watchKeys"),wrapper:Symbol("wrapper"),children:Symbol.for("children"),components:Symbol.for("components"),config:Symbol.for("config"),isSlot:Symbol.for("isSlot"),props:Symbol.for("props"),slots:Symbol.for("slots"),componentType:Symbol.for("componentType"),isComponent:Symbol.for("isComponent"),effects:Symbol.for("effects"),removeGlobalEffects:Symbol.for("removeGlobalEffects")},gt={[w.settings]:{},get(n,e=null){return n in this[w.settings]?this[w.settings][n]:e},set(n,e){typeof n=="object"?Object.keys(n).forEach(t=>{this.set(t,n[t])}):this[w.settings][n]=e}},on=()=>{},ca=()=>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),ed=n=>{const e=gt.get("debugLevel"),t={};return Object.defineProperty(t,"info",{get(){return(e>=1||Array.isArray(e)&&e.indexOf("info")>-1)&&console.info.bind(window.console,`%c ⚡️ ${n} %c ${ca()}`,"background-color: #0284c7; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||on}}),Object.defineProperty(t,"warn",{get(){return(e>=1||Array.isArray(e)&&e.indexOf("warn")>-1)&&console.warn.bind(window.console,`%c ⚡️ ${n} %c ${ca()}`,"background-color: #fbbf24; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||on}}),Object.defineProperty(t,"error",{get(){return(e>=1||Array.isArray(e)&&e.indexOf("error")>-1)&&console.error.bind(window.console,`%c ⚡️ ${n} %c ${ca()}`,"background-color: #dc2626; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||on}}),Object.defineProperty(t,"debug",{get(){return(e>=2||Array.isArray(e)&&e.indexOf("debug")>-1)&&console.debug.bind(window.console,`%c ⚡️ ${n} %c (${new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})`,"background-color: #e2e8f0; color: #334155; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||on}}),t};let ve;const cp=()=>{ve=ed("Blits")},an={aliceblue:"0xf0f8ffff",antiquewhite:"0xfaebd7ff",aqua:"0xffffff00",aquamarine:"0x7fffd4ff",azure:"0xf0ffffff",beige:"0xf5f5dcff",bisque:"0xffe4c4ff",black:"0x000000ff",blanchedalmond:"0xffebcdff",blue:"0x0000ffff",blueviolet:"0x8a2be2ff",brown:"0xa52a2aff",burlywood:"0xdeb887ff",cadetblue:"0x5f9ea0ff",chartreuse:"0x7fff00ff",chocolate:"0xd2691eff",coral:"0xff7f50ff",cornflowerblue:"0x6495edff",cornsilk:"0xfff8dcff",crimson:"0xdc143cff",cyan:"0x00ffffff",darkblue:"0x00008bff",darkcyan:"0x008b8bff",darkgoldenrod:"0xb8860bff",darkgray:"0xa9a9a9ff",darkgreen:"0x006400ff",darkgrey:"0xa9a9a9ff",darkkhaki:"0xbdb76bff",darkmagenta:"0x8b008bff",darkolivegreen:"0x556b2fff",darkorange:"0xff8c00ff",darkorchid:"0x9932ccff",darkred:"0x8b0000ff",darksalmon:"0xe9967aff",darkseagreen:"0x8fbc8fff",darkslateblue:"0x483d8bff",darkslategray:"0x2f4f4fff",darkslategrey:"0x2f4f4fff",darkturquoise:"0x00ced1ff",darkviolet:"0x9400d3ff",deeppink:"0xff1493ff",deepskyblue:"0x00bfffff",dimgray:"0x696969ff",dimgrey:"0x696969ff",dodgerblue:"0x1e90ffff",firebrick:"0xb22222ff",floralwhite:"0xfffaf0ff",forestgreen:"0x228b22ff",fuchsia:"0xff00ffff",gainsboro:"0xdcdcdcff",ghostwhite:"0xf8f8ffff",gold:"0xffd700ff",goldenrod:"0xdaa520ff",gray:"0x808080ff",green:"0x008000ff",greenyellow:"0xadff2fff",grey:"0x808080ff",honeydew:"0xf0fff0ff",hotpink:"0xff69b4ff",indianred:"0xcd5c5cff",indigo:"0x4b0082ff",ivory:"0xfffff0ff",khaki:"0xf0e68cff",lavender:"0xe6e6faff",lavenderblush:"0xfff0f5ff",lawngreen:"0x7cfc00ff",lemonchiffon:"0xfffacdff",lightblue:"0xadd8e6ff",lightcoral:"0xf08080ff",lightcyan:"0xe0ffffff",lightgoldenrodyellow:"0xfafad2ff",lightgray:"0xd3d3d3ff",lightgreen:"0x90ee90ff",lightgrey:"0xd3d3d3ff",lightpink:"0xffb6c1ff",lightsalmon:"0xffa07aff",lightseagreen:"0x20b2aaff",lightskyblue:"0x87cefaff",lightslategray:"0x778899ff",lightslategrey:"0x778899ff",lightsteelblue:"0xb0c4deff",lightyellow:"0xffffe0ff",lime:"0x00ff00ff",limegreen:"0x32cd32ff",linen:"0xfaf0e6ff",magenta:"0xff00ffff",maroon:"0x800000ff",mediumaquamarine:"0x66cdaaff",mediumblue:"0x0000cdff",mediumorchid:"0xba55d3ff",mediumpurple:"0x9370dbff",mediumseagreen:"0x3cb371ff",mediumslateblue:"0x7b68eeff",mediumspringgreen:"0x00fa9aff",mediumturquoise:"0x48d1ccff",mediumvioletred:"0xc71585ff",midnightblue:"0x191970ff",mintcream:"0xf5fffaff",mistyrose:"0xffe4e1ff",moccasin:"0xffe4b5ff",navajowhite:"0xffdeadff",navy:"0x000080ff",oldlace:"0xfdf5e6ff",olive:"0x808000ff",olivedrab:"0x6b8e23ff",orange:"0xffa500ff",orangered:"0xff4500ff",orchid:"0xda70d6ff",palegoldenrod:"0xeee8aaff",palegreen:"0x98fb98ff",paleturquoise:"0xafeeeeff",palevioletred:"0xdb7093ff",papayawhip:"0xffefd5ff",peachpuff:"0xffdab9ff",peru:"0xcd853fff",pink:"0xffc0cbff",plum:"0xdda0ddff",powderblue:"0xb0e0e6ff",purple:"0x800080ff",rebeccapurple:"0x663399ff",red:"0xff0000ff",rosybrown:"0xbc8f8fff",royalblue:"0x4169e1ff",saddlebrown:"0x8b4513ff",salmon:"0xfa8072ff",sandybrown:"0xf4a460ff",seagreen:"0x2e8b57ff",seashell:"0xfff5eeff",sienna:"0xa0522dff",silver:"0xc0c0c0ff",skyblue:"0x87ceebff",slateblue:"0x6a5acdff",slategray:"0x708090ff",slategrey:"0x708090ff",snow:"0xfffafaff",springgreen:"0x00ff7fff",steelblue:"0x4682b4ff",tan:"0xd2b48cff",teal:"0x008080ff",thistle:"0xd8bfd8ff",tomato:"0xff6347ff",transparent:"0x00000000",turquoise:"0x40e0d0ff",violet:"0xee82eeff",wheat:"0xf5deb3ff",white:"0xffffffff",whitesmoke:"0xf5f5f5ff",yellow:"0xffff00ff",yellowgreen:"0x9acd32ff"},up=/^#?([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i,dp=/^(rgba?)\((\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*),(\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*),(\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*)(,(\s*(-?\d+(?:\.\d+)?)\s*))?\)$/,fp=/^(hsla?)\((\s*(360|3[0-5][0-9]|[12]?[0-9]{1,2})\s*),(\s*(100|[1-9]?[0-9])\s*)%,(\s*(100|[1-9]?[0-9])\s*)%(,(\s*(1|0(?:\.\d+)?)\s*))?\)$/,ua={},ln=n=>{if(ua[n]!==void 0)return ua[n];const e=parseInt(n).toString(16).padStart(2,"0");return ua[n]=e,e},zs={normalize:(n="",e="0xffffffff")=>{if(n=n.toString(),n.startsWith("0x")&&n.length===10)return n;if(an[n]!==void 0)return an[n];if(up.test(n)){n=n.replace("#","").toLowerCase(),n.length===3&&(n=n.split("").map(s=>s+s).join(""));const i="0x"+n.padEnd(8,"f");return an[n]=i,i}const t=dp.exec(n);if(t){const i=ln(t[3]),s=ln(t[5]),r=ln(t[7]);let o="ff";if(t[10]&&t[1]==="rgba"){const l=Math.min(Math.max(Math.round(parseFloat(t[10])*255),0),255);o=ln(l)}const a="0x"+i+s+r+o;return an[n]=a,a}return fp.test(n)?(console.warn("HSL(A) color format is not supported yet"),"0xffffffff"):e}},gp=(n="",e,t,i=null)=>{let s=0,r=0,o=[],a=null,l=0;const h=/^<\/?([a-zA-Z0-9_\-.]+)\s*/,c=/^\s*(\/?>)\s*/,u=/^([A-Za-z0-9:.\-_@$]+)=\s*(["'])/,d=/^<>\s*/,f=/^\s*(<\/>)\s*/,g=()=>{n=m(n);try{return p(T),L(o)}catch(I){throw(I.name=="TemplateParseError"||I.name=="TemplateStructureError")&&(I.message=`${I.message}
${I.context}`),I}},p=I=>{s>=n.length||I()},m=I=>I.replace(/<!--.*?-->/gms,"").replace(/\r?\n\s*\r\n/gm," ").replace(/\r?\n\s*(\S)/gm," $1").replace(/\r?\n/g,"").trim(),_=I=>{const O=n.slice(s).match(I);return O&&(r=s,s+=O[0].length),O},T=()=>{_(d)?(o.push({[Symbol.for("componentType")]:null,[w.type]:"opening",[w.level]:l,[w.cursorTagStart]:r}),l++,p(T)):p(S)},S=()=>{_(f)?(l--,o.push({[Symbol.for("componentType")]:null,[w.type]:"closing",[w.level]:l}),p(T)):p(v)},v=()=>{const I=_(h);if(I)a={[Symbol.for("componentType")]:I[1],[w.level]:l,[w.cursorTagStart]:r},I[0].startsWith("</")?(l--,a[w.type]="closing",a[w.level]=l):(a[w.type]="opening",l++),p(E);else throw F("InvalidTag")},E=()=>{const I=_(c);if(I){if(I[1]==="/>"){if(a[w.type]==="closing")throw F("InvalidClosingTag");a[w.type]="self-closing",l--}if(a[w.type]==="opening"){const O=n.slice(s,n.indexOf("<",s));O&&(a.content=O,s+=O.length)}o.push(a),p(T)}else p(C)},C=()=>{const I=_(u);if(I){if(a[w.type]==="closing")throw F("AttributesInClosingTag");const O=I[2],V=new RegExp(`^(.*?)${O}\\s*`),B=_(V);if(B){const U=b(I[1],B[1]);a[U.name]=U.value,p(E)}else throw F("MissingOrInvalidAttributeValue")}else throw F("InvalidAttribute")},b=(I,O)=>{if(I.includes(".")){const[V,B]=I.split(".");return{name:V,value:`{${B}: ${O}}`}}return["color",":color",":effects","effects"].includes(I)?A(I,O):{name:I,value:O}},A=(I,O)=>{let V=O,B=zs.normalize(V,null);if(B===null){const U=/'([^']+)'/g;let Y,W=0,Q="";for(;(Y=U.exec(O))!==null;){const te=Y[1],re=Y.index,J=Y[0].length;Q+=O.slice(W,re),B=zs.normalize(te,null),B===null?Q+=O.slice(re,re+J):Q+=`'${B}'`,W=re+J}Q+=O.slice(W),V=Q}else V=B;return{name:I,value:V}},L=I=>{let O=[],V=!1,B={children:[]},U=B;for(let Y=0;Y<I.length;Y++){let W=I[Y];if(W[w.level]===0&&W[w.type]!=="closing"){if(V)throw z("MultipleTopLevelTags",W);if(W[":for"]!==void 0)throw z("ForAttributeOnRootElement",W);V=!0}if(W[w.type]==="opening")O.push({[w.level]:W[w.level],[w.type]:W[w.type],[w.cursorTagStart]:W[w.cursorTagStart],[Symbol.for("componentType")]:W[Symbol.for("componentType")],parent:U});else if(W[w.type]==="closing"){const te=O.length===0;let re=!1,J=!1;if(te||(re=O[O.length-1][w.level]!==W[w.level],J=O[O.length-1][Symbol.for("componentType")]!==W[Symbol.for("componentType")]),te||re||J)throw z("MismatchedClosingTag",W);U=O.pop().parent}const Q={...W};delete Q[w.type],delete Q[w.level],delete Q[w.cursorTagStart],W[w.type]==="opening"?(Y+1<I.length&&I[Y+1][w.type]!=="closing"&&(Q.children=[]),U.children.push(Q),U=Q):W[w.type]==="self-closing"&&U.children.push(Q)}if(O.length>0)throw z("UnclosedTags",O);return B},R=10,M=50,F=I=>{const O=k();I=`${I} in ${O}`;const V=new Error(I);V.name="TemplateParseError";const B=Math.max(0,r-R),U=Math.min(n.length,s+M),Y=n.slice(B,U),W=s-B;return V.context=G(W,Y),V},z=(I,O)=>{const V=k();I=`${I} in ${V}`;const B=new Error(I);B.name="TemplateStructureError",Array.isArray(O)?B.context=O.map(Y=>U(Y)).join(`
`):B.context=U(O);function U(Y){const W=Math.max(0,Y[w.cursorTagStart]-R),Q=n.slice(W,W+M);return G(R,Q)}return B},G=(I,O)=>{const V=" ".repeat(I)+"^";return`
${O}
${V}
`},k=()=>i||"Blits.Application";return g()};let le,co;function pp(n={children:[]},e=!1){const t={renderCode:["const elms = []","let componentType","const rootComponent = component","let propData","let slotComponent","let inSlot = false","let slotChildCounter = 0"],effectsCode:[],context:{props:[],components:this.components}};return le=-1,co=e,co===!0&&t.renderCode.push(`
      function propInComponent(prop, kind="dynamic") {
        const property = prop.includes('.') ? prop.split('.')[0] : prop
        if (kind === 'reactive' || prop.includes('.') === false) {
          if (property in component === false) {
            Log.warn('Property ' +  property + ' was accessed during render but is not defined on instance')
          }
        } else {
          const nestedKeys = prop.split('.')
          let base = component
          for(let i =0; i<nestedKeys.length;i++){
            if (base[nestedKeys[i]] === undefined) {
              Log.warn('Property ' +  nestedKeys.slice(0,i+1).join('.') + ' was accessed during render but is not defined on instance')
            }
            base = base[nestedKeys[i]]
          }
        }
      }
    `),id.call(t,n),t.renderCode.push("return elms"),{render:new Function("parent","component","context","components","effect","getRaw","Log",t.renderCode.join(`
`)),effects:t.effectsCode.map(i=>new Function("component","elms","context","components","rootComponent","effect",i)),context:t.context}}const mp=function(n){const e=/\$\$?\w+(\.\w+)?/g,t=n.match(e);if(t!==null){const i=/\$shader/;return t.filter(s=>!i.test(s))}else return!1},Kh=function(n,e,t="dynamic"){const i=mp(n);if(i!==!1)for(let s=0;s<i.length;s++){let r=i[s];t==="reactive"&&r.includes(".")&&(r=r.split(".")[0]),e.push(`propInComponent('${r.replace("$","")}', '${t}')`)}},uo=function(n,e=!1,t={key:!1,component:"component.",forceEffect:!1,forloop:!1}){const i=t.forceEffect?this.effectsCode:this.renderCode;e&&i.push(`parent = ${e}`),"key"in n&&(t.key=ot(n.key,t.component));const s=t.key?`elms[${le}][${t.key}]`:`elms[${le}]`;t.key&&i.push(`
      if(elms[${le}] === undefined) {
        elms[${le}] = {}
      }
    `),i.push(`const elementConfig${le} = {}`),t.forloop&&i.push(`if(${s} === undefined) {`),i.push(`
    ${s} = this.element({parent: parent || 'root'}, inSlot === true ? slotComponent : component)
  `),t.forloop&&i.push("}");const r=n.children;delete n.children,n[Symbol.for("componentType")]==="Slot"&&i.push(`elementConfig${le}[Symbol.for('isSlot')] = true`),Object.keys(n).forEach(o=>{if(o==="slot"&&i.push(`
        elementConfig${le}['parent'] = slotComponent[Symbol.for('slots')] !== undefined && Array.isArray(slotComponent[Symbol.for('slots')]) === true && slotComponent[Symbol.for('slots')].filter(slot => slot.ref === '${n.slot}').shift() || parent
      `),o==="key")return;const a=n[o];if(sd(o)){if(t.holder&&o===":color")return;t.holder?this.effectsCode.push(`
        if(typeof skip${le} === 'undefined' ||
          skip${le}.indexOf('${o.substring(1)}') === -1)
          ${s}.set('${o.substring(1)}', ${ot(n[o],t.component)})
        `):this.effectsCode.push(`
            ${s}.set('${o.substring(1)}', ${ot(n[o],t.component)})
          `),co===!0&&t.component!=="scope."&&a.includes("$")&&Kh(a,i,"reactive"),i.push(`elementConfig${le}['${o.substring(1)}'] = ${ot(a,t.component)}`)}else co===!0&&t.component!=="scope."&&a.includes("$")&&Kh(a,i),i.push(`elementConfig${le}['${o}'] = ${Yl(a,o,t.component)}`)}),t.holder===!0&&i.push(`
    const skip${le} = []
    if(typeof cmp${le} !== 'undefined') {
      for(let key in cmp${le}[Symbol.for('config')].props) {
        delete elementConfig${le}[cmp${le}[Symbol.for('config')].props[key]]
        skip${le}.push(cmp${le}[Symbol.for('config')].props[key])
      }
    }
    `),t.forloop&&i.push(`if(${s}.nodeId === undefined) {`),i.push(`${s}.populate(elementConfig${le})`),i.push(`
    if(inSlot === true) {
      slotChildCounter -= 1
    }
  `),t.forloop&&i.push("}"),r&&id.call(this,{children:r},`${s}`,t)},td=function(n,e=!1,t={key:!1,component:"component.",forceEffect:!1,holder:!1,forloop:!1}){const i=t.forceEffect?this.effectsCode:this.renderCode;i.push(`
    const cmp${le} =
      (context.components && context.components['${n[Symbol.for("componentType")]}']) || components['${n[Symbol.for("componentType")]}']
  `),"key"in n&&(t.key=ot(n.key,t.component));const s=n.children;delete n.children,uo.call(this,n,e,{...t,holder:!0}),e=t.key?`elms[${le}][${t.key}]`:`elms[${le}]`,le++;const r=t.key?`elms[${le}][${t.key}]`:`elms[${le}]`;t.key&&i.push(`
      if(elms[${le}] === undefined) {
        elms[${le}] = {}
      }
    `),e&&i.push(`parent = ${e}`),i.push(`const props${le} = {}`),t.forloop&&i.push(`if(${r} === undefined) {`),Object.keys(n).forEach(o=>{sd(o)?(this.effectsCode.push(`
        ${r}[Symbol.for('props')]['${o.substring(1)}'] = ${ot(n[o],t.component)}`),i.push(`
        propData = ${ot(n[o],t.component)}
        if (Array.isArray(propData) === true) {
          propData = getRaw(propData).slice(0)
        }
        props${le}['${o.substring(1)}'] = propData`)):i.push(`props${le}['${o}'] = ${Yl(n[o],o,t.component)}`)}),i.push(`
    componentType = props${le}['is'] || '${n[Symbol.for("componentType")]}'

    let component${le}
    if(typeof componentType === 'string') {
      component${le} = context.components && context.components[componentType] || components[componentType]
      if(!component${le}) {
        throw new Error('Component "${n[Symbol.for("componentType")]}" not found')
      }
    } else if(typeof componentType === 'function' && componentType[Symbol.for('isComponent')] === true) {
      component${le} = componentType
    }

    ${r} = component${le}.call(null, {props: props${le}}, ${e}, component)

    if (${r}[Symbol.for('slots')][0]) {
      parent = ${r}[Symbol.for('slots')][0]
      slotComponent = ${r}
      inSlot = true
    } else {
      parent = ${r}[Symbol.for('children')][0]
    }
  `),t.forloop&&i.push("}"),s&&(t.forloop||i.push(`
        if(inSlot === true) {
          slotChildCounter = ${s.length}  + 1
        }
      `),le++,uo.call(this,{children:s},!1,{...t})),t.forloop||i.push(`
      if (inSlot === true && slotChildCounter === 0) {
        inSlot = false
      }
    `)},_p=function(n,e){const t=n[":for"];delete n[":for"];const i=n.range||n[":range"]||"{}";delete n.range,delete n[":range"];const s=n.key,r=ot(s,"scope."),o=!(n.$shallow&&n.$shallow.toLowerCase()==="false");delete n.$shallow,delete n.key;const l=/(.+)\s+in\s+(.+)/gi.exec(t),[h,c]=l[1].replace("(","").replace(")","").split(/\s*,\s*/),u=new RegExp(`(scope\\.(?!${h}\\.|${c}|key)(\\w+))`,"gi"),d={renderCode:[],effectsCode:[],context:{props:[],components:this.components}};if(e&&d.renderCode.push(`parent = ${e}`),c!==void 0){const b=new RegExp(`\\$${c}(?!['\\w])`).exec(s);Array.isArray(b)&&d.renderCode.push(`console.warn(" Using '${c}' in the key, like key=${s},  is not recommended")`)}const f=le;d.renderCode.push(`
    const created${f} = []

    let from${f}
    let to${f}

    const forloop${f} = (collection = [], elms, created) => {
      const rawCollection = getRaw(collection)
      const keys = new Set()
      let l = rawCollection.length

      const range = ${ot(i)} || {}
      from${f} = range['from'] || 0
      to${f} = 'to' in range ? range['to'] : rawCollection.length

      while(l--) {
        const ${h} = rawCollection[l]
  `),c!==void 0&&d.renderCode.push(`
        const ${c} = l
    `),d.renderCode.push(`
        if(l < to${f} && l >= from${f}) {
          keys.add('' +  ${ot(s,"")||"l"})
        }
      }
  `);const g=d.renderCode.length;d.renderCode.push(`
      created.length = 0
      const length = rawCollection.length
      const effects = []
      for(let __index = 0; __index < length; __index++) {
        if(__index < from${f} || __index >= to${f}) continue
        const scope = Object.create(component)
        parent = ${e}
        scope['${h}'] = rawCollection[__index]
  `),c!==""&&d.renderCode.push(`
        scope['${c}'] = __index
    `),d.renderCode.push(`
        scope['key'] = '' + ${r||"__index"}
  `),"ref"in n&&n.ref.indexOf("$")===-1&&(d.renderCode.push(`
        scope['__ref'] = '${n.ref}' + __index
    `),n.ref="$__ref"),d.renderCode.push(`
        created.push(scope.key)
  `),n[Symbol.for("componentType")]==="Element"||n[Symbol.for("componentType")]==="Slot"||n[Symbol.for("componentType")]==="Text"?(n[Symbol.for("componentType")]==="Text"&&(n.__textnode="true"),uo.call(d,n,e,{key:"scope.key",component:"scope.",forceEffect:!1,forloop:!0})):td.call(d,n,!1,{key:"scope.key",component:"scope.",forceEffect:!1,forloop:!0});const p=d.effectsCode.filter(C=>[...C.matchAll(u)].length===0),m=d.effectsCode.filter(C=>[...C.matchAll(u)].length!==0);o===!1&&d.renderCode.push(`
      scope['${h}'] = null
      scope['${h}'] = collection[__index]
  `),p.forEach((C,b)=>{const A=C.indexOf(`scope.${b}`)>-1?`'${ot(l[2],"")}'`:null;C.indexOf("Symbol.for('props')")===-1?d.renderCode.push(`
        let eff${b} = () => {
          ${C}
        }
        effect(eff${b}, ${A})
        effects.push(eff${b})
        component[Symbol.for('effects')].push(eff${b})
      `):d.renderCode.push(`
        ${C}
      `)}),d.renderCode.push(`
    }
    return effects
  }`);const _=[];_.push(`
      let i = created.length

      while (i--) {
        if (keys.has(created[i]) === false) {
          const key = created[i]
  `);const T=le;for(let C=f;C<=T;C++)_.push(`
          elms[${C}][key] && elms[${C}][key].destroy()
          delete elms[${C}][key]
      `);_.push(`
      }
    }
  `),d.renderCode.splice(g,0,..._);let S=`${ot(l[2],"")}`;S&&S.includes(".")&&(S=S.match(/[^.]+$/)[0]);const v=/\$([^,} ]+)/g,E=[...i.matchAll(v)].map(C=>`'${C[1]}'`);d.renderCode.push(`
    let forEffects${f}
    const eff${f} = () => {
      component[Symbol.for('removeGlobalEffects')](forEffects${f})
      forEffects${f} = null
      forEffects${f} = forloop${f}(${Yl(l[2],":for")}, elms, created${f})
    }

    component[Symbol.for('effects')].push(eff${f})

    effect(eff${f}, ['${S}', ${E.join(",")}] )
  `),m.forEach((C,b)=>{const A=[...C.matchAll(u)];let L=A.length;const R=[];for(;L--;){const M=A[L],F=`component.${M[2]}`;R.indexOf(F)===-1&&R.push(F),M[2]!==h&&(C=C.substring(0,M.index)+F+C.substring(M.index+M[1].length))}d.renderCode.push(`
      const eff${f}_${b} = () => {
        void ${R.join(", ")}
        for(let __index = 0; __index < ${ot(l[2])}.length; __index++) {
          if(__index < from${f} || __index >= to${f}) continue
          const scope = {}
          scope['${c}'] = __index
          scope['${h}'] = ${ot(l[2])}[__index]
          scope['key'] = ${r||"__index"}
    `),d.renderCode.push(`
          ${C}
        }
      }
      component[Symbol.for('effects')].push(eff${f}_${b})
      effect(eff${f}_${b})
    `)}),this.renderCode.push(d.renderCode.join(`
`))},id=function(n,e=!1,t={}){n.children&&n.children.forEach(i=>{le++,Object.keys(i).indexOf(":for")>-1?_p.call(this,i,e):i[Symbol.for("componentType")]==="Element"||i[Symbol.for("componentType")]==="Slot"||i[Symbol.for("componentType")]==="Text"||i[Symbol.for("componentType")]==="Layout"?(i[Symbol.for("componentType")]==="Text"&&(i.__textnode="true"),i[Symbol.for("componentType")]==="Layout"&&(i.__layout="true"),uo.call(this,i,e,t)):td.call(this,i,e,t)})},ot=(n,e="component.")=>{if(n===void 0)return n;const t=/('.*?')+/gi,i=/\$(\$(?=\$)|\$?)/g,s=n.matchAll(t),r=[];let o=0;for(const a of s)r.push(a[0]),n=n.replace(a[0],`[@@REPLACEMENT${o}@@]`),o++;return n=n.replace(i,(a,l)=>{if(l==="")return e;if(l==="$")return e+"$"}),r.forEach((a,l)=>{n=n.replace(`[@@REPLACEMENT${l}@@]`,a)}),n},Yl=(n="",e=!1,t="component.")=>{const i=/\$\w+/gi;let s;if(e==="content")if(n.startsWith("$"))s=`${t}${n.replace("$","")}`;else{const r=n.replace(/\\\\/g,"__DOUBLE_BACKSLASH__").replace(/(^|[^\\])'/g,"$1\\'").replace(/__DOUBLE_BACKSLASH__/g,"\\\\");s=`'${xp(r,t)}'`}else if(e!=="color"&&/[^0-9%\s.eE]/.test(n)===!1&&!isNaN(parseFloat(n))){if(s=parseFloat(n),n.endsWith("%")){const o={w:"width",width:"width",x:"width",h:"height",height:"height",y:"height"}[e];o&&(s=`parent.node.${o} * (${s} / 100)`)}}else if(n.toLowerCase()==="true")s=!0;else if(n.toLowerCase()==="false")s=!1;else if(e.startsWith("@")&&n){const r=t.slice(0,-1);s=`${r}['${n.replace("$","")}'] && ${r}['${n.replace("$","")}'].bind(${r})`}else if(n.startsWith("$"))s=`${t}${n.replace("$","")}`;else if(i.exec(n)){const r=/\w+\s*:\s*(?:[^\s,}]+|".*?"|'.*?')/g,o=n.match(r);if(s={},o)for(let a=0;a<o.length;a++){const l=o[a].split(/\s*:\s*/);l&&yp(l[0],l[1],t,s)}return Tp(s)}else s=`"${n}"`;return s},sd=n=>n.startsWith(":"),xp=(n,e)=>{const t=/\{\{\s*(\$\S+)\s*\}\}/g,i=[...n.matchAll(t)];if(i.length)for(let[s,r]of i)n=n.replace(s,`${r.replace("$",`'+${e}`)}+'`);return n},yp=(n,e,t,i)=>{e.startsWith("$")?i[n]=`${t}${e.replace("$","")}`:i[n]=e},Tp=n=>{const e=[];return Object.keys(n).forEach(t=>{e.push(`${t}: ${n[t]}`)}),` { ${e.join(", ")} }`},Xh={};let Sp=0;const vp=n=>`BlitsComponent::${n}_${Xh[n]=(Xh[n]||0)+1}`,Ep=()=>++Sp,zi={},qa=(n,e,t,i=[])=>{zi[e]&&zi[e][n]&&zi[e][n].apply(t,i)},bp=(n,e,t)=>{const i=w[n];zi[e]&&zi[e][i]&&zi[e][i].apply(t)},Ap=(n={},e)=>{zi[e]={},[...Object.keys(n),...Object.getOwnPropertySymbols(n)].forEach(i=>{typeof n[i]=="function"&&(zi[e][i]=n[i])})};let Gs=null,Ms=null,Yo=!1;const Rp=()=>{Yo=!0},Cp=()=>{Yo=!1},fo=new WeakMap,$n=new Map,jh=n=>{if($n.size!==0)for(const[e,t]of $n){if(n.indexOf(e)===-1)continue;const i=fo.get(t);if(i!==void 0)for(const s of i.values())s.delete(e),$n.delete(e)}},zn=(n,e,t=!1)=>{if(Gs!==null){if(Yo)return;if(Array.isArray(Ms)===!0){if(Ms.includes(e)===!1)return}else if(Ms!==null&&e!==Ms)return;let i=fo.get(n);i===void 0&&(i=new Map,fo.set(n,i));let s=i.get(e);s===void 0&&(s=new Set,i.set(e,s)),s.add(Gs),t===!0&&$n.set(Gs,n)}},Hs=(n,e,t=!1)=>{if(Yo===!0)return;const i=fo.get(n);if(i===void 0)return;const s=i.get(e);if(s!==void 0)for(let r of s)r(t)},hn=(n,e=null)=>{Gs=n,Ms=e,Gs(),Gs=null,Ms=null},Qa=(n,e)=>{if(n===e)return!0;if(n.length!==e.length)return!1;let t=n.length;for(;t--;){const i=n[t],s=e[t];if(Array.isArray(i)&&Array.isArray(s)){if(Qa(i,s)===!1)return!1}else if(typeof i=="object"&&i!==null&&typeof s=="object"&&s!==null){if(Qa(Object.entries(i),Object.entries(s))===!1)return!1}else if(i!==s)return!1}return!0},Gn=["push","pop","shift","unshift","splice","sort"],qh=new WeakMap,is=n=>{const e=n&&n[w.raw];return e?is(e):n},Za=(n,e=null,t,i)=>{if(typeof n=="object"&&Array.isArray(n)===!1&&Object.getPrototypeOf(n)!==Object.prototype)return n;const s=qh.get(n);if(s!==void 0)return s;const r={get(a,l,h){return l===w.raw?n:Array.isArray(a)===!0?typeof a[l]=="object"&&a[l]!==null?(Array.isArray(a[l])===!0&&zn(a,l,i),Za(is(a[l]),a,l)):Gn.indexOf(l)!==-1?function(...c){Rp();const u=a[l].apply(this,c);return Cp(),Hs(e,t),u}:l==="length"?n.length:Reflect.get(a,l,h):typeof a[l]=="object"&&a[l]!==null?(Array.isArray(a[l])===!0&&zn(a,l,i),Za(is(a[l]),a,l)):(zn(a,l,i),Reflect.get(a,l,h))},set(a,l,h,c){const u=is(a[l]),d=is(h);let f=!0,g=!1;return Array.isArray(d)===!0&&Array.isArray(u)===!0?g=Qa(u,d):u===d&&(g=!0),g===!1&&(typeof h=="object"&&(Array.isArray(h)===!0?h=is(h).slice(0):h!==null&&a[l]!==null&&a[l]!==void 0&&Array.isArray(a)===!1&&Object.getPrototypeOf(h)===Object.prototype&&(h=Object.assign(c[l],h))),f=Reflect.set(a,l,h,c)),f===!0&&g===!1&&(Array.isArray(a)===!0&&l in a&&Hs(e,t,!0),Hs(a,l,!0)),f}},o=new Proxy(n,r);return qh.set(n,o),o},rd=(n,e)=>(Object.keys(n).forEach(t=>{let i=n[t];if(n[t]!==null&&typeof n[t]=="object"){if(Object.getPrototypeOf(n[t])===Object.prototype)return rd(n[t]);if(Array.isArray(n[t])===!0)for(let s=0;s<Gn.length-1;s++)n[t][Gn[s]]=function(r){Array.prototype[Gn[s]].call(this,r),Hs(n,t)}}Object.defineProperty(n,t,{enumerable:!0,configurable:!0,get(){return zn(n,t,e),i},set(s){i!==s&&(i=s,Hs(n,t))}})}),n),Lp=typeof Proxy<"u",Ja=(n,e="Proxy",t=!1)=>(Lp===!1&&(e="defineProperty"),e==="defineProperty"?rd(n,t):Za(n,void 0,void 0,t)),wp=["init","ready","focus","unfocus","destroy","attach","detach","enter","exit"],Ip={previous:null,current:null,get state(){return this.current},set state(n){wp.indexOf(n)>-1&&(n!==this.current||n==="focus")&&(ve.debug(`Setting lifecycle state from ${this.current} to ${n} for ${this.component.componentId}`),this.previous=this.current,this.current=n,bp(n,this.component[w.identifier],this.component),qa(n,this.component[w.identifier],this.component))}},Pp="modulepreload",Dp=function(n){return"/"+n},Qh={},Mp=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let o=function(h){return Promise.all(h.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=o(t.map(h=>{if(h=Dp(h),h in Qh)return;Qh[h]=!0;const c=h.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${u}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":Pp,c||(d.as="script"),d.crossOrigin="",d.href=h,l&&d.setAttribute("nonce",l),document.head.appendChild(d),c)return new Promise((f,g)=>{d.addEventListener("load",f),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${h}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})},Fp={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};function kp(n,e=!1,t){const i={alpha:!0,antialias:!1,depth:!1,stencil:!0,desynchronized:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!1},s=n.getContext(e?"webgl2":"webgl",i)||n.getContext("experimental-webgl",i);if(!s)throw new Error("Unable to create WebGL context");return t?new Proxy(s,{get(r,o){const a=r[o];return typeof a=="function"?(t.increment(String(o)),a.bind(r)):a}}):s}function X(n,e){if(qs()!==!0&&!n)throw new Error(e||"Assertion failed")}function Zh(n,e,t){const i=Math.trunc(n>>>24),s=Math.trunc(n>>>16&255),r=Math.trunc(n>>>8&255),o=Math.trunc(n&255),a=Math.trunc(e>>>24),l=Math.trunc(e>>>16&255),h=Math.trunc(e>>>8&255),c=Math.trunc(e&255),u=Math.round(a*t+i*(1-t)),d=Math.round(l*t+s*(1-t)),f=Math.round(h*t+r*(1-t)),g=Math.round(c*t+o*(1-t));return(u<<24|d<<16|f<<8|g)>>>0}function Op(n,e){const t=n>>>24,i=n>>>16&255,s=n>>>8&255,r=Math.trunc((n&255)*e);return(t<<24|i<<16|s<<8|r)>>>0}let nd=!0;function Bp(n){nd=n==="webgl"}function cn(n,e,t=!1){const i=(n&255)/255*e,s=nd?i:1,r=Math.trunc((n>>>24)*s),o=Math.trunc((n>>>16&255)*s),a=Math.trunc((n>>>8&255)*s),l=Math.trunc(i*255);return t?(l<<24|a<<16|o<<8|r)>>>0:(r<<24|o<<16|a<<8|l)>>>0}function go(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function qs(){return Fp&&!0}let Up=1;function Np(){return Up++}let li=class{constructor(){y(this,"eventListeners",{})}on(e,t){let i=this.eventListeners[e];i||(i=[]),i.push(t),this.eventListeners[e]=i}off(e,t){const i=this.eventListeners[e];if(!i)return;if(!t){delete this.eventListeners[e];return}const s=i.indexOf(t);s>=0&&i.splice(s,1)}once(e,t){const i=(s,r)=>{this.off(e,i),t(s,r)};this.on(e,i)}emit(e,t){const i=this.eventListeners[e];i&&[...i].forEach(s=>{s(this,t)})}removeAllListeners(){this.eventListeners={}}};var Ae;(function(n){n[n.generic=0]="generic",n[n.color=1]="color",n[n.image=2]="image",n[n.noise=3]="noise",n[n.renderToTexture=4]="renderToTexture",n[n.subTexture=5]="subTexture"})(Ae||(Ae={}));let Ur=class extends li{constructor(t){super();y(this,"txManager");y(this,"_dimensions",null);y(this,"_error",null);y(this,"state","initial");y(this,"renderableOwners",new Set);y(this,"renderable",!1);y(this,"type",Ae.generic);y(this,"preventCleanup",!1);y(this,"ctxTexture");y(this,"textureData",null);this.txManager=t}get dimensions(){return this._dimensions}get error(){return this._error}setRenderableOwner(t,i){var r,o;const s=this.renderableOwners.size;if(i===!0){this.renderableOwners.has(t)===!1&&this.renderableOwners.add(t);const a=this.renderableOwners.size;a>s&&a===1&&(this.renderable=!0,(r=this.onChangeIsRenderable)==null||r.call(this,!0),this.load())}else{this.renderableOwners.delete(t);const a=this.renderableOwners.size;a<s&&a===0&&(this.renderable=!1,(o=this.onChangeIsRenderable)==null||o.call(this,!1),this.txManager.orphanTexture(this))}}load(){this.txManager.loadTexture(this)}loadCtxTexture(){return this.ctxTexture===void 0&&(this.ctxTexture=this.txManager.renderer.createCtxTexture(this)),this.ctxTexture}free(){var t;(t=this.ctxTexture)==null||t.free()}freeTextureData(){this.textureData=null}setState(t,i){if(this.state===t)return;let s=null;t==="loaded"?(i!==void 0&&"width"in i&&"height"in i&&i.width!==void 0&&i.height!==void 0&&(this._dimensions=i),s=this._dimensions):t==="failed"&&(this._error=i,s=this._error),this.state=t,this.emit(t,s)}async getTextureData(){return this.textureData===null&&(this.textureData=await this.getTextureSource()),this.textureData}static makeCacheKey(t){return!1}static resolveDefaults(t){return{}}};const $p=/^(data|ftps?|https?):/,Nr=n=>{const e=n>>>24,t=n>>>16&255,i=n>>>8&255,s=n&255;return[e/255,t/255,i/255,s/255]},Jh=n=>{const e=n>>>24,t=n>>>16&255,i=n>>>8&255,s=n&255;return[e,t,i,s]};function ec(n){return(n&255)/255}function da(n){const e=Math.floor(n[0]*255),t=Math.floor(n[1]*255),i=Math.floor(n[2]*255),s=Math.floor(n[3]*255);return`rgba(${e},${t},${i},${s.toFixed(4)})`}function Fs(n,e,t,i,s){return s?(s.x1=n,s.y1=e,s.x2=t,s.y2=i,s):{x1:n,y1:e,x2:t,y2:i}}function fa(n,e){return n.x1<e.x2&&n.x2>e.x1&&n.y1<e.y2&&n.y2>e.y1}function zp(n,e){return e?(e.x=n.x1,e.y=n.y1,e.width=n.x2-n.x1,e.height=n.y2-n.y1,e):{x:n.x1,y:n.y1,width:n.x2-n.x1,height:n.y2-n.y1}}function od(n,e,t){const i=Math.max(n.x,e.x),s=Math.max(n.y,e.y),r=Math.min(n.x+n.width,e.x+e.width)-i,o=Math.min(n.y+n.height,e.y+e.height)-s;return r>0&&o>0?t?(t.x=i,t.y=s,t.width=r,t.height=o,t):{x:i,y:s,width:r,height:o}:t?(t.x=0,t.y=0,t.width=0,t.height=0,t):{x:0,y:0,width:0,height:0}}function ad(n,e){return e?(e.x=n.x,e.y=n.y,e.width=n.width,e.height=n.height,e):{x:n.x,y:n.y,width:n.width,height:n.height}}function Gp(n,e){return n===e?!0:n===null||e===null?!1:n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height}function ga(n,e){return n.x1<=e.x2&&n.y1<=e.y2&&n.x2>=e.x1&&n.y2>=e.y1}function Hp(n,e){return n.x1<e.x1&&n.x2>e.x2&&n.y1<e.y1&&n.y2>e.y2}function Vp(n){return n.x1<n.x2&&n.y1<n.y2}function el(n,e){return Fs(n.x1-e[3],n.y1-e[0],n.x2+e[1],n.y2+e[2])}function Wp(n){if(self.location.protocol==="file:"&&!$p.test(n)){const t=self.location.pathname.split("/");t.pop();const i=t.join("/"),s=self.location.protocol+"//"+i;return n.charAt(0)==="."&&(n=n.slice(1)),n.charAt(0)==="/"&&(n=n.slice(1)),s+"/"+n}return new URL(n,self.location.href).href}function pa(n){return n.startsWith("data:")===!0}function Yp(n){var l,h;n=n.replace(/^data:/,"");const e=((l=n.match(/image\/[^;]+/))==null?void 0:l[0])||"",t=n.replace(/^[^,]+,/,""),i=1024,s=atob(t),r=s.length,o=Math.ceil(r/i),a=new Array(o);for(let c=0;c<o;++c){const u=c*i,d=Math.min(u+i,r),f=new Array(d-u);for(let g=u,p=0;g<d;++p,++g)f[p]=(h=s[g])==null?void 0:h.charCodeAt(0);a[c]=new Uint8Array(f)}return new Blob(a,{type:e})}class Ne{constructor(){y(this,"ta");y(this,"tb");y(this,"tx");y(this,"tc");y(this,"td");y(this,"ty");y(this,"_floatArr",null);y(this,"mutation");this.ta=0,this.tb=0,this.tx=0,this.tc=0,this.td=0,this.ty=0,this.mutation=!0}static get temp(){return Kp}static multiply(e,t,i){const s=e.ta*t.ta+e.tb*t.tc,r=e.ta*t.tb+e.tb*t.td,o=e.ta*t.tx+e.tb*t.ty+e.tx,a=e.tc*t.ta+e.td*t.tc,l=e.tc*t.tb+e.td*t.td,h=e.tc*t.tx+e.td*t.ty+e.ty;return i||(i=new Ne),i.ta=s,i.tb=r,i.tx=o,i.tc=a,i.td=l,i.ty=h,i.mutation=!0,i}static identity(e){return e||(e=new Ne),e.ta=1,e.tb=0,e.tx=0,e.tc=0,e.td=1,e.ty=0,e.mutation=!0,e}static translate(e,t,i){return i||(i=new Ne),i.ta=1,i.tb=0,i.tx=e,i.tc=0,i.td=1,i.ty=t,i.mutation=!0,i}static scale(e,t,i){return i||(i=new Ne),i.ta=e,i.tb=0,i.tx=0,i.tc=0,i.td=t,i.ty=0,i.mutation=!0,i}static rotate(e,t){const i=Math.cos(e),s=Math.sin(e);return t||(t=new Ne),t.ta=i,t.tb=-s,t.tx=0,t.tc=s,t.td=i,t.ty=0,t.mutation=!0,t}static copy(e,t){return t||(t=new Ne),t.ta=e.ta,t.tc=e.tc,t.tb=e.tb,t.td=e.td,t.tx=e.tx,t.ty=e.ty,t.mutation=!0,t}translate(e,t){return this.tx=this.ta*e+this.tb*t+this.tx,this.ty=this.tc*e+this.td*t+this.ty,this.mutation=!0,this}scale(e,t){return this.ta=this.ta*e,this.tb=this.tb*t,this.tc=this.tc*e,this.td=this.td*t,this.mutation=!0,this}rotate(e){if(e===0||!(e%Math.PI*2))return this;const t=Math.cos(e),i=Math.sin(e),s=this.ta*t+this.tb*i,r=this.tb*t-this.ta*i,o=this.tc*t+this.td*i,a=this.td*t-this.tc*i;return this.ta=s,this.tb=r,this.tc=o,this.td=a,this.mutation=!0,this}multiply(e){return Ne.multiply(this,e,this)}getFloatArr(){return this._floatArr||(this._floatArr=new Float32Array(9)),this.mutation&&(this._floatArr[0]=this.ta,this._floatArr[1]=this.tc,this._floatArr[2]=0,this._floatArr[3]=this.tb,this._floatArr[4]=this.td,this._floatArr[5]=0,this._floatArr[6]=this.tx,this._floatArr[7]=this.ty,this._floatArr[8]=1,this.mutation=!1),this._floatArr}}const Kp=new Ne,un=0,dn=2,fn=4,gn=6,pn=1,mn=3,_n=5,xn=7;class ks{constructor(e){y(this,"data");this.data=new Float32Array(8),e&&(this.data[un]=e[un],this.data[dn]=e[dn],this.data[fn]=e[fn],this.data[gn]=e[gn],this.data[pn]=e[pn],this.data[mn]=e[mn],this.data[_n]=e[_n],this.data[xn]=e[xn])}static translate(e,t,i,s,r,o,a,l,h){return h||(h=new ks),h.data[un]=e,h.data[dn]=i,h.data[fn]=r,h.data[gn]=a,h.data[pn]=t,h.data[mn]=s,h.data[_n]=o,h.data[xn]=l,h}get x1(){return this.data[un]}get x2(){return this.data[dn]}get x3(){return this.data[fn]}get x4(){return this.data[gn]}get y1(){return this.data[pn]}get y2(){return this.data[mn]}get y3(){return this.data[_n]}get y4(){return this.data[xn]}}const ld=(n,e,t,i)=>{const s=3*n,r=3*(t-n)-s,o=1-s-r,a=3*e,l=3*(i-e)-a,h=1-a-l;return function(c){if(c>=1)return 1;if(c<=0)return 0;let u=.5,d,f,g;for(let _=0;_<20;_++){if(d=u*(u*(u*o+r)+s),g=c-d,g>-1e-8&&g<1e-8)return u*(u*(u*h+l)+a);if(f=u*(u*(3*o)+2*r)+s,f>1e-10&&f<1e-10)break;u+=g/f}let p=0,m=1;for(let _=0;_<20;_++){if(u=.5*(p+m),d=u*(u*(u*o+r)+s),g=c-d,g>-1e-8&&g<1e-8)return u*(u*(u*h+l)+a);g<0?m=u:p=u}}},Hn={},Xp={ease:[.25,.1,.25,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1],"ease-in-sine":[.12,0,.39,0],"ease-out-sine":[.12,0,.39,0],"ease-in-out-sine":[.37,0,.63,1],"ease-in-cubic":[.32,0,.67,0],"ease-out-cubic":[.33,1,.68,1],"ease-in-out-cubic":[.65,0,.35,1],"ease-in-circ":[.55,0,1,.45],"ease-out-circ":[0,.55,.45,1],"ease-in-out-circ":[.85,0,.15,1],"ease-in-back":[.36,0,.66,-.56],"ease-out-back":[.34,1.56,.64,1],"ease-in-out-back":[.68,-.6,.32,1.6]},Vn=n=>n,jp=n=>{const e=/-?\d*\.?\d+/g,t=n.match(e);if(t){const[i,s,r,o]=t,a=parseFloat(i||"0.42"),l=parseFloat(s||"0"),h=parseFloat(r||"1"),c=parseFloat(o||"1"),u=ld(a,l,h,c);return Hn[n]=u,u}return console.warn("Unknown cubic-bezier timing: "+n),Vn},qp=n=>{if(n==="linear")return Vn;if(Hn[n]!==void 0)return Hn[n]||Vn;if(n==="step-start")return()=>1;if(n==="step-end")return t=>t===1?1:0;const e=Xp[n];if(e!==void 0){const[t,i,s,r]=e,o=ld(t,i,s,r);return Hn[n]=o,o}return n.startsWith("cubic-bezier")?jp(n):(console.warn("Unknown timing function: "+n),Vn)};function tc(n){return(n/1024/1024).toFixed(2)}class Qp extends li{constructor(t,i,s){super();y(this,"node");y(this,"props");y(this,"settings");y(this,"progress",0);y(this,"delayFor",0);y(this,"delay",0);y(this,"timingFunction");y(this,"propValuesMap",{});y(this,"dynPropValuesMap");this.node=t,this.props=i;for(const a in i)if(a!=="shaderProps")this.propValuesMap.props===void 0&&(this.propValuesMap.props={}),this.propValuesMap.props[a]={start:t[a]||0,target:i[a]};else if(t.shader.type!=="DynamicShader"){this.propValuesMap.shaderProps={};for(const l in i.shaderProps)this.propValuesMap.shaderProps[l]={start:t.shader.props[l],target:i.shaderProps[l]}}else{const l=Object.keys(i.shaderProps),h=l.length;this.dynPropValuesMap={};for(let c=0;c<h;c++){const u=l[c],d=i.shaderProps[u];this.dynPropValuesMap[u]={};const f=Object.entries(d),g=f.length;for(let p=0;p<g;p++){const[m,_]=f[p];this.dynPropValuesMap[u][m]={start:t.shader.props[u][m],target:_}}}}const r=s.easing||"linear",o=s.delay??0;this.settings={duration:s.duration??0,delay:o,easing:r,loop:s.loop??!1,repeat:s.repeat??0,repeatDelay:s.repeatDelay??0,stopMethod:s.stopMethod??!1},this.timingFunction=qp(r),this.delayFor=o,this.delay=o}reset(){this.progress=0,this.delayFor=this.settings.delay||0,this.update(0)}restoreValues(t,i){const s=Object.entries(i),r=s.length;for(let o=0;o<r;o++){const[a,l]=s[o];t[a]=l.start}}restore(){if(this.reset(),this.propValuesMap.props!==void 0&&this.restoreValues(this.node,this.propValuesMap.props),this.propValuesMap.shaderProps!==void 0&&this.restoreValues(this.node.shader.props,this.propValuesMap.shaderProps),this.dynPropValuesMap!==void 0){const t=Object.keys(this.dynPropValuesMap),i=t.length;if(i>0)for(let s=0;s<i;s++){const r=t[s];this.restoreValues(this.node.shader.props[r],this.dynPropValuesMap[r])}}}reverseValues(t){const i=Object.entries(t),s=i.length;for(let r=0;r<s;r++){const[o,a]=i[r];t[o]={start:a.target,target:a.start}}}reverse(){if(this.progress=0,this.propValuesMap.props!==void 0&&this.reverseValues(this.propValuesMap.props),this.propValuesMap.shaderProps!==void 0&&this.reverseValues(this.propValuesMap.shaderProps),this.dynPropValuesMap!==void 0){const t=Object.keys(this.dynPropValuesMap),i=t.length;if(i>0)for(let s=0;s<i;s++){const r=t[s];this.reverseValues(this.dynPropValuesMap[r])}}this.settings.loop||(this.settings.stopMethod=!1)}applyEasing(t,i,s){return(this.timingFunction(t)||t)*(s-i)+i}updateValue(t,i,s,r){if(this.progress===1)return i;if(this.progress===0)return s;const o=i;if(t.indexOf("color")!==-1){if(s===o)return s;if(r){const a=this.timingFunction(this.progress)||this.progress;return Zh(s,o,a)}return Zh(s,o,this.progress)}return r?this.applyEasing(this.progress,s,o):s+(o-s)*this.progress}updateValues(t,i,s){const r=Object.entries(i),o=r.length;for(let a=0;a<o;a++){const[l,h]=r[a];t[l]=this.updateValue(l,h.target,h.start,s)}}update(t){const{duration:i,loop:s,easing:r,stopMethod:o}=this.settings,{delayFor:a}=this;if(this.node.destroyed){this.emit("destroyed",{});return}if(i===0&&a===0){this.emit("finished",{});return}if(this.delayFor>0){if(this.delayFor-=t,this.delayFor>=0)return;t=-this.delayFor,this.delayFor=0}if(i===0){this.emit("finished",{});return}if(this.progress===0&&this.emit("animating",{}),this.progress+=t/i,this.progress>1&&(this.progress=s?0:1,this.delayFor=this.delay,o)){this.emit("finished",{});return}if(this.propValuesMap.props!==void 0&&this.updateValues(this.node,this.propValuesMap.props,r),this.propValuesMap.shaderProps!==void 0&&this.updateValues(this.node.shader.props,this.propValuesMap.shaderProps,r),this.dynPropValuesMap!==void 0){const l=Object.keys(this.dynPropValuesMap),h=l.length;if(h>0)for(let c=0;c<h;c++){const u=l[c];this.updateValues(this.node.shader.props[u],this.dynPropValuesMap[u],r)}}this.progress<1&&this.emit("tick",{progress:this.progress}),this.progress===1&&this.emit("finished",{})}}class Zp extends li{constructor(t,i){super();y(this,"manager");y(this,"animation");y(this,"stoppedPromise");y(this,"stoppedResolve",null);y(this,"state");this.manager=t,this.animation=i,this.state="stopped",this.stoppedPromise=Promise.resolve(),this.onAnimating=this.onAnimating.bind(this),this.onFinished=this.onFinished.bind(this),this.onTick=this.onTick.bind(this),this.onDestroy=this.onDestroy.bind(this)}start(){return this.state!=="running"&&this.state!=="scheduled"&&(this.makeStoppedPromise(),this.registerAnimation(),this.state="scheduled"),this}stop(){return this.unregisterAnimation(),this.stoppedResolve!==null&&(this.stoppedResolve(),this.stoppedResolve=null,this.emit("stopped",this)),this.animation.reset(),this.state="stopped",this}pause(){return this.unregisterAnimation(),this.state="paused",this}restore(){return this.stoppedResolve=null,this.animation.restore(),this}waitUntilStopped(){return this.stoppedPromise}registerAnimation(){this.animation.once("finished",this.onFinished),this.animation.on("animating",this.onAnimating),this.animation.on("tick",this.onTick),this.animation.on("destroyed",this.onDestroy),this.manager.registerAnimation(this.animation)}unregisterAnimation(){this.manager.unregisterAnimation(this.animation),this.animation.off("finished",this.onFinished),this.animation.off("animating",this.onAnimating),this.animation.off("tick",this.onTick),this.animation.off("destroy",this.onDestroy)}makeStoppedPromise(){this.stoppedResolve===null&&(this.stoppedPromise=new Promise(t=>{this.stoppedResolve=t}))}onDestroy(){this.unregisterAnimation(),this.state="stopped"}onFinished(){X(this.stoppedResolve);const{loop:t,stopMethod:i}=this.animation.settings;if(i==="reverse"){this.animation.once("finished",this.onFinished),this.animation.reverse();return}t||(this.unregisterAnimation(),this.stoppedResolve(),this.stoppedResolve=null,this.emit("stopped",this),this.state="stopped")}onAnimating(){this.state="running",this.emit("animating",this)}onTick(t,i){this.emit("tick",i)}}var He;(function(n){n[n.Init=0]="Init",n[n.OutOfBounds=2]="OutOfBounds",n[n.InBounds=4]="InBounds",n[n.InViewport=8]="InViewport"})(He||(He={}));const $r=new Map;$r.set(He.Init,"init");$r.set(He.OutOfBounds,"outOfBounds");$r.set(He.InBounds,"inBounds");$r.set(He.InViewport,"inViewport");var $;(function(n){n[n.Children=1]="Children",n[n.ScaleRotate=2]="ScaleRotate",n[n.Local=4]="Local",n[n.Global=8]="Global",n[n.Clipping=16]="Clipping",n[n.CalculatedZIndex=32]="CalculatedZIndex",n[n.ZIndexSortedChildren=64]="ZIndexSortedChildren",n[n.PremultipliedColors=128]="PremultipliedColors",n[n.WorldAlpha=256]="WorldAlpha",n[n.RenderState=512]="RenderState",n[n.IsRenderable=1024]="IsRenderable",n[n.RenderTexture=2048]="RenderTexture",n[n.ParentRenderTexture=4096]="ParentRenderTexture",n[n.RenderBounds=8192]="RenderBounds",n[n.None=0]="None",n[n.All=14335]="All"})($||($={}));class tl extends li{constructor(t,i){super();y(this,"stage");y(this,"children",[]);y(this,"_id",Np());y(this,"props");y(this,"updateType",$.All);y(this,"childUpdateType",$.None);y(this,"globalTransform");y(this,"scaleRotateTransform");y(this,"localTransform");y(this,"sceneGlobalTransform");y(this,"renderCoords");y(this,"sceneRenderCoords");y(this,"renderBound");y(this,"strictBound");y(this,"preloadBound");y(this,"clippingRect",{x:0,y:0,width:0,height:0,valid:!1});y(this,"isRenderable",!1);y(this,"renderState",He.Init);y(this,"worldAlpha",1);y(this,"premultipliedColorTl",0);y(this,"premultipliedColorTr",0);y(this,"premultipliedColorBl",0);y(this,"premultipliedColorBr",0);y(this,"calcZIndex",0);y(this,"hasRTTupdates",!1);y(this,"parentHasRenderTexture",!1);y(this,"rttParent",null);y(this,"destroyed",!1);y(this,"onTextureLoaded",(t,i)=>{var s,r;this.autosizeNode(i),this.setUpdateType($.IsRenderable),this.stage.requestRender(),this.parentHasRenderTexture&&this.notifyParentRTTOfUpdate(),i.width>1&&i.height>1&&this.emit("loaded",{type:"texture",dimensions:i}),((r=(s=this.props.textureOptions)==null?void 0:s.resizeMode)==null?void 0:r.type)==="contain"&&this.setUpdateType($.Local)});y(this,"onTextureFailed",(t,i)=>{this.setUpdateType($.IsRenderable),this.parentHasRenderTexture&&this.notifyParentRTTOfUpdate(),this.emit("failed",{type:"texture",error:i})});y(this,"onTextureFreed",()=>{this.setUpdateType($.IsRenderable),this.parentHasRenderTexture&&this.notifyParentRTTOfUpdate(),this.emit("freed",{type:"texture"})});this.stage=t,this.props={...i,parent:null,texture:null,src:null,rtt:!1},this.parent=i.parent,this.texture=i.texture,this.src=i.src,this.rtt=i.rtt,i.boundsMargin&&(this.boundsMargin=Array.isArray(i.boundsMargin)?i.boundsMargin:[i.boundsMargin,i.boundsMargin,i.boundsMargin,i.boundsMargin]),this.setUpdateType($.ScaleRotate|$.Local|$.RenderBounds|$.RenderState),qs()===!1&&i.preventCleanup===!0&&console.warn("CoreNode.preventCleanup: Is deprecated and will be removed in upcoming release, please use textureOptions.preventCleanup instead"),this.stage.defaultTexture&&this.stage.defaultTexture.state!=="loaded"&&this.stage.defaultTexture.once("loaded",()=>{this.setUpdateType($.IsRenderable)})}loadTexture(){const{texture:t}=this.props;X(t),queueMicrotask(()=>{var i;if(this.textureOptions.preload===!0&&this.stage.txManager.loadTexture(t),t.preventCleanup=((i=this.props.textureOptions)==null?void 0:i.preventCleanup)??!1,t.on("loaded",this.onTextureLoaded),t.on("failed",this.onTextureFailed),t.on("freed",this.onTextureFreed),this.parentHasRenderTexture){this.notifyParentRTTOfUpdate();return}t.state==="loaded"?(X(t.dimensions),this.onTextureLoaded(t,t.dimensions)):t.state==="failed"?(X(t.error),this.onTextureFailed(t,t.error)):t.state==="freed"&&this.onTextureFreed(t)})}unloadTexture(){this.texture!==null&&(this.texture.off("loaded",this.onTextureLoaded),this.texture.off("failed",this.onTextureFailed),this.texture.off("freed",this.onTextureFreed),this.texture.setRenderableOwner(this,!1))}autosizeNode(t){this.autosize&&(this.width=t.width,this.height=t.height)}setUpdateType(t){this.updateType|=t;const i=this.props.parent;i&&(i.updateType&$.Children)===0&&i.setUpdateType($.Children)}sortChildren(){this.children.sort((t,i)=>t.calcZIndex-i.calcZIndex)}updateScaleRotateTransform(){const{rotation:t,scaleX:i,scaleY:s}=this.props;if(t===0&&i===1&&s===1){this.scaleRotateTransform=void 0;return}this.scaleRotateTransform=Ne.rotate(t,this.scaleRotateTransform).scale(i,s)}updateLocalTransform(){var h,c;const{x:t,y:i,width:s,height:r}=this.props,o=this.props.mountX*s,a=this.props.mountY*r;if(this.scaleRotateTransform){const u=this.props.pivotX*s,d=this.props.pivotY*r;this.localTransform=Ne.translate(t-o+u,i-a+d,this.localTransform).multiply(this.scaleRotateTransform).translate(-u,-d)}else this.localTransform=Ne.translate(t-o,i-a,this.localTransform);const l=this.props.texture;if(l&&l.dimensions&&((c=(h=this.props.textureOptions)==null?void 0:h.resizeMode)==null?void 0:c.type)==="contain"){let u=1,d=1,f=0,g=0;const{width:p,height:m}=l.dimensions,_=p/m,T=s/r;if(_>T){const S=s/p,v=m*S;g=(r-v)/2,d=v/r}else{const S=r/m,v=p*S;f=(s-v)/2,u=v/s}this.localTransform.translate(f,g).scale(u,d)}this.setUpdateType($.Global)}update(t,i){this.updateType&$.ScaleRotate&&(this.updateScaleRotateTransform(),this.setUpdateType($.Local)),this.updateType&$.Local&&(this.updateLocalTransform(),this.setUpdateType($.Global));const s=this.props.parent;let r=null;if(this.updateType&$.RenderTexture&&this.rtt&&(this.hasRTTupdates=!0),this.updateType&$.Global&&(X(this.localTransform),this.parentHasRenderTexture===!0&&(s==null?void 0:s.rtt)===!0?(this.globalTransform=Ne.identity(),this.sceneGlobalTransform=Ne.copy((s==null?void 0:s.globalTransform)||Ne.identity()).multiply(this.localTransform)):this.parentHasRenderTexture===!0&&(s==null?void 0:s.rtt)===!1?(this.sceneGlobalTransform=Ne.copy((s==null?void 0:s.sceneGlobalTransform)||this.localTransform).multiply(this.localTransform),this.globalTransform=Ne.copy((s==null?void 0:s.globalTransform)||this.localTransform,this.globalTransform)):this.globalTransform=Ne.copy((s==null?void 0:s.globalTransform)||this.localTransform,this.globalTransform),s!==null&&this.globalTransform.multiply(this.localTransform),this.calculateRenderCoords(),this.updateBoundingRect(),this.setUpdateType($.RenderState|$.Children),this.childUpdateType|=$.Global,this.clipping===!0&&(this.setUpdateType($.Clipping|$.RenderBounds),this.childUpdateType|=$.RenderBounds)),this.updateType&$.RenderBounds&&(this.createRenderBounds(),this.setUpdateType($.RenderState),this.setUpdateType($.Children),this.childUpdateType|=$.RenderBounds),this.updateType&$.RenderState&&(r=this.checkRenderBounds(),this.setUpdateType($.IsRenderable),r!==He.OutOfBounds&&this.updateRenderState(r)),this.updateType&$.WorldAlpha&&(s?this.worldAlpha=s.worldAlpha*this.props.alpha:this.worldAlpha=this.props.alpha,this.setUpdateType($.Children|$.PremultipliedColors|$.IsRenderable),this.childUpdateType|=$.WorldAlpha),this.updateType&$.IsRenderable&&this.updateIsRenderable(),this.updateType&$.Clipping&&(this.calculateClippingRect(i),this.setUpdateType($.Children),this.childUpdateType|=$.Clipping,this.childUpdateType|=$.RenderBounds),this.updateType&$.PremultipliedColors&&(this.premultipliedColorTl=cn(this.props.colorTl,this.worldAlpha,!0),this.props.colorTl===this.props.colorTr&&this.props.colorBl===this.props.colorBr&&this.props.colorTl===this.props.colorBl?this.premultipliedColorTr=this.premultipliedColorBl=this.premultipliedColorBr=this.premultipliedColorTl:(this.premultipliedColorTr=cn(this.props.colorTr,this.worldAlpha,!0),this.premultipliedColorBl=cn(this.props.colorBl,this.worldAlpha,!0),this.premultipliedColorBr=cn(this.props.colorBr,this.worldAlpha,!0))),s!==null&&this.updateType&$.CalculatedZIndex&&(this.calculateZIndex(),s.setUpdateType($.ZIndexSortedChildren)),this.props.strictBounds===!0&&this.renderState===He.OutOfBounds){this.updateType&=~$.RenderBounds;return}if(this.updateType&$.Children&&this.children.length>0)for(let o=0,a=this.children.length;o<a;o++){const l=this.children[o];if(l.setUpdateType(this.childUpdateType),l.updateType===0)continue;let h=this.clippingRect;this.rtt===!0&&(h={x:0,y:0,width:0,height:0,valid:!1}),l.update(t,h)}this.parentHasRenderTexture&&this.updateType>0&&this.notifyParentRTTOfUpdate(),this.updateType&$.ZIndexSortedChildren&&this.sortChildren(),r===He.OutOfBounds&&(this.updateRenderState(r),this.updateIsRenderable(),this.rtt===!0&&r===He.OutOfBounds&&this.notifyChildrenRTTOfUpdate(r)),this.updateType=0,this.childUpdateType=0}findParentRTTNode(){let t=this.parent;for(;t&&!t.rtt;)t=t.parent;return t}getRTTParentRenderState(){const t=this.rttParent||this.findParentRTTNode();return t?t.renderState:null}notifyChildrenRTTOfUpdate(t){for(const i of this.children)i.updateRenderState(t),i.updateIsRenderable(),i.notifyChildrenRTTOfUpdate(t)}notifyParentRTTOfUpdate(){if(this.parent===null)return;const t=this.rttParent||this.findParentRTTNode();t&&(t.hasRTTupdates=!0,t.setUpdateType($.RenderTexture),t.parentHasRenderTexture===!0&&t.notifyParentRTTOfUpdate())}checkRenderBounds(){return X(this.renderBound),X(this.strictBound),X(this.preloadBound),ga(this.renderBound,this.strictBound)?He.InViewport:ga(this.renderBound,this.preloadBound)?He.InBounds:Hp(this.renderBound,this.strictBound)?He.InViewport:this.parent!==null&&(this.props.width===0||this.props.height===0)?this.parent.renderState:He.OutOfBounds}updateBoundingRect(){const t=this.sceneGlobalTransform||this.globalTransform,i=this.sceneRenderCoords||this.renderCoords;X(t),X(i);const{tb:s,tc:r}=t,{x1:o,y1:a,x3:l,y3:h}=i;if(s===0||r===0)this.renderBound=Fs(o,a,l,h,this.renderBound);else{const{x2:c,x4:u,y2:d,y4:f}=i;this.renderBound=Fs(Math.min(o,c,l,u),Math.min(a,d,h,f),Math.max(o,c,l,u),Math.max(a,d,h,f),this.renderBound)}}createRenderBounds(){if(X(this.stage),this.parent!==null&&this.parent.strictBound!==void 0){const c=this.parent.strictBound;this.strictBound=Fs(c.x1,c.y1,c.x2,c.y2),this.preloadBound=el(this.strictBound,this.boundsMargin)}else this.strictBound=this.stage.strictBound,this.preloadBound=this.stage.preloadBound;if(this.props.clipping===!1||this.renderBound===void 0||ga(this.renderBound,this.strictBound)===!1)return;const{x:t,y:i,width:s,height:r}=this.props,{tx:o,ty:a}=this.sceneGlobalTransform||this.globalTransform||{},l=o??t,h=a??i;this.strictBound=Fs(l,h,l+s,h+r,this.strictBound),this.preloadBound=el(this.strictBound,this.boundsMargin)}updateRenderState(t){if(t===this.renderState)return;const i=this.renderState;this.renderState=t;const s=$r.get(t);X(s),this.emit(s,{previous:i,current:t})}updateIsRenderable(){let t=!1,i=!1;if(this.checkBasicRenderability()===!1){this.updateTextureOwnership(!1),this.setRenderable(!1);return}this.texture!==null?(i=!0,t=this.texture.state==="loaded"):(this.hasShader()||this.hasColorProperties()===!0)&&this.hasDimensions()===!0&&this.stage.defaultTexture&&this.stage.defaultTexture.state==="loaded"&&(t=!0),this.updateTextureOwnership(i),this.setRenderable(t)}checkBasicRenderability(){return!(this.worldAlpha===0||this.isOutOfBounds()===!0)}setRenderable(t){this.isRenderable=t}updateTextureOwnership(t){var i;(i=this.texture)==null||i.setRenderableOwner(this,t)}isOutOfBounds(){return this.renderState<=He.OutOfBounds}hasDimensions(){return this.props.width!==0&&this.props.height!==0}hasColorProperties(){return this.props.color!==0||this.props.colorTop!==0||this.props.colorBottom!==0||this.props.colorLeft!==0||this.props.colorRight!==0||this.props.colorTl!==0||this.props.colorTr!==0||this.props.colorBl!==0||this.props.colorBr!==0}hasShader(){return this.props.shader!==null}calculateRenderCoords(){const{width:t,height:i}=this,{tx:s,ty:r,ta:o,tb:a,tc:l,td:h}=this.globalTransform;if(a===0&&l===0){const m=s,_=s+t*o,T=r,S=r+i*h;this.renderCoords=ks.translate(m,T,_,T,_,S,m,S,this.renderCoords)}else this.renderCoords=ks.translate(s,r,s+t*o,r+t*l,s+t*o+i*a,r+t*l+i*h,s+i*a,r+i*h,this.renderCoords);if(this.sceneGlobalTransform===void 0)return;const{tx:c,ty:u,ta:d,tb:f,tc:g,td:p}=this.sceneGlobalTransform;if(f===0&&g===0){const m=c,_=c+t*d,T=u,S=u+i*p;this.sceneRenderCoords=ks.translate(m,T,_,T,_,S,m,S,this.sceneRenderCoords)}else this.sceneRenderCoords=ks.translate(c,u,c+t*d,u+t*g,c+t*d+i*f,u+t*g+i*p,c+i*f,u+i*p,this.sceneRenderCoords)}calculateClippingRect(t){X(this.globalTransform);const{clippingRect:i,props:s,globalTransform:r}=this,{clipping:o}=s,a=r.tb!==0||r.tc!==0;o===!0&&a===!1?(i.x=r.tx,i.y=r.ty,i.width=this.width*r.ta,i.height=this.height*r.td,i.valid=!0):i.valid=!1,t.valid===!0&&i.valid===!0?od(t,i,i):t.valid===!0&&(ad(t,i),i.valid=!0)}calculateZIndex(){var o,a;const t=this.props,i=t.zIndex||0,s=((o=t.parent)==null?void 0:o.zIndex)||0;let r=i;(a=t.parent)!=null&&a.zIndexLocked&&(r=i<s?i:s),this.calcZIndex=r}destroy(){var t;if(this.destroyed!==!0){for(this.destroyed=!0,this.unloadTexture(),this.clippingRect.valid=!1,this.isRenderable=!1,this.renderCoords=void 0,this.renderBound=void 0,this.strictBound=void 0,this.preloadBound=void 0,this.globalTransform=void 0,this.scaleRotateTransform=void 0,this.localTransform=void 0,this.props.texture=null,this.props.shader=this.stage.defShaderCtr;this.children.length>0;)(t=this.children[0])==null||t.destroy();this.parent=null,this.rtt&&this.stage.renderer.removeRTTNode(this),this.removeAllListeners()}}renderQuads(t){this.parentHasRenderTexture&&(!t.renderToTextureActive||this.parentRenderTexture!==t.activeRttNode)||(X(this.globalTransform),X(this.renderCoords),t.addQuad({width:this.props.width,height:this.props.height,colorTl:this.premultipliedColorTl,colorTr:this.premultipliedColorTr,colorBl:this.premultipliedColorBl,colorBr:this.premultipliedColorBr,texture:this.texture||this.stage.defaultTexture,textureOptions:this.textureOptions,zIndex:this.zIndex,shader:this.shader.shader,shaderProps:this.shader.getResolvedProps(),alpha:this.worldAlpha,clippingRect:this.clippingRect,tx:this.globalTransform.tx,ty:this.globalTransform.ty,ta:this.globalTransform.ta,tb:this.globalTransform.tb,tc:this.globalTransform.tc,td:this.globalTransform.td,renderCoords:this.renderCoords,rtt:this.rtt,parentHasRenderTexture:this.parentHasRenderTexture,framebufferDimensions:this.framebufferDimensions}))}get id(){return this._id}get data(){return this.props.data}set data(t){this.props.data=t}get x(){return this.props.x}set x(t){this.props.x!==t&&(this.props.x=t,this.setUpdateType($.Local))}get absX(){var t,i,s;return this.props.x+-this.props.width*this.props.mountX+(((t=this.props.parent)==null?void 0:t.absX)||((s=(i=this.props.parent)==null?void 0:i.globalTransform)==null?void 0:s.tx)||0)}get absY(){var t;return this.props.y+-this.props.height*this.props.mountY+(((t=this.props.parent)==null?void 0:t.absY)??0)}get y(){return this.props.y}set y(t){this.props.y!==t&&(this.props.y=t,this.setUpdateType($.Local))}get width(){return this.props.width}set width(t){this.props.width!==t&&(this.props.width=t,this.setUpdateType($.Local),this.props.rtt&&(this.texture=this.stage.txManager.createTexture("RenderTexture",{width:this.width,height:this.height}),this.setUpdateType($.RenderTexture)))}get height(){return this.props.height}set height(t){this.props.height!==t&&(this.props.height=t,this.setUpdateType($.Local),this.props.rtt&&(this.texture=this.stage.txManager.createTexture("RenderTexture",{width:this.width,height:this.height}),this.setUpdateType($.RenderTexture)))}get scale(){return this.scaleX}set scale(t){this.scaleX=t,this.scaleY=t}get scaleX(){return this.props.scaleX}set scaleX(t){this.props.scaleX!==t&&(this.props.scaleX=t,this.setUpdateType($.ScaleRotate))}get scaleY(){return this.props.scaleY}set scaleY(t){this.props.scaleY!==t&&(this.props.scaleY=t,this.setUpdateType($.ScaleRotate))}get mount(){return this.props.mount}set mount(t){(this.props.mountX!==t||this.props.mountY!==t)&&(this.props.mountX=t,this.props.mountY=t,this.props.mount=t,this.setUpdateType($.Local))}get mountX(){return this.props.mountX}set mountX(t){this.props.mountX!==t&&(this.props.mountX=t,this.setUpdateType($.Local))}get mountY(){return this.props.mountY}set mountY(t){this.props.mountY!==t&&(this.props.mountY=t,this.setUpdateType($.Local))}get pivot(){return this.props.pivot}set pivot(t){(this.props.pivotX!==t||this.props.pivotY!==t)&&(this.props.pivotX=t,this.props.pivotY=t,this.props.pivot=t,this.setUpdateType($.Local))}get pivotX(){return this.props.pivotX}set pivotX(t){this.props.pivotX!==t&&(this.props.pivotX=t,this.setUpdateType($.Local))}get pivotY(){return this.props.pivotY}set pivotY(t){this.props.pivotY!==t&&(this.props.pivotY=t,this.setUpdateType($.Local))}get rotation(){return this.props.rotation}set rotation(t){this.props.rotation!==t&&(this.props.rotation=t,this.setUpdateType($.ScaleRotate))}get alpha(){return this.props.alpha}set alpha(t){this.props.alpha=t,this.setUpdateType($.PremultipliedColors|$.WorldAlpha|$.Children|$.IsRenderable),this.childUpdateType|=$.WorldAlpha}get autosize(){return this.props.autosize}set autosize(t){this.props.autosize=t}get boundsMargin(){var t;return this.props.boundsMargin??((t=this.parent)==null?void 0:t.boundsMargin)??this.stage.boundsMargin}set boundsMargin(t){if(t!==this.props.boundsMargin){if(t===null)this.props.boundsMargin=t;else{const i=Array.isArray(t)?t:[t,t,t,t];this.props.boundsMargin=i}this.setUpdateType($.RenderBounds)}}get clipping(){return this.props.clipping}set clipping(t){this.props.clipping=t,this.setUpdateType($.Clipping|$.RenderBounds|$.Children),this.childUpdateType|=$.Global|$.Clipping}get color(){return this.props.color}set color(t){this.colorTop=t,this.colorBottom=t,this.colorLeft=t,this.colorRight=t,this.props.color=t,this.setUpdateType($.PremultipliedColors)}get colorTop(){return this.props.colorTop}set colorTop(t){(this.props.colorTl!==t||this.props.colorTr!==t)&&(this.colorTl=t,this.colorTr=t),this.props.colorTop=t,this.setUpdateType($.PremultipliedColors)}get colorBottom(){return this.props.colorBottom}set colorBottom(t){(this.props.colorBl!==t||this.props.colorBr!==t)&&(this.colorBl=t,this.colorBr=t),this.props.colorBottom=t,this.setUpdateType($.PremultipliedColors)}get colorLeft(){return this.props.colorLeft}set colorLeft(t){(this.props.colorTl!==t||this.props.colorBl!==t)&&(this.colorTl=t,this.colorBl=t),this.props.colorLeft=t,this.setUpdateType($.PremultipliedColors)}get colorRight(){return this.props.colorRight}set colorRight(t){(this.props.colorTr!==t||this.props.colorBr!==t)&&(this.colorTr=t,this.colorBr=t),this.props.colorRight=t,this.setUpdateType($.PremultipliedColors)}get colorTl(){return this.props.colorTl}set colorTl(t){this.props.colorTl=t,this.setUpdateType($.PremultipliedColors)}get colorTr(){return this.props.colorTr}set colorTr(t){this.props.colorTr=t,this.setUpdateType($.PremultipliedColors)}get colorBl(){return this.props.colorBl}set colorBl(t){this.props.colorBl=t,this.setUpdateType($.PremultipliedColors)}get colorBr(){return this.props.colorBr}set colorBr(t){this.props.colorBr=t,this.setUpdateType($.PremultipliedColors)}get zIndexLocked(){return this.props.zIndexLocked||0}set zIndexLocked(t){this.props.zIndexLocked=t,this.setUpdateType($.CalculatedZIndex|$.Children);for(let i=0,s=this.children.length;i<s;i++)this.children[i].setUpdateType($.CalculatedZIndex)}get zIndex(){return this.props.zIndex}set zIndex(t){this.props.zIndex=t,this.setUpdateType($.CalculatedZIndex|$.Children);for(let i=0,s=this.children.length;i<s;i++)this.children[i].setUpdateType($.CalculatedZIndex)}get parent(){return this.props.parent}set parent(t){const i=this.props.parent;if(i!==t){if(this.props.parent=t,i){const s=i.children.indexOf(this);X(s!==-1,"CoreNode.parent: Node not found in old parent's children!"),i.children.splice(s,1),i.setUpdateType($.Children|$.ZIndexSortedChildren)}t&&(t.children.push(this),this.setUpdateType($.All),t.setUpdateType($.Children|$.ZIndexSortedChildren),(t.rtt||t.parentHasRenderTexture)&&this.applyRTTInheritance(t)),this.updateScaleRotateTransform(),this.setUpdateType($.RenderBounds|$.Children)}}get preventCleanup(){return this.props.textureOptions.preventCleanup||!1}set preventCleanup(t){qs()===!1&&console.warn("CoreNode.preventCleanup: Is deprecated and will be removed in upcoming release, please use textureOptions.preventCleanup instead"),this.props.textureOptions.preventCleanup=t}get rtt(){return this.props.rtt}set rtt(t){this.props.rtt!==t&&(this.props.rtt=t,t===!0?(this.initRenderTexture(),this.markChildrenWithRTT()):this.cleanupRenderTexture(),this.setUpdateType($.RenderTexture),this.parentHasRenderTexture===!0&&this.notifyParentRTTOfUpdate())}initRenderTexture(){this.texture=this.stage.txManager.createTexture("RenderTexture",{width:this.width,height:this.height}),this.stage.renderer.renderToTexture(this)}cleanupRenderTexture(){this.unloadTexture(),this.clearRTTInheritance(),this.hasRTTupdates=!1,this.texture=null}markChildrenWithRTT(t=null){const i=t||this;for(const s of i.children)s.setUpdateType($.All),s.parentHasRenderTexture=!0,s.markChildrenWithRTT()}applyRTTInheritance(t){t.rtt&&t.setUpdateType($.RenderTexture),this.markChildrenWithRTT(t)}clearRTTInheritance(){if(!this.rtt)for(const t of this.children)t.parentHasRenderTexture=!1,t.rttParent=null,t.setUpdateType($.All),t.clearRTTInheritance()}get shader(){return this.props.shader}set shader(t){this.props.shader!==t&&(this.props.shader=t,this.setUpdateType($.IsRenderable))}get src(){return this.props.src}set src(t){if(this.props.src!==t){if(this.props.src=t,!t){this.texture=null;return}this.texture=this.stage.txManager.createTexture("ImageTexture",{src:t,width:this.props.width,height:this.props.height,type:this.props.imageType,sx:this.props.srcX,sy:this.props.srcY,sw:this.props.srcWidth,sh:this.props.srcHeight})}}set imageType(t){this.props.imageType!==t&&(this.props.imageType=t)}get imageType(){return this.props.imageType||null}get srcHeight(){return this.props.srcHeight}set srcHeight(t){this.props.srcHeight=t}get srcWidth(){return this.props.srcWidth}set srcWidth(t){this.props.srcWidth=t}get srcX(){return this.props.srcX}set srcX(t){this.props.srcX=t}get srcY(){return this.props.srcY}set srcY(t){this.props.srcY=t}get framebufferDimensions(){return this.parentHasRenderTexture&&!this.rtt&&this.parent?this.parent.framebufferDimensions:{width:this.width,height:this.height}}get parentRenderTexture(){let t=this.parent;for(;t;){if(t.rtt)return t;t=t.parent}return null}get texture(){return this.props.texture}set texture(t){if(this.props.texture===t)return;const i=this.props.texture;i&&(i.setRenderableOwner(this,!1),this.unloadTexture()),this.props.texture=t,t!==null&&(t.setRenderableOwner(this,this.isRenderable),this.loadTexture()),this.setUpdateType($.IsRenderable)}set textureOptions(t){this.props.textureOptions=t}get textureOptions(){return this.props.textureOptions}get strictBounds(){return this.props.strictBounds}set strictBounds(t){t!==this.props.strictBounds&&(this.props.strictBounds=t,this.setUpdateType($.RenderBounds|$.Children),this.childUpdateType|=$.RenderBounds|$.Children)}animate(t,i){const s=new Qp(this,t,i);return new Zp(this.stage.animationManager,s)}flush(){}}const Jp=n=>{let e=!1;const t=()=>{if(n.updateFrameTime(),n.updateAnimations(),!n.hasSceneUpdates()){n.calculateFps(),setTimeout(t,16.666666666666668),e||(n.eventBus.emit("idle"),e=!0),n.txMemManager.checkCleanup()===!0&&n.txMemManager.cleanup(!1),n.flushFrameEvents();return}e=!1,n.drawFrame(),n.flushFrameEvents(),requestAnimationFrame(t)};requestAnimationFrame(t)},as=()=>performance?performance.now():Date.now();let em=class{constructor(){y(this,"activeAnimations",new Set)}registerAnimation(e){this.activeAnimations.add(e)}unregisterAnimation(e){this.activeAnimations.delete(e)}update(e){this.activeAnimations.forEach(t=>{t.update(e)})}};function tm(){function n(t){return t.indexOf("image/png")!==-1}function e(t,i,s,r,o,a,l){return new Promise(function(h,c){var u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="blob",u.onload=function(){if(u.status!==200&&u.status!==0)return c(new Error("Failed to load image: "+u.statusText));var d=u.response;i!==void 0||n(d.type),createImageBitmap(d).then(function(f){h({data:f,premultiplyAlpha:i})}).catch(function(f){c(f)})},u.onerror=function(){c(new Error("Network error occurred while trying to fetch the image."))},u.send()})}self.onmessage=t=>{var i=t.data.src,s=t.data.id,r=t.data.premultiplyAlpha;t.data.sx,t.data.sy,t.data.sw,t.data.sh,e(i,r).then(function(o){self.postMessage({id:s,src:i,data:o},[o.data])}).catch(function(o){self.postMessage({id:s,src:i,error:o.message})})}}class im{constructor(e,t){y(this,"imageWorkersEnabled",!0);y(this,"messageManager",{});y(this,"workers",[]);y(this,"workerIndex",0);y(this,"nextId",0);this.workers=this.createWorkers(e,t),this.workers.forEach(i=>{i.onmessage=this.handleMessage.bind(this)})}handleMessage(e){const{id:t,data:i,error:s}=e.data,r=this.messageManager[t];if(r){const[o,a]=r;delete this.messageManager[t],s?a(new Error(s)):o(i)}}createWorkers(e=1,t){let i=`(${tm.toString()})()`;t.options===!0&&(i=i.replace("var supportsOptionsCreateImageBitmap = false;","var supportsOptionsCreateImageBitmap = true;")),t.full===!0&&(i=i.replace("var supportsOptionsCreateImageBitmap = false;","var supportsOptionsCreateImageBitmap = true;"),i=i.replace("var supportsFullCreateImageBitmap = false;","var supportsFullCreateImageBitmap = true;")),i=i.replace('"use strict";',"");const s=new Blob([i],{type:"application/javascript"}),r=(self.URL?URL:webkitURL).createObjectURL(s),o=[];for(let a=0;a<e;a++)o.push(new Worker(r));return o}getNextWorker(){const e=this.workers[this.workerIndex];return this.workerIndex=(this.workerIndex+1)%this.workers.length,e}getImage(e,t,i,s,r,o){return new Promise((a,l)=>{try{if(this.workers){const h=this.nextId++;this.messageManager[h]=[a,l];const c=this.getNextWorker();c&&c.postMessage({id:h,src:e,premultiplyAlpha:t,sx:i,sy:s,sw:r,sh:o})}}catch(h){l(h)}})}}const br=class br extends Ur{constructor(t,i){super(t);y(this,"type",Ae.color);y(this,"props");this.props=br.resolveDefaults(i||{})}get color(){return this.props.color}set color(t){this.props.color=t}async getTextureSource(){const t=new Uint8Array(4);return this.color===4294967295?(t[0]=255,t[1]=255,t[2]=255,t[3]=255):(t[0]=this.color>>16&255,t[1]=this.color>>8&255,t[2]=this.color&255,t[3]=this.color>>>24&255),this.setState("fetched",{width:1,height:1}),{data:t,premultiplyAlpha:!0}}static makeCacheKey(t){return`ColorTexture,${br.resolveDefaults(t).color}`}static resolveDefaults(t){return{color:t.color||4294967295}}};y(br,"z$__type__Props");let po=br;function sm(n){return/\.(ktx|pvr)$/.test(n)}const ic=async n=>{const t=await(await fetch(n)).arrayBuffer();return n.indexOf(".ktx")!==-1?rm(t):nm(t)},rm=async n=>{const e=new DataView(n),t=e.getUint32(12)===16909060,i=[],s={glInternalFormat:e.getUint32(28,t),pixelWidth:e.getUint32(36,t),pixelHeight:e.getUint32(40,t),numberOfMipmapLevels:e.getUint32(56,t),bytesOfKeyValueData:e.getUint32(60,t)};let r=64;r+=s.bytesOfKeyValueData;for(let o=0;o<s.numberOfMipmapLevels;o++){const a=e.getUint32(r);r+=4,i.push(e.buffer.slice(r,a)),r+=a}return{data:{glInternalFormat:s.glInternalFormat,mipmaps:i,width:s.pixelWidth||0,height:s.pixelHeight||0,type:"ktx"},premultiplyAlpha:!1}},nm=async n=>{const a=n,l=new Int32Array(a,0,13),h=l[12]+52,c=new Uint8Array(a,h),u=[],d={pixelWidth:l[7],pixelHeight:l[6],numberOfMipmapLevels:l[11]||0};let f=0,g=d.pixelWidth||0,p=d.pixelHeight||0;for(let m=0;m<d.numberOfMipmapLevels;m++){const _=(g+3>>2)*(p+3>>2)*8,T=new Uint8Array(a,c.byteOffset+f,_);u.push(T),f+=_,g=g>>1,p=p>>1}return{data:{glInternalFormat:36196,mipmaps:u,width:d.pixelWidth||0,height:d.pixelHeight||0,type:"pvr"},premultiplyAlpha:!1}};function om(n){return/\.(svg)(\?.*)?$/.test(n)}const sc=(n,e,t,i,s,r,o)=>new Promise((a,l)=>{const h=document.createElement("canvas"),c=h.getContext("2d");X(c),c.imageSmoothingEnabled=!0;const u=new Image;u.onload=()=>{const d=i??0,f=s??0,g=e||u.width,p=t||u.height;h.width=g,h.height=p,c.drawImage(u,0,0,g,p),a({data:c.getImageData(d,f,r??g,o??p),premultiplyAlpha:!1})},u.onerror=d=>{l(d)},u.src=n});function hd(n,e=""){return new Promise((t,i)=>{const s=new XMLHttpRequest;s.responseType=e,s.onreadystatechange=function(){s.readyState==XMLHttpRequest.DONE&&(s.status===0||s.status===200?t(s.response):i(s.statusText))},s.open("GET",n,!0),s.send(null)})}var Ni;let il=(Ni=class extends Ur{constructor(t,i){super(t);y(this,"props");y(this,"type",Ae.image);this.props=Ni.resolveDefaults(i)}hasAlphaChannel(t){return t.indexOf("image/png")!==-1}async loadImageFallback(t,i){const s=new Image;return typeof t=="string"&&pa(t)===!1&&(s.crossOrigin="anonymous"),new Promise(r=>{s.onload=()=>{r({data:s,premultiplyAlpha:i})},s.onerror=()=>{console.warn("Image loading failed, returning fallback object."),r({data:s,premultiplyAlpha:i})},t instanceof Blob?s.src=URL.createObjectURL(t):s.src=t})}async createImageBitmap(t,i,s,r,o,a){const l=i??t.type.includes("image/png"),h=this.txManager.imageBitmapSupported;return h.full===!0&&o!==null&&a!==null?{data:await createImageBitmap(t,s||0,r||0,o,a,{premultiplyAlpha:l?"premultiply":"none",colorSpaceConversion:"none",imageOrientation:"none"}),premultiplyAlpha:l}:h.basic===!0?{data:await createImageBitmap(t),premultiplyAlpha:l}:{data:await createImageBitmap(t,{premultiplyAlpha:l?"premultiply":"none",colorSpaceConversion:"none",imageOrientation:"none"}),premultiplyAlpha:l}}async loadImage(t){const{premultiplyAlpha:i,sx:s,sy:r,sw:o,sh:a}=this.props;if(this.txManager.hasCreateImageBitmap===!0){if(pa(t)===!1&&this.txManager.hasWorker===!0&&this.txManager.imageWorkerManager!==null)return this.txManager.imageWorkerManager.getImage(t,i,s,r,o,a);let l;return pa(t)===!0?l=Yp(t):l=await hd(t,"blob").then(h=>h),this.createImageBitmap(l,i,s,r,o,a)}return this.loadImageFallback(t,i??!0)}async getTextureSource(){var r,o;let t;try{t=await this.determineImageTypeAndLoadImage()}catch(a){return this.setState("failed",a),{data:null}}if(t.data===null)return this.setState("failed",Error("ImageTexture: No image data")),{data:null};let i,s;return t.data instanceof Uint8Array?(i=this.props.width??0,s=this.props.height??0):(i=((r=t.data)==null?void 0:r.width)??(this.props.width||0),s=((o=t.data)==null?void 0:o.height)??(this.props.height||0)),this.setState("fetched",{width:i,height:s}),{data:t.data,premultiplyAlpha:this.props.premultiplyAlpha??!0}}determineImageTypeAndLoadImage(){const{src:t,premultiplyAlpha:i,type:s}=this.props;if(t===null)return{data:null};if(typeof t!="string"){if(t instanceof Blob)if(this.txManager.hasCreateImageBitmap===!0){const{sx:o,sy:a,sw:l,sh:h}=this.props;return this.createImageBitmap(t,i,o,a,l,h)}else return this.loadImageFallback(t,i??!0);return t instanceof ImageData?{data:t,premultiplyAlpha:i}:{data:t(),premultiplyAlpha:i}}const r=Wp(t);return s==="regular"?this.loadImage(r):s==="svg"?sc(r,this.props.width,this.props.height,this.props.sx,this.props.sy,this.props.sw,this.props.sh):om(t)===!0?sc(r,this.props.width,this.props.height,this.props.sx,this.props.sy,this.props.sw,this.props.sh):s==="compressed"||sm(t)===!0?ic(r):this.loadImage(r)}static makeCacheKey(t){const i=Ni.resolveDefaults(t),s=i.key||i.src;if(typeof s!="string")return!1;let r="";return i.sh!==null&&i.sw!==null&&(r+=",",r+=i.sx??"",r+=i.sy??"",r+=i.sw||"",r+=i.sh||""),`ImageTexture,${s},${i.premultiplyAlpha??"true"}${r}`}static resolveDefaults(t){return{src:t.src??"",premultiplyAlpha:t.premultiplyAlpha??!0,key:t.key??null,type:t.type??null,width:t.width??null,height:t.height??null,sx:t.sx??null,sy:t.sy??null,sw:t.sw??null,sh:t.sh??null}}},y(Ni,"z$__type__Props"),Ni);var $i;let am=($i=class extends Ur{constructor(t,i){super(t);y(this,"props");y(this,"type",Ae.noise);this.props=$i.resolveDefaults(i)}async getTextureSource(){const{width:t,height:i}=this.props,s=t*i*4,r=new Uint8ClampedArray(s);for(let o=0;o<s;o+=4){const a=Math.floor(Math.random()*256);r[o]=a,r[o+1]=a,r[o+2]=a,r[o+3]=255}return this.setState("fetched"),{data:new ImageData(r,t,i)}}static makeCacheKey(t){if(t.cacheId===void 0)return!1;const i=$i.resolveDefaults(t);return`NoiseTexture,${i.width},${i.height},${i.cacheId}`}static resolveDefaults(t){return{width:t.width??128,height:t.height??128,cacheId:t.cacheId??0}}},y($i,"z$__type__Props"),$i);const Ho=class Ho extends Ur{constructor(t,i){super(t);y(this,"props");y(this,"parentTexture");y(this,"type",Ae.subTexture);y(this,"onParentTxLoaded",()=>{this.forwardParentTxState("loaded",{width:this.props.width,height:this.props.height})});y(this,"onParentTxFailed",(t,i)=>{this.forwardParentTxState("failed",i)});y(this,"onParentTxFetched",()=>{this.forwardParentTxState("fetched",{width:this.props.width,height:this.props.height})});y(this,"onParentTxFetching",()=>{this.forwardParentTxState("fetching")});y(this,"onParentTxLoading",()=>{this.forwardParentTxState("loading")});y(this,"onParentTxFreed",()=>{this.forwardParentTxState("freed")});this.props=Ho.resolveDefaults(i||{}),X(this.props.texture,"SubTexture requires a parent texture"),X(this.props.texture instanceof il,"SubTexture requires an ImageTexture parent"),this.parentTexture=t.resolveParentTexture(this.props.texture),this.renderableOwners.size>0&&this.parentTexture.setRenderableOwner(this,!0),queueMicrotask(()=>{const s=this.parentTexture;s.state==="loaded"?this.onParentTxLoaded(s,s.dimensions):s.state==="fetching"?this.onParentTxFetching():s.state==="fetched"?this.onParentTxFetched():s.state==="loading"?this.onParentTxLoading():s.state==="failed"?this.onParentTxFailed(s,s.error):s.state==="freed"&&this.onParentTxFreed(),s.on("fetched",this.onParentTxFetched),s.on("loading",this.onParentTxLoading),s.on("fetching",this.onParentTxFetching),s.on("loaded",this.onParentTxLoaded),s.on("failed",this.onParentTxFailed),s.on("freed",this.onParentTxFreed)})}forwardParentTxState(t,i){this.setState(t,i)}onChangeIsRenderable(t){this.parentTexture.setRenderableOwner(this,t)}async getTextureSource(){return new Promise((t,i)=>{this.setState("fetched"),t({data:this.props})})}static makeCacheKey(t){return!1}static resolveDefaults(t){return{texture:t.texture,x:t.x||0,y:t.y||0,width:t.width||0,height:t.height||0}}};y(Ho,"z$__type__Props");let Rr=Ho;const Vo=class Vo extends Ur{constructor(t,i){super(t);y(this,"props");y(this,"type",Ae.renderToTexture);this.props=Vo.resolveDefaults(i||{})}get width(){return this.props.width}set width(t){this.props.width=t}get height(){return this.props.height}set height(t){this.props.height=t}async getTextureSource(){return this.setState("fetched"),{data:null,premultiplyAlpha:null}}static resolveDefaults(t){return{width:t.width||256,height:t.height||256}}};y(Vo,"z$__type__Props");let mo=Vo;async function lm(){var s,r,o;const n=new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,1,3,0,0,0,37,219,86,202,0,0,0,3,80,76,84,69,0,0,0,167,122,61,218,0,0,0,1,116,82,78,83,0,64,230,216,102,0,0,0,10,73,68,65,84,8,215,99,96,0,0,0,2,0,1,226,33,188,51,0,0,0,0,73,69,78,68,174,66,96,130]),e={basic:!1,options:!1,full:!1},t=new Blob([n],{type:"image/png"}),i=await createImageBitmap(t);(s=i.close)==null||s.call(i),e.basic=!0;try{const a={premultiplyAlpha:"none"},l=await createImageBitmap(t,a);(r=l.close)==null||r.call(l),e.options=!0}catch{}try{const a=await createImageBitmap(t,0,0,1,1,{premultiplyAlpha:"none"});(o=a.close)==null||o.call(a),e.full=!0}catch{}return e}class hm extends li{constructor(t,i){super();y(this,"keyCache",new Map);y(this,"inverseKeyCache",new WeakMap);y(this,"txConstructors",{});y(this,"downloadTextureSourceQueue",[]);y(this,"priorityQueue",[]);y(this,"uploadTextureQueue",[]);y(this,"initialized",!1);y(this,"stage");y(this,"numImageWorkers");y(this,"imageWorkerManager",null);y(this,"hasCreateImageBitmap",!!self.createImageBitmap);y(this,"imageBitmapSupported",{basic:!1,options:!1,full:!1});y(this,"hasWorker",!!self.Worker);y(this,"renderer");y(this,"frameTime",0);const{numImageWorkers:s,createImageBitmapSupport:r}=i;this.stage=t,this.numImageWorkers=s,r==="auto"?lm().then(o=>{this.initialize(o)}).catch(o=>{console.warn("[Lightning] createImageBitmap is not supported on this browser. ImageTexture will be slower."),this.initialized=!0,this.emit("initialized")}):this.initialize({basic:r==="basic",options:r==="options",full:r==="full"}),this.registerTextureType("ImageTexture",il),this.registerTextureType("ColorTexture",po),this.registerTextureType("NoiseTexture",am),this.registerTextureType("SubTexture",Rr),this.registerTextureType("RenderTexture",mo)}registerTextureType(t,i){this.txConstructors[t]=i}initialize(t){this.hasCreateImageBitmap=t.basic||t.options||t.full,this.imageBitmapSupported=t,this.hasCreateImageBitmap||console.warn("[Lightning] createImageBitmap is not supported on this browser. ImageTexture will be slower."),this.hasCreateImageBitmap&&this.hasWorker&&this.numImageWorkers>0?this.imageWorkerManager=new im(this.numImageWorkers,t):console.warn("[Lightning] Imageworker is 0 or not supported on this browser. Image loading will be slower."),this.initialized=!0,this.emit("initialized")}enqueueDownloadTextureSource(t){this.downloadTextureSourceQueue.includes(t)||this.downloadTextureSourceQueue.push(t)}enqueueUploadTexture(t){this.uploadTextureQueue.includes(t)===!1&&this.uploadTextureQueue.push(t)}createTexture(t,i){let s;const r=this.txConstructors[t];if(!r)throw new Error(`Texture type "${t}" is not registered`);const o=r.makeCacheKey(i);return o&&this.keyCache.has(o)?s=this.keyCache.get(o):(s=new r(this,i),o&&this.initTextureToCache(s,o)),s}orphanTexture(t){this.removeTextureFromQueue(t),t.type!==Ae.subTexture&&this.stage.txMemManager.addToOrphanedTextures(t)}loadTexture(t,i){if(this.stage.txMemManager.removeFromOrphanedTextures(t),t.type!==Ae.subTexture){if(t.ctxTexture!==void 0&&t.ctxTexture.state==="loaded"){t.setState("loaded");return}if(!(this.downloadTextureSourceQueue.includes(t)===!0||this.uploadTextureQueue.includes(t)===!0)){if(t.ctxTexture!==void 0&&t.ctxTexture.state==="loading"){if(t.textureData!==null){this.enqueueUploadTexture(t);return}t.free()}if(this.initialized===!1){this.priorityQueue.push(t);return}if(t.state==="failed"&&(t.free(),t.freeTextureData()),(t.type===Ae.color||t.type===Ae.renderToTexture)&&t.state!=="initial"){t.setState("fetched"),this.enqueueUploadTexture(t);return}t.setState("loading"),i===!0&&t.getTextureData().then(()=>{this.uploadTexture(t)}).catch(s=>{console.error(s)}),this.enqueueDownloadTextureSource(t)}}}uploadTexture(t){if(this.stage.txMemManager.doNotExceedCriticalThreshold===!0&&this.stage.txMemManager.criticalCleanupRequested===!0){this.enqueueUploadTexture(t);return}const i=t.loadCtxTexture();if(i!==null&&i.state==="loaded"){t.setState("loaded");return}i.load()}isProcessingTexture(t){return this.downloadTextureSourceQueue.includes(t)===!0||this.uploadTextureQueue.includes(t)===!0}processSome(t){if(this.initialized===!1)return;const i=as();for(;this.priorityQueue.length>0&&as()-i<t;){const s=this.priorityQueue.pop();s.getTextureData().then(()=>{this.uploadTexture(s)})}for(;this.uploadTextureQueue.length>0&&as()-i<t;)this.uploadTexture(this.uploadTextureQueue.pop());for(;this.downloadTextureSourceQueue.length>0&&as()-i<t;){const s=this.downloadTextureSourceQueue.shift();s.getTextureData().then(()=>{s.state==="fetched"&&this.enqueueUploadTexture(s)})}}hasUpdates(){return this.downloadTextureSourceQueue.length>0||this.uploadTextureQueue.length>0}initTextureToCache(t,i){const{keyCache:s,inverseKeyCache:r}=this;s.set(i,t),r.set(t,i)}getTextureFromCache(t){return this.keyCache.get(t)}removeTextureFromCache(t){const{inverseKeyCache:i,keyCache:s}=this,r=i.get(t);r&&s.delete(r)}removeTextureFromQueue(t){const i=this.downloadTextureSourceQueue.indexOf(t);i!==-1&&this.downloadTextureSourceQueue.splice(i,1);const s=this.uploadTextureQueue.indexOf(t);s!==-1&&this.uploadTextureQueue.splice(s,1)}resolveParentTexture(t){if(!(t!=null&&t.props))return t;const i=il.makeCacheKey(t.props);return(i?this.getTextureFromCache(i):void 0)??t}}const cm={normal:400,bold:700,bolder:900,lighter:100},rc=n=>typeof n=="number"?n:cm[n]||400;function um(n,e,t,i,s){let r=rc(t);for(const o of n){const a=o[e];if(!a)continue;if(a.size===1)return console.warn(`TrFontManager: Only one font face found for family: '${e}' - will be used for all weights and styles`),a.values().next().value;const l=new Map;for(const c of a){const u=rc(c.descriptors.weight);if(u===r&&c.descriptors.style===i&&c.descriptors.stretch===s)return c;l.set(u,c)}const h=`TrFontManager: No exact match: '${e} Weight: ${r} Style: ${i} Stretch: ${s}'`;if(console.error(h),r===400&&l.has(500))return l.get(500);if(r===500&&l.has(400))return l.get(400);if(r<400){for(;r>0;){if(l.has(r))return l.get(r);r-=100}r=600}for(;r<1e3;){if(l.has(r))return l.get(r);r+=100}for(r=500;r>0;){if(l.has(r))return l.get(r);r-=100}}}class dm{constructor(e){y(this,"textRenderers");y(this,"fontCache",new Map);this.textRenderers=e}addFontFace(e){for(const t in this.textRenderers){const i=this.textRenderers[t];i&&i.isFontFaceSupported(e)&&i.addFontFace(e)}}resolveFontFace(e,t,i){const{fontFamily:s,fontWeight:r,fontStyle:o,fontStretch:a}=t,l=`${i}_${s}_${o}_${r}_${a}`;if(this.fontCache.has(l)===!0)return this.fontCache.get(l);const h=um(e,s,r,o,a);return h!==void 0&&this.fontCache.set(l,h),h}}class cd{static makeCacheKey(e){return!1}static resolveDefaults(e){return{}}}function nc(n,e,t){const i=n.createShader(e);if(!i){const r=n.getError();throw new Error(`Unable to create the shader: ${e===n.VERTEX_SHADER?"VERTEX_SHADER":"FRAGMENT_SHADER"}.${r?` WebGlContext Error: ${r}`:""}`)}if(n.shaderSource(i,t),n.compileShader(i),!!n.getShaderParameter(i,n.COMPILE_STATUS))return i;console.error(n.getShaderInfoLog(i)),n.deleteShader(i)}function fm(n,e,t){const i=n.createProgram();if(!i)throw new Error("Unable to create program");if(n.attachShader(i,e),n.attachShader(i,t),n.linkProgram(i),!!n.getProgramParameter(i,n.LINK_STATUS))return i;console.warn(n.getProgramInfoLog(i)),n.deleteProgram(i)}class gs extends cd{constructor(t){super();y(this,"boundBufferCollection",null);y(this,"buffersBound",!1);y(this,"program");y(this,"vao");y(this,"renderer");y(this,"glw");y(this,"attributeBuffers");y(this,"attributeLocations");y(this,"attributeNames");y(this,"uniformLocations");y(this,"uniformTypes");y(this,"supportsIndexedTextures");const i=this.renderer=t.renderer,s=this.glw=this.renderer.glw;this.supportsIndexedTextures=t.supportsIndexedTextures||!1;const r=s.isWebGl2(),o=r&&t.webgl2Extensions||!r&&t.webgl1Extensions||[],a=r?"2.0":"1.0";o.forEach(p=>{if(!s.getExtension(p))throw new Error(`Shader "${this.constructor.name}" requires extension "${p}" for WebGL ${a} but wasn't found`)});const l=t.shaderSources||this.constructor.shaderSources;if(l)r&&(l!=null&&l.webGl2)&&(l.fragment=l.webGl2.fragment,l.vertex=l.webGl2.vertex,delete l.webGl2);else throw new Error(`Shader "${this.constructor.name}" is missing shaderSources.`);const h=i.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS,c=l.vertex instanceof Function?l.vertex(h):l.vertex,u=l.fragment instanceof Function?l.fragment(h):l.fragment,d=nc(s,s.VERTEX_SHADER,c),f=nc(s,s.FRAGMENT_SHADER,u);if(!d||!f)throw new Error(`Unable to create the following shader(s): ${[!d&&"VERTEX_SHADER",!f&&"FRAGMENT_SHADER"].filter(Boolean).join(" and ")}`);const g=fm(s,d,f);if(!g)throw new Error("Unable to create program");this.program=g,this.attributeLocations={},this.attributeBuffers={},this.attributeNames=[],[...t.attributes].forEach(p=>{const m=s.getAttribLocation(this.program,p);if(m<0)throw new Error(`${this.constructor.name}: Vertex shader must have an attribute "${p}"!`);const _=s.createBuffer();if(!_)throw new Error(`${this.constructor.name}: Could not create buffer for attribute "${p}"`);this.attributeLocations[p]=m,this.attributeBuffers[p]=_,this.attributeNames.push(p)}),this.uniformLocations={},this.uniformTypes={},t.uniforms.forEach(p=>{const m=s.getUniformLocation(this.program,p.name);if(this.uniformTypes[p.name]=p.uniform,!m){console.warn(`Shader "${this.constructor.name}" could not get uniform location for "${p.name}"`);return}this.uniformLocations[p.name]=m})}bindBufferAttribute(t,i,s){const{glw:r}=this;r.enableVertexAttribArray(t),r.vertexAttribPointer(i,t,s.size,s.type,s.normalized,s.stride,s.offset)}disableAttribute(t){this.glw.disableVertexAttribArray(t)}disableAttributes(){for(const t in this.attributeLocations)this.disableAttribute(this.attributeLocations[t]);this.boundBufferCollection=null}canBatchShaderProps(t,i){return!1}bindRenderOp(t,i){this.bindBufferCollection(t.buffers),t.textures.length>0&&this.bindTextures(t.textures);const{glw:s,parentHasRenderTexture:r,renderToTexture:o}=t;if(!(o&&r)){if(r){const{width:a,height:l}=t.framebufferDimensions||{};s.uniform1f(this.getUniformLocation("u_pixelRatio"),1),s.uniform2f(this.getUniformLocation("u_resolution"),a??0,l??0)}else s.uniform1f(this.getUniformLocation("u_pixelRatio"),t.options.pixelRatio),s.uniform2f(this.getUniformLocation("u_resolution"),s.canvas.width,s.canvas.height);if(i){if(go(i,"$dimensions")){let a=i.$dimensions;a||(a=t.dimensions),s.uniform2f(this.getUniformLocation("u_dimensions"),a.width,a.height)}if(go(i,"$alpha")){let a=i.$alpha;a||(a=t.alpha),s.uniform1f(this.getUniformLocation("u_alpha"),a)}this.bindProps(i)}}}getUniformLocation(t){return this.uniformLocations[t]||null}bindBufferCollection(t){if(this.boundBufferCollection!==t){for(const i in this.attributeLocations){const s=t.getBuffer(i),r=t.getAttributeInfo(i);X(s,`Buffer for "${i}" not found`),X(r),this.bindBufferAttribute(this.attributeLocations[i],s,r)}this.boundBufferCollection=t}}bindProps(t){}bindTextures(t){}attach(){this.glw.useProgram(this.program),this.glw.isWebGl2()&&this.vao&&this.glw.bindVertexArray(this.vao)}detach(){this.disableAttributes()}}y(gs,"shaderSources");var ja;let gm=(ja=class extends gs{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2fv"}]})}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}},y(ja,"shaderSources",{vertex:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      attribute vec2 a_position;
      attribute vec2 a_textureCoordinate;
      attribute vec4 a_color;

      uniform vec2 u_resolution;
      uniform float u_pixelRatio;


      varying vec4 v_color;
      varying vec2 v_textureCoordinate;

      void main() {
        vec2 normalized = a_position * u_pixelRatio;
        vec2 screenSpace = vec2(2.0 / u_resolution.x, -2.0 / u_resolution.y);

        v_color = a_color;
        v_textureCoordinate = a_textureCoordinate;

        gl_Position = vec4(normalized.x * screenSpace.x - 1.0, normalized.y * -abs(screenSpace.y) + 1.0, 0.0, 1.0);
        gl_Position.y = -sign(screenSpace.y) * gl_Position.y;
      }
    `,fragment:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      uniform vec2 u_resolution;
      uniform sampler2D u_texture;

      varying vec4 v_color;
      varying vec2 v_textureCoordinate;

      void main() {
          vec4 color = texture2D(u_texture, v_textureCoordinate);
          gl_FragColor = vec4(v_color) * texture2D(u_texture, v_textureCoordinate);
      }
    `}),ja);class ud extends gs{constructor(t){super({renderer:t,attributes:["a_position","a_textureCoordinate","a_color","a_textureIndex"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_textures[0]",uniform:"uniform1iv"}]});y(this,"supportsIndexedTextures",!0)}bindTextures(t){const{renderer:i,glw:s}=this;if(t.length>i.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS)throw new Error(`DefaultShaderBatched: Cannot bind more than ${i.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS} textures`);t.forEach((o,a)=>{s.activeTexture(a),s.bindTexture(o.ctxTexture)});const r=Array.from(Array(t.length).keys());this.glw.uniform1iv(this.getUniformLocation("u_textures[0]"),r)}}y(ud,"shaderSources",{vertex:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      attribute vec2 a_textureCoordinate;
      attribute vec2 a_position;
      attribute vec4 a_color;
      attribute float a_textureIndex;
      attribute float a_depth;

      uniform vec2 u_resolution;
      uniform float u_pixelRatio;

      varying vec4 v_color;
      varying vec2 v_textureCoordinate;
      varying float v_textureIndex;

      void main(){
        vec2 normalized = a_position * u_pixelRatio / u_resolution;
        vec2 zero_two = normalized * 2.0;
        vec2 clip_space = zero_two - 1.0;

        // pass to fragment
        v_color = a_color;
        v_textureCoordinate = a_textureCoordinate;
        v_textureIndex = a_textureIndex;

        // flip y
        gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);
      }
    `,fragment:t=>`
      #define txUnits ${t}
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      uniform vec2 u_resolution;
      uniform sampler2D u_image;
      uniform sampler2D u_textures[txUnits];

      varying vec4 v_color;
      varying vec2 v_textureCoordinate;
      varying float v_textureIndex;

      vec4 sampleFromTexture(sampler2D textures[${t}], int idx, vec2 uv) {
        ${Array.from(Array(t).keys()).map(i=>`
          ${i!==0?"else ":""}if (idx == ${i}) {
            return texture2D(textures[${i}], uv);
          }
        `).join("")}
        return texture2D(textures[0], uv);
      }

      void main(){
        gl_FragColor = vec4(v_color) * sampleFromTexture(u_textures, int(v_textureIndex), v_textureCoordinate);
      }
    `});class We{constructor(e){y(this,"priority",1);y(this,"name","");y(this,"ref");y(this,"target");y(this,"passParameters","");y(this,"declaredUniforms","");y(this,"uniformInfo",{});const{ref:t,target:i,props:s={}}=e;this.ref=t,this.target=i;const r={},o=[];let a="";const l=this.constructor.uniforms||{};for(const h in l){const c=l[h],u=c.type,d=`${t}_${h}`;let f="";c.size&&(f=`[${c.size(s)}]`),o.push(d),a+=`uniform ${u} ${d}${f};`,r[h]={name:d,uniform:l[h].method}}this.passParameters=o.join(","),this.declaredUniforms=a,this.uniformInfo=r}static getEffectKey(e){return""}static getMethodParameters(e,t){const i=[];for(const s in e){const r=e[s];let o="";r.size&&(o=`[${r.size(t)}]`),i.push(`${r.type} ${s}${o}`)}return i.join(",")}static resolveDefaults(e){return{}}static makeEffectKey(e){return!1}}y(We,"uniforms",{}),y(We,"methods"),y(We,"onShaderMask"),y(We,"onColorize"),y(We,"onEffectMask");const ma=new Map,pm=(n,e)=>{const t=JSON.stringify(n);if(ma.has(t))return ma.get(t);n=n??[];const i=[],s=n.length;let r=0;for(;r<s;r++){const{name:o,type:a,props:l}=n[r],h={name:o,type:a,props:{}},c=e[a],u=c.resolveDefaults(l),d=c.uniforms,f=Object.keys(d),g=f.length;let p=0;for(;p<g;p++){const m=f[p],_=d[m],T={value:u[m],programValue:void 0,method:_.method,updateOnBind:_.updateOnBind||!1,hasValidator:_.validator!==void 0,hasProgramValueUpdater:_.updateProgramValue!==void 0},S=T.hasValidator&&_.validator(u[m],u)||u[m];u[m]!==S&&(T.validatedValue=S),T.hasProgramValueUpdater&&_.updateProgramValue(T),T.programValue===void 0&&(T.programValue=T.value),h.props[m]=T}i.push(h)}return ma.set(t,i),i},ti=class ti extends gs{constructor(t,i,s){const r=ti.createShader(i,s);super({renderer:t,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2fv"},{name:"u_dimensions",uniform:"uniform2fv"},{name:"u_alpha",uniform:"uniform1f"},...r.uniforms],shaderSources:{vertex:r.vertex,fragment:r.fragment}});y(this,"effects",[]);this.effects=r.effects}bindTextures(t){const{glw:i}=this;i.activeTexture(0),i.bindTexture(t[0].ctxTexture)}bindUniformMethods(t){const i=this.glw,s=t.effects,r=s.length;for(let o=0;o<r;o++){const a=this.effects[o].uniformInfo,l=s[o],h=Object.keys(l.props),c=h.length;for(let u=0;u<c;u++){const d=h[u],f=l.props[d].method,g=this.getUniformLocation(a[d].name);if(f==="uniform2fv"||f==="uniform2iv"||f==="uniform3iv"||f==="uniform4fv"||f==="uniform4iv"||f==="uniformMatrix2fv"||f==="uniformMatrix3fv"||f==="uniformMatrix4fv"||f==="uniform1f"||f==="uniform1fv"||f==="uniform1i"||f==="uniform1iv"){l.props[d].setUniformValue=function(){i[f](g,this.programValue)};continue}if(f==="uniform2f"||f==="uniform2i"){l.props[d].setUniformValue=function(){i[f](g,this.programValue[0],this.programValue[1])};continue}if(f==="uniform3f"||f==="uniform3i"){l.props[d].setUniformValue=function(){i[f](g,this.programValue[0],this.programValue[1],this.programValue[2])};continue}if(f==="uniform4f"||f==="uniform4i"){l.props[d].setUniformValue=function(){i[f](g,this.programValue[0],this.programValue[1],this.programValue[2],this.programValue[3])};continue}}}}bindProps(t){var o;const i=t.effects,s=i.length;let r=0;for(;r<s;r++){const a=i[r],l=Object.keys(a.props),h=l.length;let c=0;for(;c<h;c++){const u=l[c],d=a.props[u];if(d.updateOnBind===!0){const f=(o=this.renderer.shManager.getRegisteredEffects()[a.type])==null?void 0:o.uniforms[u];f==null||f.updateProgramValue(a.props[u],t)}d.setUniformValue()}}}canBatchShaderProps(t,i){if(t.$alpha!==i.$alpha||t.$dimensions.width!==i.$dimensions.width||t.$dimensions.height!==i.$dimensions.height||t.effects.length!==i.effects.length)return!1;const s=t.effects.length;let r=0;for(;r<s;r++){const o=t.effects[r],a=i.effects[r];if(o.type!==a.type)return!1;for(const l in o.props)if(a.props&&!a.props[l]||o.props[l].value!==a.props[l].value)return!1}return!0}static createShader(t,i){const s={},r={};let o="";const a=[],l=[],h=t.effects.map(g=>{const p=i[g.type],m=p.getEffectKey(g.props||{});s[m]=s[m]?++s[m]:1;const _=s[m];_===1&&l.push({key:m,type:g.type,props:g.props});const T=new p({ref:`${m}${_===1?"":_}`,target:m,props:g.props});return o+=T.declaredUniforms,a.push(...Object.values(T.uniformInfo)),T});let c="";l==null||l.forEach(g=>{const p=i[g.type],m=p.resolveDefaults(g.props??{}),_=[];for(const b in p.methods){let A=b;const L=p.methods[b];r[b]&&r[b]!==L&&(A=ti.resolveMethodDuplicate(b,L,r)),r[A]=L.replace("function",A),_.push({m:b,cm:A})}let T=p.onShaderMask instanceof Function?p.onShaderMask(m):p.onShaderMask,S=p.onColorize instanceof Function?p.onColorize(m):p.onColorize,v=p.onEffectMask instanceof Function?p.onEffectMask(m):p.onEffectMask;_.forEach(b=>{const{m:A,cm:L}=b,R=new RegExp(`\\$${A}`,"g");T&&(T=T.replace(R,L)),S&&(S=S.replace(R,L)),v&&(v=v.replace(R,L))});const E=p.getMethodParameters(p.uniforms,m),C=E.length>0?`, ${E}`:"";T&&(c+=`
        float fx_${g.key}_onShaderMask(float shaderMask ${C}) {
          ${T}
        }
        `),S&&(c+=`
          vec4 fx_${g.key}_onColorize(float shaderMask, vec4 maskColor, vec4 shaderColor${C}) {
            ${S}
          }
        `),v&&(c+=`
          vec4 fx_${g.key}_onEffectMask(float shaderMask, vec4 maskColor, vec4 shaderColor${C}) {
            ${v}
          }
        `)});let u="";for(const g in r)u+=r[g];let d="mix(shaderColor, maskColor, clamp(-(lng_DefaultMask), 0.0, 1.0))",f=`

    `;for(let g=0;g<h.length;g++){const p=h[g],m=p.passParameters.length>0?`, ${p.passParameters}`:"",_=i[p.name];_.onShaderMask&&(f+=`
        shaderMask = fx_${p.target}_onShaderMask(shaderMask ${m});
        `),_.onColorize&&(f+=`
        maskColor = fx_${p.target}_onColorize(shaderMask, maskColor, shaderColor${m});
        `),_.onEffectMask&&(d=`fx_${p.target}_onEffectMask(shaderMask, maskColor, shaderColor${m})`);const T=h[g+1];(T===void 0||i[T.name].onEffectMask)&&(f+=`
          shaderColor = ${d};
        `)}return{effects:h,uniforms:a,fragment:ti.fragment(o,u,c,f),vertex:ti.vertex()}}static resolveMethodDuplicate(t,i,s,r=0){const o=t+(r>0?r:"");return s[o]&&s[o]!==i?this.resolveMethodDuplicate(t,i,s,++r):o}static resolveDefaults(t,i){return X(i),{effects:pm(t.effects??[],i),$dimensions:{width:0,height:0},$alpha:0}}static makeCacheKey(t,i){var r;let s="";return(r=t.effects)==null||r.forEach(o=>{const l=i[o.type].getEffectKey(o.props||{});s+=`,${l}`}),`DynamicShader${s}`}};y(ti,"z$__type__Props"),y(ti,"vertex",()=>`
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision mediump float;
    # endif

    attribute vec2 a_textureCoordinate;
    attribute vec2 a_position;
    attribute vec4 a_color;
    attribute float a_textureIndex;

    uniform vec2 u_resolution;
    uniform float u_pixelRatio;

    varying vec4 v_color;
    varying vec2 v_textureCoordinate;
    varying float v_textureIndex;

    void main(){
      vec2 normalized = a_position * u_pixelRatio / u_resolution;
      vec2 zero_two = normalized * 2.0;
      vec2 clip_space = zero_two - 1.0;

      // pass to fragment
      v_color = a_color;
      v_textureCoordinate = a_textureCoordinate;
      v_textureIndex = a_textureIndex;

      // flip y
      gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);
    }
  `),y(ti,"fragment",(t,i,s,r)=>`
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision mediump float;
    # endif

    #define PI 3.14159265359

    uniform vec2 u_resolution;
    uniform vec2 u_dimensions;
    uniform float u_alpha;
    uniform float u_radius;
    uniform sampler2D u_texture;
    uniform float u_pixelRatio;

    ${t}

    varying vec4 v_color;
    varying vec2 v_textureCoordinate;

    ${i}

    ${s}

    void main() {
      vec2 p = v_textureCoordinate.xy * u_dimensions - u_dimensions * 0.5;
      vec2 d = abs(p) - (u_dimensions) * 0.5;
      float lng_DefaultMask = min(max(d.x, d.y), 0.0) + length(max(d, 0.0));

      vec4 shaderColor = vec4(0.0);
      float shaderMask = lng_DefaultMask;

      vec4 maskColor = texture2D(u_texture, v_textureCoordinate) * v_color;

      shaderColor = mix(shaderColor, maskColor, clamp(-(lng_DefaultMask + 0.5), 0.0, 1.0));

      ${r}

      gl_FragColor = shaderColor * u_alpha;
    }
  `);let Os=ti;class sl extends gs{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2f"},{name:"u_dimensions",uniform:"uniform2fv"},{name:"u_radius",uniform:"uniform1f"}]})}static resolveDefaults(e){return{radius:e.radius||10,$dimensions:{width:0,height:0}}}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}bindProps(e){const t=Math.min(e.$dimensions.width,e.$dimensions.height)/(2*e.radius);this.glw.uniform1f(this.getUniformLocation("u_radius"),e.radius*Math.min(t,1))}canBatchShaderProps(e,t){return e.radius===t.radius&&e.$dimensions.width===t.$dimensions.width&&e.$dimensions.height===t.$dimensions.height}}y(sl,"z$__type__Props"),y(sl,"shaderSources",{vertex:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      attribute vec2 a_position;
      attribute vec2 a_textureCoordinate;
      attribute vec4 a_color;
      attribute float a_textureIndex;
      attribute float a_depth;

      uniform vec2 u_resolution;
      uniform float u_pixelRatio;

      varying vec4 v_color;
      varying vec2 v_textureCoordinate;

      void main() {
        vec2 normalized = a_position * u_pixelRatio / u_resolution;
        vec2 zero_two = normalized * 2.0;
        vec2 clip_space = zero_two - 1.0;

        // pass to fragment
        v_color = a_color;
        v_textureCoordinate = a_textureCoordinate;

        // flip y
        gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);
      }
    `,fragment:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif

      uniform vec2 u_resolution;
      uniform vec2 u_dimensions;
      uniform float u_radius;
      uniform sampler2D u_texture;

      varying vec4 v_color;
      varying vec2 v_textureCoordinate;

      float boxDist(vec2 p, vec2 size, float radius){
        size -= vec2(radius);
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;
      }

      float fillMask(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }

      void main() {
        vec4 color = texture2D(u_texture, v_textureCoordinate) * v_color;
        vec2 halfDimensions = u_dimensions * 0.5;

        float d = boxDist(v_textureCoordinate.xy * u_dimensions - halfDimensions, halfDimensions + 0.5, u_radius);
        gl_FragColor = mix(vec4(0.0), color, fillMask(d));
      }
    `});const mm=new Float32Array([1,0,0,0,1,0,0,0,1]),Ar=class Ar extends gs{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_transform",uniform:"uniformMatrix3fv"},{name:"u_scrollY",uniform:"uniform1f"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2f"},{name:"u_color",uniform:"uniform4fv"},{name:"u_size",uniform:"uniform1f"},{name:"u_distanceRange",uniform:"uniform1f"},{name:"u_debug",uniform:"uniform1i"}]})}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}bindProps(e){const t=Ar.resolveDefaults(e);for(const i in t)if(i==="transform")this.glw.uniformMatrix3fv(this.getUniformLocation("u_transform"),t[i]);else if(i==="scrollY")this.glw.uniform1f(this.getUniformLocation("u_scrollY"),t[i]);else if(i==="color"){const s=Nr(t.color);this.glw.uniform4fv(this.getUniformLocation("u_color"),s)}else i==="size"?this.glw.uniform1f(this.getUniformLocation("u_size"),t[i]):i==="distanceRange"?this.glw.uniform1f(this.getUniformLocation("u_distanceRange"),t[i]):i==="debug"&&this.glw.uniform1i(this.getUniformLocation("u_debug"),t[i]?1:0)}static resolveDefaults(e={}){return{transform:e.transform??mm,scrollY:e.scrollY??0,color:e.color??4294967295,size:e.size??16,distanceRange:e.distanceRange??1,debug:e.debug??!1}}};y(Ar,"z$__type__Props"),y(Ar,"shaderSources",{vertex:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif
      // an attribute is an input (in) to a vertex shader.
      // It will receive data from a buffer
      attribute vec2 a_position;
      attribute vec2 a_textureCoordinate;

      uniform vec2 u_resolution;
      uniform mat3 u_transform;
      uniform float u_scrollY;
      uniform float u_pixelRatio;
      uniform float u_size;

      varying vec2 v_texcoord;

      void main() {
        vec2 scrolledPosition = a_position * u_size - vec2(0, u_scrollY);
        vec2 transformedPosition = (u_transform * vec3(scrolledPosition, 1)).xy;

        // Calculate screen space with pixel ratio
        vec2 screenSpace = (transformedPosition * u_pixelRatio / u_resolution * 2.0 - 1.0) * vec2(1, -1);

        gl_Position = vec4(screenSpace, 0.0, 1.0);
        v_texcoord = a_textureCoordinate;

      }
    `,fragment:`
      # ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      # else
      precision mediump float;
      # endif
      uniform vec4 u_color;
      uniform sampler2D u_texture;
      uniform float u_distanceRange;
      uniform float u_pixelRatio;
      uniform int u_debug;

      varying vec2 v_texcoord;

      float median(float r, float g, float b) {
          return max(min(r, g), min(max(r, g), b));
      }

      void main() {
          vec3 sample = texture2D(u_texture, v_texcoord).rgb;
          if (u_debug == 1) {
            gl_FragColor = vec4(sample.r, sample.g, sample.b, 1.0);
            return;
          }
          float scaledDistRange = u_distanceRange * u_pixelRatio;
          float sigDist = scaledDistRange * (median(sample.r, sample.g, sample.b) - 0.5);
          float opacity = clamp(sigDist + 0.5, 0.0, 1.0) * u_color.a;

          // Build the final color.
          // IMPORTANT: We must premultiply the color by the alpha value before returning it.
          gl_FragColor = vec4(u_color.r * opacity, u_color.g * opacity, u_color.b * opacity, opacity);
      }
    `});let rl=Ar;const ir=n=>{n.programValue===void 0&&(n.programValue=new Float32Array(4));const e=n.value,t=n.programValue;t[0]=(e>>>24)/255,t[1]=(e>>>16&255)/255,t[2]=(e>>>8&255)/255,t[3]=(e&255)/255},_m=n=>{const e=n.validatedValue||n.value;if(n.programValue instanceof Float32Array){const t=n.programValue;t[0]=e[0],t[1]=e[1]}else n.programValue=new Float32Array(e)},xm=n=>{const e=n.validatedValue||n.value;if(n.programValue instanceof Float32Array){const t=n.programValue;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]}else n.programValue=new Float32Array(e)},dd=n=>{const e=n.validatedValue||n.value;if(n.programValue instanceof Float32Array){const t=e.length,i=n.programValue;for(let s=0;s<t;s++)i[s]=e[s]}else n.programValue=new Float32Array(e)},Kl=n=>{const e=Array.isArray(n);if(e){if(e&&n.length===4)return n;if(e&&n.length===2)return[n[0],n[1],n[0],n[1]];if(e&&n.length===3)return[n[0],n[1],n[2],n[0]]}else return[n,n,n,n];return[n[0],n[0],n[0],n[0]]},fd=(n,e)=>{n.programValue===void 0&&(n.programValue=new Float32Array(4));const t=n.programValue,i=n.validatedValue||n.value;if(e===void 0&&n.$dimensions===void 0){t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3];return}let s=n.$dimensions;if(e!==void 0){const{$dimensions:d}=e;if(s!==void 0&&(s.width===d.width||s.height===d.height))return;s===void 0&&(s={width:d==null?void 0:d.width,height:d==null?void 0:d.height},n.$dimensions=s)}const{width:r,height:o}=s,[a,l,h,c]=i,u=Math.min(Math.min(Math.min(r/Math.max(r,a+l),r/Math.max(r,h+c)),Math.min(o/Math.max(o,a+h),o/Math.max(o,l+c))),1);t[0]=a*u,t[1]=l*u,t[2]=h*u,t[3]=c*u};class Es extends We{constructor(){super(...arguments);y(this,"name","radius")}static getEffectKey(){return"radius"}static resolveDefaults(t){return{radius:t.radius??10}}}y(Es,"z$__type__Props"),y(Es,"uniforms",{radius:{value:0,method:"uniform4fv",type:"vec4",updateOnBind:!0,validator:Kl,updateProgramValue:fd}}),y(Es,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,boxDist:`
      float function(vec2 p, vec2 size, float radius) {
        size -= vec2(radius);
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;
      }
    `}),y(Es,"onShaderMask",`
  vec2 halfDimensions = u_dimensions * 0.5;
  float r = radius[0] * step(v_textureCoordinate.x, 0.5) * step(v_textureCoordinate.y, 0.5);
  r = r + radius[1] * step(0.5, v_textureCoordinate.x) * step(v_textureCoordinate.y, 0.5);
  r = r + radius[2] * step(0.5, v_textureCoordinate.x) * step(0.5, v_textureCoordinate.y);
  r = r + radius[3] * step(v_textureCoordinate.x, 0.5) * step(0.5, v_textureCoordinate.y);
  return $boxDist(v_textureCoordinate.xy * u_dimensions - halfDimensions, halfDimensions, r);
  `),y(Es,"onEffectMask",`
  return mix(vec4(0.0), maskColor, $fillMask(shaderMask));
  `);class ar extends We{constructor(){super(...arguments);y(this,"name","border")}static getEffectKey(){return"border"}static resolveDefaults(t){return{width:t.width??10,color:t.color??4294967295}}}y(ar,"z$__type__Props"),y(ar,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(ar,"onEffectMask",`
  float intR = shaderMask + 1.0;
  float mask = clamp(intR + width, 0.0, 1.0) - clamp(intR, 0.0, 1.0);
  return mix(shaderColor, mix(shaderColor, maskColor, maskColor.a), mask);
  `),y(ar,"onColorize",`
    return color;
  `);const Fi=class Fi extends We{constructor(){super(...arguments);y(this,"name","linearGradient")}static getEffectKey(t){return t.colors.value?`linearGradient${t.colors.value.length}`:`linearGradient${t.colors.length}`}static resolveDefaults(t){const i=t.colors??[4278190080,4294967295];let s=t.stops||[];if(s.length===0||s.length!==i.length){const r=i.length;let o=0;const a=s;for(;o<r;o++)s[o]?(a[o]=s[o],s[o-1]===void 0&&a[o-2]!==void 0&&(a[o-1]=a[o-2]+(s[o]-a[o-2])/2)):a[o]=o*(1/(i.length-1));s=a}return{colors:i,stops:s,angle:t.angle??0}}};y(Fi,"z$__type__Props"),y(Fi,"uniforms",{angle:{value:0,method:"uniform1f",type:"float"},colors:{value:4294967295,validator:t=>t.reduce((i,s)=>i.concat(Nr(s)),[]),updateProgramValue:dd,size:t=>t.colors.length,method:"uniform4fv",type:"vec4"},stops:{value:[],size:t=>t.colors.length,method:"uniform1fv",type:"float"}}),y(Fi,"methods",{fromLinear:`
      vec4 function(vec4 linearRGB) {
        vec4 higher = vec4(1.055)*pow(linearRGB, vec4(1.0/2.4)) - vec4(0.055);
        vec4 lower = linearRGB * vec4(12.92);
        return mix(higher, lower, 1.0);
      }
    `,toLinear:`
      vec4 function(vec4 sRGB) {
        vec4 higher = pow((sRGB + vec4(0.055))/vec4(1.055), vec4(2.4));
        vec4 lower = sRGB/vec4(12.92);
        return mix(higher, lower, 1.0);
      }
    `,calcPoint:`
      vec2 function(float d, float angle) {
        return d * vec2(cos(angle), sin(angle)) + (u_dimensions * 0.5);
      }
    `}),y(Fi,"ColorLoop",t=>{let i="";for(let s=2;s<t;s++)i+=`colorOut = mix(colorOut, colors[${s}], clamp((dist - stops[${s-1}]) / (stops[${s}] - stops[${s-1}]), 0.0, 1.0));`;return i}),y(Fi,"onColorize",t=>{const i=t.colors.length||1;return`
      float a = angle - (PI / 180.0 * 90.0);
      float lineDist = abs(u_dimensions.x * cos(a)) + abs(u_dimensions.y * sin(a));
      vec2 f = $calcPoint(lineDist * 0.5, a);
      vec2 t = $calcPoint(lineDist * 0.5, a + PI);
      vec2 gradVec = t - f;
      float dist = dot(v_textureCoordinate.xy * u_dimensions - f, gradVec) / dot(gradVec, gradVec);

      float stopCalc = (dist - stops[0]) / (stops[1] - stops[0]);
      vec4 colorOut = $fromLinear(mix($toLinear(colors[0]), $toLinear(colors[1]), stopCalc));
      ${Fi.ColorLoop(i)}
      return mix(maskColor, colorOut, clamp(colorOut.a, 0.0, 1.0));
    `});let nl=Fi;class ol extends We{constructor(){super(...arguments);y(this,"name","grayscale")}static getEffectKey(){return"grayscale"}static resolveDefaults(t){return{amount:t.amount??1}}}y(ol,"uniforms",{amount:{value:1,method:"uniform1f",type:"float"}}),y(ol,"onColorize",`
    float grayness = 0.2 * maskColor.r + 0.6 * maskColor.g + 0.2 * maskColor.b;
    return vec4(amount * vec3(grayness) + (1.0 - amount) * maskColor.rgb, maskColor.a);
  `);class bs extends We{constructor(){super(...arguments);y(this,"name","borderRight")}static getEffectKey(){return"borderRight"}static resolveDefaults(t){return{width:t.width??10,color:t.color??4294967295}}}y(bs,"z$__type__Props"),y(bs,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(bs,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,rectDist:`
      float function(vec2 p, vec2 size) {
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));
      }
    `}),y(bs,"onEffectMask",`
  vec2 pos = vec2(u_dimensions.x - width * 0.5, 0.0);
  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(width*0.5, u_dimensions.y));
  return mix(shaderColor, maskColor, $fillMask(mask));
  `),y(bs,"onColorize",`
    return color;
  `);class As extends We{constructor(){super(...arguments);y(this,"name","borderTop")}static getEffectKey(){return"borderTop"}static resolveDefaults(t){return{width:t.width??10,color:t.color??4294967295}}}y(As,"z$__type__Props"),y(As,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(As,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,rectDist:`
      float function(vec2 p, vec2 size) {
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));
      }
    `}),y(As,"onEffectMask",`
  vec2 pos = vec2(0.0, width * 0.5);
  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(u_dimensions.x, width*0.5));
  return mix(shaderColor, maskColor, $fillMask(mask));
  `),y(As,"onColorize",`
    return color;
  `);class Rs extends We{constructor(){super(...arguments);y(this,"name","borderBottom")}static getEffectKey(){return"borderBottom"}static resolveDefaults(t){return{width:t.width??10,color:t.color??4294967295}}}y(Rs,"z$__type__Props"),y(Rs,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(Rs,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,rectDist:`
      float function(vec2 p, vec2 size) {
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));
      }
    `}),y(Rs,"onEffectMask",`
  vec2 pos = vec2(0.0, u_dimensions.y - width * 0.5);
  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(u_dimensions.x, width*0.5));
  return mix(shaderColor, maskColor, $fillMask(mask));
  `),y(Rs,"onColorize",`
    return color;
  `);class Cs extends We{constructor(){super(...arguments);y(this,"name","borderLeft")}static getEffectKey(){return"borderLeft"}static resolveDefaults(t){return{width:t.width??10,color:t.color??4294967295}}}y(Cs,"z$__type__Props"),y(Cs,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(Cs,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,rectDist:`
      float function(vec2 p, vec2 size) {
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));
      }
    `}),y(Cs,"onEffectMask",`
  vec2 pos = vec2(width * 0.5, 0.0);
  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(width*0.5, u_dimensions.y));
  return mix(shaderColor, maskColor, $fillMask(mask));
  `),y(Cs,"onColorize",`
    return color;
  `);class lr extends We{constructor(){super(...arguments);y(this,"name","glitch")}static getEffectKey(t){return"glitch"}static resolveDefaults(t){return{amplitude:t.amplitude??.2,narrowness:t.narrowness??4,blockiness:t.blockiness??2,minimizer:t.minimizer??8,time:t.time??Date.now()}}}y(lr,"z$__type__Props"),y(lr,"uniforms",{amplitude:{value:0,method:"uniform1f",type:"float"},narrowness:{value:0,method:"uniform1f",type:"float"},blockiness:{value:0,method:"uniform1f",type:"float"},minimizer:{value:0,method:"uniform1f",type:"float"},time:{value:0,method:"uniform1f",updateOnBind:!0,updateProgramValue:t=>{const i=t.value=(Date.now()-t.value)%1e3;t.programValue=i},type:"float"}}),y(lr,"methods",{rand:`
      float function(vec2 p, float time) {
        float t = floor(time * 20.) / 10.;
        return fract(sin(dot(p, vec2(t * 12.9898, t * 78.233))) * 43758.5453);
      }
    `,noise:`
      float function(vec2 uv, float blockiness, float time) {
        vec2 lv = fract(uv);
        vec2 id = floor(uv);

        float n1 = rand(id, time);
        float n2 = rand(id+vec2(1,0), time);
        float n3 = rand(id+vec2(0,1), time);
        float n4 = rand(id+vec2(1,1), time);
        vec2 u = smoothstep(0.0, 1.0 + blockiness, lv);
        return mix(mix(n1, n2, u.x), mix(n3, n4, u.x), u.y);
      }
    `,fbm:`
      float function(vec2 uv, int count, float blockiness, float complexity, float time) {
        float val = 0.0;
        float amp = 0.5;
        const int MAX_ITERATIONS = 10;

        for(int i = 0; i < MAX_ITERATIONS; i++) {
          if(i >= count) {break;}
          val += amp * noise(uv, blockiness, time);
          amp *= 0.5;
          uv *= complexity;
        }
        return val;
      }
    `}),y(lr,"onColorize",`
    vec2 uv = v_textureCoordinate.xy;
    float aspect = u_dimensions.x / u_dimensions.y;
    vec2 a = vec2(uv.x * aspect , uv.y);
    vec2 uv2 = vec2(a.x / u_dimensions.x, exp(a.y));

    float shift = amplitude * pow($fbm(uv2, 4, blockiness, narrowness, time), minimizer);
    float colR = texture2D(u_texture, vec2(uv.x + shift, uv.y)).r * (1. - shift);
    float colG = texture2D(u_texture, vec2(uv.x - shift, uv.y)).g * (1. - shift);
    float colB = texture2D(u_texture, vec2(uv.x - shift, uv.y)).b * (1. - shift);

    vec3 f = vec3(colR, colG, colB);
    return vec4(f, texture2D(u_texture, vec2(uv.x - shift, uv.y)).a);
  `);class Wn extends We{constructor(){super(...arguments);y(this,"name","fadeOut")}static getEffectKey(){return"fadeOut"}static resolveDefaults(t){return{fade:t.fade??10}}}y(Wn,"z$__type__Props"),y(Wn,"uniforms",{fade:{value:0,method:"uniform4fv",type:"vec4",validator:Kl,updateProgramValue:xm}}),y(Wn,"onColorize",`
  vec2 point = v_textureCoordinate.xy * u_dimensions.xy;
  vec2 pos1;
  vec2 pos2;
  vec2 d;
  float c;
  vec4 result = maskColor;


  if(fade[0] > 0.0) {
    pos1 = vec2(point.x, point.y);
    pos2 = vec2(point.x, point.y + fade[0]);
    d = pos2 - pos1;
    c = dot(pos1, d) / dot(d, d);
    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));
  }

  if(fade[1] > 0.0) {
    pos1 = vec2(point.x - u_dimensions.x - fade[1], v_textureCoordinate.y);
    pos2 = vec2(point.x - u_dimensions.x, v_textureCoordinate.y);
    d = pos1 - pos2;
    c = dot(pos2, d) / dot(d, d);
    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));
  }

  if(fade[2] > 0.0) {
    pos1 = vec2(v_textureCoordinate.x, point.y - u_dimensions.y - fade[2]);
    pos2 = vec2(v_textureCoordinate.x, point.y - u_dimensions.y);
    d = pos1 - pos2;
    c = dot(pos2, d) / dot(d, d);
    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));
  }

  if(fade[3] > 0.0) {
    pos1 = vec2(point.x, point.y);
    pos2 = vec2(point.x + fade[3], point.y);
    d = pos2 - pos1;
    c = dot(pos1, d) / dot(d, d);
    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));
  }

  return result;
  `);const os=class os extends We{constructor(){super(...arguments);y(this,"name","radialGradient")}static getEffectKey(t){return t.colors.value?`radialGradient${t.colors.value.length}`:`radialGradient${t.colors.length}`}static resolveDefaults(t){const i=t.colors??[4278190080,4294967295];let s=t.stops||[];if(s.length===0||s.length!==i.length){const r=i.length;let o=0;const a=s;for(;o<r;o++)s[o]?(a[o]=s[o],s[o-1]===void 0&&a[o-2]!==void 0&&(a[o-1]=a[o-2]+(s[o]-a[o-2])/2)):a[o]=o*(1/(i.length-1));s=a}return{colors:i,stops:s,width:t.width??0,height:t.height??t.width??0,pivot:t.pivot??[.5,.5]}}};y(os,"z$__type__Props"),y(os,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},height:{value:0,method:"uniform1f",type:"float"},pivot:{value:[.5,.5],updateProgramValue:_m,method:"uniform2fv",type:"vec2"},colors:{value:4294967295,validator:t=>t.reduce((i,s)=>i.concat(Nr(s)),[]),updateProgramValue:dd,size:t=>t.colors.length,method:"uniform4fv",type:"vec4"},stops:{value:[],size:t=>t.colors.length,method:"uniform1fv",type:"float"}}),y(os,"ColorLoop",t=>{let i="";for(let s=2;s<t;s++)i+=`colorOut = mix(colorOut, colors[${s}], clamp((dist - stops[${s-1}]) / (stops[${s}] - stops[${s-1}]), 0.0, 1.0));`;return i}),y(os,"onColorize",t=>{const i=t.colors.length||1;return`
      vec2 point = v_textureCoordinate.xy * u_dimensions;
      vec2 projection = vec2(pivot.x * u_dimensions.x, pivot.y * u_dimensions.y);

      float dist = length((point - projection) / vec2(width, height));

      float stopCalc = (dist - stops[0]) / (stops[1] - stops[0]);
      vec4 colorOut = mix(colors[0], colors[1], stopCalc);
      ${os.ColorLoop(i)}
      return mix(maskColor, colorOut, clamp(colorOut.a, 0.0, 1.0));
    `});let al=os;class Ls extends We{constructor(){super(...arguments);y(this,"name","radialProgress")}static getEffectKey(){return"radialProgress"}static resolveDefaults(t){return{width:t.width??10,progress:t.progress??.5,offset:t.offset??0,range:t.range??Math.PI*2,rounded:t.rounded??!1,radius:t.radius??1,color:t.color??4294967295}}}y(Ls,"z$__type__Props"),y(Ls,"uniforms",{width:{value:0,method:"uniform1f",type:"float"},progress:{value:.5,method:"uniform1f",type:"float"},offset:{value:0,method:"uniform1f",type:"float"},range:{value:0,method:"uniform1f",type:"float"},rounded:{value:0,method:"uniform1f",type:"float",validator:t=>t?1:0},radius:{value:1,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:ir,method:"uniform4fv",type:"vec4"}}),y(Ls,"methods",{rotateUV:`
    vec2 function(vec2 uv, float d) {
      float s = sin(d);
      float c = cos(d);
      mat2 rotMatrix = mat2(c, -s, s, c);
      return uv * rotMatrix;
    }
    `,drawDot:`
    float function(vec2 uv, vec2 p, float r) {
      uv += p;
      float circle = length(uv) - r;
      return clamp(-circle, 0.0, 1.0);
    }
    `}),y(Ls,"onEffectMask",`
    float outerRadius = radius * u_dimensions.y * 0.5;

    float endAngle = range * progress - 0.0005;

    vec2 uv = v_textureCoordinate.xy * u_dimensions.xy - u_dimensions * 0.5;

    uv = $rotateUV(uv, -(offset));
    float linewidth = width * u_pixelRatio;
    float circle = length(uv) - (outerRadius - linewidth) ;
    circle = abs(circle) - linewidth;
    circle = clamp(-circle, 0.0, 1.0);

    float angle = (atan(uv.x, -uv.y) / 3.14159265359 * 0.5);
    float p = endAngle / (PI * 2.);

    circle *= step(fract(angle), fract(p));

    circle = rounded < 1. ? circle : max(circle, $drawDot(uv, vec2(0, outerRadius - linewidth), linewidth));
    circle = rounded < 1. ? circle : max(circle, $drawDot($rotateUV(uv, -(endAngle)), vec2(0, outerRadius - linewidth), linewidth));

    return mix(shaderColor, maskColor, circle);
  `),y(Ls,"onColorize",`
    return color;
  `);class ws extends We{constructor(){super(...arguments);y(this,"name","holePunch")}static getEffectKey(){return"holePunch"}static resolveDefaults(t){return{x:t.x||0,y:t.y||0,width:t.width||50,height:t.height||50,radius:t.radius??0}}}y(ws,"z$__type__Props"),y(ws,"uniforms",{x:{value:0,method:"uniform1f",type:"float"},y:{value:0,method:"uniform1f",type:"float"},width:{value:0,method:"uniform1f",type:"float"},height:{value:0,method:"uniform1f",type:"float"},radius:{value:0,method:"uniform4fv",type:"vec4",updateOnBind:!0,validator:Kl,updateProgramValue:fd}}),y(ws,"methods",{fillMask:`
      float function(float dist) {
        return clamp(-dist, 0.0, 1.0);
      }
    `,boxDist:`
      float function(vec2 p, vec2 size, float radius) {
        size -= vec2(radius);
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;
      }
    `}),y(ws,"onShaderMask",`
  vec2 halfDimensions = u_dimensions * 0.5;
  vec2 size = vec2(width, height) * 0.5;
  vec2 basePos = v_textureCoordinate.xy * u_dimensions.xy - vec2(x, y);
  vec2 pos = basePos - size;
  float r = radius[0] * step(pos.x, 0.5) * step(pos.y, 0.5);
  r = r + radius[1] * step(0.5, pos.x) * step(pos.y, 0.5);
  r = r + radius[2] * step(0.5, pos.x) * step(0.5, pos.y);
  r = r + radius[3] * step(pos.x, 0.5) * step(0.5, pos.y);
  return $boxDist(pos, size, r);
  `),y(ws,"onEffectMask",`
  return mix(maskColor, vec4(0.0), $fillMask(shaderMask));
  `);const ym="RoundedRectangle";class Ko extends cd{constructor(t){super();y(this,"shType");this.shType=t}bindRenderOp(){}bindProps(){}attach(){}detach(){}}class Tm{constructor(e,t,i,s){y(this,"type");y(this,"shader");y(this,"resolvedProps");y(this,"props");this.type=e,this.shader=t,this.resolvedProps=i;const r=Object.keys(i),o=r.length,a={};for(let l=0;l<o;l++){const h=r[l];Object.defineProperty(a,h,{get:()=>this.resolvedProps[h],set:c=>{this.resolvedProps[h]=c,s.requestRender()}})}this.props=a}getResolvedProps(){return this.resolvedProps}}class Sm{constructor(e,t,i){y(this,"shader");y(this,"resolvedProps");y(this,"props");y(this,"type");this.shader=e,this.type="DynamicShader",this.resolvedProps=t;const s=i.getRegisteredEffects(),r={},o=t.effects,a=o.length;for(let l=0;l<a;l++){const{name:h,props:c,type:u}=o[l];if(h===void 0)continue;const d={},f=Object.keys(c),g=f.length;for(let p=0;p<g;p++){const m=f[p];Object.defineProperty(d,m,{get:()=>this.resolvedProps.effects[l].props[m].value,set:_=>{var S,v;const T=this.resolvedProps.effects[l].props[m];T.value=_,T.hasValidator&&(_=T.validatedValue=(S=s[u].uniforms[m])==null?void 0:S.validator(_,c)),T.hasProgramValueUpdater?(v=s[u].uniforms[m])==null||v.updateProgramValue(T):T.programValue=_,i.renderer.stage.requestRender()}})}Object.defineProperty(r,h,{get:()=>d})}this.props=r}getResolvedProps(){return this.resolvedProps}}class vm{constructor(){y(this,"shCache",new Map);y(this,"shConstructors",{});y(this,"attachedShader",null);y(this,"effectConstructors",{});y(this,"renderer");this.registerShaderType("DefaultShader",gm),this.registerShaderType("DefaultShaderBatched",ud),this.registerShaderType("RoundedRectangle",sl),this.registerShaderType("DynamicShader",Os),this.registerShaderType("SdfShader",rl),this.registerEffectType("border",ar),this.registerEffectType("borderBottom",Rs),this.registerEffectType("borderLeft",Cs),this.registerEffectType("borderRight",bs),this.registerEffectType("borderTop",As),this.registerEffectType("fadeOut",Wn),this.registerEffectType("linearGradient",nl),this.registerEffectType("radialGradient",al),this.registerEffectType("grayscale",ol),this.registerEffectType("glitch",lr),this.registerEffectType("radius",Es),this.registerEffectType("radialProgress",Ls),this.registerEffectType("holePunch",ws)}registerShaderType(e,t){this.shConstructors[e]=t}registerEffectType(e,t){this.effectConstructors[e]=t}getRegisteredEffects(){return this.effectConstructors}getRegisteredShaders(){return this.shConstructors}loadShader(e,t){if(!this.renderer)throw new Error("Renderer is not been defined");const i=this.shConstructors[e];if(!i)throw new Error(`Shader type "${e}" is not registered`);if(this.renderer.mode==="canvas"&&i.prototype instanceof gs)return this._createShaderCtr(e,new Ko(e),t);if(e==="DynamicShader")return this.loadDynamicShader(t);const s=i.resolveDefaults(t),r=i.makeCacheKey(s)||i.name;if(r&&this.shCache.has(r))return this._createShaderCtr(e,this.shCache.get(r),s);const o=new i(this.renderer,t);return r&&this.shCache.set(r,o),this._createShaderCtr(e,o,s)}loadDynamicShader(e){if(!this.renderer)throw new Error("Renderer is not been defined");const t=Os.resolveDefaults(e,this.effectConstructors),i=Os.makeCacheKey(t,this.effectConstructors);if(i&&this.shCache.has(i))return this._createDynShaderCtr(this.shCache.get(i),t);const s=new Os(this.renderer,e,this.effectConstructors);return i&&this.shCache.set(i,s),this._createDynShaderCtr(s,t)}_createShaderCtr(e,t,i){return new Tm(e,t,i,this.renderer.stage)}_createDynShaderCtr(e,t){return e.bindUniformMethods(t),new Sm(e,t,this)}useShader(e){this.attachedShader!==e&&(this.attachedShader&&this.attachedShader.detach(),e.attach(),this.attachedShader=e)}}const Em={x:(n,e)=>{n.props.x=e},y:(n,e)=>{n.props.y=e},width:(n,e)=>{n.props.width=e},height:(n,e)=>{n.props.height=e},color:(n,e)=>{n.props.color=e},zIndex:(n,e)=>{n.props.zIndex=e},fontFamily:(n,e)=>{n.props.fontFamily=e},fontWeight:(n,e)=>{n.props.fontWeight=e},fontStyle:(n,e)=>{n.props.fontStyle=e},fontStretch:(n,e)=>{n.props.fontStretch=e},fontSize:(n,e)=>{n.props.fontSize=e},text:(n,e)=>{n.props.text=e},textAlign:(n,e)=>{n.props.textAlign=e},contain:(n,e)=>{n.props.contain=e},offsetY:(n,e)=>{n.props.offsetY=e},scrollable:(n,e)=>{n.props.scrollable=e},scrollY:(n,e)=>{n.props.scrollY=e},letterSpacing:(n,e)=>{n.props.letterSpacing=e},lineHeight:(n,e)=>{n.props.lineHeight=e},maxLines:(n,e)=>{n.props.maxLines=e},textBaseline:(n,e)=>{n.props.textBaseline=e},verticalAlign:(n,e)=>{n.props.verticalAlign=e},overflowSuffix:(n,e)=>{n.props.overflowSuffix=e},debug:(n,e)=>{n.props.debug=e}};class Xl{constructor(e){y(this,"stage");y(this,"set");this.stage=e;const t={...Em,...this.getPropertySetters()},i={};Object.keys(t).forEach(s=>{Object.defineProperty(i,s,{value:(r,o)=>{r.props[s]!==o&&(t[s](r,o),this.stage.requestRender())},writable:!1,configurable:!1})}),this.set=i}setStatus(e,t,i){e.status!==t&&(e.status=t,e.emitter.emit(t,i))}setIsRenderable(e,t){e.isRenderable=t}destroyState(e){this.setStatus(e,"destroyed"),e.emitter.removeAllListeners()}scheduleUpdateState(e){e.updateScheduled||(e.updateScheduled=!0,queueMicrotask(()=>{e.status!=="destroyed"&&(e.updateScheduled=!1,this.updateState(e))}))}}class bm{constructor(){y(this,"data",{})}reset(){this.data={}}increment(e){this.data[e]||(this.data[e]=0),this.data[e]++}getData(){return{...this.data}}}class Am{constructor(e,t){y(this,"stage");y(this,"memUsed",0);y(this,"loadedTextures",new Map);y(this,"orphanedTextures",[]);y(this,"criticalThreshold");y(this,"targetThreshold");y(this,"cleanupInterval");y(this,"debugLogging");y(this,"lastCleanupTime",0);y(this,"baselineMemoryAllocation");y(this,"criticalCleanupRequested",!1);y(this,"doNotExceedCriticalThreshold");y(this,"frameTime",0);this.stage=e;const{criticalThreshold:i,doNotExceedCriticalThreshold:s}=t;this.doNotExceedCriticalThreshold=s||!1,this.criticalThreshold=Math.round(i);const r=Math.max(0,Math.min(1,t.targetThresholdLevel));if(this.cleanupInterval=t.cleanupInterval,this.debugLogging=t.debugLogging,this.baselineMemoryAllocation=Math.round(t.baselineMemoryAllocation),this.targetThreshold=Math.max(Math.round(i*r),this.baselineMemoryAllocation),this.memUsed=Math.round(t.baselineMemoryAllocation),t.debugLogging){let o=0;setInterval(()=>{o!==this.memUsed&&(o=this.memUsed,console.log(`[TextureMemoryManager] Memory used: ${tc(this.memUsed)} mb / ${tc(this.criticalThreshold)} mb (${(this.memUsed/this.criticalThreshold*100).toFixed(1)}%)`))},1e3)}i===0&&(this.setTextureMemUse=()=>{})}addToOrphanedTextures(e){this.orphanedTextures.includes(e)&&this.removeFromOrphanedTextures(e),e.preventCleanup===!1&&this.orphanedTextures.push(e)}removeFromOrphanedTextures(e){const t=this.orphanedTextures.indexOf(e);t!==-1&&this.orphanedTextures.splice(t,1)}setTextureMemUse(e,t){if(this.loadedTextures.has(e)&&(this.memUsed-=this.loadedTextures.get(e)),t===0){this.loadedTextures.delete(e);return}else this.memUsed+=t,this.loadedTextures.set(e,t);this.memUsed>this.criticalThreshold&&(this.criticalCleanupRequested=!0)}checkCleanup(){return this.criticalCleanupRequested||this.memUsed>this.targetThreshold&&this.frameTime-this.lastCleanupTime>=this.cleanupInterval}checkCriticalCleanup(){return this.memUsed>this.criticalThreshold}cleanupQuick(e){const t=this.targetThreshold,i=this.stage.txManager,s=as();for(;this.memUsed>=t&&this.orphanedTextures.length>0&&(e||as()-s<10);){const r=this.orphanedTextures.shift();r!==void 0&&r.renderable!==!0&&(r.free(),i.removeTextureFromCache(r))}}cleanupDeep(e){const t=e?this.criticalThreshold:this.targetThreshold,i=this.stage.txManager,s=[],r=[...this.loadedTextures.keys()];for(let o=0;o<r.length;o++){const a=r[o];a!==void 0&&(a.type===Ae.image||a.type===Ae.noise||a.type===Ae.renderToTexture)&&(a.renderable===!0?s.push(a):s.unshift(a))}for(;this.memUsed>=t&&s.length>0;){const o=s.shift();if(o!==void 0&&o.preventCleanup!==!0){if(o.renderable===!0)break;o.free(),this.removeFromOrphanedTextures(o),i.removeTextureFromCache(o),i.removeTextureFromQueue(o)}}}cleanup(e=!1){const t=this.criticalCleanupRequested;this.lastCleanupTime=this.frameTime,t===!0&&this.stage.queueFrameEvent("criticalCleanup",{memUsed:this.memUsed,criticalThreshold:this.criticalThreshold}),this.debugLogging===!0&&console.log(`[TextureMemoryManager] Cleaning up textures. Critical: ${t}. Aggressive: ${e}`),this.cleanupQuick(t),e===!0&&this.memUsed>=this.criticalThreshold&&this.cleanupDeep(t),this.memUsed>=this.criticalThreshold?(this.stage.queueFrameEvent("criticalCleanupFailed",{memUsed:this.memUsed,criticalThreshold:this.criticalThreshold}),(this.debugLogging===!0||qs()===!1)&&console.warn(`[TextureMemoryManager] Memory usage above critical threshold after cleanup: ${this.memUsed}`)):this.criticalCleanupRequested=!1}getMemoryInfo(){let e=0;const t=[...this.loadedTextures.keys()].reduce((i,s)=>(e+=s.renderable?1:0,i+(s.renderable?this.loadedTextures.get(s):0)),this.baselineMemoryAllocation);return{criticalThreshold:this.criticalThreshold,targetThreshold:this.targetThreshold,renderableMemUsed:t,memUsed:this.memUsed,renderableTexturesLoaded:e,loadedTextures:this.loadedTextures.size,baselineMemoryAllocation:this.baselineMemoryAllocation}}}class gd{constructor(e,t){y(this,"textureSource");y(this,"memManager");y(this,"state","freed");this.memManager=e,this.textureSource=t}setTextureMemUse(e){this.memManager.setTextureMemUse(this.textureSource,e)}get renderable(){return this.textureSource.renderable}}class pd{constructor(e){y(this,"options");y(this,"mode");y(this,"stage");y(this,"txManager");y(this,"txMemManager");y(this,"shManager");y(this,"rttNodes",[]);this.options=e,this.stage=e.stage,this.txManager=e.txManager,this.txMemManager=e.txMemManager,this.shManager=e.shManager}}class Rm extends tl{constructor(t,i,s){super(t,i);y(this,"textRenderer");y(this,"trState");y(this,"_textRendererOverride",null);y(this,"onTextLoaded",()=>{const{contain:t}=this,i=this.trState.props.width,s=this.trState.props.height,r=this.trState.textW||0,o=this.trState.textH||0;t==="both"?(this.props.width=i,this.props.height=s):t==="width"?(this.props.width=i,this.props.height=o):t==="none"&&(this.props.width=r,this.props.height=o),this.updateLocalTransform(),this.stage.requestRender(),this.emit("loaded",{type:"text",dimensions:{width:this.trState.textW||0,height:this.trState.textH||0}})});y(this,"onTextFailed",(t,i)=>{this.emit("failed",{type:"text",error:i})});this._textRendererOverride=i.textRendererOverride,this.textRenderer=s;const r=this.createState({x:this.absX,y:this.absY,width:i.width,height:i.height,textAlign:i.textAlign,color:i.color,zIndex:i.zIndex,contain:i.contain,scrollable:i.scrollable,scrollY:i.scrollY,offsetY:i.offsetY,letterSpacing:i.letterSpacing,debug:i.debug,fontFamily:i.fontFamily,fontSize:i.fontSize,fontStretch:i.fontStretch,fontStyle:i.fontStyle,fontWeight:i.fontWeight,text:i.text,lineHeight:i.lineHeight,maxLines:i.maxLines,textBaseline:i.textBaseline,verticalAlign:i.verticalAlign,overflowSuffix:i.overflowSuffix});this.trState=r}get width(){return this.props.width}set width(t){this.props.width=t,this.textRenderer.set.width(this.trState,t),this.contain==="none"&&this.setUpdateType($.Local)}get height(){return this.props.height}set height(t){this.props.height=t,this.textRenderer.set.height(this.trState,t),this.contain!=="both"&&this.setUpdateType($.Local)}get color(){return this.trState.props.color}set color(t){this.textRenderer.set.color(this.trState,t)}get text(){return this.trState.props.text}set text(t){this.textRenderer.set.text(this.trState,t)}get textRendererOverride(){return this._textRendererOverride}set textRendererOverride(t){this._textRendererOverride=t,this.textRenderer.destroyState(this.trState);const i=this.stage.resolveTextRenderer(this.trState.props,this._textRendererOverride);if(!i){console.warn("Text Renderer not found for font",this.trState.props.fontFamily);return}this.textRenderer=i,this.trState=this.createState(this.trState.props)}get fontSize(){return this.trState.props.fontSize}set fontSize(t){this.textRenderer.set.fontSize(this.trState,t)}get fontFamily(){return this.trState.props.fontFamily}set fontFamily(t){this.textRenderer.set.fontFamily(this.trState,t)}get fontStretch(){return this.trState.props.fontStretch}set fontStretch(t){this.textRenderer.set.fontStretch(this.trState,t)}get fontStyle(){return this.trState.props.fontStyle}set fontStyle(t){this.textRenderer.set.fontStyle(this.trState,t)}get fontWeight(){return this.trState.props.fontWeight}set fontWeight(t){this.textRenderer.set.fontWeight(this.trState,t)}get textAlign(){return this.trState.props.textAlign}set textAlign(t){this.textRenderer.set.textAlign(this.trState,t)}get contain(){return this.trState.props.contain}set contain(t){this.textRenderer.set.contain(this.trState,t)}get scrollable(){return this.trState.props.scrollable}set scrollable(t){this.textRenderer.set.scrollable(this.trState,t)}get scrollY(){return this.trState.props.scrollY}set scrollY(t){this.textRenderer.set.scrollY(this.trState,t)}get offsetY(){return this.trState.props.offsetY}set offsetY(t){this.textRenderer.set.offsetY(this.trState,t)}get letterSpacing(){return this.trState.props.letterSpacing}set letterSpacing(t){this.textRenderer.set.letterSpacing(this.trState,t)}get lineHeight(){return this.trState.props.lineHeight}set lineHeight(t){this.textRenderer.set.lineHeight(this.trState,t)}get maxLines(){return this.trState.props.maxLines}set maxLines(t){this.textRenderer.set.maxLines(this.trState,t)}get textBaseline(){return this.trState.props.textBaseline}set textBaseline(t){this.textRenderer.set.textBaseline(this.trState,t)}get verticalAlign(){return this.trState.props.verticalAlign}set verticalAlign(t){this.textRenderer.set.verticalAlign(this.trState,t)}get overflowSuffix(){return this.trState.props.overflowSuffix}set overflowSuffix(t){this.textRenderer.set.overflowSuffix(this.trState,t)}get debug(){return this.trState.props.debug}set debug(t){this.textRenderer.set.debug(this.trState,t)}update(t,i){super.update(t,i),X(this.globalTransform),this.textRenderer.set.x(this.trState,this.globalTransform.tx),this.textRenderer.set.y(this.trState,this.globalTransform.ty)}checkBasicRenderability(){return this.worldAlpha===0||this.isOutOfBounds()===!0?!1:!!(this.trState&&this.trState.props.text!=="")}setRenderable(t){super.setRenderable(t),this.textRenderer.setIsRenderable(this.trState,t)}renderQuads(t){var i;if(X(this.globalTransform),!this.textRenderer.renderQuads){super.renderQuads(t);return}this.parentHasRenderTexture&&(!t.renderToTextureActive||this.parentRenderTexture!==t.activeRttNode)||(this.parentHasRenderTexture&&((i=this.props.parent)!=null&&i.rtt)&&(this.globalTransform=Ne.identity(),this.localTransform&&this.globalTransform.multiply(this.localTransform)),X(this.globalTransform),this.textRenderer.renderQuads(this.trState,this.globalTransform,this.clippingRect,this.worldAlpha,this.parentHasRenderTexture,this.framebufferDimensions))}destroy(){super.destroy(),this.textRenderer.destroyState(this.trState)}createState(t){const i=this.textRenderer.createState(t,this);return i.emitter.on("loaded",this.onTextLoaded),i.emitter.on("failed",this.onTextFailed),this.textRenderer.scheduleUpdateState(i),i}}function Cm(n){const e={boolean:!0,string:!0,number:!0,undefined:!0},t=Object.keys(n);for(let i=0;i<t.length;i++){const s=t[i];if(!s)continue;const r=n[s],o=typeof r;o==="string"&&r.length>2048&&(console.warn(`Custom Data value for ${s} is too long, it will be truncated to 2048 characters`),n[s]=r.substring(0,2048)),e[o]||(console.warn(`Custom Data value for ${s} is not a boolean, string, or number, it will be ignored`),delete n[s])}return n}const Lm=2e6;let wm=class{constructor(e){y(this,"options");y(this,"animationManager");y(this,"txManager");y(this,"txMemManager");y(this,"fontManager");y(this,"textRenderers");y(this,"shManager");y(this,"renderer");y(this,"root");y(this,"boundsMargin");y(this,"defShaderCtr");y(this,"strictBound");y(this,"preloadBound");y(this,"strictBounds");y(this,"defaultTexture",null);y(this,"eventBus");y(this,"deltaTime",0);y(this,"lastFrameTime",0);y(this,"currentFrameTime",0);y(this,"fpsNumFrames",0);y(this,"fpsElapsedTime",0);y(this,"numQuadsRendered",0);y(this,"renderRequested",!1);y(this,"frameEventQueue",[]);y(this,"fontResolveMap",{});y(this,"contextSpy",null);this.options=e;const{canvas:t,clearColor:i,appWidth:s,appHeight:r,boundsMargin:o,enableContextSpy:a,forceWebGL2:l,numImageWorkers:h,textureMemory:c,renderEngine:u,fontEngines:d,createImageBitmapSupport:f}=e;this.eventBus=e.eventBus,this.txManager=new hm(this,{numImageWorkers:h,createImageBitmapSupport:f}),this.txManager.on("initialized",()=>{this.requestRender()}),this.txMemManager=new Am(this,c),this.shManager=new vm,this.animationManager=new em,this.contextSpy=a?new bm:null,this.strictBounds=e.strictBounds;let g=[0,0,0,0];o&&(g=Array.isArray(o)?o:[o,o,o,o]),this.boundsMargin=g,this.strictBound=Fs(0,0,s,r),this.preloadBound=el(this.strictBound,g);const p={stage:this,canvas:t,pixelRatio:e.devicePhysicalPixelRatio*e.deviceLogicalPixelRatio,clearColor:i??4278190080,bufferMemory:Lm,txManager:this.txManager,txMemManager:this.txMemManager,shManager:this.shManager,contextSpy:this.contextSpy,forceWebGL2:l};this.renderer=new u(p);const m=this.renderer.mode||"webgl";this.createDefaultTexture(),this.defShaderCtr=this.renderer.getDefShaderCtr(),Bp(m),this.txManager.renderer=this.renderer,this.textRenderers={},d.forEach(T=>{const S=new T(this),v=S.type;if(v==="sdf"&&m==="canvas"){console.warn("SdfTextRenderer is not compatible with Canvas renderer. Skipping...");return}S instanceof Xl&&(v==="canvas"?this.textRenderers.canvas=S:v==="sdf"&&(this.textRenderers.sdf=S))}),Object.keys(this.textRenderers).length===0&&console.warn("No text renderers available. Your text will not render."),this.fontManager=new dm(this.textRenderers);const _=new tl(this,{x:0,y:0,width:s,height:r,alpha:1,autosize:!1,boundsMargin:null,clipping:!1,color:0,colorTop:0,colorBottom:0,colorLeft:0,colorRight:0,colorTl:0,colorTr:0,colorBl:0,colorBr:0,zIndex:0,zIndexLocked:0,scaleX:1,scaleY:1,mountX:0,mountY:0,mount:0,pivot:.5,pivotX:.5,pivotY:.5,rotation:0,parent:null,texture:null,textureOptions:{},shader:this.defShaderCtr,rtt:!1,src:null,scale:1,preventCleanup:!1,strictBounds:this.strictBounds});this.root=_,Jp(this)}setClearColor(e){this.renderer.updateClearColor(e),this.renderRequested=!0}updateFrameTime(){const e=as();this.lastFrameTime=this.currentFrameTime,this.currentFrameTime=e,this.deltaTime=this.lastFrameTime?e-this.lastFrameTime:100/6,this.txManager.frameTime=e,this.txMemManager.frameTime=e,this.eventBus.emit("frameTick",{time:this.currentFrameTime,delta:this.deltaTime})}createDefaultTexture(){console.log("Creating default texture"),this.defaultTexture=this.txManager.createTexture("ColorTexture",{color:4294967295}),X(this.defaultTexture instanceof po),this.txManager.loadTexture(this.defaultTexture,!0),this.defaultTexture.setRenderableOwner(this,!0),this.defaultTexture.once("loaded",()=>{this.requestRender()})}updateAnimations(){const{animationManager:e}=this;this.root&&e.update(this.deltaTime)}hasSceneUpdates(){return!!this.root.updateType||this.renderRequested||this.txManager.hasUpdates()}drawFrame(){const{renderer:e,renderRequested:t}=this;X(e),this.root.updateType!==0&&this.root.update(this.deltaTime,this.root.clippingRect),this.txManager.processSome(this.options.textureProcessingTimeLimit),e.reset(),this.txMemManager.criticalCleanupRequested===!0&&(this.txMemManager.cleanup(!1),this.txMemManager.criticalCleanupRequested===!0&&this.txMemManager.cleanup(!0)),e.rttNodes.length>0&&e.renderRTTNodes(),this.addQuads(this.root),e==null||e.render(),this.calculateFps(),this.calculateQuads(),t&&(this.renderRequested=!1)}queueFrameEvent(e,t){this.frameEventQueue.push([e,t])}flushFrameEvents(){for(const[e,t]of this.frameEventQueue)this.eventBus.emit(e,t);this.frameEventQueue=[]}calculateFps(){var t,i;const{fpsUpdateInterval:e}=this.options;if(e&&(this.fpsNumFrames++,this.fpsElapsedTime+=this.deltaTime,this.fpsElapsedTime>=e)){const s=Math.round(this.fpsNumFrames*1e3/this.fpsElapsedTime);this.fpsNumFrames=0,this.fpsElapsedTime=0,this.queueFrameEvent("fpsUpdate",{fps:s,contextSpyData:((t=this.contextSpy)==null?void 0:t.getData())??null}),(i=this.contextSpy)==null||i.reset()}}calculateQuads(){const e=this.renderer.getQuadCount();e&&e!==this.numQuadsRendered&&(this.numQuadsRendered=e,this.queueFrameEvent("quadsUpdate",{quads:e}))}addQuads(e){X(this.renderer),e.isRenderable===!0&&e.renderQuads(this.renderer);for(let t=0;t<e.children.length;t++){const i=e.children[t];i!==void 0&&(i.worldAlpha===0||i.strictBounds===!0&&i.renderState===He.OutOfBounds||this.addQuads(i))}}requestRender(){this.renderRequested=!0}resolveTextRenderer(e,t=null){const i=`${e.fontFamily}${e.fontStyle}${e.fontWeight}${e.fontStretch}${t||""}`;if(this.fontResolveMap[i]!==void 0)return this.fontResolveMap[i];let s=t,r=!1;if(s){const a=this.textRenderers[s];a?a.canRenderFont(e)||(console.warn(`Cannot use override text renderer '${s}' for font`,e),s=null,r=!0):(console.warn(`Text renderer override '${s}' not found.`),s=null,r=!0)}if(!s){for(const[a,l]of Object.entries(this.textRenderers))if(l.canRenderFont(e)){s=a;break}!s&&this.textRenderers.canvas!==void 0&&(s="canvas")}if(r&&console.warn(`Falling back to text renderer ${String(s)}`),!s)return null;const o=this.textRenderers[s];return X(o,"resolvedTextRenderer undefined"),this.fontResolveMap[i]=o,o}createShaderCtr(e,t){return this.shManager.loadShader(e,t)}createNode(e){const t=this.resolveNodeDefaults(e);return new tl(this,t)}createTextNode(e){const t=e.fontSize??16,i={...this.resolveNodeDefaults(e),text:e.text??"",textRendererOverride:e.textRendererOverride??null,fontSize:t,fontFamily:e.fontFamily??"sans-serif",fontStyle:e.fontStyle??"normal",fontWeight:e.fontWeight??"normal",fontStretch:e.fontStretch??"normal",textAlign:e.textAlign??"left",contain:e.contain??"none",scrollable:e.scrollable??!1,scrollY:e.scrollY??0,offsetY:e.offsetY??0,letterSpacing:e.letterSpacing??0,lineHeight:e.lineHeight,maxLines:e.maxLines??0,textBaseline:e.textBaseline??"alphabetic",verticalAlign:e.verticalAlign??"middle",overflowSuffix:e.overflowSuffix??"...",debug:e.debug??{},shaderProps:null},s=this.resolveTextRenderer(i,e.textRendererOverride);if(!s)throw new Error(`No compatible text renderer found for ${i.fontFamily}`);return new Rm(this,i,s)}setBoundsMargin(e){this.boundsMargin=Array.isArray(e)?e:[e,e,e,e],this.root.setUpdateType($.RenderBounds)}resolveNodeDefaults(e){const t=e.color??4294967295,i=e.colorTl??e.colorTop??e.colorLeft??t,s=e.colorTr??e.colorTop??e.colorRight??t,r=e.colorBl??e.colorBottom??e.colorLeft??t,o=e.colorBr??e.colorBottom??e.colorRight??t;let a={};return this.options.inspector===!0&&(a=Cm(e.data??{})),{x:e.x??0,y:e.y??0,width:e.width??0,height:e.height??0,alpha:e.alpha??1,autosize:e.autosize??!1,boundsMargin:e.boundsMargin??null,clipping:e.clipping??!1,color:t,colorTop:e.colorTop??t,colorBottom:e.colorBottom??t,colorLeft:e.colorLeft??t,colorRight:e.colorRight??t,colorBl:r,colorBr:o,colorTl:i,colorTr:s,zIndex:e.zIndex??0,zIndexLocked:e.zIndexLocked??0,parent:e.parent??null,texture:e.texture??null,textureOptions:e.textureOptions??{},shader:e.shader??this.defShaderCtr,src:e.src??null,srcHeight:e.srcHeight,srcWidth:e.srcWidth,srcX:e.srcX,srcY:e.srcY,scale:e.scale??null,scaleX:e.scaleX??e.scale??1,scaleY:e.scaleY??e.scale??1,mount:e.mount??0,mountX:e.mountX??e.mount??0,mountY:e.mountY??e.mount??0,pivot:e.pivot??.5,pivotX:e.pivotX??e.pivot??.5,pivotY:e.pivotY??e.pivot??.5,rotation:e.rotation??0,rtt:e.rtt??!1,data:a,preventCleanup:e.preventCleanup??!1,imageType:e.imageType,strictBounds:e.strictBounds??this.strictBounds}}cleanup(e){this.txMemManager.cleanup(e)}};class Im extends li{constructor(t,i){var p,m,_,T,S,v;super();y(this,"root");y(this,"canvas");y(this,"settings");y(this,"stage");y(this,"inspector",null);const s={criticalThreshold:((p=t.textureMemory)==null?void 0:p.criticalThreshold)||124e6,targetThresholdLevel:((m=t.textureMemory)==null?void 0:m.targetThresholdLevel)||.5,cleanupInterval:((_=t.textureMemory)==null?void 0:_.cleanupInterval)||5e3,debugLogging:((T=t.textureMemory)==null?void 0:T.debugLogging)||!1,baselineMemoryAllocation:((S=t.textureMemory)==null?void 0:S.baselineMemoryAllocation)||26e6,doNotExceedCriticalThreshold:((v=t.textureMemory)==null?void 0:v.doNotExceedCriticalThreshold)||!1},r={appWidth:t.appWidth||1920,appHeight:t.appHeight||1080,textureMemory:s,boundsMargin:t.boundsMargin||0,deviceLogicalPixelRatio:t.deviceLogicalPixelRatio||1,devicePhysicalPixelRatio:t.devicePhysicalPixelRatio||window.devicePixelRatio,clearColor:t.clearColor??0,fpsUpdateInterval:t.fpsUpdateInterval||0,numImageWorkers:t.numImageWorkers!==void 0?t.numImageWorkers:2,enableContextSpy:t.enableContextSpy??!1,forceWebGL2:t.forceWebGL2??!1,inspector:t.inspector??!1,renderEngine:t.renderEngine,quadBufferSize:t.quadBufferSize??4*1024*1024,fontEngines:t.fontEngines,strictBounds:t.strictBounds??!0,textureProcessingTimeLimit:t.textureProcessingTimeLimit||10,canvas:t.canvas||document.createElement("canvas"),createImageBitmapSupport:t.createImageBitmapSupport||"full"};this.settings=r;const{appWidth:o,appHeight:a,deviceLogicalPixelRatio:l,devicePhysicalPixelRatio:h,inspector:c,canvas:u}=r,d=o*l,f=a*l;this.canvas=u,u.width=d*h,u.height=f*h,u.style.width=`${d}px`,u.style.height=`${f}px`,this.stage=new wm({appWidth:this.settings.appWidth,appHeight:this.settings.appHeight,boundsMargin:this.settings.boundsMargin,clearColor:this.settings.clearColor,canvas:this.canvas,deviceLogicalPixelRatio:this.settings.deviceLogicalPixelRatio,devicePhysicalPixelRatio:this.settings.devicePhysicalPixelRatio,enableContextSpy:this.settings.enableContextSpy,forceWebGL2:this.settings.forceWebGL2,fpsUpdateInterval:this.settings.fpsUpdateInterval,numImageWorkers:this.settings.numImageWorkers,renderEngine:this.settings.renderEngine,textureMemory:s,eventBus:this,quadBufferSize:this.settings.quadBufferSize,fontEngines:this.settings.fontEngines,inspector:this.settings.inspector!==null,strictBounds:this.settings.strictBounds,textureProcessingTimeLimit:this.settings.textureProcessingTimeLimit,createImageBitmapSupport:this.settings.createImageBitmapSupport}),this.root=this.stage.root;let g;if(typeof i=="string"?g=document.getElementById(i):g=i,!g)throw new Error("Could not find target element");g.appendChild(u),c&&!qs()&&(this.inspector=new c(u,r))}createNode(t){const i=this.stage.createNode(t);return this.inspector?this.inspector.createNode(i):i}createTextNode(t){const i=this.stage.createTextNode(t);return this.inspector?this.inspector.createTextNode(i):i}destroyNode(t){return this.inspector&&this.inspector.destroyNode(t.id),t.destroy()}createTexture(t,i){return this.stage.txManager.createTexture(t,i)}createShader(t,i){return this.stage.shManager.loadShader(t,i)}createDynamicShader(t){return this.stage.shManager.loadDynamicShader({effects:t})}createEffect(t,i,s){return{name:s,type:t,props:i}}getNodeById(t){var r;const i=(r=this.stage)==null?void 0:r.root;if(!i)return null;const s=o=>{if(o.id===t)return o;for(const a of o.children){const l=s(a);if(l)return l}return null};return s(i)}toggleFreeze(){throw new Error("Not implemented")}advanceFrame(){throw new Error("Not implemented")}getBufferInfo(){return this.stage.renderer.getBufferInfo()}rerender(){this.stage.requestRender()}cleanup(t=!1){this.stage.cleanup(t)}setClearColor(t){this.stage.setClearColor(t)}}class md extends li{constructor(t){super();y(this,"fontFamily");y(this,"descriptors");y(this,"loaded",!1);y(this,"metrics",null);const{fontFamily:i,descriptors:s,metrics:r}=t;r&&(this.metrics={ascender:r.ascender/r.unitsPerEm,descender:r.descender/r.unitsPerEm,lineGap:r.lineGap/r.unitsPerEm}),this.fontFamily=i,this.descriptors={style:"normal",weight:"normal",stretch:"normal",...s}}static convertToCssFontFaceDescriptors(t){return{style:t.style,weight:typeof t.weight=="number"?`${t.weight}`:t.weight,stretch:t.stretch,unicodeRange:t.unicodeRange,featureSettings:t.featureSettings,display:t.display}}}class Yn extends md{constructor(t){super(t);y(this,"fontFace");y(this,"fontUrl");const{fontFamily:i,fontUrl:s}=t,r=s.replace(/\(|\)/g,""),o=this.descriptors;let a={style:o.style,weight:typeof o.weight=="number"?`${o.weight}`:o.weight,stretch:o.stretch,unicodeRange:o.unicodeRange,featureSettings:o.featureSettings,display:o.display};for(const h in a){const c=h;a[c]===void 0&&delete a[c]}const l=new FontFace(i,`url(${r})`,a);r.length>0?l.load().then(()=>{this.loaded=!0,this.emit("loaded")}).catch(console.error):(this.loaded=!0,this.emit("loaded")),this.fontFace=l,this.fontUrl=s}}class Pm{}class _d extends Pm{constructor(t,i,s,r,o,a,l,h,c,u,d,f,g){super();y(this,"glw");y(this,"options");y(this,"buffers");y(this,"shader");y(this,"shaderProps");y(this,"alpha");y(this,"clippingRect");y(this,"dimensions");y(this,"bufferIdx");y(this,"zIndex");y(this,"renderToTexture");y(this,"parentHasRenderTexture");y(this,"framebufferDimensions");y(this,"length",0);y(this,"numQuads",0);y(this,"textures",[]);y(this,"maxTextures");this.glw=t,this.options=i,this.buffers=s,this.shader=r,this.shaderProps=o,this.alpha=a,this.clippingRect=l,this.dimensions=h,this.bufferIdx=c,this.zIndex=u,this.renderToTexture=d,this.parentHasRenderTexture=f,this.framebufferDimensions=g,this.maxTextures=r.supportsIndexedTextures?t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS):1}addTexture(t){const{textures:i,maxTextures:s}=this;let r=-1;const o=i.length;for(let a=0;a<o;a++)if(i[a]===t){r=a;break}return r!==-1?r:o>=s?4294967295:(this.textures.push(t),o)}draw(){const{glw:t,shader:i,shaderProps:s,options:r}=this,{shManager:o}=r;o.useShader(i),i.bindRenderOp(this,s);const a=this.bufferIdx/24*6*2;if(this.clippingRect.valid){const{x:l,y:h,width:c,height:u}=this.clippingRect,d=this.parentHasRenderTexture?1:r.pixelRatio,f=r.canvas.height,g=Math.round(l*d),p=Math.round(c*d),m=Math.round(u*d);let _=Math.round(f-m-h*d);this.parentHasRenderTexture&&(_=this.framebufferDimensions?this.framebufferDimensions.height-this.dimensions.height:0),t.setScissorTest(!0),t.scissor(g,_,p,m)}else t.setScissorTest(!1);t.drawElements(t.TRIANGLES,6*this.numQuads,t.UNSIGNED_SHORT,a)}}function Dm(n){const e={MAX_RENDERBUFFER_SIZE:0,MAX_TEXTURE_SIZE:0,MAX_VIEWPORT_DIMS:0,MAX_VERTEX_TEXTURE_IMAGE_UNITS:0,MAX_TEXTURE_IMAGE_UNITS:0,MAX_COMBINED_TEXTURE_IMAGE_UNITS:0,MAX_VERTEX_ATTRIBS:0,MAX_VARYING_VECTORS:0,MAX_VERTEX_UNIFORM_VECTORS:0,MAX_FRAGMENT_UNIFORM_VECTORS:0};return Object.keys(e).forEach(i=>{e[i]=n.getParameter(n[i])}),e}function Mm(n){const e={ANGLE_instanced_arrays:null,WEBGL_compressed_texture_s3tc:null,WEBGL_compressed_texture_astc:null,WEBGL_compressed_texture_etc:null,WEBGL_compressed_texture_etc1:null,WEBGL_compressed_texture_pvrtc:null,WEBKIT_WEBGL_compressed_texture_pvrtc:null,WEBGL_compressed_texture_s3tc_srgb:null,OES_vertex_array_object:null};return Object.keys(e).forEach(i=>{e[i]=n.getExtension(i)}),e}function Fm(n,e){const t=~~(e/80),i=new Uint16Array(t*6);for(let r=0,o=0;r<t;r+=6,o+=4)i[r]=o,i[r+1]=o+1,i[r+2]=o+2,i[r+3]=o+2,i[r+4]=o+1,i[r+5]=o+3;const s=n.createBuffer();n.elementArrayBufferData(s,i,n.STATIC_DRAW)}function km(n){return n!==null&&(typeof n=="object"&&n.constructor&&n.constructor.name==="HTMLImageElement"||typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement)}const _a=new Uint8Array([0,0,0,0]);class _o extends gd{constructor(t,i,s){super(i,s);y(this,"glw");y(this,"_nativeCtxTexture",null);y(this,"_w",0);y(this,"_h",0);this.glw=t}get ctxTexture(){return this.state==="freed"?(this.load(),null):(X(this._nativeCtxTexture),this._nativeCtxTexture)}get w(){return this._w}get h(){return this._h}load(){if(!(this.state==="loading"||this.state==="loaded")){if(this.state="loading",this.textureSource.setState("loading"),this._nativeCtxTexture=this.createNativeCtxTexture(),this._nativeCtxTexture===null){this.state="failed",this.textureSource.setState("failed",new Error("Could not create WebGL Texture")),console.error("Could not create WebGL Texture");return}this.onLoadRequest().then(({width:t,height:i})=>{this.state!=="freed"&&(this.state="loaded",this._w=t,this._h=i,this.textureSource.setState("loaded",{width:t,height:i}),this.textureSource.freeTextureData())}).catch(t=>{this.state!=="freed"&&(this.state="failed",this.textureSource.setState("failed",t),this.textureSource.freeTextureData(),console.error(t))})}}async onLoadRequest(){const{glw:t}=this,i=this.textureSource.textureData;if(i===null||this._nativeCtxTexture===null)throw new Error("Texture data or native texture is null "+this.textureSource.type);t.texImage2D(0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null),this.setTextureMemUse(_a.byteLength);let s=0,r=0;t.activeTexture(0);const o=i.data,a=t.RGBA,l=4,h=1.1;if(typeof ImageBitmap<"u"&&o instanceof ImageBitmap||o instanceof ImageData||km(o))s=o.width,r=o.height,t.bindTexture(this._nativeCtxTexture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!i.premultiplyAlpha),t.texImage2D(0,a,a,t.UNSIGNED_BYTE,o),this.setTextureMemUse(r*s*l*h);else if(o===null)s=0,r=0,t.bindTexture(this._nativeCtxTexture),t.texImage2D(0,a,1,1,0,a,t.UNSIGNED_BYTE,_a),this.setTextureMemUse(_a.byteLength);else if("mipmaps"in o&&o.mipmaps){const{mipmaps:c,width:u=0,height:d=0,type:f,glInternalFormat:g}=o,p=f==="ktx"?new DataView(c[0]??new ArrayBuffer(0)):c[0];t.bindTexture(this._nativeCtxTexture),t.compressedTexImage2D(0,g,u,d,0,p),t.texParameteri(t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_MIN_FILTER,t.LINEAR),this.setTextureMemUse(p.byteLength)}else o&&o instanceof Uint8Array?(s=1,r=1,t.bindTexture(this._nativeCtxTexture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!i.premultiplyAlpha),t.texImage2D(0,a,s,r,0,a,t.UNSIGNED_BYTE,o),this.setTextureMemUse(s*r*l)):console.error("WebGlCoreCtxTexture.onLoadRequest: Unexpected textureData returned",i);return{width:s,height:r}}free(){this.state!=="freed"&&(this.state="freed",this.textureSource.setState("freed"),this._w=0,this._h=0,this._nativeCtxTexture!==null&&(this.glw.deleteTexture(this._nativeCtxTexture),this.setTextureMemUse(0),this._nativeCtxTexture=null),this.textureSource.freeTextureData())}createNativeCtxTexture(){const{glw:t}=this,i=t.createTexture();return i?(t.activeTexture(0),t.bindTexture(i),t.texParameteri(t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i):null}}class Om extends _o{constructor(e,t,i){super(e,t,i)}async onLoadRequest(){var t,i;const e=this.textureSource.textureData;return X(e,"SubTexture must have texture data"),e.data instanceof Uint8Array?{width:1,height:1}:{width:((t=e.data)==null?void 0:t.width)||0,height:((i=e.data)==null?void 0:i.height)||0}}}class xd{constructor(e){y(this,"config");this.config=e}getBuffer(e){var t;return(t=this.config.find(i=>i.attributes[e]))==null?void 0:t.buffer}getAttributeInfo(e){var t;return(t=this.config.find(i=>i.attributes[e]))==null?void 0:t.attributes[e]}}function Bm(n){return self.WebGL2RenderingContext&&n instanceof self.WebGL2RenderingContext}class Um{constructor(e){y(this,"gl");y(this,"activeTextureUnit",0);y(this,"texture2dUnits");y(this,"texture2dParams",new WeakMap);y(this,"scissorEnabled");y(this,"scissorX");y(this,"scissorY");y(this,"scissorWidth");y(this,"scissorHeight");y(this,"blendEnabled");y(this,"blendSrcRgb");y(this,"blendDstRgb");y(this,"blendSrcAlpha");y(this,"blendDstAlpha");y(this,"boundArrayBuffer");y(this,"boundElementArrayBuffer");y(this,"curProgram");y(this,"canvas");y(this,"MAX_RENDERBUFFER_SIZE");y(this,"MAX_TEXTURE_SIZE");y(this,"MAX_VIEWPORT_DIMS");y(this,"MAX_VERTEX_TEXTURE_IMAGE_UNITS");y(this,"MAX_TEXTURE_IMAGE_UNITS");y(this,"MAX_COMBINED_TEXTURE_IMAGE_UNITS");y(this,"MAX_VERTEX_ATTRIBS");y(this,"MAX_VARYING_VECTORS");y(this,"MAX_VERTEX_UNIFORM_VECTORS");y(this,"MAX_FRAGMENT_UNIFORM_VECTORS");y(this,"TEXTURE_MAG_FILTER");y(this,"TEXTURE_MIN_FILTER");y(this,"TEXTURE_WRAP_S");y(this,"TEXTURE_WRAP_T");y(this,"LINEAR");y(this,"CLAMP_TO_EDGE");y(this,"RGB");y(this,"RGBA");y(this,"UNSIGNED_BYTE");y(this,"UNPACK_PREMULTIPLY_ALPHA_WEBGL");y(this,"UNPACK_FLIP_Y_WEBGL");y(this,"FLOAT");y(this,"TRIANGLES");y(this,"UNSIGNED_SHORT");y(this,"ONE");y(this,"ONE_MINUS_SRC_ALPHA");y(this,"VERTEX_SHADER");y(this,"FRAGMENT_SHADER");y(this,"STATIC_DRAW");y(this,"COMPILE_STATUS");y(this,"LINK_STATUS");y(this,"DYNAMIC_DRAW");y(this,"COLOR_ATTACHMENT0");y(this,"INVALID_ENUM");y(this,"INVALID_OPERATION");this.gl=e,this.activeTextureUnit=e.getParameter(e.ACTIVE_TEXTURE)-e.TEXTURE0;const t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);this.texture2dUnits=new Array(t).fill(void 0).map((s,r)=>(this.activeTexture(r),e.getParameter(e.TEXTURE_BINDING_2D))),this.activeTexture(this.activeTextureUnit),this.scissorEnabled=e.isEnabled(e.SCISSOR_TEST);const i=e.getParameter(e.SCISSOR_BOX);this.scissorX=i[0],this.scissorY=i[1],this.scissorWidth=i[2],this.scissorHeight=i[3],this.blendEnabled=e.isEnabled(e.BLEND),this.blendSrcRgb=e.getParameter(e.BLEND_SRC_RGB),this.blendDstRgb=e.getParameter(e.BLEND_DST_RGB),this.blendSrcAlpha=e.getParameter(e.BLEND_SRC_ALPHA),this.blendDstAlpha=e.getParameter(e.BLEND_DST_ALPHA),this.boundArrayBuffer=e.getParameter(e.ARRAY_BUFFER_BINDING),this.boundElementArrayBuffer=e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING),this.curProgram=e.getParameter(e.CURRENT_PROGRAM),this.canvas=e.canvas,this.MAX_RENDERBUFFER_SIZE=e.MAX_RENDERBUFFER_SIZE,this.MAX_TEXTURE_SIZE=e.MAX_TEXTURE_SIZE,this.MAX_VIEWPORT_DIMS=e.MAX_VIEWPORT_DIMS,this.MAX_VERTEX_TEXTURE_IMAGE_UNITS=e.MAX_VERTEX_TEXTURE_IMAGE_UNITS,this.MAX_TEXTURE_IMAGE_UNITS=e.MAX_TEXTURE_IMAGE_UNITS,this.MAX_COMBINED_TEXTURE_IMAGE_UNITS=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS,this.MAX_VERTEX_ATTRIBS=e.MAX_VERTEX_ATTRIBS,this.MAX_VARYING_VECTORS=e.MAX_VARYING_VECTORS,this.MAX_VERTEX_UNIFORM_VECTORS=e.MAX_VERTEX_UNIFORM_VECTORS,this.MAX_FRAGMENT_UNIFORM_VECTORS=e.MAX_FRAGMENT_UNIFORM_VECTORS,this.TEXTURE_MAG_FILTER=e.TEXTURE_MAG_FILTER,this.TEXTURE_MIN_FILTER=e.TEXTURE_MIN_FILTER,this.TEXTURE_WRAP_S=e.TEXTURE_WRAP_S,this.TEXTURE_WRAP_T=e.TEXTURE_WRAP_T,this.LINEAR=e.LINEAR,this.CLAMP_TO_EDGE=e.CLAMP_TO_EDGE,this.RGB=e.RGB,this.RGBA=e.RGBA,this.UNSIGNED_BYTE=e.UNSIGNED_BYTE,this.UNPACK_PREMULTIPLY_ALPHA_WEBGL=e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.UNPACK_FLIP_Y_WEBGL=e.UNPACK_FLIP_Y_WEBGL,this.FLOAT=e.FLOAT,this.TRIANGLES=e.TRIANGLES,this.UNSIGNED_SHORT=e.UNSIGNED_SHORT,this.ONE=e.ONE,this.ONE_MINUS_SRC_ALPHA=e.ONE_MINUS_SRC_ALPHA,this.MAX_VERTEX_TEXTURE_IMAGE_UNITS=e.MAX_VERTEX_TEXTURE_IMAGE_UNITS,this.TRIANGLES=e.TRIANGLES,this.UNSIGNED_SHORT=e.UNSIGNED_SHORT,this.VERTEX_SHADER=e.VERTEX_SHADER,this.FRAGMENT_SHADER=e.FRAGMENT_SHADER,this.STATIC_DRAW=e.STATIC_DRAW,this.COMPILE_STATUS=e.COMPILE_STATUS,this.LINK_STATUS=e.LINK_STATUS,this.DYNAMIC_DRAW=e.DYNAMIC_DRAW,this.COLOR_ATTACHMENT0=e.COLOR_ATTACHMENT0,this.INVALID_ENUM=e.INVALID_ENUM,this.INVALID_OPERATION=e.INVALID_OPERATION}isWebGl2(){return Bm(this.gl)}activeTexture(e){const{gl:t}=this;this.activeTextureUnit!==e&&(t.activeTexture(e+t.TEXTURE0),this.activeTextureUnit=e)}bindTexture(e){const{gl:t,activeTextureUnit:i,texture2dUnits:s}=this;s[i]!==e&&(s[i]=e,t.bindTexture(this.gl.TEXTURE_2D,e))}_getActiveTexture(){const{activeTextureUnit:e,texture2dUnits:t}=this;return t[e]}texParameteri(e,t){const{gl:i,texture2dParams:s}=this,r=this._getActiveTexture();if(!r)throw new Error("No active texture");let o=s.get(r);o||(o={},s.set(r,o)),o[e]!==t&&(o[e]=t,i.texParameteri(i.TEXTURE_2D,e,t))}texImage2D(e,t,i,s,r,o,a,l){const{gl:h}=this;o?h.texImage2D(h.TEXTURE_2D,e,t,i,s,r,o,a,l):h.texImage2D(h.TEXTURE_2D,e,t,i,s,r)}compressedTexImage2D(e,t,i,s,r,o){const{gl:a}=this;a.compressedTexImage2D(a.TEXTURE_2D,e,t,i,s,r,o)}pixelStorei(e,t){const{gl:i}=this;i.pixelStorei(e,t)}generateMipmap(){const{gl:e}=this;e.generateMipmap(e.TEXTURE_2D)}createTexture(){const{gl:e}=this;return e.createTexture()}deleteTexture(e){const{gl:t}=this;e&&this.texture2dParams.delete(e),t.deleteTexture(e)}deleteFramebuffer(e){this.gl.deleteFramebuffer(e)}viewport(e,t,i,s){const{gl:r}=this;r.viewport(e,t,i,s)}clearColor(e,t,i,s){const{gl:r}=this;r.clearColor(e,t,i,s)}setScissorTest(e){const{gl:t,scissorEnabled:i}=this;e!==i&&(e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this.scissorEnabled=e)}scissor(e,t,i,s){const{gl:r,scissorX:o,scissorY:a,scissorWidth:l,scissorHeight:h}=this;(e!==o||t!==a||i!==l||s!==h)&&(r.scissor(e,t,i,s),this.scissorX=e,this.scissorY=t,this.scissorWidth=i,this.scissorHeight=s)}setBlend(e){const{gl:t,blendEnabled:i}=this;e!==i&&(e?t.enable(t.BLEND):t.disable(t.BLEND),this.blendEnabled=e)}blendFunc(e,t){const{gl:i,blendSrcRgb:s,blendDstRgb:r,blendSrcAlpha:o,blendDstAlpha:a}=this;(e!==s||t!==r||e!==o||t!==a)&&(i.blendFunc(e,t),this.blendSrcRgb=e,this.blendDstRgb=t,this.blendSrcAlpha=e,this.blendDstAlpha=t)}createBuffer(){const{gl:e}=this;return e.createBuffer()}createFramebuffer(){const{gl:e}=this;return e.createFramebuffer()}bindFramebuffer(e){const{gl:t}=this;t.bindFramebuffer(t.FRAMEBUFFER,e)}framebufferTexture2D(e,t,i){const{gl:s}=this;s.framebufferTexture2D(s.FRAMEBUFFER,e,s.TEXTURE_2D,t,i)}clear(){const{gl:e}=this;e.clear(e.COLOR_BUFFER_BIT)}arrayBufferData(e,t,i){const{gl:s,boundArrayBuffer:r}=this;r!==e&&(s.bindBuffer(s.ARRAY_BUFFER,e),this.boundArrayBuffer=e),s.bufferData(s.ARRAY_BUFFER,t,i)}elementArrayBufferData(e,t,i){const{gl:s,boundElementArrayBuffer:r}=this;r!==e&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,e),this.boundElementArrayBuffer=e),s.bufferData(s.ELEMENT_ARRAY_BUFFER,t,i)}vertexAttribPointer(e,t,i,s,r,o,a){const{gl:l,boundArrayBuffer:h}=this;h!==e&&(l.bindBuffer(l.ARRAY_BUFFER,e),this.boundArrayBuffer=e),l.vertexAttribPointer(t,i,s,r,o,a)}useProgram(e){const{gl:t,curProgram:i}=this;i!==e&&(t.useProgram(e),this.curProgram=e)}uniform1f(e,t){const{gl:i}=this;i.uniform1f(e,t)}uniform1fv(e,t){const{gl:i}=this;i.uniform1fv(e,t)}uniform1i(e,t){const{gl:i}=this;i.uniform1i(e,t)}uniform1iv(e,t){const{gl:i}=this;i.uniform1iv(e,t)}uniform2f(e,t,i){const{gl:s}=this;s.uniform2f(e,t,i)}uniform2fv(e,t){const{gl:i}=this;i.uniform2fv(e,t)}uniform2i(e,t,i){const{gl:s}=this;s.uniform2i(e,t,i)}uniform2iv(e,t){const{gl:i}=this;i.uniform2iv(e,t)}uniform3f(e,t,i,s){const{gl:r}=this;r.uniform3f(e,t,i,s)}uniform3fv(e,t){const{gl:i}=this;i.uniform3fv(e,t)}uniform3i(e,t,i,s){const{gl:r}=this;r.uniform3i(e,t,i,s)}uniform3iv(e,t){const{gl:i}=this;i.uniform3iv(e,t)}uniform4f(e,t,i,s,r){const{gl:o}=this;o.uniform4f(e,t,i,s,r)}uniform4fv(e,t){const{gl:i}=this;i.uniform4fv(e,t)}uniform4i(e,t,i,s,r){const{gl:o}=this;o.uniform4i(e,t,i,s,r)}uniform4iv(e,t){const{gl:i}=this;i.uniform4iv(e,t)}uniformMatrix2fv(e,t){const{gl:i}=this;i.uniformMatrix2fv(e,!1,t)}uniformMatrix3fv(e,t){const{gl:i}=this;i.uniformMatrix3fv(e,!1,t)}uniformMatrix4fv(e,t){const{gl:i}=this;i.uniformMatrix4fv(e,!1,t)}getParameter(e){const{gl:t}=this;return t.getParameter(e)}drawElements(e,t,i,s){const{gl:r}=this;r.drawElements(e,t,i,s)}getExtension(e){const{gl:t}=this;return t.getExtension(e)}getError(){const{gl:e}=this;return e.getError()}createVertexArray(){const{gl:e}=this;return X(e instanceof WebGL2RenderingContext),e.createVertexArray()}bindVertexArray(e){const{gl:t}=this;X(t instanceof WebGL2RenderingContext),t.bindVertexArray(e)}getAttribLocation(e,t){const{gl:i}=this;return i.getAttribLocation(e,t)}getUniformLocation(e,t){const{gl:i}=this;return i.getUniformLocation(e,t)}enableVertexAttribArray(e){const{gl:t}=this;t.enableVertexAttribArray(e)}disableVertexAttribArray(e){const{gl:t}=this;t.disableVertexAttribArray(e)}createShader(e){const{gl:t}=this;return t.createShader(e)}compileShader(e){const{gl:t}=this;t.compileShader(e)}attachShader(e,t){const{gl:i}=this;i.attachShader(e,t)}linkProgram(e){const{gl:t}=this;t.linkProgram(e)}deleteProgram(e){const{gl:t}=this;t.deleteProgram(e)}getShaderParameter(e,t){const{gl:i}=this;return i.getShaderParameter(e,t)}getShaderInfoLog(e){const{gl:t}=this;return t.getShaderInfoLog(e)}createProgram(){const{gl:e}=this;return e.createProgram()}getProgramParameter(e,t){const{gl:i}=this;return i.getProgramParameter(e,t)}getProgramInfoLog(e){const{gl:t}=this;return t.getProgramInfoLog(e)}shaderSource(e,t){const{gl:i}=this;i.shaderSource(e,t)}deleteShader(e){const{gl:t}=this;t.deleteShader(e)}}class oc extends _o{constructor(t,i,s){super(t,i,s);y(this,"framebuffer",null)}async onLoadRequest(){const{glw:t}=this,i=this._nativeCtxTexture=this.createNativeCtxTexture(),{width:s,height:r}=this.textureSource;return this.framebuffer=t.createFramebuffer(),t.texImage2D(0,t.RGBA,s,r,0,t.RGBA,t.UNSIGNED_BYTE,null),this.setTextureMemUse(s*r*4),t.bindFramebuffer(this.framebuffer),t.framebufferTexture2D(t.COLOR_ATTACHMENT0,i,0),t.bindFramebuffer(null),{width:s,height:r}}free(){super.free(),this.glw.deleteFramebuffer(this.framebuffer),this.framebuffer=null}}const Nm=24;class jl extends pd{constructor(t){super(t);y(this,"glw");y(this,"system");y(this,"quadBuffer");y(this,"fQuadBuffer");y(this,"uiQuadBuffer");y(this,"renderOps",[]);y(this,"curBufferIdx",0);y(this,"curRenderOp",null);y(this,"rttNodes",[]);y(this,"activeRttNode",null);y(this,"defShaderCtrl");y(this,"defaultShader");y(this,"quadBufferCollection");y(this,"clearColor",{raw:0,normalized:[0,0,0,0]});y(this,"quadBufferUsage",0);y(this,"numQuadsRendered",0);y(this,"renderToTextureActive",!1);this.quadBuffer=new ArrayBuffer(this.stage.options.quadBufferSize),this.fQuadBuffer=new Float32Array(this.quadBuffer),this.uiQuadBuffer=new Uint32Array(this.quadBuffer),this.mode="webgl";const{canvas:i,clearColor:s,bufferMemory:r}=t,o=kp(i,t.forceWebGL2,t.contextSpy),a=this.glw=new Um(o);a.viewport(0,0,i.width,i.height),this.updateClearColor(s),a.setBlend(!0),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),Fm(a,r),this.system={parameters:Dm(this.glw),extensions:Mm(this.glw)},this.shManager.renderer=this,this.defShaderCtrl=this.shManager.loadShader("DefaultShader"),this.defaultShader=this.defShaderCtrl.shader;const l=a.createBuffer();X(l);const h=6*Float32Array.BYTES_PER_ELEMENT;this.quadBufferCollection=new xd([{buffer:l,attributes:{a_position:{name:"a_position",size:2,type:a.FLOAT,normalized:!1,stride:h,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:a.FLOAT,normalized:!1,stride:h,offset:2*Float32Array.BYTES_PER_ELEMENT},a_color:{name:"a_color",size:4,type:a.UNSIGNED_BYTE,normalized:!0,stride:h,offset:4*Float32Array.BYTES_PER_ELEMENT},a_textureIndex:{name:"a_textureIndex",size:1,type:a.FLOAT,normalized:!1,stride:h,offset:5*Float32Array.BYTES_PER_ELEMENT}}}])}reset(){const{glw:t}=this;this.curBufferIdx=0,this.curRenderOp=null,this.renderOps.length=0,t.setScissorTest(!1),t.clear()}getShaderManager(){return this.shManager}createCtxTexture(t){return t instanceof Rr?new Om(this.glw,this.txMemManager,t):t instanceof mo?new oc(this.glw,this.txMemManager,t):new _o(this.glw,this.txMemManager,t)}addQuad(t){const{fQuadBuffer:i,uiQuadBuffer:s}=this;let r=t.texture;if(X(r!==null,"Texture is required"),t.shaderProps!==null){if(go(t.shaderProps,"$dimensions")==!0){const _=t.shaderProps.$dimensions;_.width=t.width,_.height=t.height}go(t.shaderProps,"$alpha")===!0&&(t.shaderProps.$alpha=t.alpha)}let{curBufferIdx:o,curRenderOp:a}=this;const l={width:-1,height:-1};l.width=t.width,l.height=t.height;const h=t.shader||this.defaultShader;X(h.getUniformLocation!==void 0,"Invalid WebGL shader"),this.reuseRenderOp(t)===!1&&(this.newRenderOp(h,t.shaderProps,t.alpha,l,t.clippingRect,o,t.rtt,t.parentHasRenderTexture,t.framebufferDimensions),a=this.curRenderOp,X(a));let c=0,u=0,d=1,f=1;if(r.type===Ae.subTexture){const{x:_,y:T,width:S,height:v}=r.props,{width:E=0,height:C=0}=r.parentTexture.dimensions||{width:0,height:0};c=_/E,d=c+S/E,u=T/C,f=u+v/C,r=r.parentTexture}if(r.type===Ae.image&&t.textureOptions!==null&&t.textureOptions.resizeMode!==void 0&&r.dimensions!==null){const _=t.textureOptions.resizeMode,{width:T,height:S}=r.dimensions;if(_.type==="cover"){const v=t.width/T,E=t.height/S,C=Math.max(v,E),b=1/C;if(C&&v&&v<C){const A=b*t.width;c=(1-A/T)*(_.clipX??.5),d=c+A/T}if(C&&E&&E<C){const A=b*t.height;u=(1-A/S)*(_.clipY??.5),f=u+A/S}}}let g=0;t.textureOptions!==null&&(t.textureOptions.flipX===!0&&([c,d]=[d,c]),g=+(t.textureOptions.flipY||!1)),g^+(r.type===Ae.renderToTexture)&&([u,f]=[f,u]);const p=r.ctxTexture;X(p instanceof _o);const m=this.addTexture(p,o);if(X(this.curRenderOp!==null),t.renderCoords)i[o++]=t.renderCoords.x1,i[o++]=t.renderCoords.y1,i[o++]=c,i[o++]=u,s[o++]=t.colorTl,i[o++]=m,i[o++]=t.renderCoords.x2,i[o++]=t.renderCoords.y2,i[o++]=d,i[o++]=u,s[o++]=t.colorTr,i[o++]=m,i[o++]=t.renderCoords.x4,i[o++]=t.renderCoords.y4,i[o++]=c,i[o++]=f,s[o++]=t.colorBl,i[o++]=m,i[o++]=t.renderCoords.x3,i[o++]=t.renderCoords.y3,i[o++]=d,i[o++]=f,s[o++]=t.colorBr,i[o++]=m;else if(t.tb!==0||t.tc!==0)i[o++]=t.tx,i[o++]=t.ty,i[o++]=c,i[o++]=u,s[o++]=t.colorTl,i[o++]=m,i[o++]=t.tx+t.width*t.ta,i[o++]=t.ty+t.width*t.tc,i[o++]=d,i[o++]=u,s[o++]=t.colorTr,i[o++]=m,i[o++]=t.tx+t.height*t.tb,i[o++]=t.ty+t.height*t.td,i[o++]=c,i[o++]=f,s[o++]=t.colorBl,i[o++]=m,i[o++]=t.tx+t.width*t.ta+t.height*t.tb,i[o++]=t.ty+t.width*t.tc+t.height*t.td,i[o++]=d,i[o++]=f,s[o++]=t.colorBr,i[o++]=m;else{const _=t.tx+t.width*t.ta,T=t.ty+t.height*t.td;i[o++]=t.tx,i[o++]=t.ty,i[o++]=c,i[o++]=u,s[o++]=t.colorTl,i[o++]=m,i[o++]=_,i[o++]=t.ty,i[o++]=d,i[o++]=u,s[o++]=t.colorTr,i[o++]=m,i[o++]=t.tx,i[o++]=T,i[o++]=c,i[o++]=f,s[o++]=t.colorBl,i[o++]=m,i[o++]=_,i[o++]=T,i[o++]=d,i[o++]=f,s[o++]=t.colorBr,i[o++]=m}this.curRenderOp.length+=Nm,this.curRenderOp.numQuads++,this.curBufferIdx=o}newRenderOp(t,i,s,r,o,a,l,h,c){const u=new _d(this.glw,this.options,this.quadBufferCollection,t,i,s,o,r,a,0,l,h,c);this.curRenderOp=u,this.renderOps.push(u)}addTexture(t,i,s){const{curRenderOp:r}=this;X(r);const o=r.addTexture(t);if(o===4294967295){if(s)throw new Error("Unable to add texture to render op");return this.newRenderOp(r.shader,r.shaderProps,r.alpha,r.dimensions,r.clippingRect,i),this.addTexture(t,i,!0)}return o}reuseRenderOp(t){var h;const{shader:i,shaderProps:s,parentHasRenderTexture:r,rtt:o,clippingRect:a}=t,l=i||this.defaultShader;return!(((h=this.curRenderOp)==null?void 0:h.shader)!==l||Gp(this.curRenderOp.clippingRect,a)===!1||r!==void 0||o!==void 0||this.curRenderOp.shader!==this.defaultShader&&(s===null||this.curRenderOp.shader.canBatchShaderProps(this.curRenderOp.shaderProps,s)===!1))}addRenderOp(t){this.renderOps.push(t),this.curRenderOp=null}render(t="screen"){const{glw:i,quadBuffer:s}=this,r=new Float32Array(s,0,this.curBufferIdx),o=this.quadBufferCollection.getBuffer("a_position")||null;i.arrayBufferData(o,r,i.STATIC_DRAW);for(let l=0,h=this.renderOps.length;l<h;l++)this.renderOps[l].draw();this.quadBufferUsage=this.curBufferIdx*r.BYTES_PER_ELEMENT;const a=4*(6*r.BYTES_PER_ELEMENT);this.numQuadsRendered=this.quadBufferUsage/a}getQuadCount(){return this.numQuadsRendered}renderToTexture(t){for(let i=0;i<this.rttNodes.length;i++)if(this.rttNodes[i]===t)return;this.insertRTTNodeInOrder(t)}insertRTTNodeInOrder(t){let i=this.rttNodes.length,s=t;for(;s&&s.parent;){const o=this.rttNodes.indexOf(s.parent);if(o!==-1){i=o;break}s=s.parent}const r=this.findMaxChildRTTIndex(t);r!==-1&&(i=Math.max(i,r+1)),this.rttNodes.splice(i,0,t)}findMaxChildRTTIndex(t){let i=-1;const s=r=>{const o=this.rttNodes.indexOf(r);o!==-1&&(i=Math.max(i,o));for(const a of r.children)s(a)};return s(t),i}renderRTTNodes(){const{glw:t}=this,{txManager:i}=this.stage;for(let r=0;r<this.rttNodes.length;r++){const o=this.rttNodes[r];if(o===void 0||o.hasRTTupdates===!1||o.worldAlpha===0||o.strictBounds===!0&&o.renderState===He.OutOfBounds||o.texture===null||o.texture.state!=="loaded")continue;this.activeRttNode=o,X(o.texture,"RTT node missing texture");const a=o.texture.ctxTexture;X(a instanceof oc),this.renderToTextureActive=!0,t.bindFramebuffer(a.framebuffer),t.viewport(0,0,a.w,a.h),t.clearColor(0,0,0,0),t.clear();for(let l=0;l<o.children.length;l++){const h=o.children[l];h!==void 0&&(this.stage.addQuads(h),h.hasRTTupdates=!1)}this.render(),this.renderOps.length=0,o.hasRTTupdates=!1}const s=this.clearColor.normalized;t.clearColor(s[0],s[1],s[2],s[3]),t.bindFramebuffer(null),t.viewport(0,0,this.glw.canvas.width,this.glw.canvas.height),this.renderToTextureActive=!1}removeRTTNode(t){const i=this.rttNodes.indexOf(t);i!==-1&&this.rttNodes.splice(i,1)}getBufferInfo(){return{totalAvailable:this.stage.options.quadBufferSize,totalUsed:this.quadBufferUsage}}getDefShaderCtr(){return this.defShaderCtrl}updateClearColor(t){if(this.clearColor.raw===t)return;const i=this.glw,s=Nr(t);i.clearColor(s[0],s[1],s[2],s[3]),this.clearColor={raw:t,normalized:s},i.clear()}}const $m={LINE_FEED:10};class zm{}class Gm extends zm{constructor(t,i){super();y(this,"data");y(this,"glyphMap");y(this,"kernings");this.data=t,this.glyphMap=i;const s=this.kernings={};t.kernings.forEach(r=>{const o=r.second,a=s[o]=s[o]||{};a[r.first]=r.amount}),this.kernings=s}*shapeText(t,i){var o;let s,r;for(;(s=i.peek())&&!s.done;){const a=s.value,l=this.glyphMap.get(a);if(i.next(),l!==void 0){const h=r!==void 0?(((o=this.kernings[l.id])==null?void 0:o[r])||0)+t.letterSpacing:0;r=l.id,yield{mapped:!0,glyphId:l.id,codepoint:a,cluster:i.lastIndex,xAdvance:l.xadvance+h,yAdvance:0,xOffset:l.xoffset+h,yOffset:l.yoffset,xBearing:0,yBearing:0,width:l.width,height:l.height}}else a===$m.LINE_FEED&&(r=void 0),yield{mapped:!1,codepoint:a,cluster:i.lastIndex}}}}class ll extends md{constructor(t,i){super(i);y(this,"type");y(this,"texture");y(this,"maxCharHeight",0);y(this,"shaper");y(this,"glyphMap",new Map);y(this,"data");const{atlasUrl:s,atlasDataUrl:r,stage:o}=i;this.type=t;const a=o.renderer;X(a instanceof jl,"SDF Font Faces can only be used with the WebGL Renderer"),this.texture=o.txManager.createTexture("ImageTexture",{src:s,premultiplyAlpha:!1}),o.txManager.loadTexture(this.texture,!0),this.texture.preventCleanup=!0,this.texture.on("loaded",()=>{this.checkLoaded(),o.requestRender()}),hd(r).then(l=>{var c;this.data=JSON.parse(l),X(this.data);let h=0;if(this.data.chars.forEach(u=>{this.glyphMap.set(u.id,u);const d=u.yoffset+u.height;d>h&&(h=d)}),this.maxCharHeight=h,this.shaper=new Gm(this.data,this.glyphMap),!this.metrics)if((c=this.data)!=null&&c.lightningMetrics){const{ascender:u,descender:d,lineGap:f,unitsPerEm:g}=this.data.lightningMetrics;this.metrics={ascender:u/g,descender:d/g,lineGap:f/g}}else throw new Error(`Font metrics not found in ${this.type} font ${this.fontFamily}. Make sure you are using the latest version of the Lightning 3 \`msdf-generator\` tool to generate your SDF fonts.`);this.checkLoaded()}).catch(console.error)}getAtlasEntry(t){const i=this.glyphMap.get(t);if(i===void 0)throw new Error(`Glyph ${t} not found in font ${this.fontFamily}`);return{x:i.x,y:i.y,width:i.width,height:i.height}}checkLoaded(){this.loaded||this.texture.state==="loaded"&&this.data&&(this.loaded=!0,this.emit("loaded"))}}const Hm=24;function Vm(n,e,t,i,s,r,o,a,l){const h=Math.min(Math.max(o.firstLineIdx,0),a.length),c=0,{metrics:u}=t;X(u,"Font metrics not loaded"),X(t.data,"Font data not loaded");const d=(u.ascender-u.descender)*n;let f=0;i==="middle"?f=(e-d)/2:i==="bottom"&&(f=e-d);const g=s/r,p=t.data.common.base,_=u.ascender*n-p,T=g+_+h*e+f;if(!(l&&T>=l/r))return{sdfX:c,sdfY:T,lineIndex:h}}class hr{constructor(e,t=0){y(this,"iterator");y(this,"peekBuffer",[]);y(this,"_lastIndex");this.iterator=e,this.iterator=e,this._lastIndex=t-1,this.peekBuffer=[]}next(){const e=this.peekBuffer.length>0?this.peekBuffer.pop():this.iterator.next();return e.done?this._lastIndex=-1:this._lastIndex++,e}peek(){if(this.peekBuffer.length>0)return this.peekBuffer[0];const e=this.iterator.next();return this.peekBuffer.push(e),e}get lastIndex(){return this._lastIndex}}function*cr(n,e=0){let t=e;for(;t<n.length;){const i=n.codePointAt(t);if(i===void 0)throw new Error("Invalid Unicode code point");yield i,t+=i<=65535?1:2}}function Wm(n,e,t){const i=t.shapeText(e,new hr(cr(n,0),0));let s=0;for(const r of i)r.mapped&&r.codepoint!==8203&&(s+=r.xAdvance);return s}function Ym(n,e,t,i,s,r,o,a,l,h,c,u,d,f,g,p,m,_,T){X(g,"Font face must be loaded"),X(g.loaded,"Font face must be loaded"),X(g.data,"Font face must be loaded"),X(g.shaper,"Font face must be loaded");const S=a/g.data.info.size,v=l/S,E=r/S,C=h/S,b=d[n],A=(b==null?void 0:b.codepointIndex)||0,L=(b==null?void 0:b.maxX)||0,R=(b==null?void 0:b.maxY)||0;let M=L,F=R,z=e,G=t,k=0;const I={codepointIndex:-1,bufferOffset:-1,xStart:-1},O=g.shaper,V={letterSpacing:C};i.endsWith(" ")&&(i+=" ");let B=O.shapeText(V,new hr(cr(i,A),A)),U,Y=-1;const W=[],Q=o/S,te=Wm(_,V,O);let re=!0;for(;re;){const J=(T===0||n+1<T)&&(u!=="both"||m||G+v+g.maxCharHeight<=Q),me=J?E:E-te;let ge=0;const Be=G+g.maxCharHeight>=f.y1,Ke=G<=f.y2,ht=Be&&Ke;for(;(U=B.next())&&!U.done;){const _e=U.value;if(n===d.length)d.push({codepointIndex:_e.cluster,maxY:F,maxX:M});else if(n>d.length)throw new Error("Unexpected lineCache length");if(_e.codepoint===32||_e.codepoint===10||_e.codepoint===8203?I.codepointIndex!==-1&&(I.codepointIndex=-1,ge=z):I.codepointIndex===-1&&(I.codepointIndex=_e.cluster,I.bufferOffset=k,I.xStart=ge),_e.mapped){const Mt=z+_e.xOffset+_e.width;if(u!=="none"&&Mt>=me&&I.codepointIndex!==-1&&I.xStart>0)if(J){B=O.shapeText(V,new hr(cr(i,I.codepointIndex),I.codepointIndex)),k=I.bufferOffset;break}else B=O.shapeText(V,new hr(cr(_,0),0)),z=I.xStart,k=I.bufferOffset,u="none";else{const it=z+_e.xOffset,Je=G+_e.yOffset;if(ht){Y===-1&&(Y=k);const de=g.getAtlasEntry(_e.glyphId),xe=de.x/g.data.common.scaleW,De=de.y/g.data.common.scaleH,et=de.width/g.data.common.scaleW,Ie=de.height/g.data.common.scaleH;c[k++]=it,c[k++]=Je,c[k++]=xe,c[k++]=De,c[k++]=it+_e.width,c[k++]=Je,c[k++]=xe+et,c[k++]=De,c[k++]=it,c[k++]=Je+_e.height,c[k++]=xe,c[k++]=De+Ie,c[k++]=it+_e.width,c[k++]=Je+_e.height,c[k++]=xe+et,c[k++]=De+Ie}F=Math.max(F,Je+_e.height),M=Math.max(M,it+_e.width),z+=_e.xAdvance}}else if(_e.codepoint===10){if(J)break;B=O.shapeText(V,new hr(cr(_,0),0)),u="none"}}Y!==-1&&(W.push({bufferStart:Y,bufferEnd:k}),Y=-1),z=0,G+=v,n++,I.codepointIndex=-1,ge=0,!p&&u==="both"&&G>f.y2||U&&U.done?re=!1:J||(re=!1)}if(s==="center"){const J=u==="none"?M:E;for(let me=0;me<W.length;me++){const ge=W[me],Be=c[ge.bufferEnd-4]-c[ge.bufferStart],Ke=(J-Be)/2;for(let ht=ge.bufferStart;ht<ge.bufferEnd;ht+=4)c[ht]+=Ke}}else if(s==="right"){const J=u==="none"?M:E;for(let me=0;me<W.length;me++){const ge=W[me],Be=ge.bufferEnd===ge.bufferStart?0:c[ge.bufferEnd-4]-c[ge.bufferStart],Ke=J-Be;for(let ht=ge.bufferStart;ht<ge.bufferEnd;ht+=4)c[ht]+=Ke}}return X(U),{bufferNumFloats:k,bufferNumQuads:k/16,layoutNumCharacters:U.done?i.length-A:U.value.cluster-A+1,fullyProcessed:!!U.done,maxX:M,maxY:F,numLines:d.length}}function Km(n,e){return Math.ceil(n/e)*e}function Xm(n,e){return Math.floor(n/e)*e}function jm(n,e,t,i,s,r,o,a){const{screen:l,sdf:h}=n;if(!Vp(o))l.x1=0,l.y1=0,l.x2=0,l.y2=0,h.x1=0,h.y1=0,h.x2=0,h.y2=0,n.numLines=0,n.firstLineIdx=0;else{const c=o.x1-e,u=c+(o.x2-o.x1),d=o.y1-t+i,f=Xm(d-r,s||1),g=Km(d+(o.y2-o.y1)+r,s||1);l.x1=c,l.y1=f,l.x2=u,l.y2=g,h.x1=c/a,h.y1=f/a,h.x2=u/a,h.y2=g/a,n.numLines=Math.ceil((g-f)/s),n.firstLineIdx=s?Math.floor(f/s):0}n.valid=!0}function yd(n,e){return e*(n.ascender-n.descender+n.lineGap)}const qm={x:0,y:0,width:0,height:0};class Qm extends Xl{constructor(t){super(t);y(this,"ssdfFontFamilies",{});y(this,"msdfFontFamilies",{});y(this,"fontFamilyArray",[this.ssdfFontFamilies,this.msdfFontFamilies]);y(this,"sdfShader");y(this,"rendererBounds");y(this,"type","sdf");this.sdfShader=this.stage.shManager.loadShader("SdfShader",{transform:new Float32Array,color:0,size:0,scrollY:0,distanceRange:0,debug:!1}).shader,this.rendererBounds={x1:0,y1:0,x2:this.stage.options.appWidth,y2:this.stage.options.appHeight}}getPropertySetters(){return{fontFamily:(t,i)=>{t.props.fontFamily=i,this.releaseFontFace(t),this.invalidateLayoutCache(t)},fontWeight:(t,i)=>{t.props.fontWeight=i,this.releaseFontFace(t),this.invalidateLayoutCache(t)},fontStyle:(t,i)=>{t.props.fontStyle=i,this.releaseFontFace(t),this.invalidateLayoutCache(t)},fontStretch:(t,i)=>{t.props.fontStretch=i,this.releaseFontFace(t),this.invalidateLayoutCache(t)},fontSize:(t,i)=>{t.props.fontSize=i,this.invalidateLayoutCache(t)},text:(t,i)=>{t.props.text=i,this.invalidateLayoutCache(t)},textAlign:(t,i)=>{t.props.textAlign=i,this.invalidateLayoutCache(t)},color:(t,i)=>{t.props.color=i},x:(t,i)=>{t.props.x=i,t.elementBounds.valid&&(this.setElementBoundsX(t),!t.renderWindow.valid&&fa(t.elementBounds,this.rendererBounds)&&this.scheduleUpdateState(t))},y:(t,i)=>{t.props.y=i,t.elementBounds.valid&&(this.setElementBoundsY(t),!t.renderWindow.valid&&fa(t.elementBounds,this.rendererBounds)&&this.scheduleUpdateState(t))},contain:(t,i)=>{t.props.contain=i,this.invalidateLayoutCache(t)},width:(t,i)=>{t.props.width=i,t.props.contain!=="none"&&this.invalidateLayoutCache(t)},height:(t,i)=>{t.props.height=i,t.props.contain==="both"&&this.invalidateLayoutCache(t)},offsetY:(t,i)=>{t.props.offsetY=i,this.invalidateLayoutCache(t)},scrollable:(t,i)=>{t.props.scrollable=i,this.invalidateLayoutCache(t)},scrollY:(t,i)=>{t.props.scrollY=i,this.scheduleUpdateState(t)},letterSpacing:(t,i)=>{t.props.letterSpacing=i,this.invalidateLayoutCache(t)},lineHeight:(t,i)=>{t.props.lineHeight=i,t.resLineHeight=void 0,this.invalidateLayoutCache(t)},maxLines:(t,i)=>{t.props.maxLines=i,this.invalidateLayoutCache(t)},textBaseline:(t,i)=>{t.props.textBaseline=i,this.invalidateLayoutCache(t)},verticalAlign:(t,i)=>{t.props.verticalAlign=i,this.invalidateLayoutCache(t)},overflowSuffix:(t,i)=>{t.props.overflowSuffix=i,this.invalidateLayoutCache(t)},debug:(t,i)=>{t.props.debug=i}}}canRenderFont(t){const{fontFamily:i}=t;return i in this.ssdfFontFamilies||i in this.msdfFontFamilies||i==="$$SDF_FAILURE_TEST$$"}isFontFaceSupported(t){return t instanceof ll}addFontFace(t){X(t instanceof ll);const i=t.fontFamily,s=t.type==="ssdf"?this.ssdfFontFamilies:t.type==="msdf"?this.msdfFontFamilies:void 0;if(!s){console.warn(`Invalid font face type: ${t.type}`);return}let r=s[i];r||(r=new Set,s[i]=r),r.add(t)}createState(t){return{props:t,status:"initialState",updateScheduled:!1,emitter:new li,lineCache:[],forceFullLayoutCalc:!1,renderWindow:{screen:{x1:0,y1:0,x2:0,y2:0},sdf:{x1:0,y1:0,x2:0,y2:0},firstLineIdx:0,numLines:0,valid:!1},elementBounds:{x1:0,y1:0,x2:0,y2:0,valid:!1},clippingRect:{x:0,y:0,width:0,height:0,valid:!1},bufferNumFloats:0,bufferNumQuads:0,vertexBuffer:void 0,webGlBuffers:null,bufferUploaded:!1,textH:void 0,textW:void 0,distanceRange:0,trFontFace:void 0,isRenderable:!1,resLineHeight:void 0,debugData:{updateCount:0,layoutCount:0,lastLayoutNumCharacters:0,layoutSum:0,drawSum:0,drawCount:0,bufferSize:0}}}updateState(t){let{trFontFace:i}=t;const{textH:s,lineCache:r,debugData:o,forceFullLayoutCalc:a}=t;if(o.updateCount++,t.status==="initialState"&&this.setStatus(t,"loading"),i===void 0){if(i=this.resolveFontFace(t.props),t.trFontFace=i,i===void 0){const O=`SdfTextRenderer: Could not resolve font face for family: '${t.props.fontFamily}'`;console.error(O),this.setStatus(t,"failed",new Error(O));return}i.texture.setRenderableOwner(t,!0)}if(i.loaded===!1){i.once("loaded",()=>{this.scheduleUpdateState(t)});return}X(i.data,"Font face data should be loaded"),X(i.metrics,"Font face metrics should be loaded");const{text:l,fontSize:h,x:c,y:u,contain:d,width:f,height:g,verticalAlign:p,scrollable:m,overflowSuffix:_,maxLines:T}=t.props,S=d==="both"&&m?t.props.scrollY:0,{renderWindow:v}=t,E=i.data.info.size,C=h/E;let b=t.resLineHeight;if(b===void 0){const O=t.props.lineHeight;O===void 0?b=yd(i.metrics,h):b=O,t.resLineHeight=b}const A=b/C;t.distanceRange=C*i.data.distanceField.distanceRange;const L=l.length*Hm;let R=t.vertexBuffer;(!R||R.length<L)&&(R=new Float32Array(L*2));const M=t.elementBounds;if(M.valid||(this.setElementBoundsX(t),this.setElementBoundsY(t),M.valid=!0),!a&&v.valid){const O=v.screen;if(c+O.x1<=M.x1&&c+O.x2>=M.x2&&u-S+O.y1<=M.y1&&u-S+O.y2>=M.y2){this.setStatus(t,"loaded");return}v.valid=!1,this.setStatus(t,"loading")}const{offsetY:F,textAlign:z}=t.props;if(!v.valid){if(!fa(M,this.rendererBounds))return;jm(v,c,u,S,b,d==="both"?M.y2-M.y1:0,M,C)}const G=Vm(E,A,i,p,F,C,v,r,s);if(!G){this.setStatus(t,"loaded");return}const{letterSpacing:k}=t.props,I=Ym(G.lineIndex,G.sdfX,G.sdfY,l,z,f,g,h,b,k,R,d,r,v.sdf,i,a,m,_,T);t.bufferUploaded=!1,t.bufferNumFloats=I.bufferNumFloats,t.bufferNumQuads=I.bufferNumQuads,t.vertexBuffer=R,t.renderWindow=v,o.lastLayoutNumCharacters=I.layoutNumCharacters,o.bufferSize=R.byteLength,I.fullyProcessed&&(t.textW=I.maxX*C,t.textH=I.numLines*A*C),this.setStatus(t,"loaded")}renderQuads(t,i,s,r,o,a){var M,F;if(!t.vertexBuffer)return;const l=this.stage.renderer;X(l instanceof jl);const{fontSize:h,color:c,contain:u,scrollable:d,zIndex:f,debug:g}=t.props,p=u==="both"&&d?t.props.scrollY:0,{textW:m=0,textH:_=0,distanceRange:T,vertexBuffer:S,bufferUploaded:v,trFontFace:E,elementBounds:C}=t;let{webGlBuffers:b}=t;if(!b){const z=l.glw,G=4*Float32Array.BYTES_PER_ELEMENT,k=z.createBuffer();X(k),t.webGlBuffers=new xd([{buffer:k,attributes:{a_position:{name:"a_position",size:2,type:z.FLOAT,normalized:!1,stride:G,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:z.FLOAT,normalized:!1,stride:G,offset:2*Float32Array.BYTES_PER_ELEMENT}}}]),t.bufferUploaded=!1,X(t.webGlBuffers),b=t.webGlBuffers}if(!v){const z=l.glw,G=(b==null?void 0:b.getBuffer("a_textureCoordinate"))??null;z.arrayBufferData(G,S,z.STATIC_DRAW),t.bufferUploaded=!0}if(X(E),d&&u==="both"){X(C.valid);const z=zp(C,qm);s.valid?(t.clippingRect.valid=!0,s=od(s,z,t.clippingRect)):(t.clippingRect.valid=!0,s=ad(z,t.clippingRect))}const A=new _d(l.glw,l.options,b,this.sdfShader,{transform:i.getFloatArr(),color:Op(c,r),size:h/(((M=E.data)==null?void 0:M.info.size)||0),scrollY:p,distanceRange:T,debug:g.sdfShaderDebug},r,s,{height:_,width:m},0,f,!1,o,a),L=(F=t.trFontFace)==null?void 0:F.texture;X(L);const R=L.ctxTexture;A.addTexture(R),A.length=t.bufferNumFloats,A.numQuads=t.bufferNumQuads,l.addRenderOp(A)}setIsRenderable(t,i){var s;super.setIsRenderable(t,i),(s=t.trFontFace)==null||s.texture.setRenderableOwner(t,i)}destroyState(t){var i;super.destroyState(t),(i=t.trFontFace)==null||i.texture.setRenderableOwner(t,!1)}resolveFontFace(t){return this.stage.fontManager.resolveFontFace(this.fontFamilyArray,t,"sdf")}releaseFontFace(t){t.resLineHeight=void 0,t.trFontFace&&(t.trFontFace.texture.setRenderableOwner(t,!1),t.trFontFace=void 0)}invalidateLayoutCache(t){t.renderWindow.valid=!1,t.elementBounds.valid=!1,t.textH=void 0,t.textW=void 0,t.lineCache=[],this.setStatus(t,"loading"),this.scheduleUpdateState(t)}setElementBoundsX(t){const{x:i,contain:s,width:r}=t.props,{elementBounds:o}=t;o.x1=i,o.x2=s!=="none"?i+r:1/0}setElementBoundsY(t){const{y:i,contain:s,height:r}=t.props,{elementBounds:o}=t;o.y1=i,o.y2=s==="both"?i+r:1/0}}function ac(n){return n===""||n==="​"}function Zm(n,e,t){if(e.metrics)return e.metrics;const i=n.measureText("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz");console.warn(`Font metrics not provided for Canvas Web font ${e.fontFamily}. Using fallback values. It is HIGHLY recommended you use the latest version of the Lightning 3 \`msdf-generator\` tool to extract the default metrics for the font and provide them in the Canvas Web font definition.`);let s;return i.actualBoundingBoxDescent&&i.actualBoundingBoxAscent?s={ascender:i.actualBoundingBoxAscent/t,descender:-i.actualBoundingBoxDescent/t,lineGap:.2}:s={ascender:.8,descender:-.2,lineGap:.2},e.metrics=s,s}const lc=2048;function hc(n,e,t,i,s){const r=n!=="bottom"?.5*e:0;return t*(i-1)+r+Math.max(t,e)+(s||0)}class Jm{constructor(e,t){y(this,"_canvas");y(this,"_context");y(this,"_settings");this._canvas=e,this._context=t,this._settings=this.mergeDefaults({})}set settings(e){this._settings=this.mergeDefaults(e)}get settings(){return this._settings}getPrecision(){return this._settings.precision}setFontProperties(){this._context.font=this._getFontSetting(),this._context.textBaseline=this._settings.textBaseline}_getFontSetting(){const e=[this._settings.fontFamily],t=[];for(let i=0,s=e.length;i<s;i++)e[i]==="serif"||e[i]==="sans-serif"?t.push(e[i]):t.push(`"${e[i]}"`);return`${this._settings.fontStyle} ${this._settings.fontSize*this.getPrecision()}px ${t.join(",")}`}_load(){if(document.fonts){const e=this._getFontSetting();try{if(!document.fonts.check(e,this._settings.text))return document.fonts.load(e,this._settings.text).catch(t=>{console.warn("[Lightning] Font load error",t,e)}).then(()=>{document.fonts.check(e,this._settings.text)||console.warn("[Lightning] Font not found",e)})}catch{console.warn("[Lightning] Can't check font loading for "+e)}}}calculateRenderInfo(){const e={},t=this.getPrecision(),i=this._settings.paddingLeft*t,s=this._settings.paddingRight*t,r=this._settings.fontSize*t;let o=this._settings.offsetY===null?null:this._settings.offsetY*t;const a=this._settings.w*t,l=this._settings.h*t;let h=this._settings.wordWrapWidth*t;const c=this._settings.cutSx*t,u=this._settings.cutEx*t,d=this._settings.cutSy*t,f=this._settings.cutEy*t,g=(this._settings.letterSpacing||0)*t,p=this._settings.textIndent*t,m=this._settings.trFontFace;this.setFontProperties(),X(m);const _=Zm(this._context,m,r),T=yd(_,r)*t,S=this._settings.lineHeight!==null?this._settings.lineHeight*t:T,v=this._settings.maxHeight,E=v!==null&&S>0?Math.floor(v/S):0,C=this._settings.maxLines,b=E>0&&C>0?Math.min(E,C):Math.max(E,C);let A=a||2048/this.getPrecision(),L=A-i;if(L<10&&(A+=10-L,L=10),h||(h=L),this._settings.textOverflow&&!this._settings.wordWrap){let k;switch(this._settings.textOverflow){case"clip":k="";break;case"ellipsis":k=this._settings.overflowSuffix;break;default:k=this._settings.textOverflow}this._settings.text=this.wrapWord(this._settings.text,h-p,k)}let R;if(this._settings.wordWrap)R=this.wrapText(this._settings.text,h,g,p);else{R={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]};const k=R.l.length;for(let I=0;I<k-1;I++)R.n.push(I)}let M=R.l;if(b&&M.length>b){const k=M.slice(0,b);let I=null;if(this._settings.overflowSuffix){const Y=this._settings.overflowSuffix?this.measureText(this._settings.overflowSuffix):0,W=this.wrapText(k[k.length-1],h-Y,g,p);k[k.length-1]=`${W.l[0]}${this._settings.overflowSuffix}`,I=[W.l.length>1?W.l[1]:""]}else I=[""];let O;const V=M.length;let B=0;const U=R.n.length;for(O=b;O<V;O++)I[B]+=`${I[B]?" ":""}${M[O]}`,O+1<U&&R.n[O+1]&&B++;e.remainingText=I.join(`
`),e.moreTextLines=!0,M=k}else e.moreTextLines=!1,e.remainingText="";let F=0;const z=[];for(let k=0;k<M.length;k++){const I=this.measureText(M[k],g)+(k===0?p:0);z.push(I),F=Math.max(F,I)}e.lineWidths=z,a||(A=F+i+s,L=F),this._settings.wordWrap&&a>F&&this._settings.textAlign==="left"&&M.length===1&&(A=F+i+s);let G;return l?G=l:G=hc(this._settings.textBaseline,r,S,M.length,o),o===null&&(o=r),e.w=A,e.h=G,e.lines=M,e.precision=t,A||(A=1),G||(G=1),(c||u)&&(A=Math.min(A,u-c)),(d||f)&&(G=Math.min(G,f-d)),e.width=A,e.innerWidth=L,e.height=G,e.fontSize=r,e.cutSx=c,e.cutSy=d,e.cutEx=u,e.cutEy=f,e.lineHeight=S,e.defLineHeight=T,e.lineWidths=z,e.offsetY=o,e.paddingLeft=i,e.paddingRight=s,e.letterSpacing=g,e.textIndent=p,e.metrics=_,e}draw(e,t){const i=this.getPrecision(),s=(t==null?void 0:t.lines)||e.lines,r=(t==null?void 0:t.lineWidths)||e.lineWidths,o=t?hc(this._settings.textBaseline,e.fontSize,e.lineHeight,t.lines.length,this._settings.offsetY===null?null:this._settings.offsetY*i):e.height;this._canvas.width=Math.min(Math.ceil(e.width+this._settings.textRenderIssueMargin),lc),this._canvas.height=Math.min(Math.ceil(o),lc),this.setFontProperties(),e.fontSize>=128&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=1),(e.cutSx||e.cutSy)&&this._context.translate(-e.cutSx,-e.cutSy);let a,l;const h=[],{metrics:c}=e,u=c?c.ascender*e.fontSize:e.fontSize,d=(c.ascender-c.descender)*e.fontSize;for(let g=0,p=s.length;g<p;g++)a=g===0?e.textIndent:0,l=g*e.lineHeight+u,this._settings.verticalAlign=="middle"?l+=(e.lineHeight-d)/2:this._settings.verticalAlign=="bottom"&&(l+=e.lineHeight-d),this._settings.textAlign==="right"?a+=e.innerWidth-r[g]:this._settings.textAlign==="center"&&(a+=(e.innerWidth-r[g])/2),a+=e.paddingLeft,h.push({text:s[g],x:a,y:l,w:r[g]});if(this._settings.highlight){const g=this._settings.highlightColor,p=this._settings.highlightHeight*i||e.fontSize*1.5,m=this._settings.highlightOffset*i,_=this._settings.highlightPaddingLeft!==null?this._settings.highlightPaddingLeft*i:e.paddingLeft,T=this._settings.highlightPaddingRight!==null?this._settings.highlightPaddingRight*i:e.paddingRight;this._context.fillStyle=da(g);for(let S=0;S<h.length;S++){const v=h[S];this._context.fillRect(v.x-_,v.y-e.offsetY+m,v.w+T+_,p)}}let f=null;this._settings.shadow&&(f=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=da(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*i,this._context.shadowOffsetY=this._settings.shadowOffsetY*i,this._context.shadowBlur=this._settings.shadowBlur*i),this._context.fillStyle=da(this._settings.textColor);for(let g=0,p=h.length;g<p;g++){const m=h[g];if(e.letterSpacing===0)this._context.fillText(m.text,m.x,m.y);else{const _=m.text.split("");let T=m.x;for(let S=0,v=_.length;S<v;S++)this._context.fillText(_[S],T,m.y),T+=this.measureText(_[S],e.letterSpacing)}}f&&(this._context.shadowColor=f[0],this._context.shadowOffsetX=f[1],this._context.shadowOffsetY=f[2],this._context.shadowBlur=f[3]),(e.cutSx||e.cutSy)&&this._context.translate(e.cutSx,e.cutSy)}wrapWord(e,t,i){const s=this._context.measureText(i).width,r=e.length,o=this._context.measureText(e).width;if(o<=t)return e;let a=Math.floor(t*r/o),l=this._context.measureText(e.substring(0,a)).width+s;if(l>t)for(;a>0&&(l=this._context.measureText(e.substring(0,a)).width+s,l>t);)a-=1;else for(;a<r;)if(l=this._context.measureText(e.substring(0,a)).width+s,l<t)a+=1;else{a-=1;break}return e.substring(0,a)+(t>=s?i:"")}wrapText(e,t,i,s=0){const r=/ |\u200B/g,o=e.split(/\r?\n/g);let a=[];const l=[];for(let h=0;h<o.length;h++){const c=[];let u="",d=t-s;const f=o[h].split(r),g=o[h].match(r)||[];for(let p=0;p<f.length;p++){const m=g[p-1]||"",_=f[p],T=this.measureText(_,i),S=ac(m)?T:T+this.measureText(m,i);p===0||S>d?(p>0&&(c.push(u),u=""),u+=_,d=t-T-(p===0?s:0)):(d-=S,u+=m+_)}c.push(u),u="",a=a.concat(c),h<o.length-1&&l.push(a.length)}return{l:a,n:l}}measureText(e,t=0){return t?e.split("").reduce((i,s)=>ac(s)?i:i+this._context.measureText(s).width+t,0):this._context.measureText(e).width}mergeDefaults(e){return{text:"",w:0,h:0,fontStyle:"normal",fontSize:40,fontFamily:null,trFontFace:null,wordWrap:!0,wordWrapWidth:0,wordBreak:!1,textOverflow:"",lineHeight:null,textBaseline:"alphabetic",textAlign:"left",verticalAlign:"top",offsetY:null,maxLines:0,maxHeight:null,overflowSuffix:"...",textColor:[1,1,1,1],paddingLeft:0,paddingRight:0,shadow:!1,shadowColor:[0,0,0,1],shadowOffsetX:0,shadowOffsetY:0,shadowBlur:5,highlight:!1,highlightHeight:0,highlightColor:[0,0,0,1],highlightOffset:0,highlightPaddingLeft:0,highlightPaddingRight:0,letterSpacing:0,textIndent:0,cutSx:0,cutEx:0,cutSy:0,cutEy:0,advancedRenderer:!1,fontBaselineRatio:0,precision:1,textRenderIssueMargin:0,...e}}}const cc=typeof self>"u"?globalThis:self;var Ju;const uc=((Ju=cc.document)==null?void 0:Ju.fonts)||cc.fonts;function e0(n){const{fontFamily:e,fontStyle:t,fontWeight:i,fontStretch:s,fontSize:r}=n;return[t,i,s,`${r}px`,e].join(" ")}class dc extends Xl{constructor(t){super(t);y(this,"canvas");y(this,"context");y(this,"fontFamilies",{});y(this,"fontFamilyArray",[this.fontFamilies]);y(this,"type","canvas");y(this,"loadFont",t=>{const i=e0(t.props),s=this.stage.fontManager.resolveFontFace(this.fontFamilyArray,t.props,"canvas");if(X(s,`Could not resolve font face for ${i}`),t.fontInfo={fontFace:s,cssString:i,loaded:!1},!t.fontInfo.loaded){uc.load(i).then(this.onFontLoaded.bind(this,t,i)).catch(this.onFontLoadError.bind(this,t,i));return}});typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(0,0):this.canvas=document.createElement("canvas");let i=this.canvas.getContext("2d",{willReadFrequently:!0});i||(this.canvas=document.createElement("canvas"),i=this.canvas.getContext("2d",{willReadFrequently:!0})),X(i),this.context=i,this.addFontFace(new Yn({fontFamily:"sans-serif",descriptors:{},fontUrl:""}))}getPropertySetters(){return{fontFamily:(t,i)=>{t.props.fontFamily=i,t.fontInfo=void 0,this.invalidateLayoutCache(t)},fontWeight:(t,i)=>{t.props.fontWeight=i,t.fontInfo=void 0,this.invalidateLayoutCache(t)},fontStyle:(t,i)=>{t.props.fontStyle=i,t.fontInfo=void 0,this.invalidateLayoutCache(t)},fontStretch:(t,i)=>{t.props.fontStretch=i,t.fontInfo=void 0,this.invalidateLayoutCache(t)},fontSize:(t,i)=>{t.props.fontSize=i,t.fontInfo=void 0,this.invalidateLayoutCache(t)},text:(t,i)=>{t.props.text=i,this.invalidateLayoutCache(t)},textAlign:(t,i)=>{t.props.textAlign=i,this.invalidateLayoutCache(t)},color:(t,i)=>{t.props.color=i,this.invalidateLayoutCache(t)},x:(t,i)=>{t.props.x=i},y:(t,i)=>{t.props.y=i},contain:(t,i)=>{t.props.contain=i,this.invalidateLayoutCache(t)},width:(t,i)=>{t.props.width=i,t.props.contain!=="none"&&this.invalidateLayoutCache(t)},height:(t,i)=>{t.props.height=i,t.props.contain==="both"&&this.invalidateLayoutCache(t)},offsetY:(t,i)=>{t.props.offsetY=i,this.invalidateLayoutCache(t)},scrollY:(t,i)=>{t.props.scrollY=i},letterSpacing:(t,i)=>{t.props.letterSpacing=i,this.invalidateLayoutCache(t)},lineHeight:(t,i)=>{t.props.lineHeight=i,this.invalidateLayoutCache(t)},maxLines:(t,i)=>{t.props.maxLines=i,this.invalidateLayoutCache(t)},textBaseline:(t,i)=>{t.props.textBaseline=i,this.invalidateLayoutCache(t)},verticalAlign:(t,i)=>{t.props.verticalAlign=i,this.invalidateLayoutCache(t)},overflowSuffix:(t,i)=>{t.props.overflowSuffix=i,this.invalidateLayoutCache(t)}}}canRenderFont(t){return!0}isFontFaceSupported(t){return t instanceof Yn}addFontFace(t){X(t instanceof Yn);const i=t.fontFamily;i!=="sans-serif"&&uc.add(t.fontFace);let s=this.fontFamilies[i];s||(s=new Set,this.fontFamilies[i]=s),s.add(t)}createState(t,i){return{node:i,props:t,status:"initialState",updateScheduled:!1,emitter:new li,textureNode:void 0,lightning2TextRenderer:new Jm(this.canvas,this.context),renderInfo:void 0,forceFullLayoutCalc:!1,textW:0,textH:0,fontInfo:void 0,isRenderable:!1,debugData:{updateCount:0,layoutCount:0,drawCount:0,lastLayoutNumCharacters:0,layoutSum:0,drawSum:0,bufferSize:0}}}updateState(t){if(t.status==="initialState"&&this.setStatus(t,"loading"),t.status!=="loaded"){if(!t.fontInfo)return this.loadFont(t);t.fontInfo.loaded&&(t.renderInfo||(t.renderInfo=this.calculateRenderInfo(t),t.textH=t.renderInfo.lineHeight*t.renderInfo.lines.length,t.textW=t.renderInfo.width,this.renderSingleCanvasPage(t)))}}renderSingleCanvasPage(t){X(t.renderInfo);const i=t.node,s=this.stage.txManager.createTexture("ImageTexture",{premultiplyAlpha:!0,src:(function(r,o){return X(o),r.draw(o,{lines:o.lines,lineWidths:o.lineWidths}),this.canvas.width===0||this.canvas.height===0?null:this.context.getImageData(0,0,this.canvas.width,this.canvas.height)}).bind(this,t.lightning2TextRenderer,t.renderInfo)});if(t.textureNode)t.textureNode.texture=s,t.textureNode.alpha=ec(t.props.color);else{const r=this.stage.createNode({parent:i,texture:s,autosize:!0,alpha:ec(t.props.color)});t.textureNode=r}this.setStatus(t,"loaded")}calculateRenderInfo(t){var i;return t.lightning2TextRenderer.settings={text:t.props.text,textAlign:t.props.textAlign,fontFamily:t.props.fontFamily,trFontFace:(i=t.fontInfo)==null?void 0:i.fontFace,fontSize:t.props.fontSize,fontStyle:[t.props.fontStretch,t.props.fontStyle,t.props.fontWeight].join(" "),textColor:Nr(t.props.color),offsetY:t.props.offsetY,wordWrap:t.props.contain!=="none",wordWrapWidth:t.props.contain==="none"?void 0:t.props.width,letterSpacing:t.props.letterSpacing,lineHeight:t.props.lineHeight??null,maxLines:t.props.maxLines,maxHeight:t.props.contain==="both"?t.props.height-t.props.offsetY:null,textBaseline:t.props.textBaseline,verticalAlign:t.props.verticalAlign,overflowSuffix:t.props.overflowSuffix,w:t.props.contain!=="none"?t.props.width:void 0},t.renderInfo=t.lightning2TextRenderer.calculateRenderInfo(),t.renderInfo}renderQuads(){}destroyState(t){t.status!=="destroyed"&&(super.destroyState(t),t.textureNode&&(t.textureNode.destroy(),delete t.textureNode),delete t.renderInfo)}invalidateLayoutCache(t){t.renderInfo=void 0,this.setStatus(t,"loading"),this.scheduleUpdateState(t)}onFontLoaded(t,i){var s;i!==((s=t.fontInfo)==null?void 0:s.cssString)||!t.fontInfo||(t.fontInfo.loaded=!0,this.scheduleUpdateState(t))}onFontLoadError(t,i,s){var r;i!==((r=t.fontInfo)==null?void 0:r.cssString)||!t.fontInfo||(t.fontInfo.loaded=!0,console.error(`CanvasTextRenderer: Error loading font '${t.fontInfo.cssString}'`,s),this.scheduleUpdateState(t))}}const Td={isWhite:!0,a:1,r:255,g:255,b:255};function xa(n){if(n===4294967295)return Td;const e=(n>>>24&255)/255,t=n>>>16&255&255,i=n>>>8&255&255,s=n&255&255;return{isWhite:!1,a:e,r:s,g:i,b:t}}function Sd(n){if(n===4294967295)return Td;const e=n>>>24&255,t=n>>>16&255&255,i=n>>>8&255&255,s=(n&255&255)/255;return{isWhite:!1,r:e,g:t,b:i,a:s}}function Bs({a:n,r:e,g:t,b:i}){return`rgba(${e},${t},${i},${n})`}class t0 extends gd{constructor(){super(...arguments);y(this,"image");y(this,"tintCache")}load(){this.textureSource.setState("loading"),this.onLoadRequest().then(t=>{this.textureSource.setState("loaded",t),this.textureSource.freeTextureData(),this.updateMemSize()}).catch(t=>{this.textureSource.setState("failed",t),this.textureSource.freeTextureData()})}free(){this.image=void 0,this.tintCache=void 0,this.textureSource.setState("freed"),this.setTextureMemUse(0),this.textureSource.freeTextureData()}updateMemSize(){const t=this.tintCache?8:4;if(this.textureSource.dimensions){const{width:i,height:s}=this.textureSource.dimensions;this.setTextureMemUse(i*s*t)}}hasImage(){return this.image!==void 0}getImage(t){var o;const i=this.image;if(X(i,"Attempt to get unloaded image texture"),t.isWhite)return this.tintCache&&(this.tintCache=void 0,this.updateMemSize()),i;const s=Bs(t);if(((o=this.tintCache)==null?void 0:o.key)===s)return this.tintCache.image;const r=this.tintTexture(i,s);return this.tintCache={key:s,image:r},this.updateMemSize(),r}tintTexture(t,i){const{width:s,height:r}=t,o=document.createElement("canvas");o.width=s,o.height=r;const a=o.getContext("2d");return a&&(a.fillStyle=i,a.globalCompositeOperation="copy",a.fillRect(0,0,s,r),a.globalCompositeOperation="multiply",a.drawImage(t,0,0,s,r,0,0,s,r),a.globalCompositeOperation="destination-in",a.drawImage(t,0,0,s,r,0,0,s,r)),o}async onLoadRequest(){var i,s;X((s=(i=this.textureSource)==null?void 0:i.textureData)==null?void 0:s.data,"Texture data is null");const{data:t}=this.textureSource.textureData;if(t instanceof ImageData){const r=document.createElement("canvas");r.width=t.width,r.height=t.height;const o=r.getContext("2d");return o&&o.putImageData(t,0,0),this.image=r,{width:t.width,height:t.height}}else if(typeof ImageBitmap<"u"&&t instanceof ImageBitmap||t instanceof HTMLImageElement)return this.image=t,{width:t.width,height:t.height};return{width:0,height:0}}}function i0(n){var e,t;if(n.shader instanceof Ko){const i=n.shader.shType;if(i===ym)return((e=n.shaderProps)==null?void 0:e.radius)??0;if(i==="DynamicShader"){const s=(t=n.shaderProps)==null?void 0:t.effects;if(s){const r=s.find(o=>{var a;return o.type==="radius"&&((a=o==null?void 0:o.props)==null?void 0:a.radius)});return r&&r.type==="radius"&&r.props.radius||0}}}return 0}function nr(n,e=""){var t;if(n.shader instanceof Ko&&n.shader.shType==="DynamicShader"){const s=(t=n.shaderProps)==null?void 0:t.effects;if(s&&s.length){const r=s.find(o=>o.type===`border${e}`&&o.props&&o.props.width);return r&&r.props}}}function fc(n,e,t,i,s){if(Object.getPrototypeOf(this).roundRect)this.roundRect(n,e,t,i,s);else{const o=l=>{const h=Math.min(t/2,i/2),c=l.topLeft+l.topRight+l.bottomRight+l.bottomLeft;if(c>t||c>i){const u=h/Math.max(l.topLeft,l.topRight,l.bottomRight,l.bottomLeft);l.topLeft*=u,l.topRight*=u,l.bottomRight*=u,l.bottomLeft*=u}},a=typeof s=="number"?{topLeft:s,topRight:s,bottomRight:s,bottomLeft:s}:{topLeft:0,topRight:0,bottomRight:0,bottomLeft:0,...s};o(a),this.moveTo(n+a.topLeft,e),this.lineTo(n+t-a.topRight,e),this.ellipse(n+t-a.topRight,e+a.topRight,a.topRight,a.topRight,0,1.5*Math.PI,2*Math.PI),this.lineTo(n+t,e+i-a.bottomRight),this.ellipse(n+t-a.bottomRight,e+i-a.bottomRight,a.bottomRight,a.bottomRight,0,0,.5*Math.PI),this.lineTo(n+a.bottomLeft,e+i),this.ellipse(n+a.bottomLeft,e+i-a.bottomLeft,a.bottomLeft,a.bottomLeft,0,.5*Math.PI,Math.PI),this.lineTo(n,e+a.topLeft),this.ellipse(n+a.topLeft,e+a.topLeft,a.topLeft,a.topLeft,0,Math.PI,1.5*Math.PI)}}function yn(n,e,t,i,s,r=0,o,a){if(!r)return;let l,h=0,c,u=0;switch(a){case"Top":l=e,h=t,c=i+e,u=t;break;case"Right":l=e+i,h=t,c=e+i,u=t+s;break;case"Bottom":l=e,h=t+s,c=e+i,u=t+s;break;case"Left":l=e,h=t,c=e,u=t+s;break}n.beginPath(),n.lineWidth=r,n.strokeStyle=Bs(Sd(o??0)),n.moveTo(l,h),n.lineTo(c,u),n.stroke()}class s0 extends pd{constructor(t){super(t);y(this,"context");y(this,"canvas");y(this,"pixelRatio");y(this,"clearColor");y(this,"renderToTextureActive",!1);y(this,"activeRttNode",null);y(this,"defShaderCtr");this.mode="canvas",this.shManager.renderer=this;const{canvas:i,pixelRatio:s,clearColor:r}=t;this.canvas=i,this.context=i.getContext("2d"),this.pixelRatio=s,this.clearColor=r?Jh(r):void 0,this.defShaderCtr={type:"DefaultShader",props:{},shader:new Ko("DefaultShader"),getResolvedProps:()=>()=>({})}}reset(){this.canvas.width=this.canvas.width;const t=this.context;if(this.clearColor){const[i,s,r,o]=this.clearColor;t.fillStyle=`rgba(${i}, ${s}, ${r}, ${o/255})`,t.fillRect(0,0,this.canvas.width,this.canvas.height)}t.scale(this.pixelRatio,this.pixelRatio)}render(){}addQuad(t){const i=this.context,{tx:s,ty:r,width:o,height:a,alpha:l,colorTl:h,colorTr:c,colorBr:u,ta:d,tb:f,tc:g,td:p,clippingRect:m}=t;let _=t.texture,T,S;const v=_==null?void 0:_.type;if(X(v,"Texture type is not defined"),v!==Ae.image&&v!==Ae.color&&v!==Ae.subTexture&&v!==Ae.noise||_&&(_ instanceof Rr&&(S=_.props,_=_.parentTexture),T=_.ctxTexture,_.state==="freed"||_.state!=="loaded"))return;const E=xa(h),C=d!==1,b=m.width!==0&&m.height!==0,A=h!==c||h!==u,L=!!t.shader,R=L?i0(t):0,M=L?nr(t):void 0;if((C||b||R)&&i.save(),b){const F=new Path2D,{x:z,y:G,width:k,height:I}=m;F.rect(z,G,k,I),i.clip(F)}if(C){const F=this.pixelRatio;i.setTransform(d,g,f,p,s*F,r*F),i.scale(F,F),i.translate(-s,-r)}if(R){const F=new Path2D;fc.call(F,s,r,o,a,R),i.clip(F)}if((v===Ae.image||v===Ae.subTexture||v===Ae.noise)&&T){const F=T.getImage(E);if(i.globalAlpha=E.a??l,S)i.drawImage(F,S.x,S.y,S.width,S.height,s,r,o,a);else try{i.drawImage(F,s,r,o,a)}catch{}i.globalAlpha=1}else if(v===Ae.color&&A){let F=s,z=r,G;h===c?(F=s,z=r+a,G=xa(u)):(F=s+o,z=r,G=xa(c));const k=i.createLinearGradient(s,r,F,z);k.addColorStop(0,Bs(E)),k.addColorStop(1,Bs(G)),i.fillStyle=k,i.fillRect(s,r,o,a)}else v===Ae.color&&(i.fillStyle=Bs(E),i.fillRect(s,r,o,a));if(M&&M.width){const F=M.width,z=M.width/2,G=Bs(Sd(M.color??0));i.beginPath(),i.lineWidth=F,i.strokeStyle=G,i.globalAlpha=l,R?(fc.call(i,s+z,r+z,o-F,a-F,R),i.stroke()):i.strokeRect(s+z,r+z,o-F,a-F),i.globalAlpha=1}else if(L){const F=nr(t,"Top"),z=nr(t,"Right"),G=nr(t,"Bottom"),k=nr(t,"Left");F&&yn(i,s,r,o,a,F.width,F.color,"Top"),z&&yn(i,s,r,o,a,z.width,z.color,"Right"),G&&yn(i,s,r,o,a,G.width,G.color,"Bottom"),k&&yn(i,s,r,o,a,k.width,k.color,"Left")}(C||b||R)&&i.restore()}createCtxTexture(t){return new t0(this.txMemManager,t)}getShaderManager(){return this.shManager}getDefShaderCtr(){return this.defShaderCtr}renderRTTNodes(){}removeRTTNode(t){}renderToTexture(t){}getBufferInfo(){return null}getQuadCount(){return null}updateClearColor(t){this.clearColor=t?Jh(t):void 0}}const ur={alpha:n=>n===1?null:{prop:"opacity",value:`${n}`},x:n=>({prop:"left",value:`${n}px`}),y:n=>({prop:"top",value:`${n}px`}),width:n=>n===0?null:{prop:"width",value:`${n}px`},height:n=>n===0?null:{prop:"height",value:`${n}px`},fontSize:n=>n===0?null:{prop:"font-size",value:`${n}px`},lineHeight:n=>n===0?null:{prop:"line-height",value:`${n}px`},zIndex:()=>"z-index",fontFamily:()=>"font-family",fontStyle:()=>"font-style",fontWeight:()=>"font-weight",fontStretch:()=>"font-stretch",letterSpacing:()=>"letter-spacing",textAlign:()=>"text-align",overflowSuffix:()=>"overflow-suffix",maxLines:()=>"max-lines",contain:()=>"contain",verticalAlign:()=>"vertical-align",clipping:n=>n===!1?null:{prop:"overflow",value:n?"hidden":"visible"},rotation:n=>n===0?null:{prop:"transform",value:`rotate(${n}rad)`},scale:n=>n===1?null:{prop:"transform",value:`scale(${n})`},scaleX:n=>n===1?null:{prop:"transform",value:`scaleX(${n})`},scaleY:n=>n===1?null:{prop:"transform",value:`scaleY(${n})`},color:n=>n===0?null:{prop:"color",value:vd(n)}},vd=n=>{const e=(n&255)/255,t=n>>8&255,i=n>>16&255;return`rgba(${n>>24&255},${i},${t},${e})`},hl={id:"test-id"},r0=new Set([...Object.keys(ur),...Object.keys(hl),"src","parent","data"]);class n0{constructor(e,t){y(this,"root",null);y(this,"canvas",null);y(this,"height",1080);y(this,"width",1920);y(this,"scaleX",1);y(this,"scaleY",1);if(qs())return;if(!t)throw new Error("settings is required");this.height=Math.ceil(t.appHeight??1080/(t.deviceLogicalPixelRatio??1)),this.width=Math.ceil(t.appWidth??1920/(t.deviceLogicalPixelRatio??1)),this.scaleX=t.deviceLogicalPixelRatio??1,this.scaleY=t.deviceLogicalPixelRatio??1,this.canvas=e,this.root=document.createElement("div"),this.setRootPosition(),document.body.appendChild(this.root),new MutationObserver(this.setRootPosition.bind(this)).observe(e,{attributes:!0,childList:!1,subtree:!1}),new ResizeObserver(this.setRootPosition.bind(this)).observe(e),window.addEventListener("resize",this.setRootPosition.bind(this)),console.warn("Inspector is enabled, this will impact performance")}setRootPosition(){if(this.root===null||this.canvas===null)return;const e=this.canvas.getBoundingClientRect(),t=document.documentElement.scrollTop+e.top,i=document.documentElement.scrollLeft+e.left;this.root.id="root",this.root.style.left=`${i}px`,this.root.style.top=`${t}px`,this.root.style.width=`${this.width}px`,this.root.style.height=`${this.height}px`,this.root.style.position="absolute",this.root.style.transformOrigin="0 0 0",this.root.style.transform=`scale(${this.scaleX}, ${this.scaleY})`,this.root.style.overflow="hidden",this.root.style.zIndex="65534"}createDiv(e,t){const i=document.createElement("div");i.style.position="absolute",i.id=e.toString();for(const s in t)this.updateNodeProperty(i,s,t[s],t);return i}createNode(e){const t=this.createDiv(e.id,e.props);return t.node=e,e.div=t,e.on("inViewport",()=>t.setAttribute("state","inViewport")),e.on("inBounds",()=>t.setAttribute("state","inBounds")),e.on("outOfBounds",()=>t.setAttribute("state","outOfBounds")),this.createProxy(e,t)}createTextNode(e){const t=this.createDiv(e.id,e.props);return t.node=e,e.div=t,this.createProxy(e,t)}createProxy(e,t){r0.forEach(r=>{let o=Object.getOwnPropertyDescriptor(e,r);if(o===void 0){const a=Object.getPrototypeOf(e);o=Object.getOwnPropertyDescriptor(a,r)}o!==void 0&&Object.defineProperty(e,r,{get(){var a;return(a=o==null?void 0:o.get)==null?void 0:a.call(e)},set:a=>{var l;(l=o==null?void 0:o.set)==null||l.call(e,a),this.updateNodeProperty(t,r,a,e.props)},configurable:!0,enumerable:!0})});const i=e.destroy;Object.defineProperty(e,"destroy",{value:()=>{this.destroyNode(e.id),i.call(e)}});const s=e.animate;return Object.defineProperty(e,"animate",{value:(r,o)=>{const a=s.call(e,r,o),l=a.start.bind(a);return a.start=()=>(this.animateNode(t,r,o),l()),a}}),e}destroyNode(e){const t=document.getElementById(e.toString());t==null||t.remove()}updateNodeProperty(e,t,i,s){var r;if(!(this.root===null||i===void 0||i===null)){if(t==="parent"){const o=i.id;if(o===1){this.root.appendChild(e);return}const a=document.getElementById(o.toString());a==null||a.appendChild(e);return}if(t==="text"){e.innerHTML=String(i),e.style.visibility="hidden";return}if(t==="src"&&i){e.setAttribute("data-src",String(i));return}if(t==="rtt"&&i){e.setAttribute("data-rtt",String(i));return}if(ur[t]){const o=(r=ur[t])==null?void 0:r.call(ur,i);if(o===null)return;if(typeof o=="string"){e.style.setProperty(o,String(i));return}if(typeof o=="object"){let a=o.value;if(t==="x"){const l=s.mountX,h=s.width;l&&(a=`${parseInt(a)-h*l}px`)}else if(t==="y"){const l=s.mountY,h=s.height;l&&(a=`${parseInt(a)-h*l}px`)}e.style.setProperty(o.prop,a)}return}if(hl[t]){const o=hl[t];if(!o)return;e.setAttribute(String(o),String(i));return}if(t==="data"){for(const o in i){const a=i[o];a===void 0?e.removeAttribute(`data-${o}`):e.setAttribute(`data-${o}`,String(a))}return}}}animateNode(e,t,i){const{duration:s=1e3,delay:r=0}=i,{x:o,y:a,width:l,height:h,alpha:c=1,rotation:u=0,scale:d=1,color:f,mountX:g,mountY:p}=t;function m(){setTimeout(()=>{e.style.top=`${a-h*p}px`,e.style.left=`${o-l*g}px`,e.style.width=`${l}px`,e.style.height=`${h}px`,e.style.opacity=`${c}`,e.style.rotate=`${u}rad`,e.style.scale=`${d}`,e.style.color=vd(f)},s)}setTimeout(m,r)}}const Ed=50,gc={hd:.66666667,"720p":.66666667,720:.66666667,fhd:1,fullhd:1,"1080p":1,1080:1,"4k":2,"2160p":2,2160:2},o0={low:.66666667,medium:.85,high:1,retina:2},a0=()=>{const n=vt.stage;gt.get("fonts",[]).forEach(e=>{e.type==="sdf"||e.type==="msdf"?(!e.png&&e.file&&(e.png=e.file.replace(/\.[^.]+$/,`.${e.type}.png`)),!e.json&&e.file&&(e.json=e.file.replace(/\.[^.]+$/,`.${e.type}.json`)),n.fontManager.addFontFace(new ll(e.type,{fontFamily:e.family,descriptors:{},atlasUrl:e.png,atlasDataUrl:e.json,stage:n,metrics:e.metrics}))):e.type==="web"&&n.fontManager.addFontFace(new Yn({fontFamily:e.family,fontUrl:e.file,descriptors:{},metrics:e.metrics}))})},l0=()=>{const n=vt.stage;gt.get("shaders",[]).forEach(e=>{n.shManager.registerShaderType(e.name,e.type)}),gt.get("effects",[]).forEach(e=>{n.shManager.registerShaderType(e.name,e.type)})};let vt=null;const h0=n=>{const e="renderMode"in n?n.renderMode:"webgl";if(e==="webgl")return jl;if(e==="canvas")return s0},c0=n=>{const e="renderMode"in n?n.renderMode:"webgl";if(e==="webgl")return[Qm,dc];if(e==="canvas")return[dc]},u0=n=>{const e={max:200,target:.8,cleanupInterval:5e3,baseline:25,strict:!1,..."gpuMemory"in n?n.gpuMemory:{}};return{criticalThreshold:e.max*1024*1024,targetThresholdLevel:e.target,cleanupInterval:e.cleanupInterval,baselineMemoryAllocation:e.baseline*1024*1024,doNotExceedCriticalThreshold:e.strict}},d0=(n,e,t={})=>{vt=new Im({appWidth:t.w||1920,appHeight:t.h||1080,fpsUpdateInterval:t.fpsInterval||1e3,devicePhysicalPixelRatio:o0[t.renderQuality]||t.renderQuality||1,deviceLogicalPixelRatio:t.pixelRatio||gc[t.screenResolution]||gc[window.innerHeight]||1,numImageWorkers:"webWorkersLimit"in t?t.webWorkersLimit:window.navigator.hardwareConcurrency||2,clearColor:t.canvasColor&&zs.normalize(t.canvasColor)||0,inspector:t.inspector===!0?n0:void 0,boundsMargin:t.viewportMargin||0,renderEngine:h0(t),fontEngines:c0(t),canvas:t.canvas,textureProcessingTimeLimit:t.textureProcessingTimeLimit,textureMemory:u0(t),createImageBitmapSupport:"auto",...t.advanced||{}},e);const i=()=>{let s=n();s.quit=()=>{ve.info("Closing App"),s.destroy(),s=null,vt=null}};return l0(),a0(),i(),vt};let f0=0;const g0=(n,e)=>{if(n===void 0)return{start:0,end:0,oppositeStart:0,oppositeEnd:0};if(typeof n=="number")return{start:n,end:n,oppositeStart:n,oppositeEnd:n};if(Ci(n)===!0&&(n=Li(n)),typeof n=="object"){const{top:t=void 0,right:i=void 0,bottom:s=void 0,left:r=void 0,x:o=0,y:a=0}=n;return e==="vertical"?{start:t!==void 0?t:a,end:s!==void 0?s:a,oppositeStart:r!==void 0?r:o,oppositeEnd:i!==void 0?i:o}:{start:r!==void 0?r:o,end:i!==void 0?i:o,oppositeStart:t!==void 0?t:a,oppositeEnd:s!==void 0?s:a}}return{start:0,end:0,oppositeStart:0,oppositeEnd:0}},p0=function(n){const e=n.direction==="vertical"?"y":"x",t=n.direction==="vertical"?"x":"y",i=n.direction==="vertical"?"mountX":"mountY",s=n.direction==="vertical"?"height":"width",r=n.direction==="vertical"?"width":"height",o=g0(n.padding,n.direction);let a=o.start;const l=this.node.children,h=l.length;let c=0;const u=n.gap||0;for(let f=0;f<h;f++){if(this.children[f]!==void 0&&this.children[f].props.raw.show===!1)continue;const g=l[f];g[e]=a,g[t]=o.oppositeStart,s==="width"?a+=g.width+(g.width!==("text"in g?1:0)?u:0):a+="text"in g?g.width>1?g.height+u:0:g.height!==0?g.height+u:0,c=Math.max(c,g[r]+o.oppositeStart+o.oppositeEnd)}this.node[s]=a-u+o.end,this.node[r]=c;const d={start:0,end:1,center:.5}[n["align-items"]||"start"];if(d!==0)for(let f=0;f<h;f++){const g=l[f];g[t]=c*d,g[i]=d}n["@updated"]!==void 0&&n["@updated"]({w:this.node.width,h:this.node.height},this),this.config.parent&&this.config.parent.props.__layout===!0&&this.config.parent.triggerLayout(this.config.parent.props)},pc=n=>n!==null&&typeof n=="object"&&"transition"in n,Ci=n=>typeof n=="string"&&n.startsWith("{")&&n.endsWith("}"),Li=n=>JSON.parse(n.replace(/'/g,'"').replace(/([\w-_]+)\s*:/g,'"$1":')),_s=function(n,e){return typeof n!="string"?n:n.indexOf("%")===n.length-1?this.element.config.parent&&(this.element.config.parent.node[e]||0)*(parseFloat(n)/100)||0:n},cl=n=>{if(typeof n!="object"||n===null)return n;if(n.constructor===Object){if("value"in n)return n.value;if("transition"in n)return cl(n.transition)}return n},m0={top:"colorTop",bottom:"colorBottom",left:"colorLeft",right:"colorRight"};let ul=null;const _0={set parent(n){this.props.parent=n==="root"?vt.root:n.node},set rotation(n){this.props.rotation=n*(Math.PI/180)},set w(n){this.props.width=_s.call(this,n,"width")},set width(n){this.props.width=_s.call(this,n,"width")},set h(n){this.props.height=_s.call(this,n,"height")},set height(n){this.props.height=_s.call(this,n,"height")},set x(n){this.props.x=_s.call(this,n,"width")},set y(n){this.props.y=_s.call(this,n,"height")},set z(n){this.props.zIndex=n},set zIndex(n){this.props.zIndex=n},set color(n){typeof n=="string"&&n.startsWith("{")===!1?this.props.color=zs.normalize(n):(typeof n=="object"||Ci(n)===!0&&(n=Li(n)))&&(this.props.color=0,Object.entries(n).forEach(e=>{this.props[m0[e[0]]]=zs.normalize(e[1])}))},set src(n){this.props.src=n,this.raw.color===void 0&&(this.props.color=this.props.src?4294967295:0),!("w"in this.raw)&&!("w"in this.raw)&&!("h"in this.raw)&&!("height"in this.raw)&&(this.props.autosize=!0)},set texture(n){this.props.texture=n,this.raw.color===void 0&&n==null?this.props.color=0:this.raw.color===void 0&&(this.props.color=4294967295)},set fit(n){const e={};if(n==="cover"||n==="contain"){this.props.textureOptions={resizeMode:{type:n}};return}(typeof n=="object"||Ci(n)===!0&&(n=Li(n)))&&(e.type=n.type||"cover",typeof n.position=="number"&&(e.clipY=e.clipX=n.position),typeof n.position=="object"&&(e.clipX="x"in n.position?n.position.x:null,e.clipY="y"in n.position?n.position.y:null),this.props.textureOptions={resizeMode:e})},set rtt(n){this.props.rtt=n,this.raw.color===void 0&&(this.props.color=n===!0?4294967295:0)},set mount(n){typeof n=="object"||Ci(n)===!0&&(n=Li(n))?("x"in n&&(this.props.mountX=n.x),"y"in n&&(this.props.mountY=n.y)):(this.props.mountX=n,this.props.mountY=n)},set pivot(n){typeof n=="object"||Ci(n)===!0&&(n=Li(n))?("x"in n&&(this.props.pivotX=n.x),"y"in n&&(this.props.pivotY=n.y)):(this.props.pivotX=n,this.props.pivotY=n)},set scale(n){typeof n=="object"||Ci(n)===!0&&(n=Li(n))?("x"in n&&(this.props.scaleX=n.x),"y"in n&&(this.props.scaleY=n.y)):this.props.scale=n},set show(n){n?this.props.alpha=this.raw.alpha!==void 0?this.raw.alpha:1:this.props.alpha=0},set alpha(n){(this.raw.show===void 0||this.raw.show==!0)&&(this.props.alpha=n)},set shader(n){n!==null?this.props.shader=vt.createShader(n.type,n.props):this.props.shader=vt.createShader("DefaultShader")},set effects(n){for(let e=0;e<n.length;e++)n[e].props&&n[e].props.color&&(n[e].props.color=zs.normalize(n[e].props.color));this.element.node===void 0&&(this.props.shader=vt.createShader("DynamicShader",{effects:n.map(e=>vt.createEffect(e.type,e.props))}))},set clipping(n){this.props.clipping=n},set overflow(n){this.props.clipping=!n},set font(n){this.props.fontFamily=n},set size(n){this.props.fontSize=n},set wordwrap(n){ve.warn("The wordwrap attribute is deprecated, use maxwidth instead"),this.props.width=n,this.props.contain="width"},set maxwidth(n){this.props.width=n,this.props.contain="width"},set maxheight(n){this.props.height=n,this.props.contain="both"},set contain(n){this.props.contain=n},set maxlines(n){this.props.maxLines=n},set textoverflow(n){this.props.overflowSuffix=n===!1?" ":n===!0?void 0:n},set letterspacing(n){this.props.letterSpacing=n||1},set lineheight(n){this.props.lineHeight=n},set align(n){this.props.textAlign=n},set content(n){this.props.text=""+n},set placement(n){let e,t;typeof n=="object"||Ci(n)===!0&&(n=Li(n))?("x"in n&&(e=n.x),"y"in n&&(t=n.y)):n==="center"||n==="right"?e=n:t=n,e==="center"?(this.x="50%",this.props.mountX=.5):e==="right"&&(this.x="100%",this.props.mountX=1),t==="middle"?(this.y="50%",this.props.mountY=.5):t==="bottom"&&(this.y="100%",this.props.mountY=1)},set"inspector-data"(n){(typeof n=="object"||Ci(n)===!0&&(n=Li(n)))&&(this.props.data=n)}},x0={populate(n){const e=n;e.node=this.config.node,e[w.isSlot]===!0&&(this[w.isSlot]=!0),this.props.element=this,this.props.parent=e.parent||this.config.parent,delete e.parent,this.props.raw=n;const t=Object.keys(e),i=t.length;for(let s=0;s<i;s++){const r=t[s],o=e[r];o!==void 0&&(this.props[r]=cl(o))}this.props.props.color===void 0&&!("__textnode"in e)&&(this.props.props.color=0),this.node=e.__textnode?vt.createTextNode({...ul,...this.props.props}):vt.createNode(this.props.props),e["@loaded"]!==void 0&&typeof e["@loaded"]=="function"&&this.node.on("loaded",(s,{type:r,dimensions:o})=>{e["@loaded"]({w:o.width,h:o.height,type:r},this)}),e["@error"]!==void 0&&typeof e["@error"]=="function"&&this.node.on("failed",(s,r)=>{e["@error"](r,this)}),e.__layout===!0&&(this.triggerLayout=p0.bind(this)),this.config.parent.props!==void 0&&this.config.parent.props.__layout===!0&&(this.config.parent.triggerLayout(this.config.parent.props),this.node.on("loaded",()=>{this.config.parent.triggerLayout(this.config.parent.props)}))},set(n,e){if(e===void 0||this.props.raw[n]===e)return;this.props.raw[n]=e,this.props.props={},this.props[n]=cl(e);const t=Object.keys(this.props.props);if(t.length===1){if(pc(e)===!0)return this.animate(t[0],this.props.props[t[0]],e.transition);this.node[t[0]]=this.props.props[t[0]]}else for(let i=0;i<t.length;i++){if(pc(e)===!0)return this.animate(t[i],this.props.props[t[i]],e.transition);this.node[t[i]]=this.props.props[t[i]]}this.config.parent.props&&this.config.parent.props.__layout===!0&&this.config.parent.triggerLayout(this.config.parent.props)},animate(n,e,t){if(this.scheduledTransitions[n]!==void 0&&this.scheduledTransitions[n].f.state==="scheduled"&&this.scheduledTransitions[n].f.stop(),this.node[n]===e)return;const i={};i[n]=e;const s=this.node.animate(i,{duration:typeof t=="object"&&"duration"in t?t.duration:300,easing:typeof t=="object"&&"easing"in t?t.easing:"ease",delay:typeof t=="object"&&"delay"in t?t.delay:0}),r=this.node[n];if(this.scheduledTransitions[n]={v:i[n],f:s},t.start!==void 0&&typeof t.start=="function"&&s.once("animating",()=>{t.start.call(this.component,this,n,r)}),this.config.parent.props&&this.config.parent.props.__layout===!0&&s.on("tick",()=>{this.config.parent.triggerLayout(this.config.parent.props)}),t.progress!==void 0&&typeof t.progress=="function"){let o=0;s.on("tick",(a,{progress:l})=>{t.progress.call(this.component,this,n,l,o),o=l})}s.once("stopped",()=>{this.scheduledTransitions[n]!==void 0&&this.scheduledTransitions[n].canceled===!0||(this.node!==void 0&&t.end&&typeof t.end=="function"&&t.end.call(this.component,this,n,this.node[n]),delete this.scheduledTransitions[n])}),s.start()},destroy(){if(this.node===null)return;ve.debug("Deleting Node",this.nodeId);const n=Object.keys(this.scheduledTransitions);for(let e=0;e<n.length;e++){const t=this.scheduledTransitions[n[e]];t!==void 0&&(t.canceled=!0,t.f!==void 0&&t.f.stop())}this.scheduledTransitions={},this.component=null,delete this.component,this.config=null,delete this.config,this.counter=null,delete this.counter,this.props.raw={},this.props.element=null,this.props.props=null,this.props={},delete this.props,this.triggerLayout=null,delete this.triggerLayout,this.forComponent=null,delete this.forComponent,this.node.destroy(),this.node=null},get nodeId(){return this.node&&this.node.id},get ref(){return this.props.ref||null},get parent(){return this.node&&this.node.parent},get children(){return this.component[w.getChildren]().filter(n=>n.parent===(this[w.isSlot]?this.node.children[0]:this.node))}},y0=(n,e)=>(ul===null&&(ul={fontSize:32,fontFamily:gt.get("defaultFont","sans-serif")}),Object.assign(Object.create(x0),{props:Object.assign(Object.create(_0),{props:{}}),scheduledTransitions:{},config:n,component:e,counter:f0++})),mc={Element:y0,Launch:d0},T0="1.29.4",S0={"@lightningjs/renderer":"^2.13.4"},bd={version:T0,dependencies:S0};let xo={};const ql={};async function v0(){let n;try{if(n=await Mp(()=>import("./package-swobjhv6.js"),[]),n!==void 0)return n.version}catch{return bd.dependencies["@lightningjs/renderer"]}}const E0=(n,e,t)=>{gt.set(t),cp(),v0().then(i=>{ve.info("Blits Version ",bd.version),ve.info("Renderer Version ",i)}),ql.element=mc.Element,xo=mc.Launch(n,e,t)},b0={before:{prop:"alpha",value:0},in:{prop:"alpha",value:1,duration:200},out:{prop:"alpha",value:0,duration:100}},ls=window.speechSynthesis,A0=/android/i.test((window.navigator||{}).userAgent||"");let Ad=!1,yo=null;const Rd=()=>yo&&clearTimeout(yo),dl=n=>{if(!n||yo)return Rd();ls.pause(),ls.resume(),yo=setTimeout(()=>{dl(n)},5e3)},Is={lang:"en-US",pitch:1,rate:1,voice:null,volume:1},R0=()=>{Is.voice=ls.getVoices()[0],Ad=!0},C0=n=>{const e=new SpeechSynthesisUtterance(n.message);return e.lang=n.lang||Is.lang,e.pitch=n.pitch||Is.pitch,e.rate=n.rate||Is.rate,e.voice=n.voice||Is.voice,e.volume=n.volume||Is.volume,A0===!1&&(e.onstart=()=>{dl(e)},e.onresume=()=>{dl(e)}),new Promise((t,i)=>{e.onend=()=>{t()},e.onerror=s=>{i(s)},ls.speak(e)})},Ql={speak(n){return ls!==void 0?(Ad===!1&&R0(),C0(n)):(ve.error("speechSynthesis web API not available"),Promise.reject({error:"unavailable"}))},cancel(){ls!==void 0&&(ls.cancel(),Rd())}};let zr=!1,L0=0;const ki=[];let Ps=!1,dr=null,Tn=null;const Cd={then(){},done(){},cancel(){},stop(){}},w0=()=>{zr=!0},I0=()=>{zr=!1},P0=n=>{zr=!!n},Zl=(n,e="off")=>zr===!1?Cd:Ld(n,e),D0=n=>zr===!1?Cd:Ld(void 0,void 0,n),Ld=(n,e,t=!1)=>{const i=L0++;let s;const r=new Promise(o=>{s=o});return r.cancel=()=>{const o=ki.findIndex(a=>a.id===i);o!==-1&&ki.splice(o,1),s("canceled")},r.stop=()=>{i===dr&&(Ql.cancel(),Ps=!1,s("interupted"))},t===!1?e==="assertive"?ki.unshift({message:n,resolveFn:s,id:i}):ki.push({message:n,resolveFn:s,id:i}):ki.push({delay:t,resolveFn:s,id:i}),setTimeout(()=>{Kn()},100),r},Kn=async()=>{if(Ps===!0||ki.length===0)return;Ps=!0;const{message:n,resolveFn:e,delay:t,id:i}=ki.shift();dr=i,t?setTimeout(()=>{Ps=!1,dr=null,e("finished"),Kn()},t):(Tn!==null&&clearTimeout(Tn),Tn=setTimeout(()=>{Ql.speak({message:n}).then(()=>{Ps=!1,dr=null,e("finished"),Kn()}).catch(s=>{Ps=!1,dr=null,e(s.error),Kn()}),Tn=null},200))},M0=n=>Zl(n,"polite"),F0=n=>Zl(n,"assertive"),k0=()=>{Ql.cancel()},O0=()=>{ki.length=0},Xn={speak:Zl,polite:M0,assertive:F0,stop:k0,enable:w0,disable:I0,toggle:P0,clear:O0,pause:D0};let Oi;const ii=Ja({path:"",navigating:!1,data:null,params:null,hash:""},gt.get("reactivityMode"),!0),fl=new Map,wd=[];let Id={},Pd={},Vs=!1,Dd;const B0=()=>{const n=(document.location.hash||"/").replace(/^#/,"").split("?");return{path:n[0],queryParams:new URLSearchParams(n[1]),hash:document.location.hash}},_c=n=>n.replace(/^\/+|\/+$/g,"").toLowerCase(),xc=n=>typeof n=="object"&&n!==null,yc=n=>typeof n=="string",Md=(n,e=[])=>{const t=n.replace(/^\/+|\/+$/g,"");n=_c(n);let i=!1,s=0;for(;!i&&s<e.length;){const r=e[s];if(r.path=_c(r.path),r.path===n)r.params={},i=r;else if(r.path.indexOf(":")>-1){const o=[...r.path.matchAll(/:([^\s/]+)/gi)];let a=r.path;o.reverse().forEach(h=>{a=a.substring(0,h.index)+"([^\\s/]+)"+a.substring(h.index+h[0].length)}),a="^"+a;const l=t.match(new RegExp(`${a}`,"i"));l&&(r.params=o.reverse().reduce((h,c,u)=>(h[c[1]]=l[u+1],h),{}),i=r)}else if(r.path.endsWith("*")){const o=new RegExp(r.path.replace(/\/?\*/,"/?([^\\s]*)"),"i"),a=n.match(o);a&&(a[1]&&(r.params={path:a[1]}),i=r)}s++}return i&&(i.options={...i.options,...Id},i.data||(i.data={})),i},U0=async function(){if(Xn.stop(),Xn.clear(),ii.navigating=!0,this.parent[w.routes]){let n=Oi;const{hash:e,path:t,queryParams:i}=B0();let s=Md(t,this.parent[w.routes]);if(e!==null&&(s.hash=e),Oi=s,s){let r;if(this.parent[w.routerHooks]){const d=this.parent[w.routerHooks];if(d.beforeEach&&(r=await d.beforeEach(s,n),yc(r))){Cr(r);return}}s=xc(r)?r:s;let o;if(s.hooks&&s.hooks.before&&(o=await s.hooks.before.call(this.parent,s,n),yc(o))){Oi=n,Cr(o);return}s=xc(o)?o:s,Vs===!1&&n&&n.options.inHistory===!0&&wd.push(n),"transition"in s||(s.transition=b0),typeof s.transition=="function"&&(s.transition=s.transition(n,s));let a,l,{view:h,focus:c}=fl.get(s.hash)||{};if(s.announce&&(typeof s.announce=="string"&&(s.announce={message:s.announce}),Xn.speak(s.announce.message,s.announce.politeness)),h){a=h[w.holder];let d=!1;if(s.transition.before)if(Array.isArray(s.transition.before)){for(let f=0;f<s.transition.before.length;f++)if(s.transition.before[f].prop==="alpha"){d=!0;break}}else s.transition.before.prop==="alpha"&&(d=!0);d===!1&&a.set("alpha",1)}else{a=ql.element({parent:this[w.children][0]}),a.populate({}),a.set("w","100%"),a.set("h","100%");const d={},f=[...i.entries()];for(let p=0;p<f.length;p++)d[f[p][0]]=f[p][1];l={...Pd,...s.data,...d};const g={...this[w.props],...s.params,...l};h=await s.component({props:g},a,this),h[Symbol.toStringTag]==="Module"&&(h.default&&typeof h.default=="function"?h=h.default({props:g},a,this):ve.error("Dynamic import doesn't have a default export or default is not a function")),typeof h=="function"&&(h=h({props:g},a,this))}if(this[w.children].push(h),Dd=Us.get(),c?c.$focus():h.$focus(),s.transition.before)if(Array.isArray(s.transition.before))for(let d=0;d<s.transition.before.length;d++)a.set(s.transition.before[d].prop,s.transition.before[d].value);else a.set(s.transition.before.prop,s.transition.before.value);let u=!1;if(n){u=!0;const d=this[w.children].splice(1,1).pop();d&&N0(n,d,s.transition.out)}if(ii.path=s.path,ii.params=s.params,ii.hash=e,ii.data=l,s.transition.in)if(Array.isArray(s.transition.in))for(let d=0;d<s.transition.in.length;d++)d===s.transition.length-1?await Ws(a,s.transition.in[d],u):Ws(a,s.transition.in[d],u);else await Ws(a,s.transition.in,u);this.activeView=this[w.children][this[w.children].length-1]}else ve.error(`Route ${e} not found`)}Vs=!1,ii.navigating=!1},N0=async(n,e,t)=>{if(t)if(Array.isArray(t))for(let i=0;i<t.length;i++)i===t.length-1?await Ws(e[w.holder],t[i]):Ws(e[w.holder],t[i]);else await Ws(e[w.holder],t);Vs===!1&&n.options&&n.options.keepAlive===!0?fl.set(n.hash,{view:e,focus:Dd}):Vs===!0&&fl.delete(n.hash),n.options&&(n.options.keepAlive!==!0||Vs===!0)&&(e.destroy(),e=null)},Ws=(n,e,t=!0)=>new Promise(i=>{if(t===!0){let s=e.end;e.end=(...r)=>{s&&s(r),s=null,i()},n.set(e.prop,{transition:e})}else n.set(e.prop,e.value),i()}),Cr=(n,e={},t={})=>{Pd=e,Id=t,window.location.hash=n},Fd=function(){const n=wd.pop();if(n&&Oi!==n)return Vs=!0,Cr(n.hash,n.data,n.options),!0;const e=Oi&&Oi.options.backtrack||!1;if(e===!1)return!1;const t=/(\/:?[\w%\s-]+)$/;let i=Oi.path,s=i.split("/").length;if(s<=1)return!1;for(;s--;){if(!t.test(i))return!1;i=i.replace(t,"");const r=Md(i,this.parent[w.routes]);if(r&&e)return Cr(r.path),!0}return!1},ya={navigate:U0,back:Fd};let Xt=null,Sn=[],Tc;const gl=new Map,Us={_hold:!1,set hold(n){this._hold=n},get hold(){return this._hold},get(){return Xt},set(n,e){n!==Xt&&(clearTimeout(Tc),Xt&&Xt!==n.parent&&Xt.unfocus(),Sn.reverse().forEach(t=>t.unfocus()),n!==Xt&&(Tc=setTimeout(()=>{Xt=n,Xt.lifecycle.state="focus",e instanceof KeyboardEvent?document.dispatchEvent(new KeyboardEvent("keydown",e)):Sn=[]},this.hold?gt.get("holdTimeout",Ed):0)))},input(n,e){if(ii.navigating===!0)return;Sn=kd([Xt],n);const t=Sn.shift();if(t){let i;t[w.inputEvents][n]?i=t[w.inputEvents][n].call(t,e):t[w.inputEvents].any&&(i=t[w.inputEvents].any.call(t,e)),i!==void 0&&gl.set(e.code,i)}}},kd=(n,e)=>n[0][w.inputEvents]&&(typeof n[0][w.inputEvents][e]=="function"||typeof n[0][w.inputEvents].any=="function")?n:n[0].parent?(n.unshift(n[0].parent),kd(n,e)):[],Qi=new Map,xs=new Map,jn={registerListener(n,e,t,i=0){let s=Qi.get(e);s===void 0&&(s=new Map,Qi.set(e,s));let r=s.get(n);r===void 0&&(r=new Set,s.set(n,r)),r.add({cb:t,priority:i}),xs.delete(e)},deregisterListener(n,e){let t=Qi.get(e);t!==void 0&&t.has(n)&&(t.delete(n),Qi.set(e,t),xs.delete(e))},executeListeners(n,e){const t=Qi.get(n);if(t===void 0||t.size===0)return!0;if(xs.has(n)===!1){const s=[];for(const[r,o]of t)for(const a of o)s.push({...a,component:r});s.sort((r,o)=>o.priority-r.priority),xs.set(n,s)}const i=xs.get(n);for(let s=0;s<i.length;s++){const{cb:r,component:o}=i[s];if(r.call(o,e)===!1)return!1}return!0},removeListeners(n){for(const[e,t]of Qi)t.has(n)&&(t.delete(n),xs.delete(e),t.size===0&&Qi.delete(e))}},$0={focus:{value:function(n){return ve.warn("this.focus is deprecated, use this.$focus instead"),this.$focus(n)},writable:!1,enumerable:!0,configurable:!1},$focus:{value:function(n){this[w.state].hasFocus=!0,Us.set(this,n)},writable:!1,enumerable:!0,configurable:!1},unfocus:{value:function(){this[w.state].hasFocus=!1,this.lifecycle.state="unfocus"},writable:!1,enumerable:!0,configurable:!1},destroy:{value:function(){this.eol=!0,this.lifecycle.state="destroy",this.$clearTimeouts(),this.$clearIntervals(),jn.removeListeners(this),Od(this[w.children]),this[w.children].length=0,jh(this[w.effects]),this[w.state]={},this[w.props]={},this[w.computed]=null,this.lifecycle={},this[w.effects].length=0,this.parent=null,this.rootParent=null,this[w.wrapper]=null,this[w.originalState]=null,this[w.slots].length=0,delete this[w.computed],delete this[w.effects],delete this.parent,delete this.rootParent,delete this[w.wrapper],delete this[w.originalState],delete this[w.children],delete this[w.slots],delete this.componentId,delete this[w.id],delete this.ref,this[w.holder].destroy(),this[w.holder]=null,delete this[w.holder],ve.debug(`Destroyed component ${this.componentId}`)},writable:!1,enumerable:!0,configurable:!1},[w.removeGlobalEffects]:{value:function(n=[]){jh(n)},writable:!1,enumerable:!1,configurable:!1},select:{value:function(n){return ve.warn("this.select is deprecated, use this.$select instead"),this.$select(n)},writable:!1,enumerable:!0,configurable:!1},$select:{value:function(n){let e=null;return this[w.children].forEach(t=>{Array.isArray(t)?t.forEach(i=>{i.ref===n&&(e=i)}):Object.getPrototypeOf(t)===Object.prototype?Object.keys(t).forEach(i=>{t[i].ref===n&&(e=t[i])}):t.ref===n&&(e=t)}),e},writable:!1,enumerable:!0,configurable:!1},trigger:{value:function(n){return ve.warn("this.trigger is deprecated, use this.$trigger instead"),this.$trigger(n)},writable:!1,enumerable:!0,configurable:!1},$trigger:{value:function(n){let e=this[w.originalState];if(n.indexOf(".")>-1){const t=n.split(".");n=t.pop(t);for(let i=0;i<t.length;i++)e=e[t[i]]}Hs(e,n,!0)},writable:!1,enumerable:!0,configurable:!1},shader:{value:function(n,e){return{type:n,props:e}},writable:!1,enumerable:!0,configurable:!1}},Od=function(n){for(let e=0;e<n.length;e++){if(!n[e])return;n[e].destroy&&typeof n[e].destroy=="function"?n[e].destroy():Object.getPrototypeOf(n[e])===Object.prototype&&Od(Object.values(n[e])),n[e]=null}n.length=0},z0={$setTimeout:{value:function(n,e,...t){if(this.eol===!0)return;const i=setTimeout(()=>{this[w.timeouts]=this[w.timeouts].filter(s=>s!==i),n.apply(null,t)},e,t);return this[w.timeouts].push(i),i},writable:!1,enumerable:!0,configurable:!1},$clearTimeout:{value:function(n){this[w.timeouts].indexOf(n)>-1&&(this[w.timeouts]=this[w.timeouts].filter(e=>e!==n),clearTimeout(n))},writable:!1,enumerable:!0,configurable:!1},$clearTimeouts:{value:function(){for(let n=0;n<this[w.timeouts].length;n++)clearTimeout(this[w.timeouts][n]);this[w.timeouts]=[]},writable:!1,enumerable:!0,configurable:!1},$setInterval:{value:function(n,e,...t){if(this.eol===!0)return;const i=setInterval(()=>n.apply(null,t),e,t);return this[w.intervals].push(i),i},writable:!1,enumerable:!0,configurable:!1},$clearInterval:{value:function(n){this[w.intervals].indexOf(n)>-1&&(this[w.intervals]=this[w.intervals].filter(e=>e!==n),clearInterval(n))},writable:!1,enumerable:!0,configurable:!1},$clearIntervals:{value:function(){for(let n=0;n<this[w.intervals].length;n++)clearInterval(this[w.intervals][n]);this[w.intervals]=[]},writable:!1,enumerable:!0,configurable:!1}},G0={$emit:{value:function(n,e){return jn.executeListeners(n,e)},writable:!1,enumerable:!0,configurable:!1},$listen:{value:function(n,e,t=0){this.eol!==!0&&jn.registerListener(this,n,e,t)},writable:!1,enumerable:!0,configurable:!1},$unlisten:{value:function(n){jn.deregisterListener(this,n)},writable:!1,enumerable:!0,configurable:!1}},H0={$router:{value:{to:Cr,back:Fd,get currentRoute(){return Oi},get routes(){return this[w.routes]},get navigating(){return ii.navigating},state:ii},writable:!1,enumerable:!0,configurable:!1}},V0={$announcer:{value:Xn,writable:!1,enumerable:!0,configurable:!1}},W0={$size:{value:function(n={w:0,h:0}){this[w.holder].set("w",n.w||0),this[w.holder].set("h",n.h||0)},writable:!1,enumerable:!0,configurable:!1},[w.renderer]:{value:()=>xo,writable:!1,enumerable:!0,configurable:!1},[w.getChildren]:{value(){const n=this.rootParent||this.parent;return(this[w.children]||[]).concat(n&&n[w.getChildren]().map(e=>Object.getPrototypeOf(e)===Object.prototype?Object.values(e).map(t=>(t.forComponent=t[Symbol.for("config")]&&t[Symbol.for("config")].parent.component,t)):e).flat().filter(e=>{if(e&&e.component)return e.component&&e.component.componentId===this.componentId||e.forComponent&&e.forComponent.componentId===this.componentId})||[])},writable:!1,enumerable:!0,configurable:!1}},Bd={...G0,...H0,...V0},Zi=Object.defineProperties({[w.launched]:!1},{...$0,...z0,...Bd,...W0}),Y0={cast:n=>n,required:!1},K0=(n,e=[])=>{e.indexOf("ref")===-1&&e.push("ref"),n[w.propKeys]=[];const t=e.length;for(let i=0;i<t;i++){const s={...Y0,...typeof e[i]=="object"?e[i]:{key:e[i]}};n[w.propKeys].push(s.key),Object.defineProperty(n,s.key,{get(){const r=s.cast(this[w.props]!==void 0&&s.key in this[w.props]?this[w.props][s.key]:"default"in s?s.default:void 0);return s.required===!0&&r===void 0&&ve.warn(`${s.key} is required`),r},set(r){ve.warn(`Warning! Avoid mutating props directly (prop "${s.key}" in component "${this.componentId}")`),this[w.props][s.key]=r}})}},X0=(n,e)=>{n[w.methodKeys]=[];for(let t in e)n[w.propKeys]&&n[w.propKeys].indexOf(t)>-1?ve.error(`${t} already exists as a prop`):(typeof e[t]!="function"&&ve.warn(`${t} is not a function`),n[w.methodKeys].push(t),n[t]=e[t])},j0=(n,e=()=>{})=>{Object.defineProperty(n,w.stateKeys,{value:[],enumerable:!1,configurable:!1,writable:!1});const t=Object.keys(e.apply(n)||{});t.push(["hasFocus"]);const i=t.length;for(let s=0;s<i;s++){const r=t[s];n[w.propKeys]!==void 0&&n[w.propKeys].indexOf(r)>-1&&ve.error(`State ${r} already exists as a prop`),n[w.methodKeys]!==void 0&&n[w.methodKeys].indexOf(r)>-1&&ve.error(`State ${r} already exists as a method`),n[w.stateKeys].push(r),Object.defineProperty(n,r,{get(){return this[w.state][r]},set(o){this[w.state][r]=o}})}},q0=(n,e)=>{n[w.computedKeys]=[];for(let t in e)n[w.stateKeys]&&n[w.stateKeys].indexOf(t)>-1?ve.error(`${t} already exists as a state variable`):n[w.propKeys]&&n[w.propKeys].indexOf(t)>-1?ve.error(`${t} already exists as a prop`):n[w.methodKeys]&&n[w.methodKeys].indexOf(t)>-1?ve.error(`${t} already exists as a method`):(typeof e[t]!="function"&&ve.warn(`${t} is not a function`),n[w.computedKeys].push(t),Object.defineProperty(n,t,{get(){return e[t].apply(this)}}))},Q0=(n,e)=>{n[w.inputEvents]=[],Object.keys(e).forEach(t=>{typeof e[t]!="function"&&ve.warn(`${e[t]} is not a function`),n[w.inputEvents][t]=e[t]})},Z0=(n,e)=>{let t=e;Array.isArray(e)===!1&&(n[w.routerHooks]=e.hooks,t=e.routes),n[w.routes]=[],Object.keys(t).forEach(i=>{n[w.routes][i]={...t[i],options:{inHistory:!0,...t[i].options}}})},J0=(n,e)=>{n[w.watchKeys]=[],n[w.watchers]={};for(let t in e)typeof e[t]!="function"&&console.warn(`${t} is not a function`),n[w.watchKeys].push(t),n[w.watchers][t]=function(i,s){e[t].call(this,i,s)}};let e_=0;function t_(n,e){n[w.identifier]=++e_,Ap(e.hooks,n[w.identifier]),K0(n,e.props),e.methods&&X0(n,e.methods),j0(n,e.state),e.computed&&q0(n,e.computed),e.watch&&J0(n,e.watch);const t=e.router!==void 0?e.router:e.routes;return t!==void 0&&Z0(n,t),e.input&&Q0(n,e.input),n}const i_=()=>sr("Circle",{code:{render:function(e,t,i,s,r,o,a){const l=[],h={};return l[0]=this.element({parent:e||"root"},t),h.color=t.color,h.w=t.size,h.h=t.size,h.effects=[t.shader("radius",{radius:t.radius})],l[0].populate(h),l},effects:[function(e,t,i,s,r,o){t[0].set("color",e.color)},function(e,t,i,s,r,o){t[0].set("w",e.size)},function(e,t,i,s,r,o){t[0].set("h",e.size)},function(e,t,i,s,r,o){t[0].set("effects",[e.shader("radius",{radius:e.radius})])}],context:{}},props:[{key:"size",default:40},"color"],computed:{radius(){return this.size/2}}});let Ta=null;const s_=()=>sr("RouterView",{code:{render:function(e,t,i,s,r,o,a){const l=[],h={};return l[0]=this.element({parent:e||"root"},t),h.w=e.node.width*(100/100),h.height=e.node.height*(100/100),l[0].populate(h),l},effects:[],context:{}},state(){return{activeView:null}},hooks:{ready(){Ta=()=>ya.navigate.apply(this),ya.navigate.apply(this),window.addEventListener("hashchange",Ta)},destroy(){window.removeEventListener("hashchange",Ta,!1)},focus(){this.activeView&&this.activeView.$focus()}},input:{back(n){ya.back.call(this)===!1&&this.parent.$focus(n)}}}),r_=()=>sr("Sprite",{code:{render:function(e,t,i,s,r,o,a){const l=[],h={};return l[0]=this.element({parent:e||"root"},t),h.w=e.node.width*(100/100),h.h=e.node.height*(100/100),h.texture=t.texture,h.color=t.color,l[0].populate(h),l},effects:[function(e,t,i,s,r,o){t[0].set("texture",e.texture)},function(e,t,i,s,r,o){t[0].set("color",e.color)}],context:{}},props:["image","map","frame","color"],state(){return{spriteTexture:null}},computed:{texture(){const n="frames"in this.map?Object.assign({},this.map.defaults||{},this.map.frames[this.frame]):this.map[this.frame];if(this.spriteTexture!==null&&n)return this[w.renderer]().createTexture("SubTexture",{texture:this.spriteTexture,x:n.x,y:n.y,width:n.w,height:n.h})}},hooks:{ready(){this.spriteTexture=this[w.renderer]().createTexture("ImageTexture",{src:this.image})}}}),n_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAaMAAAAbCAYAAADRe+BYAAAAAXNSR0IArs4c6QAAGn9JREFUeF7tXQ1UVdWePxcWFg7ZA0sym5n0Tmk1z4+0YeVU4yo1h1jvPVBo1ETU8QvTdJlhsmKpi0he5jyXX0CKIWkpl3OlME3RGcdJixVEas+nJtq0sMwXN/kIgbxn1m+791n/ezifF0hr7lmrVV3O2Wfv/977//v//h/7uKTQFZJASAIhCYQkEJLADZaAy+j9iqIMkCRpliRJGeSeWkmSClwuV25X9VtRlOGSJI3m7wq6bd5Osqa/6OZSSZJKXC4X+h7UpSgKZABZQCbiKuHt4t+dvri8z5GG3E77rChKtCRJ9TY647ht0aaiKJAx5LCK/4Y5m23jneotiqJgvg84eCaYd6Cf4h/xqgo+ZwUO3h1wK5cx1oIYP/5eJUlSrsvl6tRakGUZbYr9tjQpKanL9lmw4w09F5LAzyUBXTDiih3KAspN76pwuVxjgu2koijYzGibbmg0tzQYoOPt5Zv0xydJ0hiXywWlYfviAAE5UBDSPu9YUep1QFEUvAdKWlyOAYPP26c2BhhM25ivXZo+4lWOxx8EGEHRw6iwdXHjQbu26LMwTlJsNUZusrEeHMuC9kGWZRgSYs/VJiUluZ32MXR/SAK/VAkYgREsdKaAKysr58fFxd0Di23Xrl1ScjKMTUl69913906cODHe6cDNFAVvcyAUHCxNO21rGIVv7969ufHx8djQGatWrZIyMq4bmj6frz4mJuYRSZJsMyQNQJS43e4/19bWThk+fPiA/Px8afhwkDpJKikpKUhJSXHEDujY9MDU7XZLtbWsq1BItvrMWQsAQxozZoxUUQEiYHrZapuzAYCcAOWSnJycv2RmZjZThiRJklMZGDIkyHfWLNgskkRkgXVh+g4N0NUuWLCgYN26dcMHDBiQjPUr5qyoqOjttLS0KVYC0syTui/q6+tX9O7duyU6OnoV2h09+rodEexakGUZG4vNnbiWL18uHT9+HCBsay84Gcv/13s9Hs/osLAwlZW7XK6KxMRES8Pa6/Ue4GuLic7v94+ZMGGC5Qb7OeXcXWMrLS3Nd7lcs+zKKtgxdwAjupnPnDlTNHDgwN9RhlRfXy9FR0dDuUsxMTGYDMuJ1GxooAO0eNWgQYNaX3jhhcfnzp2bhHuWLl0q5eayfWd7AyqKoro2uIJ5jr7vwIEDqqKIi4trqKysfJK7VUxlRl1ebW1tX99yyy3tlCFB+aBtroCklJQUS0Wp90L+Hii5ABYaJBhBtowRjBgxQqqqsiSCdsEISpJZIZcuXVp01113PaPHkKyAQmf8umCE9XXu3Dm2zgCoAFZ+YXGYMiS6HjZt2iSnp6eztYVLZ87gVrPFkCjQX758+d0+ffr8k1gP6Oenn34qDRgwgBkQbrfb8VqQZVnIGCyerYX9+/dLeXl5MERuSoYky7JiU/GoLE+r1A2eh4cEIKG7gD0ez4CwsDCsxwD2qygKmGlFUlKSobtUq7A5sLgnTJhgaPDx91EX+i8CjLpqbHSeXS7XCKN5sbkWDG/TAyNVuSckJHyzZ8+evvxpbNoSRVHgDmMmK1d4toFD0wumOGH9wgruBBip7q2YmBgGkiBCXDGiv6qCnj17tlRQUGBrc5PYgJSZmTk1JyfnAd5/LPTZBESowoTV7igeoSiKUEK1ly5dCo+Njf17vKezYERkAU0etAVHjZPm5uaiqKioxylD4uMNun0DgFbnbNq0aXveeustgB8TixVLpOuTsEPMeYqiKFgXTKkQkLM1ZxTkNPuCrf8rV678qVevXi+QfWGrXdxfXl4e3dbWxmJ933zzzbHz588/OnLkSKmpqUlKT0/Hv9U51CjGDq482hZk1aNHjxEJCQlsU3D2JYxB/MRiXTQG6Pf7TRUzna9uBCPxmg5xM1mW1bVhovxKkpKSdI0MPTAqLi6WvF6voWGt907OWtGFTu2vzipw+nx3jU0wo6+++qpu0aJF/bg+cURC7IxTD4xUK5goRNUipco9JSUFbgks9Bg7L9MBo+EbN24M7wwzIm3S4K+qCKgSIcpphB12xNumSQEqkFElDTYHVgewtmtp42ZqbX/99dfTzp07VzBq1KiIToCRaii4XOrUOhlrh2mk8nv66acr9u/fL+JatpWtk7VBmaLf778QHh5+O2cKtli4jvGB17O+0jkrKCiQYJzYnTMKcnpuQ+pqdWL0cJBQFeybb7557Nq1a4/OmTOHiS0vLw8MKYBpERYlaS1VjbsvNykpiS1MCyWOdc1csMGCUVKSSkDNprvW6/XWCncXUejqM2PHjpXE2PFjdXX10uzsbOYu0Shb39mzZ7MyMjL+BkYt5mTKlCnS4MGDWVunTp0qy8zM/IO2M3oKGyx8yZIlbNvpGTuyLMNFfd0nz69fChh18dgoE+6UXtFbJHpgpDINsulU9DfY7EF3jG7iYNx0ZFA0AQDg6KOK7erVqy2RkZGR/H4nihRgdD14cZ1xCaUGxT/A7/dfue+++27n8R1bCpMDEdoVcRgE1OH2SxaxhyCZEZMBxrpt27ZIEXPhfQdQMjeGQ3BgG7G9vb0pPj4+Cm2KuCFvJ6ikE6M+0PWgcbPZskDpnGNOYDBVVVWNURQFCheGFlMqRL625syAcdF9gTXCKD5Zx7b2hVB2iqL8MHXq1N+gjW3btjERcWWCdQdFyRiO1+udxfsjcateBSuakQcFi+fvvffeD9asWSPiu779+/e/lZeX9wRkAcUPABDX3Llz4Yo1VMx03igz6iowQvsUkI4fPy4tX76csU8Kwh6PZ/uOHTsm0/5ERUVJGzdulPBvXDNmzCjz+XwBgETBCOOMjY1l93JZdfDyeL3e4YqisKSgpqam+qioKGZ43+xg1E1jE8aurT3jRM/gXrtgpFoMBmDEXHhOX86Vst4mDtb1F9AFatVv3br18PTp0/+F32BLsdHGqDIiv1ekpqZuKy4uvq45rrs8bGV9kb75EhMTs3bv3r2OxreCBCM1wG4yFylOUpAVRWHWUEtLy9XIyMhbDdqtgoUezPxrn1EUhY0BivmOO+6Q6uvroZxtuVZFW8gqrKurK+vXrx9cCtqrdv369fnz588XSQG24jt03RNWRfeFyswJGFkaPVTZnT9//sTixYt/iw5v2LDhWN++fR8lilJti7riuLJWvRMiI6+xsVEFtldffbXsgQce+D3a2rdvn1xQUBBAY15//XUGzri6AIwMy0XQPo0ZGSl0Oj64KlNTU/FoCgdaxuBIP1WXPH7Pz88vvfPOO9n4Vq9eLR09ejRgT1Iw8nq9UmJiIhs3/ru4uBhuy4B1TMF93759344bN+4u3K/Xd85KA8oJYPwhlkXjWBp21sHVKsuyuo9RNpGYmGjL9d9dY6P9SUpKYvNL3cUYn6IoyHjNQKID2XCOyhO6CowsN52RoupCZhTwCtruTz/9VBMREYFYDNhIUG5FPTACW5gxY0ZzcXExzCu0i4VsmflG3UU8KwtZXQOqq6svDRs2jJlqQYIR3D0Zp0+fDp88eXKvqqoq9KkkIyNjFjILcTU3N7c9+eSTz1ZWVu62Ag9t7RMSItLT05EEMn7o0KGLNm/eHC+y04LNrqR9oG7L3bt3y4mJiUJpOlpfkK/f738zLCzsXu0YwWRnzpz5fWFhocgMtIxDoQ1togkHHGbUUKMH9zph+FTZbdiwofbgwYPol2/Lli0ro6Oj/8NIUVKWAGXd1NQ0AgpVWPFQnAUFBVCcPlmWsSYZI+T34j9VJU4B4mYAI3ROh3VV8PExNzF3XzKQ0jGEsc9pUhDzlHAlqmbTgVUOGTKEufbAJDB2vofVxAkB7j/88EPF+++/PxquQD0wEnEVkz0VoJg196t/o6wX4zKKfem9h4JRV47NCox4yAPrtkMpEIBq/PjxtrJsf5VgpEnv9Y0cOXLXsWPHhEA6y7ryR48ezZS7UMRz5sw5kZ+fD3eAJRBxxSYsHzAKUF6AiK+xsfHPUVFR/xwsGJEF2oEh0VRpriwt2SwFI7i8kLDiu54hwhYdssfgBsLFs8g6WJZWgKcBI9XVOnDgwK/PnDnzt1yJqC4qq/ZorVVTU9Op+Ph46ciRIw+gr5CBcIOmpqZeKi4uRualbbclBUudfqhxFx4zYrhklZYtlJ3f729IS0vrBSYAJVReXj5bJDUQdqC6/ajS4gxgqSzLeJZZHcJFB9esLMvMWqVsScTRONipacs3AxhRpUpiHj6v17tUuCcJIBkZE2r8lAKWVmE3NzerMSrOdlQmRe997733Prxy5crTemDk9XrB5JmLFvt50aJF2y9cuBDvdruTX3zxRdUVuGrVqvmVlZXrcR/YX0tLy/+Gh4dHYX7nzZt34Z133nm4ra1NgKjv+eefb7p48SL2AC5Lg6w7xob9oQEj1hmPx+MOCwtTMwyPHj0qFRYWFtXX168cMWLE6wsWLEgS7tL09PQV33777XKrvfurAyNt4eeMGTNyCgsLl3FBdEpZ8jbYIqeK+LPPPrv28MMPT7TjqqTunldeeSU9Ozt7I28XGw1WH7P8gmFGZLIZQ+LgiEVcpRO8D4hD6C0UCkaaFGvIkbXb0tJy4tZbb/1HPM8z+CwVsMG71DTv48ePVwwZMkQkSjhqj9aGpaamphYXF2MTMBZEU8YvXLjg79+//7/ZmTPa39OnT//hiy++2JmYmNgDv6N+LTo6+mVaxE3S6k37TpMNvvzyy7+89NJLg/i7mKFA2Y/W5URdWTwFvMrr9SJOOhqxjdTUVJFUBPcWq186ffp0w8svv9yLv0NlC13BjEwUTYAbyspNx2WCPcYMHsKAmK7XnFIhtbe3/xgREbHS7/eXmKVni/5pXVlgW1u2bGmJiIiI1KbSE/biS01NdT333HO/EfE16qaTZRl9ZWtsyZIlQ8+dO4d1xS64AQWA8bGoa4IaFHh3ZGTk3scff/xf8dwnn3wi5+bmCs+ArcSo7hibHTAirBJ6gTEkjFm4QPnatXSH282m040Z8Ww6W6httFi70k2nPTli/fr1GSQ2YNuNZoXg4u/Nzc0Xe/bsyVLfefaaKdtwcFyP2oUDBw6kjh07tthun0zkjEXCLJmSkhIW2Ley3Gl/CRiBAcBCZ24PnSwzR/Ed0V/aTkpKSnVJScnD/G+23GikHRbjunr1al1kZKSIGang2djY+D8a9mnJEHVk2qFAVRSEX7lyBSAXxksMTK1ZCjZW8wvLc/Xq1QEuZvG8SAEXSQ8ffPDBic2bNyP2xO4XLi+iNALm6EaBkdWYz58/v3Px4sXP8vtUQ3LatGn5Dz744CwR5yLtwNNQYBZjoQqbg4/0xhtvnOjfv/9vCQNl7lfBWuvq6vbMnz//GZrsYRDvUuPfnHGneL3eZE2yCbqrrumdO3f+V0REhIhls6EoinJh/PjxIovUtt7qrrFZMSMetxTTwEpfOBtnLJ0YFKoBpDf3pnVGBGwoGKmp38QCtKSQ3Q1G3IpH1guzqD766KOcxx57TDAi/GQrs4koNXFmHn4S7rSAYYhgOwEjU+alc/6c1X5Ehp0tMOLMR6Sf4rimgIJBg7RmS2uFxyCG8yJn9Dcgk4YyEVLbZLrotIOmcvnuu++qY2NjBRBZ9k+nLQZGFy9ebOnXr5/InqTrV5stGhR4kvMUkylLPnLkSOUTTzyBgljTNaepB7JcB7iBx3tU8KTMCjECYYFnZGQ0nD17FgyIyY+mJvM2AuawK8DIRjYdk7PNotdcj8fTtmPHjudJHEKrY5DOnYF4Dyxw4RLie7EiIiIiRdRXUeHqKewJEyaUTZo0iSV4CCtelmXIiDHKDRs27Dl48OAz8+bNa33qqaduwW96YJSVlfV2bGxsXN++ff9Bb0J55iP+pI6FJrCIZwoLCzeXl5f/O/9/256B7hqbAzBS9xItJbCI76miMj2BwSBriJ2fxY/XUV0BTt0dROl3OptOe2bY559/vm7o0KGIB4iAWjDZc1Ds4py3DmfxUQV64sSJ1sGDB7NFqpehqLMwdQ80NcimE4+bjkETz+hwRhplHiTAbkn/deq0VEWmiSn91e1238E765TNqP7911577ciyZctQWIsrmHlTa0K4q5PWhqmB7aampvbbbruN1XTZKaY1QwsKyMOGDfugpqYGadSmblC6WQmT6fAa6u7gykydMw5oLMYAqx4KuaGhoTYtLU0kZwgLX83044ohAIApWHVBzMhIVB3ASK/OyOBhoyxVcTDycIASAFHUGV2+fPnU7NmzH9S2p6eweVwNbUULBsrBCL/5ONBG5+Tk1A4aNIjJloJReXl5VVtbG4ycgFok7bsJGAUADJU/Ya943JGh1B1js+OmI8xI1Q0GYGRKWozOplM3NGdH4vQFlRWtXbv2xMKFC1kaqlPWQSeps2467blptbW1f3S73TNNLCozvRLwN8p8uMWbybOnsOigQNniW7hw4V/Xrl0rFLFpait/geoyoy/sDBihHdpfnt32Co8XqUWVyACMjY2N4m4kS+ZBs8jwzMSJE5s+/PDD2zgQqXU7mZmZp8gpFbaZEW2fH7skArZB1TLQmByy/yZNmoREiL/j71EPevV4PHXJycnCjecIPMWcaU9z52vvJf53U9lSBUSSDTqsTQAqUq9xkWC+Kl+tq+/QoUOH169fD7eP6tKjabgALQDS0aNHWRvaLDAKRvw5duaV3llsBnVGwaR2G+1JgBDWgVWSifBiZGzatCla1A5lZWVVnjx5cpxwKeMlVGETJYokD8iLHWQJGWzatIn1iRfPMta0devW6ttvv52xdgpGpaWlySKlGQkMa9asOYWkGbBnWjOlB0Z6ZxISJuHIGOuOsd0MYIQiR/gyr1ePdbzAFLAAYGk6Qm9tU10ARnaOB1Ff6yJHE1ihEmJQ165dOxQeHi6Cvh0eqaury7/nnntEpl6nEiSohR1MAgP629TUtCcqKup6JV/Hy5eQkPCfe/bsEYFRWy4Aq1O2OyMDCh55eXmVc+fOFS6uzrh+aSZVBym0trYevvvuu4fwGiZHqf4mspjtcrlgSYvEC0OAo66Z77//vm7mzJkCFHXnQwe41Pu0yoy46ALYhCZl2HDpUzAqLS1V60b0UnS7EIwsla5mnIYpz+vWrSvv168fOz6KK/UAo8ZIYXu9XtTKME8IQEowrJUrV1bU1NRgTpHNJxKBAsBIlmVWAI9n09LSahoaGoYKAdsAI5H56vvxxx979ezZM1xk1zU2Nva30lH0790xthsORhggLN+cnJz/XrZsGS0cFN8zAhBdP77bRvqqmUBvZjDicohesWLFl1OmTIlBbIBcBTt27KiZPHnyDELPg1ag/F16p184strBANDfBQsWxCB7jFxLR40aFXP48GFhuVtm09GHy8rKhp09e/bo4sWLaeFrRWVlZVlcXFxaMDKgrKgzRa566ys7O/vtuLi4ySKVm99TVV9fX967d2+kzwvQsGSHtH0NGDGr3e12R+I0d3JmnynIUzZSWlpat337drHHdOOa1OUhMudEcSZ11RHmhC53UPBZWVlTwsLCtglFC5der169cIIGTnRg8jBiRgZFnurxMCRmFAwzsgQjTYzN16NHD7deTIjGpHj8B8NS5WqgsBlg0dgIHmpvbz/57LPPskxRpOhzI4LJSZNNB8Yd3dra2jpx4kThrkebSLfH/SyQr2VGdF5ramq2f/zxx5PFUUh8nh3pk+4Y200BRnwCADqm3zVyemq3CTDRTBRbFrumLUcMyWZsR7zCSg5ssdo9fcEMnPnf6NFGjsCIzBs2iNF3mNj3nRyczye6bPVRvM7IgM5fMPOvJ1ZThiQynqgbx8bcWMnCiQKhcUk7rJqekaYFLno2oxnbo/uMjYWewECKYum6o3KkRw/9bGCEflLlDeA9dOjQsb17947E3wBWra2tq4S7rKGhgdVt8clS58RCYQfokLKysi+LiopEMgKKilfpnKsHEINMmXFOAAdZjAEfYaRg5PF4SkidTu3UqVPDGhsb783Ly/P36dMnDG1xlovCbXHQrehfLXebBtQ1dsfYuhqMPB5PBf+EB3RTQCGw3fiG9rh2xpCsCvocbGzcejODEfonzqjTfvEVckBQ2cqv7UQcnQUj2l8sYEqR2Jdv7Rbo6nRa7wvAGLuQg5NxintpxbwjxmbjZVi7mDP64UIofsigM98JosAs4hqQAVMcNi+q5O0AMFWWWkZH+9PBKOBuLgT5MW7ci7ZGI74i4iN1dXUN8+fPFwqcghFtW2UxP6ebTshz+/btf4qMjGSno5tcvqysrLMnT54ULl81A9FMYWs/FUGAmRkKRjVSvL7LyGhXi6H5kUPo9lKv1ztaABs9oikhIWHz9OnTWSYdZ7oU/E2PCeqOsXU1GPFTNMSHUANq0OyAkc19FbotJIGQBG5GCXAlK8oe6NEzOARUTcQpKir6qqysjH3ChJ/EbwqsNwKM0LGHHnoo9/77739Jm9INpt/Y2Fg+depU1P6JM9ICYtpmChttC8DR1M4wQ8GsYBcyrqqqOvDII48wb0R7ezsKaVf06NGjQJykITLlZs2aJY8bN47FbTWuQFbD5/V6dwmg4myKsWDBDFHUvGTJkphLly7hfhgHjCF119gcpHZbZtNRZrRz5876nTt3IpGGyTcERjej9gj1KSSBLpQAXFjt7e2qgtNruqGh4d20tDRxcoAdlyFthn5awK5OoezfMmak02fqljSSlpk7Wsts6fd5tNmu2uxQo76bufNVhqRx6dO2qIuX9k87H/S4Lz23cHeMjZE14voX80xlpZcBS9k87Sv1hDGDwe7C6cKtEWoqJIGQBG6EBHJzc5+vr69/Iy4ujh1lxK+S6urqquzsbLgzRZ2Mk7gXmrkRYIT3QhGKWiPqirbjhjVT2GhbgISegjUDUvQJCph+dgZuU7jb2AcUSQYyVch6BgB9D3XjqrEjyozInHbX2LoSjCAnjI/FjkLM6EZohNA7QxK4cRKAwlZrrQy64Si78MYNJfTmX5sEQszo1zajofGEJGAtAfHNHVGegSeQ2CD+sW4hdEdIAl0sgRAYdbFAQ82FJBCSQEgCIQk4l0AIjJzLLPRESAIhCYQkEJJAF0vg/wBMng85iZWBHAAAAABJRU5ErkJggg==",o_=()=>sr("FPScounter",{code:{render:function(e,t,i,s,r,o,a){const l=[];let h,c,u,d=!1,f=0;const g={};l[0]=this.element({parent:e||"root"},d===!0?u:t),l[0].populate(g),d===!0&&(f-=1),e=l[0];const p={};l[1]=this.element({parent:e||"root"},d===!0?u:t),p.y=15,p.x=20,l[1].populate(p),d===!0&&(f-=1),e=l[1];const m={};l[2]=this.element({parent:e||"root"},d===!0?u:t),l[2].populate(m),d===!0&&(f-=1);const _=i.components&&i.components.Sprite||s.Sprite;e=l[2];const T={};l[3]=this.element({parent:e||"root"},d===!0?u:t),T.image=t.image,T.w=43,T.h=25,T.map=t.sprite,T.frame="fps";const S=[];if(typeof _<"u")for(let se in _[Symbol.for("config")].props)delete T[_[Symbol.for("config")].props[se]],S.push(_[Symbol.for("config")].props[se]);l[3].populate(T),d===!0&&(f-=1),e=l[3];const v={};v.image=t.image,v.w=43,v.h=25,v.map=t.sprite,v.frame="fps",h=v.is||"Sprite";let E;if(typeof h=="string"){if(E=i.components&&i.components[h]||s[h],!E)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(E=h);l[4]=E.call(null,{props:v},l[3],t),l[4][Symbol.for("slots")][0]?(e=l[4][Symbol.for("slots")][0],u=l[4],d=!0):e=l[4][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[2];const C={};l[5]=this.element({parent:e||"root"},d===!0?u:t),C.x=58,C.y=2,l[5].populate(C),d===!0&&(f-=1);const b=i.components&&i.components.Sprite||s.Sprite;e=l[5];const A={};l[6]=this.element({parent:e||"root"},d===!0?u:t),A.image=t.image,A.x=0,A.h=20,A.w=20,A.map=t.sprite,A.frame=t.fps[0];const L=[];if(typeof b<"u")for(let se in b[Symbol.for("config")].props)delete A[b[Symbol.for("config")].props[se]],L.push(b[Symbol.for("config")].props[se]);l[6].populate(A),d===!0&&(f-=1),e=l[6];const R={};R.image=t.image,R.x=0,R.h=20,R.w=20,R.map=t.sprite,c=t.fps[0],Array.isArray(c)===!0&&(c=o(c).slice(0)),R.frame=c,h=R.is||"Sprite";let M;if(typeof h=="string"){if(M=i.components&&i.components[h]||s[h],!M)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(M=h);l[7]=M.call(null,{props:R},l[6],t),l[7][Symbol.for("slots")][0]?(e=l[7][Symbol.for("slots")][0],u=l[7],d=!0):e=l[7][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const F=i.components&&i.components.Sprite||s.Sprite;e=l[5];const z={};l[8]=this.element({parent:e||"root"},d===!0?u:t),z.image=t.image,z.x=18,z.h=20,z.w=20,z.map=t.sprite,z.frame=t.fps[1];const G=[];if(typeof F<"u")for(let se in F[Symbol.for("config")].props)delete z[F[Symbol.for("config")].props[se]],G.push(F[Symbol.for("config")].props[se]);l[8].populate(z),d===!0&&(f-=1),e=l[8];const k={};k.image=t.image,k.x=18,k.h=20,k.w=20,k.map=t.sprite,c=t.fps[1],Array.isArray(c)===!0&&(c=o(c).slice(0)),k.frame=c,h=k.is||"Sprite";let I;if(typeof h=="string"){if(I=i.components&&i.components[h]||s[h],!I)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(I=h);l[9]=I.call(null,{props:k},l[8],t),l[9][Symbol.for("slots")][0]?(e=l[9][Symbol.for("slots")][0],u=l[9],d=!0):e=l[9][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const O=i.components&&i.components.Sprite||s.Sprite;e=l[5];const V={};l[10]=this.element({parent:e||"root"},d===!0?u:t),V.image=t.image,V.x=36,V.h=20,V.w=20,V.map=t.sprite,V.frame=t.fps[2];const B=[];if(typeof O<"u")for(let se in O[Symbol.for("config")].props)delete V[O[Symbol.for("config")].props[se]],B.push(O[Symbol.for("config")].props[se]);l[10].populate(V),d===!0&&(f-=1),e=l[10];const U={};U.image=t.image,U.x=36,U.h=20,U.w=20,U.map=t.sprite,c=t.fps[2],Array.isArray(c)===!0&&(c=o(c).slice(0)),U.frame=c,h=U.is||"Sprite";let Y;if(typeof h=="string"){if(Y=i.components&&i.components[h]||s[h],!Y)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Y=h);l[11]=Y.call(null,{props:U},l[10],t),l[11][Symbol.for("slots")][0]?(e=l[11][Symbol.for("slots")][0],u=l[11],d=!0):e=l[11][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[1];const W={};l[12]=this.element({parent:e||"root"},d===!0?u:t),W.x=150,l[12].populate(W),d===!0&&(f-=1);const Q=i.components&&i.components.Sprite||s.Sprite;e=l[12];const te={};l[13]=this.element({parent:e||"root"},d===!0?u:t),te.image=t.image,te.y=2,te.w=48,te.h=25,te.map=t.sprite,te.frame="avg";const re=[];if(typeof Q<"u")for(let se in Q[Symbol.for("config")].props)delete te[Q[Symbol.for("config")].props[se]],re.push(Q[Symbol.for("config")].props[se]);l[13].populate(te),d===!0&&(f-=1),e=l[13];const J={};J.image=t.image,J.y=2,J.w=48,J.h=25,J.map=t.sprite,J.frame="avg",h=J.is||"Sprite";let me;if(typeof h=="string"){if(me=i.components&&i.components[h]||s[h],!me)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(me=h);l[14]=me.call(null,{props:J},l[13],t),l[14][Symbol.for("slots")][0]?(e=l[14][Symbol.for("slots")][0],u=l[14],d=!0):e=l[14][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[12];const ge={};l[15]=this.element({parent:e||"root"},d===!0?u:t),ge.x=63,ge.y=2,l[15].populate(ge),d===!0&&(f-=1);const Be=i.components&&i.components.Sprite||s.Sprite;e=l[15];const Ke={};l[16]=this.element({parent:e||"root"},d===!0?u:t),Ke.image=t.image,Ke.x=0,Ke.h=20,Ke.w=20,Ke.map=t.sprite,Ke.frame=t.avgFps[0];const ht=[];if(typeof Be<"u")for(let se in Be[Symbol.for("config")].props)delete Ke[Be[Symbol.for("config")].props[se]],ht.push(Be[Symbol.for("config")].props[se]);l[16].populate(Ke),d===!0&&(f-=1),e=l[16];const _e={};_e.image=t.image,_e.x=0,_e.h=20,_e.w=20,_e.map=t.sprite,c=t.avgFps[0],Array.isArray(c)===!0&&(c=o(c).slice(0)),_e.frame=c,h=_e.is||"Sprite";let Mt;if(typeof h=="string"){if(Mt=i.components&&i.components[h]||s[h],!Mt)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Mt=h);l[17]=Mt.call(null,{props:_e},l[16],t),l[17][Symbol.for("slots")][0]?(e=l[17][Symbol.for("slots")][0],u=l[17],d=!0):e=l[17][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const it=i.components&&i.components.Sprite||s.Sprite;e=l[15];const Je={};l[18]=this.element({parent:e||"root"},d===!0?u:t),Je.image=t.image,Je.x=18,Je.h=20,Je.w=20,Je.map=t.sprite,Je.frame=t.avgFps[1];const de=[];if(typeof it<"u")for(let se in it[Symbol.for("config")].props)delete Je[it[Symbol.for("config")].props[se]],de.push(it[Symbol.for("config")].props[se]);l[18].populate(Je),d===!0&&(f-=1),e=l[18];const xe={};xe.image=t.image,xe.x=18,xe.h=20,xe.w=20,xe.map=t.sprite,c=t.avgFps[1],Array.isArray(c)===!0&&(c=o(c).slice(0)),xe.frame=c,h=xe.is||"Sprite";let De;if(typeof h=="string"){if(De=i.components&&i.components[h]||s[h],!De)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(De=h);l[19]=De.call(null,{props:xe},l[18],t),l[19][Symbol.for("slots")][0]?(e=l[19][Symbol.for("slots")][0],u=l[19],d=!0):e=l[19][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const et=i.components&&i.components.Sprite||s.Sprite;e=l[15];const Ie={};l[20]=this.element({parent:e||"root"},d===!0?u:t),Ie.image=t.image,Ie.x=36,Ie.h=20,Ie.w=20,Ie.map=t.sprite,Ie.frame=t.avgFps[2];const ci=[];if(typeof et<"u")for(let se in et[Symbol.for("config")].props)delete Ie[et[Symbol.for("config")].props[se]],ci.push(et[Symbol.for("config")].props[se]);l[20].populate(Ie),d===!0&&(f-=1),e=l[20];const Qe={};Qe.image=t.image,Qe.x=36,Qe.h=20,Qe.w=20,Qe.map=t.sprite,c=t.avgFps[2],Array.isArray(c)===!0&&(c=o(c).slice(0)),Qe.frame=c,h=Qe.is||"Sprite";let Yi;if(typeof h=="string"){if(Yi=i.components&&i.components[h]||s[h],!Yi)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Yi=h);l[21]=Yi.call(null,{props:Qe},l[20],t),l[21][Symbol.for("slots")][0]?(e=l[21][Symbol.for("slots")][0],u=l[21],d=!0):e=l[21][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[1];const ui={};l[22]=this.element({parent:e||"root"},d===!0?u:t),ui.x=0,ui.y=40,l[22].populate(ui),d===!0&&(f-=1);const Ki=i.components&&i.components.Sprite||s.Sprite;e=l[22];const st={};l[23]=this.element({parent:e||"root"},d===!0?u:t),st.image=t.image,st.x="-2",st.w=47,st.h=25,st.map=t.sprite,st.frame="min";const Wr=[];if(typeof Ki<"u")for(let se in Ki[Symbol.for("config")].props)delete st[Ki[Symbol.for("config")].props[se]],Wr.push(Ki[Symbol.for("config")].props[se]);l[23].populate(st),d===!0&&(f-=1),e=l[23];const Ft={};Ft.image=t.image,Ft.x="-2",Ft.w=47,Ft.h=25,Ft.map=t.sprite,Ft.frame="min",h=Ft.is||"Sprite";let Xi;if(typeof h=="string"){if(Xi=i.components&&i.components[h]||s[h],!Xi)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Xi=h);l[24]=Xi.call(null,{props:Ft},l[23],t),l[24][Symbol.for("slots")][0]?(e=l[24][Symbol.for("slots")][0],u=l[24],d=!0):e=l[24][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[22];const ms={};l[25]=this.element({parent:e||"root"},d===!0?u:t),ms.x=58,ms.y=2,l[25].populate(ms),d===!0&&(f-=1);const kt=i.components&&i.components.Sprite||s.Sprite;e=l[25];const di={};l[26]=this.element({parent:e||"root"},d===!0?u:t),di.image=t.image,di.x=0,di.h=20,di.w=20,di.map=t.sprite,di.frame=t.minFps[0];const tp=[];if(typeof kt<"u")for(let se in kt[Symbol.for("config")].props)delete di[kt[Symbol.for("config")].props[se]],tp.push(kt[Symbol.for("config")].props[se]);l[26].populate(di),d===!0&&(f-=1),e=l[26];const fi={};fi.image=t.image,fi.x=0,fi.h=20,fi.w=20,fi.map=t.sprite,c=t.minFps[0],Array.isArray(c)===!0&&(c=o(c).slice(0)),fi.frame=c,h=fi.is||"Sprite";let Yr;if(typeof h=="string"){if(Yr=i.components&&i.components[h]||s[h],!Yr)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Yr=h);l[27]=Yr.call(null,{props:fi},l[26],t),l[27][Symbol.for("slots")][0]?(e=l[27][Symbol.for("slots")][0],u=l[27],d=!0):e=l[27][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const Kr=i.components&&i.components.Sprite||s.Sprite;e=l[25];const gi={};l[28]=this.element({parent:e||"root"},d===!0?u:t),gi.image=t.image,gi.x=18,gi.h=20,gi.w=20,gi.map=t.sprite,gi.frame=t.minFps[1];const ip=[];if(typeof Kr<"u")for(let se in Kr[Symbol.for("config")].props)delete gi[Kr[Symbol.for("config")].props[se]],ip.push(Kr[Symbol.for("config")].props[se]);l[28].populate(gi),d===!0&&(f-=1),e=l[28];const pi={};pi.image=t.image,pi.x=18,pi.h=20,pi.w=20,pi.map=t.sprite,c=t.minFps[1],Array.isArray(c)===!0&&(c=o(c).slice(0)),pi.frame=c,h=pi.is||"Sprite";let Xr;if(typeof h=="string"){if(Xr=i.components&&i.components[h]||s[h],!Xr)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Xr=h);l[29]=Xr.call(null,{props:pi},l[28],t),l[29][Symbol.for("slots")][0]?(e=l[29][Symbol.for("slots")][0],u=l[29],d=!0):e=l[29][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const jr=i.components&&i.components.Sprite||s.Sprite;e=l[25];const mi={};l[30]=this.element({parent:e||"root"},d===!0?u:t),mi.image=t.image,mi.x=36,mi.h=20,mi.w=20,mi.map=t.sprite,mi.frame=t.minFps[2];const sp=[];if(typeof jr<"u")for(let se in jr[Symbol.for("config")].props)delete mi[jr[Symbol.for("config")].props[se]],sp.push(jr[Symbol.for("config")].props[se]);l[30].populate(mi),d===!0&&(f-=1),e=l[30];const _i={};_i.image=t.image,_i.x=36,_i.h=20,_i.w=20,_i.map=t.sprite,c=t.minFps[2],Array.isArray(c)===!0&&(c=o(c).slice(0)),_i.frame=c,h=_i.is||"Sprite";let qr;if(typeof h=="string"){if(qr=i.components&&i.components[h]||s[h],!qr)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(qr=h);l[31]=qr.call(null,{props:_i},l[30],t),l[31][Symbol.for("slots")][0]?(e=l[31][Symbol.for("slots")][0],u=l[31],d=!0):e=l[31][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[1];const la={};l[32]=this.element({parent:e||"root"},d===!0?u:t),la.x=150,la.y=40,l[32].populate(la),d===!0&&(f-=1);const Qr=i.components&&i.components.Sprite||s.Sprite;e=l[32];const ji={};l[33]=this.element({parent:e||"root"},d===!0?u:t),ji.image=t.image,ji.w=53,ji.h=25,ji.map=t.sprite,ji.frame="max";const rp=[];if(typeof Qr<"u")for(let se in Qr[Symbol.for("config")].props)delete ji[Qr[Symbol.for("config")].props[se]],rp.push(Qr[Symbol.for("config")].props[se]);l[33].populate(ji),d===!0&&(f-=1),e=l[33];const qi={};qi.image=t.image,qi.w=53,qi.h=25,qi.map=t.sprite,qi.frame="max",h=qi.is||"Sprite";let Zr;if(typeof h=="string"){if(Zr=i.components&&i.components[h]||s[h],!Zr)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(Zr=h);l[34]=Zr.call(null,{props:qi},l[33],t),l[34][Symbol.for("slots")][0]?(e=l[34][Symbol.for("slots")][0],u=l[34],d=!0):e=l[34][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[32];const ha={};l[35]=this.element({parent:e||"root"},d===!0?u:t),ha.x=63,ha.y=2,l[35].populate(ha),d===!0&&(f-=1);const Jr=i.components&&i.components.Sprite||s.Sprite;e=l[35];const xi={};l[36]=this.element({parent:e||"root"},d===!0?u:t),xi.image=t.image,xi.x=0,xi.h=20,xi.w=20,xi.map=t.sprite,xi.frame=t.maxFps[0];const np=[];if(typeof Jr<"u")for(let se in Jr[Symbol.for("config")].props)delete xi[Jr[Symbol.for("config")].props[se]],np.push(Jr[Symbol.for("config")].props[se]);l[36].populate(xi),d===!0&&(f-=1),e=l[36];const yi={};yi.image=t.image,yi.x=0,yi.h=20,yi.w=20,yi.map=t.sprite,c=t.maxFps[0],Array.isArray(c)===!0&&(c=o(c).slice(0)),yi.frame=c,h=yi.is||"Sprite";let en;if(typeof h=="string"){if(en=i.components&&i.components[h]||s[h],!en)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(en=h);l[37]=en.call(null,{props:yi},l[36],t),l[37][Symbol.for("slots")][0]?(e=l[37][Symbol.for("slots")][0],u=l[37],d=!0):e=l[37][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const tn=i.components&&i.components.Sprite||s.Sprite;e=l[35];const Ti={};l[38]=this.element({parent:e||"root"},d===!0?u:t),Ti.image=t.image,Ti.x=18,Ti.h=20,Ti.w=20,Ti.map=t.sprite,Ti.frame=t.maxFps[1];const op=[];if(typeof tn<"u")for(let se in tn[Symbol.for("config")].props)delete Ti[tn[Symbol.for("config")].props[se]],op.push(tn[Symbol.for("config")].props[se]);l[38].populate(Ti),d===!0&&(f-=1),e=l[38];const Si={};Si.image=t.image,Si.x=18,Si.h=20,Si.w=20,Si.map=t.sprite,c=t.maxFps[1],Array.isArray(c)===!0&&(c=o(c).slice(0)),Si.frame=c,h=Si.is||"Sprite";let sn;if(typeof h=="string"){if(sn=i.components&&i.components[h]||s[h],!sn)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(sn=h);l[39]=sn.call(null,{props:Si},l[38],t),l[39][Symbol.for("slots")][0]?(e=l[39][Symbol.for("slots")][0],u=l[39],d=!0):e=l[39][Symbol.for("children")][0],d===!0&&f===0&&(d=!1);const rn=i.components&&i.components.Sprite||s.Sprite;e=l[35];const vi={};l[40]=this.element({parent:e||"root"},d===!0?u:t),vi.image=t.image,vi.x=36,vi.h=20,vi.w=20,vi.map=t.sprite,vi.frame=t.maxFps[2];const ap=[];if(typeof rn<"u")for(let se in rn[Symbol.for("config")].props)delete vi[rn[Symbol.for("config")].props[se]],ap.push(rn[Symbol.for("config")].props[se]);l[40].populate(vi),d===!0&&(f-=1),e=l[40];const Ei={};Ei.image=t.image,Ei.x=36,Ei.h=20,Ei.w=20,Ei.map=t.sprite,c=t.maxFps[2],Array.isArray(c)===!0&&(c=o(c).slice(0)),Ei.frame=c,h=Ei.is||"Sprite";let nn;if(typeof h=="string"){if(nn=i.components&&i.components[h]||s[h],!nn)throw new Error('Component "Sprite" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(nn=h);return l[41]=nn.call(null,{props:Ei},l[40],t),l[41][Symbol.for("slots")][0]?(e=l[41][Symbol.for("slots")][0],u=l[41],d=!0):e=l[41][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),l},effects:[function(e,t,i,s,r,o){(typeof skip6>"u"||skip6.indexOf("frame")===-1)&&t[6].set("frame",e.fps[0])},function(e,t,i,s,r,o){t[7][Symbol.for("props")].frame=e.fps[0]},function(e,t,i,s,r,o){(typeof skip8>"u"||skip8.indexOf("frame")===-1)&&t[8].set("frame",e.fps[1])},function(e,t,i,s,r,o){t[9][Symbol.for("props")].frame=e.fps[1]},function(e,t,i,s,r,o){(typeof skip10>"u"||skip10.indexOf("frame")===-1)&&t[10].set("frame",e.fps[2])},function(e,t,i,s,r,o){t[11][Symbol.for("props")].frame=e.fps[2]},function(e,t,i,s,r,o){(typeof skip16>"u"||skip16.indexOf("frame")===-1)&&t[16].set("frame",e.avgFps[0])},function(e,t,i,s,r,o){t[17][Symbol.for("props")].frame=e.avgFps[0]},function(e,t,i,s,r,o){(typeof skip18>"u"||skip18.indexOf("frame")===-1)&&t[18].set("frame",e.avgFps[1])},function(e,t,i,s,r,o){t[19][Symbol.for("props")].frame=e.avgFps[1]},function(e,t,i,s,r,o){(typeof skip20>"u"||skip20.indexOf("frame")===-1)&&t[20].set("frame",e.avgFps[2])},function(e,t,i,s,r,o){t[21][Symbol.for("props")].frame=e.avgFps[2]},function(e,t,i,s,r,o){(typeof skip26>"u"||skip26.indexOf("frame")===-1)&&t[26].set("frame",e.minFps[0])},function(e,t,i,s,r,o){t[27][Symbol.for("props")].frame=e.minFps[0]},function(e,t,i,s,r,o){(typeof skip28>"u"||skip28.indexOf("frame")===-1)&&t[28].set("frame",e.minFps[1])},function(e,t,i,s,r,o){t[29][Symbol.for("props")].frame=e.minFps[1]},function(e,t,i,s,r,o){(typeof skip30>"u"||skip30.indexOf("frame")===-1)&&t[30].set("frame",e.minFps[2])},function(e,t,i,s,r,o){t[31][Symbol.for("props")].frame=e.minFps[2]},function(e,t,i,s,r,o){(typeof skip36>"u"||skip36.indexOf("frame")===-1)&&t[36].set("frame",e.maxFps[0])},function(e,t,i,s,r,o){t[37][Symbol.for("props")].frame=e.maxFps[0]},function(e,t,i,s,r,o){(typeof skip38>"u"||skip38.indexOf("frame")===-1)&&t[38].set("frame",e.maxFps[1])},function(e,t,i,s,r,o){t[39][Symbol.for("props")].frame=e.maxFps[1]},function(e,t,i,s,r,o){(typeof skip40>"u"||skip40.indexOf("frame")===-1)&&t[40].set("frame",e.maxFps[2])},function(e,t,i,s,r,o){t[41][Symbol.for("props")].frame=e.maxFps[2]}],context:{}},state(){return{image:n_,sprite:{defaults:{y:1,w:20,h:20},frames:{"-":{x:-1e3},0:{x:1},1:{x:23},2:{x:45},3:{x:67},4:{x:89},5:{x:111},6:{x:133},7:{x:155},8:{x:177},9:{x:199},avg:{x:221,w:48,h:25},fps:{x:271,w:43,h:25},max:{x:316,w:53,h:25},min:{x:371,w:47,h:25}}},fps:"---",avgFps:"---",minFps:"---",maxFps:"---"}},hooks:{ready(){}}}),a_=()=>({Circle:i_(),RouterView:s_(),Sprite:r_(),FPScounter:o_()}),l_={name:"log",plugin(){return ed("App")}},pl={log:l_},Ud=(n,e="",t={})=>{let i;if(typeof e=="object"?t=e:i=e,typeof n=="function"){if(i===void 0)throw Error("Error registering plugin: name is required for plugin");pl[i]={plugin:n,options:t}}else n.plugin&&Ud(n.plugin,i||n.name,t)};let Sa;const Sc=n=>{throw new Error(`Parameter ${n} is required`)},sr=(n=Sc("name"),e=Sc("config"))=>{let t;const i=function(r,o,a,l){this.componentId=vp(n),this[w.effects]=[],this.lifecycle=Object.assign(Object.create(Ip),{component:this,previous:null,current:null}),this.parent=a,this.rootParent=l,this[w.holder]=o,this[w.id]=Ep(),this[w.props]=Ja(r.props||{},gt.get("reactivityMode")),this[w.timeouts]=[],this[w.intervals]=[],this[w.originalState]=e.state&&typeof e.state=="function"&&e.state.apply(this)||{},this[w.originalState].hasFocus=!1,this[w.state]=Ja(this[w.originalState],gt.get("reactivityMode")),this.lifecycle.state="init",this[w.children]=e.code.render.apply(ql,[o,this,e,Sa,hn,is,ve])||[],this[w.wrapper]=this[w.children][0],this[w.slots]=this[w.children].filter(c=>c[w.isSlot]),e.hooks&&(e.hooks.frameTick&&xo.on("frameTick",(c,u)=>qa("frameTick",this[w.identifier],this,[u])),e.hooks.idle&&xo.on("idle",()=>{qa("idle",this[w.identifier],this)}),e.hooks.attach&&this[w.wrapper].node.on("inBounds",()=>{this.lifecycle.state="attach"}),e.hooks.detach&&this[w.wrapper].node.on("outOfBounds",(c,{previous:u})=>{u>0&&(this.lifecycle.state="detach")}),e.hooks.enter&&this[w.wrapper].node.on("inViewport",()=>{this.lifecycle.state="enter"}),e.hooks.exit&&this[w.wrapper].node.on("outOfViewport",()=>{this.lifecycle.state="exit"}));const h=e.code.effects;for(let c=0;c<h.length;c++){const u=()=>{h[c](this,this[w.children],e,Sa,l,hn)};this[w.effects].push(u),hn(u)}if(this[w.watchers]){const c=Object.keys(this[w.watchers]),u=c.length;for(let d=0;d<u;d++){let f=this,g=c[d];const p=g;if(g.indexOf(".")>-1){const T=g.split(".");g=T.pop();for(let S=0;S<T.length;S++)f=f[T[S]]}let m=this[g];const _=(T=!1)=>{const S=f[g];(m!==S||T===!0)&&(this[w.watchers][p].apply(this,[S,m]),m=S)};this[w.effects].push(_),hn(_)}}return setTimeout(()=>this.lifecycle.state="ready"),this},s=(r={},o,a,l)=>{if(Zi[w.launched]===!1){const h=Object.keys(pl),c=h.length,u={};for(let d=0;d<c;d++){const f=h[d],g=`$${f}`;g in Zi&&ve.warn(`"${f}" (this.${g}) already exists as a property or plugin on the Base Component. You may be overwriting built-in functionality. Proceed with care!`);const p=pl[f];u[g]={value:Object.defineProperties(p.plugin(p.options),Bd),writable:!1,enumerable:!0,configurable:!0}}Object.defineProperties(Zi,u);for(const d in u)Object.defineProperties(Zi[d],u),delete Zi[d][d];Sa=a_(),Zi[w.launched]=!0}return t===void 0&&(ve.debug(`Setting up ${n} component`),t=t_(Object.create(Zi),e)),e.code===void 0&&(ve.debug(`Generating code for ${n} component`),e.code=pp.call(e,gp(e.template))),i.call(Object.create(t),r,o,a,l)};return s[Symbol.for("config")]=e,s[w.isComponent]=!0,s},h_=n=>{const e={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Enter:"enter"," ":"space",Backspace:"back",Escape:"escape",37:"left",39:"right",38:"up",40:"down",13:"enter",32:"space",8:"back",27:"escape"};n.hooks=n.hooks||{};let t,i,s;return n.hooks[w.destroy]=function(){document.removeEventListener("keydown",t),document.removeEventListener("keyup",i)},n.hooks[w.init]=function(){this.$announcer.toggle(gt.get("announcer",!1));const r={...e,...gt.get("keymap",{})};t=async o=>{const a=r[o.key]||r[o.keyCode]||o.key||o.keyCode;this[w.inputEvents]!==void 0&&this[w.inputEvents].intercept!==void 0&&(o=await this[w.inputEvents].intercept.call(this,o),!(o instanceof KeyboardEvent))||(Us.input(a,o),clearTimeout(s),s=setTimeout(()=>{Us.hold=!0},gt.get("holdTimeout",Ed)))},i=o=>{const a=gl.get(o.code);a!==void 0&&typeof a=="function"&&(gl.delete(o.code),a()),clearTimeout(s),Us.hold=!1},document.addEventListener("keydown",t),document.addEventListener("keyup",i),setTimeout(()=>Us.set(this))},sr("App",n)},Jl={Component:sr,Application:h_,Launch:E0,Plugin:Ud};function c_(n,e){let t;return(...i)=>{t===void 0&&n(...i),window.clearTimeout(t),t=window.setTimeout(()=>{n(...i),t=void 0},e)}}const u_=Jl.Component("Icon",{props:["stageW","stageH"],computed:{iconSize(){return this.stageW,this.stageH,Math.max(this.stageW,this.stageH)}},code:{render:function(e,t,i,s,r,o,a){const l=[],h={};return l[0]=this.element({parent:e||"root"},t),h.src="assets/icon.png",h.w=t.iconSize,h.h=t.iconSize,h.x=t.stageW/2,h.y=t.stageH/2,h.mount=.5,l[0].populate(h),l},effects:[function(e,t,i,s,r,o){t[0].set("w",e.iconSize)},function(e,t,i,s,r,o){t[0].set("h",e.iconSize)},function(e,t,i,s,r,o){t[0].set("x",e.stageW/2)},function(e,t,i,s,r,o){t[0].set("y",e.stageH/2)},function(e,t,i,s,r,o){t[0].set("mount",.5)}],context:{}}}),_r={},yt={},d_=(n,e)=>{_r.app=n,_r.platform=e,_r.user={}},f_=(n,e)=>{yt[n]&&yt[n].forEach(t=>t(e))},g_=(n={},e)=>{if(n===null)return;const t=e.split(".");for(let i=0;i<t.length;i++)n=n[t[i]]=n[t[i]]!==void 0?n[t[i]]:{};return typeof n=="object"&&n!==null?Object.keys(n).length?n:void 0:n},It={get(n,e,t=void 0){const i=g_(_r[n],e);return i!==void 0?i:t},has(n,e){return!!this.get(n,e)},set(n,e){_r.user[n]=e,f_(n,e)},subscribe(n,e){yt[n]=yt[n]||[],yt[n].push(e)},unsubscribe(n,e){if(e){const t=yt[n]&&yt[n].findIndex(i=>i===e);t>-1&&yt[n].splice(t,1)}else n in yt&&(yt[n]=[])},clearSubscribers(){for(const n of Object.getOwnPropertyNames(yt))delete yt[n]}},vn=(n,e)=>{const t={Info:"green",Debug:"gray",Warn:"orange",Error:"red"};return e=Array.from(e),["%c"+(e.length>1&&typeof e[0]=="string"?e.shift():n),"background-color: "+t[n]+"; color: white; padding: 2px 4px; border-radius: 2px",e]},Te={info(){It.get("platform","log")&&console.log.apply(console,vn("Info",arguments))},debug(){It.get("platform","log")&&console.debug.apply(console,vn("Debug",arguments))},error(){It.get("platform","log")&&console.error.apply(console,vn("Error",arguments))},warn(){It.get("platform","log")&&console.warn.apply(console,vn("Warn",arguments))}};class ie{static mergeNumbers(e,t,i){return e*i+t*(1-i)}static rgb(e,t,i){return(e<<16)+(t<<8)+i+255*16777216}static rgba(e,t,i,s){return(e<<16)+(t<<8)+i+(s*255|0)*16777216}static getRgbString(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256;return"rgb("+t+","+i+","+s+")"}static getRgbaString(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256,r=(e/16777216|0)/255;return"rgba("+t+","+i+","+s+","+r.toFixed(4)+")"}static getRgbaStringFromArray(e){let t=Math.floor(e[0]*255),i=Math.floor(e[1]*255),s=Math.floor(e[2]*255),r=Math.floor(e[3]*255)/255;return"rgba("+t+","+i+","+s+","+r.toFixed(4)+")"}static getRgbaComponentsNormalized(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256,r=e/16777216|0;return[t/255,i/255,s/255,r/255]}static getRgbComponentsNormalized(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256;return[t/255,i/255,s/255]}static getRgbaComponents(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256,r=e/16777216|0;return[t,i,s,r]}static getArgbNumber(e){e[0]=Math.max(0,Math.min(255,e[0])),e[1]=Math.max(0,Math.min(255,e[1])),e[2]=Math.max(0,Math.min(255,e[2])),e[3]=Math.max(0,Math.min(255,e[3]));let t=((e[3]|0)<<24)+((e[0]|0)<<16)+((e[1]|0)<<8)+(e[2]|0);return t<0&&(t=4294967295+t+1),t}static mergeColors(e,t,i){let s=(e/65536|0)%256,r=(e/256|0)%256,o=e%256,a=e/16777216|0,l=(t/65536|0)%256,h=(t/256|0)%256,c=t%256,u=t/16777216|0,d=s*i+l*(1-i),f=r*i+h*(1-i),g=o*i+c*(1-i),p=a*i+u*(1-i);return Math.round(p)*16777216+Math.round(d)*65536+Math.round(f)*256+Math.round(g)}static mergeMultiColors(e,t){let i=0,s=0,r=0,o=0,a=0,l=e.length;for(let h=0;h<l;h++){let c=(e[h]/65536|0)%256,u=(e[h]/256|0)%256,d=e[h]%256,f=e[h]/16777216|0;i+=c*t[h],s+=u*t[h],r+=d*t[h],o+=f*t[h],a+=t[h]}return a=1/a,Math.round(o*a)*16777216+Math.round(i*a)*65536+Math.round(s*a)*256+Math.round(r*a)}static mergeMultiColorsEqual(e){let t=0,i=0,s=0,r=0,o=0,a=e.length;for(let l=0;l<a;l++){let h=(e[l]/65536|0)%256,c=(e[l]/256|0)%256,u=e[l]%256,d=e[l]/16777216|0;t+=h,i+=c,s+=u,r+=d,o+=1}return o=1/o,Math.round(r*o)*16777216+Math.round(t*o)*65536+Math.round(i*o)*256+Math.round(s*o)}static mergeColorAlpha(e,t){let i=(e/16777216|0)*t|0;return((e>>16&255)*i/255&255)+((e&65280)*i/255&65280)+(((e&255)<<16)*i/255&16711680)+(i<<24)}static rad(e){return e*(Math.PI/180)}static getTimingBezier(e,t,i,s){let r=3*e,o=3*(i-e)-r,a=1-r-o,l=3*t,h=3*(s-t)-l,c=1-l-h;return function(u){if(u>=1)return 1;if(u<=0)return 0;let d=.5,f,g,p;for(let T=0;T<20;T++){if(f=d*(d*(d*a+o)+r),p=u-f,p>-1e-8&&p<1e-8)return d*(d*(d*c+h)+l);if(g=d*(d*(3*a)+2*o)+r,g>1e-10&&g<1e-10)break;d+=p/g}let m=0,_=1;for(let T=0;T<20;T++){if(d=.5*(m+_),f=d*(d*(d*a+o)+r),p=u-f,p>-1e-8&&p<1e-8)return d*(d*(d*c+h)+l);p<0?_=d:m=d}}}static getTimingFunction(e){switch(e){case"linear":return function(i){return i};case"ease":return ie.getTimingBezier(.25,.1,.25,1);case"ease-in":return ie.getTimingBezier(.42,0,1,1);case"ease-out":return ie.getTimingBezier(0,0,.58,1);case"ease-in-out":return ie.getTimingBezier(.42,0,.58,1);case"step-start":return function(){return 1};case"step-end":return function(i){return i===1?1:0};default:let t="cubic-bezier(";if(e&&e.indexOf(t)===0){let i=e.substr(t.length,e.length-t.length-1).split(",");if(i.length!==4)return console.warn("[Lightning] Unknown timing function: "+e),function(l){return l};let s=parseFloat(i[0]),r=parseFloat(i[1]),o=parseFloat(i[2]),a=parseFloat(i[3]);return isNaN(s)||isNaN(r)||isNaN(o)||isNaN(a)?(console.warn("[Lightning] Unknown timing function: "+e),function(l){return l}):ie.getTimingBezier(s,r,o,a)}else return console.warn("[Lightning] Unknown timing function: "+e),function(i){return i}}}}let H=class ct{static isFunction(e){return typeof e=="function"}static isNumber(e){return typeof e=="number"}static isInteger(e){return typeof e=="number"&&e%1===0}static isBoolean(e){return e===!0||e===!1}static isString(e){return typeof e=="string"}static clone(e){return ct.isObjectLiteral(e)||Array.isArray(e)?ct.getDeepClone(e):e}static cloneObjShallow(e){let t=Object.keys(e),i={};for(let s=0;s<t.length;s++)i[t[s]]=e[t[s]];return i}static merge(e,t){let i=Object.keys(t);for(let s=0;s<i.length;s++)e[i[s]]=t[i[s]];return e}static isObject(e){let t=typeof e;return!!e&&(t==="object"||t==="function")}static isPlainObject(e){return!!e&&typeof e==="object"}static isObjectLiteral(e){return typeof e=="object"&&e&&e.constructor===Object}static getArrayIndex(e,t){return ct.getModuloIndex(e,t.length)}static getModuloIndex(e,t){if(t===0)return e;for(;e<0;)e+=Math.ceil(-e/t)*t;return e=e%t,e}static getDeepClone(e){let t,i;if(ct.isFunction(e))return e;if(Array.isArray(e)){i=[];let s=Object.keys(e);for(t=0;t<s.length;t++)i[s[t]]=ct.getDeepClone(e[s[t]]);return i}else if(ct.isObject(e)){i={};let s=Object.keys(e);for(t=0;t<s.length;t++)i[s[t]]=ct.getDeepClone(e[s[t]]);return i}else return e}static equalValues(e,t){return typeof e!=typeof t?!1:ct.isObjectLiteral(e)?ct.isObjectLiteral(t)&&ct.equalObjectLiterals(e,t):Array.isArray(e)?Array.isArray(t)&&ct.equalArrays(e,t):e===t}static equalObjectLiterals(e,t){let i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r=0,o=i.length;r<o;r++){const a=i[r],l=s[r];if(a!==l)return!1;const h=e[a],c=t[l];if(!ct.equalValues(h,c))return!1}return!0}static equalArrays(e,t){if(e.length!==t.length)return!1;for(let i=0,s=e.length;i<s;i++)if(!this.equalValues(e[i],t[i]))return!1;return!0}static setToArray(e){let t=[];return e.forEach(function(i){t.push(i)}),t}static iteratorToArray(e){let t=[],i=e.next();for(;!i.done;)t.push(i.value),i=e.next();return t}static isUcChar(e){return e>=65&&e<=90}};H.isWeb=typeof window<"u"&&typeof sparkscene>"u";H.isWPE=H.isWeb&&navigator.userAgent.indexOf("WPE")!==-1;H.isSpark=typeof sparkscene<"u";H.isNode=typeof window>"u"||H.isSpark;H.isPS4=H.isWeb&&navigator.userAgent.indexOf("PlayStation 4")!==-1;H.isZiggo=H.isWeb&&(navigator.userAgent.indexOf("EOSSTB")!==-1||navigator.userAgent.indexOf("HZNSTB")!==-1);class Xe{static defaultSetter(e,t,i){e[t]=i}static patchObject(e,t){if(!H.isObjectLiteral(t))console.error("[Lightning] Settings must be object literal");else{let i=Object.keys(t);for(let s=0,r=i.length;s<r;s++){let o=i[s];this.patchObjectProperty(e,o,t[o])}}}static patchObjectProperty(e,t,i){let s=e.setSetting||Xe.defaultSetter;t.charAt(0)==="_"?t!=="__create"&&console.error("[Lightning] Patch of private property '"+t+"' is not allowed"):t!=="type"&&(H.isFunction(i)&&i.__local&&(i=i.__local(e)),s(e,t,i))}static local(e){e.__local=!0}}class Nd{static getSpacing(e,t,i){const s=t-1;let r,o,a;switch(e){case"flex-start":o=0,a=0;break;case"flex-end":o=i,a=0;break;case"center":o=i/2,a=0;break;case"space-between":o=0,a=Math.max(0,i)/s;break;case"space-around":if(i<0)return this.getSpacing("center",t,i);r=i/(s+1),o=.5*r,a=r;break;case"space-evenly":if(i<0)return this.getSpacing("center",t,i);r=i/(s+2),o=r,a=r;break;case"stretch":o=0,a=0;break;default:throw new Error("Unknown mode: "+e)}return{spacingBefore:o,spacingBetween:a}}}class p_{constructor(e){this._layout=e,this._totalCrossAxisSize=0}get _lines(){return this._layout._lines}init(){this._totalCrossAxisSize=this._getTotalCrossAxisSize()}align(){const t=this._layout.crossAxisSize-this._totalCrossAxisSize,{spacingBefore:i,spacingBetween:s}=this._getSpacing(t),r=this._lines,o=this._layout._flexContainer.alignContent;let a=0;o==="stretch"&&r.length&&t>0&&(a=t/r.length);let l=i;for(let h=0,c=r.length;h<c;h++){const u=l,d=r[h].createItemAligner();let f=r[h].crossAxisLayoutSize+a;d.setCrossAxisLayoutSize(f),d.setCrossAxisLayoutOffset(u),d.align(),d.recursiveResizeOccured&&r[h].setItemPositions(),l+=f,l+=s}}get totalCrossAxisSize(){return this._totalCrossAxisSize}_getTotalCrossAxisSize(){const e=this._lines;let t=0;for(let i=0,s=e.length;i<s;i++){const r=e[i];t+=r.crossAxisLayoutSize}return t}_getSpacing(e){const t=this._layout._flexContainer.alignContent,i=this._lines.length;return Nd.getSpacing(t,i,e)}}class ae{static getParentAxisSizeWithPadding(e,t){const s=e.target.getParent();if(s){const r=e.flexParent;return r?this.getAxisLayoutSize(r,t)+this.getTotalPadding(r,t):t?s.w:s.h}else return 0}static getRelAxisSize(e,t){return t?e.funcW?this._allowRelAxisSizeFunction(e,!0)?e.funcW(this.getParentAxisSizeWithPadding(e,!0)):0:e.originalWidth:e.funcH?this._allowRelAxisSizeFunction(e,!1)?e.funcH(this.getParentAxisSizeWithPadding(e,!1)):0:e.originalHeight}static _allowRelAxisSizeFunction(e,t){const i=e.flexParent;return!(i&&i._flex._layout.isAxisFitToContents(t))}static isZeroAxisSize(e,t){return t?!e.originalWidth&&!e.funcW:!e.originalHeight&&!e.funcH}static getAxisLayoutPos(e,t){return t?e.x:e.y}static getAxisLayoutSize(e,t){return t?e.w:e.h}static setAxisLayoutPos(e,t,i){t?e.x=i:e.y=i}static setAxisLayoutSize(e,t,i){t?e.w=i:e.h=i}static getAxisMinSize(e,t){let i=this.getPlainAxisMinSize(e,t),s=0;return e.isFlexItemEnabled()&&(s=e._flexItem._getMinSizeSetting(t)),s>0&&(i=Math.max(i,s)),i}static getPlainAxisMinSize(e,t){return e.isFlexEnabled()?e._flex._layout.getAxisMinSize(t):e.flexItem.shrink!==0?0:this.getRelAxisSize(e,t)}static resizeAxis(e,t,i){e.isFlexEnabled()?e._flex._horizontal===t?e._flex._layout.resizeMainAxis(i):e._flex._layout.resizeCrossAxis(i):this.setAxisLayoutSize(e,t,i)}static getPaddingOffset(e,t){if(e.isFlexEnabled()){const i=e._flex;return t?i.paddingLeft:i.paddingTop}else return 0}static getTotalPadding(e,t){if(e.isFlexEnabled()){const i=e._flex;return t?i.paddingRight+i.paddingLeft:i.paddingTop+i.paddingBottom}else return 0}static getMarginOffset(e,t){const i=e.flexItem;return i?t?i.marginLeft:i.marginTop:0}static getTotalMargin(e,t){const i=e.flexItem;return i?t?i.marginRight+i.marginLeft:i.marginTop+i.marginBottom:0}}class m_{constructor(e){this._line=e,this._amountRemaining=0,this._shrunkSize=0}shrink(e){this._shrunkSize=0,this._amountRemaining=e;let t=this._getTotalShrinkAmount();if(t){const i=this._line.items;do{let s=this._amountRemaining/t;for(let r=this._line.startIndex;r<=this._line.endIndex;r++){const a=i[r].flexItem,l=a.shrink;if(l>0){let c=l*s;const u=a._getMainAxisMinSize(),d=a._getMainAxisLayoutSize();if(d>u){const f=d-u;c>=f&&(c=f,t-=l);const p=d-c;if(a._resizeMainAxis(p),this._shrunkSize+=c,this._amountRemaining-=c,Math.abs(this._amountRemaining)<1e-5)return}}}}while(t&&Math.abs(this._amountRemaining)>1e-5)}}_getTotalShrinkAmount(){let e=0;const t=this._line.items;for(let i=this._line.startIndex;i<=this._line.endIndex;i++){const r=t[i].flexItem;if(r.shrink){const o=r._getMainAxisMinSize();r._getMainAxisLayoutSize()>o&&(e+=r.shrink)}}return e}getShrunkSize(){return this._shrunkSize}}class __{constructor(e){this._line=e,this._amountRemaining=0,this._grownSize=0}grow(e){this._grownSize=0,this._amountRemaining=e;let t=this._getTotalGrowAmount();if(t){const i=this._line.items;do{let s=this._amountRemaining/t;for(let r=this._line.startIndex;r<=this._line.endIndex;r++){const a=i[r].flexItem,l=a.grow;if(l>0){let c=l*s;const u=a._getMainAxisMaxSizeSetting(),d=a._getMainAxisLayoutSize();if(u>0)if(d>=u)c=0;else{const f=u-d;c>=f&&(c=f,t-=l)}if(c>0){const f=d+c;if(a._resizeMainAxis(f),this._grownSize+=c,this._amountRemaining-=c,Math.abs(this._amountRemaining)<1e-5)return}}}}while(t&&Math.abs(this._amountRemaining)>1e-5)}}_getTotalGrowAmount(){let e=0;const t=this._line.items;for(let i=this._line.startIndex;i<=this._line.endIndex;i++){const r=t[i].flexItem;if(r.grow){const o=r._getMainAxisMaxSizeSetting(),a=r._getMainAxisLayoutSize();(o===0||a<o)&&(e+=r.grow)}}return e}getGrownSize(){return this._grownSize}}class x_{constructor(e){this._line=e}get _layout(){return this._line._layout}position(){const{spacingBefore:e,spacingBetween:t}=this._getSpacing();let i=e;const s=this._line.items;for(let r=this._line.startIndex;r<=this._line.endIndex;r++){const o=s[r];o.flexItem._setMainAxisLayoutPos(i),i+=o.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin(),i+=t}}_getSpacing(){const e=this._line._availableSpace;let t=this._layout._flexContainer.justifyContent;const i=this._line.numberOfItems;return Nd.getSpacing(t,i,e)}}class y_{constructor(e){this._line=e,this._crossAxisLayoutSize=0,this._crossAxisLayoutOffset=0,this._alignItemsSetting=null,this._recursiveResizeOccured=!1,this._isCrossAxisFitToContents=!1}get _layout(){return this._line._layout}get _flexContainer(){return this._layout._flexContainer}setCrossAxisLayoutSize(e){this._crossAxisLayoutSize=e}setCrossAxisLayoutOffset(e){this._crossAxisLayoutOffset=e}align(){this._alignItemsSetting=this._flexContainer.alignItems,this._isCrossAxisFitToContents=this._layout.isAxisFitToContents(!this._flexContainer._horizontal),this._recursiveResizeOccured=!1;const e=this._line.items;for(let t=this._line.startIndex;t<=this._line.endIndex;t++){const i=e[t];this._alignItem(i)}}get recursiveResizeOccured(){return this._recursiveResizeOccured}_alignItem(e){const t=e.flexItem;let i=t.alignSelf||this._alignItemsSetting;switch(i==="stretch"&&this._preventStretch(t)&&(i="flex-start"),i!=="stretch"&&!this._isCrossAxisFitToContents&&t._hasRelCrossAxisSize()&&t._resetCrossAxisLayoutSize(),i){case"flex-start":this._alignItemFlexStart(t);break;case"flex-end":this._alignItemFlexEnd(t);break;case"center":this._alignItemFlexCenter(t);break;case"stretch":this._alignItemStretch(t);break}}_alignItemFlexStart(e){e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset)}_alignItemFlexEnd(e){const t=e._getCrossAxisLayoutSizeWithPaddingAndMargin();e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset+(this._crossAxisLayoutSize-t))}_alignItemFlexCenter(e){const t=e._getCrossAxisLayoutSizeWithPaddingAndMargin(),i=(this._crossAxisLayoutSize-t)/2;e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset+i)}_alignItemStretch(e){e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset);const t=e._getMainAxisLayoutSize();let i=this._crossAxisLayoutSize-e._getCrossAxisMargin()-e._getCrossAxisPadding();const s=e._getCrossAxisMinSizeSetting();s>0&&(i=Math.max(i,s));const r=e._getCrossAxisMaxSizeSetting();r>0&&(i=Math.min(i,r)),e._resizeCrossAxis(i),e._getMainAxisLayoutSize()!==t&&(this._recursiveResizeOccured=!0)}_preventStretch(e){const t=e._hasFixedCrossAxisSize(),i=e.alignSelf==="stretch";return t&&!i}}class T_{constructor(e,t,i,s){this._layout=e,this.items=e.items,this.startIndex=t,this.endIndex=i,this._availableSpace=s}performLayout(){this._setItemSizes(),this.setItemPositions(),this._calcLayoutInfo()}_setItemSizes(){this._availableSpace>0?this._growItemSizes(this._availableSpace):this._availableSpace<0&&this._shrinkItemSizes(-this._availableSpace)}_growItemSizes(e){const t=new __(this);t.grow(e),this._availableSpace-=t.getGrownSize()}_shrinkItemSizes(e){const t=new m_(this);t.shrink(e),this._availableSpace+=t.getShrunkSize()}setItemPositions(){new x_(this).position()}createItemAligner(){return new y_(this)}_calcLayoutInfo(){this._calcCrossAxisMaxLayoutSize()}getMainAxisMinSize(){let e=0;for(let t=this.startIndex;t<=this.endIndex;t++){const i=this.items[t];e+=i.flexItem._getMainAxisMinSizeWithPaddingAndMargin()}return e}get numberOfItems(){return this.endIndex-this.startIndex+1}get crossAxisLayoutSize(){const e=this._layout.isCrossAxisFitToContents()&&!this._layout.resizingCrossAxis;return this._layout.isWrapping()||e?this._crossAxisMaxLayoutSize:this._layout.crossAxisSize}_calcCrossAxisMaxLayoutSize(){this._crossAxisMaxLayoutSize=this._getCrossAxisMaxLayoutSize()}_getCrossAxisMaxLayoutSize(){let e=0;for(let t=this.startIndex;t<=this.endIndex;t++){const i=this.items[t];e=Math.max(e,i.flexItem._getCrossAxisLayoutSizeWithPaddingAndMargin())}return e}}class S_{constructor(e){this._layout=e,this._mainAxisMinSize=-1,this._crossAxisMinSize=-1,this._mainAxisContentSize=0}get lines(){return this._lines}get mainAxisMinSize(){return this._mainAxisMinSize===-1&&(this._mainAxisMinSize=this._getMainAxisMinSize()),this._mainAxisMinSize}get crossAxisMinSize(){return this._crossAxisMinSize===-1&&(this._crossAxisMinSize=this._getCrossAxisMinSize()),this._crossAxisMinSize}get mainAxisContentSize(){return this._mainAxisContentSize}layoutLines(){this._setup();const e=this._layout.items,t=this._layout.isWrapping();let i=0,s;const r=e.length;for(s=0;s<r;s++){const o=e[s];this._layoutFlexItem(o);const a=o.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin();t&&s>i&&this._curMainAxisPos+a>this._mainAxisSize&&(this._layoutLine(i,s-1),this._curMainAxisPos=0,i=s),this._addToMainAxisPos(a)}i<s&&this._layoutLine(i,s-1)}_layoutFlexItem(e){e.isFlexEnabled()?e.flexLayout.updateTreeLayout():e.flexItem._resetLayoutSize()}_setup(){this._mainAxisSize=this._layout.mainAxisSize,this._curMainAxisPos=0,this._maxMainAxisPos=0,this._lines=[],this._mainAxisMinSize=-1,this._crossAxisMinSize=-1,this._mainAxisContentSize=0}_addToMainAxisPos(e){this._curMainAxisPos+=e,this._curMainAxisPos>this._maxMainAxisPos&&(this._maxMainAxisPos=this._curMainAxisPos)}_layoutLine(e,t){const i=this._getAvailableMainAxisLayoutSpace(),s=new T_(this._layout,e,t,i);s.performLayout(),this._lines.push(s),(this._mainAxisContentSize===0||this._curMainAxisPos>this._mainAxisContentSize)&&(this._mainAxisContentSize=this._curMainAxisPos)}_getAvailableMainAxisLayoutSpace(){return!this._layout.resizingMainAxis&&this._layout.isMainAxisFitToContents()?0:this._mainAxisSize-this._curMainAxisPos}_getCrossAxisMinSize(){let e=0;const t=this._layout.items;for(let i=0,s=t.length;i<s;i++){const o=t[i].flexItem._getCrossAxisMinSizeWithPaddingAndMargin();e=Math.max(e,o)}return e}_getMainAxisMinSize(){return this._lines.length===1?this._lines[0].getMainAxisMinSize():this._layout.mainAxisSize}}class To{constructor(e){this._layout=e,this._isReverse=this._flexContainer._reverse,this._horizontalPaddingOffset=this._layout._getHorizontalPaddingOffset(),this._verticalPaddingOffset=this._layout._getVerticalPaddingOffset()}get _flexContainer(){return this._layout._flexContainer}finalize(){const e=this._layout.getParentFlexContainer();e?new To(e._layout)._finalizeItemAndChildren(this._flexContainer.item):(this._finalizeRoot(),this._finalizeItems())}_finalizeRoot(){const e=this._flexContainer.item;let t=ae.getAxisLayoutPos(e,!0),i=ae.getAxisLayoutPos(e,!1),s=ae.getAxisLayoutSize(e,!0),r=ae.getAxisLayoutSize(e,!1);s+=this._layout._getHorizontalPadding(),r+=this._layout._getVerticalPadding(),e.clearRecalcFlag(),e.setLayout(t,i,s,r)}_finalizeItems(){const e=this._layout.items;for(let t=0,i=e.length;t<i;t++){const s=e[t],r=this._validateItemCache(s);this._finalizeItem(s),r||this._finalizeItemChildren(s)}}_validateItemCache(e){if(e.recalc===0&&e.isFlexEnabled()){const t=e._flex._layout;if(e.w===e.target.w&&e.h===e.target.h)return!0;{const s=t.crossAxisSize;t.performResizeMainAxis(t.mainAxisSize),t.performResizeCrossAxis(s)}}return!1}_finalizeItemAndChildren(e){this._finalizeItem(e),this._finalizeItemChildren(e)}_finalizeItem(e){this._isReverse&&this._reverseMainAxisLayoutPos(e);let t=ae.getAxisLayoutPos(e,!0),i=ae.getAxisLayoutPos(e,!1),s=ae.getAxisLayoutSize(e,!0),r=ae.getAxisLayoutSize(e,!1);t+=this._horizontalPaddingOffset,i+=this._verticalPaddingOffset,e.flex&&(s+=e._flex._layout._getHorizontalPadding(),r+=e._flex._layout._getVerticalPadding());const a=e.flexItem;a&&(t+=a._getHorizontalMarginOffset(),i+=a._getVerticalMarginOffset()),e.clearRecalcFlag(),e.setLayout(t,i,s,r)}_finalizeItemChildren(e){const t=e._flex;t&&new To(t._layout)._finalizeItems()}_reverseMainAxisLayoutPos(e){const t=e.flexItem._getMainAxisLayoutPos()+e.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin(),i=this._layout.mainAxisSize-t;e.flexItem._setMainAxisLayoutPos(i)}}class v_{constructor(e){this._flexContainer=e,this._lineLayouter=new S_(this),this._resizingMainAxis=!1,this._resizingCrossAxis=!1,this._cachedMainAxisSizeAfterLayout=0,this._cachedCrossAxisSizeAfterLayout=0,this._shrunk=!1}get shrunk(){return this._shrunk}get recalc(){return this.item.recalc}layoutTree(){this.item.flexParent!==null?this._updateSubTreeLayout():this.updateTreeLayout(),this.updateItemCoords()}updateTreeLayout(){this.recalc?this._performUpdateLayoutTree():this._performUpdateLayoutTreeFromCache()}_performUpdateLayoutTree(){this._setInitialAxisSizes(),this._layoutAxes(),this._refreshLayoutCache()}_refreshLayoutCache(){this._cachedMainAxisSizeAfterLayout=this.mainAxisSize,this._cachedCrossAxisSizeAfterLayout=this.crossAxisSize}_performUpdateLayoutTreeFromCache(){this.item.funcW||this.item.funcH?(this.item.enableLocalRecalcFlag(),this._performUpdateLayoutTree()):(this.mainAxisSize=this._cachedMainAxisSizeAfterLayout,this.crossAxisSize=this._cachedCrossAxisSizeAfterLayout)}updateItemCoords(){new To(this).finalize()}_updateSubTreeLayout(){const e=this.crossAxisSize;this._layoutMainAxis(),this.performResizeCrossAxis(e)}_setInitialAxisSizes(){this.item.isFlexItemEnabled()?this.item.flexItem._resetLayoutSize():(this.mainAxisSize=this._getMainAxisBasis(),this.crossAxisSize=this._getCrossAxisBasis()),this._resizingMainAxis=!1,this._resizingCrossAxis=!1,this._shrunk=!1}_layoutAxes(){this._layoutMainAxis(),this._layoutCrossAxis()}_layoutMainAxis(){this._layoutLines(),this._fitMainAxisSizeToContents()}_layoutLines(){this._lineLayouter.layoutLines()}get _lines(){return this._lineLayouter.lines}_fitMainAxisSizeToContents(){this._resizingMainAxis||this.isMainAxisFitToContents()&&(this.mainAxisSize=this._lineLayouter.mainAxisContentSize)}_layoutCrossAxis(){const e=new p_(this);e.init(),this._totalCrossAxisSize=e.totalCrossAxisSize,this._fitCrossAxisSizeToContents(),e.align()}_fitCrossAxisSizeToContents(){this._resizingCrossAxis||this.isCrossAxisFitToContents()&&(this.crossAxisSize=this._totalCrossAxisSize)}isWrapping(){return this._flexContainer.wrap}isAxisFitToContents(e){return this._horizontal===e?this.isMainAxisFitToContents():this.isCrossAxisFitToContents()}isMainAxisFitToContents(){return!this.isWrapping()&&!this._hasFixedMainAxisBasis()}isCrossAxisFitToContents(){return!this._hasFixedCrossAxisBasis()}_hasFixedMainAxisBasis(){return!ae.isZeroAxisSize(this.item,this._horizontal)}_hasFixedCrossAxisBasis(){return!ae.isZeroAxisSize(this.item,!this._horizontal)}getAxisMinSize(e){return this._horizontal===e?this._getMainAxisMinSize():this._getCrossAxisMinSize()}_getMainAxisMinSize(){return this._lineLayouter.mainAxisMinSize}_getCrossAxisMinSize(){return this._lineLayouter.crossAxisMinSize}resizeMainAxis(e){this.mainAxisSize!==e&&(this.recalc>0?this.performResizeMainAxis(e):this._checkValidCacheMainAxisResize()?(this.mainAxisSize=e,this._fitCrossAxisSizeToContents()):(this.item.enableLocalRecalcFlag(),this.performResizeMainAxis(e)))}_checkValidCacheMainAxisResize(e){return e===this.targetMainAxisSize||!this.isCrossAxisFitToContents()}performResizeMainAxis(e){const t=e<this.mainAxisSize;this._shrunk=t,this.mainAxisSize=e,this._resizingMainAxis=!0,this._layoutAxes(),this._resizingMainAxis=!1}resizeCrossAxis(e){this.crossAxisSize!==e&&(this.recalc>0?this.performResizeCrossAxis(e):this.crossAxisSize=e)}performResizeCrossAxis(e){this.crossAxisSize=e,this._resizingCrossAxis=!0,this._layoutCrossAxis(),this._resizingCrossAxis=!1}get targetMainAxisSize(){return this._horizontal?this.item.target.w:this.item.target.h}get targetCrossAxisSize(){return this._horizontal?this.item.target.h:this.item.target.w}getParentFlexContainer(){return this.item.isFlexItemEnabled()?this.item.flexItem.ctr:null}_getHorizontalPadding(){return ae.getTotalPadding(this.item,!0)}_getVerticalPadding(){return ae.getTotalPadding(this.item,!1)}_getHorizontalPaddingOffset(){return ae.getPaddingOffset(this.item,!0)}_getVerticalPaddingOffset(){return ae.getPaddingOffset(this.item,!1)}_getMainAxisBasis(){return ae.getRelAxisSize(this.item,this._horizontal)}_getCrossAxisBasis(){return ae.getRelAxisSize(this.item,!this._horizontal)}get _horizontal(){return this._flexContainer._horizontal}get _reverse(){return this._flexContainer._reverse}get item(){return this._flexContainer.item}get items(){return this.item.items}get resizingMainAxis(){return this._resizingMainAxis}get resizingCrossAxis(){return this._resizingCrossAxis}get numberOfItems(){return this.items.length}get mainAxisSize(){return ae.getAxisLayoutSize(this.item,this._horizontal)}get crossAxisSize(){return ae.getAxisLayoutSize(this.item,!this._horizontal)}set mainAxisSize(e){ae.setAxisLayoutSize(this.item,this._horizontal,e)}set crossAxisSize(e){ae.setAxisLayoutSize(this.item,!this._horizontal,e)}}class ut{constructor(e){this._item=e,this._layout=new v_(this),this._horizontal=!0,this._reverse=!1,this._wrap=!1,this._alignItems="stretch",this._justifyContent="flex-start",this._alignContent="flex-start",this._paddingLeft=0,this._paddingTop=0,this._paddingRight=0,this._paddingBottom=0}get item(){return this._item}_changedDimensions(){this._item.changedDimensions()}_changedContents(){this._item.changedContents()}get direction(){return(this._horizontal?"row":"column")+(this._reverse?"-reverse":"")}set direction(e){this.direction!==e&&(this._horizontal=e==="row"||e==="row-reverse",this._reverse=e==="row-reverse"||e==="column-reverse",this._changedContents())}set wrap(e){this._wrap=e,this._changedContents()}get wrap(){return this._wrap}get alignItems(){return this._alignItems}set alignItems(e){if(this._alignItems!==e){if(ut.ALIGN_ITEMS.indexOf(e)===-1)throw new Error("Unknown alignItems, options: "+ut.ALIGN_ITEMS.join(","));this._alignItems=e,this._changedContents()}}get alignContent(){return this._alignContent}set alignContent(e){if(this._alignContent!==e){if(ut.ALIGN_CONTENT.indexOf(e)===-1)throw new Error("Unknown alignContent, options: "+ut.ALIGN_CONTENT.join(","));this._alignContent=e,this._changedContents()}}get justifyContent(){return this._justifyContent}set justifyContent(e){if(this._justifyContent!==e){if(ut.JUSTIFY_CONTENT.indexOf(e)===-1)throw new Error("Unknown justifyContent, options: "+ut.JUSTIFY_CONTENT.join(","));this._justifyContent=e,this._changedContents()}}set padding(e){this.paddingLeft=e,this.paddingTop=e,this.paddingRight=e,this.paddingBottom=e}get padding(){return this.paddingLeft}set paddingLeft(e){this._paddingLeft=e,this._changedDimensions()}get paddingLeft(){return this._paddingLeft}set paddingTop(e){this._paddingTop=e,this._changedDimensions()}get paddingTop(){return this._paddingTop}set paddingRight(e){this._paddingRight=e,this._changedDimensions()}get paddingRight(){return this._paddingRight}set paddingBottom(e){this._paddingBottom=e,this._changedDimensions()}get paddingBottom(){return this._paddingBottom}patch(e){Xe.patchObject(this,e)}}ut.ALIGN_ITEMS=["flex-start","flex-end","center","stretch"];ut.ALIGN_CONTENT=["flex-start","flex-end","center","space-between","space-around","space-evenly","stretch"];ut.JUSTIFY_CONTENT=["flex-start","flex-end","center","space-between","space-around","space-evenly"];class Lr{constructor(e){this._ctr=null,this._item=e,this._grow=0,this._shrink=Lr.SHRINK_AUTO,this._alignSelf=void 0,this._minWidth=0,this._minHeight=0,this._maxWidth=0,this._maxHeight=0,this._marginLeft=0,this._marginTop=0,this._marginRight=0,this._marginBottom=0}get item(){return this._item}get grow(){return this._grow}set grow(e){this._grow!==e&&(this._grow=parseInt(e)||0,this._changed())}get shrink(){return this._shrink===Lr.SHRINK_AUTO?this._getDefaultShrink():this._shrink}_getDefaultShrink(){return this.item.isFlexEnabled()?1:0}set shrink(e){this._shrink!==e&&(this._shrink=parseInt(e)||0,this._changed())}get alignSelf(){return this._alignSelf}set alignSelf(e){if(this._alignSelf!==e){if(e===void 0)this._alignSelf=void 0;else{if(ut.ALIGN_ITEMS.indexOf(e)===-1)throw new Error("Unknown alignSelf, options: "+ut.ALIGN_ITEMS.join(","));this._alignSelf=e}this._changed()}}get minWidth(){return this._minWidth}set minWidth(e){this._minWidth=Math.max(0,e),this._item.changedDimensions(!0,!1)}get minHeight(){return this._minHeight}set minHeight(e){this._minHeight=Math.max(0,e),this._item.changedDimensions(!1,!0)}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth=Math.max(0,e),this._item.changedDimensions(!0,!1)}get maxHeight(){return this._maxHeight}set maxHeight(e){this._maxHeight=Math.max(0,e),this._item.changedDimensions(!1,!0)}set margin(e){this.marginLeft=e,this.marginTop=e,this.marginRight=e,this.marginBottom=e}get margin(){return this.marginLeft}set marginLeft(e){this._marginLeft=e,this._changed()}get marginLeft(){return this._marginLeft}set marginTop(e){this._marginTop=e,this._changed()}get marginTop(){return this._marginTop}set marginRight(e){this._marginRight=e,this._changed()}get marginRight(){return this._marginRight}set marginBottom(e){this._marginBottom=e,this._changed()}get marginBottom(){return this._marginBottom}_changed(){this.ctr&&this.ctr._changedContents()}set ctr(e){this._ctr=e}get ctr(){return this._ctr}patch(e){Xe.patchObject(this,e)}_resetLayoutSize(){this._resetHorizontalAxisLayoutSize(),this._resetVerticalAxisLayoutSize()}_resetCrossAxisLayoutSize(){this.ctr._horizontal?this._resetVerticalAxisLayoutSize():this._resetHorizontalAxisLayoutSize()}_resetHorizontalAxisLayoutSize(){let e=ae.getRelAxisSize(this.item,!0);this._minWidth&&(e=Math.max(this._minWidth,e)),this._maxWidth&&(e=Math.min(this._maxWidth,e)),ae.setAxisLayoutSize(this.item,!0,e)}_resetVerticalAxisLayoutSize(){let e=ae.getRelAxisSize(this.item,!1);this._minHeight&&(e=Math.max(this._minHeight,e)),this._maxHeight&&(e=Math.min(this._maxHeight,e)),ae.setAxisLayoutSize(this.item,!1,e)}_getCrossAxisMinSizeSetting(){return this._getMinSizeSetting(!this.ctr._horizontal)}_getCrossAxisMaxSizeSetting(){return this._getMaxSizeSetting(!this.ctr._horizontal)}_getMainAxisMaxSizeSetting(){return this._getMaxSizeSetting(this.ctr._horizontal)}_getMinSizeSetting(e){return e?this._minWidth:this._minHeight}_getMaxSizeSetting(e){return e?this._maxWidth:this._maxHeight}_getMainAxisMinSize(){return ae.getAxisMinSize(this.item,this.ctr._horizontal)}_getCrossAxisMinSize(){return ae.getAxisMinSize(this.item,!this.ctr._horizontal)}_getMainAxisLayoutSize(){return ae.getAxisLayoutSize(this.item,this.ctr._horizontal)}_getMainAxisLayoutPos(){return ae.getAxisLayoutPos(this.item,this.ctr._horizontal)}_setMainAxisLayoutPos(e){return ae.setAxisLayoutPos(this.item,this.ctr._horizontal,e)}_setCrossAxisLayoutPos(e){return ae.setAxisLayoutPos(this.item,!this.ctr._horizontal,e)}_getCrossAxisLayoutSize(){return ae.getAxisLayoutSize(this.item,!this.ctr._horizontal)}_resizeCrossAxis(e){return ae.resizeAxis(this.item,!this.ctr._horizontal,e)}_resizeMainAxis(e){return ae.resizeAxis(this.item,this.ctr._horizontal,e)}_getMainAxisPadding(){return ae.getTotalPadding(this.item,this.ctr._horizontal)}_getCrossAxisPadding(){return ae.getTotalPadding(this.item,!this.ctr._horizontal)}_getMainAxisMargin(){return ae.getTotalMargin(this.item,this.ctr._horizontal)}_getCrossAxisMargin(){return ae.getTotalMargin(this.item,!this.ctr._horizontal)}_getHorizontalMarginOffset(){return ae.getMarginOffset(this.item,!0)}_getVerticalMarginOffset(){return ae.getMarginOffset(this.item,!1)}_getMainAxisMinSizeWithPaddingAndMargin(){return this._getMainAxisMinSize()+this._getMainAxisPadding()+this._getMainAxisMargin()}_getCrossAxisMinSizeWithPaddingAndMargin(){return this._getCrossAxisMinSize()+this._getCrossAxisPadding()+this._getCrossAxisMargin()}_getMainAxisLayoutSizeWithPaddingAndMargin(){return this._getMainAxisLayoutSize()+this._getMainAxisPadding()+this._getMainAxisMargin()}_getCrossAxisLayoutSizeWithPaddingAndMargin(){return this._getCrossAxisLayoutSize()+this._getCrossAxisPadding()+this._getCrossAxisMargin()}_hasFixedCrossAxisSize(){return!ae.isZeroAxisSize(this.item,!this.ctr._horizontal)}_hasRelCrossAxisSize(){return!!(this.ctr._horizontal?this.item.funcH:this.item.funcW)}}Lr.SHRINK_AUTO=-1;class E_{constructor(e){this._target=e,this._recalc=0,this._enabled=!1,this.x=0,this.y=0,this.w=0,this.h=0,this._originalX=0,this._originalY=0,this._originalWidth=0,this._originalHeight=0,this._flex=null,this._flexItem=null,this._flexItemDisabled=!1,this._items=null}get flexLayout(){return this.flex?this.flex._layout:null}layoutFlexTree(){this.isFlexEnabled()&&this.isChanged()&&this.flexLayout.layoutTree()}get target(){return this._target}get flex(){return this._flex}set flex(e){e?(this.isFlexEnabled()||this._enableFlex(),this._flex.patch(e)):this.isFlexEnabled()&&this._disableFlex()}get flexItem(){return this._flexItemDisabled?!1:(this._ensureFlexItem(),this._flexItem)}set flexItem(e){if(e===!1){if(!this._flexItemDisabled){const t=this.flexParent;this._flexItemDisabled=!0,this._checkEnabled(),t&&(t._clearFlexItemsCache(),t.changedContents())}}else if(this._ensureFlexItem(),this._flexItem.patch(e),this._flexItemDisabled){this._flexItemDisabled=!1,this._checkEnabled();const t=this.flexParent;t&&(t._clearFlexItemsCache(),t.changedContents())}}_enableFlex(){this._flex=new ut(this),this._checkEnabled(),this.changedDimensions(),this._enableChildrenAsFlexItems()}_disableFlex(){this.changedDimensions(),this._flex=null,this._checkEnabled(),this._disableChildrenAsFlexItems()}_enableChildrenAsFlexItems(){const e=this._target._children;if(e)for(let t=0,i=e.length;t<i;t++)e[t].layout._enableFlexItem()}_disableChildrenAsFlexItems(){const e=this._target._children;if(e)for(let t=0,i=e.length;t<i;t++)e[t].layout._disableFlexItem()}_enableFlexItem(){if(this._ensureFlexItem(),this._target._parent){const e=this._target._parent._layout;this._flexItem.ctr=e._flex,e.changedContents()}this._checkEnabled()}_disableFlexItem(){this._flexItem&&(this._flexItem.ctr=null),this._checkEnabled(),this._resetOffsets()}_resetOffsets(){this.x=0,this.y=0}_ensureFlexItem(){this._flexItem||(this._flexItem=new Lr(this))}_checkEnabled(){const e=this.isEnabled();this._enabled!==e&&(e?this._enable():this._disable(),this._enabled=e)}_enable(){this._setupTargetForFlex(),this._target.enableFlexLayout()}_disable(){this._restoreTargetToNonFlex(),this._target.disableFlexLayout()}isEnabled(){return this.isFlexEnabled()||this.isFlexItemEnabled()}isFlexEnabled(){return this._flex!==null}isFlexItemEnabled(){return this.flexParent!==null}_restoreTargetToNonFlex(){const e=this._target;e.x=this._originalX,e.y=this._originalY,e.setDimensions(this._originalWidth,this._originalHeight)}_setupTargetForFlex(){const e=this._target;this._originalX=e._x,this._originalY=e._y,this._originalWidth=e._w,this._originalHeight=e._h}setParent(e,t){e&&e.isFlexContainer()&&e._layout._changedChildren(),t&&t.isFlexContainer()&&(this._enableFlexItem(),t._layout._changedChildren()),this._checkEnabled()}get flexParent(){if(this._flexItemDisabled)return null;const e=this._target._parent;return e&&e.isFlexContainer()?e._layout:null}setVisible(e){const t=this.flexParent;t&&t._changedChildren()}get items(){return this._items||(this._items=this._getFlexItems()),this._items}_getFlexItems(){const e=[],t=this._target._children;if(t)for(let i=0,s=t.length;i<s;i++){const r=t[i];r.visible&&r.isFlexItem()&&e.push(r.layout)}return e}_changedChildren(){this._clearFlexItemsCache(),this.changedContents()}_clearFlexItemsCache(){this._items=null}setLayout(e,t,i,s){let r=this._originalX,o=this._originalY;this.funcX&&(r=this.funcX(ae.getParentAxisSizeWithPadding(this,!0))),this.funcY&&(o=this.funcY(ae.getParentAxisSizeWithPadding(this,!1))),this.isFlexItemEnabled()?this.target.setLayout(e+r,t+o,i,s):this.target.setLayout(r,o,i,s)}changedDimensions(e=!0,t=!0){this._updateRecalc(e,t)}changedContents(){this._updateRecalc()}forceLayout(){this._updateRecalc()}isChanged(){return this._recalc>0}_updateRecalc(e=!1,t=!1){if(this.isFlexEnabled()){const r=this._flex._layout;e=e||r.isAxisFitToContents(!0),t=t||r.isAxisFitToContents(!1)}const i=1+(e?2:0)+(t?4:0),s=this.getNewRecalcFlags(i);this._recalc|=i,s>1?this.flexParent?this.flexParent._updateRecalcBottomUp(i):this._target.triggerLayout():this._target.triggerLayout()}getNewRecalcFlags(e){return 7-this._recalc&e}_updateRecalcBottomUp(e){const t=this._getRecalcFromChangedChildRecalc(e),i=this.getNewRecalcFlags(t);if(this._recalc|=t,i>1){const s=this.flexParent;s?s._updateRecalcBottomUp(t):this._target.triggerLayout()}else this._target.triggerLayout()}_getRecalcFromChangedChildRecalc(e){const t=this._flex._layout,i=t._horizontal?1:2,s=t._horizontal?2:1;e&s||e&i&&t.isWrapping()&&t.isCrossAxisFitToContents()&&(e+=s);let o=t.isAxisFitToContents(!0),a=t.isAxisFitToContents(!1);t.shrunk&&(t._horizontal?o=!0:a=!0);const l=1+(o?2:0)+(a?4:0);return e&l}get recalc(){return this._recalc}clearRecalcFlag(){this._recalc=0}enableLocalRecalcFlag(){this._recalc=1}get originalX(){return this._originalX}setOriginalXWithoutUpdatingLayout(e){this._originalX=e}get originalY(){return this._originalY}setOriginalYWithoutUpdatingLayout(e){this._originalY=e}get originalWidth(){return this._originalWidth}set originalWidth(e){this._originalWidth!==e&&(this._originalWidth=e,this.changedDimensions(!0,!1))}get originalHeight(){return this._originalHeight}set originalHeight(e){this._originalHeight!==e&&(this._originalHeight=e,this.changedDimensions(!1,!0))}get funcX(){return this._target.funcX}get funcY(){return this._target.funcY}get funcW(){return this._target.funcW}get funcH(){return this._target.funcH}}class rr{constructor(e,t=null){this.id=rr.id++,this.manager=e,this.stage=e.stage,this.textures=new Set,this._activeTextureCount=0,this.loader=t,this.lookupId=null,this._cancelCb=null,this.loadingSince=0,this.w=0,this.h=0,this._nativeTexture=null,this.permanent=!1,this.renderInfo=null,this._isResultTexture=!this.loader,this._loadError=null,this._imageRef=null,this._hasAlpha=!1}get hasAlpha(){return this._hasAlpha}get loadError(){return this._loadError}addTexture(e){this.textures.has(e)||this.textures.add(e)}removeTexture(e){this.textures.delete(e)}incActiveTextureCount(){this._activeTextureCount++,this._activeTextureCount===1&&this.becomesUsed()}decActiveTextureCount(){this._activeTextureCount--,this._activeTextureCount===0&&this.becomesUnused()}get isResultTexture(){return this._isResultTexture}set isResultTexture(e){this._isResultTexture=e}forEachEnabledElement(e){this.textures.forEach(t=>{t.elements.forEach(e)})}hasEnabledElements(){return this.textures.size>0}forEachActiveElement(e){this.textures.forEach(t=>{t.elements.forEach(i=>{i.active&&e(i)})})}getRenderWidth(){return this.w}getRenderHeight(){return this.h}allowCleanup(){return!this.permanent&&!this.isUsed()}becomesUsed(){this.load()}becomesUnused(){this.cancel()}cancel(){this.isLoading()&&(this._cancelCb&&(this._cancelCb(this),this._cancelCb=null),this.loadingSince=0)}isLoaded(){return!!this._nativeTexture}isLoading(){return this.loadingSince>0}isError(){return!!this._loadError}reload(){this.free(),this.isUsed()&&this.load()}load(e=!1){this.isResultTexture||!this._nativeTexture&&!this.isLoading()&&(this.loadingSince=new Date().getTime(),this._cancelCb=this.loader((t,i)=>{if(this.isLoading()){if(this._cancelCb=null,this.manager.stage.destroyed)return;if(t)this.onError(t);else if(i&&i.source)if(!this.stage.isUpdatingFrame()&&!e&&i.throttle!==!1){const s=this.stage.textureThrottler;this._cancelCb=s.genericCancelCb,s.add(this,i)}else this.processLoadedSource(i)}},this))}processLoadedSource(e){this.loadingSince=0,this.setSource(e)}setSource(e){const t=e.source;this._hasAlpha=e&&e.hasAlpha||!1,this.w=t.width||e&&e.w||0,this.h=t.height||e&&e.h||0,e&&e.renderInfo&&(this.renderInfo=e.renderInfo),this.permanent=!!e.permanent,e&&e.imageRef&&(this._imageRef=e.imageRef),e&&e.flipTextureY?this._flipTextureY=e.flipTextureY:this._flipTextureY=!1,this._isNativeTexture(t)?(this._nativeTexture=t,this.w=this.w||t.w,this.h=this.h||t.h,this.permanent=e.hasOwnProperty("permanent")?e.permanent:!0):this.manager.uploadTextureSource(this,e),this._loadError=null,this.onLoad()}isUsed(){return this._activeTextureCount>0}onLoad(){this.isUsed()&&this.textures.forEach(e=>{e.onLoad()})}forceRenderUpdate(){this._nativeTexture&&(this._nativeTexture.update=this.stage.frameCounter),this.forEachActiveElement(function(e){e.forceRenderUpdate()})}forceUpdateRenderCoords(){this.forEachActiveElement(function(e){e._updateTextureCoords()})}get nativeTexture(){return this._nativeTexture}clearNativeTexture(){this._nativeTexture=null,this._imageRef=null}replaceNativeTexture(e,t,i){let s=this._nativeTexture;this._nativeTexture=e,this.w=t,this.h=i,!s&&this._nativeTexture&&this.forEachActiveElement(r=>r.onTextureSourceLoaded()),this._nativeTexture||this.forEachActiveElement(r=>r._setDisplayedTexture(null)),this.forEachEnabledElement(r=>r._updateDimensions())}onError(e){this._loadError=e,this.loadingSince=0,console.error("[Lightning] texture load error",e,this.lookupId),this.forEachActiveElement(t=>t.onTextureSourceLoadError(e))}free(){this.isLoaded()&&this.manager.freeTextureSource(this)}_isNativeTexture(e){return H.isNode?e.constructor.name==="WebGLTexture":"WebGLTexture"in window?e instanceof WebGLTexture:!1}}rr.prototype.isTextureSource=!0;rr.id=1;class $d{constructor(e){this._element=e.element,this._core=e,this.ctx=this._core.ctx,this._enabled=!1,this.lazy=!1,this._colorize=!1,this._renderTexture=null,this._renderTextureReused=!1,this._resultTextureSource=null,this._renderOffscreen=!1,this.empty=!1}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._core.updateRenderToTextureEnabled()}get renderOffscreen(){return this._renderOffscreen}set renderOffscreen(e){this._renderOffscreen=e,this._core.setHasRenderUpdates(1),this._core._setRecalc(6)}get colorize(){return this._colorize}set colorize(e){this._colorize!==e&&(this._colorize=e,this._core.setHasRenderUpdates(1))}_getTextureSource(){return this._resultTextureSource||(this._resultTextureSource=new rr(this._element.stage.textureManager),this.updateResultTexture()),this._resultTextureSource}hasResultTexture(){return!!this._resultTextureSource}resultTextureInUse(){return this._resultTextureSource&&this._resultTextureSource.hasEnabledElements()}updateResultTexture(){let e=this.getResultTexture();if(this._resultTextureSource){if(this._resultTextureSource.nativeTexture!==e){let t=e?e.w:0,i=e?e.h:0;this._resultTextureSource.replaceNativeTexture(e,t,i)}this._resultTextureSource.forEachEnabledElement(t=>{t._updateDimensions(),t.core.setHasRenderUpdates(3)})}}mustRenderToTexture(){return this._enabled&&!this.lazy?!0:!!(this._enabled&&this.lazy&&this._core._hasRenderUpdates<3)}deactivate(){this.release()}get renderTextureReused(){return this._renderTextureReused}release(){this.releaseRenderTexture()}releaseRenderTexture(){this._renderTexture&&(this._renderTextureReused||this.ctx.releaseRenderTexture(this._renderTexture),this._renderTexture=null,this._renderTextureReused=!1,this.updateResultTexture())}reuseTextureAsRenderTexture(e){this._renderTexture!==e&&(this.releaseRenderTexture(),this._renderTexture=e,this._renderTextureReused=!0)}hasRenderTexture(){return!!this._renderTexture}getRenderTexture(){return this._renderTexture||(this._renderTexture=this.ctx.allocateRenderTexture(this._core._w,this._core._h),this._renderTextureReused=!1),this._renderTexture}getResultTexture(){return this._renderTexture}}class Bi{constructor(e){this._element=e,this.ctx=e.stage.ctx,this._recalc=0,this._parent=null,this._onUpdate=null,this._pRecalc=0,this._worldContext=new ss,this._hasUpdates=!1,this._localAlpha=1,this._onAfterCalcs=null,this._onAfterUpdate=null,this._localPx=0,this._localPy=0,this._localTa=1,this._localTb=0,this._localTc=0,this._localTd=1,this._isComplex=!1,this._dimsUnknown=!1,this._clipping=!1,this._zSort=!1,this._outOfBounds=0,this._displayedTextureSource=null,this._zContextUsage=0,this._children=null,this._hasRenderUpdates=0,this._zIndexedChildren=null,this._renderContext=this._worldContext,this.renderState=this.ctx.renderState,this._scissor=null,this._shaderOwner=null,this._updateTreeOrder=0,this._colorUl=this._colorUr=this._colorBl=this._colorBr=4294967295,this._x=0,this._y=0,this._w=0,this._h=0,this._optFlags=0,this._funcX=null,this._funcY=null,this._funcW=null,this._funcH=null,this._scaleX=1,this._scaleY=1,this._pivotX=.5,this._pivotY=.5,this._mountX=0,this._mountY=0,this._rotation=0,this._alpha=1,this._visible=!0,this._ulx=0,this._uly=0,this._brx=1,this._bry=1,this._zIndex=0,this._forceZIndexContext=!1,this._zParent=null,this._isRoot=!1,this._zIndexResort=!1,this._shader=null,this._renderToTextureEnabled=!1,this._texturizer=null,this._useRenderToTexture=!1,this._boundsMargin=null,this._recBoundsMargin=null,this._withinBoundsMargin=!1,this._viewport=null,this._clipbox=!0,this.render=this._renderSimple,this._layout=null}get offsetX(){return this._funcX?this._funcX:this.hasFlexLayout()?this._layout.originalX:this._x}set offsetX(e){H.isFunction(e)?this.funcX=e:(this._disableFuncX(),this.hasFlexLayout()?(this.x+=e-this._layout.originalX,this._layout.setOriginalXWithoutUpdatingLayout(e)):this.x=e)}get x(){return this._x}set x(e){e!==this._x&&(this._updateLocalTranslateDelta(e-this._x,0),this._x=e)}get funcX(){return this._optFlags&1?this._funcX:null}set funcX(e){this._funcX!==e&&(this._optFlags|=1,this._funcX=e,this.hasFlexLayout()?(this._layout.setOriginalXWithoutUpdatingLayout(0),this.layout.forceLayout()):(this._x=0,this._triggerRecalcTranslate()))}_disableFuncX(){this._optFlags=this._optFlags&65534,this._funcX=null}get offsetY(){return this._funcY?this._funcY:this.hasFlexLayout()?this._layout.originalY:this._y}set offsetY(e){H.isFunction(e)?this.funcY=e:(this._disableFuncY(),this.hasFlexLayout()?(this.y+=e-this._layout.originalY,this._layout.setOriginalYWithoutUpdatingLayout(e)):this.y=e)}get y(){return this._y}set y(e){e!==this._y&&(this._updateLocalTranslateDelta(0,e-this._y),this._y=e)}get funcY(){return this._optFlags&2?this._funcY:null}set funcY(e){this._funcY!==e&&(this._optFlags|=2,this._funcY=e,this.hasFlexLayout()?(this._layout.setOriginalYWithoutUpdatingLayout(0),this.layout.forceLayout()):(this._y=0,this._triggerRecalcTranslate()))}_disableFuncY(){this._optFlags=this._optFlags&65533,this._funcY=null}get funcW(){return this._optFlags&4?this._funcW:null}set funcW(e){this._funcW!==e&&(this._optFlags|=4,this._funcW=e,this.hasFlexLayout()?(this._layout._originalWidth=0,this.layout.changedDimensions(!0,!1)):(this._w=0,this._triggerRecalcTranslate()))}disableFuncW(){this._optFlags=this._optFlags&65531,this._funcW=null}get funcH(){return this._optFlags&8?this._funcH:null}set funcH(e){this._funcH!==e&&(this._optFlags|=8,this._funcH=e,this.hasFlexLayout()?(this._layout._originalHeight=0,this.layout.changedDimensions(!1,!0)):(this._h=0,this._triggerRecalcTranslate()))}disableFuncH(){this._optFlags=this._optFlags&65527,this._funcH=null}get w(){return this._w}getRenderWidth(){return this.hasFlexLayout()?this._layout.originalWidth:this._w}get h(){return this._h}getRenderHeight(){return this.hasFlexLayout()?this._layout.originalHeight:this._h}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX!==e&&(this._scaleX=e,this._updateLocalTransform())}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY!==e&&(this._scaleY=e,this._updateLocalTransform())}get scale(){return this.scaleX}set scale(e){(this._scaleX!==e||this._scaleY!==e)&&(this._scaleX=e,this._scaleY=e,this._updateLocalTransform())}get pivotX(){return this._pivotX}set pivotX(e){this._pivotX!==e&&(this._pivotX=e,this._updateLocalTranslate())}get pivotY(){return this._pivotY}set pivotY(e){this._pivotY!==e&&(this._pivotY=e,this._updateLocalTranslate())}get pivot(){return this._pivotX}set pivot(e){(this._pivotX!==e||this._pivotY!==e)&&(this._pivotX=e,this._pivotY=e,this._updateLocalTranslate())}get mountX(){return this._mountX}set mountX(e){this._mountX!==e&&(this._mountX=e,this._updateLocalTranslate())}get mountY(){return this._mountY}set mountY(e){this._mountY!==e&&(this._mountY=e,this._updateLocalTranslate())}get mount(){return this._mountX}set mount(e){(this._mountX!==e||this._mountY!==e)&&(this._mountX=e,this._mountY=e,this._updateLocalTranslate())}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._updateLocalTransform())}get alpha(){return this._alpha}set alpha(e){if(e=e>1?1:e<1e-14?0:e,this._alpha!==e){let t=this._alpha;this._alpha=e,this._updateLocalAlpha(),t===0!=(e===0)&&this._element._updateEnabledFlag()}}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._updateLocalAlpha(),this._element._updateEnabledFlag(),this.hasFlexLayout()&&this.layout.setVisible(e))}_updateLocalTransform(){if(this._rotation!==0&&this._rotation%(2*Math.PI)){let e=Math.sin(this._rotation),t=Math.cos(this._rotation);this._setLocalTransform(t*this._scaleX,-e*this._scaleY,e*this._scaleX,t*this._scaleY)}else this._setLocalTransform(this._scaleX,0,0,this._scaleY);this._updateLocalTranslate()}_updateLocalTranslate(){this._recalcLocalTranslate(),this._triggerRecalcTranslate()}_recalcLocalTranslate(){let e=this._pivotX*this._w,t=this._pivotY*this._h,i=this._x-(e*this._localTa+t*this._localTb)+e,s=this._y-(e*this._localTc+t*this._localTd)+t;i-=this._mountX*this._w,s-=this._mountY*this._h,this._localPx=i,this._localPy=s}_updateLocalTranslateDelta(e,t){this._addLocalTranslate(e,t)}_updateLocalAlpha(){this._setLocalAlpha(this._visible?this._alpha:0)}setHasRenderUpdates(e){if(this._worldContext.alpha){let t=this;for(t._hasRenderUpdates=Math.max(e,t._hasRenderUpdates);(t=t._parent)&&t._hasRenderUpdates!==3;)t._hasRenderUpdates=3}}_setRecalc(e){this._recalc|=e,this._setHasUpdates(),this._parent&&this._parent.setHasRenderUpdates(3)}_setHasUpdates(){let e=this;for(;e&&!e._hasUpdates;)e._hasUpdates=!0,e=e._parent}getParent(){return this._parent}setParent(e){if(e!==this._parent){let t=this.isZContext(),i=this._parent;if(this._parent=e,(this._layout||e&&e.isFlexContainer())&&this.layout.setParent(i,e),i&&i.setHasRenderUpdates(3),this._setRecalc(7),this._parent&&this._parent._setHasUpdates(),this._zIndex===0?this.setZParent(e):this.setZParent(e?e.findZContext():null),t!==this.isZContext()&&(this.isZContext()?this.enableZContext(i.findZContext()):this.disableZContext()),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort(),!this._shader){let s=e&&!e._renderToTextureEnabled?e._shaderOwner:null;s!==this._shaderOwner&&(this.setHasRenderUpdates(1),this._setShaderOwnerRecursive(s))}}}enableZSort(e=!1){!this._zSort&&this._zContextUsage>0&&(this._zSort=!0,e&&this.ctx.forceZSort(this))}addChildAt(e,t){this._children||(this._children=[]),this._children.splice(e,0,t),t.setParent(this)}setChildAt(e,t){this._children||(this._children=[]),this._children[e].setParent(null),this._children[e]=t,t.setParent(this)}removeChildAt(e){let t=this._children[e];this._children.splice(e,1),t.setParent(null)}removeChildren(){if(this._children){for(let e=0,t=this._children.length;e<t;e++)this._children[e].setParent(null);this._children.splice(0),this._zIndexedChildren&&this._zIndexedChildren.splice(0)}}syncChildren(e,t,i){this._children=i;for(let s=0,r=e.length;s<r;s++)e[s].setParent(null);for(let s=0,r=t.length;s<r;s++)t[s].setParent(this)}moveChild(e,t){let i=this._children[e];this._children.splice(e,1),this._children.splice(t,0,i),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort()}_setLocalTransform(e,t,i,s){this._setRecalc(4),this._localTa=e,this._localTb=t,this._localTc=i,this._localTd=s,this._isComplex=t!==0||i!==0||e<0||s<0}_addLocalTranslate(e,t){this._localPx+=e,this._localPy+=t,this._triggerRecalcTranslate()}_setLocalAlpha(e){!this._worldContext.alpha&&this._parent&&this._parent._worldContext.alpha&&e?this._setRecalc(129):this._setRecalc(1),e<1e-14&&(e=0),this._localAlpha=e}setDimensions(e,t,i=this._dimsUnknown){if(this._dimsUnknown=i,this.hasFlexLayout())this._layout.originalWidth=e,this._layout.originalHeight=t;else if(this._w!==e||this._h!==t)return this._updateDimensions(e,t),!0;return!1}_updateDimensions(e,t){(this._w!==e||this._h!==t)&&(this._w=e,this._h=t,this._triggerRecalcTranslate(),this._texturizer&&(this._texturizer.releaseRenderTexture(),this._texturizer.updateResultTexture()),this._updateLocalTranslate())}setTextureCoords(e,t,i,s){this.setHasRenderUpdates(3),this._ulx=e,this._uly=t,this._brx=i,this._bry=s}get displayedTextureSource(){return this._displayedTextureSource}setDisplayedTextureSource(e){this.setHasRenderUpdates(3),this._displayedTextureSource=e}get isRoot(){return this._isRoot}setAsRoot(){this._parent=new Bi(this._element),this._parent._hasRenderUpdates=3,this._parent._hasUpdates=!0,this._isRoot=!0,this.ctx.root=this,this._parent._viewport=[0,0,this.ctx.stage.coordsWidth,this.ctx.stage.coordsHeight],this._parent._scissor=this._parent._viewport,this._parent._recBoundsMargin=null,this._setRecalc(7)}isAncestorOf(e){let t=e;for(;t=t._parent;)if(this===t)return!0;return!1}isZContext(){return this._forceZIndexContext||this._renderToTextureEnabled||this._zIndex!==0||this._isRoot||!this._parent}findZContext(){return this.isZContext()?this:this._parent.findZContext()}setZParent(e){if(this._zParent!==e){if(this._zParent!==null&&(this._zIndex!==0&&this._zParent.decZContextUsage(),this._zParent.enableZSort()),e!==null){let t=e._zContextUsage>0;this._zIndex!==0&&e.incZContextUsage(),e._zContextUsage>0&&(!t&&this._parent===e||e._zIndexedChildren.push(this),e.enableZSort())}this._zParent=e,this._zIndexResort=!0}}incZContextUsage(){if(this._zContextUsage++,this._zContextUsage===1&&(this._zIndexedChildren||(this._zIndexedChildren=[]),this._children)){for(let e=0,t=this._children.length;e<t;e++)this._zIndexedChildren.push(this._children[e]);this._zSort=!1}}decZContextUsage(){this._zContextUsage--,this._zContextUsage===0&&(this._zSort=!1,this._zIndexedChildren.splice(0))}get zIndex(){return this._zIndex}set zIndex(e){if(this._zIndex!==e){this.setHasRenderUpdates(1);let t=this._zParent,i=this.isZContext();e===0&&this._zIndex!==0?this._parent===this._zParent?this._zParent&&this._zParent.decZContextUsage():t=this._parent:e!==0&&this._zIndex===0?(t=this._parent?this._parent.findZContext():null,t===this._zParent&&this._zParent&&(this._zParent.incZContextUsage(),this._zParent.enableZSort())):e!==this._zIndex&&this._zParent&&this._zParent._zContextUsage&&this._zParent.enableZSort(),t!==this._zParent&&this.setZParent(null),this._zIndex=e,t!==this._zParent&&this.setZParent(t),i!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext()),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort()}}get forceZIndexContext(){return this._forceZIndexContext}set forceZIndexContext(e){this.setHasRenderUpdates(1);let t=this.isZContext();this._forceZIndexContext=e,t!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext())}enableZContext(e){e&&e._zContextUsage>0&&this._getZIndexedDescs().forEach(i=>{this.isAncestorOf(i)&&i._zIndex!==0&&i.setZParent(this)})}_getZIndexedDescs(){const e=[];if(this._children)for(let t=0,i=this._children.length;t<i;t++)this._children[t]._getZIndexedDescsRec(e);return e}_getZIndexedDescsRec(e){if(this._zIndex)e.push(this);else if(this._children&&!this.isZContext())for(let t=0,i=this._children.length;t<i;t++)this._children[t]._getZIndexedDescsRec(e)}disableZContext(){if(this._zContextUsage>0){let e=this._parent.findZContext();this._zSort&&this.sortZIndexedChildren(),this._zIndexedChildren.slice().forEach(function(t){t._zIndex!==0&&t.setZParent(e)})}}get colorUl(){return this._colorUl}set colorUl(e){this._colorUl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUl=e)}get colorUr(){return this._colorUr}set colorUr(e){this._colorUr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUr=e)}get colorBl(){return this._colorBl}set colorBl(e){this._colorBl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBl=e)}get colorBr(){return this._colorBr}set colorBr(e){this._colorBr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBr=e)}set onUpdate(e){this._onUpdate=e,this._setRecalc(7)}set onAfterUpdate(e){this._onAfterUpdate=e,this._setRecalc(7)}set onAfterCalcs(e){this._onAfterCalcs=e,this._setRecalc(7)}get shader(){return this._shader}set shader(e){this.setHasRenderUpdates(1);let t=this._shader;if(this._shader=e,!e&&t){let i=this._parent&&!this._parent._renderToTextureEnabled?this._parent._shaderOwner:null;this._setShaderOwnerRecursive(i)}else e&&this._setShaderOwnerRecursive(this)}get activeShader(){return this._shaderOwner?this._shaderOwner.shader:this.renderState.defaultShader}get activeShaderOwner(){return this._shaderOwner}get clipping(){return this._clipping}set clipping(e){this._clipping!==e&&(this._clipping=e,this._setRecalc(3))}get clipbox(){return this._clipbox}set clipbox(e){this._clipbox=e}_setShaderOwnerRecursive(e){if(this._shaderOwner=e,this._children&&!this._renderToTextureEnabled)for(let t=0,i=this._children.length;t<i;t++){let s=this._children[t];s._shader||(s._setShaderOwnerRecursive(e),s._hasRenderUpdates=3)}}_setShaderOwnerChildrenRecursive(e){if(this._children)for(let t=0,i=this._children.length;t<i;t++){let s=this._children[t];s._shader||(s._setShaderOwnerRecursive(e),s._hasRenderUpdates=3)}}_hasRenderContext(){return this._renderContext!==this._worldContext}get renderContext(){return this._renderContext}updateRenderToTextureEnabled(){this.texturizer._enabled?this._enableRenderToTexture():(this._disableRenderToTexture(),this._texturizer.releaseRenderTexture())}_enableRenderToTexture(){if(!this._renderToTextureEnabled){let e=this.isZContext();this._renderToTextureEnabled=!0,this._renderContext=new ss,this._setShaderOwnerChildrenRecursive(null),e||this.enableZContext(this._parent?this._parent.findZContext():null),this.setHasRenderUpdates(3),this._setRecalc(7),this.render=this._renderAdvanced}}_disableRenderToTexture(){this._renderToTextureEnabled&&(this._renderToTextureEnabled=!1,this._setShaderOwnerChildrenRecursive(this._shaderOwner),this._renderContext=this._worldContext,this.isZContext()||this.disableZContext(),this._setRecalc(7),this.setHasRenderUpdates(3),this.render=this._renderSimple)}isWhite(){return this._colorUl===4294967295&&this._colorUr===4294967295&&this._colorBl===4294967295&&this._colorBr===4294967295}hasSimpleTexCoords(){return this._ulx===0&&this._uly===0&&this._brx===1&&this._bry===1}_stashTexCoords(){this._stashedTexCoords=[this._ulx,this._uly,this._brx,this._bry],this._ulx=0,this._uly=0,this._brx=1,this._bry=1}_unstashTexCoords(){this._ulx=this._stashedTexCoords[0],this._uly=this._stashedTexCoords[1],this._brx=this._stashedTexCoords[2],this._bry=this._stashedTexCoords[3],this._stashedTexCoords=null}_stashColors(){this._stashedColors=[this._colorUl,this._colorUr,this._colorBr,this._colorBl],this._colorUl=4294967295,this._colorUr=4294967295,this._colorBr=4294967295,this._colorBl=4294967295}_unstashColors(){this._colorUl=this._stashedColors[0],this._colorUr=this._stashedColors[1],this._colorBr=this._stashedColors[2],this._colorBl=this._stashedColors[3],this._stashedColors=null}isVisible(){return this._localAlpha>1e-14}get outOfBounds(){return this._outOfBounds}set boundsMargin(e){this._boundsMargin=e?e.slice():null,this._triggerRecalcTranslate()}get boundsMargin(){return this._boundsMargin}update(){this._recalc|=this._parent._pRecalc,this._layout&&this._layout.isEnabled()?this._recalc&256&&this._layout.layoutFlexTree():this._recalc&2&&this._optFlags&&this._applyRelativeDimFuncs(),this._onUpdate&&(this._hasUpdates=!0,this._onUpdate(this.element,this));const e=this._parent._worldContext;let t=this._worldContext;const i=e.alpha&&this._localAlpha;if(this._hasUpdates||this._recalc&&i||t.alpha&&!i){let s=this._recalc;s&1&&(!t.alpha&&i&&(this._hasRenderUpdates=3),t.alpha=e.alpha*this._localAlpha,t.alpha<1e-14&&(t.alpha=0)),s&6&&(t.px=e.px+this._localPx*e.ta,t.py=e.py+this._localPy*e.td,e.tb!==0&&(t.px+=this._localPy*e.tb),e.tc!==0&&(t.py+=this._localPx*e.tc)),s&4&&(t.ta=this._localTa*e.ta,t.tb=this._localTd*e.tb,t.tc=this._localTa*e.tc,t.td=this._localTd*e.td,this._isComplex&&(t.ta+=this._localTc*e.tb,t.tb+=this._localTb*e.ta,t.tc+=this._localTc*e.td,t.td+=this._localTb*e.tc));const r=this._parent._renderContext;if(this._parent._hasRenderContext()){const p=this._renderContext===this._worldContext;p&&(this._renderContext=new ss);const m=this._renderContext;(p||s&1)&&(m.alpha=r.alpha*this._localAlpha,m.alpha<1e-14&&(m.alpha=0)),(p||s&6)&&(m.px=r.px+this._localPx*r.ta,m.py=r.py+this._localPy*r.td,r.tb!==0&&(m.px+=this._localPy*r.tb),r.tc!==0&&(m.py+=this._localPx*r.tc)),p&&(s|=2),(p||s&4)&&(m.ta=this._localTa*r.ta,m.tb=this._localTd*r.tb,m.tc=this._localTa*r.tc,m.td=this._localTd*r.td,this._isComplex&&(m.ta+=this._localTc*r.tb,m.tb+=this._localTb*r.ta,m.tc+=this._localTc*r.td,m.td+=this._localTb*r.tc))}else this._renderContext=this._worldContext;this.ctx.updateTreeOrder===-1?this.ctx.updateTreeOrder=this._updateTreeOrder+1:this._updateTreeOrder=this.ctx.updateTreeOrder++;const o=this._renderToTextureEnabled&&this._texturizer.mustRenderToTexture();this._useRenderToTexture!==o&&(this._recalc|=6,s|=2,this._useRenderToTexture||this._texturizer.release()),this._useRenderToTexture=o;const a=this._renderContext,l=this._dimsUnknown?2048:this._w,h=this._dimsUnknown?2048:this._h;let c,u,d,f;const g=a.tb!==0||a.tc!==0||a.ta<0||a.td<0;if(g?(c=Math.min(0,l*a.ta,l*a.ta+h*a.tb,h*a.tb)+a.px,d=Math.max(0,l*a.ta,l*a.ta+h*a.tb,h*a.tb)+a.px,u=Math.min(0,l*a.tc,l*a.tc+h*a.td,h*a.td)+a.py,f=Math.max(0,l*a.tc,l*a.tc+h*a.td,h*a.td)+a.py):(c=a.px,d=a.px+a.ta*l,u=a.py,f=a.py+a.td*h),this._dimsUnknown&&(g||this._localTa<1||this._localTb<1)){const p=this._x*r.ta+this._y*r.tb+r.px,m=this._x*r.tc+this._y*r.td+r.py;p<c&&(c=p),m<u&&(u=m),p>d&&(d=p),m>f&&(f=m)}if(s&6||!this._scissor)if(this._clipping&&a.isSquare()){const p=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor;if(p){const m=Math.max(p[0],c),_=Math.max(p[1],u);this._scissor=[m,_,Math.min(p[2]+p[0],d)-m,Math.min(p[3]+p[1],f)-_]}else this._scissor=[c,u,d-c,f-u]}else this._scissor=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor;if(this._boundsMargin?this._recBoundsMargin=this._boundsMargin:this._recBoundsMargin=this._parent._recBoundsMargin,this._onAfterCalcs&&this._onAfterCalcs(this.element)&&(g?(c=Math.min(0,l*a.ta,l*a.ta+h*a.tb,h*a.tb)+a.px,d=Math.max(0,l*a.ta,l*a.ta+h*a.tb,h*a.tb)+a.px,u=Math.min(0,l*a.tc,l*a.tc+h*a.td,h*a.td)+a.py,f=Math.max(0,l*a.tc,l*a.tc+h*a.td,h*a.td)+a.py):(c=a.px,d=a.px+a.ta*l,u=a.py,f=a.py+a.td*h),this._dimsUnknown&&(g||this._localTa<1||this._localTb<1))){const p=this._x*r.ta+this._y*r.tb+r.px,m=this._x*r.tc+this._y*r.td+r.py;p<c&&(c=p),m<u&&(u=m),p>d&&(d=p),m>f&&(f=m)}if(this._parent._outOfBounds===2)this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.element._disableWithinBoundsMargin());else if(s&6){this._outOfBounds=0;let p=!0;if((!this._renderToTextureEnabled||!this._texturizer||!this._texturizer.renderOffscreen)&&(this._scissor&&(this._scissor[2]<=0||this._scissor[3]<=0)?this._outOfBounds=2:((this._scissor[0]>d||this._scissor[1]>f||c>this._scissor[0]+this._scissor[2]||u>this._scissor[1]+this._scissor[3])&&(this._outOfBounds=1),this._outOfBounds&&(this._clipping||this._useRenderToTexture||this._clipbox&&l&&h)&&(this._outOfBounds=2)),p=this._outOfBounds===0,p||(this._recBoundsMargin?p=!(d<this._scissor[0]-this._recBoundsMargin[2]||f<this._scissor[1]-this._recBoundsMargin[3]||c>this._scissor[0]+this._scissor[2]+this._recBoundsMargin[0]||u>this._scissor[1]+this._scissor[3]+this._recBoundsMargin[1]):p=!(d<this._scissor[0]-100||f<this._scissor[1]-100||c>this._scissor[0]+this._scissor[2]+100||u>this._scissor[1]+this._scissor[3]+100),p&&this._outOfBounds===2&&(this._outOfBounds=1))),this._withinBoundsMargin!==p)if(this._withinBoundsMargin=p,this._withinBoundsMargin){this._hasUpdates=!0;const m=this._recalc;if(this._recalc=0,this.element._enableWithinBoundsMargin(),this._recalc)return this.update();this._recalc=m}else this.element._disableWithinBoundsMargin()}if(this._useRenderToTexture&&(this._viewport?(this._viewport[2]=l,this._viewport[3]=h):this._viewport=[0,0,l,h]),this._pRecalc=this._recalc&135,this._recalc=0,this._hasUpdates=!1,this._outOfBounds<2){if(this._useRenderToTexture&&(this._worldContext.isIdentity()?this._renderContext=this._worldContext:this._renderContext=ss.IDENTITY),this._children)for(let p=0,m=this._children.length;p<m;p++)this._children[p].update();this._useRenderToTexture&&(this._renderContext=a)}else if(this._children)for(let p=0,m=this._children.length;p<m;p++)this._children[p]._hasUpdates?this._children[p].update():(this._children[p]._recalc|=this._pRecalc,this._children[p].updateOutOfBounds());this._onAfterUpdate&&this._onAfterUpdate(this.element)}else this.ctx.updateTreeOrder===-1||this._updateTreeOrder>=this.ctx.updateTreeOrder?this.ctx.updateTreeOrder=-1:this.updateTreeOrder()}_applyRelativeDimFuncs(){if(this._optFlags&1){const t=this._funcX(this._parent.w);t!==this._x&&(this._localPx+=t-this._x,this._x=t)}if(this._optFlags&2){const t=this._funcY(this._parent.h);t!==this._y&&(this._localPy+=t-this._y,this._y=t)}let e=!1;if(this._optFlags&4){const t=this._funcW(this._parent.w);t!==this._w&&(this._w=t,e=!0)}if(this._optFlags&8){const t=this._funcH(this._parent.h);t!==this._h&&(this._h=t,e=!0)}e&&(this._recalcLocalTranslate(),this.element.onDimensionsChanged(this._w,this._h))}updateOutOfBounds(){if(this._outOfBounds!==2&&this._renderContext.alpha>0&&(this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.element._disableWithinBoundsMargin()),this._children))for(let e=0,t=this._children.length;e<t;e++)this._children[e].updateOutOfBounds()}updateTreeOrder(){if(this._localAlpha&&this._outOfBounds!==2&&(this._updateTreeOrder=this.ctx.updateTreeOrder++,this._children))for(let e=0,t=this._children.length;e<t;e++)this._children[e].updateTreeOrder()}_renderSimple(){if(this._hasRenderUpdates=0,this._zSort&&this.sortZIndexedChildren(),this._outOfBounds<2&&this._renderContext.alpha){let e=this.renderState;if(this._outOfBounds===0&&this._displayedTextureSource&&(e.setShader(this.activeShader,this._shaderOwner),e.setScissor(this._scissor),this.renderState.addQuad(this)),this._children)if(this._zContextUsage)for(let t=0,i=this._zIndexedChildren.length;t<i;t++)this._zIndexedChildren[t].render();else for(let t=0,i=this._children.length;t<i;t++)this._children[t]._zIndex===0&&this._children[t].render()}}_renderAdvanced(){const e=this._hasRenderUpdates;if(this._hasRenderUpdates=0,this._zSort&&this.sortZIndexedChildren(),this._outOfBounds<2&&this._renderContext.alpha){let t=this.renderState,i=!0,s,r;if(this._useRenderToTexture){if(this._w===0||this._h===0)return;if(!this._texturizer.hasRenderTexture()||e>=3){if(this.ctx.renderToTextureCount++,t.setShader(t.defaultShader,this),r=t.renderTextureInfo,s={nativeTexture:null,offset:0,w:this._w,h:this._h,empty:!0,cleared:!1,ignore:!1,cache:!1},(this._texturizer.hasResultTexture()||!t.isCachingTexturizer&&e<3)&&(s.cache=!0,t.isCachingTexturizer=!0),this._texturizer.hasResultTexture()||this._texturizer.releaseRenderTexture(),t.setRenderTextureInfo(s),t.setScissor(null),this._displayedTextureSource){let o=this._renderContext;this._renderContext=ss.IDENTITY,this.renderState.addQuad(this),this._renderContext=o}}else i=!1}else this._outOfBounds===0&&this._displayedTextureSource&&(t.setShader(this.activeShader,this._shaderOwner),t.setScissor(this._scissor),this.renderState.addQuad(this));if(i&&this._children)if(this._zContextUsage)for(let o=0,a=this._zIndexedChildren.length;o<a;o++)this._zIndexedChildren[o].render();else for(let o=0,a=this._children.length;o<a;o++)this._children[o]._zIndex===0&&this._children[o].render();if(this._useRenderToTexture){let o=!1;if(i&&(t.finishedRenderTexture(),this._texturizer.empty=s.empty,s.empty?this._texturizer.releaseRenderTexture():s.nativeTexture?(this._texturizer.reuseTextureAsRenderTexture(s.nativeTexture),s.ignore=!0):(this._texturizer.renderTextureReused&&this._texturizer.releaseRenderTexture(),s.nativeTexture=this._texturizer.getRenderTexture()),t.setRenderTextureInfo(r),o=!0),!this._texturizer.empty){let a=this._texturizer.getResultTexture();if(o&&(a&&(a.update=t.stage.frameCounter),this._texturizer.updateResultTexture()),!this._texturizer.renderOffscreen){t.setShader(this.activeShader,this._shaderOwner),t.setScissor(this._scissor);const l=!s||s.cache;t.setTexturizer(this._texturizer,l),this._stashTexCoords(),this._texturizer.colorize||this._stashColors(),this.renderState.addQuad(this,!0),this._texturizer.colorize||this._unstashColors(),this._unstashTexCoords(),t.setTexturizer(null)}}}s&&s.cache&&(t.isCachingTexturizer=!1)}}get zSort(){return this._zSort}sortZIndexedChildren(){const e=this._zIndexedChildren.length;let t=0;const i=this._zIndexedChildren,s=[];for(let o=0;o<e;o++)i[o]._zParent===this&&(i[o]._zIndexResort?s.push(i[o]):(t!==o&&(i[t]=i[o]),t++));const r=s.length;if(r){for(let a=0;a<r;a++)s[a]._zIndexResort=!1;s.sort(Bi.sortZIndexedChildren);const o=t;if(o){i.splice(o),+ +i.sort(Bi.sortZIndexedChildren),t=0;let a=0,l=0;const h=[];do{const u=(i[a]._zIndex===s[l]._zIndex?i[a]._updateTreeOrder-s[l]._updateTreeOrder:i[a]._zIndex-s[l]._zIndex)>0?s[l++]:i[a++];if((t===0||h[t-1]!==u)&&(h[t++]=u),a>=o){do{const d=s[l++];(t===0||h[t-1]!==d)&&(h[t++]=d)}while(l<r);break}else if(l>=r){do{const d=i[a++];(t===0||h[t-1]!==d)&&(h[t++]=d)}while(a<o);break}}while(!0);this._zIndexedChildren=h}else{t=0;let a=0;do i[t++]=s[a++];while(a<r);i.length>t&&i.splice(t)}}else i.length>t&&i.splice(t);this._zSort=!1}get localTa(){return this._localTa}get localTb(){return this._localTb}get localTc(){return this._localTc}get localTd(){return this._localTd}get element(){return this._element}get renderUpdates(){return this._hasRenderUpdates}get texturizer(){return this._texturizer||(this._texturizer=new $d(this)),this._texturizer}getCornerPoints(){let e=this._worldContext;return[e.px,e.py,e.px+this._w*e.ta,e.py+this._w*e.tc,e.px+this._w*e.ta+this._h*e.tb,e.py+this._w*e.tc+this._h*e.td,e.px+this._h*e.tb,e.py+this._h*e.td]}getRenderTextureCoords(e,t){let i=this._renderContext;return[i.px+i.ta*e+i.tb*t,i.py+i.tc*e+i.td*t]}getAbsoluteCoords(e,t){let i=this._renderContext;return[i.px+i.ta*e+i.tb*t,i.py+i.tc*e+i.td*t]}collectAtCoord(e,t,i){if(this._renderContext.alpha!==0){if(this.inBound(e,t)&&(this._scissor?this.inScissor()&&i.push(this):i.push(this)),this._children){const s=this._children.length;for(let r=0;r<s;r++)this._children[r].collectAtCoord(e,t,i)}return i.sort(Bi.sortZIndexedChildren)}}inBound(e,t){const i=this.getCornerPoints();return e>i[0]&&e<i[2]&&t>i[1]&&t<i[7]}inScissor(){const e=this._scissor,t=this.getCornerPoints();return t[2]>=e[0]&&t[0]<=e[0]+e[2]&&t[7]>=e[1]&&t[1]<=e[1]+e[3]}get layout(){return this._ensureLayout(),this._layout}get flex(){return this._layout?this._layout.flex:null}set flex(e){this.layout.flex=e}get flexItem(){return this._layout?this._layout.flexItem:null}set flexItem(e){this.layout.flexItem=e}isFlexItem(){return!!this._layout&&this._layout.isFlexItemEnabled()}isFlexContainer(){return!!this._layout&&this._layout.isFlexEnabled()}enableFlexLayout(){this._ensureLayout()}_ensureLayout(){this._layout||(this._layout=new E_(this))}disableFlexLayout(){this._triggerRecalcTranslate()}hasFlexLayout(){return this._layout&&this._layout.isEnabled()}setLayout(e,t,i,s){this.x=e,this.y=t,this._updateDimensions(i,s)}triggerLayout(){this._setRecalc(256)}_triggerRecalcTranslate(){this._setRecalc(2)}}class ss{constructor(){this.alpha=1,this.px=0,this.py=0,this.ta=1,this.tb=0,this.tc=0,this.td=1}isIdentity(){return this.alpha===1&&this.px===0&&this.py===0&&this.ta===1&&this.tb===0&&this.tc===0&&this.td===1}isSquare(){return this.tb===0&&this.tc===0}}ss.IDENTITY=new ss;Bi.sortZIndexedChildren=function(n,e){return n._zIndex===e._zIndex?n._updateTreeOrder-e._updateTreeOrder:n._zIndex-e._zIndex};let tt=class es{constructor(){this._hasEventListeners=!1}on(e,t){this._hasEventListeners||(this._eventFunction={},this._eventListeners={},this._hasEventListeners=!0),this._eventFunction[e]?this._eventFunction[e]!==es.combiner?(this._eventListeners[e]=[this._eventFunction[e],t],this._eventFunction[e]=es.combiner):this._eventListeners[e].push(t):this._eventFunction[e]=t}once(e,t){const i=(s,r,o)=>{t(s,r,o),this.off(e,i)};i.__originalFunc=t,this.on(e,i)}has(e,t){if(this._hasEventListeners){const i=this._eventFunction[e];if(i){if(i===es.combiner){const s=this._eventListeners[e];for(const r of s)if(r===t||r.__originalFunc==t)return!0}else if(this._eventFunction[e]===t||this._eventFunction[e].__originalFunc===t)return!0}}return!1}off(e,t){if(this._hasEventListeners){const i=this._eventFunction[e];if(i)if(i===es.combiner){const s=this._eventListeners[e];let r=s.indexOf(t);r>=0&&s.splice(r,1),r=s.map(o=>o.__originalFunc).indexOf(t),r>=0&&s.splice(r,1),s.length===1&&(this._eventFunction[e]=s[0],this._eventListeners[e]=void 0)}else(this._eventFunction[e]===t||this._eventFunction[e].__originalFunc===t)&&(this._eventFunction[e]=void 0)}}removeListener(e,t){this.off(e,t)}emit(e,t,i,s){if(this._hasEventListeners){const r=this._eventFunction[e];r&&(r===es.combiner?r(this,e,t,i,s):r(t,i,s))}}listenerCount(e){if(this._hasEventListeners){const t=this._eventFunction[e];if(t)return t===es.combiner?this._eventListeners[e].length:1}return 0}removeAllListeners(e){this._hasEventListeners&&(delete this._eventFunction[e],delete this._eventListeners[e])}};tt.combiner=function(n,e,t,i,s){const r=n._eventListeners[e];if(r)for(const o of[...r])o(t,i,s)};tt.addAsMixin=function(n){n.prototype.on=tt.prototype.on,n.prototype.once=tt.prototype.once,n.prototype.has=tt.prototype.has,n.prototype.off=tt.prototype.off,n.prototype.removeListener=tt.prototype.removeListener,n.prototype.emit=tt.prototype.emit,n.prototype.listenerCount=tt.prototype.listenerCount,n.prototype.removeAllListeners=tt.prototype.removeAllListeners};class Gr{constructor(e){this._initialized=!1,this.ctx=e,this._elements=new Set}static create(e,t){let i;if(H.isObjectLiteral(t))t.type?i=e.renderer.createShader(e.ctx,t):i=this.shader,i&&Xe.patchObject(i,t);else if(t===null)i=e.ctx.renderState.defaultShader;else if(t===void 0)i=null;else if(t.isShader)e.renderer.isValidShaderType(t.constructor)||(console.error("[Lightning] Invalid shader type"),t=null),i=t;else{console.error("[Lightning] Please specify a shader type.");return}return i}static getWebGL(){}static getC2d(){}addElement(e){this._elements.add(e)}removeElement(e){this._elements.delete(e),this._elements||this.cleanup()}redraw(){this._elements.forEach(e=>{e.setHasRenderUpdates(2)})}patch(e){Xe.patchObject(this,e)}useDefault(){return!1}addEmpty(){return!1}cleanup(){}get isShader(){return!0}}class _t{constructor(e){this.stage=e,this.manager=this.stage.textureManager,this.id=_t.id++,this.elements=new Set,this._activeCount=0,this._source=null,this._resizeMode=null,this._x=0,this._y=0,this._w=0,this._h=0,this._precision=1,this.mw=0,this.mh=0,this.clipping=!1,this._mustUpdate=!0}get source(){return(this._mustUpdate||this.stage.hasUpdateSourceTexture(this))&&(this._performUpdateSource(!0),this.stage.removeUpdateSourceTexture(this)),this._source}addElement(e){this.elements.has(e)||(this.elements.add(e),this.elements.size===1&&this._source&&this._source.addTexture(this),e.active&&this.incActiveCount())}removeElement(e){this.elements.delete(e)&&(this.elements.size===0&&this._source&&this._source.removeTexture(this),e.active&&this.decActiveCount())}incActiveCount(){this.source&&this._checkForNewerReusableTextureSource(),this._activeCount++,this._activeCount===1&&this.becomesUsed()}decActiveCount(){this.source,this._activeCount--,this._activeCount||this.becomesUnused()}becomesUsed(){this.source&&this.source.incActiveTextureCount()}onLoad(){this._resizeMode&&this._applyResizeMode(),this.elements.forEach(e=>{e.active&&e.onTextureSourceLoaded()})}_checkForNewerReusableTextureSource(){const e=this.source;if(e.isLoaded())this._resizeMode&&this._applyResizeMode();else{const t=this._getReusableTextureSource();t&&t.isLoaded()&&t!==e&&this._replaceTextureSource(t)}}becomesUnused(){this.source&&this.source.decActiveTextureCount()}isUsed(){return this._activeCount>0}_getLookupId(){return null}_getSourceLoader(){throw new Error("Texture.generate must be implemented.")}get isValid(){return this._getIsValid()}_getIsValid(){return!0}_changed(){this.isUsed()?this._updateSource():this._mustUpdate=!0}_updateSource(){this.stage.addUpdateSourceTexture(this)}_performUpdateSource(e=!1){if(e||this.isUsed()){this._mustUpdate=!1;let t=this._getTextureSource();this._replaceTextureSource(t)}}_getTextureSource(){let e=null;if(this._getIsValid()){const t=this._getLookupId();e=this._getReusableTextureSource(t),e||(e=this.manager.getTextureSource(this._getSourceLoader(),t))}return e}_getReusableTextureSource(e=this._getLookupId()){return this._getIsValid()&&e?this.manager.getReusableTextureSource(e):null}_replaceTextureSource(e=null){let t=this._source;if(this._source=e,this.elements.size&&(t&&(this._activeCount&&t.decActiveTextureCount(),t.removeTexture(this),this.text&&!t.isUsed()&&this.manager.freeTextureSource(t)),e&&(e.addTexture(this),this._activeCount&&e.incActiveTextureCount())),this.isUsed())if(e)if(e.isLoaded())this._resizeMode&&this._applyResizeMode(),this.elements.forEach(i=>{i.active&&i._setDisplayedTexture(this)});else{const i=e.loadError;i&&this.elements.forEach(s=>{s.active&&s.onTextureSourceLoadError(i)})}else this.elements.forEach(i=>{i.active&&i._setDisplayedTexture(null)})}load(){this.source&&(this.isLoaded()||this.source.load(!0))}isLoaded(){return this._source&&this._source.isLoaded()}get loadError(){return this._source&&this._source.loadError}free(){this._source&&this._source.free()}set resizeMode({type:e="cover",w:t=0,h:i=0,clipX:s=.5,clipY:r=.5}){this._resizeMode={type:e,w:t,h:i,clipX:s,clipY:r},this.isLoaded()&&this._applyResizeMode()}get resizeMode(){return this._resizeMode}_clearResizeMode(){this._resizeMode=null}_applyResizeMode(){this._resizeMode.type==="cover"?this._applyResizeCover():this._resizeMode.type==="contain"&&this._applyResizeContain(),this._updatePrecision(),this._updateClipping()}_applyResizeCover(){const e=this._resizeMode.w/this._source.w,t=this._resizeMode.h/this._source.h;let i=Math.max(e,t);if(i){if(this._precision=1/i,e&&e<i){const s=this._precision*this._resizeMode.w,r=this._source.w-s;this._x=r*this._resizeMode.clipX,this._w=this._source.w-r}if(t&&t<i){const s=this._precision*this._resizeMode.h,r=this._source.h-s;this._y=r*this._resizeMode.clipY,this._h=this._source.h-r}}}_applyResizeContain(){const e=this._resizeMode.w/this._source.w,t=this._resizeMode.h/this._source.h;let i=e;(!i||t<i)&&(i=t),i&&(this._precision=1/i)}enableClipping(e,t,i,s){this._clearResizeMode(),e*=this._precision,t*=this._precision,i*=this._precision,s*=this._precision,(this._x!==e||this._y!==t||this._w!==i||this._h!==s)&&(this._x=e,this._y=t,this._w=i,this._h=s,this._updateClipping(!0))}disableClipping(){this._clearResizeMode(),(this._x||this._y||this._w||this._h)&&(this._x=0,this._y=0,this._w=0,this._h=0,this._updateClipping())}_updateClipping(){this.clipping=!!(this._x||this._y||this._w||this._h);let e=this;this.elements.forEach(function(t){t.displayedTexture===e&&t.onDisplayedTextureClippingChanged()})}_updatePrecision(){let e=this;this.elements.forEach(function(t){t.displayedTexture===e&&t.onPrecisionChanged()})}getNonDefaults(){let e={};return e.type=this.constructor.name,this.x!==0&&(e.x=this.x),this.y!==0&&(e.y=this.y),this.w!==0&&(e.w=this.w),this.h!==0&&(e.h=this.h),this.precision!==1&&(e.precision=this.precision),e}get px(){return this._x}get py(){return this._y}get pw(){return this._w}get ph(){return this._h}get x(){return this._x/this._precision}set x(e){this._clearResizeMode(),e=e*this._precision,this._x!==e&&(this._x=e,this._updateClipping())}get y(){return this._y/this._precision}set y(e){this._clearResizeMode(),e=e*this._precision,this._y!==e&&(this._y=e,this._updateClipping())}get w(){return this._w/this._precision}set w(e){this._clearResizeMode(),e=e*this._precision,this._w!==e&&(this._w=e,this._updateClipping())}get h(){return this._h/this._precision}set h(e){this._clearResizeMode(),e=e*this._precision,this._h!==e&&(this._h=e,this._updateClipping())}get precision(){return this._precision}set precision(e){this._clearResizeMode(),this._precision!==e&&(this._precision=e,this._updatePrecision())}isAutosizeTexture(){return!0}getRenderWidth(){return this.isAutosizeTexture()?(this._w||(this._source?this._source.getRenderWidth()-this._x:0))/this._precision:0}getRenderHeight(){return this.isAutosizeTexture()?(this._h||(this._source?this._source.getRenderHeight()-this._y:0))/this._precision:0}patch(e){Xe.patchObject(this,e)}}_t.prototype.isTexture=!0;_t.id=0;class ml extends _t{constructor(e){super(e),this._src=void 0,this._hasAlpha=!1}get src(){return this._src}set src(e){this._src!==e&&(this._src=e,this._changed())}get hasAlpha(){return this._hasAlpha}set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._changed())}_getIsValid(){return!!this._src}_getLookupId(){return this._src}_getSourceLoader(){let e=this._src,t=this._hasAlpha;if(this.stage.getOption("srcBasePath")){var i=e.charCodeAt(0);e.indexOf("//")===-1&&(i>=65&&i<=90||i>=97&&i<=122||i==46)&&(e=this.stage.getOption("srcBasePath")+e)}return s=>this.stage.platform.loadSrcTexture({src:e,hasAlpha:t},s)}getNonDefaults(){const e=super.getNonDefaults();return this._src&&(e.src=this._src),e}}function So(n,e,t,i,s){let r=n;Array.isArray(r)||(r=[r]);let o=[];for(let a=0,l=r.length;a<l;a++){let h=r[a];h==null&&(h=s),h.indexOf(" ")<0?o.push(h):o.push(`"${h}"`)}return`${e} ${t*i}px ${o.join(",")}`}function zd(n){return n===""||n==="​"}function vc(n){return zd(n)||n===" "}function b_(n,e){const t=e.match(n)||[],i=e.split(n)||[];let s=[];for(let r=0;r<i.length;r++)s.push(i[r],t[r]);return s.pop(),s.filter(r=>r!="")}function vo(n,e,t=0){return t?e.split("").reduce((i,s)=>zd(s)?i:i+n.measureText(s).width+t,0):n.measureText(e).width}function A_(n,e,t,i,s){const r=/ |\u200B/g;let o=e.split(/\r?\n/g),a=[],l=[];for(let h=0;h<o.length;h++){let c=[],u="",d=t-s,f=o[h].split(r),g=o[h].match(r)||[];for(let p=0;p<f.length;p++){const m=g[p-1]||"",_=f[p],T=vo(n,_,i),S=T+vo(n,m,i);p===0||S>d?(p>0&&(c.push(u),u=""),u+=_,d=t-T-(p===0?s:0)):(d-=S,u+=m+_)}c.push(u),u="",a=a.concat(c),h<o.length-1&&l.push(a.length)}return{l:a,n:l}}class R_{constructor(e,t,i){this._stage=e,this._canvas=t,this._context=this._canvas.getContext("2d"),this._settings=i}getPrecision(){return this._settings.precision}setFontProperties(){this._context.font=So(this._settings.fontFace,this._settings.fontStyle,this._settings.fontSize,this.getPrecision(),this._stage.getOption("defaultFontFace")),this._context.textBaseline=this._settings.textBaseline,this._context.direction=this._settings.rtl?"rtl":"ltr"}_load(){if(H.isWeb&&document.fonts){const e=So(this._settings.fontFace,this._settings.fontStyle,this._settings.fontSize,this.getPrecision(),this._stage.getOption("defaultFontFace"));try{if(!document.fonts.check(e,this._settings.text))return document.fonts.load(e,this._settings.text).catch(t=>{console.warn("[Lightning] Font load error",t,e)}).then(()=>{document.fonts.check(e,this._settings.text)||console.warn("[Lightning] Font not found",e)})}catch{console.warn("[Lightning] Can't check font loading for "+e)}}}draw(){const e=this._load();return e?e.then(()=>H.isSpark?this._stage.platform.drawText(this):this._draw()):H.isSpark?this._stage.platform.drawText(this):this._draw()}_calculateRenderInfo(){let e={};const t=this.getPrecision(),i=this._settings.paddingLeft*t,s=this._settings.paddingRight*t,r=this._settings.fontSize*t;let o=this._settings.offsetY===null?null:this._settings.offsetY*t,a=this._settings.lineHeight*t;const l=this._settings.w*t,h=this._settings.h*t;let c=this._settings.wordWrapWidth*t;const u=this._settings.cutSx*t,d=this._settings.cutEx*t,f=this._settings.cutSy*t,g=this._settings.cutEy*t,p=(this._settings.letterSpacing||0)*t,m=this._settings.textIndent*t;this.setFontProperties();let _=l||this._stage.getOption("w"),T=_-i;if(T<10&&(_+=10-T,T=10),c||(c=T),this._settings.textOverflow&&!this._settings.wordWrap){let A;switch(this._settings.textOverflow){case"clip":A="";break;case"ellipsis":A=this._settings.maxLinesSuffix;break;default:A=this._settings.textOverflow}this._settings.text=this.wrapWord(this._settings.text,c-m,A)}let S;if(this._settings.wordWrap)S=this.wrapText(this._settings.text,c,p,m);else{S={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]};let A=S.l.length;for(let L=0;L<A-1;L++)S.n.push(L)}let v=S.l;if(this._settings.maxLines&&v.length>this._settings.maxLines){let A=v.slice(0,this._settings.maxLines),L=null;if(this._settings.maxLinesSuffix){let G=this._settings.maxLinesSuffix?this.measureText(this._settings.maxLinesSuffix):0,k=this.wrapText(A[A.length-1],c-G,p,m);A[A.length-1]=k.l[0]+this._settings.maxLinesSuffix,L=[k.l.length>1?k.l[1]:""]}else L=[""];let R,M=v.length,F=0,z=S.n.length;for(R=this._settings.maxLines;R<M;R++)L[F]+=(L[F]?" ":"")+v[R],R+1<z&&S.n[R+1]&&F++;e.remainingText=L.join(`
`),e.moreTextLines=!0,v=A}else e.moreTextLines=!1,e.remainingText="";let E=0,C=[];for(let A=0;A<v.length;A++){let L=this.measureText(v[A],p)+(A===0?m:0);C.push(L),E=Math.max(E,L)}e.lineWidths=C,l||(_=E+i+s,T=E),a=a||r;let b;if(h)b=h;else{const A=this._settings.textBaseline!="bottom"?.5*r:0;b=a*(v.length-1)+A+Math.max(a,r)+o}return o===null&&(o=r),e.w=_,e.h=b,e.lines=v,e.precision=t,_||(_=1),b||(b=1),(u||d)&&(_=Math.min(_,d-u)),(f||g)&&(b=Math.min(b,g-f)),e.width=_,e.innerWidth=T,e.height=b,e.fontSize=r,e.cutSx=u,e.cutSy=f,e.cutEx=d,e.cutEy=g,e.lineHeight=a,e.lineWidths=C,e.offsetY=o,e.paddingLeft=i,e.paddingRight=s,e.letterSpacing=p,e.textIndent=m,e}_draw(){const e=this._calculateRenderInfo(),t=this.getPrecision();this._canvas.width=Math.ceil(e.width+this._stage.getOption("textRenderIssueMargin")),this._canvas.height=Math.ceil(e.height),this.setFontProperties(),e.fontSize>=128&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=1),(e.cutSx||e.cutSy)&&this._context.translate(-e.cutSx,-e.cutSy);let i,s,r=[];for(let a=0,l=e.lines.length;a<l;a++)i=a===0?e.textIndent:0,s=a*e.lineHeight+e.offsetY,this._settings.verticalAlign=="middle"?s+=(e.lineHeight-e.fontSize)/2:this._settings.verticalAlign=="bottom"&&(s+=e.lineHeight-e.fontSize),this._settings.textAlign==="right"?i+=e.innerWidth-e.lineWidths[a]:this._settings.textAlign==="center"&&(i+=(e.innerWidth-e.lineWidths[a])/2),i+=e.paddingLeft,this._settings.rtl&&(i+=e.lineWidths[a]),r.push({text:e.lines[a],x:i,y:s,w:e.lineWidths[a]});if(this._settings.highlight){let a=this._settings.highlightColor||0,l=this._settings.highlightHeight*t||e.fontSize*1.5;const h=this._settings.highlightOffset*t,c=this._settings.highlightPaddingLeft!==null?this._settings.highlightPaddingLeft*t:e.paddingLeft,u=this._settings.highlightPaddingRight!==null?this._settings.highlightPaddingRight*t:e.paddingRight;this._context.fillStyle=ie.getRgbaString(a);for(let d=0;d<r.length;d++){let f=r[d];this._context.fillRect(f.x-c,f.y-e.offsetY+h,f.w+u+c,l)}}let o=null;this._settings.shadow&&(o=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=ie.getRgbaString(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*t,this._context.shadowOffsetY=this._settings.shadowOffsetY*t,this._context.shadowBlur=this._settings.shadowBlur*t),this._context.fillStyle=ie.getRgbaString(this._settings.textColor);for(let a=0,l=r.length;a<l;a++){let h=r[a];if(e.letterSpacing===0)this._context.fillText(h.text,h.x,h.y);else{const c=h.text.split("");let u=h.x;for(let d=0,f=c.length;d<f;d++)this._context.fillText(c[d],u,h.y),u+=this.measureText(c[d],e.letterSpacing)}}o&&(this._context.shadowColor=o[0],this._context.shadowOffsetX=o[1],this._context.shadowOffsetY=o[2],this._context.shadowBlur=o[3]),(e.cutSx||e.cutSy)&&this._context.translate(e.cutSx,e.cutSy),this.renderInfo=e}wrapWord(e,t,i){const s=this.measureText(i),r=e.length,o=this.measureText(e);if(o<=t)return e;let a=Math.floor(t*r/o),l=this.measureText(e.substring(0,a))+s;if(l>t)for(;a>0&&(l=this.measureText(e.substring(0,a))+s,l>t);)a-=1;else for(;a<r;)if(l=this.measureText(e.substring(0,a))+s,l<t)a+=1;else{a-=1;break}return e.substring(0,a)+(t>=s?i:"")}wrapText(e,t,i,s=0){return A_(this._context,e,t,i,s)}measureText(e,t=0){return vo(this._context,e,t)}}class C_{constructor(e,t,i){this._stage=e,this._canvas=t,this._context=this._canvas.getContext("2d"),this._settings=i}getPrecision(){return this._settings.precision}setFontProperties(){const e=So(this._settings.fontFace,this._settings.fontStyle,this._settings.fontSize,this.getPrecision(),this._stage.getOption("defaultFontFace"));return this._context.font=e,this._context.textBaseline=this._settings.textBaseline,e}_load(){if(H.isWeb&&document.fonts){const e=So(this._settings.fontFace,this._settings.fontStyle,this._settings.fontSize,this.getPrecision(),this._stage.getOption("defaultFontFace"));try{if(!document.fonts.check(e,this._settings.text))return document.fonts.load(e,this._settings.text).catch(t=>{console.warn("Font load error",t,e)}).then(()=>{document.fonts.check(e,this._settings.text)||console.warn("Font not found",e)})}catch{console.warn("Can't check font loading for "+e)}}}draw(){const e=this._load();return e?e.then(()=>H.isSpark?this._stage.platform.drawText(this):this._draw()):H.isSpark?this._stage.platform.drawText(this):this._draw()}_calculateRenderInfo(){let e={};const t=this.getPrecision(),i=this._settings.paddingLeft*t,s=this._settings.paddingRight*t,r=this._settings.fontSize*t,o=this._settings.lineHeight*t||r,a=this._settings.w!=0?this._settings.w*t:this._stage.getOption("w"),l=this._settings.wordWrapWidth*t,h=this._settings.cutSx*t,c=this._settings.cutEx*t,u=this._settings.cutSy*t,d=this._settings.cutEy*t,f=this._settings.letterSpacing||0;e.baseFont=this.setFontProperties(),e.w=a,e.width=a,e.text=this._settings.text,e.precision=t,e.fontSize=r,e.fontBaselineRatio=this._settings.fontBaselineRatio,e.lineHeight=o,e.letterSpacing=f,e.textAlign=this._settings.textAlign,e.textColor=this._settings.textColor,e.verticalAlign=this._settings.verticalAlign,e.highlight=this._settings.highlight,e.highlightColor=this._settings.highlightColor,e.highlightHeight=this._settings.highlightHeight,e.highlightPaddingLeft=this._settings.highlightPaddingLeft,e.highlightPaddingRight=this._settings.highlightPaddingRight,e.highlightOffset=this._settings.highlightOffset,e.paddingLeft=this._settings.paddingLeft,e.paddingRight=this._settings.paddingRight,e.maxLines=this._settings.maxLines,e.maxLinesSuffix=this._settings.maxLinesSuffix,e.textOverflow=this._settings.textOverflow,e.wordWrap=this._settings.wordWrap,e.wordWrapWidth=l,e.shadow=this._settings.shadow,e.shadowColor=this._settings.shadowColor,e.shadowOffsetX=this._settings.shadowOffsetX,e.shadowOffsetY=this._settings.shadowOffsetY,e.shadowBlur=this._settings.shadowBlur,e.cutSx=h,e.cutEx=c,e.cutSy=u,e.cutEy=d,e.textIndent=this._settings.textIndent*t,e.wordBreak=this._settings.wordBreak;let g=e.text,p=e.wordWrap&&e.wordWrapWidth||e.width;if(e.textOverflow&&!e.wordWrap){let v;switch(this._settings.textOverflow){case"clip":v="";break;case"ellipsis":v=this._settings.maxLinesSuffix;break;default:v=this._settings.textOverflow}g=this.wrapWord(g,l||e.w,v)}g=this.tokenize(g),g=this.parse(g),g=this.measure(g,f,e.baseFont),e.textIndent&&(g=this.indent(g,e.textIndent)),e.wordBreak&&(g=g.reduce((v,E)=>v.concat(this.wordBreak(E,p,e.baseFont)),[]),this.resetFontStyle());let m=i,_=0;for(const v of g)(e.wordWrap&&m+v.width>p||v.text==`
`)&&(m=i,_+=1),v.lineNo=_,v.text!=`
`&&(v.x=m,m+=v.width);e.lineNum=_+1,this._settings.h?e.h=this._settings.h:e.maxLines&&e.maxLines<e.lineNum?e.h=e.maxLines*e.lineHeight+r/2:e.h=e.lineNum*e.lineHeight+r/2;const T=e.fontBaselineRatio*e.fontSize;let S=0;e.verticalAlign=="top"&&this._context.textBaseline=="alphabetic"?S=-T:e.verticalAlign=="middle"?S=(e.lineHeight-e.fontSize-T)/2:this._settings.verticalAlign=="bottom"&&(S=e.lineHeight-e.fontSize),e.lines=[];for(let v=0;v<e.lineNum;v++)e.lines[v]={width:0,x:0,y:e.lineHeight*v+S,text:[]};for(let v of g)e.lines[v.lineNo].text.push(v);for(const v of e.lines){if(v.text.length==0)continue;const E=v.text[0].text,C=v.text[v.text.length-1].text;E==`
`&&v.text.shift(),(vc(C)||C==`
`)&&v.text.pop()}for(let v of e.lines)v.width=v.text.reduce((E,C)=>E+C.width,0);if(e.width=this._settings.w!=0?this._settings.w*t:Math.max(...e.lines.map(v=>v.width))+s,e.w=e.width,e.maxLines&&e.lineNum>e.maxLines&&e.maxLinesSuffix){const v=e.maxLines-1;let E=g.filter(L=>L.lineNo==v),C=e.maxLinesSuffix;C=this.tokenize(C),C=this.parse(C),C=this.measure(C,e.letterSpacing,e.baseFont);for(const L of C)L.lineNo=v,L.x=0,E.push(L);const b=C.length+1;let A=E.reduce((L,R)=>L+R.width,0);for(;(A>e.width||vc(E[E.length-b].text))&&(E.splice(E.length-b,1),A=E.reduce((L,R)=>L+R.width,0),!(E.length<b)););this.alignLine(E,E[0].x),e.lines[v].text=E,e.lines[v].width=A}if(e.textAlign=="center")for(let v of e.lines)v.x=(e.width-v.width-i)/2;else if(e.textAlign=="right")for(let v of e.lines)v.x=e.width-v.width-i;return e}_draw(){const e=this._calculateRenderInfo(),t=this.getPrecision(),i=e.paddingLeft*t;let s=e.w||e.width;(e.cutSx||e.cutEx)&&(s=Math.min(e.w,e.cutEx-e.cutSx));let r=e.h;if((e.cutSy||e.cutEy)&&(r=Math.min(e.h,e.cutEy-e.cutSy)),this._canvas.width=Math.ceil(s+this._stage.getOption("textRenderIssueMargin")),this._canvas.height=Math.ceil(r),this.setFontProperties(),e.fontSize>=128&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=1),(e.cutSx||e.cutSy)&&this._context.translate(-e.cutSx,-e.cutSy),e.highlight){const h=e.highlightColor||0,c=e.highlightHeight?e.highlightHeight*t:e.fontSize*1.5,u=e.highlightOffset?e.highlightOffset*t:0,d=e.highlightPaddingLeft!==null?e.highlightPaddingLeft*t:e.paddingLeft,f=e.highlightPaddingRight!==null?e.highlightPaddingRight*t:e.paddingRight;this._context.fillStyle=ie.getRgbaString(h);const g=e.maxLines?Math.min(e.maxLines,e.lineNum):e.lineNum;for(let p=0;p<g;p++){const m=e.lines[p];this._context.fillRect(m.x-d+i,m.y+u,m.width+d+f,c)}}let o=null;this._settings.shadow&&(o=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=ie.getRgbaString(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*t,this._context.shadowOffsetY=this._settings.shadowOffsetY*t,this._context.shadowBlur=this._settings.shadowBlur*t);const a=ie.getRgbaString(this._settings.textColor);let l=a;this._context.fillStyle=a;for(const h of e.lines)for(const c of h.text){let u=0;if(c.text!=`
`&&!(e.maxLines&&c.lineNo>=e.maxLines))if(c.color!=l&&(l=c.color,this._context.fillStyle=l),this._context.font=c.fontStyle,c.letters)for(let d of c.letters){const f=e.lines[c.lineNo].x+c.x+u;this._context.fillText(d.text,f,e.lines[c.lineNo].y+e.fontSize),u+=d.width}else{const d=e.lines[c.lineNo].x+c.x;this._context.fillText(c.text,d,e.lines[c.lineNo].y+e.fontSize)}}o&&(this._context.shadowColor=o[0],this._context.shadowOffsetX=o[1],this._context.shadowOffsetY=o[2],this._context.shadowBlur=o[3]),(e.cutSx||e.cutSy)&&this._context.translate(e.cutSx,e.cutSy),e.lines=e.lines.map(h=>h.text.reduce((c,u)=>c+u.text,"")),e.maxLines&&(e.lines=e.lines.slice(0,e.maxLines)),this.renderInfo=e}measureText(e,t=0){return vo(this._context,e,t)}tokenize(e){return b_(/ |\u200B|\n|<i>|<\/i>|<b>|<\/b>|<color=0[xX][0-9a-fA-F]{8}>|<\/color>/g,e)}parse(e){let t=0,i=0,s=[ie.getRgbaString(this._settings.textColor)],r=0;const o=/<color=(0[xX][0-9a-fA-F]{8})>/;return e.map(a=>{if(a=="<i>")t+=1,a="";else if(a=="</i>"&&t>0)t-=1,a="";else if(a=="<b>")i+=1,a="";else if(a=="</b>"&&i>0)i-=1,a="";else if(a=="</color>")s.length>1&&(r-=1,s.pop()),a="";else if(o.test(a)){const l=o.exec(a);s.push(ie.getRgbaString(parseInt(l[1]))),r+=1,a=""}return{text:a,italic:t,bold:i,color:s[r]}}).filter(a=>a.text!="")}applyFontStyle(e,t){let i=t;e.bold&&(i="bold "+i),e.italic&&(i="italic "+i),this._context.font=i,e.fontStyle=i}resetFontStyle(e){this._context.font=e}measure(e,t=0,i){for(const s of e)if(this.applyFontStyle(s,i),s.width=this.measureText(s.text,t),t>0){s.letters=s.text.split("").map(r=>({text:r}));for(let r of s.letters)r.width=this.measureText(r.text,t)}return this.resetFontStyle(i),e}indent(e,t){return e.splice(0,0,{text:"",width:t}),e}wrapWord(e,t,i){const s=this.measureText(i),r=e.length,o=this.measureText(e);if(o<=t)return e;let a=Math.floor(t*r/o),l=this.measureText(e.substring(0,a))+s;if(l>t)for(;a>0&&(l=this.measureText(e.substring(0,a))+s,l>t);)a-=1;else for(;a<r;)if(l=this.measureText(e.substring(0,a))+s,l<t)a+=1;else{a-=1;break}return e.substring(0,a)+(t>=s?i:"")}_getBreakIndex(e,t){const i=e.length,s=this.measureText(e);if(s<=t)return{breakIndex:e.length,truncWordWidth:s};let r=Math.floor(t*i/s),o=this.measureText(e.substring(0,r));if(o>t)for(;r>0&&(o=this.measureText(e.substring(0,r)),o>t);)r-=1;else for(;r<i;)if(o=this.measureText(e.substring(0,r)),o<t)r+=1;else{r-=1,o=this.measureText(e.substring(0,r));break}return{breakIndex:r,truncWordWidth:o}}wordBreak(e,t,i){if(!e.text)return e;this.applyFontStyle(e,i);const s=[];let r=e.text;if(e.letters){let o=0,a=[],l=0;for(const h of e.letters)o+h.width>=t?(s.push({...e}),s[s.length-1].text=r.slice(0,l),s[s.length-1].width=o,s[s.length-1].letters=a,r=r.slice(l),o=0,a=[],l=0):(l+=1,a.push(h),o+=h.width);o>0&&(s.push({...e}),s[s.length-1].text=r.slice(0,l),s[s.length-1].width=o,s[s.length-1].letters=a)}else for(;;){const{breakIndex:o,truncWordWidth:a}=this._getBreakIndex(r,t);if(s.push({...e}),s[s.length-1].text=r.slice(0,o),s[s.length-1].width=a,o===r.length)break;r=r.slice(o)}return s}alignLine(e,t=0){let i=0,s=t;for(const r of e)r.text!=`
`&&(r.x=s+i,s=r.x,i=r.width)}}class ni extends _t{constructor(e){super(e),this._precision=this.stage.getOption("precision")}static renderer(e,t,i){return i.advancedRenderer?new C_(e,t,i):new R_(e,t,i)}get text(){return this._text}set text(e){this._text!==e&&(this._text=""+e,this._changed())}get w(){return this._w}set w(e){this._w!==e&&(this._w=e,this._changed())}get h(){return this._h}set h(e){this._h!==e&&(this._h=e,this._changed())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this._changed())}get fontBaselineRatio(){return this._fontBaselineRatio}set fontBaselineRatio(e){this._fontBaselineRatio!==e&&(this._fontBaselineRatio=e,this._changed())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._changed())}get fontFace(){return this._fontFace}set fontFace(e){this._fontFace!==e&&(this._fontFace=e,this._changed())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!==e&&(this._wordWrap=e,this._changed())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(e){this._wordWrapWidth!==e&&(this._wordWrapWidth=e,this._changed())}get wordBreak(){return this._wordBreak}set wordBreak(e){this._wordBreak!==e&&(this._wordBreak=e,this._changed())}get textOverflow(){return this._textOverflow}set textOverflow(e){e!=this._textOverflow&&(this._textOverflow=e,this._changed())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._changed())}get textBaseline(){return this._textBaseline}set textBaseline(e){this._textBaseline!==e&&(this._textBaseline=e,this._changed())}get textAlign(){return this._textAlign}set textAlign(e){this._textAlign!==e&&(this._textAlign=e,this._changed())}get verticalAlign(){return this._verticalAlign}set verticalAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._changed())}get offsetY(){return this._offsetY}set offsetY(e){this._offsetY!==e&&(this._offsetY=e,this._changed())}get maxLines(){return this._maxLines}set maxLines(e){this._maxLines!==e&&(this._maxLines=e,this._changed())}get maxLinesSuffix(){return this._maxLinesSuffix}set maxLinesSuffix(e){this._maxLinesSuffix!==e&&(this._maxLinesSuffix=e,this._changed())}get textColor(){return this._textColor}set textColor(e){this._textColor!==e&&(this._textColor=e,this._changed())}get paddingLeft(){return this._paddingLeft}set paddingLeft(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._changed())}get paddingRight(){return this._paddingRight}set paddingRight(e){this._paddingRight!==e&&(this._paddingRight=e,this._changed())}get shadow(){return this._shadow}set shadow(e){this._shadow!==e&&(this._shadow=e,this._changed())}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor!==e&&(this._shadowColor=e,this._changed())}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this._changed())}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this._changed())}get shadowBlur(){return this._shadowBlur}set shadowBlur(e){this._shadowBlur!==e&&(this._shadowBlur=e,this._changed())}get highlight(){return this._highlight}set highlight(e){this._highlight!==e&&(this._highlight=e,this._changed())}get highlightHeight(){return this._highlightHeight}set highlightHeight(e){this._highlightHeight!==e&&(this._highlightHeight=e,this._changed())}get highlightColor(){return this._highlightColor}set highlightColor(e){this._highlightColor!==e&&(this._highlightColor=e,this._changed())}get highlightOffset(){return this._highlightOffset}set highlightOffset(e){this._highlightOffset!==e&&(this._highlightOffset=e,this._changed())}get highlightPaddingLeft(){return this._highlightPaddingLeft}set highlightPaddingLeft(e){this._highlightPaddingLeft!==e&&(this._highlightPaddingLeft=e,this._changed())}get highlightPaddingRight(){return this._highlightPaddingRight}set highlightPaddingRight(e){this._highlightPaddingRight!==e&&(this._highlightPaddingRight=e,this._changed())}get cutSx(){return this._cutSx}set cutSx(e){this._cutSx!==e&&(this._cutSx=e,this._changed())}get cutEx(){return this._cutEx}set cutEx(e){this._cutEx!==e&&(this._cutEx=e,this._changed())}get cutSy(){return this._cutSy}set cutSy(e){this._cutSy!==e&&(this._cutSy=e,this._changed())}get cutEy(){return this._cutEy}set cutEy(e){this._cutEy!==e&&(this._cutEy=e,this._changed())}get advancedRenderer(){return this._advancedRenderer}set advancedRenderer(e){this._advancedRenderer!==e&&(this._advancedRenderer=e,this._changed())}set letterSpacing(e){this._letterSpacing!==e&&(this._letterSpacing=e,this._changed())}get letterSpacing(){return this._letterSpacing}set textIndent(e){this._textIndent!==e&&(this._textIndent=e,this._changed())}get textIndent(){return this._textIndent}set rtl(e){this._rtl!==e&&(this._rtl=e,this._changed())}get rtl(){return this._rtl}get precision(){return super.precision}set precision(e){this.precision!==e&&(super.precision=e,this._changed())}_getIsValid(){return!!this.text}_getLookupId(){let e=[];return this.w!==0&&e.push("w "+this.w),this.h!==0&&e.push("h "+this.h),this.fontStyle!=="normal"&&e.push("fS"+this.fontStyle),this.fontSize!==40&&e.push("fs"+this.fontSize),this.fontBaselineRatio!==0&&e.push("fb"+this.fontBaselineRatio),this.fontFace!==null&&e.push("ff"+(Array.isArray(this.fontFace)?this.fontFace.join(","):this.fontFace)),this.wordWrap!==!0&&e.push("wr"+(this.wordWrap?1:0)),this.wordWrapWidth!==0&&e.push("ww"+this.wordWrapWidth),this.wordBreak!==!1&&e.push("wb"+this.wordBreak?1:0),this.textOverflow!=""&&e.push("to"+this.textOverflow),this.lineHeight!==null&&e.push("lh"+this.lineHeight),this.textBaseline!=="alphabetic"&&e.push("tb"+this.textBaseline),this.textAlign!=="left"&&e.push("ta"+this.textAlign),this.verticalAlign!=="top"&&e.push("va"+this.verticalAlign),this.offsetY!==null&&e.push("oy"+this.offsetY),this.maxLines!==0&&e.push("ml"+this.maxLines),this.maxLinesSuffix!==".."&&e.push("ms"+this.maxLinesSuffix),e.push("pc"+this.precision),this.textColor!==4294967295&&e.push("co"+this.textColor.toString(16)),this.paddingLeft!==0&&e.push("pl"+this.paddingLeft),this.paddingRight!==0&&e.push("pr"+this.paddingRight),this.shadow!==!1&&e.push("sh"+(this.shadow?1:0)),this.shadowColor!==4278190080&&e.push("sc"+this.shadowColor.toString(16)),this.shadowOffsetX!==0&&e.push("sx"+this.shadowOffsetX),this.shadowOffsetY!==0&&e.push("sy"+this.shadowOffsetY),this.shadowBlur!==5&&e.push("sb"+this.shadowBlur),this.highlight!==!1&&e.push("hL"+(this.highlight?1:0)),this.highlightHeight!==0&&e.push("hh"+this.highlightHeight),this.highlightColor!==4278190080&&e.push("hc"+this.highlightColor.toString(16)),this.highlightOffset!==null&&e.push("ho"+this.highlightOffset),this.highlightPaddingLeft!==null&&e.push("hl"+this.highlightPaddingLeft),this.highlightPaddingRight!==null&&e.push("hr"+this.highlightPaddingRight),this.letterSpacing!==null&&e.push("ls"+this.letterSpacing),this.textIndent!==null&&e.push("ti"+this.textIndent),this.cutSx&&e.push("csx"+this.cutSx),this.cutEx&&e.push("cex"+this.cutEx),this.cutSy&&e.push("csy"+this.cutSy),this.cutEy&&e.push("cey"+this.cutEy),this.advancedRenderer&&e.push("aR"+this.advancedRenderer?1:0),"TX$"+e.join("|")+":"+this.text}_getSourceLoader(){const e=this.cloneArgs(),t=this.stage.gl;return function(i){const s=this.stage.platform.getDrawingCanvas(),r=ni.renderer(this.stage,s,e),o=r.draw(),a={},l=this.stage.getOption("fontSharp");let h=!1;H.isBoolean(l)?h=l:H.isObject(l)&&(h=this.stage.getRenderPrecision()<=l.precision&&e.fontSize<=l.fontSize),t&&h&&(a[t.TEXTURE_MAG_FILTER]=t.NEAREST),o?o.then(()=>{i(null,Object.assign({renderInfo:r.renderInfo,throttle:!1,texParams:a},this.stage.platform.getTextureOptionsForDrawingCanvas(s)))}).catch(c=>{i(c)}):i(null,Object.assign({renderInfo:r.renderInfo,throttle:!1,texParams:a},this.stage.platform.getTextureOptionsForDrawingCanvas(s)))}}getNonDefaults(){const e=super.getNonDefaults();return this.text!==""&&(e.text=this.text),this.w!==0&&(e.w=this.w),this.h!==0&&(e.h=this.h),this.fontStyle!=="normal"&&(e.fontStyle=this.fontStyle),this.fontSize!==40&&(e.fontSize=this.fontSize),this.fontBaselineRatio!==0&&(e.fontBaselineRatio=this.fontBaselineRatio),this.fontFace!==null&&(e.fontFace=this.fontFace),this.wordWrap!==!0&&(e.wordWrap=this.wordWrap),this.wordWrapWidth!==0&&(e.wordWrapWidth=this.wordWrapWidth),this.wordBreak!==!1&&(e.wordBreak=this.wordBreak),this.textOverflow!=""&&(e.textOverflow=this.textOverflow),this.lineHeight!==null&&(e.lineHeight=this.lineHeight),this.textBaseline!=="alphabetic"&&(e.textBaseline=this.textBaseline),this.textAlign!=="left"&&(e.textAlign=this.textAlign),this.verticalAlign!=="top"&&(e.verticalAlign=this.verticalAlign),this.offsetY!==null&&(e.offsetY=this.offsetY),this.maxLines!==0&&(e.maxLines=this.maxLines),this.maxLinesSuffix!==".."&&(e.maxLinesSuffix=this.maxLinesSuffix),this.precision!==this.stage.getOption("precision")&&(e.precision=this.precision),this.textColor!==4294967295&&(e.textColor=this.textColor),this.paddingLeft!==0&&(e.paddingLeft=this.paddingLeft),this.paddingRight!==0&&(e.paddingRight=this.paddingRight),this.shadow!==!1&&(e.shadow=this.shadow),this.shadowColor!==4278190080&&(e.shadowColor=this.shadowColor),this.shadowOffsetX!==0&&(e.shadowOffsetX=this.shadowOffsetX),this.shadowOffsetY!==0&&(e.shadowOffsetY=this.shadowOffsetY),this.shadowBlur!==5&&(e.shadowBlur=this.shadowBlur),this.highlight!==!1&&(e.highlight=this.highlight),this.highlightHeight!==0&&(e.highlightHeight=this.highlightHeight),this.highlightColor!==4278190080&&(e.highlightColor=this.highlightColor),this.highlightOffset!==0&&(e.highlightOffset=this.highlightOffset),this.highlightPaddingLeft!==0&&(e.highlightPaddingLeft=this.highlightPaddingLeft),this.highlightPaddingRight!==0&&(e.highlightPaddingRight=this.highlightPaddingRight),this.letterSpacing!==0&&(e.letterSpacing=this.letterSpacing),this.textIndent!==0&&(e.textIndent=this.textIndent),this.rtl!==0&&(e.rtl=this.rtl),this.cutSx&&(e.cutSx=this.cutSx),this.cutEx&&(e.cutEx=this.cutEx),this.cutSy&&(e.cutSy=this.cutSy),this.cutEy&&(e.cutEy=this.cutEy),this.advancedRenderer&&(e.renderer=this.advancedRenderer),e}cloneArgs(){let e={};return e.text=this._text,e.w=this._w,e.h=this._h,e.fontStyle=this._fontStyle,e.fontSize=this._fontSize,e.fontBaselineRatio=this._fontBaselineRatio,e.fontFace=this._fontFace,e.wordWrap=this._wordWrap,e.wordWrapWidth=this._wordWrapWidth,e.wordBreak=this._wordBreak,e.textOverflow=this._textOverflow,e.lineHeight=this._lineHeight,e.textBaseline=this._textBaseline,e.textAlign=this._textAlign,e.verticalAlign=this._verticalAlign,e.offsetY=this._offsetY,e.maxLines=this._maxLines,e.maxLinesSuffix=this._maxLinesSuffix,e.precision=this._precision,e.textColor=this._textColor,e.paddingLeft=this._paddingLeft,e.paddingRight=this._paddingRight,e.shadow=this._shadow,e.shadowColor=this._shadowColor,e.shadowOffsetX=this._shadowOffsetX,e.shadowOffsetY=this._shadowOffsetY,e.shadowBlur=this._shadowBlur,e.highlight=this._highlight,e.highlightHeight=this._highlightHeight,e.highlightColor=this._highlightColor,e.highlightOffset=this._highlightOffset,e.highlightPaddingLeft=this._highlightPaddingLeft,e.highlightPaddingRight=this._highlightPaddingRight,e.letterSpacing=this._letterSpacing,e.textIndent=this._textIndent,e.rtl=this._rtl,e.cutSx=this._cutSx,e.cutEx=this._cutEx,e.cutSy=this._cutSy,e.cutEy=this._cutEy,e.advancedRenderer=this._advancedRenderer,e}}let ue=ni.prototype;ue._text="";ue._w=0;ue._h=0;ue._fontStyle="normal";ue._fontSize=40;ue._fontFace=null;ue._wordWrap=!0;ue._wordWrapWidth=0;ue._wordBreak=!1;ue._textOverflow="";ue._lineHeight=null;ue._textBaseline="alphabetic";ue._textAlign="left";ue._verticalAlign="top";ue._offsetY=null;ue._maxLines=0;ue._maxLinesSuffix="..";ue._textColor=4294967295;ue._paddingLeft=0;ue._paddingRight=0;ue._shadow=!1;ue._shadowColor=4278190080;ue._shadowOffsetX=0;ue._shadowOffsetY=0;ue._shadowBlur=5;ue._highlight=!1;ue._highlightHeight=0;ue._highlightColor=4278190080;ue._highlightOffset=0;ue._highlightPaddingLeft=0;ue._highlightPaddingRight=0;ue._letterSpacing=0;ue._textIndent=0;ue._rtl=0;ue._cutSx=0;ue._cutEx=0;ue._cutSy=0;ue._cutEy=0;ue._advancedRenderer=!1;ue._fontBaselineRatio=0;class Gd extends _t{constructor(e){super(e),this._textureSource=void 0}get textureSource(){return this._textureSource}set textureSource(e){e!==this._textureSource&&(e.isResultTexture&&(this._precision=this.stage.getRenderPrecision()),this._textureSource=e,this._changed())}_getTextureSource(){return this._textureSource}}class _l extends tt{constructor(e,t,i,s){super(),this.manager=e,this._settings=t,this._element=i,this._getter=i.constructor.getGetter(s),this._setter=i.constructor.getSetter(s),this._merger=t.merger,this._merger||(this._merger=i.constructor.getMerger(s)),this._startValue=this._getter(this._element),this._targetValue=this._startValue,this._p=1,this._delayLeft=0}start(e){this._startValue=this._getter(this._element),this.isAttached()?e===this._startValue?this.reset(e,1):(this._targetValue=e,this._p=0,this._delayLeft=this._settings.delay,this.emit("start"),this.add()):(this._targetValue=e,this._p=1,this._updateDrawValue())}finish(){this._p<1&&(this._p=1)}stop(){this.emit("stop"),this.manager.removeActive(this)}pause(){this.stop()}play(){this.manager.addActive(this)}reset(e,t){this.isAttached()?(this._startValue=this._getter(this._element),this._targetValue=e,this._p=t,this.add()):(this._startValue=this._getter(this._element),this._targetValue=e,this._p=1,this._updateDrawValue())}_updateDrawValue(){this._setter(this._element,this.getDrawValue())}add(){this.manager.addActive(this)}isAttached(){return this._element.attached}isRunning(){return this._p<1}progress(e){if(this.isAttached()||(this._p=1),this.p<1){if(this.delayLeft>0)if(this._delayLeft-=e,this.delayLeft<0)e=-this.delayLeft,this._delayLeft=0,this.emit("delayEnd");else return;this._settings.duration==0?this._p=1:this._p+=e/this._settings.duration,this._p>=1&&(this._p=1)}this._updateDrawValue(),this.invokeListeners()}invokeListeners(){this.emit("progress",this.p),this.p===1&&this.emit("finish")}updateTargetValue(e){let t=this._settings.timingFunctionImpl(this.p);t===1?this._targetValue=e:t===0?(this._startValue=this._targetValue,this._targetValue=e):(this._startValue=e-(e-this._targetValue)/(1-t),this._targetValue=e)}getDrawValue(){if(this.p>=1)return this.targetValue;{let e=this._settings._timingFunctionImpl(this.p);return this._merger(this.targetValue,this.startValue,e)}}skipDelay(){this._delayLeft=0}get startValue(){return this._startValue}get targetValue(){return this._targetValue}get p(){return this._p}get delayLeft(){return this._delayLeft}get element(){return this._element}get settings(){return this._settings}set settings(e){this._settings=e}}_l.prototype.isTransition=!0;class Hd{constructor(){this._items=[],this._refs={}}get(){return this._items}get first(){return this._items[0]}get last(){return this._items.length?this._items[this._items.length-1]:void 0}add(e){this.addAt(e,this._items.length)}addAt(e,t){if(t>=0&&t<=this._items.length){let i=this._items.indexOf(e);if(i===t)return e;if(H.isObjectLiteral(e)){const s=e;e=this.createItem(s),e.patch(s)}i!=-1?this.setAt(e,t):(e.ref&&(this._refs[e.ref]=e),this._items.splice(t,0,e),this.onAdd(e,t))}else throw new Error("addAt: The index "+t+" is out of bounds "+this._items.length)}replaceByRef(e){if(e.ref){const t=this.getByRef(e.ref);if(!t)throw new Error("replaceByRef: no item found with reference: "+e.ref);this.replace(e,t)}else throw new Error("replaceByRef: no ref specified in item");this.addAt(e,this._items.length)}replace(e,t){const i=this.getIndex(t);if(i===-1)throw new Error("replace: The previous item does not exist");this.setAt(e,i)}setAt(e,t){if(t>=0&&t<=this._items.length){if(H.isObjectLiteral(e)){const s=e;e=this.createItem(s),e.patch(s)}let i=this._items.indexOf(e);if(i!=-1){if(i!==t){const s=i;s!==t&&(this._items.splice(s,1),this._items.splice(t,0,e),this.onMove(e,s,t))}}else if(t<this._items.length){this._items[t].ref&&(this._refs[this._items[t].ref]=void 0);const s=this._items[t];this._items[t]=e,e.ref&&(this._refs[e.ref]=e),this.onSet(e,t,s)}else throw new Error("setAt: The index "+t+" is out of bounds "+this._items.length)}else throw new Error("setAt: The index "+t+" is out of bounds "+this._items.length)}getAt(e){return this._items[e]}getIndex(e){return this._items.indexOf(e)}remove(e){let t=this._items.indexOf(e);t!==-1&&this.removeAt(t)}removeAt(e){if(e>=0&&e<this._items.length){const t=this._items[e];return t.ref&&(this._refs[t.ref]=void 0),this._items.splice(e,1),this.onRemove(t,e),t}else throw new Error(`removeAt: The index ${e} is out of bounds ${this._items.length-1}`)}clear(){if(this._items.length){let t=this._items;this._items=[],this._refs={},this.onSync(t,[],[])}}a(e){if(H.isObjectLiteral(e)){let t=this.createItem(e);return t.patch(e),this.add(t),t}else if(Array.isArray(e)){for(let t=0,i=e.length;t<i;t++)this.a(e[t]);return null}else if(this.isItem(e))return this.add(e),e}get length(){return this._items.length}_getRefs(){return this._refs}getByRef(e){return this._refs[e]}clearRef(e){delete this._refs[e]}setRef(e,t){this._refs[e]=t}patch(e){H.isObjectLiteral(e)?this._setByObject(e):Array.isArray(e)&&this._setByArray(e)}_setByObject(e){let t=this._getRefs(),i=Object.keys(e);for(let s=0,r=i.length;s<r;s++){let o=i[s],a=e[o],l=t[o];if(!l)this.isItem(a)?(a.ref=o,this.add(a)):(l=this.createItem(a),l.ref=o,l.patch(a),this.add(l));else if(this.isItem(a)){if(l!==a){let h=this.getIndex(l);a.ref=o,this.setAt(a,h)}}else l.patch(a)}}_equalsArray(e){let t=!0;if(e.length===this._items.length)for(let i=0,s=this._items.length;i<s&&t;i++)t=t&&this._items[i]===e[i];else t=!1;return t}_setByArray(e){if(this._equalsArray(e))return;for(let s=0,r=this._items.length;s<r;s++)this._items[s].marker=!0;let t,i=[];for(let s=0,r=e.length;s<r;s++){let o=e[s];if(this.isItem(o))o.marker=!1,i.push(o);else{let a=o.ref,l;a&&(t||(t=this._getRefs()),l=t[a]),l?l.marker=!1:l=this.createItem(o),H.isObjectLiteral(o)&&l.patch(o),i.push(l)}}this._setItems(i)}_setItems(e){let t=this._items;this._items=e;let i=t.filter(r=>{let o=r.marker;return delete r.marker,o}),s=e.filter(r=>t.indexOf(r)===-1);if(i.length||s.length){this._refs={};for(let r=0,o=this._items.length;r<o;r++){let a=this._items[r].ref;a&&(this._refs[a]=this._items[r])}}this.onSync(i,s,e)}sort(e){const t=this._items.slice();t.sort(e),this._setByArray(t)}onAdd(e,t){}onRemove(e,t){}onSync(e,t,i){}onSet(e,t,i){}onMove(e,t,i){}createItem(e){throw new Error("ObjectList.createItem must create and return a new object")}isItem(e){return!1}forEach(e){this.get().forEach(e)}}class L_ extends Hd{constructor(e){super(),this._element=e}_connectParent(e){const t=e.parent;if(t&&t!==this._element){const i=e.parent.childList,s=i.getIndex(e);e.ref&&(i._refs[e.ref]=void 0),i._items.splice(s,1),t.core.removeChildAt(s)}e._setParent(this._element)}onAdd(e,t){this._connectParent(e),this._element.core.addChildAt(t,e.core)}onRemove(e,t){e._setParent(null),this._element.core.removeChildAt(t)}onSync(e,t,i){for(let r=0,o=e.length;r<o;r++)e[r]._setParent(null);for(let r=0,o=t.length;r<o;r++)this._connectParent(t[r]);let s=r=>r.core;this._element.core.syncChildren(e.map(s),t.map(s),i.map(s))}onSet(e,t,i){i._setParent(null),this._connectParent(e),this._element.core.setChildAt(t,e.core)}onMove(e,t,i){this._element.core.moveChild(t,i)}createItem(e){return e.type?new e.type(this._element.stage):this._element.stage.createElement()}isItem(e){return e.isElement}}class Ce{constructor(e){this.stage=e,this.__id=Ce.id++,this.__start(),this._hasEventListeners=!1,this.__core=new Bi(this),this.__ref=null,this.__attached=!1,this.__enabled=!1,this.__active=!1,this.__parent=null,this.__texture=null,this.__displayedTexture=null,this.__tags=null,this.__treeTags=null,this.__tagRoot=!1,this.__childList=null,this._w=0,this._h=0}__start(){}get id(){return this.__id}set ref(e){if(this.__ref!==e){const t=e.charCodeAt(0);H.isUcChar(t)||this._throwError("Ref must start with an upper case character: "+e),this.__ref!==null&&(this.removeTag(this.__ref),this.__parent&&this.__parent.__childList.clearRef(this.__ref)),this.__ref=e,this.__ref&&(this._addTag(this.__ref),this.__parent&&this.__parent.__childList.setRef(this.__ref,this))}}get ref(){return this.__ref}get core(){return this.__core}setAsRoot(){this.__core.setAsRoot(),this._updateAttachedFlag(),this._updateEnabledFlag()}get isRoot(){return this.__core.isRoot}_setParent(e){this.__parent!==e&&(this.__parent&&this._unsetTagsParent(),this.__parent=e,e&&this._setTagsParent(),this._updateAttachedFlag(),this._updateEnabledFlag(),this._updateCollision(),this.isRoot&&e&&this._throwError("Root should not be added as a child! Results are unspecified!"))}getDepth(){let e=0,t=this.__parent;for(;t;)e++,t=t.__parent;return e}getAncestor(e){let t=this;for(;e>0&&t.__parent;)t=t.__parent,e--;return t}getAncestors(){const e=[];let t=this;for(;t;)e.push(t),t=t.__parent;return e}getAncestorAtDepth(e){let t=this.getDepth()-e;return t<0?null:this.getAncestor(t)}isAncestorOf(e){let t=e;for(;t=t.parent;)if(this===t)return!0;return!1}getSharedAncestor(e){let t=this,i=e,s=t.getDepth(),r=i.getDepth();s>r?t=t.getAncestor(s-r):r>s&&(i=i.getAncestor(r-s));do{if(t===i)return t;t=t.__parent,i=i.__parent}while(t&&i);return null}get attached(){return this.__attached}get enabled(){return this.__enabled}get active(){return this.__active}_isAttached(){return this.__parent?this.__parent.__attached:this.stage.root===this}_isEnabled(){return this.__core.visible&&this.__core.alpha>0&&(this.__parent?this.__parent.__enabled:this.stage.root===this)}_isActive(){return this._isEnabled()&&this.withinBoundsMargin}_updateAttachedFlag(){let e=this._isAttached();if(this.__attached!==e){this.__attached=e,e&&this._onSetup();let t=this._children.get();if(t){let i=t.length;if(i>0)for(let s=0;s<i;s++)t[s]._updateAttachedFlag()}e?this._onAttach():this._onDetach()}}_updateEnabledFlag(){let e=this._isEnabled();if(this.__enabled!==e){e?(this._onEnabled(),this._setEnabledFlag()):(this._onDisabled(),this._unsetEnabledFlag());let t=this._children.get();if(t){let i=t.length;if(i>0)for(let s=0;s<i;s++)t[s]._updateEnabledFlag()}}}_setEnabledFlag(){this.__enabled=!0,this._updateDimensions(),this._updateTextureCoords(),this.__texture&&this.__texture.addElement(this),this.withinBoundsMargin&&this._setActiveFlag(),this.__core.shader&&this.__core.shader.addElement(this.__core)}_unsetEnabledFlag(){this.__active&&this._unsetActiveFlag(),this.__texture&&this.__texture.removeElement(this),this.__core.shader&&this.__core.shader.removeElement(this.__core),this._texturizer&&this.texturizer.filters.forEach(e=>e.removeElement(this.__core)),this.__enabled=!1}_setActiveFlag(){this.__active=!0,this.__texture&&this.__texture.incActiveCount(),this.__texture&&this._enableTexture(),this._onActive()}_unsetActiveFlag(){this.__texture&&this.__texture.decActiveCount(),this.__active=!1,this.__texture&&this._disableTexture(),this._hasTexturizer()&&this.texturizer.deactivate(),this._onInactive()}_onSetup(){}_onAttach(){}_onDetach(){}_onEnabled(){}_onDisabled(){}_onActive(){}_onInactive(){}_onResize(){}_getRenderWidth(){return this._w?this._w:this.__displayedTexture?this.__displayedTexture.getRenderWidth():this.__texture?this.__texture.getRenderWidth():0}_getRenderHeight(){return this._h?this._h:this.__displayedTexture?this.__displayedTexture.getRenderHeight():this.__texture?this.__texture.getRenderHeight():0}get renderWidth(){return this.__enabled?this.__core.getRenderWidth():this._getRenderWidth()}get renderHeight(){return this.__enabled?this.__core.getRenderHeight():this._getRenderHeight()}get finalX(){return this.__core.x}get finalY(){return this.__core.y}get finalW(){return this.__core.w}get finalH(){return this.__core.h}textureIsLoaded(){return this.__texture&&this.__texture.isLoaded()}loadTexture(){this.__texture&&(this.__texture.load(),(!this.__texture.isUsed()||!this._isEnabled())&&this._updateDimensions())}_enableTextureError(){const e=this.__texture.loadError;e&&this.emit("txError",e,this.__texture._source)}_enableTexture(){this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):(this._setDisplayedTexture(null),this._enableTextureError())}_disableTexture(){this._setDisplayedTexture(null)}get texture(){return this.__texture}set texture(e){let t;if(H.isObjectLiteral(e))e.type?t=new e.type(this.stage):t=this.texture,t&&Xe.patchObject(t,e);else if(!e)t=null;else if(e.isTexture)t=e;else if(e.isTextureSource)t=new Gd(this.stage),t.textureSource=e;else{console.error("[Lightning] Please specify a texture type.");return}const i=this.__texture;t!==i&&(this.__texture=t,this.__texture?this.__enabled&&(this.__texture.addElement(this),this.withinBoundsMargin&&(this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):this._enableTextureError())):this._setDisplayedTexture(null),i&&i!==this.__displayedTexture&&i.removeElement(this),this._updateDimensions())}get displayedTexture(){return this.__displayedTexture}_setDisplayedTexture(e){let t=this.__displayedTexture;t&&e!==t&&this.__texture!==t&&t.removeElement(this);const i=this.__core.displayedTextureSource,s=(e?e._source:null)!==i;this.__displayedTexture=e,this._updateDimensions(),this.__displayedTexture?s&&(this._updateTextureCoords(),this.__core.setDisplayedTextureSource(this.__displayedTexture._source)):this.__core.setDisplayedTextureSource(null),s&&(this.__displayedTexture?(this.stage.removeUpdateSourceTexture(this.__displayedTexture),this.emit("txLoaded",this.__displayedTexture)):this.emit("txUnloaded",this.__displayedTexture))}onTextureSourceLoaded(){this.active&&this._setDisplayedTexture(this.__texture)}onTextureSourceLoadError(e){this.emit("txError",e,this.__texture._source)}forceRenderUpdate(){this.__core.setHasRenderUpdates(3)}onDisplayedTextureClippingChanged(){this._updateDimensions(),this._updateTextureCoords()}onPrecisionChanged(){this._updateDimensions()}onDimensionsChanged(e,t){this.texture instanceof ni&&(this.texture.w=e,this.texture.h=t,this.w=e,this.h=t)}_updateDimensions(){let e=this._getRenderWidth(),t=this._getRenderHeight(),i=!1;(!e||!t)&&!this.__displayedTexture&&this.__texture&&(e=e||this.__texture.mw,t=t||this.__texture.mh,(!e||!t)&&this.__texture.isAutosizeTexture()&&(i=!0)),this.__core.setDimensions(e,t,i)&&this._onResize()}_updateTextureCoords(){if(this.displayedTexture&&this.displayedTexture._source){let e=this.displayedTexture,t=this.displayedTexture._source,i=0,s=0,r=1,o=1;if(e.clipping){let a=t.getRenderWidth(),l=t.getRenderHeight(),h,c,u,d;h=1/a,c=1/l,e.pw?u=e.pw*h:u=(a-e.px)*h,e.ph?d=e.ph*c:d=(l-e.py)*c,h*=e.px,c*=e.py,i=h,s=c,r=r*u+h,o=o*d+c,i=Math.max(0,i),s=Math.max(0,s),r=Math.min(1,r),o=Math.min(1,o)}if(t._flipTextureY){let a=o;o=s,s=a}this.__core.setTextureCoords(i,s,r,o)}}getCornerPoints(){return this.__core.getCornerPoints()}_unsetTagsParent(){this.__tags&&this.__tags.forEach(i=>{let s=this;for(;(s=s.__parent)&&(s.__treeTags.get(i).delete(this),!s.__tagRoot););});let e=null,t=0;if(this.__treeTags&&!this.__tagRoot&&(e=H.iteratorToArray(this.__treeTags.keys()),t=e.length,t>0))for(let i=0;i<t;i++){let s=this.__treeTags.get(e[i]),r=this;for(;r=r.__parent;){let o=r.__treeTags.get(e[i]);if(s.forEach(function(a){o.delete(a)}),r.__tagRoot)break}}}_setTagsParent(){this.__tags&&this.__tags.forEach(e=>{let t=this;for(;t=t.__parent;){t.__treeTags||(t.__treeTags=new Map);let i=t.__treeTags.get(e);if(i||(i=new Set,t.__treeTags.set(e,i)),i.add(this),t.__tagRoot)break}}),this.__treeTags&&this.__treeTags.size&&(this.__tagRoot||this.__treeTags.forEach((e,t)=>{let i=this;for(;!i.__tagRoot&&(i=i.__parent);){i.__tagRoot,i.__treeTags||(i.__treeTags=new Map);let s=i.__treeTags.get(t);s||(s=new Set,i.__treeTags.set(t,s)),e.forEach(function(r){s.add(r)})}}))}_getByTag(e){if(!this.__treeTags)return[];let t=this.__treeTags.get(e);return t?H.setToArray(t):[]}getTags(){return this.__tags?this.__tags:[]}setTags(e){e=e.reduce((a,l)=>a.concat(l.split(" ")),[]),this.__ref&&e.push(this.__ref);let t,i=e.length,s=[],r=[];for(t=0;t<i;t++)this.hasTag(e[t])||r.push(e[t]);let o=this.tags||[];for(i=o.length,t=0;t<i;t++)e.indexOf(o[t])==-1&&s.push(o[t]);for(t=0;t<s.length;t++)this.removeTag(s[t]);for(t=0;t<r.length;t++)this.addTag(r[t])}addTag(e){if(e.indexOf(" ")===-1)H.isUcChar(e.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character."),this._addTag(e);else{const t=e.split(" ");for(let i=0,s=t.length;i<s;i++){const r=t[i];H.isUcChar(r.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character."),this._addTag(r)}}}_addTag(e){if(this.__tags||(this.__tags=[]),this.__tags.indexOf(e)===-1){this.__tags.push(e);let t=this.__parent;if(t)do{t.__treeTags||(t.__treeTags=new Map);let i=t.__treeTags.get(e);i||(i=new Set,t.__treeTags.set(e,i)),i.add(this)}while(!t.__tagRoot&&(t=t.__parent))}}removeTag(e){let t=this.__tags.indexOf(e);if(t!==-1){this.__tags.splice(t,1);let i=this.__parent;if(i)do{let s=i.__treeTags.get(e);s&&s.delete(this)}while(!i.__tagRoot&&(i=i.__parent))}}hasTag(e){return this.__tags&&this.__tags.indexOf(e)!==-1}_tag(e){if(e.indexOf(".")!==-1)return this.mtag(e)[0];if(this.__treeTags){let t=this.__treeTags.get(e);if(t){const i=t.values().next();return i?i.value:void 0}}}get tag(){return this._tag}set tag(e){this.tags=e}mtag(e){if(e.indexOf(".")>=0){let i=e.split("."),s=this._getByTag(i[0]),r=1,o=i.length;for(;s.length&&r<o;){let a=[];for(let l=0,h=s.length;l<h;l++)a=a.concat(s[l]._getByTag(i[r]));s=a,r++}return s}else return this._getByTag(e)}stag(e,t){let i=this.mtag(e),s=i.length;for(let r=0;r<s;r++)Xe.patchObject(i[r],t)}get tagRoot(){return this.__tagRoot}set tagRoot(e){this.__tagRoot!==e&&(e?this._unsetTagsParent():this._setTagsParent(),this.__tagRoot=e)}sel(e){const t=this.select(e);if(t.length)return t[0]}select(e){if(e.indexOf(",")!==-1){let t=e.split(","),i=[];for(let s=0;s<t.length;s++)i=i.concat(this._select(t[s]));return i}else return this._select(e)}_select(e){if(e==="")return[this];let t=e.indexOf("."),i=e.indexOf(">");if(t===-1&&i===-1)return this.mtag(e);let s;return i===0?(s=!0,e=e.substr(1)):t===0?(s=!1,e=e.substr(1)):s=!1,this._selectChilds(e,s)}_selectChilds(e,t){const i=e.indexOf("."),s=e.indexOf(">");if(i===-1&&s===-1)if(t){const r=this.getByRef(e);return r?[r]:[]}else return this.mtag(e);if(s===-1||i!==-1&&i<s){let r;const o=e.substr(0,i);if(t){const h=this.getByRef(o);r=h?[h]:[]}else r=this.mtag(o);let a=[];const l=e.substr(i+1);for(let h=0,c=r.length;h<c;h++)a=a.concat(r[h]._selectChilds(l,!1));return a}else{let r;const o=e.substr(0,s);if(t){const h=this.getByRef(o);r=h?[h]:[]}else r=this.mtag(o);let a=[];const l=e.substr(s+1);for(let h=0,c=r.length;h<c;h++)a=a.concat(r[h]._selectChilds(l,!0));return a}}getByRef(e){return this.childList.getByRef(e)}getLocationString(){let e;e=this.__parent?this.__parent._children.getIndex(this):"R";let t=this.getTags(),i=this.__parent?this.__parent.getLocationString():"";return this.ref?i+=":["+e+"]"+this.ref:t.length?i+=":["+e+"]"+t.join(","):i+=":["+e+"]#"+this.id,i}toString(){let e=this.getSettings();return Ce.getPrettyString(e,"")}static getPrettyString(e,t){let i=e.children;delete e.children;let s=["color","colorUl","colorUr","colorBl","colorBr"],r=JSON.stringify(e,function(o,a){return s.indexOf(o)!==-1?"COLOR["+a.toString(16)+"]":a});if(r=r.replace(/"COLOR\[([a-f0-9]{1,8})\]"/g,"0x$1"),i){let o="";if(H.isObjectLiteral(i)){let a=Object.keys(i);o="";for(let h=0,c=a.length;h<c;h++)o+=`
${t}  "${a[h]}":`,delete i[a[h]].ref,o+=Ce.getPrettyString(i[a[h]],t+"  ")+(h<c-1?",":"");let l=r==="{}";r=r.substr(0,r.length-1)+(l?"":",")+o+`
`+t+"}"}else{let a=i.length;o="[";for(let h=0;h<a;h++)o+=Ce.getPrettyString(i[h],t+"  ")+(h<a-1?",":"")+`
`;o+=t+"]}";let l=r==="{}";r=r.substr(0,r.length-1)+(l?"":",")+`"children":
`+t+o+"}"}}return r}getSettings(){let e=this.getNonDefaults(),t=this._children.get();if(t){let i=t.length;if(i){const s=[];let r=!1;for(let o=0;o<i;o++)s.push(t[o].getSettings()),r=r||!t[o].ref;r?e.children=s:(e.children={},s.forEach(o=>{e.children[o.ref]=o}))}}return e.id=this.id,e}getNonDefaults(){let e={};if(this.constructor!==Ce&&(e.type=this.constructor.name),this.__ref&&(e.ref=this.__ref),this.__tags&&this.__tags.length&&(e.tags=this.__tags),this.x!==0&&(e.x=this.x),this.y!==0&&(e.y=this.y),this.w!==0&&(e.w=this.w),this.h!==0&&(e.h=this.h),this.scaleX===this.scaleY?this.scaleX!==1&&(e.scale=this.scaleX):(this.scaleX!==1&&(e.scaleX=this.scaleX),this.scaleY!==1&&(e.scaleY=this.scaleY)),this.pivotX===this.pivotY?this.pivotX!==.5&&(e.pivot=this.pivotX):(this.pivotX!==.5&&(e.pivotX=this.pivotX),this.pivotY!==.5&&(e.pivotY=this.pivotY)),this.mountX===this.mountY?this.mountX!==0&&(e.mount=this.mountX):(this.mountX!==0&&(e.mountX=this.mountX),this.mountY!==0&&(e.mountY=this.mountY)),this.alpha!==1&&(e.alpha=this.alpha),this.visible||(e.visible=!1),this.rotation!==0&&(e.rotation=this.rotation),this.colorUl===this.colorUr&&this.colorBl===this.colorBr&&this.colorUl===this.colorBl?this.colorUl!==4294967295&&(e.color=this.colorUl.toString(16)):(this.colorUl!==4294967295&&(e.colorUl=this.colorUl.toString(16)),this.colorUr!==4294967295&&(e.colorUr=this.colorUr.toString(16)),this.colorBl!==4294967295&&(e.colorBl=this.colorBl.toString(16)),this.colorBr!==4294967295&&(e.colorBr=this.colorBr.toString(16))),this.zIndex&&(e.zIndex=this.zIndex),this.forceZIndexContext&&(e.forceZIndexContext=!0),this.clipping&&(e.clipping=this.clipping),this.clipbox||(e.clipbox=this.clipbox),this.__texture){let t=this.__texture.getNonDefaults();Object.keys(t).length&&(e.texture=t)}if(this.shader&&H.isFunction(this.shader.getNonDefaults)){let t=this.shader.getNonDefaults();Object.keys(t).length&&(e.shader=t)}return this._hasTexturizer()&&(this.texturizer.enabled&&(e.renderToTexture=this.texturizer.enabled),this.texturizer.lazy&&(e.renderToTextureLazy=this.texturizer.lazy),this.texturizer.colorize&&(e.colorizeResultTexture=this.texturizer.colorize),this.texturizer.renderOffscreen&&(e.renderOffscreen=this.texturizer.renderOffscreen)),e}static getGetter(e){let t=Ce.PROP_GETTERS.get(e);return t||(t=new Function("obj","return obj."+e),Ce.PROP_GETTERS.set(e,t)),t}static getSetter(e){let t=Ce.PROP_SETTERS.get(e);return t||(t=new Function("obj","v","obj."+e+" = v"),Ce.PROP_SETTERS.set(e,t)),t}get withinBoundsMargin(){return this.__core._withinBoundsMargin}_enableWithinBoundsMargin(){this.__enabled&&this._setActiveFlag()}_disableWithinBoundsMargin(){this.__active&&this._unsetActiveFlag()}set boundsMargin(e){if(!Array.isArray(e)&&e!==null)throw new Error("boundsMargin should be an array of left-top-right-bottom values or null (inherit margin)");this.__core.boundsMargin=e}get boundsMargin(){return this.__core.boundsMargin}get x(){return this.__core.offsetX}set x(e){this.__core.offsetX=e}get y(){return this.__core.offsetY}set y(e){this.__core.offsetY=e}get w(){return this._w}set w(e){H.isFunction(e)?(this._w=0,this.__core.funcW=e):(e=Math.max(e,0),this._w!==e&&(this.__core.disableFuncW(),this._w=e,this._updateDimensions()))}get h(){return this._h}set h(e){H.isFunction(e)?(this._h=0,this.__core.funcH=e):(e=Math.max(e,0),this._h!==e&&(this.__core.disableFuncH(),this._h=e,this._updateDimensions()))}get collision(){return this._collision}set collision(e){this._collision=e}_updateCollision(){this.collision&&this.__parent&&this.__parent.collision===void 0&&(this.__parent.collision=2)}get scaleX(){return this.__core.scaleX}set scaleX(e){this.__core.scaleX=e}get scaleY(){return this.__core.scaleY}set scaleY(e){this.__core.scaleY=e}get scale(){return this.__core.scale}set scale(e){this.__core.scale=e}get pivotX(){return this.__core.pivotX}set pivotX(e){this.__core.pivotX=e}get pivotY(){return this.__core.pivotY}set pivotY(e){this.__core.pivotY=e}get pivot(){return this.__core.pivot}set pivot(e){this.__core.pivot=e}get mountX(){return this.__core.mountX}set mountX(e){this.__core.mountX=e}get mountY(){return this.__core.mountY}set mountY(e){this.__core.mountY=e}get mount(){return this.__core.mount}set mount(e){this.__core.mount=e}get rotation(){return this.__core.rotation}set rotation(e){this.__core.rotation=e}get alpha(){return this.__core.alpha}set alpha(e){this.__core.alpha=e}get visible(){return this.__core.visible}set visible(e){this.__core.visible=e}get colorUl(){return this.__core.colorUl}set colorUl(e){this.__core.colorUl=e}get colorUr(){return this.__core.colorUr}set colorUr(e){this.__core.colorUr=e}get colorBl(){return this.__core.colorBl}set colorBl(e){this.__core.colorBl=e}get colorBr(){return this.__core.colorBr}set colorBr(e){this.__core.colorBr=e}get color(){return this.__core.colorUl}set color(e){(this.colorUl!==e||this.colorUr!==e||this.colorBl!==e||this.colorBr!==e)&&(this.colorUl=e,this.colorUr=e,this.colorBl=e,this.colorBr=e)}get colorTop(){return this.colorUl}set colorTop(e){(this.colorUl!==e||this.colorUr!==e)&&(this.colorUl=e,this.colorUr=e)}get colorBottom(){return this.colorBl}set colorBottom(e){(this.colorBl!==e||this.colorBr!==e)&&(this.colorBl=e,this.colorBr=e)}get colorLeft(){return this.colorUl}set colorLeft(e){(this.colorUl!==e||this.colorBl!==e)&&(this.colorUl=e,this.colorBl=e)}get colorRight(){return this.colorUr}set colorRight(e){(this.colorUr!==e||this.colorBr!==e)&&(this.colorUr=e,this.colorBr=e)}get zIndex(){return this.__core.zIndex}set zIndex(e){this.__core.zIndex=e}get forceZIndexContext(){return this.__core.forceZIndexContext}set forceZIndexContext(e){this.__core.forceZIndexContext=e}get clipping(){return this.__core.clipping}set clipping(e){this.__core.clipping=e}get clipbox(){return this.__core.clipbox}set clipbox(e){this.__core.clipbox=e}get tags(){return this.getTags()}set tags(e){Array.isArray(e)||(e=[e]),this.setTags(e)}set t(e){this.tags=e}get _children(){return this.__childList||(this.__childList=new L_(this,!1)),this.__childList}get childList(){return this._allowChildrenAccess()||this._throwError("Direct access to children is not allowed in "+this.getLocationString()),this._children}hasChildren(){return this._allowChildrenAccess()&&this.__childList&&this.__childList.length>0}_allowChildrenAccess(){return!0}get children(){return this.childList.get()}set children(e){this.childList.patch(e)}add(e){return this.childList.a(e)}get p(){return this.__parent}get parent(){return this.__parent}get src(){if(this.texture&&this.texture instanceof ml)return this.texture._src}set src(e){const t=new ml(this.stage);t.src=e,this.texture=t}set mw(e){this.texture?(this.texture.mw=e,this._updateDimensions()):this._throwError("Please set mw after setting a texture.")}set mh(e){this.texture?(this.texture.mh=e,this._updateDimensions()):this._throwError("Please set mh after setting a texture.")}get rect(){return this.texture===this.stage.rectangleTexture}set rect(e){e?this.texture=this.stage.rectangleTexture:this.texture=null}enableTextTexture(){return(!this.texture||!(this.texture instanceof ni))&&(this.texture=new ni(this.stage),!this.texture.w&&!this.texture.h&&(this.texture.w=this.w,this.texture.h=this.h)),this.texture}get text(){return this.texture&&this.texture instanceof ni?this.texture:null}set text(e){(!this.texture||!(this.texture instanceof ni))&&this.enableTextTexture(),H.isString(e)?this.texture.text=e:this.texture.patch(e)}set onUpdate(e){this.__core.onUpdate=e}set onAfterCalcs(e){this.__core.onAfterCalcs=e}set onAfterUpdate(e){this.__core.onAfterUpdate=e}forceUpdate(){this.__core._setHasUpdates()}get shader(){return this.__core.shader}set shader(e){if(H.isObjectLiteral(e)&&!e.type)this.shader&&this.shader.patch(e);else{const t=Gr.create(this.stage,e);this.__enabled&&this.__core.shader&&this.__core.shader.removeElement(this.__core),this.__core.shader=t,this.__enabled&&this.__core.shader&&this.__core.shader.addElement(this.__core)}}_hasTexturizer(){return!!this.__core._texturizer}get renderToTexture(){return this.rtt}set renderToTexture(e){this.rtt=e}get rtt(){return this._hasTexturizer()&&this.texturizer.enabled}set rtt(e){this.texturizer.enabled=e}get rttLazy(){return this._hasTexturizer()&&this.texturizer.lazy}set rttLazy(e){this.texturizer.lazy=e}get renderOffscreen(){return this._hasTexturizer()&&this.texturizer.renderOffscreen}set renderOffscreen(e){this.texturizer.renderOffscreen=e}get colorizeResultTexture(){return this._hasTexturizer()&&this.texturizer.colorize}set colorizeResultTexture(e){this.texturizer.colorize=e}getTexture(){return this.texturizer._getTextureSource()}get texturizer(){return this.__core.texturizer}patch(e){let t=Object.keys(e);for(let i=0,s=t.length;i<s;i++){let r=t[i];const o=e[r],a=r.charCodeAt(0);if(H.isUcChar(a)){const l=this.getByRef(r);if(l)o===void 0?l.parent&&l.parent.childList.remove(l):H.isObjectLiteral(o)?l.patch(o):o.isElement?(o.ref=r,this.childList.replace(o,l)):this._throwError("Unexpected value for path: "+r);else if(o!==void 0){let h;H.isObjectLiteral(o)?(h=this.childList.createItem(o),h.patch(o)):H.isObject(o)&&(h=o),h.isElement&&(h.ref=r),this.childList.a(h)}}else Xe.patchObjectProperty(this,r,o)}}_throwError(e){throw new Error(this.constructor.name+" ("+this.getLocationString()+"): "+e)}animation(e){return this.stage.animations.createAnimation(this,e)}transition(e,t=null){return t===null?this._getTransition(e):(this._setTransition(e,t),null)}set transitions(e){Object.keys(e).forEach(i=>{this.transition(i,e[i])})}set smooth(e){Object.keys(e).forEach(i=>{let s=e[i];Array.isArray(s)?this.setSmooth(i,s[0],s[1]):this.setSmooth(i,s)})}fastForward(e){if(this._transitions){let t=this._transitions[e];t&&t.isTransition&&t.finish()}}_getTransition(e){this._transitions||(this._transitions={});let t=this._transitions[e];return t?t.isTransitionSettings&&(t=new _l(this.stage.transitions,t,this,e)):t=new _l(this.stage.transitions,this.stage.transitions.defaultTransitionSettings,this,e),this._transitions[e]=t,t}_setTransition(e,t){if(!t)this._removeTransition(e);else{H.isObjectLiteral(t)&&(t=this.stage.transitions.createSettings(t)),this._transitions||(this._transitions={});let i=this._transitions[e];if(i&&i.isTransition)return i.settings=t,i;this._transitions[e]=t}}_removeTransition(e){this._transitions&&delete this._transitions[e]}getSmooth(e,t){let i=this._getTransition(e);return i&&i.isAttached()?i.targetValue:t}setSmooth(e,t,i){i&&this._setTransition(e,i);let s=this._getTransition(e);return s.start(t),s}get flex(){return this.__core.flex}set flex(e){this.__core.flex=e}get flexItem(){return this.__core.flexItem}set flexItem(e){this.__core.flexItem=e}static isColorProperty(e){return e.toLowerCase().indexOf("color")>=0}static getMerger(e){return Ce.isColorProperty(e)?ie.mergeColors:ie.mergeNumbers}toJSON(){const e=[`${this.constructor.name}`],t={};return t[e]={},this.hasChildren()?Ce.collectChildren(t[e],this.__childList):t[e]={...Ce.getProperties(this)},t}static collectChildren(e,t){const i=t;for(let s=0,r=i.length;s<r;s++){const o=i.getAt(s),a=`${o.__ref||`Element-${o.id}`}`,l=this.getProperties(o);e[a]={...l},o.hasChildren()&&(e[a].children={},this.collectChildren(e[a].children,o.__childList))}}static getProperties(e){const t={},i=["alpha","active","attached","boundsMargin","color","clipping","enabled","h","id","isComponent","mount","mountY","mountX","pivot","pivotX","pivotY","ref","renderOffscreen","renderToTexture","scale","scaleX","scaleY","state","tag","visible","w","x","y","zIndex","!!flex","!!flexItem","hasFocus()","hasFinalFocus()"];let s=i.length;for(;s--;){let r=i[s];const o=/^!{2}/,a=/\(\)$/;o.test(r)?(r=r.substring(2,r.length),t[r]=!!e[r]):a.test(r)?(r=r.substring(0,r.length-2),typeof e[r]=="function"&&(t[r]=e[r]())):t[r]=e[r]}return{...t,...e.getNonDefaults()}}}tt.addAsMixin(Ce);Ce.prototype.isElement=1;Ce.id=1;Ce.PROP_GETTERS=new Map;Ce.PROP_SETTERS=new Map;class Tt{constructor(){Tt.setupStateMachine(this)}static setupStateMachine(e){const t=e.constructor,i=Tt.create(t);Object.setPrototypeOf(e,i.prototype),e.constructor=t,e._initStateMachine()}static create(e){if(!e.hasOwnProperty("_sm")){const t=new si(e);e._sm=t}return e._sm.router}fire(e,...t){if(this._hasMethod(e))return this[e](...t)}_getState(){return this._state.__path}_inState(e,t=this._state.__path){const i=this._sm.getStateByPath(e),s=this._sm.getStateByPath(t),r=i.__level;return Tt._getStateAtLevel(s,r)===i}_hasMember(e){return!!this.constructor.prototype[e]}_hasMethod(e){const t=this.constructor.prototype[e];return!!t&&typeof t=="function"}_setState(e,t){const i=++this._setStateCounter;if(this._setStateId=i,this._state.__path!==e){let s=this._sm._stateMap[e];s||(s=this._sm.getStateByPath(e));const r=this._state,o=s.prototype.$enter!==this._state.prototype.$enter,a=s.prototype.$exit!==this._state.prototype.$exit;if(o||a){const l=Tt._getSharedState(this._state,s),h={newState:s.__path,prevState:r.__path,sharedState:l.__path},c=l.__level;if(a){const u=Tt._getStatesUntilLevel(this._state,c);for(let d=0,f=u.length;d<f;d++)if(this.__setState(u[d]),this._callExit(this._state,t,h),this._setStateId!==i)return}if(o){const u=Tt._getStatesUntilLevel(s,c).reverse();for(let d=0,f=u.length;d<f;d++)if(this.__setState(u[d]),this._callEnter(this._state,t,h),this._setStateId!==i)return}}if(this.__setState(s),this._changedState){const l={newState:s.__path,prevState:r.__path};t?this._changedState(l,...t):this._changedState(l)}if(this._onStateChange){const l={newState:s.__path,prevState:r.__path};this._onStateChange(l)}}}_callEnter(e,t=[],i){const s=!!e.__parent;e.prototype.$enter&&(!s||e.__parent.prototype.$enter!==e.prototype.$enter)&&e.prototype.$enter.apply(this,[i,...t])}_callExit(e,t=[],i){const s=!!e.__parent;e.prototype.$exit&&(!s||e.__parent.prototype.$exit!==e.prototype.$exit)&&e.prototype.$exit.apply(this,[i,...t])}__setState(e){this._state=e,this._stateIndex=e.__index,this.constructor=e}_initStateMachine(){this._state=null,this._stateIndex=0,this._setStateCounter=0,this._sm=this._routedType._sm,this.__setState(this._sm.getStateByPath(""));const e={newState:"",prevState:void 0,sharedState:void 0};this._callEnter(this._state,[],e),this._onStateChange=void 0}_getMostSpecificHandledMember(e){let t=this._state;do{for(let i=0,s=e.length;i<s;i++){const r=e[i];if(t.__parent){const o=si.getStateMemberAlias(t.__path,r);if(this[o])return r}else if(t.prototype[r])return r}t=t.__parent}while(t)}static _getStatesUntilLevel(e,t){const i=[];for(;e.__level>t;)i.push(e),e=e.__parent;return i}static _getSharedState(e,t){const i=Tt._getAncestorStates(e),s=Tt._getAncestorStates(t),r=Math.min(i.length,s.length);for(let o=0;o<r;o++)if(i[o]!==s[o])return i[o-1];return i[r-1]}static _getAncestorStates(e){const t=[];do t.push(e);while(e=e.__parent);return t.reverse()}static _getStateAtLevel(e,t){if(!(t>e.__level)){for(;t<e.__level;)e=e.__parent;return e}}}class si{constructor(e){this._type=e,this._router=null,this.init()}get router(){return this._router}init(){this._router=this._createRouter(),this._stateMap=this._getStateMap(),this._addStateMemberDelegatorsToRouter()}_createRouter(){const e=this._type,t=class extends e{constructor(){if(super(...arguments),!this.constructor.hasOwnProperty("_isRouter"))throw new Error(`You need to extend ${e.name}.original instead of ${e.name}.`)}};return t._isRouter=!0,t.prototype._routedType=e,t.original=e,this._mixinStateMachineMethods(t),t}_mixinStateMachineMethods(e){const t=Object.getOwnPropertyNames(Tt.prototype);for(let i=0,s=t.length;i<s;i++){const r=t[i];if(r!=="constructor"){const o=Object.getOwnPropertyDescriptor(Tt.prototype,r);Object.defineProperty(e.prototype,r,o)}}}_addStateMemberDelegatorsToRouter(){this._getAllMemberNames().forEach(t=>{this._addMemberRouter(t)})}_addMemberRouter(e){const t=Object.keys(this._stateMap),i=[],s=[];t.forEach((o,a)=>{const l=this._stateMap[o],h=this._getDescriptor(l,e);if(h){i[a]=h;const c=si.getStateMemberAlias(h._source.__path,e);s[a]=c,this._router.prototype.hasOwnProperty(c)||Object.defineProperty(this._router.prototype,c,h)}else i[a]=null,s[a]=null});let r;switch(i.forEach(o=>{if(o){const a=this._getDescriptorType(o);if(r&&r!==a){console.warn(`[Lightning] Member ${e} in ${this._type.name} has inconsistent types.`);return}r=a}}),r){case"method":this._addMethodRouter(e,i,s);break;case"getter":this._addGetterSetterRouters(e);break;case"property":console.warn("[Lightning] Fixed properties are not supported; please use a getter instead!");break}}_getDescriptor(e,t,i=()=>!0){let s=e,r=e;do{const o=Object.getOwnPropertyDescriptor(s.prototype,t);if(o&&i(o))return o._source=r,o;s=Object.getPrototypeOf(s),s&&s.hasOwnProperty("__state")&&(r=s)}while(s&&s.prototype)}_getDescriptorType(e){return e.get||e.set?"getter":typeof e.value=="function"?"method":"property"}static _supportsSpread(){if(this.__supportsSpread===void 0){this.__supportsSpread=!1;try{new Function("return [].concat(...arguments);")(),this.__supportsSpread=!0}catch{}}return this.__supportsSpread}_addMethodRouter(e,t,i){const s=["//@ sourceURL=StateMachineRouter.js","var i = this._stateIndex;"];let r=i[0];const o=si._supportsSpread();for(let c=1,u=i.length;c<u;c++){const d=i[c];d!==r&&(r?o?s.push(`if (i < ${c}) return this["${r}"](...arguments); else`):s.push(`if (i < ${c}) return this["${r}"].apply(this, arguments); else`):s.push(`if (i < ${c}) return ; else`)),r=d}r?o?s.push(`return this["${r}"](...arguments);`):s.push(`return this["${r}"].apply(this, arguments);`):s.push(";");const a=s.join(`
`),h={value:new Function([],a)};Object.defineProperty(this._router.prototype,e,h)}_addGetterSetterRouters(e){const t=this._getGetterRouter(e),i=this._getSetterRouter(e),s={get:t,set:i};Object.defineProperty(this._router.prototype,e,s)}_getGetterRouter(e){const t=Object.keys(this._stateMap),i=[];t.forEach((l,h)=>{const c=this._stateMap[l],u=this._getDescriptor(c,e,d=>d.get);if(u){const d=si.getStateMemberAlias(u._source.__path,e);i[h]=d,this._router.prototype.hasOwnProperty(d)||Object.defineProperty(this._router.prototype,d,u)}else i[h]=null});const s=["//@ sourceURL=StateMachineRouter.js","var i = this._stateIndex;"];let r=i[0];for(let l=1,h=i.length;l<h;l++){const c=i[l];c!==r&&(r?s.push(`if (i < ${l}) return this["${r}"]; else`):s.push(`if (i < ${l}) return ; else`)),r=c}r?s.push(`return this["${r}"];`):s.push(";");const o=s.join(`
`);return new Function([],o)}_getSetterRouter(e){const t=Object.keys(this._stateMap),i=[];t.forEach((l,h)=>{const c=this._stateMap[l],u=this._getDescriptor(c,e,d=>d.set);if(u){const d=si.getStateMemberAlias(u._source.__path,e);i[h]=d,this._router.prototype.hasOwnProperty(d)||Object.defineProperty(this._router.prototype,d,u)}else i[h]=null});const s=["//@ sourceURL=StateMachineRouter.js","var i = this._stateIndex;"];let r=i[0];for(let l=1,h=i.length;l<h;l++){const c=i[l];c!==r&&(r?s.push(`if (i < ${l}) this["${r}"] = arg; else`):s.push(`if (i < ${l}) ; else`)),r=c}r?s.push(`this["${r}"] = arg;`):s.push(";");const o=s.join(`
`);return new Function(["arg"],o)}static getStateMemberAlias(e,t){return"$"+(e?e+".":"")+t}_getAllMemberNames(){const e=this._stateMap,t=Object.keys(e);let i=new Set;return t.forEach(s=>{if(s==="")return;const r=e[s];this._getStateMemberNames(r).forEach(a=>{i.add(a)})}),[...i]}_getStateMemberNames(e){let t=e,i=new Set;const s=this._type===e;do this._getStateMemberNamesForType(t).forEach(o=>{i.add(o)}),t=Object.getPrototypeOf(t);while(t&&t.prototype&&(!t.hasOwnProperty("__state")||s));return i}_getStateMemberNamesForType(e){return Object.getOwnPropertyNames(e.prototype).filter(i=>i!=="constructor"&&!si._isStateLocalMember(i))}static _isStateLocalMember(e){return e==="$enter"||e==="$exit"}getStateByPath(e){if(this._stateMap[e])return this._stateMap[e];const t=e.split(".");for(;t.pop();){const i=t.join(".");if(this._stateMap[i])return this._stateMap[i]}}_getStateMap(){return this._stateMap||(this._stateMap=this._createStateMap()),this._stateMap}_createStateMap(){const e={};return this._addState(this._type,null,"",e),e}_addState(e,t,i,s){e.__state=!0,e.__name=i,this._addStaticStateProperty(e,t);const r=t?t.__path:"";let o=(r?r+".":"")+i;e.__path=o,e.__level=t?t.__level+1:0,e.__parent=t,e.__index=Object.keys(s).length,s[o]=e;const a=e._states;a&&(t&&t._states===a||e._states().forEach(c=>{const u=si._getStateName(c);this._addState(c,e,u,s)}))}static _getStateName(e){const t=e.name,i=t.indexOf("$");return i>0?t.substr(0,i):t}_addStaticStateProperty(e,t){t&&(t&&!t.__parent?this._router[e.__name]=e:t[e.__name]=e)}}class ke extends Ce{constructor(e,t){super(e),this.tagRoot=!0,H.isObjectLiteral(t)&&Object.assign(this,t),this.__initialized=!1,this.__firstActive=!1,this.__firstEnable=!1,this.__signals=void 0,this.__passSignals=void 0,this.__construct();const i=this.constructor.getTemplateFunc(this);i.f(this,i.a),this._build()}__start(){Tt.setupStateMachine(this),this._onStateChange=ke.prototype.__onStateChange}get state(){return this._getState()}__onStateChange(){this.application&&this.application.updateFocusPath()}_refocus(){this.application&&this.application.updateFocusPath()}static bindProp(e,t=null){return{__propertyBinding:!0,__name:e,__func:t}}__bindProperty(e,t,i){const s=t,r=i,o=Array.isArray(e.__name)?e.__name:[e.__name];for(let a=0;a<o.length;a++){const l=o[a],h=e.__func?e.__func:c=>c[l];this.hasOwnProperty(l)?this[`__prop_bindings_${l}`].push({__obj:s,__prop:r,__func:h}):(this[`__prop_bindings_${l}`]=[{__obj:s,__prop:r,__func:h}],Object.defineProperty(this,l,{set:c=>{this[`__prop_${l}`]=c;for(const{__obj:u,__prop:d,__func:f}of this[`__prop_bindings_${l}`])u[d]=f(this)},get:()=>this[`__prop_${l}`]}))}}static getTemplateFunc(e){const t="_templateFunc",i="__has"+t;return this[i]!==this&&(this[i]=this,this[t]=this.parseTemplate(this._template(e))),this[t]}static parseTemplate(e){const t={loc:[],store:[],rid:0};this.parseTemplateRec(e,t,"element");const i=t.loc.join(`;
`);return{f:new Function("element","store",i),a:t.store}}static parseTemplateRec(e,t,i){const s=t.store,r=t.loc;Object.keys(e).forEach(a=>{let l=e[a];if(H.isUcChar(a.charCodeAt(0)))if(H.isObjectLiteral(l)){const h=`r${a.replace(/[^a-z0-9]/gi,"")+t.rid}`;let c=l.type?l.type:Ce;c===Ce?r.push(`var ${h} = element.stage.createElement()`):(s.push(c),r.push(`var ${h} = new store[${s.length-1}](${i}.stage)`)),r.push(`${h}.ref = "${a}"`),t.rid++,this.parseTemplateRec(l,t,h),r.push(`${i}.childList.add(${h})`)}else H.isObject(l)&&(s.push(l),r.push(`${i}.childList.add(store[${s.length-1}])`));else if(a==="text"){const h=i+"__text";r.push(`var ${h} = ${i}.enableTextTexture()`),l.__propertyBinding===!0?(s.push(l),r.push(`element.__bindProperty(store[${s.length-1}], ${i}, "${a}")`)):this.parseTemplatePropRec(l,t,h)}else if(a==="shader"&&H.isObjectLiteral(l)){const h=`${i}["shader"]`;s.push(l),r.push(`${i}["${a}"] = store[${s.length-1}]`),this.parsePropertyBindings(l,t,h)}else if(a==="texture"&&H.isObjectLiteral(l)){const h=i+"__texture",c=l.type;c?(s.push(c),r.push(`var ${h} = new store[${s.length-1}](${i}.stage)`),this.parseTemplatePropRec(l,t,h),r.push(`${i}["${a}"] = ${h}`)):(r.push(`${h} = ${i}.texture`),this.parseTemplatePropRec(l,t,h))}else H.isObjectLiteral(l)&&l.__propertyBinding===!0?(s.push(l),r.push(`element.__bindProperty(store[${s.length-1}], ${i}, "${a}")`)):H.isNumber(l)?r.push(`${i}["${a}"] = ${l}`):H.isBoolean(l)?r.push(`${i}["${a}"] = ${l?"true":"false"}`):H.isObject(l)||Array.isArray(l)?(s.push(l),r.push(`${i}["${a}"] = store[${s.length-1}]`)):r.push(`${i}["${a}"] = ${JSON.stringify(l)}`)})}static parseTemplatePropRec(e,t,i){const s=t.store,r=t.loc;Object.keys(e).forEach(a=>{if(a!=="type"){const l=e[a];H.isNumber(l)?r.push(`${i}["${a}"] = ${l}`):H.isBoolean(l)?r.push(`${i}["${a}"] = ${l?"true":"false"}`):H.isObject(l)&&l.__propertyBinding===!0?(s.push(l),r.push(`element.__bindProperty(store[${s.length-1}], ${i}, "${a}")`)):H.isObject(l)||Array.isArray(l)?(s.push(l),r.push(`${i}["${a}"] = store[${s.length-1}]`)):r.push(`${i}["${a}"] = ${JSON.stringify(l)}`)}})}static parsePropertyBindings(e,t,i){const s=t.store,r=t.loc;Object.keys(e).forEach(a=>{if(a!=="type"){const l=e[a];H.isObjectLiteral(l)&&l.__propertyBinding===!0&&(s.push(l),r.push(`element.__bindProperty(store[${s.length-1}], ${i}, "${a}")`))}})}_onSetup(){this.__initialized||this._setup()}_setup(){}_onAttach(){this.__initialized||(this.__init(),this.__initialized=!0),this._attach()}_attach(){}_onDetach(){this._detach()}_detach(){}_onEnabled(){this.__firstEnable||(this._firstEnable(),this.__firstEnable=!0),this._enable()}_firstEnable(){}_enable(){}_onDisabled(){this._disable()}_disable(){}_onActive(){this.__firstActive||(this._firstActive(),this.__firstActive=!0),this._active()}_firstActive(){}_active(){}_onInactive(){this._inactive()}_inactive(){}get application(){return this.stage.application}__construct(){this._construct()}_construct(){}_build(){}__init(){this._init()}_init(){}_focus(e,t){}_unfocus(e){}_focusChange(e,t){}_getFocused(){return this}_setFocusSettings(e){}_handleFocusSettings(e){}static _template(){return{}}hasFinalFocus(){let e=this.application._focusPath;return e&&e.length&&e[e.length-1]===this}hasFocus(){let e=this.application._focusPath;return e&&e.indexOf(this)>=0}get cparent(){return ke.getParent(this)}seekAncestorByType(e){let t=this.cparent;for(;t;){if(t.constructor===e)return t;t=t.cparent}}getSharedAncestorComponent(e){let t=this.getSharedAncestor(e);for(;t&&!t.isComponent;)t=t.parent;return t}get signals(){return this.__signals}set signals(e){H.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__signals=e}set alterSignals(e){H.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__signals||(this.__signals={});for(let t in e)e[t]===void 0?delete this.__signals[t]:this.__signals[t]=e}get passSignals(){return this.__passSignals||{}}set passSignals(e){this.__passSignals=Object.assign(this.__passSignals||{},e)}set alterPassSignals(e){H.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__passSignals||(this.__passSignals={});for(let t in e)e[t]===void 0?delete this.__passSignals[t]:this.__passSignals[t]=e}signal(e,...t){return this._signal(e,t)}_signal(e,t){const i=this._getParentSignalHandler();if(i){if(this.__signals){let r=this.__signals[e];if(r===!1)return;if(r){if(r===!0&&(r=e),H.isFunction(r))return r(...t);if(i._hasMethod(r))return i[r](...t)}}let s=this.__passSignals&&this.__passSignals[e];if(s)return s&&s!==!0&&(e=s),i._signal(e,t)}}_getParentSignalHandler(){return this.cparent?this.cparent._getSignalHandler():null}_getSignalHandler(){return this._signalProxy?this.cparent?this.cparent._getSignalHandler():null:this}get _signalProxy(){return!1}fireAncestors(e,...t){if(!e.startsWith("$"))throw new Error("Ancestor event name must be prefixed by dollar sign.");const i=this._getParentSignalHandler();if(i)return i._doFireAncestors(e,t)}_doFireAncestors(e,t){if(this._hasMethod(e))return this.fire(e,...t);{const i=this._getParentSignalHandler();if(i)return i._doFireAncestors(e,t)}}static collectSubComponents(e,t){if(t.hasChildren()){const i=t.__childList;for(let s=0,r=i.length;s<r;s++){const o=i.getAt(s);o.isComponent?e.push(o):ke.collectSubComponents(e,o)}}}static getComponent(e){let t=e;for(;t&&!t.isComponent;)t=t.parent;return t}static getParent(e){return ke.getComponent(e.parent)}}ke.prototype.isComponent=!0;class Vd{constructor(e){this.ctx=e,this.quadTextures=[],this.quadElements=[]}get length(){return this.quadTextures.length}reset(){this.quadTextures=[],this.quadElements=[],this.dataLength=0}getElement(e){return this.quadElements[e]._element}getElementCore(e){return this.quadElements[e]}getTexture(e){return this.quadTextures[e]}getTextureWidth(e){let t=this.quadTextures[e];return t.w?t.w:this.quadElements[e]._displayedTextureSource.w}getTextureHeight(e){let t=this.quadTextures[e];return t.h?t.h:this.quadElements[e]._displayedTextureSource.h}}class w_ extends Vd{constructor(e){super(e);const t=e.stage.getOption("bufferMemory");this.dataLength=0,this.data=new ArrayBuffer(t),this.floats=new Float32Array(this.data),this.uints=new Uint32Array(this.data)}getAttribsDataByteOffset(e){return e*80}getQuadContents(){let e=this.floats,t=this.uints,i=[];for(let s=1;s<=this.length;s++){let r="entry "+s+": ";for(let o=0;o<4;o++){let a=s*20+o*4;r+=e[a]+","+e[a+1]+":"+e[a+2]+","+e[a+3]+"["+t[a+4].toString(16)+"] "}i.push(r)}return i}}class Wd{constructor(e,t,i,s,r,o){this.ctx=e,this.shader=t,this.shaderOwner=i,this.renderTextureInfo=s,this.scissor=r,this.index=o,this.length=0}get quads(){return this.ctx.renderState.quads}getTexture(e){return this.quads.getTexture(this.index+e)}getElementCore(e){return this.quads.getElementCore(this.index+e)}getElement(e){return this.quads.getElement(this.index+e)}getElementWidth(e){return this.getElement(e).renderWidth}getElementHeight(e){return this.getElement(e).renderHeight}getTextureWidth(e){return this.quads.getTextureWidth(this.index+e)}getTextureHeight(e){return this.quads.getTextureHeight(this.index+e)}getRenderWidth(){return this.renderTextureInfo?this.renderTextureInfo.w:this.ctx.stage.w}getRenderHeight(){return this.renderTextureInfo?this.renderTextureInfo.h:this.ctx.stage.h}}class I_ extends Wd{constructor(e,t,i,s,r,o){super(e,t,i,s,r,o),this.extraAttribsDataByteOffset=0}getAttribsDataByteOffset(e){return this.quads.getAttribsDataByteOffset(this.index+e)}getNormalRenderTextureCoords(e,t){let i=this.shaderOwner.getRenderTextureCoords(e,t);return i[0]/=this.getRenderWidth(),i[1]/=this.getRenderHeight(),i[0]=i[0]*2-1,i[1]=1-i[1]*2,i}getProjection(){return this.renderTextureInfo===null?this.ctx.renderExec._projection:this.renderTextureInfo.nativeTexture.projection}}class Yd{constructor(e){this.ctx=e,this.renderState=e.renderState,this.gl=this.ctx.stage.gl}destroy(){this.ctx=null,this.renderState=null,this.gl=null,delete this.ctx,delete this.renderState,delete this.gl}_reset(){this._bindRenderTexture(null),this._setScissor(null),this._clearRenderTexture()}execute(){this._reset();let e=this.renderState.quadOperations,t=0,i=e.length;for(;t<i;)this._processQuadOperation(e[t]),t++}_processQuadOperation(e){e.renderTextureInfo&&e.renderTextureInfo.ignore||(this._setupQuadOperation(e),this._execQuadOperation(e))}_setupQuadOperation(e){}_execQuadOperation(e){let t=e.renderTextureInfo?e.renderTextureInfo.nativeTexture:null;this._renderTexture!==t&&this._bindRenderTexture(t),e.renderTextureInfo&&!e.renderTextureInfo.cleared?(this._setScissor(null),this._clearRenderTexture(),e.renderTextureInfo.cleared=!0,this._setScissor(e.scissor)):this._setScissor(e.scissor),this._renderQuadOperation(e)}_renderQuadOperation(e){}_bindRenderTexture(e){this._renderTexture=e}_clearRenderTexture(e){}_setScissor(e){}}class P_ extends Yd{constructor(e){super(e),this.gl=this.ctx.stage.gl,this.init()}init(){let e=this.gl;this._attribsBuffer=e.createBuffer();let t=Math.floor(this.renderState.quads.data.byteLength/80),i=new Uint16Array(t*6);for(let s=0,r=0;s<t;s+=6,r+=4)i[s]=r,i[s+1]=r+1,i[s+2]=r+2,i[s+3]=r,i[s+4]=r+2,i[s+5]=r+3;this._quadsBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW),this._projection=new Float32Array([2/this.ctx.stage.coordsWidth,-2/this.ctx.stage.coordsHeight])}destroy(){super.destroy(),this.gl.deleteBuffer(this._attribsBuffer),this.gl.deleteBuffer(this._quadsBuffer),this.gl=null,delete this.gl}_reset(){super._reset();let e=this.gl;e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),e.disable(e.DEPTH_TEST),this._stopShaderProgram(),this._setupBuffers()}_setupBuffers(){let e=this.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer);let t=new Float32Array(this.renderState.quads.data,0,this.renderState.quads.dataLength);e.bindBuffer(e.ARRAY_BUFFER,this._attribsBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.DYNAMIC_DRAW)}_setupQuadOperation(e){super._setupQuadOperation(e),this._useShaderProgram(e.shader,e)}_renderQuadOperation(e){let t=e.shader;(e.length||e.shader.addEmpty())&&(t.beforeDraw(e),t.draw(e),t.afterDraw(e))}_useShaderProgram(e,t){e.hasSameProgram(this._currentShaderProgram)||(this._currentShaderProgram&&this._currentShaderProgram.stopProgram(),e.useProgram(),this._currentShaderProgram=e),e.setupUniforms(t)}_stopShaderProgram(){this._currentShaderProgram&&(this._currentShaderProgram.stopProgram(),this._currentShaderProgram=null)}_bindRenderTexture(e){super._bindRenderTexture(e);let t=this.gl;this._renderTexture?(t.bindFramebuffer(t.FRAMEBUFFER,this._renderTexture.framebuffer),t.viewport(0,0,this._renderTexture.w,this._renderTexture.h)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.ctx.stage.w,this.ctx.stage.h))}_clearRenderTexture(){super._clearRenderTexture();let e=this.gl;if(this._renderTexture)e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT);else{let t=this.ctx.stage.getClearColor();t&&(e.clearColor(t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),e.clear(e.COLOR_BUFFER_BIT))}}_setScissor(e){if(super._setScissor(e),this._scissor===e)return;this._scissor=e;let t=this.gl;if(!e)t.disable(t.SCISSOR_TEST);else{t.enable(t.SCISSOR_TEST);let i=this.ctx.stage.getRenderPrecision(),s=e[1];this._renderTexture===null&&(s=this.ctx.stage.h/i-(e[1]+e[3])),t.scissor(Math.round(e[0]*i),Math.round(s*i),Math.round(e[2]*i),Math.round(e[3]*i))}}}class Kd{constructor(e){this.ctx=e,this.stage=e.stage,this.defaultShader=this.stage.renderer.getDefaultShader(e),this.renderer=e.stage.renderer,this.quads=this.renderer.createCoreQuadList(e)}reset(){this._renderTextureInfo=null,this._scissor=null,this._shader=null,this._shaderOwner=null,this._realShader=null,this._check=!1,this.quadOperations=[],this._texturizer=null,this._texturizerTemporary=!1,this._quadOperation=null,this.quads.reset(),this._temporaryTexturizers=[],this._isCachingTexturizer=!1}get length(){return this.quads.quadTextures.length}setShader(e,t){(this._shaderOwner!==t||this._realShader!==e)&&(this._realShader=e,e.useDefault()&&(e=this.defaultShader),(this._shader!==e||this._shaderOwner!==t)&&(this._shader=e,this._shaderOwner=t,this._check=!0))}get renderTextureInfo(){return this._renderTextureInfo}setScissor(e){this._scissor!==e&&(e?this._scissor=e:this._scissor=null,this._check=!0)}getScissor(){return this._scissor}setRenderTextureInfo(e){this._renderTextureInfo!==e&&(this._renderTextureInfo=e,this._scissor=null,this._check=!0)}setTexturizer(e,t=!1){this._texturizer=e,this._cacheTexturizer=t}set isCachingTexturizer(e){this._isCachingTexturizer=e}get isCachingTexturizer(){return this._isCachingTexturizer}addQuad(e){this._quadOperation?this._check&&this._hasChanges()&&(this._finishQuadOperation(),this._check=!1):this._createQuadOperation();let t=null;this._texturizer&&(t=this._texturizer.getResultTexture(),this._cacheTexturizer||this._temporaryTexturizers.push(this._texturizer)),t||(t=e._displayedTextureSource.nativeTexture),this._renderTextureInfo&&(this._shader===this.defaultShader&&this._renderTextureInfo.empty?(this._renderTextureInfo.nativeTexture=t,this._renderTextureInfo.offset=this.length):this._renderTextureInfo.nativeTexture=null,this._renderTextureInfo.empty=!1),this.quads.quadTextures.push(t),this.quads.quadElements.push(e),this._quadOperation.length++,this.renderer.addQuad(this,this.quads,this.length-1)}finishedRenderTexture(){this._renderTextureInfo.nativeTexture&&(this._isRenderTextureReusable()||(this._renderTextureInfo.nativeTexture=null))}_isRenderTextureReusable(){const e=this._renderTextureInfo.offset;return this.quads.quadTextures[e].w===this._renderTextureInfo.w&&this.quads.quadTextures[e].h===this._renderTextureInfo.h&&this.renderer.isRenderTextureReusable(this,this._renderTextureInfo)}_hasChanges(){let e=this._quadOperation;return this._shader!==e.shader||this._shaderOwner!==e.shaderOwner||this._renderTextureInfo!==e.renderTextureInfo||this._scissor!==e.scissor&&(this._scissor[0]!==e.scissor[0]||this._scissor[1]!==e.scissor[1]||this._scissor[2]!==e.scissor[2]||this._scissor[3]!==e.scissor[3])}_finishQuadOperation(e=!0){if(this._quadOperation){if((this._quadOperation.length||this._shader.addEmpty())&&(!this._quadOperation.scissor||this._quadOperation.scissor[2]>0&&this._quadOperation.scissor[3]>0)&&this.quadOperations.push(this._quadOperation),this._temporaryTexturizers.length){for(let t=0,i=this._temporaryTexturizers.length;t<i;t++)this._temporaryTexturizers[t].releaseRenderTexture();this._temporaryTexturizers=[]}this._quadOperation=null}e&&this._createQuadOperation()}_createQuadOperation(){this._quadOperation=this.renderer.createCoreQuadOperation(this.ctx,this._shader,this._shaderOwner,this._renderTextureInfo,this._scissor,this.length),this._check=!1}finish(){this._quadOperation&&this._finishQuadOperation(!1),this.renderer.finishRenderState(this)}}class D_{constructor(e,t){this.vertexShaderSource=e,this.fragmentShaderSource=t,this._program=null,this.gl=null,this._uniformLocations=new Map,this._attributeLocations=new Map,this._currentUniformValues={}}compile(e){if(this._program)return;this.gl=e,this._program=e.createProgram();let t=this._glCompile(e.VERTEX_SHADER,this.vertexShaderSource),i=this._glCompile(e.FRAGMENT_SHADER,this.fragmentShaderSource);e.attachShader(this._program,t),e.attachShader(this._program,i),e.linkProgram(this._program),e.getProgramParameter(this._program,e.LINK_STATUS)||(console.error("[Lightning] Error: Could not initialize shader."),console.error("[Lightning] gl.VALIDATE_STATUS",e.getProgramParameter(this._program,e.VALIDATE_STATUS)),console.error("[Lightning] gl.getError()",e.getError()),e.getProgramInfoLog(this._program)!==""&&console.warn("[Lightning] Warning: gl.getProgramInfoLog()",e.getProgramInfoLog(this._program)),e.deleteProgram(this._program),this._program=null),e.deleteShader(t),e.deleteShader(i)}_glCompile(e,t){let i=this.gl.createShader(e);if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){console.error("[Lightning]",this.constructor.name,"Type: "+(e===this.gl.VERTEX_SHADER?"vertex shader":"fragment shader")),console.error("[Lightning]",this.gl.getShaderInfoLog(i));let s=0;return console.error("[Lightning]",`========== source ==========
`+t.split(`
`).map(r=>""+ ++s+": "+r).join(`
`)),null}return i}getUniformLocation(e){let t=this._uniformLocations.get(e);return t===void 0&&(t=this.gl.getUniformLocation(this._program,e),this._uniformLocations.set(e,t)),t}getAttribLocation(e){let t=this._attributeLocations.get(e);return t===void 0&&(t=this.gl.getAttribLocation(this._program,e),this._attributeLocations.set(e,t)),t}destroy(){this._program&&this.gl.deleteProgram(this._program),this._attributeLocations=null,this._currentUniformValues=null,this.fragmentShaderSource=null,this._program=null,this.gl=null,this._uniformLocations=null,this.vertexShaderSource=null,delete this.vertexShaderSource,delete this._program,delete this._currentUniformValues,delete this.fragmentShaderSource,delete this.gl,delete this._uniformLocations,delete this._attributeLocations}get glProgram(){return this._program}get compiled(){return!!this._program}_valueEquals(e,t){if(e.length&&t.length){for(let i=0,s=e.length;i<s;i++)if(e[i]!==t[i])return!1;return!0}else return e===t}_valueClone(e){return e.length?e.slice(0):e}setUniformValue(e,t,i){let s=this._currentUniformValues[e];if(s===void 0||!this._valueEquals(s,t)){let r=this._valueClone(t);this._currentUniformValues[e]=r;let o=this.getUniformLocation(e);o&&(i===this.gl.uniformMatrix2fv||i===this.gl.uniformMatrix3fv||i===this.gl.uniformMatrix4fv?i.call(this.gl,o,!1,r):i.call(this.gl,o,r))}}}class Xo extends Gr{constructor(e){super(e);const t=e.stage;this._program=t.renderer.shaderPrograms.get(this.constructor),this._program||(this._program=new D_(this.constructor.vertexShaderSource,this.constructor.fragmentShaderSource),t.renderer.shaderPrograms.set(this.constructor,this._program)),this.gl=t.gl}get glProgram(){return this._program.glProgram}_init(){this._initialized||(this.initialize(),this._initialized=!0)}initialize(){this._program.compile(this.gl)}get initialized(){return this._initialized}_uniform(e){return this._program.getUniformLocation(e)}_attrib(e){return this._program.getAttribLocation(e)}_setUniform(e,t,i){this._program.setUniformValue(e,t,i)}useProgram(){this._init(),this.gl.useProgram(this.glProgram),this.beforeUsage(),this.enableAttribs()}stopProgram(){this.afterUsage(),this.disableAttribs()}hasSameProgram(e){return e&&(e===this||e._program===this._program)}beforeUsage(){}afterUsage(){}enableAttribs(){}disableAttribs(){}getExtraAttribBytesPerVertex(){return 0}getVertexAttribPointerOffset(e){return e.extraAttribsDataByteOffset-e.index*4*this.getExtraAttribBytesPerVertex()}setExtraAttribsInBuffer(e){}setupUniforms(e){}_getProjection(e){return e.getProjection()}getFlipY(e){return this._getProjection(e)[1]<0}beforeDraw(e){}draw(e){}afterDraw(e){}cleanup(){this._initialized=!1}}let be=class extends Xo{enableAttribs(){let e=this.gl;e.vertexAttribPointer(this._attrib("aVertexPosition"),2,e.FLOAT,!1,20,0),e.enableVertexAttribArray(this._attrib("aVertexPosition")),this._attrib("aTextureCoord")!==-1&&(e.vertexAttribPointer(this._attrib("aTextureCoord"),2,e.FLOAT,!1,20,2*4),e.enableVertexAttribArray(this._attrib("aTextureCoord"))),this._attrib("aColor")!==-1&&(e.vertexAttribPointer(this._attrib("aColor"),4,e.UNSIGNED_BYTE,!0,20,4*4),e.enableVertexAttribArray(this._attrib("aColor")))}disableAttribs(){let e=this.gl;e.disableVertexAttribArray(this._attrib("aVertexPosition")),this._attrib("aTextureCoord")!==-1&&e.disableVertexAttribArray(this._attrib("aTextureCoord")),this._attrib("aColor")!==-1&&e.disableVertexAttribArray(this._attrib("aColor"))}setupUniforms(e){this._setUniform("projection",this._getProjection(e),this.gl.uniform2fv,!1)}draw(e){let t=this.gl,i=e.length;if(i){let s=e.getTexture(0),r=0;for(let o=0;o<i;o++){let a=e.getTexture(o);s!==a&&(t.bindTexture(t.TEXTURE_2D,s),t.drawElements(t.TRIANGLES,6*(o-r),t.UNSIGNED_SHORT,(r+e.index)*6*2),s=a,r=o)}t.bindTexture(t.TEXTURE_2D,s),t.drawElements(t.TRIANGLES,6*(i-r),t.UNSIGNED_SHORT,(r+e.index)*6*2)}}};be.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;be.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    void main(void){
        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;
    }
`;class Xd{constructor(e){this.stage=e,this._defaultShader=void 0}gc(e){}destroy(){}getDefaultShader(e=this.stage.ctx){return this._defaultShader||(this._defaultShader=this._createDefaultShader(e)),this._defaultShader}_createDefaultShader(e){}isValidShaderType(e){return e.prototype instanceof this._getShaderBaseType()}createShader(e,t){const i=t.type;if(this.isValidShaderType(i)){const s=new i(e);return Xe.patchObject(this,t),s}else{const s=this._getShaderAlternative(i);return s?new s(e):(console.warn("[Lightning] Shader has no implementation for render target: "+i.name),this._createDefaultShader(e))}}_getShaderBaseType(){}_getShaderAlternative(e){return this.getDefaultShader()}copyRenderTexture(e,t,i){console.warn("[Lightning] copyRenderTexture not supported by renderer")}}class jd extends Xd{constructor(e){super(e),this.shaderPrograms=new Map,this._compressedTextureExtensions={astc:e.gl.getExtension("WEBGL_compressed_texture_astc"),etc1:e.gl.getExtension("WEBGL_compressed_texture_etc1"),s3tc:e.gl.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:e.gl.getExtension("WEBGL_compressed_texture_pvrtc")}}getCompressedTextureExtensions(){return this._compressedTextureExtensions}destroy(){this.shaderPrograms.forEach(e=>e.destroy()),this.shaderPrograms=null,this._compressedTextureExtensions=null,delete this.shaderPrograms,delete this._compressedTextureExtensions}_createDefaultShader(e){return new be(e)}_getShaderBaseType(){return Xo}_getShaderAlternative(e){return e.getWebGL&&e.getWebGL()}createCoreQuadList(e){return new w_(e)}createCoreQuadOperation(e,t,i,s,r,o){return new I_(e,t,i,s,r,o)}createCoreRenderExecutor(e){return new P_(e)}createCoreRenderState(e){return new Kd(e)}createRenderTexture(e,t,i,s){const r=this.stage.gl,o=r.createTexture();return r.bindTexture(r.TEXTURE_2D,o),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,i,s,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),o.params={},o.params[r.TEXTURE_MAG_FILTER]=r.LINEAR,o.params[r.TEXTURE_MIN_FILTER]=r.LINEAR,o.params[r.TEXTURE_WRAP_S]=r.CLAMP_TO_EDGE,o.params[r.TEXTURE_WRAP_T]=r.CLAMP_TO_EDGE,o.options={format:r.RGBA,internalFormat:r.RGBA,type:r.UNSIGNED_BYTE},o.framebuffer=r.createFramebuffer(),o.projection=new Float32Array([2/e,2/t]),r.bindFramebuffer(r.FRAMEBUFFER,o.framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,o,0),o}freeRenderTexture(e){let t=this.stage.gl;t.deleteFramebuffer(e.framebuffer),t.deleteTexture(e)}_getBytesPerPixel(e,t){const i=this.stage.gl;if(e===i.RGBA)switch(t){case i.UNSIGNED_BYTE:return 4;case i.UNSIGNED_SHORT_4_4_4_4:return 2;case i.UNSIGNED_SHORT_5_5_5_1:return 2;default:throw new Error("Invalid type specified for GL_RGBA format")}else if(e===i.RGB)switch(t){case i.UNSIGNED_BYTE:return 3;case i.UNSIGNED_BYTE_5_6_5:return 2;default:throw new Error("Invalid type specified for GL_RGB format")}else throw new Error("Invalid format specified in call to _getBytesPerPixel()")}uploadTextureSource(e,t){const i=this.stage.gl,s=t.source;let r=!1;t.renderInfo&&(r=t.renderInfo.compressed||!1);const o={premultiplyAlpha:!0,hasAlpha:!0};t&&t.hasOwnProperty("premultiplyAlpha")&&(o.premultiplyAlpha=t.premultiplyAlpha),t&&t.hasOwnProperty("flipBlueRed")&&(o.flipBlueRed=t.flipBlueRed),t&&t.hasOwnProperty("hasAlpha")&&(o.hasAlpha=t.hasAlpha),o.hasAlpha||(o.premultiplyAlpha=!1),o.texParams=t.texParams||{},o.texOptions=t.texOptions||{};let a=i.createTexture();i.bindTexture(i.TEXTURE_2D,a),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),H.isNode&&i.pixelStorei(i.UNPACK_FLIP_BLUE_RED,!!o.flipBlueRed);const l=o.texParams;if(l[i.TEXTURE_MAG_FILTER]||(l[i.TEXTURE_MAG_FILTER]=i.LINEAR),l[i.TEXTURE_MIN_FILTER]||(l[i.TEXTURE_MIN_FILTER]=i.LINEAR),l[i.TEXTURE_WRAP_S]||(l[i.TEXTURE_WRAP_S]=i.CLAMP_TO_EDGE),l[i.TEXTURE_WRAP_T]||(l[i.TEXTURE_WRAP_T]=i.CLAMP_TO_EDGE),Object.keys(l).forEach(c=>{const u=l[c];i.texParameteri(i.TEXTURE_2D,parseInt(c),u)}),r)return this.stage.platform.uploadCompressedGlTexture(i,e,s),a;const h=o.texOptions;return h.format=h.format||(o.hasAlpha?i.RGBA:i.RGB),h.type=h.type||i.UNSIGNED_BYTE,h.internalFormat=h.internalFormat||h.format,t&&t.imageRef&&(h.imageRef=t.imageRef),this.stage.platform.uploadGlTexture(i,e,s,h),a.params=H.cloneObjShallow(l),a.options=H.cloneObjShallow(h),a.bytesPerPixel=this._getBytesPerPixel(h.format,h.type),a}freeTextureSource(e){this.stage.gl.deleteTexture(e.nativeTexture)}addQuad(e,t,i){let s=i*20;const r=t.quadElements[i];let o=r._renderContext,a=e.quads.floats,l=e.quads.uints;const h=ie.mergeColorAlpha;if(o.tb!==0||o.tc!==0)a[s++]=o.px,a[s++]=o.py,a[s++]=r._ulx,a[s++]=r._uly,l[s++]=h(r._colorUl,o.alpha),a[s++]=o.px+r._w*o.ta,a[s++]=o.py+r._w*o.tc,a[s++]=r._brx,a[s++]=r._uly,l[s++]=h(r._colorUr,o.alpha),a[s++]=o.px+r._w*o.ta+r._h*o.tb,a[s++]=o.py+r._w*o.tc+r._h*o.td,a[s++]=r._brx,a[s++]=r._bry,l[s++]=h(r._colorBr,o.alpha),a[s++]=o.px+r._h*o.tb,a[s++]=o.py+r._h*o.td,a[s++]=r._ulx,a[s++]=r._bry,l[s]=h(r._colorBl,o.alpha);else{let c=o.px+r._w*o.ta,u=o.py+r._h*o.td;a[s++]=o.px,a[s++]=o.py,a[s++]=r._ulx,a[s++]=r._uly,l[s++]=h(r._colorUl,o.alpha),a[s++]=c,a[s++]=o.py,a[s++]=r._brx,a[s++]=r._uly,l[s++]=h(r._colorUr,o.alpha),a[s++]=c,a[s++]=u,a[s++]=r._brx,a[s++]=r._bry,l[s++]=h(r._colorBr,o.alpha),a[s++]=o.px,a[s++]=u,a[s++]=r._ulx,a[s++]=r._bry,l[s]=h(r._colorBl,o.alpha)}}isRenderTextureReusable(e,t){let i=e._renderTextureInfo.offset*80/4,s=e.quads.floats,r=e.quads.uints;return s[i]===0&&s[i+1]===0&&s[i+2]===0&&s[i+3]===0&&r[i+4]===4294967295&&s[i+5]===t.w&&s[i+6]===0&&s[i+7]===1&&s[i+8]===0&&r[i+9]===4294967295&&s[i+10]===t.w&&s[i+11]===t.h&&s[i+12]===1&&s[i+13]===1&&r[i+14]===4294967295&&s[i+15]===0&&s[i+16]===t.h&&s[i+17]===0&&s[i+18]===1&&r[i+19]===4294967295}finishRenderState(e){let t=e.length*80;for(let i=0,s=e.quadOperations.length;i<s;i++){e.quadOperations[i].extraAttribsDataByteOffset=t;let r=e.quadOperations[i].shader.getExtraAttribBytesPerVertex()*4*e.quadOperations[i].length;t+=r,r&&e.quadOperations[i].shader.setExtraAttribsInBuffer(e.quadOperations[i],e.quads)}e.quads.dataLength=t}copyRenderTexture(e,t,i){const s=this.stage.gl;s.bindTexture(s.TEXTURE_2D,t),s.bindFramebuffer(s.FRAMEBUFFER,e.framebuffer);const r=e.precision;s.copyTexSubImage2D(s.TEXTURE_2D,0,r*(i.sx||0),r*(i.sy||0),r*(i.x||0),r*(i.y||0),r*(i.w||e.ow),r*(i.h||e.oh))}}class M_ extends Vd{constructor(e){super(e),this.renderContexts=[],this.modes=[]}setRenderContext(e,t){this.renderContexts[e]=t}setSimpleTc(e,t){t?this.modes[e]|=1:this.modes[e]-=this.modes[e]&1}setWhite(e,t){t?this.modes[e]|=2:this.modes[e]-=this.modes[e]&2}getRenderContext(e){return this.renderContexts[e]}getSimpleTc(e){return this.modes[e]&1}getWhite(e){return this.modes[e]&2}}class F_ extends Wd{getRenderContext(e){return this.quads.getRenderContext(this.index+e)}getSimpleTc(e){return this.quads.getSimpleTc(this.index+e)}getWhite(e){return this.quads.getWhite(this.index+e)}}class eh extends Yd{init(){this._mainRenderTexture=this.ctx.stage.getCanvas()}_renderQuadOperation(e){let t=e.shader;if(e.length||e.shader.addEmpty()){const i=this._renderTexture||this._mainRenderTexture;t.beforeDraw(e,i),t.draw(e,i),t.afterDraw(e,i)}}_clearRenderTexture(){const e=this._getContext();let t=[0,0,0,0];this._mainRenderTexture.ctx===e&&(t=this.ctx.stage.getClearColor());const i=e.canvas;e.setTransform(1,0,0,1,0,0),!t[0]&&!t[1]&&!t[2]&&!t[3]?e.clearRect(0,0,i.width,i.height):(e.fillStyle=ie.getRgbaStringFromArray(t),e.globalCompositeOperation="copy",e.beginPath(),e.rect(0,0,i.width,i.height),e.closePath(),e.fill(),e.globalCompositeOperation="source-over")}_getContext(){return this._renderTexture?this._renderTexture.ctx:this._mainRenderTexture.ctx}_restoreContext(){const e=this._getContext();e.restore(),e.save(),e._scissor=null}_setScissor(e){const t=this._getContext();if(!eh._equalScissorAreas(t.canvas,t._scissor,e)){this._restoreContext();let i=this.ctx.stage.getRenderPrecision();e&&(t.beginPath(),t.rect(Math.round(e[0]*i),Math.round(e[1]*i),Math.round(e[2]*i),Math.round(e[3]*i)),t.closePath(),t.clip()),t._scissor=e}}static _equalScissorAreas(e,t,i){return t||(t=[0,0,e.width,e.height]),i||(i=[0,0,e.width,e.height]),H.equalValues(t,i)}}class th extends Gr{beforeDraw(e){}draw(e){}afterDraw(e){}}class jo extends th{constructor(e){super(e),this._rectangleTexture=e.stage.rectangleTexture.source.nativeTexture,this._tintManager=this.ctx.stage.renderer.tintManager}draw(e,t){const i=t.ctx;let s=e.length;for(let r=0;r<s;r++){const o=e.getTexture(r);if(!o)continue;const a=e.getElementCore(r),l=e.getRenderContext(r),h=e.getWhite(r),c=e.getSimpleTc(r),u=this.ctx.stage.getRenderPrecision();i.setTransform(l.ta*u,l.tc*u,l.tb*u,l.td*u,l.px*u,l.py*u);const d=o===this._rectangleTexture,f={operation:e,target:t,index:r,rect:d};if(d)h?i.fillStyle="white":this._setColorGradient(i,a),i.globalAlpha=l.alpha,this._beforeDrawEl(f),i.fillRect(0,0,a.w,a.h),this._afterDrawEl(f),i.globalAlpha=1;else{i.globalAlpha=l.alpha,this._beforeDrawEl(f);const g=c?0:a._ulx*o.w,p=c?0:a._uly*o.h,m=(c?1:a._brx-a._ulx)*o.w,_=(c?1:a._bry-a._uly)*o.h;if(!h){let S=a._colorUl;(a._colorUl!==a._colorUr||a._colorUr!==a._colorBl||a._colorBr!==a._colorBl)&&(S=ie.mergeMultiColorsEqual([a._colorUl,a._colorUr,a._colorBl,a._colorBr]));const v=(S/16777216|0)/255;i.globalAlpha*=v;const E=S&16777215,C=this._tintManager.getTintTexture(o,E);i.fillStyle="white",i.drawImage(C,g,p,m,_,0,0,a.w,a.h)}else i.fillStyle="white",i.drawImage(o,g,p,m,_,0,0,a.w,a.h);this._afterDrawEl(f),i.globalAlpha=1}}}_setColorGradient(e,t,i=t.w,s=t.h,r=!0){let o=t._colorUl,a;t._colorUl===t._colorUr?t._colorBl===t._colorBr&&(t._colorUl===t._colorBl||(a=e.createLinearGradient(0,0,0,s),r?(a.addColorStop(0,ie.getRgbaString(t._colorUl)),a.addColorStop(1,ie.getRgbaString(t._colorBl))):(a.addColorStop(0,ie.getRgbString(t._colorUl)),a.addColorStop(1,ie.getRgbString(t._colorBl))))):t._colorUl===t._colorBl&&t._colorUr===t._colorBr&&(a=e.createLinearGradient(0,0,i,0),r?(a.addColorStop(0,ie.getRgbaString(t._colorUl)),a.addColorStop(1,ie.getRgbaString(t._colorBr))):(a.addColorStop(0,ie.getRgbString(t._colorUl)),a.addColorStop(1,ie.getRgbString(t._colorBr)))),a?e.fillStyle=a:e.fillStyle=r?ie.getRgbaString(o):ie.getRgbString(o)}_beforeDrawEl(e){}_afterDrawEl(e){}}class k_{constructor(e){this.stage=e,this._usedMemory=0,this._cachedNativeTextures=new Set}destroy(){this.gc(!0),this.stage=null,delete this.stage}_addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}delete(e){if(this._hasCache(e)){const t=this._getCache(e),i=t.memoryUsage;t.clear(),this._cachedNativeTextures.delete(e),this._addMemoryUsage(t.memoryUsage-i)}}getTintTexture(e,t){const i=this.stage.frameCounter;this._cachedNativeTextures.add(e);const s=this._getCache(e),r=s.get(t);if(r.lf=i,r.tx)return e.update>r.u&&this._tintTexture(r.tx,e,t),r.tx;{const o=s.memoryUsage;let a=s.reuseTexture(i);a?a.ctx.clearRect(0,0,a.width,a.height):(a=document.createElement("canvas"),a.width=e.w,a.height=e.h,a.ctx=a.getContext("2d")),this._tintTexture(a,e,t),s.set(t,a,i);const l=s.memoryUsage;return l!==o&&this._addMemoryUsage(l-o),a}}_tintTexture(e,t,i){let s=i.toString(16);for(;s.length<6;)s="0"+s;e.ctx.fillStyle="#"+s,e.ctx.globalCompositeOperation="copy",e.ctx.fillRect(0,0,t.w,t.h),e.ctx.globalCompositeOperation="multiply",e.ctx.drawImage(t,0,0,t.w,t.h,0,0,e.width,e.height),e.ctx.globalCompositeOperation="destination-in",e.ctx.drawImage(t,0,0,t.w,t.h,0,0,e.width,e.height)}_hasCache(e){return!!e._tintCache}_getCache(e){return e._tintCache||(e._tintCache=new O_(e)),e._tintCache}gc(e=!1){const t=this.stage.frameCounter;let i=0;this._cachedNativeTextures.forEach(s=>{const r=this._getCache(s);if(e)i+=r.memoryUsage,r.clear();else{const o=r.memoryUsage;r.cleanup(t),r.releaseBlancoTextures(),i+=r.memoryUsage-o}}),e&&this._cachedNativeTextures.clear(),i&&this._addMemoryUsage(i)}}class O_{constructor(e){this._tx=e,this._colors=new Map,this._blancoTextures=null,this._lastCleanupFrame=0,this._memTextures=0}get memoryUsage(){return this._memTextures*this._tx.w*this._tx.h}releaseBlancoTextures(){this._memTextures-=this._blancoTextures.length,this._blancoTextures=[]}clear(){this._blancoTextures=null,this._colors.clear(),this._memTextures=0}get(e){let t=this._colors.get(e);return t||(t={lf:-1,tx:void 0,u:-1},this._colors.set(e,t)),t}set(e,t,i){const s=this.get(e);s.lf=i,s.tx=t,s.u=i,this._memTextures++}cleanup(e){this._lastCleanupFrame!==e&&(this._blancoTextures=[],this._colors.forEach((t,i)=>{t.lf<e-1&&(t.tx&&this._blancoTextures.push(t.tx),this._colors.delete(i))}),this._lastCleanupFrame=e)}reuseTexture(e){if(this.cleanup(e),this._blancoTextures&&this._blancoTextures.length)return this._memTextures--,this._blancoTextures.pop()}}class B_ extends Xd{constructor(e){super(e),this.tintManager=new k_(e),this.setupC2d(this.stage.c2d.canvas)}destroy(){this.tintManager.destroy(),this.tintManager=null,delete this.tintManager}_createDefaultShader(e){return new jo(e)}_getShaderBaseType(){return th}_getShaderAlternative(e){return e.getC2d&&e.getC2d()}createCoreQuadList(e){return new M_(e)}createCoreQuadOperation(e,t,i,s,r,o){return new F_(e,t,i,s,r,o)}createCoreRenderExecutor(e){return new eh(e)}createCoreRenderState(e){return new Kd(e)}createRenderTexture(e,t,i,s){const r=document.createElement("canvas");return r.width=i,r.height=s,this.setupC2d(r),r}freeRenderTexture(e){this.tintManager.delete(e)}gc(e){this.tintManager.gc(e)}uploadTextureSource(e,t){if(t.source.buffer){const i=document.createElement("canvas");i.width=t.w,i.height=t.h;const s=new ImageData(new Uint8ClampedArray(t.source.buffer),t.w,t.h);return i.getContext("2d").putImageData(s,0,0),i}return t.source}freeTextureSource(e){this.tintManager.delete(e.nativeTexture)}addQuad(e,t,i){const s=t.quadElements[i];t.setRenderContext(i,s._renderContext),t.setWhite(i,s.isWhite()),t.setSimpleTc(i,s.hasSimpleTexCoords())}isRenderTextureReusable(e,t){return!1}finishRenderState(e){}setupC2d(e){const t=e.getContext("2d");e.ctx=t,t._scissor=null,e.ctx.save()}}class ih extends Xo{enableAttribs(){let e=this.gl;e.vertexAttribPointer(this._attrib("aVertexPosition"),2,e.FLOAT,!1,20,0),e.enableVertexAttribArray(this._attrib("aVertexPosition")),this._attrib("aTextureCoord")!==-1&&(e.vertexAttribPointer(this._attrib("aTextureCoord"),2,e.FLOAT,!1,20,2*4),e.enableVertexAttribArray(this._attrib("aTextureCoord"))),this._attrib("aColor")!==-1&&(e.vertexAttribPointer(this._attrib("aColor"),4,e.UNSIGNED_BYTE,!0,20,4*4),e.enableVertexAttribArray(this._attrib("aColor")))}disableAttribs(){let e=this.gl;e.disableVertexAttribArray(this._attrib("aVertexPosition")),this._attrib("aTextureCoord")!==-1&&e.disableVertexAttribArray(this._attrib("aTextureCoord")),this._attrib("aColor")!==-1&&e.disableVertexAttribArray(this._attrib("aColor"))}setupUniforms(e){this._setUniform("projection",this._getProjection(e),this.gl.uniform2fv,!1)}draw(e){let t=this.gl,i=e.length;if(i){let s=e.getTexture(0),r=0;for(let o=0;o<i;o++){let a=e.getTexture(o);if(s!==a){if(s.options&&s.options.imageRef){let l=o>0?o-1:o;const h=this.ctx.stage.getOption("precision");let c=e.getElementCore(l);this.ctx.stage.platform.paint(t,s.options.imageRef,c._worldContext.px*h,c._worldContext.py*h,c._colorUl,c)}else t.bindTexture(t.TEXTURE_2D,s),t.drawElements(t.TRIANGLES,6*(o-r),t.UNSIGNED_SHORT,(r+e.index)*6*2);s=a,r=o}}if(r<i)if(s.options&&s.options.imageRef){const o=this.ctx.stage.getOption("precision");let a=e.getElementCore(r);this.ctx.stage.platform.paint(t,s.options.imageRef,a._worldContext.px*o,a._worldContext.py*o,a._colorUl,a)}else t.bindTexture(t.TEXTURE_2D,s),t.drawElements(t.TRIANGLES,6*(i-r),t.UNSIGNED_SHORT,(r+e.index)*6*2)}}}ih.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;ih.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    void main(void){
        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;
    }
`;class U_ extends jd{constructor(e){super(e)}_createDefaultShader(e){return new ih(e)}createCoreRenderExecutor(e){global.beginDrawing();let t=super.createCoreRenderExecutor(e);return global.endDrawing(),t}}class N_{constructor(e={}){this._items=new Map,this._id=0,this._initWorker()}destroy(){this._worker&&this._worker.terminate(),this._items=null,this._worker=null,delete this._items,delete this._worker}_initWorker(){const e=`(${z_.toString()})()`,t=new Blob([e.replace('"use strict";',"")]),i=(window.URL?URL:webkitURL).createObjectURL(t,{type:"application/javascript; charset=utf-8"});this._worker=new Worker(i),this._worker.postMessage({type:"config",config:{path:window.location.href,protocol:window.location.protocol}}),this._worker.onmessage=s=>{if(s.data&&s.data.id){const r=s.data.id,o=this._items.get(r);o&&(s.data.type=="data"?this.finish(o,s.data.info):this.error(o,s.data.info))}}}create(e){const t=++this._id,i=new $_(this,t,e);return this._items.set(t,i),this._worker.postMessage({type:"add",id:t,src:e}),i}cancel(e){this._worker.postMessage({type:"cancel",id:e.id}),this._items.delete(e.id)}error(e,t){e.error(t),this._items.delete(e.id)}finish(e,t){e.load(t),this._items.delete(e.id)}}class $_{constructor(e,t,i){this._manager=e,this._id=t,this._src=i,this._onError=null,this._onLoad=null}get id(){return this._id}get src(){return this._src}set onError(e){this._onError=e}set onLoad(e){this._onLoad=e}cancel(){this._manager.cancel(this)}load(e){this._onLoad&&this._onLoad(e)}error(e){this._onError&&this._onError(e)}}const z_=function(){function n(){this.items=new Map;var t=this;onmessage=function(i){t._receiveMessage(i)}}n.isPathAbsolute=function(t){return/^(?:\/|[a-z]+:\/\/)/.test(t)||t.substr(0,5)=="data:"},n.prototype._receiveMessage=function(t){if(t.data.type==="config"){this.config=t.data.config;var i=this.config.path,s=/#.*?\//;s.test(i)&&(i=i.replace(/#.*$/,""));var r=i.split("/");r.pop(),this._relativeBase=r.join("/")+"/"}else t.data.type==="add"?this.add(t.data.id,t.data.src):t.data.type==="cancel"&&this.cancel(t.data.id)},n.prototype.add=function(t,i){n.isPathAbsolute(i)||(i=this._relativeBase+i),i.substr(0,2)==="//"&&(i=this.config.protocol+i);var s=new e(t,i),r=this;s.onFinish=function(o){r.finish(s,o)},s.onError=function(o){r.error(s,o)},this.items.set(t,s),s.start()},n.prototype.cancel=function(t){var i=this.items.get(t);i&&(i.cancel(),this.items.delete(t))},n.prototype.finish=function(t,{imageBitmap:i,hasAlphaChannel:s}){postMessage({type:"data",id:t.id,info:{imageBitmap:i,hasAlphaChannel:s}},[i]),this.items.delete(t.id)},n.prototype.error=function(t,{type:i,message:s}){postMessage({type:"error",id:t.id,info:{type:i,message:s}}),this.items.delete(t.id)},n.isWPEBrowser=function(){return navigator.userAgent.indexOf("WPE")!==-1};function e(t,i){this._onError=void 0,this._onFinish=void 0,this._id=t,this._src=i,this._xhr=void 0,this._mimeType=void 0,this._canceled=!1}Object.defineProperty(e.prototype,"id",{get:function(){return this._id}}),Object.defineProperty(e.prototype,"onFinish",{get:function(){return this._onFinish},set:function(t){this._onFinish=t}}),Object.defineProperty(e.prototype,"onError",{get:function(){return this._onError},set:function(t){this._onError=t}}),e.prototype.start=function(){this._xhr=new XMLHttpRequest,this._xhr.open("GET",this._src,!0),this._xhr.responseType="blob";var t=this;this._xhr.onerror=function(i){t.error({type:"connection",message:"Connection error"})},this._xhr.onload=function(i){var s=t._xhr.response;t._mimeType=s.type,t._createImageBitmap(s)},this._xhr.send()},e.prototype._createImageBitmap=function(t){var i=this;createImageBitmap(t,{premultiplyAlpha:"premultiply",colorSpaceConversion:"none",imageOrientation:"none"}).then(function(s){i.finish({imageBitmap:s,hasAlphaChannel:i._hasAlphaChannel()})}).catch(function(s){i.error({type:"parse",message:"Error parsing image data"})})},e.prototype._hasAlphaChannel=function(){return n.isWPEBrowser()?!0:this._mimeType.indexOf("image/png")!==-1},e.prototype.cancel=function(){this._canceled||(this._xhr&&this._xhr.abort(),this._canceled=!0)},e.prototype.error=function(t,i){!this._canceled&&this._onError&&this._onError({type:t,message:i})},e.prototype.finish=function(t){!this._canceled&&this._onFinish&&this._onFinish(t)},new n};class G_{init(e){this.stage=e,this._looping=!1,this._awaitingLoop=!1,this._loopHandler=null,this._idleLoopCounter=0,this._idleLoopDelay=60,this._onIdle=!1,this.stage.getOption("useImageWorker")&&(!window.createImageBitmap||!window.Worker?console.warn("[Lightning] Can't use image worker because browser does not have createImageBitmap and Web Worker support"):this._imageWorker=new N_),this._registerVisibilityChangeHandler()}destroy(){this._imageWorker&&this._imageWorker.destroy(),clearInterval(this._loopHandler),this._removeKeyHandler(),this._removeClickHandler(),this._removeHoverHandler(),this._removeScrollWheelHandler(),this._removeVisibilityChangeHandler(),this.stage=null,delete this.stage}startLoop(){this._looping=!0,this._awaitingLoop||this.loop()}stopLoop(){this._looping=!1}switchLoop(){if(this._onIdle===!1&&(this._onIdle=!0,this.stage.onIdle()),this._idleLoopCounter<this._idleLoopDelay){this._idleLoopCounter++;return}this.stage.ctx.hasRenderUpdates()?this._idleLoopCounter=0:(this.stopLoop(),this._loopHandler=setInterval(()=>{this.stage.updateFrame(),this.stage.idleFrame(),this.stage.ctx.hasRenderUpdates()&&(clearInterval(this._loopHandler),this.startLoop())},1e3/60))}loop(){let e=this,t=function(){e._awaitingLoop=!1,e._onIdle=!1,e._looping&&(e.stage.updateFrame(),e.stage.getOption("pauseRafLoopOnIdle")&&e.switchLoop(),e.stage.renderFrame(),requestAnimationFrame(t),e._awaitingLoop=!0)};requestAnimationFrame(t)}uploadCompressedGlTexture(e,t,i,s){const r=i.pvr?i.mipmaps[0]:new DataView(i.mipmaps[0]);e.compressedTexImage2D(e.TEXTURE_2D,0,i.glInternalFormat,i.pixelWidth,i.pixelHeight,0,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)}uploadGlTexture(e,t,i,s){if(i instanceof ImageData||i instanceof HTMLImageElement||i instanceof HTMLVideoElement||window.ImageBitmap&&i instanceof ImageBitmap)e.texImage2D(e.TEXTURE_2D,0,s.internalFormat,s.format,s.type,i);else if(i instanceof HTMLCanvasElement){if(H.isZiggo||this.stage.getOption("forceTxCanvasSource"))e.texImage2D(e.TEXTURE_2D,0,s.internalFormat,s.format,s.type,i);else if(i.width>0&&i.height>0){const r=i.getContext("2d");e.texImage2D(e.TEXTURE_2D,0,s.internalFormat,s.format,s.type,r.getImageData(0,0,i.width,i.height))}}else e.texImage2D(e.TEXTURE_2D,0,s.internalFormat,t.w,t.h,0,s.format,s.type,i)}handleKtxLoad(e,t){var i=this;return function(){var s=this.response,r=new DataView(s),o=3632701469;o!==r.getUint32(0)+r.getUint32(4)+r.getUint32(8)&&e("Parsing failed: identifier ktx mismatch:",t);var a=r.getUint32(12)===16909060,l={glType:r.getUint32(16,a),glTypeSize:r.getUint32(20,a),glFormat:r.getUint32(24,a),glInternalFormat:r.getUint32(28,a),glBaseInternalFormat:r.getUint32(32,a),pixelWidth:r.getUint32(36,a),pixelHeight:r.getUint32(40,a),pixelDepth:r.getUint32(44,a),numberOfArrayElements:r.getUint32(48,a),numberOfFaces:r.getUint32(52,a),numberOfMipmapLevels:r.getUint32(56,a),bytesOfKeyValueData:r.getUint32(60,a),kvps:[],mipmaps:[],get width(){return this.pixelWidth},get height(){return this.pixelHeight}};const h=g=>{const p=[];for(let m in g)p.push(g[m]);return p};Object.values(i.stage.renderer.getCompressedTextureExtensions()).filter(g=>g!=null).map(g=>h(g)).reduce((g,p)=>g.concat(p)).includes(l.glInternalFormat)||console.warn("[Lightning] Unrecognized texture extension format:",t,l.glInternalFormat,i.stage.renderer.getCompressedTextureExtensions());var u=64;u+=l.bytesOfKeyValueData;for(var d=0;d<l.numberOfMipmapLevels;d++){var f=r.getUint32(u);u+=4,l.mipmaps.push(r.buffer.slice(u,f)),u+=f}e(null,{source:l,renderInfo:{src:t,compressed:!0}})}}handlePvrLoad(e,t){return function(){const h=this.response,c=new Int32Array(h,0,13),u=c[12]+52,d=new Uint8Array(h,u);var f={glInternalFormat:36196,pixelWidth:c[7],pixelHeight:c[6],numberOfMipmapLevels:c[11],mipmaps:[],pvr:!0,get width(){return this.pixelWidth},get height(){return this.pixelHeight}};let g=0,p=f.pixelWidth,m=f.pixelHeight;for(var _=0;_<f.numberOfMipmapLevels;_++){const T=(p+3>>2)*(m+3>>2)*8,S=new Uint8Array(h,d.byteOffset+g,T);f.mipmaps.push(S),g+=T,p=p>>1,m=m>>1}e(null,{source:f,renderInfo:{src:t,compressed:!0}})}}loadSrcTexture({src:e,hasAlpha:t},i){let s,r=e.toLowerCase().indexOf(".png")>=0||e.substr(0,21)=="data:image/png;base64",o=e.indexOf(".ktx")>=0,a=e.indexOf(".pvr")>=0;if(o||a){let l=new XMLHttpRequest;l.addEventListener("load",o?this.handleKtxLoad(i,e):this.handlePvrLoad(i,e)),l.open("GET",e),l.responseType="arraybuffer",l.send(),s=function(){l.abort()}}else if(this._imageWorker){if(typeof e!="string")return i("Invalid image URL");const l=e.indexOf("//");if(l!==0&&l!==5&&l!==6)return i("Invalid image URL");const h=this._imageWorker.create(e);h.onError=function(c){return i("Image load error")},h.onLoad=function({imageBitmap:c,hasAlphaChannel:u}){i(null,{source:c,renderInfo:{src:e,compressed:!1},hasAlpha:u,premultiplyAlpha:!0})},s=function(){h.cancel()}}else{let l=new Image;e.substr(0,5)!="data:"&&!H.isPS4&&(l.crossOrigin="Anonymous"),l.onerror=function(h){if(l.src)return i("Image load error")},l.onload=function(){i(null,{source:l,renderInfo:{src:e,compressed:!1},hasAlpha:r||t})},l.src=e,s=function(){l.onerror=null,l.onload=null,l.removeAttribute("src")}}return s}createWebGLContext(e,t){let i=this.stage.getOption("canvas")||document.createElement("canvas");e&&t&&(i.width=e,i.height=t);let s={alpha:!0,antialias:!1,premultipliedAlpha:!0,stencil:!0,preserveDrawingBuffer:!1},r=i.getContext("webgl",s)||i.getContext("experimental-webgl",s)||i.getContext("webgl2",s);if(!r)throw new Error("This browser does not support webGL.");return r}createCanvasContext(e,t){let i=this.stage.getOption("canvas")||document.createElement("canvas");e&&t&&(i.width=e,i.height=t);let s=i.getContext("2d");if(!s)throw new Error("This browser does not support 2d canvas.");return s}getHrTime(){return window.performance?window.performance.now():new Date().getTime()}getDrawingCanvas(){return document.createElement("canvas")}getTextureOptionsForDrawingCanvas(e){let t={};return t.source=e,t}nextFrame(e){}registerKeydownHandler(e){this._keydownListener=t=>{e(t)},window.addEventListener("keydown",this._keydownListener)}registerKeyupHandler(e){this._keyupListener=t=>{e(t)},window.addEventListener("keyup",this._keyupListener)}_removeKeyHandler(){this._keydownListener&&window.removeEventListener("keydown",this._keydownListener),this._keyupListener&&window.removeEventListener("keyup",this._keyupListener)}registerClickHandler(e){this._clickListener=t=>{e(t)},window.addEventListener("mousedown",this._clickListener)}_removeClickHandler(){this._clickListener&&window.removeEventListener("mousedown",this._clickListener)}registerHoverHandler(e){this._hoverListener=t=>{e(t)},window.addEventListener("mousemove",this._hoverListener)}_removeHoverHandler(){this._hoverListener&&window.removeEventListener("mousemove",this._hoverListener)}registerScrollWheelHandler(e){this._scrollWheelListener=t=>{e(t)},window.addEventListener("wheel",this._scrollWheelListener)}_removeScrollWheelHandler(){this._scrollWheelListener&&window.removeEventListener("wheel",this._scrollWheelListener)}_registerVisibilityChangeHandler(){this._visibilityChangeHandler=()=>{document.visibilityState==="visible"&&(this.stage.root.core.setHasRenderUpdates(2),this.stage.renderFrame())},document.addEventListener("visibilitychange",this._visibilityChangeHandler)}_removeVisibilityChangeHandler(){this._visibilityChangeHandler&&document.removeEventListener("visibilitychange",this._visibilityChangeHandler)}}class H_{static load(e){return e.platform?e.platform:G_}}class wt{static isFunction(e){return typeof e=="function"}static isNumber(e){return typeof e=="number"}static isInteger(e){return typeof e=="number"&&e%1===0}static isBoolean(e){return e===!0||e===!1}static isString(e){return typeof e=="string"}static isObject(e){let t=typeof e;return!!e&&(t=="object"||t=="function")}static isPlainObject(e){return!!e&&typeof e=="object"}static isObjectLiteral(e){return typeof e=="object"&&e&&e.constructor===Object}static getArrayIndex(e,t){return wt.getModuloIndex(e,t.length)}static equalValues(e,t){return typeof e!=typeof t?!1:wt.isObjectLiteral(e)?wt.isObjectLiteral(t)&&wt.equalObjectLiterals(e,t):Array.isArray(e)?Array.isArray(t)&&wt.equalArrays(e,t):e===t}static equalObjectLiterals(e,t){let i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r=0,o=i.length;r<o;r++){const a=i[r],l=s[r];if(a!==l)return!1;const h=e[a],c=t[l];if(!wt.equalValues(h,c))return!1}return!0}static equalArrays(e,t){if(e.length!==t.length)return!1;for(let i=0,s=e.length;i<s;i++)if(!this.equalValues(e[i],t[i]))return!1;return!0}}class Qt{constructor(e,t){this._id=e,this._gl=t,this._program=void 0,this._buffers=new Map,this._framebuffers=new Map,this._renderbuffers=new Map,this._vertexAttribs=new Array(16),this._nonDefaultFlags=new Set,this._settings=new Map,this._textures=new Array(8),this._maxTexture=0,this._activeTexture=t.TEXTURE0,this._pixelStorei=new Array(5)}_getDefaultFlag(e){return e===this._gl.DITHER}setFlag(e,t){const i=this._getDefaultFlag(e);return t===i?this._nonDefaultFlags.delete(e):this._nonDefaultFlags.has(e)?!1:(this._nonDefaultFlags.add(e),!0)}setBuffer(e,t){const i=this._buffers.get(e)!==t;return this._buffers.set(e,t),i&&e===this._gl.ARRAY_BUFFER&&(this._vertexAttribs=[]),i}setFramebuffer(e,t){const i=this._framebuffers.get(e)!==t;return this._framebuffers.set(e,t),i}setRenderbuffer(e,t){const i=this._renderbuffers.get(e)!==t;return this._renderbuffers.set(e,t),i}setProgram(e){const t=this._program!==e;return this._program=e,t}setSetting(e,t){const i=this._settings.get(e),s=!i||!wt.equalValues(i,t);return this._settings.set(e,t),s}disableVertexAttribArray(e){const t=this._vertexAttribs[e];return t&&t[5]?(t[5]=!1,!0):!1}enableVertexAttribArray(e){const t=this._vertexAttribs[e];if(t){if(!t[0])return t[0]=!0,!0}else return this._vertexAttribs[e]=[0,0,0,0,0,!0],!0;return!1}vertexAttribPointer(e,t){let i=this._vertexAttribs[e],s=!1;return i&&(s=i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]),s?!1:(t[5]=i?i[5]:!1,!0)}setActiveTexture(e){const t=this._activeTexture!==e;return this._activeTexture=e,t}bindTexture(e,t){const i=Qt._getTextureIndex(this._activeTexture);this._maxTexture=Math.max(this._maxTexture,i+1);const s=this._textures[i],r=Qt._getTextureTargetIndex(e);return s?s[r]===t?!1:(s[r]=t,!0):t?(this._textures[i]=[],this._textures[i][r]=t,!0):!1}setPixelStorei(e,t){const i=Qt._getPixelStoreiIndex(e),s=!wt.equalValues(this._pixelStorei[i],t);return this._pixelStorei[i]=t,s}migrate(e){const t=this;this._migrateFlags(t,e),e._program!==t._program&&this._gl._useProgram(e._program),this._migrateFramebuffers(t,e),this._migrateRenderbuffers(t,e);const i=this._migrateBuffers(t,e);this._migrateAttributes(t,e,i),this._migrateFlags(t,e),this._migrateSettings(t,e),this._migratePixelStorei(t,e),this._migrateTextures(t,e)}_migratePixelStorei(e,t){for(let i=0,s=e._pixelStorei.length;i<s;i++)if(e._pixelStorei[i]!==t._pixelStorei[i]){const r=t._pixelStorei[i]!==void 0?t._pixelStorei[i]:Qt._getDefaultPixelStoreiByIndex(i);this._gl._pixelStorei(Qt._getPixelStoreiByIndex(i),r)}}_migrateTextures(e,t){const i=Math.max(e._maxTexture,t._maxTexture);let s=e._activeTexture;for(let r=0;r<i;r++){const o=t._textures[r],a=e._textures[r],l=Qt._getTextureByIndex(r),h=Math.max(a?a.length:0,o?o.length:0);for(let c=0,u=h;c<u;c++){const d=Qt._getTextureTargetByIndex(c);s!==l&&(this._gl._activeTexture(l),s=l);const f=o&&o[c]||null;this._gl._bindTexture(d,f)}}t._activeTexture!==s&&this._gl._activeTexture(t._activeTexture)}_migrateBuffers(e,t){return t._buffers.forEach((i,s)=>{e._buffers.get(s)!==i&&this._gl._bindBuffer(s,i)}),e._buffers.forEach((i,s)=>{t._buffers.get(s)===void 0&&this._gl._bindBuffer(s,null)}),t._buffers.get(this._gl.ARRAY_BUFFER)!==e._buffers.get(this._gl.ARRAY_BUFFER)}_migrateFramebuffers(e,t){t._framebuffers.forEach((i,s)=>{e._framebuffers.get(s)!==i&&this._gl._bindFramebuffer(s,i)}),e._framebuffers.forEach((i,s)=>{t._framebuffers.get(s)===void 0&&this._gl._bindFramebuffer(s,null)})}_migrateRenderbuffers(e,t){t._renderbuffers.forEach((i,s)=>{e._renderbuffers.get(s)!==i&&this._gl._bindRenderbuffer(s,i)}),e._renderbuffers.forEach((i,s)=>{t._renderbuffers.get(s)===void 0&&this._gl._bindRenderbuffer(s,null)})}_migrateAttributes(e,t,i){i?t._vertexAttribs.forEach((s,r)=>{s[0]&&this._gl._vertexAttribPointer(r,s[0],s[1],s[2],s[3],s[4]),s[5]&&this._gl._enableVertexAttribArray(r)}):(e._vertexAttribs.forEach((s,r)=>{t._vertexAttribs[r]||this._gl._disableVertexAttribArray(r)}),t._vertexAttribs.forEach((s,r)=>{this._gl._vertexAttribPointer(r,s[0],s[1],s[2],s[4]),s[5]?this._gl._enableVertexAttribArray(r):this._gl._disableVertexAttribArray(r)}))}_migrateSettings(e,t){const i=this.constructor.getDefaultSettings();e._settings.forEach((s,r)=>{const o=r.name||r.xname;if(!t._settings.has(r)){let a=i.get(o);wt.isFunction(a)&&(a=a(this._gl)),t._settings.set(r,a),r.apply(this._gl,a)}}),t._settings.forEach((s,r)=>{const o=e._settings.get(r);(!o||!wt.equalValues(o,s))&&r.apply(this._gl,s)})}_migrateFlags(e,t){e._nonDefaultFlags.forEach(i=>{t._nonDefaultFlags.has(i)||(this._getDefaultFlag(i)?this._gl._enable(i):this._gl._disable(i))}),t._nonDefaultFlags.forEach(i=>{e._nonDefaultFlags.has(i)||(this._getDefaultFlag(i)?this._gl._disable(i):this._gl._enable(i))})}static getDefaultSettings(){if(!this._defaultSettings){this._defaultSettings=new Map;const e=this._defaultSettings,t=WebGLRenderingContext.prototype;e.set("viewport",function(i){return[0,0,i.canvas.width,i.canvas.height]}),e.set("scissor",function(i){return[0,0,i.canvas.width,i.canvas.height]}),e.set("blendColor",[0,0,0,0]),e.set("blendEquation",[t.FUNC_ADD]),e.set("blendEquationSeparate",[t.FUNC_ADD,t.FUNC_ADD]),e.set("blendFunc",[t.ONE,t.ZERO]),e.set("blendFuncSeparate",[t.ONE,t.ZERO,t.ONE,t.ZERO]),e.set("clearColor",[0,0,0,0]),e.set("clearDepth",[1]),e.set("clearStencil",[0]),e.set("colorMask",[!0,!0,!0,!0]),e.set("cullFace",[t.BACK]),e.set("depthFunc",[t.LESS]),e.set("depthMask",[!0]),e.set("depthRange",[0,1]),e.set("frontFace",[t.CCW]),e.set("lineWidth",[1]),e.set("polygonOffset",[0,0]),e.set("sampleCoverage",[1,!1]),e.set("stencilFunc",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateFront",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateBack",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateFrontAndBack",[t.ALWAYS,0,1]),e.set("stencilMask",[1]),e.set("_stencilMaskSeparateFront",[1]),e.set("_stencilMaskSeparateBack",[1]),e.set("_stencilMaskSeparateFrontAndBack",[1]),e.set("stencilOp",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateFront",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateBack",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateFrontAndBack",[t.KEEP,t.KEEP,t.KEEP]),e.set("vertexAttrib1f",[]),e.set("vertexAttrib1fv",[]),e.set("vertexAttrib2f",[]),e.set("vertexAttrib2fv",[]),e.set("vertexAttrib3f",[]),e.set("vertexAttrib3fv",[]),e.set("vertexAttrib4f",[]),e.set("vertexAttrib4fv",[])}return this._defaultSettings}static _getTextureTargetIndex(e){switch(e){case 3553:return 0;case 34067:return 1;default:throw new Error("Unknown texture target: "+e)}}static _getTextureTargetByIndex(e){return this._textureTargetIndices||(this._textureTargetIndices=[3553,34067]),this._textureTargetIndices[e]}static _getTextureIndex(e){return e-33984}static _getTextureByIndex(e){return e+33984}static _getPixelStoreiIndex(e){switch(e){case 3333:return 0;case 3317:return 1;case 37440:return 2;case 37441:return 3;case 37443:return 4;case 37445:return 5;default:throw new Error("Unknown pixelstorei: "+e)}}static _getPixelStoreiByIndex(e){return this._pixelStoreiIndices||(this._pixelStoreiIndices=[3333,3317,37440,37441,37443]),this._pixelStoreiIndices[e]}static _getDefaultPixelStoreiByIndex(e){return this._pixelStoreiDefaults||(this._pixelStoreiDefaults=[4,4,!1,!1,WebGLRenderingContext.prototype.BROWSER_DEFAULT_WEBGL]),this._pixelStoreiDefaults[e]}}class xr{_initStateManager(e="default"){this._states={},this._state=this._getState(e)}_getState(e){return this._states[e]||(this._states[e]=new Qt(e,this)),this._states[e]}switchState(e="default"){if(this._state._id!==e){const t=this._getState(e);this._state.migrate(t),this._state=t}}$useProgram(e){this._state.setProgram(e)&&this._useProgram(e)}$bindBuffer(e,t){this._state.setBuffer(e,t)&&this._bindBuffer(e,t)}$bindFramebuffer(e,t){this._state.setFramebuffer(e,t)&&this._bindFramebuffer(e,t)}$bindRenderbuffer(e,t){this._state.setRenderbuffer(e,t)&&this._bindRenderbuffer(e,t)}$enable(e){this._state.setFlag(e,!0)&&this._enable(e)}$disable(e){this._state.setFlag(e,!1)&&this._disable(e)}$viewport(e,t,i,s){this._state.setSetting(this._viewport,[e,t,i,s])&&this._viewport(e,t,i,s)}$scissor(e,t,i,s){this._state.setSetting(this._scissor,[e,t,i,s])&&this._scissor(e,t,i,s)}$disableVertexAttribArray(e){this._state.disableVertexAttribArray(e)&&this._disableVertexAttribArray(e)}$enableVertexAttribArray(e){this._state.enableVertexAttribArray(e)&&this._enableVertexAttribArray(e)}$vertexAttribPointer(e,t,i,s,r,o){this._state.vertexAttribPointer(e,[t,i,s,r,o])&&this._vertexAttribPointer(e,t,i,s,r,o)}$activeTexture(e){this._state.setActiveTexture(e)&&this._activeTexture(e)}$bindTexture(e,t){this._state.bindTexture(e,t)&&this._bindTexture(e,t)}$pixelStorei(e,t){this._state.setPixelStorei(e,t)&&this._pixelStorei(e,t)}$stencilFuncSeparate(e,t,i,s){let r;switch(e){case this.FRONT:r=this._stencilFuncSeparateFront;break;case this.BACK:r=this._stencilFuncSeparateBack;break;case this.FRONT_AND_BACK:r=this._stencilFuncSeparateFrontAndBack;break}this._state.setSetting(r,[t,i,s])&&r.apply(this,[t,i,s])}_stencilFuncSeparateFront(e,t,i){this._stencilFuncSeparate(this.FRONT,e,t,i)}_stencilFuncSeparateBack(e,t,i){this._stencilFuncSeparate(this.BACK,e,t,i)}_stencilFuncSeparateFrontAndBack(e,t,i){this._stencilFuncSeparate(this.FRONT_AND_BACK,e,t,i)}$stencilMaskSeparate(e,t){let i;switch(e){case this.FRONT:i=this._stencilMaskSeparateFront;break;case this.BACK:i=this._stencilMaskSeparateBack;break;case this.FRONT_AND_BACK:i=this._stencilMaskSeparateFrontAndBack;break}this._state.setSetting(i,[t])&&i.apply(this,[t])}_stencilMaskSeparateFront(e){this._stencilMaskSeparate(this.FRONT,e)}_stencilMaskSeparateBack(e){this._stencilMaskSeparate(this.BACK,e)}_stencilMaskSeparateFrontAndBack(e){this._stencilMaskSeparate(this.FRONT_AND_BACK,e)}$stencilOpSeparate(e,t,i,s){let r;switch(e){case this.FRONT:r=this._stencilOpSeparateFront;break;case this.BACK:r=this._stencilOpSeparateBack;break;case this.FRONT_AND_BACK:r=this._stencilOpSeparateFrontAndBack;break}this._state.setSetting(r,[t,i,s])&&r.apply(this,[t,i,s])}_stencilOpSeparateFront(e,t,i){this._stencilOpSeparate(this.FRONT,e,t,i)}_stencilOpSeparateBack(e,t,i){this._stencilOpSeparate(this.BACK,e,t,i)}_stencilOpSeparateFrontAndBack(e,t,i){this._stencilOpSeparate(this.FRONT_AND_BACK,e,t,i)}$blendColor(e,t,i,s){this._state.setSetting(this._blendColor,[e,t,i,s])&&this._blendColor(e,t,i,s)}$blendEquation(e){this._state.setSetting(this._blendEquation,[e])&&this._blendEquation(e)}$blendEquationSeparate(e,t){this._state.setSetting(this._blendEquationSeparate,[e,t])&&this._blendEquationSeparate(e,t)}$blendFunc(e,t){this._state.setSetting(this._blendFunc,[e,t])&&this._blendFunc(e,t)}$blendFuncSeparate(e,t,i,s){this._state.setSetting(this._blendFuncSeparate,[e,t,i,s])&&this._blendFuncSeparate(e,t,i,s)}$clearColor(e,t,i,s){this._state.setSetting(this._clearColor,[e,t,i,s])&&this._clearColor(e,t,i,s)}$clearDepth(e){this._state.setSetting(this._clearDepth,[e])&&this._clearDepth(e)}$clearStencil(e){this._state.setSetting(this._clearStencil,[e])&&this._clearStencil(e)}$colorMask(e,t,i,s){this._state.setSetting(this._colorMask,[e,t,i,s])&&this._colorMask(e,t,i,s)}$cullFace(e){this._state.setSetting(this._cullFace,[e])&&this._cullFace(e)}$depthFunc(e){this._state.setSetting(this._depthFunc,[e])&&this._depthFunc(e)}$depthMask(e){this._state.setSetting(this._depthMask,[e])&&this._depthMask(e)}$depthRange(e,t){this._state.setSetting(this._depthRange,[e,t])&&this._depthRange(e,t)}$frontFace(e){this._state.setSetting(this._frontFace,[e])&&this._frontFace(e)}$lineWidth(e){this._state.setSetting(this._lineWidth,[e])&&this._lineWidth(e)}$polygonOffset(e,t){this._state.setSetting(this._polygonOffset,[e,t])&&this._polygonOffset(e,t)}$sampleCoverage(e,t){this._state.setSetting(this._sampleCoverage,[e,t])&&this._sampleCoverage(e,t)}$stencilFunc(e,t,i){this._state.setSetting(this._stencilFunc,[e,t,i])&&this._stencilFunc(e,t,i)}$stencilMask(e){this._state.setSetting(this._stencilMask,[e])&&this._stencilMask(e)}$stencilOp(e,t,i){this._state.setSetting(this._stencilOp,[e,t,i])&&this._stencilOp(e,t,i)}$vertexAttrib1f(e,t){this._state.setSetting(this._vertexAttrib1f,[e,t])&&this._vertexAttrib1f(e,t)}$vertexAttrib1fv(e,t){this._state.setSetting(this._vertexAttrib1fv,[e,t])&&this._vertexAttrib1fv(e,t)}$vertexAttrib2f(e,t,i){this._state.setSetting(this._vertexAttrib2f,[e,t,i])&&this._vertexAttrib2f(e,t,i)}$vertexAttrib2fv(e,t){this._state.setSetting(this._vertexAttrib2fv,[e,t])&&this._vertexAttrib2fv(e,t)}$vertexAttrib3f(e,t,i,s){this._state.setSetting(this._vertexAttrib3f,[e,t,i,s])&&this._vertexAttrib3f(e,t,i,s)}$vertexAttrib3fv(e,t){this._state.setSetting(this._vertexAttrib3fv,[e,t])&&this._vertexAttrib3fv(e,t)}$vertexAttrib4f(e,t,i,s,r){this._state.setSetting(this._vertexAttrib4f,[e,t,i,s,r])&&this._vertexAttrib4f(e,t,i,s,r)}$vertexAttrib4fv(e,t){this._state.setSetting(this._vertexAttrib4fv,[e,t])&&this._vertexAttrib4fv(e,t)}static enable(e,t="default"){const i=Object.getOwnPropertyNames(xr.prototype);return e.__proto__,i.forEach(s=>{if(s!=="constructor"){const r=xr.prototype[s];s.charAt(0)==="$"&&(s=s.substr(1)),e[s]!==r&&(e[s]&&(e[s].name||(e[s].xname=s),e["_"+s]=e[s]),e[s]=r)}}),xr.prototype._initStateManager.call(e,t),e}}class V_{constructor(e){this.stage=e,this._usedMemory=0,this._uploadedTextureSources=[],this.textureSourceHashmap=new Map}get usedMemory(){return this._usedMemory}destroy(){for(let e=0,t=this._uploadedTextureSources.length;e<t;e++)this._nativeFreeTextureSource(this._uploadedTextureSources[e]);this.textureSourceHashmap.clear(),this._usedMemory=0}getReusableTextureSource(e){return this.textureSourceHashmap.get(e)}getTextureSource(e,t){let i=t?this.textureSourceHashmap.get(t):null;return i||(i=new rr(this,e),t&&(i.lookupId=t,this.textureSourceHashmap.set(t,i))),i}uploadTextureSource(e,t){if(e.isLoaded())return;this._addMemoryUsage(e.w*e.h);const i=this._nativeUploadTextureSource(e,t);e._nativeTexture=i,i.w=e.w,i.h=e.h,i.update=this.stage.frameCounter,this._uploadedTextureSources.push(e),this.addToLookupMap(e),this._updateVramUsage(e,1)}_addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}_updateVramUsage(e,t){const i=e.nativeTexture;var s;hs.isWebglSupported()&&e.isLoaded()&&(!i.hasOwnProperty("bytesPerPixel")||isNaN(i.bytesPerPixel)||(s=t*(e.w*e.h*i.bytesPerPixel),this.stage.addVramUsage(s,e.hasAlpha)))}addToLookupMap(e){const t=e.lookupId;t&&(this.textureSourceHashmap.has(t)||this.textureSourceHashmap.set(t,e))}gc(){this.freeUnusedTextureSources()}freeUnusedTextureSources(){let e=[];for(let t=0,i=this._uploadedTextureSources.length;t<i;t++){let s=this._uploadedTextureSources[t];s.allowCleanup()?this._freeManagedTextureSource(s):e.push(s)}this._uploadedTextureSources=e,this._cleanupLookupMap()}_freeManagedTextureSource(e){e.isLoaded()&&(this._nativeFreeTextureSource(e),this._addMemoryUsage(-e.w*e.h),this._updateVramUsage(e,-1)),e.loadingSince=null}_cleanupLookupMap(){this.textureSourceHashmap.forEach((e,t)=>{!(e.isLoaded()||e.isLoading())&&!e.isUsed()&&this.textureSourceHashmap.delete(t)})}freeTextureSource(e){const t=this._uploadedTextureSources.indexOf(e),i=t!==-1;e.isLoaded()&&(i&&(this._addMemoryUsage(-e.w*e.h),this._uploadedTextureSources.splice(t,1)),this._nativeFreeTextureSource(e)),e.loadingSince=null}_nativeUploadTextureSource(e,t){return this.stage.renderer.uploadTextureSource(e,t)}_nativeFreeTextureSource(e){this.stage.renderer.freeTextureSource(e),e.clearNativeTexture()}}class qo{constructor(e){this.stage=e,this.genericCancelCb=t=>{this._remove(t)},this._sources=[],this._data=[]}destroy(){this._sources=[],this._data=[],this.stage=null,delete this._sources,delete this._data,delete this.stage}processSome(){if(this._sources.length){const e=Date.now();do this._processItem();while(this._sources.length&&Date.now()-e<qo.MAX_UPLOAD_TIME_PER_FRAME)}}_processItem(){const e=this._sources.pop(),t=this._data.pop();e.isLoading()&&e.processLoadedSource(t)}add(e,t){this._sources.push(e),this._data.push(t)}_remove(e){const t=this._sources.indexOf(e);t>=0&&(this._sources.splice(t,1),this._data.splice(t,1))}}qo.MAX_UPLOAD_TIME_PER_FRAME=10;class W_{constructor(e){this.stage=e,this.root=null,this.updateTreeOrder=0,this.renderState=this.stage.renderer.createCoreRenderState(this),this.renderExec=this.stage.renderer.createCoreRenderExecutor(this),this.renderExec.init(),this._usedMemory=0,this._renderTexturePool=[],this._renderTextureId=1,this._zSorts=[],this.renderToTextureCount=0}get usedMemory(){return this._usedMemory}destroy(){this._renderTexturePool.forEach(e=>this._freeRenderTexture(e)),this._usedMemory=0,this.stage=null,this.root=null,this.renderState=null,this.renderExec=null,this._renderTexturePool=null,this._zSorts=null,delete this.stage,delete this.root,delete this.renderState,delete this.renderExec,delete this._renderTexturePool,delete this._zSorts}hasRenderUpdates(){return!!this.root._parent._hasRenderUpdates}render(){this.root._parent._hasRenderUpdates=0,this._render()}update(){this._update(),this.root._hasUpdates&&this._update(),this._performForcedZSorts()}_performForcedZSorts(){if(this._zSorts.length){for(let t=0,i=this._zSorts.length;t<i;t++)this._zSorts[t].zSort&&this._zSorts[t].sortZIndexedChildren();this._zSorts=[]}}_update(){this.updateTreeOrder=0,this.root.update()}_render(){const e=this.stage.getOption("debugFrame");this._fillRenderState(),this.stage.getOption("readPixelsBeforeDraw")&&this._readPixels(),this._performRender(),e&&console.log(`[Lightning] RTT Renders in frame: ${this.renderToTextureCount}`),this.stage.getOption("readPixelsAfterDraw")&&this.renderToTextureCount>=this.stage.getOption("readPixelsAfterDrawThreshold")&&(e&&console.log("[Lightning] readPixelsAfterDraw behavior triggered"),this._readPixels()),this.renderToTextureCount=0}_readPixels(){const e=new Uint8Array(4),t=this.stage.gl;t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,e)}_fillRenderState(){this.renderState.reset(),this.root.render(),this.renderState.finish()}_performRender(){this.renderExec.execute()}_addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}allocateRenderTexture(e,t){let i=this.stage.getRenderPrecision(),s=Math.max(1,Math.round(e*i)),r=Math.max(1,Math.round(t*i));const o=this._renderTexturePool.length;for(let l=o-1;l>=0;l--){const h=this._renderTexturePool[l];if(h.w===s&&h.h===r&&h.update!==this.stage.frameCounter)return h.f=this.stage.frameCounter,this._renderTexturePool.splice(l,1),h}const a=this._createRenderTexture(e,t,s,r);return a.precision=i,a}releaseRenderTexture(e){this._renderTexturePool.push(e)}freeUnusedRenderTextures(e=60){let t=this.stage.frameCounter-e;this._renderTexturePool=this._renderTexturePool.filter(i=>i.f<=t?(this._freeRenderTexture(i),!1):!0)}_createRenderTexture(e,t,i,s){this._addMemoryUsage(i*s);const r=this.stage.renderer.createRenderTexture(e,t,i,s);return r.id=this._renderTextureId++,r.f=this.stage.frameCounter,r.ow=e,r.oh=t,r.w=i,r.h=s,r}_freeRenderTexture(e){this.stage.renderer.freeRenderTexture(e),this._addMemoryUsage(-e.w*e.h)}copyRenderTexture(e,t,i){this.stage.renderer.copyRenderTexture(e,t,i)}forceZSort(e){this._zSorts.push(e)}}class xl{constructor(e){this.stage=e,this._timingFunction="ease",this._timingFunctionImpl=ie.getTimingFunction(this._timingFunction),this.delay=0,this.duration=.2,this.merger=null}get timingFunction(){return this._timingFunction}set timingFunction(e){this._timingFunction=e,this._timingFunctionImpl=ie.getTimingFunction(e)}get timingFunctionImpl(){return this._timingFunctionImpl}patch(e){Xe.patchObject(this,e)}}xl.prototype.isTransitionSettings=!0;class Y_{constructor(e){this.stage=e,this.stage.on("frameStart",()=>this.progress()),this.active=new Set,this.defaultTransitionSettings=new xl(this.stage)}progress(){if(this.active.size){let e=this.stage.dt,t=!1;this.active.forEach(function(i){i.progress(e),i.isRunning()||(t=!0)}),t&&(this.active=new Set([...this.active].filter(i=>i.isRunning())))}}createSettings(e){const t=new xl;return Xe.patchObject(t,e),t}addActive(e){this.active.add(e)}removeActive(e){this.active.delete(e)}}class Me{constructor(){this._clear()}_clear(){this._p=[],this._pe=[],this._idp=[],this._f=[],this._v=[],this._lv=[],this._sm=[],this._s=[],this._ve=[],this._sme=[],this._se=[],this._length=0}parse(e,t){let i,s;H.isObjectLiteral(t)||(t={0:t});let r=.5,o=[];for(let a in t)if(t.hasOwnProperty(a)){let l=t[a];H.isObjectLiteral(l)||(l={v:l});let h=parseFloat(a);a==="sm"?r=l.v:!isNaN(h)&&h>=0&&h<=2&&(l.p=h,l.f=H.isFunction(l.v),l.lv=l.f?l.v(0,0):l.v,o.push(l))}for(o=o.sort(function(a,l){return a.p-l.p}),s=o.length,i=0;i<s;i++){let a=i===s-1;if(!o[i].hasOwnProperty("pe"))o[i].pe=a?o[i].p<=1?1:2:o[i+1].p;else{const l=i<s-1?o[i+1].p:1;o[i].pe>l&&(o[i].pe=l)}o[i].pe===o[i].p?o[i].idp=0:o[i].idp=1/(o[i].pe-o[i].p)}for(i=0;i<s;i++)if(o[i].hasOwnProperty("sm")||(o[i].sm=r),!o[i].hasOwnProperty("s"))if(i===0||i===s-1||o[i].p===1)o[i].s=e?[0,0,0,0]:0;else{const a=o[i-1],l=o[i+1];if(a.p===l.p)o[i].s=e?[0,0,0,0]:0;else if(e){const h=Me.getRgbaComponents(l.lv),c=Me.getRgbaComponents(a.lv),u=1/(l.p-a.p);o[i].s=[u*(h[0]-c[0]),u*(h[1]-c[1]),u*(h[2]-c[2]),u*(h[3]-c[3])]}else o[i].s=(l.lv-a.lv)/(l.p-a.p)}for(i=0;i<s-1;i++)if(!o[i].f){let a=i===s-1;o[i].hasOwnProperty("ve")||(o[i].ve=a?o[i].lv:o[i+1].lv),H.isNumber(o[i].v)&&H.isNumber(o[i].lv)&&(o[i].hasOwnProperty("sme")||(o[i].sme=a?r:o[i+1].sm),o[i].hasOwnProperty("se")||(o[i].se=a?e?[0,0,0,0]:0:o[i+1].s),e?o[i].v=Me.getSplineRgbaValueFunction(o[i].v,o[i].ve,o[i].p,o[i].pe,o[i].sm,o[i].sme,o[i].s,o[i].se):o[i].v=Me.getSplineValueFunction(o[i].v,o[i].ve,o[i].p,o[i].pe,o[i].sm,o[i].sme,o[i].s,o[i].se),o[i].f=!0)}for(this.length&&this._clear(),i=0,s=o.length;i<s;i++)this._add(o[i])}_add(e){this._p.push(e.p||0),this._pe.push(e.pe||0),this._idp.push(e.idp||0),this._f.push(e.f||!1),this._v.push(e.hasOwnProperty("v")?e.v:0),this._lv.push(e.lv||0),this._sm.push(e.sm||0),this._s.push(e.s||0),this._ve.push(e.ve||0),this._sme.push(e.sme||0),this._se.push(e.se||0),this._length++}_getItem(e){const t=this._length;if(!t)return-1;if(e<this._p[0])return 0;for(let i=0;i<t;i++)if(this._p[i]<=e&&e<this._pe[i])return i;return t-1}getValue(e){const t=this._getItem(e);if(t!==-1)if(this._f[t]){const i=Math.min(1,Math.max(0,(e-this._p[t])*this._idp[t]));return this._v[t](i)}else return this._v[t]}get length(){return this._length}static getRgbaComponents(e){let t=(e/65536|0)%256,i=(e/256|0)%256,s=e%256,r=e/16777216|0;return[t,i,s,r]}static getSplineValueFunction(e,t,i,s,r,o,a,l){let h=s-i;a*=h,l*=h;let c=Me.getSplineHelpers(e,t,r,o,a,l);return c?function(u){return u===0?e:u===1?t:Me.calculateSpline(c,u)}:function(u){return u===0?e:u===1?t:t*u+e*(1-u)}}static getSplineRgbaValueFunction(e,t,i,s,r,o,a,l){let h=s-i;a[0]*=h,a[1]*=h,a[2]*=h,a[3]*=h,l[0]*=h,l[1]*=h,l[2]*=h,l[3]*=h;let c=Me.getRgbaComponents(e),u=Me.getRgbaComponents(t),d=[Me.getSplineHelpers(c[0],u[0],r,o,a[0],l[0]),Me.getSplineHelpers(c[1],u[1],r,o,a[1],l[1]),Me.getSplineHelpers(c[2],u[2],r,o,a[2],l[2]),Me.getSplineHelpers(c[3],u[3],r,o,a[3],l[3])];return d[0]?function(f){return f===0?e:f===1?t:Me.getArgbNumber([Math.min(255,Me.calculateSpline(d[0],f)),Math.min(255,Me.calculateSpline(d[1],f)),Math.min(255,Me.calculateSpline(d[2],f)),Math.min(255,Me.calculateSpline(d[3],f))])}:function(f){return f===0?e:f===1?t:Me.mergeColors(t,e,f)}}static getSplineHelpers(e,t,i,s,r,o){if(!i&&!s)return null;let a=i,l=e+r*i,h=1-s,c=t-o*s,u=3*a-3*h+1,d=-6*a+3*h,f=3*a,g=3*l-3*c+t-e,p=3*(c+e)-6*l,m=3*(l-e);return[u,d,f,g,p,m,e]}static calculateSpline(e,t){let i=e[0],s=e[1],r=e[2],o=e[3],a=e[4],l=e[5],h=e[6];if(i===-2&&o===-2&&r===0&&l===0)return t;let c=.5,u,d;for(let p=0;p<20;p++){if(u=c*(c*(c*i+s)+r),d=t-u,d>-1e-8&&d<1e-8)return c*(c*(c*o+a)+l)+h;let m=c*(c*(3*i)+2*s)+r;if(m>1e-10&&m<1e-10)break;c+=d/m}let f=0,g=1;for(let p=0;p<20;p++){if(c=.5*(f+g),u=c*(c*(c*i+s)+r),d=t-u,d>-1e-8&&d<1e-8)return c*(c*(c*o+a)+l)+h;d<0?g=c:f=c}return c}static mergeColors(e,t,i){let s=(e/65536|0)%256,r=(e/256|0)%256,o=e%256,a=e/16777216|0,l=(t/65536|0)%256,h=(t/256|0)%256,c=t%256,u=t/16777216|0,d=s*i+l*(1-i),f=r*i+h*(1-i),g=o*i+c*(1-i),p=a*i+u*(1-i);return Math.round(p)*16777216+Math.round(d)*65536+Math.round(f)*256+Math.round(g)}static getArgbNumber(e){e[0]=Math.max(0,Math.min(255,e[0])),e[1]=Math.max(0,Math.min(255,e[1])),e[2]=Math.max(0,Math.min(255,e[2])),e[3]=Math.max(0,Math.min(255,e[3]));let t=((e[3]|0)<<24)+((e[0]|0)<<16)+((e[1]|0)<<8)+(e[2]|0);return t<0&&(t=4294967295+t+1),t}}class qd{constructor(e){this.animationSettings=e,this._selector="",this._items=new Me,this._props=[],this._propSetters=[],this._resetValue=void 0,this._hasResetValue=!1,this._hasColorProperty=void 0}getResetValue(){return this._hasResetValue?this._resetValue:this._items.getValue(0)}apply(e,t,i){const s=this.getAnimatedElements(e);let r=this._items.getValue(t);if(r===void 0||!s.length)return;if(i!==1){let l=this.getResetValue();H.isNumber(r)&&H.isNumber(l)&&(this.hasColorProperty()?r=ie.mergeColors(r,l,i):r=ie.mergeNumbers(r,l,i))}const o=this._propSetters.length,a=s.length;for(let l=0;l<a;l++)for(let h=0;h<o;h++)this._propSetters[h](s[l],r)}getAnimatedElements(e){const t=this._selector;return typeof t=="string"?e.select(t):[t]}reset(e){const t=this.getAnimatedElements(e);let i=this.getResetValue();if(i===void 0||!t.length)return;const s=this._propSetters.length,r=t.length;for(let o=0;o<r;o++)for(let a=0;a<s;a++)this._propSetters[a](t[o],i)}set selector(e){this._selector=e}set t(e){this.selector=e}get resetValue(){return this._resetValue}set resetValue(e){this._resetValue=e,this._hasResetValue=e!==void 0}set rv(e){this.resetValue=e}set value(e){this._items.parse(this.hasColorProperty(),e)}set v(e){this.value=e}set properties(e){Array.isArray(e)||(e=[e]),this._props=[],e.forEach(t=>{this._props.push(t),this._propSetters.push(Ce.getSetter(t))})}set property(e){this._hasColorProperty=void 0,this.properties=e}set p(e){this.properties=e}patch(e){Xe.patchObject(this,e)}hasColorProperty(){return this._hasColorProperty===void 0&&(this._hasColorProperty=this._props.length?Ce.isColorProperty(this._props[0]):!1),this._hasColorProperty}}qd.prototype.isAnimationActionSettings=!0;class nt{constructor(){this._actions=[],this.delay=0,this.duration=1,this.repeat=0,this.repeatOffset=0,this.repeatDelay=0,this.autostop=!1,this.stopMethod=nt.STOP_METHODS.FADE,this._stopTimingFunction="ease",this._stopTimingFunctionImpl=ie.getTimingFunction(this._stopTimingFunction),this.stopDuration=0,this.stopDelay=0}get actions(){return this._actions}set actions(e){this._actions=[];for(let t=0,i=e.length;t<i;t++){const s=e[t];if(s.isAnimationActionSettings)this._actions.push(s);else{const r=new qd(this);r.patch(s),this._actions.push(r)}}}apply(e,t,i=1){this._actions.forEach(function(s){s.apply(e,t,i)})}reset(e){this._actions.forEach(function(t){t.reset(e)})}get stopTimingFunction(){return this._stopTimingFunction}set stopTimingFunction(e){this._stopTimingFunction=e,this._stopTimingFunctionImpl=ie.getTimingFunction(e)}get stopTimingFunctionImpl(){return this._stopTimingFunctionImpl}patch(e){Xe.patchObject(this,e)}}nt.STOP_METHODS={FADE:"fade",REVERSE:"reverse",FORWARD:"forward",IMMEDIATE:"immediate",ONETOTWO:"onetotwo"};class ce extends tt{constructor(e,t,i){super(),this.manager=e,this._settings=t,this._element=i,this._state=ce.STATES.IDLE,this._p=0,this._delayLeft=0,this._repeatsLeft=0,this._stopDelayLeft=0,this._stopP=0}start(){this._element&&this._element.attached?(this._p=0,this._delayLeft=this.settings.delay,this._repeatsLeft=this.settings.repeat,this._state=ce.STATES.PLAYING,this.emit("start"),this.checkActive()):console.warn("[Lightning] Element must be attached before starting animation")}play(){this._state===ce.STATES.PAUSED?(this._state=ce.STATES.PLAYING,this.checkActive(),this.emit("resume")):this._state==ce.STATES.STOPPING&&this.settings.stopMethod==nt.STOP_METHODS.REVERSE?(this._state=ce.STATES.PLAYING,this.emit("stopContinue")):this._state!=ce.STATES.PLAYING&&this._state!=ce.STATES.FINISHED&&this.start()}pause(){this._state===ce.STATES.PLAYING&&(this._state=ce.STATES.PAUSED,this.emit("pause"))}replay(){this._state==ce.STATES.FINISHED?this.start():this.play()}skipDelay(){this._delayLeft=0,this._stopDelayLeft=0}finish(){this._state===ce.STATES.PLAYING?(this._delayLeft=0,this._p=1):this._state===ce.STATES.STOPPING&&(this._stopDelayLeft=0,this._p=0)}stop(){this._state===ce.STATES.STOPPED||this._state===ce.STATES.IDLE||(this._stopDelayLeft=this.settings.stopDelay||0,this.settings.stopMethod===nt.STOP_METHODS.IMMEDIATE&&!this._stopDelayLeft||this._delayLeft>0?(this._state=ce.STATES.STOPPING,this.emit("stop")):(this.settings.stopMethod===nt.STOP_METHODS.FADE&&(this._stopP=0),this._state=ce.STATES.STOPPING,this.emit("stop")),this.checkActive())}stopNow(){(this._state!==ce.STATES.STOPPED||this._state!==ce.STATES.IDLE)&&(this._state=ce.STATES.STOPPING,this._p=0,this.emit("stop"),this.reset(),this._state=ce.STATES.STOPPED,this.emit("stopFinish"))}isPaused(){return this._state===ce.STATES.PAUSED}isPlaying(){return this._state===ce.STATES.PLAYING}isStopping(){return this._state===ce.STATES.STOPPING}isFinished(){return this._state===ce.STATES.FINISHED}checkActive(){this.isActive()&&this.manager.addActive(this)}isActive(){return(this._state==ce.STATES.PLAYING||this._state==ce.STATES.STOPPING)&&this._element&&this._element.attached}progress(e){this._element&&(this._progress(e),this.apply())}_progress(e){if(this._state==ce.STATES.STOPPING){this._stopProgress(e);return}if(this._state==ce.STATES.PLAYING){if(this._delayLeft>0)if(this._delayLeft-=e,this._delayLeft<0)e=-this._delayLeft,this._delayLeft=0,this.emit("delayEnd");else return;this.settings.duration===0?this._p=1:this.settings.duration>0&&(this._p+=e/this.settings.duration),this._p>=1?this.settings.repeat==-1||this._repeatsLeft>0?(this._repeatsLeft>0&&this._repeatsLeft--,this._p=this.settings.repeatOffset,this.emit("progress",this._p),this.settings.repeatDelay&&(this._delayLeft=this.settings.repeatDelay),this.emit("repeat",this._repeatsLeft)):(this._p=1,this.emit("progress",this._p),this._state=ce.STATES.FINISHED,this.emit("finish"),this.settings.autostop&&this.stop()):this.emit("progress",this._p)}}_stopProgress(e){let t=this._getStopDuration();if(this._stopDelayLeft>0)if(this._stopDelayLeft-=e,this._stopDelayLeft<0)e=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("stopDelayEnd");else return;this.settings.stopMethod==nt.STOP_METHODS.IMMEDIATE?(this._state=ce.STATES.STOPPED,this.emit("stopFinish")):this.settings.stopMethod==nt.STOP_METHODS.REVERSE?(t===0?this._p=0:t>0&&(this._p-=e/t),this._p<=0&&(this._p=0,this._state=ce.STATES.STOPPED,this.emit("stopFinish"))):this.settings.stopMethod==nt.STOP_METHODS.FADE?(this._progressStopTransition(e),this._stopP>=1&&(this._p=0,this._state=ce.STATES.STOPPED,this.emit("stopFinish"))):this.settings.stopMethod==nt.STOP_METHODS.ONETOTWO?this._p<2&&(t===0?this._p=2:t>0&&(this._p<1?this._p+=e/this.settings.duration:this._p+=e/t),this._p>=2?(this._p=2,this._state=ce.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p)):this.settings.stopMethod==nt.STOP_METHODS.FORWARD&&this._p<1&&(this.settings.duration==0?this._p=1:this._p+=e/this.settings.duration,this._p>=1?this.settings.stopMethod==nt.STOP_METHODS.FORWARD?(this._p=1,this._state=ce.STATES.STOPPED,this.emit("stopFinish")):this._repeatsLeft>0?(this._repeatsLeft--,this._p=0,this.emit("repeat",this._repeatsLeft)):(this._p=1,this._state=ce.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p))}_progressStopTransition(e){if(this._stopP<1){if(this._stopDelayLeft>0)if(this._stopDelayLeft-=e,this._stopDelayLeft<0)e=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("delayEnd");else return;const t=this._getStopDuration();t==0?this._stopP=1:this._stopP+=e/t,this._stopP>=1&&(this._stopP=1)}}_getStopDuration(){return this.settings.stopDuration||this.settings.duration}apply(){if(this._state===ce.STATES.STOPPED)this.reset();else{let e=1;this._state===ce.STATES.STOPPING&&this.settings.stopMethod===nt.STOP_METHODS.FADE&&(e=1-this.settings.stopTimingFunctionImpl(this._stopP)),this._settings.apply(this._element,this._p,e)}}reset(){this._settings.reset(this._element)}get state(){return this._state}get p(){return this._p}get delayLeft(){return this._delayLeft}get element(){return this._element}get frame(){return Math.round(this._p*this._settings.duration*60)}get settings(){return this._settings}}ce.STATES={IDLE:0,PLAYING:1,STOPPING:2,STOPPED:3,FINISHED:4,PAUSED:5};class K_{constructor(e){this.stage=e,this.stage.on("frameStart",()=>this.progress()),this.active=new Set}progress(){if(this.active.size){let e=this.stage.dt,t=!1;this.active.forEach(function(i){i.isActive()?i.progress(e):t=!0}),t&&(this.active=new Set([...this.active].filter(i=>i.isActive())))}}createAnimation(e,t){return H.isObjectLiteral(t)&&(t=this.createSettings(t)),new ce(this,t,e)}createSettings(e){const t=new nt;return Xe.patchObject(t,e),t}addActive(e){this.active.add(e)}}class Qd extends _t{_getLookupId(){return"__whitepix"}_getSourceLoader(){return function(e){var t=new Uint8Array([255,255,255,255]);e(null,{source:t,w:1,h:1,permanent:!0})}}isAutosizeTexture(){return!1}}class hs extends tt{constructor(e={}){super(),this._setOptions(e),this._usedMemory=0,this._lastGcFrame=0,this._usedVramAlpha=0,this._usedVramNonAlpha=0;const t=hs.platform?hs.platform:H_.load(e);this.platform=new t,this.platform.init&&this.platform.init(this),this.gl=null,this.c2d=null;const i=this.getOption("context");if(i?i.useProgram?this.gl=i:this.c2d=i:H.isWeb&&(!hs.isWebglSupported()||this.getOption("canvas2d"))?this.c2d=this.platform.createCanvasContext(this.getOption("w"),this.getOption("h")):this.gl=this.platform.createWebGLContext(this.getOption("w"),this.getOption("h")),this.gl&&xr.enable(this.gl,"lightning"),this._mode=this.gl?0:1,this.getCanvas()){if(this.getOption("devicePixelRatio")!==1){const s=this.getOption("devicePixelRatio");this.getCanvas().style.width=this._options.w/s+"px",this.getCanvas().style.height=this._options.h/s+"px"}this._options.w=this.getCanvas().width,this._options.h=this.getCanvas().height}this._mode===0?H.isSpark?this._renderer=new U_(this):this._renderer=new jd(this):this._renderer=new B_(this),this.setClearColor(this.getOption("clearColor")),this.frameCounter=0,this.transitions=new Y_(this),this.animations=new K_(this),this.textureManager=new V_(this),this.textureThrottler=new qo(this),this.startTime=0,this.currentTime=0,this.dt=0,this.rectangleTexture=new Qd(this),this.rectangleTexture.load(),this.rectangleTexture.source.permanent=!0,this.ctx=new W_(this),this._updateSourceTextures=new Set}get renderer(){return this._renderer}static isWebglSupported(){if(H.isNode)return!0;try{return!!window.WebGLRenderingContext}catch{return!1}}get mode(){return this._mode}isWebgl(){return this.mode===0}isC2d(){return this.mode===1}getOption(e){return this._options[e]}_setOptions(e){this._options={};let t=(i,s)=>{let r=e[i];r===void 0?this._options[i]=s:this._options[i]=r};t("canvas",null),t("context",null),t("w",1920),t("h",1080),t("srcBasePath",null),t("memoryPressure",24e6),t("bufferMemory",2e6),t("textRenderIssueMargin",0),t("fontSharp",{precision:.6666666667,fontSize:24}),t("clearColor",[0,0,0,0]),t("defaultFontFace","sans-serif"),t("fixedDt",0),t("useImageWorker",!0),t("autostart",!0),t("precision",1),t("canvas2d",!1),t("platform",null),t("readPixelsBeforeDraw",!1),t("devicePixelRatio",1),t("readPixelsAfterDraw",!1),t("readPixelsAfterDrawThreshold",0),t("debugFrame",!1),t("forceTxCanvasSource",!1),t("pauseRafLoopOnIdle",!1),e.devicePixelRatio!=null&&e.devicePixelRatio!==1&&(this._options.precision*=e.devicePixelRatio,this._options.w*=e.devicePixelRatio,this._options.h*=e.devicePixelRatio)}setApplication(e){this.application=e}init(){this.application.getOption("debug")&&this.platform._imageWorker&&console.log("[Lightning] Using image worker!"),this.application.getOption("debug")&&this.c2d&&console.log("[Lightning] Using canvas2d renderer"),this.application.setAsRoot(),this.getOption("autostart")&&this.platform.startLoop()}destroy(){this.platform.stopLoop(),this.platform.destroy(),this.ctx.destroy(),this.textureManager.destroy(),this._renderer.destroy(),this.gl?(this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)):this.c2d&&this.c2d.clearRect(0,0,this.c2d.canvas.width,this.c2d.canvas.height),this.gl=null,this.c2d=null,this.ctx=null,this._options=null,this.platform=null,this.textureManager=null,this._renderer=null,delete this.gl,delete this.c2d,delete this.ctx,delete this._options,delete this.platform,delete this.textureManager,delete this._renderer}stop(){this.platform.stopLoop()}resume(){this.platform.startLoop()}get root(){return this.application}getCanvas(){return this._mode?this.c2d.canvas:this.gl.canvas}getRenderPrecision(){return this._options.precision}addUpdateSourceTexture(e){this._updatingFrame?e._performUpdateSource():this._updateSourceTextures.add(e)}removeUpdateSourceTexture(e){this._updateSourceTextures&&this._updateSourceTextures.delete(e)}hasUpdateSourceTexture(e){return this._updateSourceTextures&&this._updateSourceTextures.has(e)}_performUpdateSource(){this._updateSourceTextures.size&&(this._updateSourceTextures.forEach(e=>{e._performUpdateSource()}),this._updateSourceTextures=new Set)}_calculateDt(){this.startTime=this.currentTime,this.currentTime=this.platform.getHrTime(),this._options.fixedDt?this.dt=this._options.fixedDt:this.dt=this.startTime?.001*(this.currentTime-this.startTime):.02}updateFrame(){this._calculateDt(),this.emit("frameStart"),this._performUpdateSource(),this.emit("update")}idleFrame(){this.textureThrottler.processSome(),this.emit("frameEnd"),this.frameCounter++}onIdle(){this.emit("idle")}renderFrame(){const e=this.ctx.hasRenderUpdates();this.textureThrottler.processSome(),e&&(this._updatingFrame=!0,this.ctx.update(),this.ctx.render(),this._updatingFrame=!1),this.platform.nextFrame(e),this.emit("frameEnd"),this.frameCounter++}isUpdatingFrame(){return this._updatingFrame}drawFrame(){this.updateFrame(),this.renderFrame()}forceRenderUpdate(){this.root&&this.root.core._parent.setHasRenderUpdates(1)}setClearColor(e){this.forceRenderUpdate(),e===null?this._clearColor=null:Array.isArray(e)?this._clearColor=e:this._clearColor=ie.getRgbaComponentsNormalized(e)}getClearColor(){return this._clearColor}createElement(e){return e?this.element(e):new Ce(this)}createShader(e){return Gr.create(this,e)}element(e){if(e.isElement)return e;let t;return e.type?t=new e.type(this):t=new Ce(this),t.patch(e),t}c(e){return this.element(e)}get w(){return this._options.w}get h(){return this._options.h}get coordsWidth(){return this.w/this._options.precision}get coordsHeight(){return this.h/this._options.precision}addMemoryUsage(e){this._usedMemory+=e,e>0&&this._lastGcFrame!==this.frameCounter&&this._usedMemory>this.getOption("memoryPressure")&&(this.gc(!1),this._usedMemory>this.getOption("memoryPressure")-2e6&&this.gc(!0))}get usedMemory(){return this._usedMemory}addVramUsage(e,t){t?this._usedVramAlpha+=e:this._usedVramNonAlpha+=e}get usedVramAlpha(){return this._usedVramAlpha}get usedVramNonAlpha(){return this._usedVramNonAlpha}get usedVram(){return this._usedVramAlpha+this._usedVramNonAlpha}gc(e){if(this._lastGcFrame!==this.frameCounter){this._lastGcFrame=this.frameCounter;const t=this._usedMemory;if(this.gcTextureMemory(e),this.gcRenderTextureMemory(e),this.renderer.gc(e),this.application.getOption("debug")){console.log(`[Lightning] GC${e?"[aggressive]":""}! Frame ${this._lastGcFrame} Freed ${((t-this._usedMemory)/1e6).toFixed(2)}MP from GPU memory. Remaining: ${(this._usedMemory/1e6).toFixed(2)}MP`);const i=this._usedMemory-this.textureManager.usedMemory-this.ctx.usedMemory;console.log(`[Lightning] Textures: ${(this.textureManager.usedMemory/1e6).toFixed(2)}MP, Render Textures: ${(this.ctx.usedMemory/1e6).toFixed(2)}MP, Renderer caches: ${(i/1e6).toFixed(2)}MP`)}}}gcTextureMemory(e=!1){e&&this.ctx.root.visible?(this.ctx.root.visible=!1,this.textureManager.gc(),this.ctx.root.visible=!0):this.textureManager.gc()}gcRenderTextureMemory(e=!1){e&&this.root.visible?(this.root.visible=!1,this.ctx.freeUnusedRenderTextures(0),this.root.visible=!0):this.ctx.freeUnusedRenderTextures(0)}getDrawingCanvas(){return this.platform.getDrawingCanvas()}update(){this.ctx.update()}addServiceProvider(e){H.isSpark&&this.platform.addServiceProvider(e)}getChildrenByPosition(e,t){const i=[];return this.root.core.update(),this.root.core.collectAtCoord(e,t,i),i}}class Pi extends ke{constructor(e={},t){Pi._temp_options=e,Pi.booting=!0;const i=new hs(e.stage);super(i,t),Pi.booting=!1,this.__updateFocusCounter=0,this.__keypressTimers=new Map,this.__hoveredChild=null,this.stage.init(),this.updateFocusSettings(),this.__keymap=this.getOption("keys"),this.__keymap&&(this.stage.platform.registerKeydownHandler(s=>{this._receiveKeydown(s)}),this.stage.platform.registerKeyupHandler(s=>{this._receiveKeyup(s)})),this.getOption("enablePointer")&&(this.stage.platform.registerClickHandler(s=>{this._receiveClick(s)}),this.stage.platform.registerHoverHandler(s=>{this._receiveHover(s)}),this.stage.platform.registerScrollWheelHandler(s=>{this._recieveScrollWheel(s)}),this.cursor="default")}getOption(e){return this.__options[e]}_setOptions(e){this.__options={};let t=(i,s)=>{let r=e[i];r===void 0?this.__options[i]=s:this.__options[i]=r};t("debug",!1),t("keys",{38:"Up",40:"Down",37:"Left",39:"Right",13:"Enter",8:"Back",27:"Exit"}),t("enablePointer",!1)}__construct(){this.stage.setApplication(this),this._setOptions(Pi._temp_options),delete Pi._temp_options,super.__construct()}__init(){super.__init(),this.__updateFocus()}updateFocusPath(){this.__updateFocus()}__updateFocus(){const e=this.__updateFocusRec();!Pi.booting&&e&&this.updateFocusSettings()}__updateFocusRec(){const e=++this.__updateFocusCounter;this.__updateFocusId=e;const t=this.__getFocusPath(),i=t[t.length-1],s=this._focusPath?this._focusPath[this._focusPath.length-1]:void 0;if(s){let r=Math.min(this._focusPath.length,t.length),o;for(o=0;o<r&&this._focusPath[o]===t[o];o++);if(this._focusPath.length!==t.length||o!==t.length){this.getOption("debug")&&console.log("[Lightning] Focus changed: "+i.getLocationString());for(let a=this._focusPath.length-1;a>=o;a--)if(this._focusPath.pop()._unfocus(i,s),this.__updateFocusId!==e)return!1;for(let a=o,l=t.length;a<l;a++)if(this._focusPath.push(t[a]),this._focusPath[a]._focus(i,s),this.__updateFocusId!==e)return!1;for(let a=0;a<o;a++)this._focusPath[a]._focusChange(i,s)}}else{this._focusPath=[];for(let r=0,o=t.length;r<o;r++)if(this._focusPath.push(t[r]),this._focusPath[r]._focus(i,void 0),this.__updateFocusId!==e)return!1;return!0}return!0}updateFocusSettings(){const e=this._focusPath[this._focusPath.length-1],t={},i=ke.prototype._setFocusSettings;for(let r=0,o=this._focusPath.length;r<o;r++)this._focusPath[r]._setFocusSettings!==i&&this._focusPath[r]._setFocusSettings(t);const s=ke.prototype._handleFocusSettings;for(let r=0,o=this._focusPath.length;r<o;r++)this._focusPath[r]._handleFocusSettings!==s&&this._focusPath[r]._handleFocusSettings(t,this.__prevFocusSettings,e);this.__prevFocusSettings=t}_handleFocusSettings(e,t,i,s){}__getFocusPath(){const e=[this];let t=this;do{const i=t._getFocused();if(!i||i===t)break;let s=i.cparent;if(s===t)e.push(i);else{const r=[i];do s||t._throwError("Return value for _getFocused must be an attached descendant component but its '"+i.getLocationString()+"'"),r.push(s),s=s.cparent;while(s!==t);for(let o=0,a=r.length;o<a;o++)e.push(r[a-o-1])}t=i}while(!0);return e}get focusPath(){return this._focusPath}focusTopDownEvent(e,...t){const i=this.focusPath,s=i.length;for(let r=0;r<s;r++){const o=i[r]._getMostSpecificHandledMember(e);if(o!==void 0&&i[r][o](...t)!==!1)return!0}return!1}focusBottomUpEvent(e,...t){const i=this.focusPath,s=i.length;for(let r=s-1;r>=0;r--){const o=i[r]._getMostSpecificHandledMember(e);if(o!==void 0&&i[r][o](...t)!==!1)return!0}return!1}_receiveKeydown(e){const t=e,i=this.__keymap[e.keyCode],s=this.focusPath;let r;if(i&&(r=Array.isArray(i)?i:[i]),r)for(let a=0,l=r.length;a<l;a++){const h=this.__keypressTimers.has(r[a]);if(s[s.length-1].longpress&&h)return;this.stage.application.focusTopDownEvent([`_capture${r[a]}`,"_captureKey"],t)||this.stage.application.focusBottomUpEvent([`_handle${r[a]}`,"_handleKey"],t)}else this.stage.application.focusTopDownEvent(["_captureKey"],t)||this.stage.application.focusBottomUpEvent(["_handleKey"],t);this.updateFocusPath();const o=s[s.length-1];if(r&&o.longpress)for(let a=0,l=r.length;a<l;a++)this._startLongpressTimer(r[a],o)}_receiveKeyup(e){const t=e,i=this.__keymap[e.keyCode];let s;if(i&&(s=Array.isArray(i)?i:[i]),s)for(let r=0,o=s.length;r<o;r++)this.stage.application.focusTopDownEvent([`_capture${s[r]}Release`,"_captureKeyRelease"],t)||this.stage.application.focusBottomUpEvent([`_handle${s[r]}Release`,"_handleKeyRelease"],t);else this.stage.application.focusTopDownEvent(["_captureKeyRelease"],t)||this.stage.application.focusBottomUpEvent(["_handleKeyRelease"],t);if(this.updateFocusPath(),s)for(let r=0,o=s.length;r<o;r++)this.__keypressTimers.has(s[r])&&(clearTimeout(this.__keypressTimers.get(s[r])),this.__keypressTimers.delete(s[r]))}_startLongpressTimer(e,t){const i=t.longpress,s=e.toLowerCase();if(i[s]){const r=i[s];H.isNumber(r)?this.__keypressTimers.set(e,setTimeout(()=>{this.stage.application.focusTopDownEvent([`_capture${e}Long`,"_captureKey"],{})||this.stage.application.focusBottomUpEvent([`_handle${e}Long`,"_handleKey"],{}),this.__keypressTimers.delete(e)},r||500)):t._throwError("config value for longpress must be a number")}}_recieveScrollWheel(e){const t=e,{clientX:i,clientY:s}=t;i<=this.stage.w&&s<=this.stage.h&&(this.fireTopDownScrollWheelHandler("_captureScroll",t)||this.fireBottomUpScrollWheelHandler("_handleScroll",t))}fireTopDownScrollWheelHandler(e,t){let i=this.stage.application.children,s=this._findChildren([],i).reverse(),r=s.length;for(;r--;){const o=s[r];if(o&&o[e])return o._captureScroll(t),!0}return!1}fireBottomUpScrollWheelHandler(e,t){const{clientX:i,clientY:s}=t;let o=this._getTargetChild(i,s);for(;o!==null;){if(o&&o[e])return o._handleScroll(t),!0;o=o.parent}return!1}_receiveClick(e){const t=e,{clientX:i,clientY:s}=t;i<=this.stage.w&&s<=this.stage.h&&this.stage.application.fireBottomUpClickHandler(t)}fireBottomUpClickHandler(e){const{clientX:t,clientY:i}=e,s=this._getTargetChild(t,i),r=this.stage.getRenderPrecision()/this.stage.getOption("devicePixelRatio");let o=s;for(;o!==null;){if(o&&o._handleClick){const{px:a,py:l}=o.core._worldContext,h=a*r,c=l*r,u={x:t-h,y:i-c};if(o._handleClick(s,u)!==!1)break}o=o.parent}}_receiveHover(e){const t=e,{clientX:i,clientY:s}=t;i<=this.stage.w&&s<=this.stage.h&&this.stage.application.fireBottomUpHoverHandler(t)}fireBottomUpHoverHandler(e){const{clientX:t,clientY:i}=e,s=this._getTargetChild(t,i);if(s!==this.__hoveredChild){let r=new Set,o=new Set;if(s&&(o=new Set(s.getAncestors())),this.__hoveredChild){r=new Set(this.__hoveredChild.getAncestors());for(const h of[...r].filter(c=>!o.has(c))){const c=ke.getComponent(h);c._handleUnhover&&c._handleUnhover(h),h.parent&&h.parent.cursor&&(this.stage.getCanvas().style.cursor=h.parent.cursor)}}this.__hoveredChild=s;const a=[...o].filter(h=>!r.has(h));for(const h of a){const c=ke.getComponent(h);c._handleHover&&c._handleHover(h)}const l=a[0];if(l&&l.cursor&&(this.stage.getCanvas().style.cursor=l.cursor),a.length===0&&s){const h=ke.getComponent(s);h._handleHover&&h._handleHover(s)}}}_getTargetChild(e,t){let i=this.stage.application.children,s=this._findChildren([],i),r=this._withinClickableRange(s,e,t);return r.sort((o,a)=>o.zIndex>a.zIndex?1:o.zIndex<a.zIndex?-1:o.id>a.id?1:-1),r.length?r.slice(-1)[0]:null}_findChildren(e,t){let i=t.length;for(;i--;){const s=t[i];s.__active&&s.collision&&(s.collision===!0&&e.push(s),s.hasChildren()&&this._findChildren(e,s.children))}return e}_withinClickableRange(e,t,i){let s=e.length;const r=[];for(;s--;){const o=e[s],a=this.stage.getRenderPrecision()/this.stage.getOption("devicePixelRatio"),l=o.core._worldContext,h=l.px*a,c=l.py*a,u=o.finalW*l.ta*a,d=o.finalH*l.td*a;if(!(h>this.stage.w||c>this.stage.h)){if(o.parent.core._scissor){const f=o.parent.core._scissor.map(g=>g*a);if(!this._testCollision(t,i,...f))continue}this._testCollision(t,i,h,c,u,d)&&r.push(o)}}return r}_testCollision(e,t,i,s,r,o){return e>=i&&e<=i+r&&t>=s&&t<=s+o}destroy(){this._destroyed||(this._destroy(),this.stage.destroy(),this._destroyed=!0)}_destroy(){if(this.stage.setApplication(void 0),this._updateAttachedFlag(),this._updateEnabledFlag(),this.__keypressTimers.size){for(const e of this.__keypressTimers.values())clearTimeout(e);this.__keypressTimers.clear()}}getCanvas(){return this.stage.getCanvas()}}class Zd extends _t{constructor(e){super(e),this._factory=void 0,this._lookupId=void 0}set content({factory:e,lookupId:t=void 0}){this._factory=e,this._lookupId=t,this._changed()}_getIsValid(){return!!this._factory}_getLookupId(){return this._lookupId}_getSourceLoader(){const e=this._factory;return t=>e((i,s)=>{if(i)return t(i);t(null,this.stage.platform.getTextureOptionsForDrawingCanvas(s))},this.stage)}}class yr{static getCanvasTexture(e,t){return{type:Zd,content:{factory:e,lookupId:t}}}static getRoundRect(e,t,i,s,r,o,a){Array.isArray(i)||(i=[i,i,i,i]);let l=(c,u)=>{H.isSpark?u.platform.createRoundRect(c,u,e,t,i,s,r,o,a):c(null,this.createRoundRect(u,e,t,i,s,r,o,a))},h="rect"+[e,t,s,r,o?1:0,a].concat(i).join(",");return yr.getCanvasTexture(l,h)}static createRoundRect(e,t,i,s,r,o,a,l){a===void 0&&(a=!0),r===void 0&&(r=0);let h=e.platform.getDrawingCanvas(),c=h.getContext("2d");c.imageSmoothingEnabled=!0,h.width=t+r+2,h.height=i+r+2,c.beginPath();let u=.5*r+1,d=.5*r+1;return c.moveTo(u+s[0],d),c.lineTo(u+t-s[1],d),c.arcTo(u+t,d,u+t,d+s[1],s[1]),c.lineTo(u+t,d+i-s[2]),c.arcTo(u+t,d+i,u+t-s[2],d+i,s[2]),c.lineTo(u+s[3],d+i),c.arcTo(u,d+i,u,d+i-s[3],s[3]),c.lineTo(u,d+s[0]),c.arcTo(u,d,u+s[0],d,s[0]),c.closePath(),a&&(H.isNumber(l)?c.fillStyle=ie.getRgbaString(l):c.fillStyle="white",c.fill()),r&&(H.isNumber(o)?c.strokeStyle=ie.getRgbaString(o):c.strokeStyle="white",c.lineWidth=r,c.stroke()),h}static getShadowRect(e,t,i=0,s=5,r=s*2){Array.isArray(i)||(i=[i,i,i,i]);let o=(l,h)=>{H.isSpark?h.platform.createShadowRect(l,h,e,t,i,s,r):l(null,this.createShadowRect(h,e,t,i,s,r))},a="shadow"+[e,t,s,r].concat(i).join(",");return yr.getCanvasTexture(o,a)}static createShadowRect(e,t,i,s,r,o){let a=e.platform.getDrawingCanvas(),l=a.getContext("2d");l.imageSmoothingEnabled=!0,a.width=t+o*2,a.height=i+o*2,l.globalAlpha=.01,l.fillRect(0,0,.01,.01),l.globalAlpha=1,l.shadowColor=ie.getRgbaString(4294967295),l.fillStyle=ie.getRgbaString(4294967295),l.shadowBlur=r,l.shadowOffsetX=t+10+o,l.shadowOffsetY=o,l.beginPath();const h=-(t+10),c=0;return l.moveTo(h+s[0],c),l.lineTo(h+t-s[1],c),l.arcTo(h+t,c,h+t,c+s[1],s[1]),l.lineTo(h+t,c+i-s[2]),l.arcTo(h+t,c+i,h+t-s[2],c+i,s[2]),l.lineTo(h+s[3],c+i),l.arcTo(h,c+i,h,c+i-s[3],s[3]),l.lineTo(h,c+s[0]),l.arcTo(h,c,h+s[0],c,s[0]),l.closePath(),l.fill(),a}static getSvgTexture(e,t,i){let s=(o,a)=>{H.isSpark?a.platform.createSvg(o,a,e,t,i):this.createSvg(o,a,e,t,i)},r="svg"+[t,i,e].join(",");return yr.getCanvasTexture(s,r)}static createSvg(e,t,i,s,r){let o=t.platform.getDrawingCanvas(),a=o.getContext("2d");a.imageSmoothingEnabled=!0;let l=new Image;l.onload=()=>{o.width=s,o.height=r,a.drawImage(l,0,0,o.width,o.height),e(null,o)},l.onerror=h=>{e(h)},H.isPS4||(l.crossOrigin="Anonymous"),l.src=i}}class sh{static isMf(e){return H.isFunction(e)&&e.__mf}static mf(e){return e.__mf=!0,e}static merge(e,t){const i=Object.keys(e),s=Object.keys(t);if(!s.length)return e;const r={},o={};for(let c=0,u=s.length;c<u;c++){const d=s[c];r[d]=-1,o[d]=c}for(let c=0,u=i.length;c<u;c++){const d=i[c];r[d]=c,o[d]===void 0&&(o[d]=-1)}const a=i.length,l={};for(let c=0,u=s.length;c<u;c++){const d=s[c],f=r[d];let g=f;for(;--g>=0;){const T=i[g];if(o[T]!==-1)break}for(;++g<f;){const T=i[g];l[T]=e[T]}const p=t[d],m=e[d];let _;this.isMf(p)?_=p(m):!H.isObjectLiteral(m)||!H.isObjectLiteral(p)?_=p:_=sh.merge(m,p),_!==void 0&&(l[d]=_)}let h=a;for(;--h>=0;){const c=i[h];if(o[c]!==-1)break}for(;++h<a;){const c=i[h];l[c]=e[c]}return l}}class Jd extends Hd{constructor(e){super(),this._target=e}onAdd(e,t){this._target.addAt(e,t)}onRemove(e,t){this._target.removeAt(t)}onSync(e,t,i){this._target._setByArray(i)}onSet(e,t){this._target.setAt(e,t)}onMove(e,t,i){this._target.setAt(e,i)}createItem(e){return this._target.createItem(e)}isItem(e){return this._target.isItem(e)}}class ef extends Jd{constructor(e,t){super(e),this._wrap=t}wrap(e){let t=this._wrap(e);return e._wrapper=t,t}onAdd(e,t){e=this.wrap(e),super.onAdd(e,t)}onRemove(e,t){super.onRemove(e,t)}onSync(e,t,i){t.forEach(s=>this.wrap(s)),i=i.map(s=>s._wrapper),super.onSync(e,t,i)}onSet(e,t){e=this.wrap(e),super.onSet(e,t)}onMove(e,t,i){super.onMove(e,t,i)}}class tf extends _t{_getLookupId(){return"__noise"}_getSourceLoader(){const e=this.stage.gl;return function(t){const i=new Uint8Array(65536);for(let r=0;r<128*128*4;r+=4){const o=Math.floor(Math.random()*256);i[r]=o,i[r+1]=o,i[r+2]=o,i[r+3]=255}const s={};e&&(s[e.TEXTURE_WRAP_S]=e.REPEAT,s[e.TEXTURE_WRAP_T]=e.REPEAT,s[e.TEXTURE_MIN_FILTER]=e.NEAREST,s[e.TEXTURE_MAG_FILTER]=e.NEAREST),t(null,{source:i,w:128,h:128,texParams:s})}}}class rh extends _t{constructor(e){super(e),this._htmlElement=void 0,this._scale=1}set htmlElement(e){this._htmlElement=e,this._changed()}get htmlElement(){return this._htmlElement}set scale(e){this._scale=e,this._changed()}get scale(){return this._scale}set html(e){if(!e)this.htmlElement=void 0;else{const t=document.createElement("div");t.innerHTML="<div>"+e+"</div>",this.htmlElement=t.firstElementChild}}get html(){return this._htmlElement.innerHTML}_getIsValid(){return this.htmlElement}_getLookupId(){return this._scale+":"+this._htmlElement.innerHTML}_getSourceLoader(){const e=this._htmlElement,t=this._scale;return function(i){if(!window.html2canvas)return i(new Error("Please include html2canvas (https://html2canvas.hertzen.com/)"));const s=rh.getPreloadArea();s.appendChild(e),html2canvas(e,{backgroundColor:null,scale:t}).then(function(r){if(s.removeChild(e),r.height===0)return i(new Error("Canvas height is 0"));i(null,{source:r,width:r.width,height:r.height})}).catch(r=>{console.error("[Lightning]",r)})}}static getPreloadArea(){return this._preloadArea||(this._preloadArea=document.createElement("div"),this._preloadArea.attachShadow&&this._preloadArea.attachShadow({mode:"closed"}),this._preloadArea.style.opacity=0,this._preloadArea.style.pointerEvents="none",this._preloadArea.style.position="fixed",this._preloadArea.style.display="block",this._preloadArea.style.top="100vh",this._preloadArea.style.overflow="hidden",document.body.appendChild(this._preloadArea)),this._preloadArea}}class X_ extends _t{constructor(e,t){super(e),this._options=t}set options(e){this._options!==e&&(this._options=e,this._changed())}get options(){return this._options}_getIsValid(){return!!this._options}_getSourceLoader(){return e=>{e(null,this._options)}}}class j_ extends ke{constructor(e){super(e),this._wrapper=super._children.a({}),this._reloadVisibleElements=!1,this._visibleItems=new Set,this._index=0,this._started=!1,this._scrollTransitionSettings=this.stage.transitions.createSettings({}),this._itemSize=100,this._viewportScrollOffset=0,this._itemScrollOffset=0,this._roll=!1,this._rollMin=0,this._rollMax=0,this._progressAnimation=null,this._invertDirection=!1,this._horizontal=!0,this.itemList=new q_(this)}_allowChildrenAccess(){return!1}get items(){return this.itemList.get()}set items(e){this.itemList.patch(e)}start(){this._wrapper.transition(this.property,this._scrollTransitionSettings),this._scrollTransition=this._wrapper.transition(this.property),this._scrollTransition.on("progress",e=>this.update()),this.setIndex(0,!0,!0),this._started=!0,this.update()}setIndex(e,t=!1,i=!1){let s=this.length;if(!s)return;if(this.emit("unfocus",this.getElement(this.realIndex),this._index,this.realIndex),i){let a=H.getModuloIndex(e,s),l=H.getModuloIndex(this.index,s),h=a-l;h>.5*s?h-=s:h<-.5*s&&(h+=s),this._index+=h}else this._index=e;(this._roll||this.viewportSize>this._itemSize*s)&&(this._index=H.getModuloIndex(this._index,s));let r=this._horizontal^this._invertDirection?-1:1,o=r*this._index*this._itemSize;if(this._roll){let a,l,h;if(r==1)l=(s-1)*this._itemSize,h=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,l-=h,a=this.viewportSize-(this._itemSize+h),this._rollMin&&(a-=this._rollMin),this._rollMax&&(l+=this._rollMax),o=Math.max(Math.min(o,l),a);else{l=s*this._itemSize-this.viewportSize,h=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,l+=h;let c=h;this._rollMin&&(c-=this._rollMin),this._rollMax&&(l+=this._rollMax),o=Math.min(Math.max(-l,o),-c)}}this._scrollTransition.start(o),t&&this._scrollTransition.finish(),this.emit("focus",this.getElement(this.realIndex),this._index,this.realIndex)}getAxisPosition(){let e=-this._scrollTransition._targetValue,i=-(this._horizontal^this._invertDirection?-1:1)*this._index*this._itemSize;return this._viewportScrollOffset*this.viewportSize+(i-e)}update(){if(!this._started)return;let e=this.length;if(!e)return;let t=this._horizontal^this._invertDirection?-1:1,i=this._horizontal?this._wrapper.x:this._wrapper.y,s=this.viewportSize,r=this._viewportScrollOffset*s-this._itemScrollOffset*this._itemSize;i+=r;let o,a,l,h;t==-1?(o=Math.floor(-i/this._itemSize),l=1-(-i/this._itemSize-o),a=Math.floor((s-i)/this._itemSize),h=(s-i)/this._itemSize-a):(o=Math.ceil(i/this._itemSize),l=1+i/this._itemSize-o,a=Math.ceil((i-s)/this._itemSize),h=a-(i-s)/this._itemSize),(this._roll||s>this._itemSize*e)&&(a>=e&&(a=e-1,h=1),o>=e&&(o=e-1,l=1),a<=-1&&(a=0,h=1),o<=-1&&(o=0,l=1));let c=-t*o*this._itemSize,u;for(let f=o;t==-1?f<=a:f>=a;t==-1?f++:f--){let g=H.getModuloIndex(f,e),p=this.getElement(g);u=p.parent,this._visibleItems.delete(u),this._horizontal?u.x=c+r:u.y=c+r;let m=u.visible;if(u.visible=!0,(!m||this._reloadVisibleElements)&&this.emit("visible",f,g),this._progressAnimation){let _=1;f==o?_=l:f==a&&(_=h),this._progressAnimation.apply(p,_)}c+=this._itemSize}let d=this;this._visibleItems.forEach(function(f){f.visible=!1,d._visibleItems.delete(f)});for(let f=o;t==-1?f<=a:f>=a;t==-1?f++:f--){let g=H.getModuloIndex(f,e);this._visibleItems.add(this.getWrapper(g))}this._reloadVisibleElements=!1}setPrevious(){this.setIndex(this._index-1)}setNext(){this.setIndex(this._index+1)}getWrapper(e){return this._wrapper.children[e]}getElement(e){let t=this._wrapper.children[e];return t?t.children[0]:null}reload(){this._reloadVisibleElements=!0,this.update()}get element(){let e=this._wrapper.children[this.realIndex];return e?e.children[0]:null}get length(){return this._wrapper.children.length}get property(){return this._horizontal?"x":"y"}get viewportSize(){return this._horizontal?this.w:this.h}get index(){return this._index}get realIndex(){return H.getModuloIndex(this._index,this.length)}get itemSize(){return this._itemSize}set itemSize(e){this._itemSize=e,this.update()}get viewportScrollOffset(){return this._viewportScrollOffset}set viewportScrollOffset(e){this._viewportScrollOffset=e,this.update()}get itemScrollOffset(){return this._itemScrollOffset}set itemScrollOffset(e){this._itemScrollOffset=e,this.update()}get scrollTransitionSettings(){return this._scrollTransitionSettings}set scrollTransitionSettings(e){this._scrollTransitionSettings.patch(e)}set scrollTransition(e){this._scrollTransitionSettings.patch(e)}get scrollTransition(){return this._scrollTransition}get progressAnimation(){return this._progressAnimation}set progressAnimation(e){H.isObjectLiteral(e)?this._progressAnimation=this.stage.animations.createSettings(e):this._progressAnimation=e,this.update()}get roll(){return this._roll}set roll(e){this._roll=e,this.update()}get rollMin(){return this._rollMin}set rollMin(e){this._rollMin=e,this.update()}get rollMax(){return this._rollMax}set rollMax(e){this._rollMax=e,this.update()}get invertDirection(){return this._invertDirection}set invertDirection(e){this._started||(this._invertDirection=e)}get horizontal(){return this._horizontal}set horizontal(e){e!==this._horizontal&&(this._started||(this._horizontal=e))}}class q_ extends ef{constructor(e){let t=i=>{let s=i.stage.createElement();return s.add(i),s.visible=!1,s};super(e._wrapper._children,t),this.list=e}onAdd(e,t){super.onAdd(e,t),this.checkStarted(t)}checkStarted(e){this.list._reloadVisibleElements=!0,this.list._started?(this.list.length===1?this.list.setIndex(0,!0,!0):this.list._index>=this.list.length&&this.list.setIndex(0),this.list.update()):this.list.start()}onRemove(e,t){super.onRemove(e,t);let i=this.list.realIndex;i===t?(i===this.list.length&&i--,i>=0&&this.list.setIndex(i)):i>t&&this.list.setIndex(i-1),this.list._reloadVisibleElements=!0}onSet(e,t){super.onSet(e,t),this.checkStarted(t)}onSync(e,t,i){super.onSync(e,t,i),this.checkStarted(0)}get _signalProxy(){return!0}}class Qo extends be{constructor(e){super(e),this._direction=new Float32Array([1,0]),this._kernelRadius=1}get x(){return this._direction[0]}set x(e){this._direction[0]=e,this.redraw()}get y(){return this._direction[1]}set y(e){this._direction[1]=e,this.redraw()}get kernelRadius(){return this._kernelRadius}set kernelRadius(e){this._kernelRadius=e,this.redraw()}useDefault(){return this._kernelRadius===0}setupUniforms(e){super.setupUniforms(e),this._setUniform("direction",this._direction,this.gl.uniform2fv),this._setUniform("kernelRadius",this._kernelRadius,this.gl.uniform1i);const t=e.getRenderWidth(),i=e.getRenderHeight();this._setUniform("resolution",new Float32Array([t,i]),this.gl.uniform2fv)}}Qo.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    uniform vec2 resolution;
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform vec2 direction;
    uniform int kernelRadius;
    
    vec4 blur1(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {
        vec4 color = vec4(0.0);
        vec2 off1 = vec2(1.3333333333333333) * direction;
        color += texture2D(image, uv) * 0.29411764705882354;
        color += texture2D(image, uv + (off1 / resolution)) * 0.35294117647058826;
        color += texture2D(image, uv - (off1 / resolution)) * 0.35294117647058826;
        return color; 
    }
    
    vec4 blur2(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {
        vec4 color = vec4(0.0);
        vec2 off1 = vec2(1.3846153846) * direction;
        vec2 off2 = vec2(3.2307692308) * direction;
        color += texture2D(image, uv) * 0.2270270270;
        color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;
        color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;
        color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;
        color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;
        return color;
    }
    
    vec4 blur3(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {
        vec4 color = vec4(0.0);
        vec2 off1 = vec2(1.411764705882353) * direction;
        vec2 off2 = vec2(3.2941176470588234) * direction;
        vec2 off3 = vec2(5.176470588235294) * direction;
        color += texture2D(image, uv) * 0.1964825501511404;
        color += texture2D(image, uv + (off1 / resolution)) * 0.2969069646728344;
        color += texture2D(image, uv - (off1 / resolution)) * 0.2969069646728344;
        color += texture2D(image, uv + (off2 / resolution)) * 0.09447039785044732;
        color += texture2D(image, uv - (off2 / resolution)) * 0.09447039785044732;
        color += texture2D(image, uv + (off3 / resolution)) * 0.010381362401148057;
        color += texture2D(image, uv - (off3 / resolution)) * 0.010381362401148057;
        return color;
    }    

    void main(void){
        if (kernelRadius == 1) {
            gl_FragColor = blur1(uSampler, vTextureCoord, resolution, direction) * vColor;
        } else if (kernelRadius == 2) {
            gl_FragColor = blur2(uSampler, vTextureCoord, resolution, direction) * vColor;
        } else {
            gl_FragColor = blur3(uSampler, vTextureCoord, resolution, direction) * vColor;
        }
    }
`;class Pt extends be{setupUniforms(e){super.setupUniforms(e);const t=1/e.getTextureWidth(0),i=1/e.getTextureHeight(0);this._setUniform("stepTextureCoord",new Float32Array([t,i]),this.gl.uniform2fv)}}Pt.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    uniform vec2 stepTextureCoord;
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec4 vColor;
    varying vec2 vTextureCoordUl;
    varying vec2 vTextureCoordUr;
    varying vec2 vTextureCoordBl;
    varying vec2 vTextureCoordBr;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoordUl = aTextureCoord - stepTextureCoord;
        vTextureCoordBr = aTextureCoord + stepTextureCoord;
        vTextureCoordUr = vec2(vTextureCoordBr.x, vTextureCoordUl.y);
        vTextureCoordBl = vec2(vTextureCoordUl.x, vTextureCoordBr.y);
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;Pt.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoordUl;
    varying vec2 vTextureCoordUr;
    varying vec2 vTextureCoordBl;
    varying vec2 vTextureCoordBr;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    void main(void){
        vec4 color = 0.25 * (texture2D(uSampler, vTextureCoordUl) + texture2D(uSampler, vTextureCoordUr) + texture2D(uSampler, vTextureCoordBl) + texture2D(uSampler, vTextureCoordBr));
        gl_FragColor = color * vColor;
    }
`;class sf extends jo{constructor(e){super(e),this._kernelRadius=1}get kernelRadius(){return this._kernelRadius}set kernelRadius(e){this._kernelRadius=e,this.redraw()}useDefault(){return this._amount===0}_beforeDrawEl({target:e}){e.ctx.filter="blur("+this._kernelRadius+"px)"}_afterDrawEl({target:e}){e.ctx.filter="none"}}class Q_ extends ke{static _template(){return{}}get wrap(){return this.tag("Wrap")}set content(e){return this.wrap.content=e}get content(){return this.wrap.content}set padding(e){this.wrap._paddingX=e,this.wrap._paddingY=e,this.wrap._updateBlurSize()}set paddingX(e){this.wrap._paddingX=e,this.wrap._updateBlurSize()}set paddingY(e){this.wrap._paddingY=e,this.wrap._updateBlurSize()}set amount(e){return this.wrap.amount=e}get amount(){return this.wrap.amount}_onResize(){this.wrap.w=this.renderWidth,this.wrap.h=this.renderHeight}get _signalProxy(){return!0}_build(){this.patch({Wrap:{type:this.stage.gl?Z_:Eo}})}}class Eo extends ke{static _template(){return{forceZIndexContext:!0,rtt:!0,Textwrap:{shader:{type:sf},Content:{}}}}constructor(e){super(e),this._textwrap=this.sel("Textwrap"),this._wrapper=this.sel("Textwrap>Content"),this._amount=0,this._paddingX=0,this._paddingY=0}static getSpline(){return this._multiSpline||(this._multiSpline=new Me,this._multiSpline.parse(!1,{0:0,.25:1.5,.5:5.5,.75:18,1:39})),this._multiSpline}get content(){return this.sel("Textwrap>Content")}set content(e){this.sel("Textwrap>Content").patch(e,!0)}set padding(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}set paddingX(e){this._paddingX=e,this._updateBlurSize()}set paddingY(e){this._paddingY=e,this._updateBlurSize()}_updateBlurSize(){let e=this.renderWidth,t=this.renderHeight,i=this._paddingX,s=this._paddingY;this._wrapper.x=i,this._textwrap.x=-i,this._wrapper.y=s,this._textwrap.y=-s,this._textwrap.w=e+i*2,this._textwrap.h=t+s*2}get amount(){return this._amount}set amount(e){this._amount=e,this._textwrap.shader.kernelRadius=Eo._amountToKernelRadius(e)}static _amountToKernelRadius(e){return Eo.getSpline().getValue(Math.min(1,e*.25))}get _signalProxy(){return!0}}class Z_ extends ke{static _template(){const e=function(t,i){if(i._recalc&130){const s=i.w,r=i.h;let o=i;do o=o._children[0],o._element.w=s,o._element.h=r;while(o._children)}};return{Textwrap:{rtt:!0,forceZIndexContext:!0,renderOffscreen:!0,Content:{}},Layers:{L0:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Pt}}},L1:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Pt}}},L2:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Pt}}},L3:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Pt}}}},Result:{shader:{type:rf},visible:!1}}}get _signalProxy(){return!0}constructor(e){super(e),this._textwrap=this.sel("Textwrap"),this._wrapper=this.sel("Textwrap>Content"),this._layers=this.sel("Layers"),this._output=this.sel("Result"),this._amount=0,this._paddingX=0,this._paddingY=0}_buildLayers(){const t=[{x:1,y:0,kernelRadius:1},{x:0,y:1,kernelRadius:1},{x:1.5,y:0,kernelRadius:1},{x:0,y:1.5,kernelRadius:1}].map(i=>Gr.create(this.stage,Object.assign({type:Qo},i)));this._setLayerTexture(this.getLayerContents(0),this._textwrap.getTexture(),[]),this._setLayerTexture(this.getLayerContents(1),this.getLayer(0).getTexture(),[t[0],t[1]]),this._setLayerTexture(this.getLayerContents(2),this.getLayer(1).getTexture(),[t[0],t[1],t[2],t[3]]),this._setLayerTexture(this.getLayerContents(3),this.getLayer(2).getTexture(),[t[0],t[1],t[2],t[3]])}_setLayerTexture(e,t,i){if(!i.length)e.texture=t;else{const s=i.pop(),r=e.stage.c({rtt:!0,shader:s});this._setLayerTexture(r,t,i),e.childList.add(r)}return e}get content(){return this.sel("Textwrap>Content")}set content(e){this.sel("Textwrap>Content").patch(e,!0)}set padding(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}set paddingX(e){this._paddingX=e,this._updateBlurSize()}set paddingY(e){this._paddingY=e,this._updateBlurSize()}getLayer(e){return this._layers.sel("L"+e)}getLayerContents(e){return this.getLayer(e).sel("Content")}_onResize(){this._updateBlurSize()}_updateBlurSize(){let e=this.renderWidth,t=this.renderHeight,i=this._paddingX,s=this._paddingY,r=e+i*2,o=t+s*2;this._textwrap.w=r,this._wrapper.x=i,this.getLayer(0).w=this.getLayerContents(0).w=r/2,this.getLayer(1).w=this.getLayerContents(1).w=r/4,this.getLayer(2).w=this.getLayerContents(2).w=r/8,this.getLayer(3).w=this.getLayerContents(3).w=r/16,this._output.x=-i,this._textwrap.x=-i,this._output.w=r,this._textwrap.h=o,this._wrapper.y=s,this.getLayer(0).h=this.getLayerContents(0).h=o/2,this.getLayer(1).h=this.getLayerContents(1).h=o/4,this.getLayer(2).h=this.getLayerContents(2).h=o/8,this.getLayer(3).h=this.getLayerContents(3).h=o/16,this._output.y=-s,this._textwrap.y=-s,this._output.h=o,this.w=e,this.h=t}set amount(e){this._amount=e,this._update()}get amount(){return this._amount}_update(){let e=Math.min(4,Math.max(0,this._amount));e===0?(this._textwrap.renderToTexture=!1,this._output.shader.otherTextureSource=null,this._output.visible=!1):(this._textwrap.renderToTexture=!0,this._output.visible=!0,this.getLayer(0).visible=e>0,this.getLayer(1).visible=e>1,this.getLayer(2).visible=e>2,this.getLayer(3).visible=e>3,e<=1?(this._output.texture=this._textwrap.getTexture(),this._output.shader.otherTextureSource=this.getLayer(0).getTexture(),this._output.shader.a=e):e<=2?(this._output.texture=this.getLayer(0).getTexture(),this._output.shader.otherTextureSource=this.getLayer(1).getTexture(),this._output.shader.a=e-1):e<=3?(this._output.texture=this.getLayer(1).getTexture(),this._output.shader.otherTextureSource=this.getLayer(2).getTexture(),this._output.shader.a=e-2):e<=4&&(this._output.texture=this.getLayer(2).getTexture(),this._output.shader.otherTextureSource=this.getLayer(3).getTexture(),this._output.shader.a=e-3))}set shader(e){super.shader=e,this.renderToTexture||console.warn("[Lightning] Please enable renderToTexture to use with a shader.")}_firstActive(){this._buildLayers()}}class rf extends be{constructor(e){super(e),this._a=0,this._otherTextureSource=null}get a(){return this._a}set a(e){this._a=e,this.redraw()}set otherTextureSource(e){this._otherTextureSource=e,this.redraw()}setupUniforms(e){super.setupUniforms(e),this._setUniform("a",this._a,this.gl.uniform1f),this._setUniform("uSampler2",1,this.gl.uniform1i)}beforeDraw(e){let t=this._otherTextureSource?this._otherTextureSource.nativeTexture:null,i=this.gl;i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,t),i.activeTexture(i.TEXTURE0)}}rf.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform sampler2D uSampler2;
    uniform float a;
    void main(void){
        if (a == 1.0) {
            gl_FragColor = texture2D(uSampler2, vTextureCoord) * vColor;
        } else {
            gl_FragColor = ((1.0 - a) * texture2D(uSampler, vTextureCoord) + (a * texture2D(uSampler2, vTextureCoord))) * vColor;
        }
    }
`;class J_ extends ke{static _template(){const e=function(t,i){if(i._recalc&130){const s=i.w,r=i.h;let o=i;do o=o._children[0],o._element.w=s,o._element.h=r;while(o._children)}};return{Textwrap:{rtt:!0,forceZIndexContext:!0,renderOffscreen:!0,BloomBase:{shader:{type:nf},Content:{}}},Layers:{L0:{rtt:!0,onUpdate:e,scale:2,pivot:0,visible:!1,Content:{shader:{type:Pt}}},L1:{rtt:!0,onUpdate:e,scale:4,pivot:0,visible:!1,Content:{shader:{type:Pt}}},L2:{rtt:!0,onUpdate:e,scale:8,pivot:0,visible:!1,Content:{shader:{type:Pt}}},L3:{rtt:!0,onUpdate:e,scale:16,pivot:0,visible:!1,Content:{shader:{type:Pt}}}}}}get _signalProxy(){return!0}constructor(e){super(e),this._textwrap=this.sel("Textwrap"),this._wrapper=this.sel("Textwrap.Content"),this._layers=this.sel("Layers"),this._amount=0,this._paddingX=0,this._paddingY=0}_build(){const t=[{x:1,y:0,kernelRadius:3},{x:0,y:1,kernelRadius:3},{x:1.5,y:0,kernelRadius:3},{x:0,y:1.5,kernelRadius:3}].map(i=>this.stage.createShader(Object.assign({type:Qo},i)));this._setLayerTexture(this.getLayerContents(0),this._textwrap.getTexture(),[]),this._setLayerTexture(this.getLayerContents(1),this.getLayer(0).getTexture(),[t[0],t[1]]),this._setLayerTexture(this.getLayerContents(2),this.getLayer(1).getTexture(),[t[0],t[1],t[2],t[3]]),this._setLayerTexture(this.getLayerContents(3),this.getLayer(2).getTexture(),[t[0],t[1],t[2],t[3]])}_setLayerTexture(e,t,i){if(!i.length)e.texture=t;else{const s=i.pop(),r=e.stage.c({rtt:!0,shader:s});this._setLayerTexture(r,t,i),e.childList.add(r)}return e}get content(){return this.sel("Textwrap.Content")}set content(e){this.sel("Textwrap.Content").patch(e)}set padding(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}set paddingX(e){this._paddingX=e,this._updateBlurSize()}set paddingY(e){this._paddingY=e,this._updateBlurSize()}getLayer(e){return this._layers.sel("L"+e)}getLayerContents(e){return this.getLayer(e).sel("Content")}_onResize(){this._updateBlurSize()}_updateBlurSize(){let e=this.renderWidth,t=this.renderHeight,i=this._paddingX,s=this._paddingY,r=e+i*2,o=t+s*2;this._textwrap.w=r,this._wrapper.x=i,this.getLayer(0).w=this.getLayerContents(0).w=r/2,this.getLayer(1).w=this.getLayerContents(1).w=r/4,this.getLayer(2).w=this.getLayerContents(2).w=r/8,this.getLayer(3).w=this.getLayerContents(3).w=r/16,this._textwrap.x=-i,this._textwrap.h=o,this._wrapper.y=s,this.getLayer(0).h=this.getLayerContents(0).h=o/2,this.getLayer(1).h=this.getLayerContents(1).h=o/4,this.getLayer(2).h=this.getLayerContents(2).h=o/8,this.getLayer(3).h=this.getLayerContents(3).h=o/16,this._textwrap.y=-s,this.w=e,this.h=t}set amount(e){this._amount=e,this._update()}get amount(){return this._amount}_update(){let e=Math.min(4,Math.max(0,this._amount));e>0&&(this.getLayer(0).visible=e>0,this.getLayer(1).visible=e>1,this.getLayer(2).visible=e>2,this.getLayer(3).visible=e>3)}set shader(e){super.shader=e,this.renderToTexture||console.warn("[Lightning] Please enable renderToTexture to use with a shader.")}_firstActive(){this._build()}}class nf extends be{}nf.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    void main(void){
        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;
        float m = max(max(color.r, color.g), color.b);
        float c = max(0.0, (m - 0.80)) * 5.0;
        color = color * c;
        gl_FragColor = color;
    }
`;class bo extends ke{static _template(){return{ContentWrap:{renderOffscreen:!0,forceZIndexContext:!0,onAfterUpdate:bo._updateDimensions,Content:{}},Scale:{visible:!1}}}constructor(e){super(e),this._smoothScale=1,this._iterations=0}get content(){return this.tag("Content")}set content(e){this.tag("Content").patch(e,!0)}get smoothScale(){return this._smoothScale}set smoothScale(e){if(this._smoothScale!==e){let t=0;for(;e<.5&&t<12;)t++,e=e*2;this.scale=e,this._setIterations(t),this._smoothScale=e}}_setIterations(e){if(this._iterations!==e){const t=this.sel("Scale").childList,i=this.sel("ContentWrap");for(;t.length<e;){const o=t.length===0?i.getTexture():t.last.getTexture();t.a({rtt:!0,renderOffscreen:!0,texture:o})}bo._updateDimensions(this.tag("ContentWrap"),!0);const s=e>0;this.patch({ContentWrap:{renderToTexture:s},Scale:{visible:s}});for(let r=0,o=t.length;r<o;r++)t.getAt(r).patch({visible:r<e,renderOffscreen:r!==e-1});this._iterations=e}}static _updateDimensions(e,t){const i=e.children[0];let s=i.renderWidth,r=i.renderHeight;if(s!==e.w||r!==e.h||t){e.w=s,e.h=r;const o=e.parent.tag("Scale").children;for(let a=0,l=o.length;a<l;a++)s=s*.5,r=r*.5,o[a].w=s,o[a].h=r}}get _signalProxy(){return!0}}class ex extends ke{static _template(){return{Content:{},Borders:{Top:{rect:!0,visible:!1,mountY:1},Right:{rect:!0,visible:!1},Bottom:{rect:!0,visible:!1},Left:{rect:!0,visible:!1,mountX:1}}}}get _signalProxy(){return!0}constructor(e){super(e),this._borderTop=this.tag("Top"),this._borderRight=this.tag("Right"),this._borderBottom=this.tag("Bottom"),this._borderLeft=this.tag("Left"),this.onAfterUpdate=function(t){const i=t.childList.first;let s=t.core.w||i.renderWidth,r=t.core.h||i.renderHeight;t._borderTop.w=s,t._borderBottom.y=r,t._borderBottom.w=s,t._borderLeft.h=r+t._borderTop.h+t._borderBottom.h,t._borderLeft.y=-t._borderTop.h,t._borderRight.x=s,t._borderRight.h=r+t._borderTop.h+t._borderBottom.h,t._borderRight.y=-t._borderTop.h},this.borderWidth=1}get content(){return this.sel("Content")}set content(e){this.sel("Content").patch(e,!0)}get borderWidth(){return this.borderWidthTop}get borderWidthTop(){return this._borderTop.h}get borderWidthRight(){return this._borderRight.w}get borderWidthBottom(){return this._borderBottom.h}get borderWidthLeft(){return this._borderLeft.w}set borderWidth(e){this.borderWidthTop=e,this.borderWidthRight=e,this.borderWidthBottom=e,this.borderWidthLeft=e}set borderWidthTop(e){this._borderTop.h=e,this._borderTop.visible=e>0}set borderWidthRight(e){this._borderRight.w=e,this._borderRight.visible=e>0}set borderWidthBottom(e){this._borderBottom.h=e,this._borderBottom.visible=e>0}set borderWidthLeft(e){this._borderLeft.w=e,this._borderLeft.visible=e>0}get colorBorder(){return this.colorBorderTop}get colorBorderTop(){return this._borderTop.color}get colorBorderRight(){return this._borderRight.color}get colorBorderBottom(){return this._borderBottom.color}get colorBorderLeft(){return this._borderLeft.color}set colorBorder(e){this.colorBorderTop=e,this.colorBorderRight=e,this.colorBorderBottom=e,this.colorBorderLeft=e}set colorBorderTop(e){this._borderTop.color=e}set colorBorderRight(e){this._borderRight.color=e}set colorBorderBottom(e){this._borderBottom.color=e}set colorBorderLeft(e){this._borderLeft.color=e}get borderTop(){return this._borderTop}set borderTop(e){this.borderTop.patch(e)}get borderRight(){return this._borderRight}set borderRight(e){this.borderRight.patch(e)}get borderBottom(){return this._borderBottom}set borderBottom(e){this.borderBottom.patch(e)}get borderLeft(){return this._borderLeft}set borderLeft(e){this.borderLeft.patch(e)}set borders(e){this.borderTop=e,this.borderLeft=e,this.borderBottom=e,this.borderRight=e}}class nh extends be{constructor(e){super(e),this._amount=1}static getC2d(){return of}set amount(e){this._amount=e,this.redraw()}get amount(){return this._amount}useDefault(){return this._amount===0}setupUniforms(e){super.setupUniforms(e),this._setUniform("amount",this._amount,this.gl.uniform1f)}}nh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform float amount;
    void main(void){
        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;
        float grayness = 0.2 * color.r + 0.6 * color.g + 0.2 * color.b;
        gl_FragColor = vec4(amount * vec3(grayness, grayness, grayness) + (1.0 - amount) * color.rgb, color.a);
    }
`;class of extends jo{constructor(e){super(e),this._amount=1}static getWebGL(){return nh}set amount(e){this._amount=e,this.redraw()}get amount(){return this._amount}useDefault(){return this._amount===0}_beforeDrawEl({target:e}){e.ctx.filter="grayscale("+this._amount+")"}_afterDrawEl({target:e}){e.ctx.filter="none"}}class oh extends be{constructor(e){super(e),this._noiseTexture=new tf(e.stage),this._graining=1/256,this._random=!1}set graining(e){this._graining=e,this.redraw()}set random(e){this._random=e,this.redraw()}setExtraAttribsInBuffer(e){this._noiseTexture.load();let t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,s=e.length;for(let r=0;r<s;r++){let o=e.getElementWidth(r)/this._noiseTexture.getRenderWidth(),a=e.getElementHeight(r)/this._noiseTexture.getRenderHeight(),l=0,h=0;if(this._random){if(l=Math.random(),h=Math.random(),o+=l,a+=h,Math.random()<.5){const c=l;l=o,o=c}if(Math.random()<.5){const c=h;h=a,a=c}}i[t]=l,i[t+1]=h,i[t+2]=o,i[t+3]=h,i[t+4]=o,i[t+5]=a,i[t+6]=l,i[t+7]=a,t+=8}}beforeDraw(e){let t=this.gl;t.vertexAttribPointer(this._attrib("aNoiseTextureCoord"),2,t.FLOAT,!1,8,this.getVertexAttribPointerOffset(e));let i=this._noiseTexture.source.nativeTexture;t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,i),t.activeTexture(t.TEXTURE0)}getExtraAttribBytesPerVertex(){return 8}setupUniforms(e){super.setupUniforms(e),this._setUniform("uNoiseSampler",1,this.gl.uniform1i),this._setUniform("graining",2*this._graining,this.gl.uniform1f)}enableAttribs(){super.enableAttribs(),this.gl.enableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}disableAttribs(){super.disableAttribs(),this.gl.disableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}useDefault(){return this._graining===0}afterDraw(e){this._random&&this.redraw()}}oh.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec2 aNoiseTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec2 vNoiseTextureCoord;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vNoiseTextureCoord = aNoiseTextureCoord;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;oh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec2 vNoiseTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform sampler2D uNoiseSampler;
    uniform float graining;
    void main(void){
        vec4 noise = texture2D(uNoiseSampler, vNoiseTextureCoord);
        vec4 color = texture2D(uSampler, vTextureCoord);
        gl_FragColor = (color * vColor) + graining * (noise.r - 0.5);
    }
`;class ah extends be{constructor(e){super(e),this._inputValue=0,this._maxDerivative=.01,this._normalizedValue=0,this._offset=0,this._amount=.1,this._aspectRatio=1,this._offsetX=0,this._offsetY=0,this.buckets=100}get aspectRatio(){return this._aspectRatio}set aspectRatio(e){this._aspectRatio=e,this.redraw()}get offsetX(){return this._offsetX}set offsetX(e){this._offsetX=e,this.redraw()}get offsetY(){return this._offsetY}set offsetY(e){this._offsetY=e,this.redraw()}set amount(e){this._amount=e,this.redraw()}get amount(){return this._amount}set inputValue(e){this._inputValue=e}get inputValue(){return this._inputValue}set maxDerivative(e){this._maxDerivative=e}get maxDerivative(){return this._maxDerivative}set buckets(e){e>100&&(console.warn("[Lightning] CircularPushShader: supports max 100 buckets"),e=100),this._buckets=e,this._values=new Uint8Array(this._getValues(e)),this.redraw()}get buckets(){return this._buckets}_getValues(e){const t=[];for(let i=0;i<e;i++)t.push(this._inputValue);return t}progress(e){this._offset+=e*this._buckets;const t=Math.floor(this._offset);this._offset-=t,this._shiftBuckets(t),this.redraw()}_shiftBuckets(e){for(let t=this._buckets-1;t>=0;t--){const i=t-e;i<0?(this._normalizedValue=Math.min(this._normalizedValue+this._maxDerivative,Math.max(this._normalizedValue-this._maxDerivative,this._inputValue)),this._values[t]=255*this._normalizedValue):this._values[t]=this._values[i]}}set offset(e){this._offset=e,this.redraw()}setupUniforms(e){super.setupUniforms(e),this._setUniform("aspectRatio",this._aspectRatio,this.gl.uniform1f),this._setUniform("offsetX",this._offsetX,this.gl.uniform1f),this._setUniform("offsetY",this._offsetY,this.gl.uniform1f),this._setUniform("amount",this._amount,this.gl.uniform1f),this._setUniform("offset",this._offset,this.gl.uniform1f),this._setUniform("buckets",this._buckets,this.gl.uniform1f),this._setUniform("uValueSampler",1,this.gl.uniform1i)}useDefault(){return this._amount===0}beforeDraw(e){const t=this.gl;t.activeTexture(t.TEXTURE1),this._valuesTexture?t.bindTexture(t.TEXTURE_2D,this._valuesTexture):(this._valuesTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._valuesTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),H.isNode&&t.pixelStorei(t.UNPACK_FLIP_BLUE_RED,!1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)),t.texImage2D(t.TEXTURE_2D,0,t.ALPHA,this._buckets,1,0,t.ALPHA,t.UNSIGNED_BYTE,this._values),t.activeTexture(t.TEXTURE0)}cleanup(){this._valuesTexture&&this.gl.deleteTexture(this._valuesTexture)}}ah.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    uniform float offsetX;
    uniform float offsetY;
    uniform float aspectRatio;
    varying vec2 vTextureCoord;
    varying vec2 vPos;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vPos = vTextureCoord * 2.0 - 1.0;
        vPos.y = vPos.y * aspectRatio;
        vPos.y = vPos.y + offsetY;
        vPos.x = vPos.x + offsetX;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;ah.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    varying vec2 vPos;
    uniform float amount;
    uniform float offset;
    uniform float values[100];
    uniform float buckets;
    uniform sampler2D uSampler;
    uniform sampler2D uValueSampler;
    void main(void){
        float l = length(vPos);
        float m = (l * buckets * 0.678 - offset) / buckets;
        float f = texture2D(uValueSampler, vec2(m, 0.0)).a * amount;
        vec2 unit = vPos / l;
        gl_FragColor = texture2D(uSampler, vTextureCoord - f * unit) * vColor;
    }
`;class af extends be{constructor(e){super(e),this._amount=1}set amount(e){this._amount=e,this.redraw()}get amount(){return this._amount}useDefault(){return this._amount===0}setupUniforms(e){super.setupUniforms(e),this._setUniform("amount",this._amount,this.gl.uniform1f)}}af.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform float amount;
    void main(void){
        vec4 color = texture2D(uSampler, vTextureCoord);
        color.rgb = color.rgb * (1.0 - amount) + amount * (1.0 * color.a - color.rgb); 
        gl_FragColor = color * vColor;
    }
`;class lh extends be{constructor(e){super(e),this._width=5,this._col=4294967295,this._color=[1,1,1,1]}set width(e){this._width=e,this.redraw()}get color(){return this._col}set color(e){if(this._col!==e){const t=ie.getRgbaComponentsNormalized(e);t[0]=t[0]*t[3],t[1]=t[1]*t[3],t[2]=t[2]*t[3],this._color=t,this.redraw(),this._col=e}}useDefault(){return this._width===0||this._col[3]===0}setupUniforms(e){super.setupUniforms(e);let t=this.gl;this._setUniform("color",new Float32Array(this._color),t.uniform4fv)}enableAttribs(){super.enableAttribs(),this.gl.enableVertexAttribArray(this._attrib("aCorner"))}disableAttribs(){super.disableAttribs(),this.gl.disableVertexAttribArray(this._attrib("aCorner"))}setExtraAttribsInBuffer(e){let t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,s=e.length;for(let r=0;r<s;r++){const o=e.getElementCore(r),a=this._width/o.w,l=a/(1-2*a),h=this._width/o.h,c=h/(1-2*h);i[t]=-l,i[t+1]=-c,i[t+2]=1+l,i[t+3]=-c,i[t+4]=1+l,i[t+5]=1+c,i[t+6]=-l,i[t+7]=1+c,t+=8}}beforeDraw(e){let t=this.gl;t.vertexAttribPointer(this._attrib("aCorner"),2,t.FLOAT,!1,8,this.getVertexAttribPointerOffset(e))}getExtraAttribBytesPerVertex(){return 8}}lh.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    attribute vec2 aCorner;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec2 vCorner;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vCorner = aCorner;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;lh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    varying vec2 vCorner;
    uniform vec4 color;
    uniform sampler2D uSampler;
    void main(void){
        vec2 m = min(vCorner, 1.0 - vCorner);
        float value = step(0.0, min(m.x, m.y));
        gl_FragColor = mix(color, texture2D(uSampler, vTextureCoord) * vColor, value);
    }
`;class hh extends be{constructor(e){super(e),this._size=new Float32Array([4,4])}get x(){return this._size[0]}set x(e){this._size[0]=e,this.redraw()}get y(){return this._size[1]}set y(e){this._size[1]=e,this.redraw()}get size(){return this._size[0]}set size(e){this._size[0]=e,this._size[1]=e,this.redraw()}useDefault(){return this._size[0]===0&&this._size[1]===0}static getWebGLImpl(){return WebGLPixelateShaderImpl}setupUniforms(e){super.setupUniforms(e);let t=this.gl;this._setUniform("size",new Float32Array(this._size),t.uniform2fv)}getExtraAttribBytesPerVertex(){return 8}enableAttribs(){super.enableAttribs(),this.gl.enableVertexAttribArray(this._attrib("aTextureRes"))}disableAttribs(){super.disableAttribs(),this.gl.disableVertexAttribArray(this._attrib("aTextureRes"))}setExtraAttribsInBuffer(e){let t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,s=e.length;for(let r=0;r<s;r++){let o=e.quads.getTextureWidth(e.index+r),a=e.quads.getTextureHeight(e.index+r);i[t]=o,i[t+1]=a,i[t+2]=o,i[t+3]=a,i[t+4]=o,i[t+5]=a,i[t+6]=o,i[t+7]=a,t+=8}}beforeDraw(e){let t=this.gl;t.vertexAttribPointer(this._attrib("aTextureRes"),2,t.FLOAT,!1,this.getExtraAttribBytesPerVertex(),this.getVertexAttribPointerOffset(e))}}hh.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    attribute vec2 aTextureRes;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    varying vec2 vTextureRes;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vColor = aColor;
        vTextureRes = aTextureRes;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;hh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    varying vec2 vTextureRes;

    uniform vec2 size;
    uniform sampler2D uSampler;
    
    vec2 mapCoord( vec2 coord )
    {
        coord *= vTextureRes.xy;
        return coord;
    }
    
    vec2 unmapCoord( vec2 coord )
    {
        coord /= vTextureRes.xy;
        return coord;
    }
    
    vec2 pixelate(vec2 coord, vec2 size)
    {
        return floor( coord / size ) * size;
    }
    
    void main(void)
    {
        vec2 coord = mapCoord(vTextureCoord);
        coord = pixelate(coord, size);
        coord = unmapCoord(coord);
        gl_FragColor = texture2D(uSampler, coord) * vColor;
    }
`;class ch extends be{constructor(e){super(e),this._radius=0,this._cutoff=1}set radius(e){this._radius=e,this.redraw()}get radius(){return this._radius}set cutoff(e){this._cutoff=e,this.redraw()}get cutoff(){return this._cutoff}useDefault(){return this._radius===0}setupUniforms(e){super.setupUniforms(e),this._setUniform("radius",2*(this._radius-.5)/e.getRenderWidth(),this.gl.uniform1f),this._setUniform("cutoff",.5*e.getRenderWidth()/this._cutoff,this.gl.uniform1f)}}ch.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 pos;
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
        pos = gl_Position.xy;
    }
`;ch.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec2 pos;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform float radius;
    uniform float cutoff;
    void main(void){
        vec4 color = texture2D(uSampler, vTextureCoord);
        float f = max(0.0, min(1.0, 1.0 - (length(pos) - radius) * cutoff));
        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor * f;
    }
`;class uh extends be{constructor(e){super(e),this._blend=0,this._radius=[1,1,1,1],this._stroke=0,this._fc=16777215,this._fillColor=this._getNormalizedColor(4294967295),this._strokeColor=this._getNormalizedColor(16777215)}set blend(e){this._blend=Math.min(Math.max(e,0),1)}get blend(){return this._blend}set radius(e){Array.isArray(e)?e.length===2?this._radius=[e[0],e[1],e[0],e[1]]:e.length===3?this._radius=[e[0],e[1],e[2],this._radius[3]]:e.length===4?this._radius=e:this._radius=[e[0],e[0],e[0],e[0]]:this._radius=[e,e,e,e],this.redraw()}get radius(){return this._radius}set topLeft(e){this._radius[0]=e,this.redraw()}get topLeft(){return this._radius[0]}set topRight(e){this._radius[1]=e,this.redraw()}get topRight(){return this._radius[1]}set bottomRight(e){this._radius[2]=e,this.redraw()}get bottomRight(){return this._radius[2]}set bottomLeft(e){this._radius[3]=e,this.redraw()}get bottomLeft(){return this._radius[3]}set strokeColor(e){this._sc=e,this._strokeColor=this._getNormalizedColor(e),this.redraw()}get strokeColor(){return this._sc}set fillColor(e){this._fc=e,this._fillColor=this._getNormalizedColor(e),this.redraw()}get fillColor(){return this._fc}set stroke(e){this._stroke=e,this.redraw()}get stroke(){return this._stroke}_getNormalizedColor(e){const t=ie.getRgbaComponentsNormalized(e);return t[0]*=t[3],t[1]*=t[3],t[2]*=t[3],new Float32Array(t)}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=this.ctx.stage.getRenderPrecision(),s=this._radius.map(r=>(r+.5)*i);this._setUniform("radius",new Float32Array(s),this.gl.uniform4fv),this._setUniform("alpha",e.getElementCore(0).renderContext.alpha,this.gl.uniform1f),this._setUniform("blend",this._blend,this.gl.uniform1f),this._setUniform("strokeColor",this._strokeColor,this.gl.uniform4fv),this._setUniform("fillColor",this._fillColor,this.gl.uniform4fv),this._setUniform("stroke",this._stroke*i,this.gl.uniform1f),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv)}}uh.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;

    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;

    void main(void){
        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
        vColor = aColor;
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;uh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif

    #define PI 3.14159265359

    varying vec2 vTextureCoord;
    varying vec4 vColor;

    uniform sampler2D uSampler;
    uniform vec2 resolution;
    uniform vec4 radius;
    uniform float stroke;
    uniform vec4 strokeColor;
    uniform vec4 fillColor;
    uniform float alpha;
    uniform float fill;
    uniform float blend;
    
    float boxDist(vec2 p, vec2 size, float radius){
        size -= vec2(radius);
        vec2 d = abs(p) - size;
        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;
    }
    
    float fillMask(float dist){
        return clamp(-dist, 0.0, 1.0);
    }
    
    float innerBorderMask(float dist, float width){
        float alpha1 = clamp(dist + width, 0.0, 1.0);
        float alpha2 = clamp(dist, 0.0, 1.0);
        return alpha1 - alpha2;
    }

    void main() {
        vec2 halfRes = 0.5 * resolution.xy;
        float r = 0.0;
        if (vTextureCoord.x < 0.5 && vTextureCoord.y < 0.5) {
            r = radius[0];
        } else if (vTextureCoord.x >= 0.5 && vTextureCoord.y < 0.5) {
            r = radius[1];
        } else if (vTextureCoord.x >= 0.5 && vTextureCoord.y >= 0.5) {
            r = radius[2];
        } else {
            r = radius[3];
        }
        
        float b = boxDist(vTextureCoord.xy * resolution - halfRes, halfRes - 0.005, r);
        vec4 tex = texture2D(uSampler, vTextureCoord) * vColor;
        vec4 blend = mix(vec4(1.0) * alpha, tex, blend);     
        vec4 layer1 = mix(vec4(0.0), tex * fillColor, fillMask(b));
        gl_FragColor = mix(layer1, blend * strokeColor, innerBorderMask(b + 1.0, stroke));
    }
`;class lf extends be{constructor(e){super(e),this._fade=[0,0,0,0]}set top(e){this._fade[0]=e,this.redraw()}get top(){return this._fade[0]}set right(e){this._fade[1]=e,this.redraw()}get right(){return this._fade[1]}set bottom(e){this._fade[2]=e,this.redraw()}get bottom(){return this._fade[2]}set left(e){this._fade[3]=e,this.redraw()}get left(){return this._fade[3]}set fade(e){Array.isArray(e)?e.length===2?this._fade=[e[0],e[1],e[0],e[1]]:e.length===3?this._fade=[e[0],e[1],e[2],this._fade[3]]:e.length===4?this._fade=e:this._fade=[e[0],e[0],e[0],e[0]]:this._fade=[e,e,e,e],this.redraw()}get fade(){return this._fade}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=this.ctx.stage.getRenderPrecision(),s=this._fade.map(r=>r*i);this._setUniform("fade",new Float32Array(s),this.gl.uniform4fv),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv)}}lf.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform vec2 resolution;
    uniform vec4 fade;
    
    void main() {
        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;
        vec2 halfRes = 0.5 * resolution.xy;
        vec2 point = vTextureCoord.xy * resolution.xy;
        
        vec2 pos1;
        vec2 pos2;
        vec2 d;
        float c;
        float t = 0.0;
             
        if(fade[0] > 0.0) {
            pos1 = vec2(point.x, point.y);
            pos2 = vec2(point.x, point.y + fade[0]);
            d = pos2 - pos1;
            c = dot(pos1, d) / dot(d, d);
            t = smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0));
            color = mix(vec4(0.0), color, t);
        }
        
        if(fade[1] > 0.0) {
            vec2 pos1 = vec2(point.x - resolution.x - fade[1], vTextureCoord.y);
            vec2 pos2 = vec2(point.x - resolution.x, vTextureCoord.y);
            d = pos1 - pos2;
            c = dot(pos2, d) / dot(d, d);
            t = smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0));
            color = mix(vec4(0.0), color, t);
        }
        
        if(fade[2] > 0.0) {
            vec2 pos1 = vec2(vTextureCoord.x, point.y - resolution.y - fade[2]);
            vec2 pos2 = vec2(vTextureCoord.x, point.y - resolution.y);
            d = pos1 - pos2;
            c = dot(pos2, d) / dot(d, d);
            t = smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0));
            color = mix(vec4(0.0), color, t);
        }
        
        if(fade[3] > 0.0) {
            pos1 = vec2(point.x, point.y);
            pos2 = vec2(point.x + fade[3], point.y);
            d = pos2 - pos1;
            c = dot(pos1, d) / dot(d, d);
            t = smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0));
            color = mix(vec4(0.0), color, t);
        }
        
        gl_FragColor = color;
    }
`;class dh extends be{constructor(e){super(e),this._magnitude=1.3,this._intensity=.7,this._pivot=[.5,.5]}setupUniforms(e){super.setupUniforms(e),this._setUniform("magnitude",this._magnitude,this.gl.uniform1f),this._setUniform("intensity",this._intensity,this.gl.uniform1f),this._setUniform("pivot",new Float32Array(this._pivot),this.gl.uniform2fv),this.redraw()}set pivot(e){Array.isArray(e)?this._pivot=e:this._pivot=[e,e],this.redraw()}get pivotX(){return this._pivot[0]}set pivotX(e){this._pivot[0]=e,this.redraw()}get pivotY(){return this._pivot[1]}set pivotY(e){this._pivot[1]=e,this.redraw()}get intensity(){return this._intensity}set intensity(e){this._intensity=e,this.redraw()}get magnitude(){return this._magnitude}set magnitude(e){this._magnitude=e,this.redraw()}}dh.vertexShaderSource=be.vertexShaderSource;dh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;

    uniform float magnitude;
    uniform float intensity;
    uniform vec2 pivot;

    void main() {
        vec2 uv = vTextureCoord.xy - pivot + vec2(0.5);
        uv.x = clamp(uv.x, 0.0, 1.0);
        uv.y = clamp(uv.y, 0.0, 1.0);
   
        uv *=  1.00 - uv.yx;
        float vig = uv.x * uv.y * 25.0 * intensity;
        vig = pow(vig, 0.45 * magnitude);
        vec4 fragColor = vec4(vig) * vColor;
        gl_FragColor = texture2D(uSampler, vTextureCoord) * fragColor;

    }
`;class fh extends be{constructor(e){super(e),this._radius=100,this._width=50,this._period=1,this._angle=.5,this._smooth=.005,this._color=4294967295,this._backgroundColor=4278190080,this._time=Date.now()}set radius(e){this._radius=e,this.redraw()}set width(e){this._width=e,this.redraw()}set period(e){this._period=e,this.redraw()}set angle(e){this._angle=e,this.redraw()}set smooth(e){this._smooth=e,this.redraw()}set color(e){this._color=e,this.redraw()}set backgroundColor(e){this._backgroundColor=e,this.redraw()}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner;this._setUniform("iTime",Date.now()-this._time,this.gl.uniform1f);const i=this.ctx.stage.getRenderPrecision();this._setUniform("radius",this._radius*i,this.gl.uniform1f),this._setUniform("width",this._width*i,this.gl.uniform1f),this._setUniform("period",this._period,this.gl.uniform1f),this._setUniform("angle",this._angle,this.gl.uniform1f),this._setUniform("smooth",this._smooth,this.gl.uniform1f),this._setUniform("color",new Float32Array(ie.getRgbaComponentsNormalized(this._color)),this.gl.uniform4fv),this._setUniform("backgroundColor",new Float32Array(ie.getRgbaComponentsNormalized(this._backgroundColor)),this.gl.uniform4fv),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv),this.redraw()}}fh.vertexShaderSource=be.vertexShaderSource;fh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;

    uniform float iTime;
    uniform float radius;
    uniform float width;
    uniform float period;
    uniform float angle;
    uniform float smooth;
    uniform vec2 resolution;

    uniform vec4 color;
    uniform vec4 backgroundColor;

    float ratio = resolution.y / resolution.x;

    vec2 transpose_pos(vec2 pos) {
        if (ratio < 1.) {
            float diff = 0.5 - pos.x;
            pos.x = 0.5 - diff / ratio;
        } else {
            float diff = 0.5 - pos.y;
            pos.y = 0.5 - diff * ratio;
        }
        return pos;
    }

    float get_angle(vec2 pos) {
        pos = transpose_pos(pos);
        float a = atan(pos.y - 0.5, pos.x - 0.5);
        a = (1.0+a/3.14159)/2.0;
        
        return a;
    }

    float dist(vec2 pos1, vec2 pos2) {
        pos1 = transpose_pos(pos1);
        return distance(pos1, pos2);
    }

    void main()
    {
        vec2 fragCoord = vTextureCoord;
        vec4 fragColor = vColor;
        
        vec2 st = vTextureCoord;
        float pct = dist(st, vec2(0.5));

        float a = get_angle(st);
        float t = iTime / 1000.0 / period;

        float inner = max((radius - width) / resolution.x, (radius - width) / resolution.y);
        float outer = max(radius / resolution.x, radius / resolution.y);

        float x1 = mod(t, 1.0);
        float x2 = mod(t + angle, 1.0);

        if (x1 < x2) {
            if (a > x1 && a < x2) {
                float val = (1.0 - (x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (x2 - a));
                fragColor = mix(backgroundColor, color, val);
            } else {
                fragColor = backgroundColor;
            }
        } else {
            if (a < x2) {
                float val = (1.0 - (x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (x2 - a));
                fragColor = mix(backgroundColor, color, val);
            } else if (a > x1) {
                float val = (1.0 - (1.0 + x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (1.0 + x2 - a));
                fragColor = mix(backgroundColor, color, val);
            } else {
                fragColor = backgroundColor;
            }
        }

        float s = smoothstep(inner, inner + smooth + 0.00001, pct) * (1.0 - smoothstep(outer, outer + smooth + 0.00001, pct));
        gl_FragColor = texture2D(uSampler, fragCoord) * vColor * (1. - s * fragColor.a) + fragColor * s;
    }
`;class gh extends be{constructor(e){super(e),this._x=0,this._y=0,this._w=0,this._h=0,this._radius=0}get x(){return this._x}set x(e){this._x=e,this.redraw()}get y(){return this._y}set y(e){this._y=e,this.redraw()}get w(){return this._w}set w(e){this._w=e,this.redraw()}get h(){return this._h}set h(e){this._h=e,this.redraw()}get radius(){return this._radius}set radius(e){this._radius=e,this.redraw()}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=this.ctx.stage.getRenderPrecision();this._setUniform("x",this._x*i,this.gl.uniform1f),this._setUniform("y",this._y*i,this.gl.uniform1f),this._setUniform("w",this._w*i,this.gl.uniform1f),this._setUniform("h",this._h*i,this.gl.uniform1f),this._setUniform("radius",(this._radius+.5)*i,this.gl.uniform1f),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv)}useDefault(){return this._x===0&&this._y===0&&this._w===0&&this._h===0}}gh.vertexShaderSource=be.vertexShaderSource;gh.fragmentShaderSource=`
   #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform float x;
    uniform float y;
    uniform float w;
    uniform float h;
    uniform vec2 resolution;
    uniform float radius;

    float roundBox(vec2 p, vec2 b, float r) {
        float d = length(max(abs(p)-b+r, 0.1))-r;
        return smoothstep(1.0, 0.0, d);
    }

    void main(void){
        vec4 color = texture2D(uSampler, vTextureCoord);
        vec2 pos = vTextureCoord.xy * resolution - vec2(x, y) - vec2(w, h) / 2.0;
        vec2 size = vec2(w, h) / 2.0;
        float b = roundBox(pos, size, radius);
        gl_FragColor = mix(color, vec4(0.0), b) * vColor;
    }
`;class hf extends be{constructor(e){super(e),this._pivot=[0,0],this._ic=4294967295,this._normalizedIC=this._getNormalizedColor(this._ic),this._oc=16777215,this._normalizedOC=this._getNormalizedColor(this._oc),this._radius=0}set radiusX(e){this.radius=e}get radiusX(){return this._radius}set radiusY(e){this._radiusY=e,this.redraw()}get radiusY(){return this._radiusY}set radius(e){this._radius=e,this.redraw()}set innerColor(e){this._ic=e,this._normalizedIC=this._getNormalizedColor(e),this.redraw()}get innerColor(){return this._ic}set outerColor(e){this._oc=e,this._normalizedOC=this._getNormalizedColor(e),this.redraw()}set color(e){this.innerColor=e}get color(){return this.innerColor}get outerColor(){return this._ic}set x(e){this._x=e,this.redraw()}set y(e){this._y=e,this.redraw()}set pivot(e){Array.isArray(e)&&e.length===2?this._pivot=e:Array.isArray(e)?this._pivot=[e[0],e[1]||e[0]]:this._pivot=[e,e],this.redraw()}get pivot(){return this._pivot[0]}set pivotY(e){this._pivot[1]=e,this.redraw()}get pivotY(){return this._pivot[1]}set pivotX(e){this._pivot[0]=e,this.redraw()}get pivotX(){return this._pivot[0]}_getNormalizedColor(e){const t=ie.getRgbaComponentsNormalized(e);return t[0]*=t[3],t[1]*=t[3],t[2]*=t[3],new Float32Array(t)}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner;this._x&&(this._pivot[0]=this._x/t.w),this._y&&(this._pivot[1]=this._y/t.h),this._radius===0&&(this._radius=t.w*.5),this._setUniform("innerColor",this._normalizedIC,this.gl.uniform4fv),this._setUniform("fill",ie.getRgbaComponentsNormalized(this._oc)[3],this.gl.uniform1f),this._setUniform("outerColor",this._normalizedOC,this.gl.uniform4fv),this._setUniform("pivot",new Float32Array(this._pivot),this.gl.uniform2fv),this._setUniform("resolution",new Float32Array([t._w,t._h]),this.gl.uniform2fv),this._setUniform("alpha",e.getElementCore(0).renderContext.alpha,this.gl.uniform1f),this._setUniform("radius",this._radius,this.gl.uniform1f),this._setUniform("radiusY",this._radiusY||this._radius,this.gl.uniform1f)}}hf.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    
    #define PI 3.14159265359
    
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform vec2 resolution;
    uniform vec2 pivot;
    uniform vec4 innerColor;
    uniform vec4 outerColor;
    uniform float radius;
    uniform float radiusY;
    uniform float alpha;
    uniform float fill;
    uniform float aspectRatio;
    
    void main() {
        vec2 point = vTextureCoord.xy * resolution;
        vec2 projection = vec2(pivot.x * resolution.x, pivot.y * resolution.y);
        float d = length((point - projection) / vec2(radius * 2.0, radiusY * 2.0));
        vec4 color = mix(texture2D(uSampler, vTextureCoord) * vColor, outerColor * alpha, fill);
        gl_FragColor = mix(innerColor * alpha, color, smoothstep(0.0, 1.0, d));
    }
`;class ph extends be{constructor(e){super(e),this._strength=.5,this._ambient=.5,this._fudge=.4,this._rx=0,this._ry=0,this._z=0,this._pivotX=NaN,this._pivotY=NaN,this._pivotZ=0,this._lightY=0,this._lightZ=0}setupUniforms(e){super.setupUniforms(e);let t=e.shaderOwner,i=t.element,s=isNaN(this._pivotX)?i.pivotX*t.w:this._pivotX,r=isNaN(this._pivotY)?i.pivotY*t.h:this._pivotY,o=t.getRenderTextureCoords(s,r),a=-Math.atan2(t._renderContext.tc,t._renderContext.ta),l=this.gl;this._setUniform("pivot",new Float32Array([o[0],o[1],this._pivotZ]),l.uniform3fv),this._setUniform("rot",new Float32Array([this._rx,this._ry,a]),l.uniform3fv),this._setUniform("z",this._z,l.uniform1f),this._setUniform("lightY",this.lightY,l.uniform1f),this._setUniform("lightZ",this.lightZ,l.uniform1f),this._setUniform("strength",this._strength,l.uniform1f),this._setUniform("ambient",this._ambient,l.uniform1f),this._setUniform("fudge",this._fudge,l.uniform1f)}set strength(e){this._strength=e,this.redraw()}get strength(){return this._strength}set ambient(e){this._ambient=e,this.redraw()}get ambient(){return this._ambient}set fudge(e){this._fudge=e,this.redraw()}get fudge(){return this._fudge}get rx(){return this._rx}set rx(e){this._rx=e,this.redraw()}get ry(){return this._ry}set ry(e){this._ry=e,this.redraw()}get z(){return this._z}set z(e){this._z=e,this.redraw()}get pivotX(){return this._pivotX}set pivotX(e){this._pivotX=e+1,this.redraw()}get pivotY(){return this._pivotY}set pivotY(e){this._pivotY=e+1,this.redraw()}get lightY(){return this._lightY}set lightY(e){this._lightY=e,this.redraw()}get pivotZ(){return this._pivotZ}set pivotZ(e){this._pivotZ=e,this.redraw()}get lightZ(){return this._lightZ}set lightZ(e){this._lightZ=e,this.redraw()}useDefault(){return this._rx===0&&this._ry===0&&this._z===0&&this._strength===0&&this._ambient===1}}ph.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;

    uniform float fudge;
    uniform float strength;
    uniform float ambient;
    uniform float z;
    uniform float lightY;
    uniform float lightZ;
    uniform vec3 pivot;
    uniform vec3 rot;
    varying vec3 pos;

    void main(void) {
        pos = vec3(aVertexPosition.xy, z);
        
        pos -= pivot;
        
        // Undo XY rotation
        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), 
                           -sin(rot.z), cos(rot.z));
        pos.xy = iRotXy * pos.xy;
        
        // Perform 3d rotations
        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;
        gl_Position.y = pos.y;
        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;
        
        pos.x = gl_Position.x;
        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;
        pos.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;
        
        // Redo XY rotation
        iRotXy[0][1] = -iRotXy[0][1];
        iRotXy[1][0] = -iRotXy[1][0];
        pos.xy = iRotXy * pos.xy; 

        // Undo translate to pivot position
        pos.xyz += pivot;

        pos = vec3(pos.x * projection.x - 1.0, pos.y * -abs(projection.y) + 1.0, pos.z * projection.x);
        
        // Set depth perspective
        float perspective = 1.0 + fudge * pos.z;

        pos.z += lightZ * projection.x;

        // Map coords to gl coordinate space.
        // Set z to 0 because we don't want to perform z-clipping
        gl_Position = vec4(pos.xy, 0.0, perspective);

        // Correct light source position.
        pos.y += lightY * abs(projection.y);

        vTextureCoord = aTextureCoord;
        vColor = aColor;
        
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;ph.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    varying vec3 pos;
    uniform sampler2D uSampler;
    uniform float ambient;
    uniform float strength;
    void main(void){
        vec4 rgba = texture2D(uSampler, vTextureCoord);
        float d = length(pos);
        float n = 1.0 / max(0.1, d);
        rgba.rgb = rgba.rgb * (strength * n + ambient);
        gl_FragColor = rgba * vColor;
    }
`;class mh extends be{constructor(e){super(e),this._fudge=.2,this._rx=0,this._ry=0,this._z=1}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=t.element,s=i.pivotX*t.w,r=i.pivotY*t.h,o=t.getRenderTextureCoords(s,r),a=-Math.atan2(t._renderContext.tc,t._renderContext.ta),l=this.gl;this._setUniform("pivot",new Float32Array([o[0],o[1],0]),l.uniform3fv),this._setUniform("rot",new Float32Array([this._rx,this._ry,a]),l.uniform3fv),this._setUniform("z",this._z,l.uniform1f),this._setUniform("fudge",this._fudge,l.uniform1f)}set fudge(e){this._fudge=e,this.redraw()}get fudge(){return this._fudge}get rx(){return this._rx}set rx(e){this._rx=e,this.redraw()}get ry(){return this._ry}set ry(e){this._ry=e,this.redraw()}get z(){return this._z}set z(e){this._z=e,this.redraw()}useDefault(){return this._rx===0&&this._ry===0&&this._z===0}}mh.vertexShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec4 aColor;
    uniform vec2 projection;
    varying vec2 vTextureCoord;
    varying vec4 vColor;

    uniform float z;
    uniform vec3 pivot;
    uniform vec3 rot;
    varying vec3 pos;

    void main(void) {
        pos = vec3(aVertexPosition.xy, z);
        
        pos -= pivot;
        
        // Undo XY rotation
        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), 
                           -sin(rot.z), cos(rot.z));
        pos.xy = iRotXy * pos.xy;
        
        // Perform 3d rotations
        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;
        gl_Position.y = pos.y;
        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;
        
        pos.x = gl_Position.x;
        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;
        pos.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;
        
        // Redo XY rotation
        iRotXy[0][1] = -iRotXy[0][1];
        iRotXy[1][0] = -iRotXy[1][0];
        pos.xy = iRotXy * pos.xy; 

        // Undo translate to pivot position
        pos.xyz += pivot;

        pos = vec3(pos.x * projection.x - 1.0, pos.y * -abs(projection.y) + 1.0, pos.z * projection.x);
        
        // Map coords to gl coordinate space.
        // Set z to 0 because we don't want to perform z-clipping
        gl_Position = vec4(pos.xy, 0.0, z);

        vTextureCoord = aTextureCoord;
        vColor = aColor;
        
        gl_Position.y = -sign(projection.y) * gl_Position.y;
    }
`;mh.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;

    uniform vec3 rot;
    uniform float fudge;

    void main(void) {
        vec2 coords = vTextureCoord;

        coords.xy -= vec2(0.5);
        coords.y = coords.y + (sign(rot[0]) * 0.5 - coords.x) * sin(rot[0]) * fudge * coords.y;
        coords.x = coords.x + (sign(rot[1]) * 0.5 - coords.y) * sin(rot[1]) * fudge * coords.x;
        coords.xy += vec2(0.5);

        if (coords.x < 0.0 || coords.x > 1.0 || coords.y < 0.0 || coords.y > 1.0) {
            gl_FragColor = vec4(0.0);
        } else {
            gl_FragColor = texture2D(uSampler, coords) * vColor;
        }
    }
`;class _h extends be{constructor(e){super(e),this._x=0,this._y=0,this._w=0,this._h=0,this._radius=0,this._magnification=.6}get x(){return this._x}set x(e){this._x=e,this.redraw()}get y(){return this._y}set y(e){this._y=e,this.redraw()}get w(){return this._w}set w(e){this._w=e,this.redraw()}get h(){return this._h}set h(e){this._h=e,this.redraw()}get magnification(){return this._magnification}set magnification(e){this._magnification=e,this.redraw()}get radius(){return this._radius}set radius(e){this._radius=e,this.redraw()}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=this.ctx.stage.getRenderPrecision();this._setUniform("x",this._x*i,this.gl.uniform1f),this._setUniform("y",this._y*i,this.gl.uniform1f),this._setUniform("w",this._w*i,this.gl.uniform1f),this._setUniform("h",this._h*i,this.gl.uniform1f),this._setUniform("magnification",this._magnification,this.gl.uniform1f),this._setUniform("radius",(this._radius+.5)*i,this.gl.uniform1f),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv)}useDefault(){return this._w===0&&this._h===0}}_h.vertexShaderSource=be.vertexShaderSource;_h.fragmentShaderSource=`
	  #ifdef GL_ES
		# ifdef GL_FRAGMENT_PRECISION_HIGH
		precision highp float;
		# else
		precision lowp float;
		# endif
	  #endif

	  varying vec2 vTextureCoord;
	  varying vec4 vColor;
	  uniform sampler2D uSampler;
	  uniform float x;
	  uniform float y;
	  uniform float w;
	  uniform float h;
	  uniform vec2 resolution;
	  uniform float radius;
	  uniform float magnification;
  
	  float roundBox(vec2 p, vec2 b, float r) {
		  float d = length(max(abs(p)-b+r, 0.1))-r;
		  return smoothstep(1.0, 0.0, d);
	  }

	  float inside(vec2 v) {
		vec2 s = step(vec2(0.0, 0.0), v) - step(vec2(1.0, 1.0), v);
		return s.x * s.y;   
      }
  
	  void main(void) {
		vec4 color = texture2D(uSampler, vTextureCoord);
		vec2 pos = vTextureCoord.xy * resolution - vec2(x, y) - vec2(w, h) / 2.0;
		vec2 size = vec2(w, h) / 2.0;
		float b = roundBox(pos, size, radius);
		vec2 pos2 = (vTextureCoord.xy * magnification * resolution + vec2(x, y) * magnification) / resolution;
		gl_FragColor = mix(color, texture2D(uSampler, pos2) * inside(pos2), b) * vColor;
	  }
  `;class Hr extends be{constructor(e){super(e),this._period=1,this._stroke=0,this._showDot=!0,this._clockwise=!0,this._bc=4278190080,this._normalizedBC=this._getNormalizedColor(this._bc),this._c=4294967295,this._normalizedC=this._getNormalizedColor(this._c)}set radius(e){e===0&&(e=1),this._radius=e}set stroke(e){this._stroke=Math.abs(e)}get stroke(){return this._stroke}set color(e){this._c=e,this._normalizedC=this._getNormalizedColor(e)}get color(){return this._c}set backgroundColor(e){this._bc=e,this._normalizedBC=this._getNormalizedColor(e)}get backgroundColor(){return this._sc}set showDot(e){this._showDot=e}get showDot(){return this._showDot}set clockwise(e){this._clockwise=e}get clockwise(){return this._clockwise}set period(e){this._period=e}get period(){return this._period}_getNormalizedColor(e){const t=ie.getRgbaComponentsNormalized(e);return t[0]*=t[3],t[1]*=t[3],t[2]*=t[3],new Float32Array(t)}setupUniforms(e){super.setupUniforms(e);const t=e.shaderOwner,i=this._radius||t._w/2;this._stroke===0&&(this._stroke=i*.33),this._setUniform("resolution",new Float32Array([t._w,t._h]),this.gl.uniform2fv),this._setUniform("color",this._normalizedC,this.gl.uniform4fv),this._setUniform("backgroundColor",this._normalizedBC,this.gl.uniform4fv),this._setUniform("stroke",this._stroke,this.gl.uniform1f),this._setUniform("radius",i,this.gl.uniform1f),this._setUniform("direction",this._clockwise?-1:1,this.gl.uniform1f),this._setUniform("showDot",!!this._showDot,this.gl.uniform1f),this._setUniform("time",Date.now()-Hr.spinSync,this.gl.uniform1f),this._setUniform("period",this._period,this.gl.uniform1f),this._setUniform("alpha",e.getElementCore(0).renderContext.alpha,this.gl.uniform1f),(this._sc!==this._bc||this._stroke!==i*.5)&&this.redraw()}}Hr.spinSync=Date.now();Hr.fragmentShaderSource=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
    
    #define PI 3.14159265359
    
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    
    uniform sampler2D uSampler;
    uniform vec2 resolution;
    uniform vec4 color;
    uniform vec4 backgroundColor;
    uniform float direction;
    uniform float radius;
    uniform float time;
    uniform float stroke;
    uniform float showDot;
    uniform float period;
    uniform float alpha;
    
    float circleDist(vec2 p, float radius){
        return length(p) - radius;
    }
    
    float fillMask(float dist){
        return clamp(-dist, 0.0, 1.0);
    }
    
    void main() {
        vec2 halfRes = 0.5 * resolution.xy;
        vec2 center = vTextureCoord.xy * resolution - halfRes;
        
        float c = max(-circleDist(center, radius - stroke), circleDist(center, radius));
        float rot = -(time / 1000.0 / period) * 6.0 * direction;
        center *= mat2(cos(rot), sin(rot), -sin(rot), cos(rot));
        
        float a = direction * atan(center.x, center.y) * PI * 0.05 + 0.45;
        
        float strokeRad = stroke * 0.5;
        a = mix(a, max(a, fillMask(circleDist(vec2(center.x, center.y + (radius - strokeRad)), strokeRad))), showDot);
        vec4 base = mix(vec4(0.0), backgroundColor * alpha, fillMask(c));
        gl_FragColor = mix(base, color * alpha, fillMask(c) * a);
    }
`;const Ye={Application:Pi,Component:ke,Base:Xe,Utils:H,StageUtils:ie,Element:Ce,Tools:yr,Stage:hs,ElementCore:Bi,ElementTexturizer:$d,Texture:_t,EventEmitter:tt,shaders:{Grayscale:nh,BoxBlur:Pt,Dithering:oh,CircularPush:ah,Inversion:af,LinearBlur:Qo,Outline:lh,Pixelate:hh,RadialFilter:ch,RoundedRectangle:uh,Spinner2:Hr,FadeOut:lf,Hole:gh,Vignette:dh,Spinner:fh,RadialGradient:hf,Light3d:ph,Perspective:mh,Magnifier:_h,WebGLShader:Xo,WebGLDefaultShader:be,C2dShader:th,C2dDefaultShader:jo,c2d:{Grayscale:of,Blur:sf}},textures:{RectangleTexture:Qd,NoiseTexture:tf,TextTexture:ni,ImageTexture:ml,HtmlTexture:rh,StaticTexture:X_,StaticCanvasTexture:Zd,SourceTexture:Gd},components:{FastBlurComponent:Q_,BloomComponent:J_,SmoothScaleComponent:bo,BorderComponent:ex,ListComponent:j_},tools:{ObjMerger:sh,ObjectListProxy:Jd,ObjectListWrapper:ef}};H.isWeb&&(window.lng=Ye);class qe extends Ye.shaders.WebGLDefaultShader{set brightness(e){this._brightness=(e-50)/100,this.redraw()}set contrast(e){this._contrast=(e+50)/100,this.redraw()}set gamma(e){this._gamma=(e+50)/100,this.redraw()}setupUniforms(e){super.setupUniforms(e);const t=this.gl;this._setUniform("colorAdjust",[this._brightness||0,this._contrast||1,this._gamma||1],t.uniform3fv)}}qe.before=`
    #ifdef GL_ES
    # ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    # else
    precision lowp float;
    # endif
    #endif
        
    varying vec2 vTextureCoord;
    varying vec4 vColor;
    uniform sampler2D uSampler;
    uniform vec3 colorAdjust;
    
    const mat3 RGBtoOpponentMat = mat3(0.2814, -0.0971, -0.0930, 0.6938, 0.1458,-0.2529, 0.0638, -0.0250, 0.4665);
    const mat3 OpponentToRGBMat = mat3(1.1677, 0.9014, 0.7214, -6.4315, 2.5970, 0.1257, -0.5044, 0.0159, 2.0517);    
`;qe.after=`    
    vec3 brightnessContrast(vec3 value, float brightness, float contrast)
    {
        return (value - 0.5) * contrast + 0.5 + brightness;
    }   
    
    vec3 updateGamma(vec3 value, float param)
    {
        return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));
    } 
       
    void main(void){
        vec4 fragColor = texture2D(uSampler, vTextureCoord);        
        vec4 color = filter(fragColor) * vColor;       
        
        vec3 bc = brightnessContrast(color.rgb,colorAdjust[0],colorAdjust[1]);        
        vec3 ga = updateGamma(bc.rgb, colorAdjust[2]);  
              
        gl_FragColor = vec4(ga.rgb, color.a);          
    }    
`;class tx extends qe{}tx.fragmentShaderSource=`
    ${qe.before}    
    vec4 vision(vec4 color)
    {
        vec4 r = vec4( 0.20,  0.99, -0.19, 0.0);
        vec4 g = vec4( 0.16,  0.79,  0.04, 0.0);
        vec4 b = vec4( 0.01, -0.01,  1.00, 0.0);
       
        return vec4(dot(color, r), dot(color, g), dot(color, b), color.a);	
    }
    
    vec4 filter( vec4 color )
    {   
        vec3 opponentColor = RGBtoOpponentMat * vec3(color.r, color.g, color.b);
        opponentColor.x -= opponentColor.y * 1.5; 
        vec3 rgbColor = OpponentToRGBMat * opponentColor;
        return vision(vec4(rgbColor.r, rgbColor.g, rgbColor.b, color.a));      
    }    
    ${qe.after} 
`;class ix extends qe{}ix.fragmentShaderSource=`
    ${qe.before}
    vec4 vision(vec4 color)
    {
        vec4 r = vec4( 0.43,  0.72, -0.15, 0.0 );
        vec4 g = vec4( 0.34,  0.57,  0.09, 0.0 );
        vec4 b = vec4(-0.02,  0.03,  1.00, 0.0 );
       
        return vec4(dot(color, r), dot(color, g), dot(color, b), color.a);	
    }
       
    vec4 filter( vec4 color )
    {   
        vec3 opponentColor = RGBtoOpponentMat * vec3(color.r, color.g, color.b);
        opponentColor.x -= opponentColor.y * 1.5; 
        vec3 rgbColor = OpponentToRGBMat * opponentColor;
        return vision(vec4(rgbColor.r, rgbColor.g, rgbColor.b, color.a));    
    }
    ${qe.after}    
`;class sx extends qe{}sx.fragmentShaderSource=`
    ${qe.before}    
    vec4 vision(vec4 color)
    {
        vec4 r = vec4( 0.97,  0.11, -0.08, 0.0 );
        vec4 g = vec4( 0.02,  0.82,  0.16, 0.0 );
        vec4 b = vec4(-0.06,  0.88,  0.18, 0.0 );
       
        return vec4(dot(color, r), dot(color, g), dot(color, b), color.a);	
    }   
    
    vec4 filter( vec4 color )
    {   
        vec3 opponentColor = RGBtoOpponentMat * vec3(color.r, color.g, color.b);
        opponentColor.x -= ((3.0 * opponentColor.z) - opponentColor.y) * 0.25;
        vec3 rgbColor = OpponentToRGBMat * opponentColor;
        return vision(vec4(rgbColor.r, rgbColor.g, rgbColor.b, color.a));
    }   
    ${qe.after} 
`;class rx extends qe{}rx.fragmentShaderSource=`
    ${qe.before}
    vec4 filter( vec4 color )
    {
        return color;
    }
    ${qe.after}
`;class nx extends qe{}nx.fragmentShaderSource=`
    ${qe.before}
    vec4 filter( vec4 color )
    {   
        float grey = dot(color.rgb, vec3(0.299, 0.587, 0.114));
        return vec4(vec3(grey, grey, grey), 1.0 ); 
    }
    ${qe.after}
`;function ox(n=[]){const e=[];for(var t=0;t<n.length&&(typeof n[t]=="string"&&!n[t].includes("PAUSE-"));t++)e.push(n[t]);return[e.join(",\b ")].concat(n.slice(t))}function Ec(n){return new Promise(e=>{setTimeout(e,n)})}function ax(n,e,t="en-US"){const i=window.speechSynthesis;return new Promise((s,r)=>{const o=new SpeechSynthesisUtterance(n);o.lang=t,o.onend=()=>{s()},o.onerror=a=>{r(a)},e.push(o),i.speak(o)})}function yl(n,e,t=!0){const i=window.speechSynthesis,s=ox(Array.isArray(n)?n:[n]),r=[],o=[];let a=!0;return{series:(async()=>{try{for(;a&&s.length;){const h=await Promise.resolve(s.shift());if(a){if(typeof h=="string"&&h.includes("PAUSE-")){let c=h.split("PAUSE-")[1]*1e3;isNaN(c)&&(c=0),await Ec(c)}else if(typeof h=="string"&&h.length){let u=3;for(;a&&u>0;)try{await ax(h,o,e),u=0}catch(d){if(d instanceof SpeechSynthesisErrorEvent)if(d.error==="network")u--,console.warn(`Speech synthesis network error. Retries left: ${u}`),await Ec(500*(3-u));else if(d.error==="canceled"||d.error==="interrupted")u=0;else throw new Error(`SpeechSynthesisErrorEvent: ${d.error}`);else throw d}}else if(typeof h=="function"){const c=yl(h(),e,!1);r.push(c),await c.series}else if(Array.isArray(h)){const c=yl(h,e,!1);r.push(c),await c.series}}else break}}finally{a=!1}})(),get active(){return a},append:h=>{s.push(h)},cancel:()=>{a&&(t&&i.cancel(),r.forEach(h=>{h.cancel()}),a=!1)}}}let En;function lx(n,e){return En&&En.cancel(),En=yl(n,e),En}function bn(n){return n.ref||n.constructor.name}function bc(n,e,t){var i,s,r,o,a;e==null&&(e=100);function l(){var c=Date.now()-o;c<e&&c>=0?i=setTimeout(l,e-c):(i=null,a=n.apply(r,s),r=s=null)}var h=function(){return r=this,s=arguments,o=Date.now(),i||(i=setTimeout(l,e)),a};return h.clear=function(){i&&(clearTimeout(i),i=null)},h.flush=function(){i&&(a=n.apply(r,s),r=s=null,clearTimeout(i),i=null)},h}let Tl,Tr=[],wi,Sl=!1;const hx=3e5;function cx(n=[]){if(!zt.enabled)return;const e=n.every(r=>!r.loading),t=n.filter(r=>!Tr.includes(r));if(Tl(),!e){zt.onFocusChange();return}Tr=n.slice(0);let i=[],s=t.reduce((r,o)=>(o.announce?(r.push([bn(o),"Announce",o.announce]),i.push(o.announce)):o.title&&(r.push([bn(o),"Title",o.title]),i.push(o.title)),r),[]);if(t.reverse().reduce((r,o)=>(o.announceContext?(r.push([bn(o),"Context",o.announceContext]),i.push(o.announceContext)):r.push([bn(o),"No Context",""]),r),s),zt.debug&&console.table(s),i.length)return zt.speak(i.reduce((r,o)=>r.concat(o),[]))}function ux(n){if(!Sl)return wi=lx(n)}const zt={enabled:!0,debug:!1,cancel:function(){wi&&wi.cancel()},clearPrevFocus:function(n=0){Tr=Tr.slice(0,n),Tl()},speak:function(n,{append:e=!1,notification:t=!1}={}){return zt.enabled&&(zt.onFocusChange.flush(),e&&wi&&wi.active?wi.append(n):(zt.cancel(),ux(n)),t&&(Sl=!0,wi.series.finally(()=>{Sl=!1,zt.refresh()}))),wi},setupTimers:function({focusDebounce:n=400,focusChangeTimeout:e=hx}={}){zt.onFocusChange=bc(cx,n),Tl=bc(()=>{Tr=[]},e)}};zt.setupTimers();let Vr,Ns,Ui,qn,vl;const bi={set log(n){Vr=n},set settings(n){Ns=n},set ads(n){qn=n},set lightning(n){vl=n},set appInstance(n){Ui=n}};let Ao=(n,e,t)=>{Vr.info("Sending metric",n,e,t)};const dx={app:["launch","loaded","ready","close"],page:["view","leave"],user:["click","input"],media:["abort","canplay","ended","pause","play","volumechange","waiting","seeking","seeked"]},cf=(n,e,t,i,s={})=>{s={params:s,message:e,code:t,visible:i},Ao(n,"error",s)},Ac=(n,e,t={})=>e.reduce((i,s)=>(i[s]=(r,o={})=>{o={...t,...r?{name:r}:{},...o},Ao(n,s,o)},i),{error(i,s,r){cf(n,i,s,r)},event(i,s){Ao(n,i,s)}}),fx=n=>Object.keys(n).reduce((e,t)=>(t==="media"?e[t]=i=>Ac(t,n[t],{url:i}):e[t]=Ac(t,n[t]),e),{error:cf,event:Ao}),uf=fx(dx);new Date(new Date-60*5*1e3).toUTCString(),60*30,new Date(new Date-60*20*1e3).toUTCString(),60*45,new Date(new Date-60*10*1e3).toUTCString(),60*60;const gx=(n,e=null,t=null)=>{let i;if(n&&typeof n=="function")try{i=n.apply(t,e)}catch(s){i=s}else i=n;return i!==null&&typeof i=="object"&&i.then&&typeof i.then=="function"?i:new Promise((s,r)=>{i instanceof Error?r(i):s(i)})},Rc={abort:"Abort",canplay:"CanPlay",canplaythrough:"CanPlayThrough",durationchange:"DurationChange",emptied:"Emptied",encrypted:"Encrypted",ended:"Ended",error:"Error",interruptbegin:"InterruptBegin",interruptend:"InterruptEnd",loadeddata:"LoadedData",loadedmetadata:"LoadedMetadata",loadstart:"LoadStart",pause:"Pause",play:"Play",playing:"Playing",progress:"Progress",ratechange:"Ratechange",seeked:"Seeked",seeking:"Seeking",stalled:"Stalled",timeupdate:"TimeUpdate",volumechange:"VolumeChange",waiting:"Waiting"},px=(n,e=()=>{})=>{let t=!1;const i=()=>{t===!1&&(e(),t=!0)};return Object.keys(n).reduce((s,r)=>(typeof n[r]=="function"?s[r]=function(){return i(),n[r].apply(n,arguments)}:typeof Object.getOwnPropertyDescriptor(n,r).get=="function"?s.__defineGetter__(r,function(){return i(),Object.getOwnPropertyDescriptor(n,r).get.apply(n)}):typeof Object.getOwnPropertyDescriptor(n,r).set=="function"?s.__defineSetter__(r,function(){return i(),Object.getOwnPropertyDescriptor(n,r).set.sourceObject[r].apply(n,arguments)}):s[r]=n[r],s),{})};let Cc=null;const mx=(n,e)=>{clearTimeout(Cc),Cc=setTimeout(()=>{n()},e)},_x=()=>class extends vl.Component{static _template(){return{Video:{alpha:1,visible:!1,pivot:.5,texture:{type:vl.textures.StaticTexture,options:{}}}}}set videoEl(e){this._videoEl=e}get videoEl(){return this._videoEl}get videoView(){return this.tag("Video")}get videoTexture(){return this.videoView.texture}get isVisible(){return this.videoView.alpha===1&&this.videoView.visible===!0}_init(){this._createVideoTexture()}_createVideoTexture(){const t=this.stage.gl,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.videoTexture.options={source:i,w:this.videoEl.width,h:this.videoEl.height},this.videoView.w=this.videoEl.width/this.stage.getRenderPrecision(),this.videoView.h=this.videoEl.height/this.stage.getRenderPrecision()}start(){const e=this.stage;this._lastTime=0,this._updateVideoTexture||(this._updateVideoTexture=()=>{if(this.videoTexture.options.source&&this.videoEl.videoWidth&&this.active){const t=e.gl,i=new Date().getTime(),s=this.videoEl.getVideoPlaybackQuality(),r=s?s.totalVideoFrames:this.videoEl.webkitDecodedFrameCount;if(r?this._lastFrame!==r:this._lastTime<i-30){this._lastTime=i,this._lastFrame=r;try{t.bindTexture(t.TEXTURE_2D,this.videoTexture.options.source),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.videoEl),this._lastFrame=this.videoEl.webkitDecodedFrameCount,this.videoView.visible=!0,this.videoTexture.options.w=this.videoEl.width,this.videoTexture.options.h=this.videoEl.height;const a=this.videoView.w/this.videoView.h,l=this.videoEl.width/this.videoEl.height;a>l?(this.videoView.scaleX=l/a,this.videoView.scaleY=1):(this.videoView.scaleY=a/l,this.videoView.scaleX=1)}catch(a){Vr.error("texImage2d video",a),this.stop()}this.videoTexture.source.forceRenderUpdate()}}}),this._updatingVideoTexture||(e.on("frameStart",this._updateVideoTexture),this._updatingVideoTexture=!0)}stop(){const e=this.stage;if(e.removeListener("frameStart",this._updateVideoTexture),this._updatingVideoTexture=!1,this.videoView.visible=!1,this.videoTexture.options.source){const t=e.gl;t.bindTexture(t.TEXTURE_2D,this.videoTexture.options.source),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT)}}position(e,t){this.videoView.patch({x:t,y:e})}size(e,t){this.videoView.patch({w:e,h:t})}show(){this.videoView.alpha=1}hide(){this.videoView.alpha=0}};let df=n=>n,j,Ii,fr,Ys,El=1,Zt=!1,Qn={};const Fe={adsEnabled:!1,playing:!1,_playingAds:!1,get playingAds(){return this._playingAds},set playingAds(n){this._playingAds!==n&&(this._playingAds=n,rs(n===!0?"AdStart":"AdEnd"))},skipTime:!1,playAfterSeek:null},va={play(){Fe.playing=!0},pause(){Fe.playing=!1},seeked(){Fe.playAfterSeek===!0&&ff.play(),Fe.playAfterSeek=null},abort(){bl()}},Nt=n=>Math.round(El*n)+"px",rs=(n,e)=>{Ys&&(Ys.fire("$videoPlayer"+n,e,j.currentTime),Ys.fire("$videoPlayerEvent",n,e,j.currentTime))},xx=(n,e)=>{va[n]&&typeof va[n]=="function"&&va[n].call(null,n,e)};let Zn=null,Jn=null;const yx=(n,e,t)=>Zn&&typeof Zn=="function"?Zn(n,e,t):new Promise(i=>{n=df(n),e.setAttribute("src",n),e.load(),i()}),Tx=n=>Jn&&typeof Jn=="function"?Jn(n):new Promise(e=>{n.removeAttribute("src"),n.load(),e()}),Sx=()=>{const n=document.getElementsByTagName("video");if(n&&n.length)return n[0];{const e=document.createElement("video"),t=Ns.get("platform","width")?Ns.get("platform","width"):1920,i=Ns.get("platform","height")?Ns.get("platform","height"):1080;return e.setAttribute("id","video-player"),e.setAttribute("width",Nt(t)),e.setAttribute("height",Nt(i)),e.style.position="absolute",e.style.zIndex="1",e.style.display="none",e.style.visibility="hidden",e.style.top=Nt(0),e.style.left=Nt(0),e.style.width=Nt(t),e.style.height=Nt(i),document.body.appendChild(e),e}},vx=()=>{if(!Ui.tag("VideoTexture")){const n=Ui.stage.c({type:_x(),ref:"VideoTexture",zIndex:0,videoEl:j});Ui.childList.addAt(n,0)}return Ui.tag("VideoTexture")},Ex=()=>{Vr.info("VideoPlayer","Registering event listeners"),Object.keys(Rc).forEach(n=>{const e=t=>{fr&&fr[n]&&typeof fr[n]=="function"&&fr[n]({currentTime:j.currentTime}),xx(n,{videoElement:j,event:t}),rs(Rc[n],{videoElement:j,event:t})};Qn[n]=e,j.addEventListener(n,e)})},bl=()=>{Vr.info("VideoPlayer","Deregistering event listeners"),Object.keys(Qn).forEach(n=>{j.removeEventListener(n,Qn[n])}),Qn={}},ff={consumer(n){Ys=n},loader(n){Zn=n},unloader(n){Jn=n},position(n=0,e=0){j.style.left=Nt(e),j.style.top=Nt(n),Zt===!0&&Ii.position(n,e)},size(n=1920,e=1080){j.style.width=Nt(n),j.style.height=Nt(e),j.width=parseFloat(j.style.width),j.height=parseFloat(j.style.height),Zt===!0&&Ii.size(n,e)},area(n=0,e=1920,t=1080,i=0){this.position(n,i),this.size(e-i,t-n)},open(n,e={}){if(this.canInteract)if(fr=uf.media(n),this.hide(),bl(),this.src==n)this.clear().then(this.open(n,e));else{const t={enabled:Fe.adsEnabled,duration:300};e.videoId&&(t.caid=e.videoId),qn.get(t,Ys).then(i=>{Fe.playingAds=!0,i.prerolls().then(()=>{Fe.playingAds=!1,yx(n,j,e).then(()=>{Ex(),this.show(),this.play()}).catch(s=>{rs("Error",{videoElement:j,event:s}),rs("error",{videoElement:j,event:s})})})})}},reload(){if(!this.canInteract)return;const n=j.getAttribute("src");this.close(),this.open(n)},close(){qn.cancel(),Fe.playingAds&&(Fe.playingAds=!1,qn.stop(),setTimeout(()=>{this.close()})),this.canInteract&&(this.clear(),this.hide(),bl())},clear(){if(this.canInteract)return this.pause(),Zt===!0&&Ii.stop(),Tx(j).then(()=>{rs("Clear",{videoElement:j})})},play(){this.canInteract&&(Zt===!0&&Ii.start(),gx(j.play,null,j).catch(n=>{rs("Error",{videoElement:j,event:n}),rs("error",{videoElement:j,event:n})}))},pause(){this.canInteract&&j.pause()},playPause(){this.canInteract&&(this.playing===!0?this.pause():this.play())},mute(n=!0){this.canInteract&&(j.muted=n)},loop(n=!0){j.loop=n},seek(n){this.canInteract&&this.src&&(Fe.playAfterSeek===null&&(Fe.playAfterSeek=!!Fe.playing),this.pause(),j.currentTime=Math.max(0,Math.min(n,this.duration-.1)))},skip(n){this.canInteract&&this.src&&(Fe.skipTime=(Fe.skipTime||j.currentTime)+n,mx(()=>{this.seek(Fe.skipTime),Fe.skipTime=!1},300))},show(){this.canInteract&&(Zt===!0?Ii.show():(j.style.display="block",j.style.visibility="visible"))},hide(){this.canInteract&&(Zt===!0?Ii.hide():(j.style.display="none",j.style.visibility="hidden"))},enableAds(n=!0){Fe.adsEnabled=n},get duration(){return j&&(isNaN(j.duration)?1/0:j.duration)},get currentTime(){return j&&j.currentTime},get muted(){return j&&j.muted},get looped(){return j&&j.loop},get src(){return j&&j.getAttribute("src")},get playing(){return Fe.playing},get playingAds(){return Fe.playingAds},get canInteract(){return Fe.playingAds===!1},get top(){return j&&parseFloat(j.style.top)},get left(){return j&&parseFloat(j.style.left)},get bottom(){return j&&parseFloat(j.style.top-j.style.height)},get right(){return j&&parseFloat(j.style.left-j.style.width)},get width(){return j&&parseFloat(j.style.width)},get height(){return j&&parseFloat(j.style.height)},get visible(){return Zt===!0?Ii.isVisible:j&&j.style.display==="block"},get adsEnabled(){return Fe.adsEnabled},get _videoEl(){return j},get _consumer(){return Ys}},bx=px(ff,()=>{El=Ui&&Ui.stage&&Ui.stage.getRenderPrecision()||El,j=Sx(),Zt=Ns.get("platform","textureMode",!1),Zt===!0&&(j.setAttribute("crossorigin","anonymous"),Ii=vx())});let eo,Ax=()=>Promise.resolve({prerolls:[],midrolls:[],postrolls:[]});const gr={active:!1},Rx=(n=[])=>n.reduce((e,t)=>e.then(()=>Cx(t)),Promise.resolve(null)),Cx=n=>new Promise(e=>{if(gr.active===!1)return Te.info("Ad","Skipping add due to inactive state"),e();const t=document.getElementsByTagName("video")[0];t.style.display="block",t.style.visibility="visible",t.src=df(n.url),t.load();let i=null,s;const r=()=>{Object.keys(o).forEach(a=>t.removeEventListener(a,o[a])),e()},o={play(){Te.info("Ad","Play ad",n.url),Lt("Play",n),ns(n.callbacks,"defaultImpression")},ended(){Lt("Ended",n),ns(n.callbacks,"complete"),r()},timeupdate(){!i&&t.duration&&(i={firstQuartile:t.duration/4,midPoint:t.duration/2,thirdQuartile:t.duration/4*3},Te.info("Ad","Calculated quartiles times",{timeEvents:i})),i&&i.firstQuartile&&t.currentTime>=i.firstQuartile&&(Lt("FirstQuartile",n),delete i.firstQuartile,ns(n.callbacks,"firstQuartile")),i&&i.midPoint&&t.currentTime>=i.midPoint&&(Lt("MidPoint",n),delete i.midPoint,ns(n.callbacks,"midPoint")),i&&i.thirdQuartile&&t.currentTime>=i.thirdQuartile&&(Lt("ThirdQuartile",n),delete i.thirdQuartile,ns(n.callbacks,"thirdQuartile"))},stalled(){Lt("Stalled",n),s=setTimeout(()=>{r()},5e3)},canplay(){s&&clearTimeout(s)},error(){Lt("Error",n),r()},abort(){r()}};Object.keys(o).forEach(a=>t.addEventListener(a,o[a])),t.play()}),ns=(n,e)=>{if(n&&n[e])return Te.info("Ad","Sending beacon",e,n[e]),n[e].reduce((t,i)=>t.then(()=>fetch(i).then(s=>{s.status===200?Lt("Beacon"+e+"Sent"):Lt("Beacon"+e+"Failed"+s.status),Promise.resolve(null)}).catch(()=>{Promise.resolve(null)})),Promise.resolve(null));Te.info("Ad","No callback found for "+e)},Lt=(n,e)=>{eo&&(eo.fire("$ad"+n,e),eo.fire("$adEvent",n,e))},Lx={get(n,e){return n.enabled===!1?Promise.resolve({prerolls(){return Promise.resolve()}}):(eo=e,new Promise(t=>{Te.info("Ad","Starting session"),Ax().then(i=>{Te.info("Ad","API result",i),t({prerolls(){return i.preroll?(gr.active=!0,Lt("PrerollSlotImpression",i),ns(i.preroll.callbacks,"slotImpression"),Rx(i.preroll.ads).then(()=>{Lt("PrerollSlotEnd",i),ns(i.preroll.callbacks,"slotEnd"),gr.active=!1})):Promise.resolve()},midrolls(){return Promise.resolve()},postrolls(){return Promise.resolve()}})})}))},cancel(){Te.info("Ad","Cancel Ad"),gr.active=!1},stop(){Te.info("Ad","Stop Ad"),gr.active=!1;const n=document.getElementsByTagName("video")[0];n.pause(),n.removeAttribute("src")}};var Ea,Lc;function wx(){if(Lc)return Ea;Lc=1;var n=function(T){return e(T)&&!t(T)};function e(_){return!!_&&typeof _=="object"}function t(_){var T=Object.prototype.toString.call(_);return T==="[object RegExp]"||T==="[object Date]"||r(_)}var i=typeof Symbol=="function"&&Symbol.for,s=i?Symbol.for("react.element"):60103;function r(_){return _.$$typeof===s}function o(_){return Array.isArray(_)?[]:{}}function a(_,T){return T.clone!==!1&&T.isMergeableObject(_)?p(o(_),_,T):_}function l(_,T,S){return _.concat(T).map(function(v){return a(v,S)})}function h(_,T){if(!T.customMerge)return p;var S=T.customMerge(_);return typeof S=="function"?S:p}function c(_){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(_).filter(function(T){return Object.propertyIsEnumerable.call(_,T)}):[]}function u(_){return Object.keys(_).concat(c(_))}function d(_,T){try{return T in _}catch{return!1}}function f(_,T){return d(_,T)&&!(Object.hasOwnProperty.call(_,T)&&Object.propertyIsEnumerable.call(_,T))}function g(_,T,S){var v={};return S.isMergeableObject(_)&&u(_).forEach(function(E){v[E]=a(_[E],S)}),u(T).forEach(function(E){f(_,E)||(d(_,E)&&S.isMergeableObject(T[E])?v[E]=h(E,S)(_[E],T[E],S):v[E]=a(T[E],S))}),v}function p(_,T,S){S=S||{},S.arrayMerge=S.arrayMerge||l,S.isMergeableObject=S.isMergeableObject||n,S.cloneUnlessOtherwiseSpecified=a;var v=Array.isArray(T),E=Array.isArray(_),C=v===E;return C?v?S.arrayMerge(_,T,S):g(_,T,S):a(T,S)}p.all=function(T,S){if(!Array.isArray(T))throw new Error("first argument should be an array");return T.reduce(function(v,E){return p(v,E,S)},{})};var m=p;return Ea=m,Ea}wx();class Ub extends Ye.Component{static _template(){return{rect:!0,color:3137370284,h:40,w:100,x:e=>e-50,y:e=>e-50,mount:1,Text:{w:e=>e,h:e=>e,y:5,x:20,text:{fontSize:22,lineHeight:26}}}}_firstActive(){this.tag("Text").text=`APP - v${this.version}
SDK - v${this.sdkVersion}`,this.tag("Text").loadTexture(),this.w=this.tag("Text").renderWidth+40,this.h=this.tag("Text").renderHeight+5}}class Nb extends Ye.Component{static _template(){return{rect:!0,color:4294967295,texture:Ye.Tools.getRoundRect(80,80,40),h:80,w:80,x:100,y:100,mount:1,Background:{x:3,y:3,texture:Ye.Tools.getRoundRect(72,72,36),color:4278222848},Counter:{w:e=>e,h:e=>e,y:10,text:{fontSize:32,textAlign:"center"}},Text:{w:e=>e,h:e=>e,y:48,text:{fontSize:15,textAlign:"center",text:"FPS"}}}}_setup(){this.config={log:!1,interval:500,threshold:1,...It.get("platform","showFps")},this.fps=0,this.lastFps=this.fps-this.config.threshold;const e=()=>{this.fps=~~(1/this.stage.dt)};this.stage.on("frameStart",e),this.stage.off("framestart",e),this.interval=setInterval(this.showFps.bind(this),this.config.interval)}_firstActive(){this.showFps()}_detach(){clearInterval(this.interval)}showFps(){if(Math.abs(this.lastFps-this.fps)<=this.config.threshold)return;this.lastFps=this.fps;let e=4278222848;this.fps<=40&&this.fps>20?e=4294944e3:this.fps<=20&&(e=4294901760),this.tag("Background").setSmooth("color",e),this.tag("Counter").text=`${this.fps}`,this.config.log&&Te.info("FPS",this.fps)}}const oe={eventListeners:[],timeouts:[],intervals:[],targets:[]},Ix={setTimeout(n,e,...t){const i=setTimeout(()=>{oe.timeouts=oe.timeouts.filter(s=>s!==i),n.apply(null,t)},e,t);return Te.info("Set Timeout","ID: "+i),oe.timeouts.push(i),i},clearTimeout(n){oe.timeouts.indexOf(n)>-1?(oe.timeouts=oe.timeouts.filter(e=>e!==n),Te.info("Clear Timeout","ID: "+n),clearTimeout(n)):Te.error("Clear Timeout","ID "+n+" not found")},clearTimeouts(){oe.timeouts.forEach(n=>{this.clearTimeout(n)})},setInterval(n,e,...t){const i=setInterval(()=>{oe.intervals.filter(s=>s!==i),n.apply(null,t)},e,t);return Te.info("Set Interval","ID: "+i),oe.intervals.push(i),i},clearInterval(n){oe.intervals.indexOf(n)>-1?(oe.intervals=oe.intervals.filter(e=>e!==n),Te.info("Clear Interval","ID: "+n),clearInterval(n)):Te.error("Clear Interval","ID "+n+" not found")},clearIntervals(){oe.intervals.forEach(n=>{this.clearInterval(n)})},addEventListener(n,e,t){n.addEventListener(e,t);const i=oe.targets.indexOf(n)>-1?oe.targets.indexOf(n):oe.targets.push(n)-1;oe.eventListeners[i]=oe.eventListeners[i]||{},oe.eventListeners[i][e]=oe.eventListeners[i][e]||[],oe.eventListeners[i][e].push(t),Te.info("Add eventListener","Target:",n,"Event: "+e,"Handler:",t.toString())},removeEventListener(n,e,t){const i=oe.targets.indexOf(n);i>-1&&oe.eventListeners[i]&&oe.eventListeners[i][e]&&oe.eventListeners[i][e].indexOf(t)>-1?(oe.eventListeners[i][e]=oe.eventListeners[i][e].filter(s=>s!==t),Te.info("Remove eventListener","Target:",n,"Event: "+e,"Handler:",t.toString()),n.removeEventListener(e,t),Object.keys(oe.eventListeners[i]).forEach(s=>{oe.eventListeners[i][s].length===0&&delete oe.eventListeners[i][s]}),Object.keys(oe.eventListeners[i]).length===0&&(oe.targets.splice(i,1),oe.eventListeners.splice(i,1))):Te.error("Remove eventListener","Not found","Target",n,"Event: "+e,"Handler",t.toString())},removeEventListeners(n,e){if(n&&e){const t=oe.targets.indexOf(n);t>-1&&oe.eventListeners[t][e].forEach(i=>{this.removeEventListener(n,e,i)})}else if(n){const t=oe.targets.indexOf(n);t>-1&&Object.keys(oe.eventListeners[t]).forEach(i=>{this.removeEventListeners(n,i)})}else Object.keys(oe.eventListeners).forEach(t=>{this.removeEventListeners(oe.targets[t])})},clear(){this.clearTimeouts(),this.clearIntervals(),this.removeEventListeners(),oe.eventListeners=[],oe.timeouts=[],oe.intervals=[],oe.targets=[]}};let Px;class $b extends Ye.textures.ImageTexture{constructor(e){super(e),this._scalingOptions=void 0}set options(e){this.resizeMode=this._scalingOptions=e}_getLookupId(){return`${this._src}-${this._scalingOptions.type}-${this._scalingOptions.w}-${this._scalingOptions.h}`}getNonDefaults(){const e=super.getNonDefaults();return this._src&&(e.src=this._src),e}}const wc=["timeupdate","error","ended","loadeddata","canplay","play","playing","pause","loadstart","seeking","seeked","encrypted"];let Dx=n=>n;class zb extends Ye.Component{_construct(){this._skipRenderToTexture=!1,this._metrics=null,this._textureMode=It.get("platform","textureMode")||!1,Te.info("Texture mode: "+this._textureMode),console.warn(["The 'MediaPlayer'-plugin in the Lightning-SDK is deprecated and will be removed in future releases.","Please consider using the new 'VideoPlayer'-plugin instead.","https://rdkcentral.github.io/Lightning-SDK/#/plugins/videoplayer"].join(`

`))}static _template(){return{Video:{VideoWrap:{VideoTexture:{visible:!1,pivot:.5,texture:{type:Ye.textures.StaticTexture,options:{}}}}}}}set skipRenderToTexture(e){this._skipRenderToTexture=e}get textureMode(){return this._textureMode}get videoView(){return this.tag("Video")}_init(){const e=document.getElementsByTagName("video");e&&e.length>0?this.videoEl=e[0]:(this.videoEl=document.createElement("video"),this.videoEl.setAttribute("id","video-player"),this.videoEl.style.position="absolute",this.videoEl.style.zIndex="1",this.videoEl.style.display="none",this.videoEl.setAttribute("width","100%"),this.videoEl.setAttribute("height","100%"),this.videoEl.style.visibility=this.textureMode?"hidden":"visible",document.body.appendChild(this.videoEl)),this.textureMode&&!this._skipRenderToTexture&&this._createVideoTexture(),this.eventHandlers=[]}_registerListeners(){wc.forEach(e=>{const t=i=>{this._metrics&&this._metrics[e]&&typeof this._metrics[e]=="function"&&this._metrics[e]({currentTime:this.videoEl.currentTime}),this.fire(e,{videoElement:this.videoEl,event:i})};this.eventHandlers.push(t),this.videoEl.addEventListener(e,t)})}_deregisterListeners(){Te.info("Deregistering event listeners MediaPlayer"),wc.forEach((e,t)=>{this.videoEl.removeEventListener(e,this.eventHandlers[t])}),this.eventHandlers=[]}_attach(){this._registerListeners()}_detach(){this._deregisterListeners(),this.close()}_createVideoTexture(){const t=this.stage.gl,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.videoTexture.options={source:i,w:this.videoEl.width,h:this.videoEl.height}}_startUpdatingVideoTexture(){if(this.textureMode&&!this._skipRenderToTexture){const e=this.stage;this._updateVideoTexture||(this._updateVideoTexture=()=>{if(this.videoTexture.options.source&&this.videoEl.videoWidth&&this.active){const t=e.gl,i=new Date().getTime(),s=this.videoEl.webkitDecodedFrameCount;if(s?this._lastFrame!==s:this._lastTime<i-30){this._lastTime=i,this._lastFrame=s;try{t.bindTexture(t.TEXTURE_2D,this.videoTexture.options.source),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.videoEl),this._lastFrame=this.videoEl.webkitDecodedFrameCount,this.videoTextureView.visible=!0,this.videoTexture.options.w=this.videoEl.videoWidth,this.videoTexture.options.h=this.videoEl.videoHeight;const o=this.videoTextureView.w/this.videoTextureView.h,a=this.videoEl.videoWidth/this.videoEl.videoHeight;o>a?(this.videoTextureView.scaleX=a/o,this.videoTextureView.scaleY=1):(this.videoTextureView.scaleY=o/a,this.videoTextureView.scaleX=1)}catch(o){Te.error("texImage2d video",o),this._stopUpdatingVideoTexture(),this.videoTextureView.visible=!1}this.videoTexture.source.forceRenderUpdate()}}}),this._updatingVideoTexture||(e.on("frameStart",this._updateVideoTexture),this._updatingVideoTexture=!0)}}_stopUpdatingVideoTexture(){if(this.textureMode){const e=this.stage;if(e.removeListener("frameStart",this._updateVideoTexture),this._updatingVideoTexture=!1,this.videoTextureView.visible=!1,this.videoTexture.options.source){const t=e.gl;t.bindTexture(t.TEXTURE_2D,this.videoTexture.options.source),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT)}}}updateSettings(e={}){this._consumer=e.consumer,this._consumer&&this._consumer.getMediaplayerSettings&&(e=Object.assign(e,this._consumer.getMediaplayerSettings())),Ye.Utils.equalValues(this._stream,e.stream)||(e.stream&&e.stream.keySystem?navigator.requestMediaKeySystemAccess(e.stream.keySystem.id,e.stream.keySystem.config).then(t=>t.createMediaKeys()).then(t=>this.videoEl.setMediaKeys(t)).then(()=>{e.stream&&e.stream.src&&this.open(e.stream.src)}).catch(()=>{console.error("Failed to set up MediaKeys")}):e.stream&&e.stream.src?It.get("app","hls")?(window.Hls||(window.Hls=class{static isSupported(){return console.warn("hls-light not included"),!1}}),window.Hls.isSupported()&&(this._hls||(this._hls=new window.Hls({liveDurationInfinity:!0})),this._hls.loadSource(e.stream.src),this._hls.attachMedia(this.videoEl),this.videoEl.style.display="block")):this.open(e.stream.src):this.close(),this._stream=e.stream),this._setHide(e.hide),this._setVideoArea(e.videoPos)}_setHide(e){this.textureMode?this.tag("Video").setSmooth("alpha",e?0:1):this.videoEl.style.visibility=e?"hidden":"visible"}open(e,t={hide:!1,videoPosition:null}){if(e=Dx(e),this._metrics=uf.media(e),Te.info("Playing stream",e),this.application.noVideo){Te.info("noVideo option set, so ignoring: "+e);return}this.videoEl.getAttribute("src")===e&&this.close(),this.videoEl.setAttribute("src",e),this.videoEl.style.visibility="hidden",this.videoEl.style.display="none",setTimeout(()=>{this.videoEl.style.display="block",this.videoEl.style.visibility="visible"}),this._setHide(t.hide),this._setVideoArea(t.videoPosition||[0,0,1920,1080])}close(){this.videoEl.pause(),this.videoEl.removeAttribute("src"),this.videoEl.load(),this._clearSrc(),this.videoEl.style.display="none"}playPause(){this.isPlaying()?this.doPause():this.doPlay()}get muted(){return this.videoEl.muted}set muted(e){this.videoEl.muted=e}get loop(){return this.videoEl.loop}set loop(e){this.videoEl.loop=e}isPlaying(){return this._getState()==="Playing"}doPlay(){this.videoEl.play()}doPause(){this.videoEl.pause()}reload(){var e=this.videoEl.getAttribute("src");this.close(),this.videoEl.src=e}getPosition(){return Promise.resolve(this.videoEl.currentTime)}setPosition(e){this.videoEl.currentTime=e}getDuration(){return Promise.resolve(this.videoEl.duration)}seek(e,t=!1){t?this.videoEl.currentTime=e:this.videoEl.currentTime+=e}get videoTextureView(){return this.tag("Video").tag("VideoTexture")}get videoTexture(){return this.videoTextureView.texture}_setVideoArea(e){if(!Ye.Utils.equalValues(this._videoPos,e))if(this._videoPos=e,this.textureMode)this.videoTextureView.patch({smooth:{x:e[0],y:e[1],w:e[2]-e[0],h:e[3]-e[1]}});else{const t=this.stage.getRenderPrecision();this.videoEl.style.left=Math.round(e[0]*t)+"px",this.videoEl.style.top=Math.round(e[1]*t)+"px",this.videoEl.style.width=Math.round((e[2]-e[0])*t)+"px",this.videoEl.style.height=Math.round((e[3]-e[1])*t)+"px"}}_fireConsumer(e,t){this._consumer&&this._consumer.fire(e,t)}_equalInitData(e,t){if(!e||!t||e.byteLength!=t.byteLength)return!1;const i=new Int8Array(e),s=new Int8Array(t);for(let r=0;r!=e.byteLength;r++)if(i[r]!=s[r])return!1;return!0}error(e){return this._fireConsumer("$mediaplayerError",e),this._setState(""),""}loadeddata(e){this._fireConsumer("$mediaplayerLoadedData",e)}play(e){this._fireConsumer("$mediaplayerPlay",e)}playing(e){this._fireConsumer("$mediaplayerPlaying",e),this._setState("Playing")}canplay(e){this.videoEl.play(),this._fireConsumer("$mediaplayerStart",e)}loadstart(e){this._fireConsumer("$mediaplayerLoad",e)}seeked(){this._fireConsumer("$mediaplayerSeeked",{currentTime:this.videoEl.currentTime,duration:this.videoEl.duration||1})}seeking(){this._fireConsumer("$mediaplayerSeeking",{currentTime:this.videoEl.currentTime,duration:this.videoEl.duration||1})}durationchange(e){this._fireConsumer("$mediaplayerDurationChange",e)}encrypted(e){const t=e.videoElement,i=e.event;t.mediaKeys&&!this._equalInitData(this._previousInitData,i.initData)&&(this._previousInitData=i.initData,this._fireConsumer("$mediaplayerEncrypted",e))}static _states(){return[class extends this{$enter(){this._startUpdatingVideoTexture()}$exit(){this._stopUpdatingVideoTexture()}timeupdate(){this._fireConsumer("$mediaplayerProgress",{currentTime:this.videoEl.currentTime,duration:this.videoEl.duration||1})}ended(t){this._fireConsumer("$mediaplayerEnded",t),this._setState("")}pause(t){this._fireConsumer("$mediaplayerPause",t),this._setState("Playing.Paused")}_clearSrc(){this._fireConsumer("$mediaplayerStop",{}),this._setState("")}static _states(){return[class extends this{}]}}]}}const Ro=/\{\/(.*?)\/([igm]{0,3})\}/g,xh=/^[!*$]$/,Ic=/\/:\w+?@@([0-9]+?)@@/,Pc=/^\/:/,Zo=(n,e="R")=>(Ro.test(n)&&(n=n.replace(Ro,e)),n),Mx=n=>{const e=new Map;return[...Object.keys(n),...Object.getOwnPropertySymbols(n)].forEach(t=>{e.set(t,n[t])}),e};class Fx{constructor(e="",t,i){this._hash=e,this._storeCaller=i,this._register=new Map,this._isCreated=!1,this._isSharedInstance=!1,this._cancelled=!1,this._copiedHistoryState=null,Dt(t)?this._register=Mx(t):Yt(t)&&(this._storeCaller=t),this._register.set(ze.store,this._storeCaller)}cancel(){Te.debug("[router]:",`cancelled ${this._hash}`),this._cancelled=!0}get url(){return this._hash}get register(){return this._register}get hash(){return this._hash}set hash(e){this._hash=e}get route(){return this._route}set route(e){this._route=e}get provider(){return this._provider}set provider(e){this._provider=e}get providerType(){return this._providerType}set providerType(e){this._providerType=e}set page(e){this._page=e}get page(){return this._page}set isCreated(e){this._isCreated=e}get isCreated(){return this._isCreated}get isSharedInstance(){return this._isSharedInstance}set isSharedInstance(e){this._isSharedInstance=e}get isCancelled(){return this._cancelled}set copiedHistoryState(e){this._copiedHistoryState=e}get copiedHistoryState(){return this._copiedHistoryState}}class kx{constructor(e={}){let t=["on","before","after"].reduce((i,s)=>je(e[s])?s:i,void 0);this._cfg=e,t&&(this._provider={type:t,request:e[t]})}get path(){return this._cfg.path}get name(){return this._cfg.name}get component(){return this._cfg.component}get options(){return this._cfg.options}get widgets(){return this._cfg.widgets}get cache(){return this._cfg.cache}get hook(){return this._cfg.hook}get beforeNavigate(){return this._cfg.beforeNavigate}get provider(){return this._provider}}const yh=n=>Zo(n).split("/").length,Ox=n=>{const e=[];for(let[t]of ai.entries())yh(t)===n&&e.push(t);return e},Jo=n=>{n=n.replace(/^#/,"");const e=/(\/?:?[^/]+)/g,t=Ox(yh(n)),i=n.match(e)||[];let s=[],r=t.filter(o=>{let a=!0;if(Ro.test(o)){const h=o.match(Ro);h&&h.length&&(o=h.reduce((c,u)=>{const d=s.length;return c=c.replace(u,`@@${d}@@`),s.push(u.substring(1,u.length-1)),c},o))}const l=o.match(e)||[];for(let h=0,c=l.length;h<c;h++){const u=l[h],d=i[h];if(Ic.test(u)){const g=Ic.exec(u)[1],p=s[g],m=/\/([^\/]+)\/([igm]{0,3})/.exec(p);if(m&&m.length){const _=m[1],T=m[2];new RegExp(`^/${_}$`,T).test(d)||(a=!1)}}else{if(Pc.test(u))continue;d&&u.toLowerCase()!==d.toLowerCase()&&(a=!1)}}return a});if(r.length){if(r.indexOf(n)!==-1){const o=r[r.indexOf(n)];return ai.get(o)}else if(r=r.sort(o=>Pc.test(o)?-1:1),Wi(r[0]))return ai.get(r[0])}return!1},gf=(n="",e)=>{e=Zo(e,"");const t=/(\/?:?[\w%\s:.-]+)/g,i=n.match(t)||[],s=e.match(t)||[],r=/^\/:([\w-]+)\/?/;return s.reduce((o,a,l)=>{const h=r.exec(a);return h&&h.length&&o.set(h[1],decodeURIComponent(i[l].replace(/^\//,""))),o},new Map)},ea=(n,e)=>{if(n&&n.hasOwnProperty(e))return n[e]},Bx=n=>{if(n.path==="$"){let e={preventStorage:!0};Dt(n.options)&&(e={...n.options,...e}),n.options=e,wr&&(n.after=wr)}return new kx(n)},Ux=(n,e,t)=>new Fx(n,e,t),Nx=n=>{if(!n.to&&!n.name)return!1;const e=$x(n.to||n.name),t=/\/:([\w-]+)\/?/;let i=e;return t.test(e)&&(n.params&&(i=Object.keys(n.params).reduce((r,o)=>r.replace(`:${o}`,n.params[o]),e)),n.query)?`${i}${uy(n.query)}`:i},$x=n=>{for(let[e,t]of ai.entries())if(t.name===n)return e;return!1},zx=(n,e)=>{if(ps(n)){const s=ly();if(s.has(n))n=s.get(n);else return!1}const t=e.register,i=n.options;return t.has("keepAlive")?t.get("keepAlive"):i&&i.keepAlive?i.keepAlive:!1},Qs=(n,e=[],t={})=>{Eh(e)||(e=[e]),e.forEach(i=>{const s=`_on${If(i)}`;je(n[s])&&n[s](t)})};let us=null;const Gx=()=>{if(ds)return ds.get().reduce((n,e)=>{const t=e.ref.toLowerCase();return n[t]=e,n},{})},Hx=(n,e)=>{const t=(n||[]).map(i=>i.toLowerCase());ds.forEach(i=>{i.visible=t.indexOf(i.ref.toLowerCase())!==-1,i.visible&&Qs(i,["activated"],e)}),Le.state==="Widgets"&&us&&!us.visible&&Le._setState("")},Vx=n=>(n=If(n),ds.getByRef(n)||!1),Wx=n=>{const e=Vx(n);e&&(Yx(e),Le.state==="Widgets"?Le.reload(us):Le._setState("Widgets",[us]))},Dc=()=>{us=null,Le._setState("")},pf=()=>us,Yx=n=>{us=n},mf=(n,e)=>n.c({type:e,visible:!1,widgets:Gx()});let lt=[];const _f=n=>{const e=Zs();if(!e)return;const i=n.register.get(ze.store),s=Jo(e),r=ea(s.options,"preventStorage");if(Yt(i)?i:!r){const a=e.replace(/^\//,""),l=Co(a),h=jx(Gi(),n),c=wf();if(l===-1||c.get("storeSameHash"))lt.push({hash:a,state:h});else{const u=lt.splice(l,1)[0];lt.push({hash:u.hash,state:h})}}},Co=n=>{for(let e=0;e<lt.length;e++)if(lt[e].hash===n)return e;return-1},Kx=n=>{let e=null;return lt.length&&(n?Co(n)!==-1&&(e=lt[Co(n)].state):e=lt[lt.length-1].state),e},Xx=(n=null,e)=>{if(!lt.length)return;const t=e?Co(e):lt.length-1;t!==-1&&Dt(n)&&(lt[t].state=n)},jx=(n,e)=>{if(e.isSharedInstance){if(e.copiedHistoryState)return e.copiedHistoryState}else if(n&&je(n.historyState))return n.historyState();return null},xf=()=>lt.slice(0),ta=(n=[])=>{Eh(n)&&(lt=n)};let Mc,Le,oi,ia,bt,ds,yf,wr,Al=!0,Tf=async(n,e)=>!0,Sf=()=>{},ai=new Map,Gt=new Map,vf=!1,Th=null,Ef,Lo,bf,Af;const qx=n=>{n.pages&&(oi=n.pages.childList),n.widgets&&n.widgets.children&&(ds=n.widgets.childList,ds.forEach(e=>e.visible=!1)),n._handleBack=e=>{to(-1),e.preventDefault()}},Qx=(n,e)=>{let{appInstance:t,routes:i}=n;e&&Sh(e)&&(Le=e),Le||(Le=t||Px),Mc=Le.application,oi=Mc.childList,ia=Le.stage,bt=cy(),qx(Le),Eh(i)?Zx(n):je(i)&&(console.warn("[Router]: Calling Router.route() directly is deprecated."),console.warn("Use object config: https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration"))},Zx=n=>{vf||Jx(n),n.routes.forEach(e=>{const t=bh(e.path);if(Wi(t))console.error(`${t} already exists in routes configuration`);else{const i=Bx(e);if(ai.set(t,i),i.component){let s=i.component;vh(s)&&(bt.get("lazyCreate")||(s=mf(ia,s),oi.a(s))),Gt.set(t,s)}}})},Jx=n=>{yf=n.root,je(n.boot)&&(wr=n.boot),Yt(n.updateHash)&&(Al=n.updateHash),je(n.beforeEachRoute)&&(Tf=n.beforeEachRoute),je(n.afterEachRoute)&&(Sf=n.afterEachRoute),n.bootComponent&&(console.warn("[Router]: Boot Component is now available as a special router: https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration?id=special-routes"),console.warn("[Router]: setting { bootComponent } property will be deprecated in a future release"),Sh(n.bootComponent)?n.routes.push({path:"$",component:n.bootComponent,after:wr||null,options:{preventStorage:!0}}):console.error(`[Router]: ${n.bootComponent} is not a valid boot component`)),n.routes.forEach(e=>{const t=Zo(e.path);if(/.*\/:.*?\?$/u.test(t)){const s=e.path.substring(0,e.path.lastIndexOf("/")),r=e.path.substring(0,e.path.lastIndexOf("?"));e.path=r;let o={...e};o.path=s,n.routes.push(o)}}),vf=!0},sa=(n,e)=>{Gt.has(n)&&Gt.set(n,e)},Rf=n=>Gt.has(n)?Gt.get(n):null,ey=n=>{Gt.has(n)&&oi.getIndex(Gt.get(n))!==-1&&(oi.remove(Gt.get(n)),sa(n,Gt.get(n)._routedType||Gt.get(n).constructor))},Rl=()=>{if(!bt||!bt.size)return!1;const n=bt.get("updateHash");return!(Yt(n)&&!n||Yt(Al)&&!Al)},ty=n=>{const e=n.hash,t=n.route,i=n.register,s=n.page;ea(t.options,"clearHistory")?ta([]):e&&!xh.test(t.path)&&_f(n),sa(t.path,s),n.isSharedInstance||!n.isCreated?Qs(s,"changed"):n.isCreated&&Qs(s,"mounted"),ds&&Hx(t.widgets,s),Gi()&&!n.isSharedInstance&&iy(Th,n),i.get(ze.historyState)&&je(s.historyState)&&s.historyState(i.get(ze.historyState)),sy(s),Ef=n.hash,Lo=t.path;for(let r of pt.values())r.isCancelled&&r.hash&&pt.delete(r.hash);Sf(n),Te.info("[route]:",t.path),Te.info("[hash]:",e)},iy=(n,e)=>{const t=Lo,i=e.register,s=bt.get("lazyDestroy"),r=bt.get("destroyOnHistoryBack"),o=i.get("keepAlive"),a=i.get(ze.backtrack);let l=!1;a&&(r||s)&&(l=!0),s&&!o&&(l=!0),Lo===e.route.path&&(l=!0),l?(sa(t,n._routedType||n.constructor),oi.remove(n),bt.get("gcOnUnload")&&ia.gc()):n.patch({x:0,y:0,scale:1,visible:!1,alpha:1})},Zs=()=>Ef,sy=n=>{Th=n},Gi=()=>Th,Cl=()=>Lo,Cf=()=>bf,ry=n=>{bf=n},ny=n=>{Af=n},oy=()=>Af,Wi=n=>ai.has(n),Lf=()=>yf,ay=()=>wr,wf=()=>bt,ly=()=>ai,je=n=>typeof n=="function",Dt=n=>typeof n=="object"&&n!==null,Yt=n=>typeof n=="boolean",Sh=n=>!!(n instanceof Ye.Element||vh(n)),vh=n=>n.prototype&&"isComponent"in n.prototype,Eh=n=>Array.isArray(n),If=n=>`${n.charAt(0).toUpperCase()}${n.slice(1)}`,ps=n=>typeof n=="string",hy=n=>{let e;if(je(n))try{e=n.apply(null)}catch(t){e=t}else e=n;return Dt(e)&&je(e.then)},bh=(n="")=>n.replace(/^#/,"").replace(/\/+$/,""),cy=()=>{const n=It.get("platform","router"),e=Dt(n);return["backtrack","gcOnUnload","destroyOnHistoryBack","lazyCreate","lazyDestroy","reuseInstance","autoRestoreRemote","numberNavigation","updateHash","storeSameHash"].reduce((t,i)=>(t.set(i,e?n[i]:It.get("platform",i)),t),new Map)},Ah=(n=Zs())=>{const e=Dy();(n==="$"||!n)&&e&&ps(e)&&(n=e);let t="";const s=/([?&].*)/.exec(n),r={};if(document.location&&document.location.search&&(t=document.location.search),s&&s.length){let o=s[1];t?(o=o.replace(/^\?/,""),t=`${t}&${o}`):t=o}if(t){const o=new URLSearchParams(t);for(const[a,l]of o.entries())r[a]=l;return r}else return!1},uy=n=>Dt(n)?"?"+Object.keys(n).map(e=>`${e}=${n[e]}`).join("&"):"",ze={route:Symbol("route"),hash:Symbol("hash"),store:Symbol("store"),fromHistory:Symbol("fromHistory"),expires:Symbol("expires"),resume:Symbol("resume"),backtrack:Symbol("backtrack"),historyState:Symbol("historyState"),queryParams:Symbol("queryParams")},dy={on:n=>(ny(Le.state||""),Le._setState("Loading"),ba(n)),before:n=>ba(n),after:n=>{try{ba(n,!0)}catch{}return Promise.resolve()}},ba=(n,e)=>{const t=n.route,i=t.provider,s=t.cache?t.cache*1e3:0,r=Pf(n);return i.request(n.page,{...r}).then(()=>{n.page[ze.expires]=Date.now()+s,e&&Qs(n.page,"dataProvided")}).catch(o=>{throw n.page[ze.expires]=Date.now(),o})},Pf=({page:n,route:e,hash:t,register:i=new Map})=>{const s=gf(t,e.path),r=Ah(t),o=new Map([...s,...i]),a={};for(let[l,h]of o)a[l]=h;if(r&&(a[ze.queryParams]=r),i.size){const l={};for(let[h,c]of i)l[h]=c;n.persist=l}return n.params=a,Qs(n,["urlParams"],a),a},fy=n=>{if(!n[ze.expires])return!1;const e=n[ze.expires];return Date.now()>=e},Fc=n=>Wi(n)?!!ai.get(n).provider:!1,gy=n=>{if(Wi(n.path)){const{provider:e}=ai.get(n.path);return{type:e.type,provider:e.request}}},py=(n,e)=>new Promise(t=>{n.patch({alpha:0,visible:!0,smooth:{alpha:[1,{duration:.5,delay:.1}]}}),n.transition("alpha").on("finish",()=>{e&&(e.visible=!1),t()})}),my=(n,e)=>new Promise(t=>{n.patch({alpha:0,visible:!0,smooth:{alpha:[1,{duration:.5,delay:.1}]}}),e&&e.patch({smooth:{alpha:[0,{duration:.5,delay:.3}]}}),n.transition("alpha").on("finish",()=>{t()})}),ra=(n,e,t,i)=>{const s=n==="x"?1920:1080;return new Promise(r=>{t.patch({[`${n}`]:e?s*-1:s,visible:!0,smooth:{[`${n}`]:[0,{duration:.4,delay:.2}]}}),i&&i.patch({[`${n}`]:0,smooth:{[`${n}`]:[e?s:s*-1,{duration:.4,delay:.2}]}}),t.transition(n).on("finish",()=>{r()})})},_y=(n,e)=>ra("y",0,n,e),xy=(n,e)=>ra("y",1,n,e),yy=(n,e)=>ra("x",0,n,e),Ty=(n,e)=>ra("x",1,n,e),kc={fade:py,crossFade:my,up:_y,down:xy,left:yy,right:Ty},Sy=(n,e=null)=>{const t=n.pageTransition||n.easing,i=!!(n.smoothIn||n.smoothInOut||t),s=wf().get("disableTransitions");if(n.easing&&console.warn("easing() method is deprecated and will be removed. Use pageTransition()"),!i||s)return n.visible=!0,e&&(e.visible=!1),Promise.resolve();if(t){let r;try{r=t.call(n,n,e)}catch{r="crossFade"}if(hy(r))return r;if(ps(r)){const o=kc[r];if(o)return o(n,e)}if(n.smoothIn){const o=(a,l,h={})=>new Promise(c=>{n.visible=!0,n.setSmooth(a,l,h),n.transition(a).on("finish",()=>{c()})});return n.smoothIn({pageIn:n,smooth:o})}}return kc.crossFade(n,e)},Oc=async n=>{let e=!1;try{if(n=await vy(n),n&&!n.isCancelled?(Le.state==="Loading"&&(oy()==="Widgets"?Le._setState("Widgets",[pf()]):Le._setState("")),!n.isSharedInstance&&!n.isCancelled&&await Sy(n.page,Gi())):e=!0,e||n.isCancelled)Te.debug("[router]:",`Rejected ${n.hash} because route to ${Cf()} started`),n.isCreated&&!n.isSharedInstance&&oi.remove(n.page);else return ty(n),n.page}catch(t){if(!t.route)console.error(t);else if(!e){const{route:i}=t;ea(i.options,"clearHistory")?ta([]):xh.test(i.path)||_f(t),t.isCreated&&!t.isSharedInstance&&oi.remove(t.page),Ey(t)}}},vy=async n=>{const e=n.route,t=n.hash,i=n.register;let s=Rf(e.path),r=vh(s),o=!1;if(!r&&!i.get(ze.backtrack)&&(by(e)||(s=s.constructor,r=!0)),r)n.page=mf(ia,s),oi.a(n.page),Fc(e.path)&&(o=!0),n.isCreated=!0;else{n.page=s,Fc(e.path)&&(fy(s)||s[ze.hash]!==t)&&(o=!0);let a=Gi()&&Gi()[ze.route];e.path===a&&(n.isSharedInstance=!0,je(n.page.historyState)&&(n.copiedHistoryState=n.page.historyState()))}n.page[ze.hash]=t,n.page[ze.route]=e.path;try{if(o){const{type:a,provider:l}=gy(e);return n.provider=l,n.providerType=a,await dy[a](n),t!==Cf()?!1:(n.providerType!=="after"&&Qs(n.page,"dataProvided"),n)}else return Pf(n),n}catch(a){return n.error=a,Promise.reject(n)}},Ey=n=>{n&&n.error?console.error(n.error):n&&Te.error(n),n.page&&Wi("!")&&Oe("!",{request:n},!1)},by=n=>{const e=ea(n.options,"reuseInstance"),t=bt.get("reuseInstance");return Yt(e)?e:!(Yt(t)&&t===!1)};class Ay extends Ye.Component{static _template(){return{Pages:{forceZIndexContext:!0},Loading:{rect:!0,w:1920,h:1080,color:4278190080,visible:!1,zIndex:99,Label:{mount:.5,x:960,y:540,text:{text:"Loading.."}}}}}static _states(){return[class extends this{$enter(){this.tag("Loading").visible=!0}$exit(){this.tag("Loading").visible=!1}},class extends this{$enter(t,i){this._widget=i,this._refocus()}_getFocused(){return this._widget}reload(t){this._widget=t,this._refocus()}_handleKey(){const t=bt.get("autoRestoreRemote");(!Yt(t)||t===!0)&&Bc.focusPage()}}]}get pages(){return this.tag("Pages")}get widgets(){return this.tag("Widgets")}_handleBack(){}_getFocused(){return Bc.getActivePage()}}let pt=new Map,Aa="",ri="";const Ry=(n,e)=>{Qx(n,e),Fy(),Cy()},Cy=()=>{let n=(na()||"").replace(/^#/,"");const e="$",t=Ah(n),i=ay(),s=Lf(),r=n.indexOf(e)!==-1;xh.test(n)&&n!==e&&(n=""),ri=r?s:n||s;const o=()=>{!n&&s?ps(s)?Oe(s):je(s)&&s().then(a=>{Dt(a)?Oe(a.path,a.params):Oe(a)}):(wo(n),Io().then(()=>{Le._refocus()}).catch(a=>{console.error(a)}))};if(Wi(e)){if(n&&!r&&!Jo(n)){Oe("*",{failedHash:n});return}Oe(e,{resume:ri,reload:e===n},!1)}else je(i)?i(t).then(()=>{o()}).catch(a=>{Ly(a)}):o()},Ly=n=>{Wi("!")?Oe("!",{request:{error:n}}):console.error(n)},Oe=(n,e={},t)=>{if(Dt(n)&&(n=Nx(n),!n))return;let i=na();!Rl()&&Aa&&(i=Aa),i.replace(/^#/,"")!==n?(wo(n,e,t),Rl()?My(n):(Aa=n,Io(n).then(()=>{Le._refocus()}).catch(s=>{console.error(s)}))):e.reload&&(wo(n,e,t),Io(n).then(()=>{Le._refocus()}).catch(s=>{console.error(s)}))},wo=(n,e={},t)=>{if(n=bh(n),!pt.has(n)){for(let s of pt.values())s.cancel();const i=Ux(n,e,t);return pt.set(decodeURIComponent(n),i),i}return!1},Io=async n=>{const e=bh(n||na()),t=decodeURIComponent(e);let i=pt.get(t);!i&&!pt.size&&(i=wo(e));const s=Jo(e);if(!s){Wi("*")?Oe("*",{failedHash:e}):console.error(`Unable to navigate to: ${e}`);return}i.hash=e,i.route=s;let r=await Tf(Zs(),i);if(r&&s.beforeNavigate&&(r=await s.beforeNavigate(Zs(),i)),Yt(r)){if(r)return wy(i)}else if(i.cancel(),pt.delete(t),ps(r))Oe(r);else if(Dt(r)){let o=!0;Yt(r.store)&&(o=r.store),Oe(r.path,r.params,o)}},wy=n=>{const e=n.hash,t=n.route,i=decodeURIComponent(e);if(ry(e),t.path){const s=Rf(t.path);if(je(t.hook)){const r=gf(e,t.path),o={};for(const a of r.keys())o[a]=r.get(a);t.hook(Le,{...o})}if(s){const r=Gi();if(r){const o=zx(Cl(),n);r&&t.path===Cl()&&!o&&r._setState("")}Sh(s)?Oc(n).then(()=>{Le._refocus(),pt.delete(i)}):s().then(o=>o.default).then(o=>(sa(t.path,o),Oc(n))).then(()=>{Le._refocus(),pt.delete(i)})}else pt.delete(i)}},to=(n=0)=>{if(!n||isNaN(n))return!1;const e=xf();if(n=Math.abs(n),e.length){const t=e.splice(e.length-n,n)[0];return ta(e),Oe(t.hash,{[ze.backtrack]:!0,[ze.historyState]:t.state},!1)}else if(bt.get("backtrack")){const t=/(\/:?[\w%\s-]+)$/;let i=Zo(na()),s=yh(i);if(s>1){for(;s--;)if(i=i.replace(t,""),Jo(i))return Oe(i,{[ze.backtrack]:!0},!1)}}return n>e.length?je(Le._handleAppClose)?Le._handleAppClose():Le.application.closeApp():!1},Iy=()=>{ps(ri)?(Oe(ri,!1),ri=""):je(ri)?ri().then(n=>{ri="",Dt(n)?Oe(n.path,n.params):Oe(n)}):console.warn("[Router]: resume() called but no hash found")},Py=()=>{if(!Df()){const n=Zs();Oe(n,{reload:!0},!1)}},Df=()=>{if(pt.size){let n=!1;for(let e of pt.values())e.isCancelled||(n=!0);return n}return!1},Dy=()=>ri;let na=()=>document.location.hash,My=n=>{document.location.hash=n};const Fy=()=>{Ix.addEventListener(window,"hashchange",async()=>{if(Rl())try{await Io()}catch(n){console.error(n)}})},ky=()=>{const n=Lf();ps(n)?Oe(n):je(n)&&n().then(e=>{Dt(e)?Oe(e.path,e.params):Oe(e)})},Oy=n=>{ey(n)},Bc={startRouter:Ry,navigate:Oe,resume:Iy,step:to,go:to,back:to.bind(null,-1),activePage:Gi,getActivePage(){return Gi()},deletePage:Oy,getActiveRoute:Cl,getActiveHash:Zs,focusWidget:Wx,getActiveWidget:pf,restoreFocus:Dc,isNavigating:Df,getHistory:xf,setHistory:ta,getHistoryState:Kx,replaceHistoryState:Xx,getQueryStringParams:Ah,reload:Py,symbols:ze,App:Ay,focusPage:Dc,root:ky,setupRoutes(){console.warn("Router: setupRoutes is deprecated, consolidate your configuration"),console.warn("https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration")},on(){console.warn("Router.on() is deprecated, consolidate your configuration"),console.warn("https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration")},before(){console.warn("Router.before() is deprecated, consolidate your configuration"),console.warn("https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration")},after(){console.warn("Router.after() is deprecated, consolidate your configuration"),console.warn("https://rdkcentral.github.io/Lightning-SDK/#/plugins/router/configuration")}};class Kb extends Ye.Component{static _template(){return{visible:!1,rect:!0,color:2415919104,shader:{type:Ye.shaders.RoundedRectangle,radius:5},Text:{y:5,x:20,text:{textColor:4294967295,fontSize:38,lineHeight:38*1.4,textAlign:"center",wordWrap:!0,maxLines:3,shadow:!0,shadowColor:4281545523}}}}_init(){this._textTextureDefaults=new Ye.textures.TextTexture(this.stage).cloneArgs(),this.tag("Text").on("txLoaded",({_source:e})=>{this.w=e.w+this.tag("Text").x*2,this.h=e.h,this.position()})}get textFormat(){const e=this.tag("Text").text;return{fontFace:e.fontFace||"sans-serif",fontSize:e.fontSize,lineHeight:e.lineHeight,textAlign:e.textAlign,wordWrap:!0,maxLines:e.maxLines}}show(){this.visible=!0}hide(){this.visible=!1}position(){this.x=this._calculateX(this.xPos),this.y=this._calculateY(this.yPos)}set viewportW(e){this._viewportW=e,this.x=this._calculateX(this.xPos)}get viewportW(){return this._viewportW||this.application.finalW}set viewportH(e){this._viewportH=e,this.y=this._calculateY(this.yPos)}get viewportH(){return this._viewportH||this.application.finalH}_calculateX(e){return e==="center"?e=(this.viewportW-this.finalW)/2:e==="left"?e=60:e==="right"&&(e=this.viewportW-this.finalW-60),e}set xPos(e){this._x=e,this.x=this._calculateX(e)}get xPos(){return this._x||"center"}_calculateY(e){return e==="center"?(this.viewportH-this.finalH)/2:e==="top"?60:e==="bottom"?this.viewportH-this.finalH-60:e}set yPos(e){this._y=e,this.y=this._calculateY(e)}get yPos(){return this._y||"bottom"}set fontFamily(e){this.tag("Text").text.fontFace=e}set fontSize(e){this.tag("Text").text.fontSize=e,this.tag("Text").text.lineHeight=e*1.3}set fontColor(e){this.tag("Text").color=e}set backgroundColor(e){this.color=e}_defineBreakpoint(e,t){if(t>=this.maxWidth)return this.maxWidth;const i=Ye.textures.TextTexture.renderer(this.stage,this.stage.platform.getDrawingCanvas(),{...this._textTextureDefaults,...this.textFormat,wordWrapWidth:t,text:e})._calculateRenderInfo();return i.width<=t&&i.lines.length<=2?t:this._defineBreakpoint(e,t*1.25)}set text(e){if(this.alpha=0,e&&e.length){const t=this._defineBreakpoint(e,640);this.tag("Text").text.wordWrapWidth=t,this.tag("Text").text=e,this.alpha=1}}set textAlign(e){this._textAlign=e,this.tag("Text").text.textAlign=e}set maxWidth(e){this._maxWidth=e}get maxWidth(){return(this._maxWidth||1200)-this.tag("Text").x*2}set maxLines(e){this.tag("Text").text.maxLines=e}}const K=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},By=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=Uy},Uy=Number.MAX_SAFE_INTEGER||9007199254740991;let Z=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),D=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",n.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",n.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.ASSET_LIST_LOAD_ERROR="assetListLoadError",n.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",n.ASSET_LIST_PARSING_ERROR="assetListParsingError",n.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.ATTACH_MEDIA_ERROR="attachMediaError",n.UNKNOWN="unknown",n}({}),x=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.MEDIA_ENDED="hlsMediaEnded",n.STALL_RESOLVED="hlsStallResolved",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFERED_TO_END="hlsBufferedToEnd",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n.ASSET_LIST_LOADING="hlsAssetListLoading",n.ASSET_LIST_LOADED="hlsAssetListLoaded",n.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",n.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",n.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",n.INTERSTITIAL_STARTED="hlsInterstitialStarted",n.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",n.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",n.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",n.INTERSTITIAL_ENDED="hlsInterstitialEnded",n.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",n.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",n.EVENT_CUE_ENTER="hlsEventCueEnter",n}({});var fe={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},q={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class ys{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Ny{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new ys(e),this.fast_=new ys(t),this.defaultTTFB_=s,this.ttfb_=new ys(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new ys(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new ys(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new ys(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function $y(n,e,t){return(e=Gy(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Ee(){return Ee=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},Ee.apply(null,arguments)}function Uc(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function ye(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Uc(Object(t),!0).forEach(function(i){$y(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Uc(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function zy(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Gy(n){var e=zy(n,"string");return typeof e=="symbol"?e:e+""}class hi{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Di,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Di=function(){},Hy={trace:Di,debug:Di,log:Di,warn:Di,info:Di,error:Di};function Ll(){return Ee({},Hy)}function Vy(n,e){const t=self.console[n];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${n}] >`):Di}function Nc(n,e,t){return e[n]?e[n].bind(e):Vy(n,t)}const wl=Ll();function Wy(n,e,t){const i=Ll();if(typeof console=="object"&&n===!0||typeof n=="object"){const s=["debug","log","info","warn","error"];s.forEach(r=>{i[r]=Nc(r,n,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.5`)}catch{return Ll()}s.forEach(r=>{wl[r]=Nc(r,n)})}else Ee(wl,i);return i}const pe=wl;function Hi(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function Yy(n){return typeof self<"u"&&n===self.ManagedMediaSource}function Mf(n,e){const t=Object.keys(n),i=Object.keys(e),s=t.length,r=i.length;return!s||!r||s===r&&!t.some(o=>i.indexOf(o)===-1)}function mt(n,e=!1){if(typeof TextDecoder<"u"){const h=new TextDecoder("utf-8").decode(n);if(e){const c=h.indexOf("\0");return c!==-1?h.substring(0,c):h}return h.replace(/\0/g,"")}const t=n.length;let i,s,r,o="",a=0;for(;a<t;){if(i=n[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:s=n[a++],o+=String.fromCharCode((i&31)<<6|s&63);break;case 14:s=n[a++],r=n[a++],o+=String.fromCharCode((i&15)<<12|(s&63)<<6|(r&63)<<0);break}}return o}const Ut={hexDump:function(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function Ky(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Ra={exports:{}},$c;function Xy(){return $c||($c=1,function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(l,h,c){if(c=c||{},l=l.trim(),h=h.trim(),!h){if(!c.alwaysNormalize)return l;var u=a.parseURL(l);if(!u)throw new Error("Error trying to parse base URL.");return u.path=a.normalizePath(u.path),a.buildURLFromParts(u)}var d=a.parseURL(h);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return c.alwaysNormalize?(d.path=a.normalizePath(d.path),a.buildURLFromParts(d)):h;var f=a.parseURL(l);if(!f)throw new Error("Error trying to parse base URL.");if(!f.netLoc&&f.path&&f.path[0]!=="/"){var g=s.exec(f.path);f.netLoc=g[1],f.path=g[2]}f.netLoc&&!f.path&&(f.path="/");var p={scheme:f.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(p.netLoc=f.netLoc,d.path[0]!=="/"))if(!d.path)p.path=f.path,d.params||(p.params=f.params,d.query||(p.query=f.query));else{var m=f.path,_=m.substring(0,m.lastIndexOf("/")+1)+d.path;p.path=a.normalizePath(_)}return p.path===null&&(p.path=c.alwaysNormalize?a.normalizePath(d.path):d.path),a.buildURLFromParts(p)},parseURL:function(l){var h=i.exec(l);return h?{scheme:h[1]||"",netLoc:h[2]||"",path:h[3]||"",params:h[4]||"",query:h[5]||"",fragment:h[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(o,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};n.exports=a})()}(Ra)),Ra.exports}var Rh=Xy();class Ch{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Re={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Ff{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,qy(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let s;i.length===1?s=(t==null?void 0:t.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[Re.AUDIO]:null,[Re.VIDEO]:null,[Re.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new Ch),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Rh.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[Re.AUDIO]=null,e[Re.VIDEO]=null,e[Re.AUDIOVIDEO]=null}}function Ve(n){return n.sn!=="initSegment"}class Ca extends Ff{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],t=this.byteRange[1];if(K(e)&&K(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=K(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!K(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return Ve(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,o=!1){const{elementaryStreams:a}=this,l=a[e];if(!l){a[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:o};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}}class jy extends Ff{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function kf(n,e){const t=Object.getPrototypeOf(n);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||kf(t,e)}}function qy(n,e){const t=kf(n,e);t&&(t.enumerable=!0,Object.defineProperty(n,e,t))}const Po=Math.pow(2,32)-1,Qy=[].push,Of={video:1,audio:2,id3:3,text:4};function Ue(n){return String.fromCharCode.apply(null,n)}function Bf(n,e){const t=n[e]<<8|n[e+1];return t<0?65536+t:t}function ee(n,e){const t=Uf(n,e);return t<0?4294967296+t:t}function zc(n,e){let t=ee(n,e);return t*=Math.pow(2,32),t+=ee(n,e+4),t}function Uf(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function La(n,e,t){n[e]=t>>24,n[e+1]=t>>16&255,n[e+2]=t>>8&255,n[e+3]=t&255}function Zy(n){const e=n.byteLength;for(let t=0;t<e;){const i=ee(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function he(n,e){const t=[];if(!e.length)return t;const i=n.byteLength;for(let s=0;s<i;){const r=ee(n,s),o=Ue(n.subarray(s+4,s+8)),a=r>1?s+r:i;if(o===e[0])if(e.length===1)t.push(n.subarray(s+8,a));else{const l=he(n.subarray(s+8,a),e.slice(1));l.length&&Qy.apply(t,l)}s=a}return t}function Jy(n){const e=[],t=n[0];let i=8;const s=ee(n,i);i+=4;let r=0,o=0;t===0?(r=ee(n,i),o=ee(n,i+4),i+=8):(r=zc(n,i),o=zc(n,i+8),i+=16),i+=2;let a=n.length+o;const l=Bf(n,i);i+=2;for(let h=0;h<l;h++){let c=i;const u=ee(n,c);c+=4;const d=u&2147483647;if((u&2147483648)>>>31===1)return pe.warn("SIDX has hierarchical references (not supported)"),null;const g=ee(n,c);c+=4,e.push({referenceSize:d,subsegmentDuration:g,info:{duration:g/s,start:a,end:a+d-1}}),a+=d,c+=4,i=c}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:l,references:e}}function Nf(n){const e=[],t=he(n,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],o=he(r,["tkhd"])[0];if(o){let a=o[0];const l=ee(o,a===0?12:20),h=he(r,["mdia","mdhd"])[0];if(h){a=h[0];const c=ee(h,a===0?12:20),u=he(r,["mdia","hdlr"])[0];if(u){const d=Ue(u.subarray(8,12)),f={soun:Re.AUDIO,vide:Re.VIDEO}[d],g=he(r,["mdia","minf","stbl","stsd"])[0],p=eT(g);f?(e[l]={timescale:c,type:f,stsd:p},e[f]=ye({timescale:c,id:l},p)):e[l]={timescale:c,type:d,stsd:p}}}}}return he(n,["moov","mvex","trex"]).forEach(s=>{const r=ee(s,4),o=e[r];o&&(o.default={duration:ee(s,12),flags:ee(s,20)})}),e}function eT(n){const e=n.subarray(8),t=e.subarray(86),i=Ue(e.subarray(4,8));let s=i,r;const o=i==="enca"||i==="encv";if(o){const h=he(e,[i])[0].subarray(i==="enca"?28:78);he(h,["sinf"]).forEach(u=>{const d=he(u,["schm"])[0];if(d){const f=Ue(d.subarray(4,8));if(f==="cbcs"||f==="cenc"){const g=he(u,["frma"])[0];g&&(s=Ue(g))}}})}const a=s;switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const l=he(t,["avcC"])[0];l&&l.length>3&&(s+="."+Rn(l[1])+Rn(l[2])+Rn(l[3]),r=An(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=he(e,[i])[0],h=he(l.subarray(28),["esds"])[0];if(h&&h.length>7){let c=4;if(h[c++]!==3)break;c=wa(h,c),c+=2;const u=h[c++];if(u&128&&(c+=2),u&64&&(c+=h[c++]),h[c++]!==4)break;c=wa(h,c);const d=h[c++];if(d===64)s+="."+Rn(d);else break;if(c+=12,h[c++]!==5)break;c=wa(h,c);const f=h[c++];let g=(f&248)>>3;g===31&&(g+=1+((f&7)<<3)+((h[c]&224)>>5)),s+="."+g}break}case"hvc1":case"hev1":{const l=he(t,["hvcC"])[0];if(l&&l.length>12){const h=l[1],c=["","A","B","C"][h>>6],u=h&31,d=ee(l,2),f=(h&32)>>5?"H":"L",g=l[12],p=l.subarray(6,12);s+="."+c+u,s+="."+tT(d).toString(16).toUpperCase(),s+="."+f+g;let m="";for(let _=p.length;_--;){const T=p[_];(T||m)&&(m="."+T.toString(16).toUpperCase()+m)}s+=m}r=An(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{s=An(s,t)||s;break}case"vp09":{const l=he(t,["vpcC"])[0];if(l&&l.length>6){const h=l[4],c=l[5],u=l[6]>>4&15;s+="."+Bt(h)+"."+Bt(c)+"."+Bt(u)}break}case"av01":{const l=he(t,["av1C"])[0];if(l&&l.length>2){const h=l[1]>>>5,c=l[1]&31,u=l[2]>>>7?"H":"M",d=(l[2]&64)>>6,f=(l[2]&32)>>5,g=h===2&&d?f?12:10:d?10:8,p=(l[2]&16)>>4,m=(l[2]&8)>>3,_=(l[2]&4)>>2,T=l[2]&3;s+="."+h+"."+Bt(c)+u+"."+Bt(g)+"."+p+"."+m+_+T+"."+Bt(1)+"."+Bt(1)+"."+Bt(1)+"."+0,r=An("dav1",t)}break}}return{codec:s,encrypted:o,supplemental:r}}function An(n,e){const t=he(e,["dvvC"]),i=t.length?t[0]:he(e,["dvcC"])[0];if(i){const s=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return n+"."+Bt(s)+"."+Bt(r)}}function tT(n){let e=0;for(let t=0;t<32;t++)e|=(n>>t&1)<<31-t;return e>>>0}function wa(n,e){const t=e+5;for(;n[e++]&128&&e<t;);return e}function Rn(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Bt(n){return(n<10?"0":"")+n}function iT(n,e){if(!n||!e)return n;const t=e.keyId;return t&&e.isCommonEncryption&&he(n,["moov","trak"]).forEach(s=>{const o=he(s,["mdia","minf","stbl","stsd"])[0].subarray(8);let a=he(o,["enca"]);const l=a.length>0;l||(a=he(o,["encv"])),a.forEach(h=>{const c=l?h.subarray(28):h.subarray(78);he(c,["sinf"]).forEach(d=>{const f=$f(d);if(f){const g=f.subarray(8,24);g.some(p=>p!==0)||(pe.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${Ut.hexDump(g)} -> ${Ut.hexDump(t)}`),f.set(t,8))}})})}),n}function $f(n){const e=he(n,["schm"])[0];if(e){const t=Ue(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return he(n,["schi","tenc"])[0]}return null}function sT(n,e,t){const i={},s=he(n,["moof","traf"]);for(let r=0;r<s.length;r++){const o=s[r],a=he(o,["tfhd"])[0],l=ee(a,4),h=e[l];if(!h)continue;const c=i[l]||(i[l]={start:NaN,duration:0,sampleCount:0,timescale:h.timescale,type:h.type}),u=he(o,["tfdt"])[0];if(u){const S=u[0];let v=ee(u,4);S===1&&(v===Po?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(v*=Po+1,v+=ee(u,8))),K(v)&&(!K(c.start)||v<c.start)&&(c.start=v)}const d=h.default,f=ee(a,0)|(d==null?void 0:d.flags);let g=(d==null?void 0:d.duration)||0;f&8&&(f&2?g=ee(a,12):g=ee(a,8));const p=he(o,["trun"]);let m=c.start||0,_=0,T=g;for(let S=0;S<p.length;S++){const v=p[S],E=ee(v,4),C=c.sampleCount;c.sampleCount+=E;const b=v[3]&1,A=v[3]&4,L=v[2]&1,R=v[2]&2,M=v[2]&4,F=v[2]&8;let z=8,G=E;for(b&&(z+=4),A&&E&&(!(v[z+1]&1)&&c.keyFrameIndex===void 0&&(c.keyFrameIndex=C),z+=4,L?(T=ee(v,z),z+=4):T=g,R&&(z+=4),F&&(z+=4),m+=T,_+=T,G--);G--;)L?(T=ee(v,z),z+=4):T=g,R&&(z+=4),M&&(v[z+1]&1||c.keyFrameIndex===void 0&&(c.keyFrameIndex=c.sampleCount-(G+1),c.keyFrameStart=m),z+=4),F&&(z+=4),m+=T,_+=T;!_&&g&&(_+=g*E)}c.duration+=_}if(!Object.keys(i).some(r=>i[r].duration)){let r=1/0,o=0;const a=he(n,["sidx"]);for(let l=0;l<a.length;l++){const h=Jy(a[l]);if(h!=null&&h.references){r=Math.min(r,h.earliestPresentationTime/h.timescale);const c=h.references.reduce((u,d)=>u+d.info.duration||0,0);o=Math.max(o,c+h.earliestPresentationTime/h.timescale)}}o&&K(o)&&Object.keys(i).forEach(l=>{i[l].duration||(i[l].duration=o*i[l].timescale-i[l].start)})}return i}function rT(n,e,t){he(e,["moof","traf"]).forEach(i=>{he(i,["tfhd"]).forEach(s=>{const r=ee(s,4),o=n[r];if(!o)return;const a=o.timescale||9e4;he(i,["tfdt"]).forEach(l=>{const h=l[0],c=t*a;if(c){let u=ee(l,4);if(h===0)u-=c,u=Math.max(u,0),La(l,4,u);else{u*=Math.pow(2,32),u+=ee(l,8),u-=c,u=Math.max(u,0);const d=Math.floor(u/(Po+1)),f=Math.floor(u%(Po+1));La(l,4,d),La(l,8,f)}}})})})}function nT(n){const e={valid:null,remainder:null},t=he(n,["moof"]);if(t.length<2)return e.remainder=n,e;const i=t[t.length-1];return e.valid=n.slice(0,i.byteOffset-8),e.remainder=n.slice(i.byteOffset-8),e}function At(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Gc(n,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let o=!1;return he(i,["moof"]).map(l=>{const h=l.byteOffset-8;he(l,["traf"]).map(u=>{const d=he(u,["tfdt"]).map(f=>{const g=f[0];let p=ee(f,4);return g===1&&(p*=Math.pow(2,32),p+=ee(f,8)),p/s})[0];return d!==void 0&&(n=d),he(u,["tfhd"]).map(f=>{const g=ee(f,4),p=ee(f,0)&16777215,m=(p&1)!==0,_=(p&2)!==0,T=(p&8)!==0;let S=0;const v=(p&16)!==0;let E=0;const C=(p&32)!==0;let b=8;g===r&&(m&&(b+=8),_&&(b+=4),T&&(S=ee(f,b),b+=4),v&&(E=ee(f,b),b+=4),C&&(b+=4),e.type==="video"&&(o=oa(e.codec)),he(u,["trun"]).map(A=>{const L=A[0],R=ee(A,0)&16777215,M=(R&1)!==0;let F=0;const z=(R&4)!==0,G=(R&256)!==0;let k=0;const I=(R&512)!==0;let O=0;const V=(R&1024)!==0,B=(R&2048)!==0;let U=0;const Y=ee(A,4);let W=8;M&&(F=ee(A,W),W+=4),z&&(W+=4);let Q=F+h;for(let te=0;te<Y;te++){if(G?(k=ee(A,W),W+=4):k=S,I?(O=ee(A,W),W+=4):O=E,V&&(W+=4),B&&(L===0?U=ee(A,W):U=Uf(A,W),W+=4),e.type===Re.VIDEO){let re=0;for(;re<O;){const J=ee(i,Q);if(Q+=4,oT(o,i[Q])){const me=i.subarray(Q,Q+J);Lh(me,o?2:1,n+U/s,t)}Q+=J,re+=J+4}}n+=k/s}}))})})}),t}function oa(n){if(!n)return!1;const e=n.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function oT(n,e){if(n){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Lh(n,e,t,i){const s=zf(n);let r=0;r+=e;let o=0,a=0,l=0;for(;r<s.length;){o=0;do{if(r>=s.length)break;l=s[r++],o+=l}while(l===255);a=0;do{if(r>=s.length)break;l=s[r++],a+=l}while(l===255);const h=s.length-r;let c=r;if(a<h)r+=a;else if(a>h){pe.error(`Malformed SEI payload. ${a} is too small, only ${h} bytes left to parse.`);break}if(o===4){if(s[c++]===181){const d=Bf(s,c);if(c+=2,d===49){const f=ee(s,c);if(c+=4,f===1195456820){const g=s[c++];if(g===3){const p=s[c++],m=31&p,_=64&p,T=_?2+m*3:0,S=new Uint8Array(T);if(_){S[0]=p;for(let v=1;v<T;v++)S[v]=s[c++]}i.push({type:g,payloadType:o,pts:t,bytes:S})}}}}}else if(o===5&&a>16){const u=[];for(let g=0;g<16;g++){const p=s[c++].toString(16);u.push(p.length==1?"0"+p:p),(g===3||g===5||g===7||g===9)&&u.push("-")}const d=a-16,f=new Uint8Array(d);for(let g=0;g<d;g++)f[g]=s[c++];i.push({payloadType:o,pts:t,uuid:u.join(""),userData:mt(f),userDataBytes:f})}}}function zf(n){const e=n.byteLength,t=[];let i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;const s=e-t.length,r=new Uint8Array(s);let o=0;for(i=0;i<s;o++,i++)o===t[0]&&(o++,t.shift()),r[i]=n[o];return r}function aT(n){const e=n[0];let t="",i="",s=0,r=0,o=0,a=0,l=0,h=0;if(e===0){for(;Ue(n.subarray(h,h+1))!=="\0";)t+=Ue(n.subarray(h,h+1)),h+=1;for(t+=Ue(n.subarray(h,h+1)),h+=1;Ue(n.subarray(h,h+1))!=="\0";)i+=Ue(n.subarray(h,h+1)),h+=1;i+=Ue(n.subarray(h,h+1)),h+=1,s=ee(n,12),r=ee(n,16),a=ee(n,20),l=ee(n,24),h=28}else if(e===1){h+=4,s=ee(n,h),h+=4;const u=ee(n,h);h+=4;const d=ee(n,h);for(h+=4,o=2**32*u+d,By(o)||(o=Number.MAX_SAFE_INTEGER,pe.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=ee(n,h),h+=4,l=ee(n,h),h+=4;Ue(n.subarray(h,h+1))!=="\0";)t+=Ue(n.subarray(h,h+1)),h+=1;for(t+=Ue(n.subarray(h,h+1)),h+=1;Ue(n.subarray(h,h+1))!=="\0";)i+=Ue(n.subarray(h,h+1)),h+=1;i+=Ue(n.subarray(h,h+1)),h+=1}const c=n.subarray(h,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:l,payload:c}}function lT(n,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function hT(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const o=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),lT([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,o,t||new Uint8Array)}function cT(n){const e=[];if(n instanceof ArrayBuffer){const t=n.byteLength;let i=0;for(;i+32<t;){const s=new DataView(n,i),r=uT(s);e.push(r),i+=r.size}}return e}function uT(n){const e=n.getUint32(0),t=n.byteOffset,i=n.byteLength;if(i<e)return{offset:t,size:i};if(n.getUint32(4)!==1886614376)return{offset:t,size:e};const r=n.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const o=n.buffer,a=Ut.hexDump(new Uint8Array(o,t+12,16)),l=n.getUint32(28);let h=null,c=null;if(r===0){if(e-32<l||l<22)return{offset:t,size:e};c=new Uint8Array(o,t+32,l)}else if(r===1){if(!l||i<t+32+l*16+16)return{offset:t,size:e};h=[];for(let u=0;u<l;u++)h.push(new Uint8Array(o,t+32+u*16,16))}return{version:r,systemId:a,kids:h,data:c,offset:t,size:e}}const Gf=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Js={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Hf(n,e){const t=Js[e];return!!t&&!!t[n.slice(0,4)]}function Il(n,e,t=!0){return!n.split(",").some(i=>!Vf(i,e,t))}function Vf(n,e,t=!0){var i;const s=Hi(t);return(i=s==null?void 0:s.isTypeSupported(Ir(n,e)))!=null?i:!1}function Ir(n,e){return`${e}/mp4;codecs=${n}`}function Hc(n){if(n){const e=n.substring(0,4);return Js.video[e]}return 2}function Do(n){const e=Gf();return n.split(",").reduce((t,i)=>{const r=e&&oa(i)?9:Js.video[i];return r?(r*2+t)/(t?3:2):(Js.audio[i]+t)/(t?2:1)},0)}const Ia={};function dT(n,e=!0){if(Ia[n])return Ia[n];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[n];for(let s=0;s<t.length;s++){var i;if(Vf(t[s],"audio",e))return Ia[n]=t[s],t[s];if(t[s]==="mp3"&&(i=Hi(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return n}const fT=/flac|opus|mp4a\.40\.34/i;function Mo(n,e=!0){return n.replace(fT,t=>dT(t.toLowerCase(),e))}function gT(n,e){const t=[];if(n){const i=n.split(",");for(let s=0;s<i.length;s++)Hf(i[s],"video")||t.push(i[s])}return e&&t.push(e),t.join(",")}function io(n,e){if(n&&(n.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(n)!==-1))return n;if(e){const t=e.split(",");if(t.length>1){if(n){for(let i=t.length;i--;)if(t[i].substring(0,4)===n.substring(0,4))return t[i]}return t[0]}}return e||n}function pT(n){const e=n.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function mT(n){if(n.startsWith("av01.")){const e=n.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return n}function Vc(n){const e=Hi(n)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Wf(n){return n.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Yf={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function Kf(n,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:n}}const Wc={};function _T(n,e,t,i,s,r){const o=n.audioCodec?n.audioGroups:null,a=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,h=l?parseInt(l):a?1/0:2;let c=null;if(o!=null&&o.length)try{o.length===1&&o[0]?c=e.groups[o[0]].channels:c=o.reduce((u,d)=>{if(d){const f=e.groups[d];if(!f)throw new Error(`Audio track group ${d} not found`);Object.keys(f.channels).forEach(g=>{u[g]=(u[g]||0)+f.channels[g]})}return u},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!c&&K(h)&&Object.keys(c).some(u=>parseInt(u)>h)}function Xf(n,e,t){const i=n.videoCodec,s=n.audioCodec;if(!i&&!s||!t)return Promise.resolve(Yf);const r=[];if(i){const o={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(o.transferFunction=a.toLowerCase());const l=i.split(","),h=navigator.userAgent;if(l.some(c=>oa(c))&&Gf())return Promise.resolve(Kf(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${h})`),r));r.push.apply(r,l.map(c=>({type:"media-source",video:ye(ye({},o),{},{contentType:Ir(mT(c),"video")})})))}return s&&n.audioGroups&&n.audioGroups.forEach(o=>{var a;o&&((a=e.groups[o])==null||a.tracks.forEach(l=>{if(l.groupId===o){const h=l.channels||"",c=parseFloat(h);K(c)&&c>2&&r.push.apply(r,s.split(",").map(u=>({type:"media-source",audio:{contentType:Ir(u,"audio"),channels:""+c}})))}}))}),Promise.all(r.map(o=>{const a=xT(o);return Wc[a]||(Wc[a]=t.decodingInfo(o))})).then(o=>({supported:!o.some(a=>!a.supported),configurations:r,decodingInfoResults:o})).catch(o=>({supported:!1,configurations:r,decodingInfoResults:[],error:o}))}function xT(n){const{audio:e,video:t}=n,i=t||e;if(i){const s=Wf(i.contentType);if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${s}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${s}`}return""}const Pl=["NONE","TYPE-0","TYPE-1",null];function yT(n){return Pl.indexOf(n)>-1}const Fo=["SDR","PQ","HLG"];function TT(n){return!!n&&Fo.indexOf(n)>-1}var so={No:"",Yes:"YES",v2:"v2"};function Yc(n){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=n,s=i<e/2;return e&&s?t?so.v2:so.Yes:so.No}class Kc{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Pr{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Xc(this._audioGroups,e)}hasSubtitleGroup(e){return Xc(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function Xc(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function ST(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function vT(n,e){let t=!1,i=[];if(n&&(t=n!=="SDR",i=[n]),e){i=e.allowedVideoRanges||Fo.slice(0);const s=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:s&&ST(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const ET=n=>{const e=new WeakSet;return(t,i)=>{if(n&&(i=n(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},we=(n,e)=>JSON.stringify(n,ET(e));function bT(n,e,t,i,s){const r=Object.keys(n),o=i==null?void 0:i.channels,a=i==null?void 0:i.audioCodec,l=s==null?void 0:s.videoCodec,h=o&&parseInt(o)===2;let c=!1,u=!1,d=1/0,f=1/0,g=1/0,p=1/0,m=0,_=[];const{preferHDR:T,allowedVideoRanges:S}=vT(e,s);for(let A=r.length;A--;){const L=n[r[A]];c||(c=L.channels[2]>0),d=Math.min(d,L.minHeight),f=Math.min(f,L.minFramerate),g=Math.min(g,L.minBitrate),S.filter(M=>L.videoRanges[M]>0).length>0&&(u=!0)}d=K(d)?d:0,f=K(f)?f:0;const v=Math.max(1080,d),E=Math.max(30,f);g=K(g)?g:t,t=Math.max(g,t),u||(e=void 0);const C=r.length>1;return{codecSet:r.reduce((A,L)=>{const R=n[L];if(L===A)return A;if(_=u?S.filter(M=>R.videoRanges[M]>0):[],C){if(R.minBitrate>t)return Ot(L,`min bitrate of ${R.minBitrate} > current estimate of ${t}`),A;if(!R.hasDefaultAudio)return Ot(L,"no renditions with default or auto-select sound found"),A;if(a&&L.indexOf(a.substring(0,4))%5!==0)return Ot(L,`audio codec preference "${a}" not found`),A;if(o&&!h){if(!R.channels[o])return Ot(L,`no renditions with ${o} channel sound found (channels options: ${Object.keys(R.channels)})`),A}else if((!a||h)&&c&&R.channels[2]===0)return Ot(L,"no renditions with stereo sound found"),A;if(R.minHeight>v)return Ot(L,`min resolution of ${R.minHeight} > maximum of ${v}`),A;if(R.minFramerate>E)return Ot(L,`min framerate of ${R.minFramerate} > maximum of ${E}`),A;if(!_.some(M=>R.videoRanges[M]>0))return Ot(L,`no variants with VIDEO-RANGE of ${we(_)} found`),A;if(l&&L.indexOf(l.substring(0,4))%5!==0)return Ot(L,`video codec preference "${l}" not found`),A;if(R.maxScore<m)return Ot(L,`max score of ${R.maxScore} < selected max of ${m}`),A}return A&&(Do(L)>=Do(A)||R.fragmentError>n[A].fragmentError)?A:(p=R.minIndex,m=R.maxScore,L)},void 0),videoRanges:_,preferHDR:T,minFramerate:f,minBitrate:g,minIndex:p}}function Ot(n,e){pe.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function jf(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function AT(n,e,t,i){return n.slice(t,i+1).reduce((s,r,o)=>{if(!r.codecSet)return s;const a=r.audioGroups;let l=s[r.codecSet];l||(s[r.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,r.bitrate);const h=Math.min(r.height,r.width);return l.minHeight=Math.min(l.minHeight,h),l.minFramerate=Math.min(l.minFramerate,r.frameRate),l.minIndex=Math.min(l.minIndex,o),l.maxScore=Math.max(l.maxScore,r.score),l.fragmentError+=r.fragmentError,l.videoRanges[r.videoRange]=(l.videoRanges[r.videoRange]||0)+1,a&&a.forEach(c=>{if(!c)return;const u=e.groups[c];u&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(u.channels).forEach(d=>{l.channels[d]=(l.channels[d]||0)+u.channels[d]}))}),s},{})}function jc(n){if(!n)return n;const{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}=n;return{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}}function Vt(n,e,t){if("attrs"in n){const i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){const s=e[i];if(cs(n,s,t))return i}return-1}function cs(n,e,t){const{groupId:i,name:s,lang:r,assocLang:o,default:a}=n,l=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||RT(r,e.lang))&&(r===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(l===void 0||e.forced===l)&&(!("characteristics"in n)||CT(n.characteristics||"",e.characteristics))&&(t===void 0||t(n,e))}function RT(n,e="--"){return n.length===e.length?n===e:n.startsWith(e)||e.startsWith(n)}function CT(n,e=""){const t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function ts(n,e){const{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function LT(n,e,t,i,s){const r=e[i],a=e.reduce((d,f,g)=>{const p=f.uri;return(d[p]||(d[p]=[])).push(g),d},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const l=r.videoRange,h=r.frameRate,c=r.codecSet.substring(0,4),u=qc(e,i,d=>{if(d.videoRange!==l||d.frameRate!==h||d.codecSet.substring(0,4)!==c)return!1;const f=d.audioGroups,g=t.filter(p=>!f||f.indexOf(p.groupId)!==-1);return Vt(n,g,s)>-1});return u>-1?u:qc(e,i,d=>{const f=d.audioGroups,g=t.filter(p=>!f||f.indexOf(p.groupId)!==-1);return Vt(n,g,s)>-1})}function qc(n,e,t){for(let i=e;i>-1;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}function ko(n,e){var t;return!!n&&n!==((t=e.loadLevelObj)==null?void 0:t.uri)}class wT extends hi{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:s,partCurrent:r,hls:o}=this,{autoLevelEnabled:a,media:l}=o;if(!s||!l)return;const h=performance.now(),c=r?r.stats:s.stats,u=r?r.duration:s.duration,d=h-c.loading.start,f=o.minAutoLevel,g=s.level,p=this._nextAutoLevel;if(c.aborted||c.loaded&&c.loaded===c.total||g<=f){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const m=p>-1&&p!==g,_=!!t||m;if(!_&&(l.paused||!l.playbackRate||!l.readyState))return;const T=o.mainForwardBufferInfo;if(!_&&T===null)return;const S=this.bwEstimator.getEstimateTTFB(),v=Math.abs(l.playbackRate);if(d<=Math.max(S,1e3*(u/(v*2))))return;const E=T?T.len/v:0,C=c.loading.first?c.loading.first-c.loading.start:-1,b=c.loaded&&C>-1,A=this.getBwEstimate(),L=o.levels,R=L[g],M=Math.max(c.loaded,Math.round(u*(s.bitrate||R.averageBitrate)/8));let F=b?d-C:d;F<1&&b&&(F=Math.min(d,c.loaded*8/A));const z=b?c.loaded*1e3/F:0,G=S/1e3,k=z?(M-c.loaded)/z:M*8/A+G;if(k<=E)return;const I=z?z*8:A,O=((i=(t==null?void 0:t.details)||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,V=this.hls.config.abrBandWidthUpFactor;let B=Number.POSITIVE_INFINITY,U;for(U=g-1;U>f;U--){const te=L[U].maxBitrate,re=!L[U].details||O;if(B=this.getTimeToLoadFrag(G,I,u*te,re),B<Math.min(E,u+G))break}if(B>=k||B>u*10)return;b?this.bwEstimator.sample(d-Math.min(S,C),c.loaded):this.bwEstimator.sampleTTFB(d);const Y=L[U].maxBitrate;this.getBwEstimate()*V>Y&&this.resetEstimator(Y);const W=this.findBestLevel(Y,f,U,0,E,1,1);W>-1&&(U=W),this.warn(`Fragment ${s.sn}${r?" part "+r.index:""} of level ${g} is loading too slowly;
      Fragment duration: ${s.duration.toFixed(3)}
      Time to underbuffer: ${E.toFixed(3)} s
      Estimated load time for current fragment: ${k.toFixed(3)} s
      Estimated load time for down switch fragment: ${B.toFixed(3)} s
      TTFB estimate: ${C|0} ms
      Current BW estimate: ${K(A)?A|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${U} @ ${Y|0} bps`),o.nextLoadLevel=o.nextAutoLevel=U,this.clearTimer();const Q=()=>{if(this.clearTimer(),this.fragCurrent===s&&this.hls.loadLevel===U&&U>0){const te=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${U>0?"and switching down":""}
      Fragment duration: ${s.duration.toFixed(3)} s
      Time to underbuffer: ${te.toFixed(3)} s`),s.abortRequests(),this.fragCurrent=this.partCurrent=null,U>f){let re=this.findBestLevel(this.hls.levels[f].bitrate,f,U,0,te,1,1);re===-1&&(re=f),this.hls.nextLoadLevel=this.hls.nextAutoLevel=re,this.resetEstimator(this.hls.levels[re].bitrate)}}};m||k>B*2?Q():this.timer=self.setInterval(Q,B*1e3),o.trigger(x.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:r,stats:c})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new Ny(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.FRAG_LOADING,this.onFragLoading,this),e.on(x.FRAG_LOADED,this.onFragLoaded,this),e.on(x.FRAG_BUFFERED,this.onFragBuffered,this),e.on(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(x.LEVEL_LOADED,this.onLevelLoaded,this),e.on(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(x.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.FRAG_LOADING,this.onFragLoading,this),e.off(x.FRAG_LOADED,this.onFragLoaded,this),e.off(x.FRAG_BUFFERED,this.onFragBuffered,this),e.off(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(x.LEVEL_LOADED,this.onLevelLoaded,this),e.off(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(x.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(x.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case D.BUFFER_ADD_CODEC_ERROR:case D.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case D.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const o=performance.now(),a=r?r.stats:i.stats,l=o-a.loading.start,h=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&h>-1){const u=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(u,h),a.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,o=s?e+this.lastLevelLoadSec:0;return r+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:s}=t.stats,r=s.end-s.first;K(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===q.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+s.loaded,l=(o.loaded?o.loaded.duration:0)+r;o.loaded={bytes:a,duration:l},o.realBitrate=Math.round(8*a/l)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(x.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const o=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==q.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,r)&&o[e].loadError<=o[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:s,config:r,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),h=this.getStarvationDelay();let c=r.abrBandWidthFactor,u=r.abrBandWidthUpFactor;if(h){const m=this.findBestLevel(l,o,s,h,0,c,u);if(m>=0)return this.rebufferNotice=-1,m}let d=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!h){const m=this.bitrateTestDelay;m&&(d=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-m,this.info(`bitrate test took ${Math.round(1e3*m)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),c=u=1)}const f=this.findBestLevel(l,o,s,h,d,c,u);if(this.rebufferNotice!==f&&(this.rebufferNotice=f,this.info(`${h?"rebuffering expected":"buffer is empty"}, optimal quality level ${f}`)),f>-1)return f;const g=i.levels[o],p=i.loadLevelObj;return p&&(g==null?void 0:g.bitrate)<p.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,s=e.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,o,a){var l;const h=s+r,c=this.lastLoadedFragLevel,u=c===-1?this.hls.firstLevel:c,{fragCurrent:d,partCurrent:f}=this,{levels:g,allAudioTracks:p,loadLevel:m,config:_}=this.hls;if(g.length===1)return 0;const T=g[u],S=!!((l=this.hls.latestLevelDetails)!=null&&l.live),v=m===-1||c===-1;let E,C="SDR",b=(T==null?void 0:T.frameRate)||0;const{audioPreference:A,videoPreference:L}=_,R=this.audioTracksByGroup||(this.audioTracksByGroup=jf(p));let M=-1;if(v){if(this.firstSelection!==-1)return this.firstSelection;const I=this.codecTiers||(this.codecTiers=AT(g,R,t,i)),O=bT(I,C,e,A,L),{codecSet:V,videoRanges:B,minFramerate:U,minBitrate:Y,minIndex:W,preferHDR:Q}=O;M=W,E=V,C=Q?B[B.length-1]:B[0],b=U,e=Math.max(e,Y),this.log(`picked start tier ${we(O)}`)}else E=T==null?void 0:T.codecSet,C=T==null?void 0:T.videoRange;const F=f?f.duration:d?d.duration:0,z=this.bwEstimator.getEstimateTTFB()/1e3,G=[];for(let I=i;I>=t;I--){var k;const O=g[I],V=I>u;if(!O)continue;if(_.useMediaCapabilities&&!O.supportedResult&&!O.supportedPromise){const re=navigator.mediaCapabilities;typeof(re==null?void 0:re.decodingInfo)=="function"&&(_T(O,R,C,b,e,A)||oa(O.videoCodec))?(O.supportedPromise=Xf(O,R,re),O.supportedPromise.then(J=>{if(!this.hls)return;O.supportedResult=J;const me=this.hls.levels,ge=me.indexOf(O);J.error?this.warn(`MediaCapabilities decodingInfo error: "${J.error}" for level ${ge} ${we(J)}`):J.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${ge} ${we(J)}`),ge>-1&&me.length>1&&(this.log(`Removing unsupported level ${ge}`),this.hls.removeLevel(ge),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):O.supportedResult=Yf}if((E&&O.codecSet!==E||C&&O.videoRange!==C||V&&b>O.frameRate||!V&&b>0&&b<O.frameRate||O.supportedResult&&!((k=O.supportedResult.decodingInfoResults)!=null&&k[0].smooth))&&(!v||I!==M)){G.push(I);continue}const B=O.details,U=(f?B==null?void 0:B.partTarget:B==null?void 0:B.averagetargetduration)||F;let Y;V?Y=a*e:Y=o*e;const W=F&&s>=F*2&&r===0?O.averageBitrate:O.maxBitrate,Q=this.getTimeToLoadFrag(z,Y,W*U,B===void 0);if(Y>=W&&(I===c||O.loadError===0&&O.fragmentError===0)&&(Q<=z||!K(Q)||S&&!this.bitrateTestDelay||Q<h)){const re=this.forcedAutoLevel;return I!==m&&(re===-1||re!==m)&&(G.length&&this.trace(`Skipped level(s) ${G.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${g[G[0]].codecs}" ${g[G[0]].videoRange}; not compatible with "${E}" ${C}`),this.info(`switch candidate:${u}->${I} adjustedbw(${Math.round(Y)})-bitrate=${Math.round(Y-W)} ttfb:${z.toFixed(1)} avgDuration:${U.toFixed(1)} maxFetchDuration:${h.toFixed(1)} fetchDuration:${Q.toFixed(1)} firstSelection:${v} codecSet:${O.codecSet} videoRange:${O.videoRange} hls.loadLevel:${m}`)),v&&(this.firstSelection=I),I}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const qf={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];const o=e(r);if(o>0)t=s+1;else if(o<0)i=s-1;else return r}return null}};function IT(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!K(e))return null;const i=n[0].programDateTime;if(e<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;for(let r=0;r<n.length;++r){const o=n[r];if(DT(e,t,o))return o}return null}function fs(n,e,t=0,i=0,s=.005){let r=null;if(n){r=e[1+n.sn-e[0].sn]||null;const a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),r&&n.level!==r.level&&r.end<=n.end&&(r=e[2+n.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!n||n.level===r.level)&&Qc(t,i,r)===0||PT(r,n,Math.min(s,i))))return r;const o=qf.search(e,Qc.bind(null,t,i));return o&&(o!==n||!r)?o:r}function PT(n,e,t){if(e&&e.start===0&&e.level<n.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((s,r)=>(r[0]==="INF"&&(s+=parseFloat(r[1])),s),t);return n.start<=i}return!1}function Qc(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function DT(n,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function Qf(n,e,t){if(n&&n.startCC<=e&&n.endCC>=e){let i=n.fragments;const{fragmentHint:s}=n;s&&(i=i.concat(s));let r;return qf.search(i,o=>o.cc<e?1:o.cc>e?-1:(r=o,o.end<=t?1:o.start>t?-1:0)),r||null}return null}function Oo(n){switch(n.details){case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_TIMEOUT:case D.LEVEL_LOAD_TIMEOUT:case D.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Zc(n,e){const t=Oo(e);return n.default[`${t?"timeout":"error"}Retry`]}function wh(n,e){const t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function Jc(n){return ye(ye({},n),{errorRetry:null,timeoutRetry:null})}function Bo(n,e,t,i){if(!n)return!1;const s=i==null?void 0:i.code,r=e<n.maxNumRetry&&(MT(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function MT(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}var Ze={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},Ct={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class FT extends hi{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(x.ERROR,this.onError,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(x.ERROR,this.onError,this),e.off(x.ERROR,this.onErrorOut,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===q.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const s=this.hls,r=t.context;switch(t.details){case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case D.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Dr();return}case D.FRAG_GAP:case D.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Ze.SendAlternateToPenaltyBox;return}case D.LEVEL_EMPTY_ERROR:case D.LEVEL_PARSING_ERROR:{var o,a;const h=t.parent===q.MAIN?t.level:s.loadLevel;t.details===D.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(a=o.levelDetails)!=null&&a.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,h):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,h))}return;case D.LEVEL_LOAD_ERROR:case D.LEVEL_LOAD_TIMEOUT:typeof(r==null?void 0:r.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case D.AUDIO_TRACK_LOAD_ERROR:case D.AUDIO_TRACK_LOAD_TIMEOUT:case D.SUBTITLE_LOAD_ERROR:case D.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const h=s.loadLevelObj;if(h&&(r.type===fe.AUDIO_TRACK&&h.hasAudioGroup(r.groupId)||r.type===fe.SUBTITLE_TRACK&&h.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=Ze.SendAlternateToPenaltyBox,t.errorAction.flags=Ct.MoveAllAlternatesMatchingHost;return}}return;case D.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const h=s.loadLevelObj,c=h==null?void 0:h.attrs["HDCP-LEVEL"];c?t.errorAction={action:Ze.SendAlternateToPenaltyBox,flags:Ct.MoveAllAlternatesMatchingHDCP,hdcpLevel:c}:this.keySystemError(t)}return;case D.BUFFER_ADD_CODEC_ERROR:case D.REMUX_ALLOC_ERROR:case D.BUFFER_APPEND_ERROR:if(!t.errorAction){var l;t.errorAction=this.getLevelSwitchAction(t,(l=t.level)!=null?l:s.loadLevel)}return;case D.INTERNAL_EXCEPTION:case D.BUFFER_APPENDING_ERROR:case D.BUFFER_FULL_ERROR:case D.LEVEL_SWITCH_ERROR:case D.BUFFER_STALLED_ERROR:case D.BUFFER_SEEK_OVER_HOLE:case D.BUFFER_NUDGE_ON_STALL:t.errorAction=Dr();return}t.type===Z.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,s=Zc(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Bo(s,r,Oo(e),e.response))return{action:Ze.RetryRequest,flags:Ct.None,retryConfig:s,retryCount:r};const a=this.getLevelSwitchAction(e,t);return s&&(a.retryConfig=s,a.retryCount=r),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:o}=t.config,a=Zc(e.details.startsWith("key")?o:r,e),l=t.levels.reduce((c,u)=>c+u.fragmentError,0);if(s&&(e.details!==D.FRAG_GAP&&s.fragmentError++,Bo(a,l,Oo(e),e.response)))return{action:Ze.RetryRequest,flags:Ct.None,retryConfig:a,retryCount:l};const h=this.getLevelSwitchAction(e,i);return a&&(h.retryConfig=a,h.retryCount=l),h}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s){var r,o;const h=e.details;s.loadError++,h===D.BUFFER_APPEND_ERROR&&s.fragmentError++;let c=-1;const{levels:u,loadLevel:d,minAutoLevel:f,maxAutoLevel:g}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const p=(r=e.frag)==null?void 0:r.type,_=(p===q.AUDIO&&h===D.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(h===D.BUFFER_ADD_CODEC_ERROR||h===D.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:C})=>s.audioCodec!==C),S=e.sourceBufferName==="video"&&(h===D.BUFFER_ADD_CODEC_ERROR||h===D.BUFFER_APPEND_ERROR)&&u.some(({codecSet:C,audioCodec:b})=>s.codecSet!==C&&s.audioCodec===b),{type:v,groupId:E}=(o=e.context)!=null?o:{};for(let C=u.length;C--;){const b=(C+d)%u.length;if(b!==d&&b>=f&&b<=g&&u[b].loadError===0){var a,l;const A=u[b];if(h===D.FRAG_GAP&&p===q.MAIN&&e.frag){const L=u[b].details;if(L){const R=fs(e.frag,L.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else{if(v===fe.AUDIO_TRACK&&A.hasAudioGroup(E)||v===fe.SUBTITLE_TRACK&&A.hasSubtitleGroup(E))continue;if(p===q.AUDIO&&(a=s.audioGroups)!=null&&a.some(L=>A.hasAudioGroup(L))||p===q.SUBTITLE&&(l=s.subtitleGroups)!=null&&l.some(L=>A.hasSubtitleGroup(L))||_&&s.audioCodec===A.audioCodec||!_&&s.audioCodec!==A.audioCodec||S&&s.codecSet===A.codecSet)continue}c=b;break}}if(c>-1&&i.loadLevel!==c)return e.levelRetry=!0,this.playlistError=0,{action:Ze.SendAlternateToPenaltyBox,flags:Ct.None,nextAutoLevel:c}}return{action:Ze.SendAlternateToPenaltyBox,flags:Ct.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Ze.DoNothing:break;case Ze.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==D.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:o}=i;switch(s){case Ct.None:this.switchLevel(e,o);break;case Ct.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=Pl[Pl.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,o)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===D.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=Wf(e.mimeType),s=this.hls.levels;for(let r=s.length;r--;)s[r][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(r)}}}function Dr(n){const e={action:Ze.DoNothing,flags:Ct.None};return n&&(e.resolved=!0),e}var $e={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class kT{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.BUFFER_APPENDED,this.onBufferAppended,this),e.on(x.FRAG_BUFFERED,this.onFragBuffered,this),e.on(x.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.BUFFER_APPENDED,this.onBufferAppended,this),e.off(x.FRAG_BUFFERED,this.onFragBuffered,this),e.off(x.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const o=r.end;if(r.start<=e&&o!==null&&e<=o)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:s}=this,r=Object.keys(s);for(let o=r.length;o--;){const a=s[r[o]];if((a==null?void 0:a.body.type)===t&&(!i||a.buffered)){const l=a.body;if(l.start<=e&&e<=l.end)return l}}return null}detectEvictedFragments(e,t,i,s,r){this.timeRanges&&(this.timeRanges[e]=t);const o=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const l=this.fragments[a];if(!l||o>=l.body.sn)return;if(!l.buffered&&(!l.loaded||r)){l.body.type===i&&this.removeFragment(l.body);return}const h=l.range[e];if(h){if(h.time.length===0){this.removeFragment(l.body);return}h.time.some(c=>{const u=!this.isTimeBuffered(c.startPTS,c.endPTS,t);return u&&this.removeFragment(l.body),u})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,s=Ts(i),r=this.fragments[s];if(!r||r.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const l=i.elementaryStreams[a];if(!l)return;const h=t[a],c=o||l.partial===!0;r.range[a]=this.getBufferedTimes(i,e.part,c,h)}),r.loaded=null,Object.keys(r.range).length?(r.buffered=!0,(r.body.endList=i.endList||r.body.endList)&&(this.endListFragments[r.body.type]=r),Cn(r)||this.removeParts(i.sn-1,i.type)):this.removeFragment(r.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=eu(i,s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=Ts(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},o=e.start,a=e.end,l=e.minEndPTS||a,h=e.maxStartPTS||o;for(let c=0;c<s.length;c++){const u=s.start(c)-this.bufferPadding,d=s.end(c)+this.bufferPadding;if(h>=u&&l<=d){r.time.push({startPTS:Math.max(o,s.start(c)),endPTS:Math.min(a,s.end(c))});break}else if(o<d&&a>u){const f=Math.max(o,s.start(c)),g=Math.min(a,s.end(c));g>f&&(r.partial=!0,r.time.push({startPTS:f,endPTS:g}))}else if(a<=u)break}return r}getPartialFragment(e){let t=null,i,s,r,o=0;const{bufferPadding:a,fragments:l}=this;return Object.keys(l).forEach(h=>{const c=l[h];c&&Cn(c)&&(s=c.body.start-a,r=c.body.end+a,e>=s&&e<=r&&(i=Math.min(e-s,r-e),o<=i&&(t=c.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Cn(t))}getState(e){const t=Ts(e),i=this.fragments[t];return i?i.buffered?Cn(i)?$e.PARTIAL:$e.OK:$e.APPENDING:$e.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let o=0;o<i.length;o++){if(s=i.start(o)-this.bufferPadding,r=i.end(o)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,s=t.part?null:t,r=Ts(i);this.fragments[r]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(s){let h=this.activePartLists[a];h||(this.activePartLists[a]=h=[]),h.push(s)}this.timeRanges=r;const l=r[o];this.detectEvictedFragments(o,l,a,s)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Ts(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let s=i.length;s--;){const r=t[i[s]];if((r==null?void 0:r.body.type)===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const l=a.body;l.type!==i||s&&!l.gap||l.start<t&&l.end>e&&(a.buffered||r)&&this.removeFragment(l)})}removeFragment(e){const t=Ts(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=eu(i,r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const i=(e=this.hls)==null||(t=e.latestLevelDetails)==null?void 0:t.partList;i&&i.forEach(s=>s.clearElementaryStreamInfo())}}function Cn(n){var e,t,i;return n.buffered&&(n.body.gap||((e=n.range.video)==null?void 0:e.partial)||((t=n.range.audio)==null?void 0:t.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Ts(n){return`${n.type}_${n.level}_${n.sn}`}function eu(n,e){return n.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var Vi={cbc:0,ctr:1};class OT{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Vi.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Vi.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function BT(n){const e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?n.slice(0,e-t):n}class UT{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],o=i[2],a=i[3],l=this.invSubMix,h=l[0],c=l[1],u=l[2],d=l[3],f=new Uint32Array(256);let g=0,p=0,m=0;for(m=0;m<256;m++)m<128?f[m]=m<<1:f[m]=m<<1^283;for(m=0;m<256;m++){let _=p^p<<1^p<<2^p<<3^p<<4;_=_>>>8^_&255^99,e[g]=_,t[_]=g;const T=f[g],S=f[T],v=f[S];let E=f[_]*257^_*16843008;s[g]=E<<24|E>>>8,r[g]=E<<16|E>>>16,o[g]=E<<8|E>>>24,a[g]=E,E=v*16843009^S*65537^T*257^g*16843008,h[_]=E<<24|E>>>8,c[_]=E<<16|E>>>16,u[_]=E<<8|E>>>24,d[_]=E,g?(g=T^f[f[f[v^T]]],p^=f[f[p]]):g=p=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const o=this.ksRows=(r+6+1)*4;let a,l;const h=this.keySchedule=new Uint32Array(o),c=this.invKeySchedule=new Uint32Array(o),u=this.sBox,d=this.rcon,f=this.invSubMix,g=f[0],p=f[1],m=f[2],_=f[3];let T,S;for(a=0;a<o;a++){if(a<r){T=h[a]=t[a];continue}S=T,a%r===0?(S=S<<8|S>>>24,S=u[S>>>24]<<24|u[S>>>16&255]<<16|u[S>>>8&255]<<8|u[S&255],S^=d[a/r|0]<<24):r>6&&a%r===4&&(S=u[S>>>24]<<24|u[S>>>16&255]<<16|u[S>>>8&255]<<8|u[S&255]),h[a]=T=(h[a-r]^S)>>>0}for(l=0;l<o;l++)a=o-l,l&3?S=h[a]:S=h[a-4],l<4||a<=4?c[l]=S:c[l]=g[u[S>>>24]]^p[u[S>>>16&255]]^m[u[S>>>8&255]]^_[u[S&255]],c[l]=c[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,l=a[0],h=a[1],c=a[2],u=a[3],d=this.uint8ArrayToUint32Array_(i);let f=d[0],g=d[1],p=d[2],m=d[3];const _=new Int32Array(e),T=new Int32Array(_.length);let S,v,E,C,b,A,L,R,M,F,z,G,k,I;const O=this.networkToHostOrderSwap;for(;t<_.length;){for(M=O(_[t]),F=O(_[t+1]),z=O(_[t+2]),G=O(_[t+3]),b=M^r[0],A=G^r[1],L=z^r[2],R=F^r[3],k=4,I=1;I<s;I++)S=l[b>>>24]^h[A>>16&255]^c[L>>8&255]^u[R&255]^r[k],v=l[A>>>24]^h[L>>16&255]^c[R>>8&255]^u[b&255]^r[k+1],E=l[L>>>24]^h[R>>16&255]^c[b>>8&255]^u[A&255]^r[k+2],C=l[R>>>24]^h[b>>16&255]^c[A>>8&255]^u[L&255]^r[k+3],b=S,A=v,L=E,R=C,k=k+4;S=o[b>>>24]<<24^o[A>>16&255]<<16^o[L>>8&255]<<8^o[R&255]^r[k],v=o[A>>>24]<<24^o[L>>16&255]<<16^o[R>>8&255]<<8^o[b&255]^r[k+1],E=o[L>>>24]<<24^o[R>>16&255]<<16^o[b>>8&255]<<8^o[A&255]^r[k+2],C=o[R>>>24]<<24^o[b>>16&255]<<16^o[A>>8&255]<<8^o[L&255]^r[k+3],T[t]=O(S^f),T[t+1]=O(C^g),T[t+2]=O(E^p),T[t+3]=O(v^m),f=M,g=F,p=z,m=G,t=t+4}return T.buffer}}class NT{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=$T(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function $T(n){switch(n){case Vi.cbc:return"AES-CBC";case Vi.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${n}`)}}const zT=16;class Ih{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?BT(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,s){return this.useSoftware?new Promise((r,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,s);const l=this.flush();l?r(l.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,s)}softwareDecrypt(e,t,i,s){const{currentIV:r,currentResult:o,remainderData:a}=this;if(s!==Vi.cbc||t.byteLength!==16)return pe.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=At(a,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;r&&(i=r);let h=this.softwareDecrypter;h||(h=this.softwareDecrypter=new UT),h.expandKey(t);const c=o;return this.currentResult=h.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,c||null}webCryptoDecrypt(e,t,i,s){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,s));this.key=t,this.fastAesKey=new NT(this.subtle,t,s)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new OT(this.subtle,new Uint8Array(i),s).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(pe.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,s)))}onWebCryptoError(e,t,i,s){const r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,s);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%zT;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(pe.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const tu=Math.pow(2,17);class GT{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Jt({type:Z.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(g=>g[0]==="GAP")){l(su(e));return}else e.gap=!1;const h=this.loader=r?new r(s):new o(s),c=iu(e);e.loader=h;const u=Jc(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:tu};e.stats=h.stats;const f={onSuccess:(g,p,m,_)=>{this.resetLoader(e,h);let T=g.data;m.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(T.slice(0,16)),T=T.slice(16)),a({frag:e,part:null,payload:T,networkDetails:_})},onError:(g,p,m,_)=>{this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:ye({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:_}))},onAbort:(g,p,m)=>{this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:m,stats:g}))},onTimeout:(g,p,m)=>{this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}))}};t&&(f.onProgress=(g,p,m,_)=>t({frag:e,part:null,payload:m,networkDetails:_})),h.load(c,d,f)})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(su(e,t));return}const h=this.loader=r?new r(s):new o(s),c=iu(e,t);e.loader=h;const u=Jc(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:tu};t.stats=h.stats,h.load(c,d,{onSuccess:(f,g,p,m)=>{this.resetLoader(e,h),this.updateStatsFromPart(e,t);const _={frag:e,part:t,payload:f.data,networkDetails:m};i(_),a(_)},onError:(f,g,p,m)=>{this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:ye({url:c.url,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:p,stats:m}))},onAbort:(f,g,p)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:p,stats:f}))},onTimeout:(f,g,p)=>{this.resetLoader(e,h),l(new Jt({type:Z.NETWORK_ERROR,details:D.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:p,stats:f}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const l=Math.round(e.duration/t.duration),h=Math.min(Math.round(i.loaded/r),l),u=(l-h)*Math.round(i.loaded/h);i.total=i.loaded+u}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=s.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function iu(n,e=null){const t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(K(s)&&K(r)){var o;let a=s,l=r;if(n.sn==="initSegment"&&HT((o=n.decryptdata)==null?void 0:o.method)){const h=r-s;h%16&&(l=r+(16-h%16)),s!==0&&(i.resetIV=!0,a=s-16)}i.rangeStart=a,i.rangeEnd=l}return i}function su(n,e){const t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:Z.MEDIA_ERROR,details:D.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new Jt(i)}function HT(n){return n==="AES-128"||n==="AES-256"}class Jt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Zf extends hi{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Ph{constructor(e,t,i,s=0,r=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ln(),this.buffering={audio:Ln(),video:Ln(),audiovideo:Ln()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=o}}function Ln(){return{start:0,executeStart:0,executeEnd:0,end:0}}const ru={length:0,start:()=>0,end:()=>0};class ne{static isBuffered(e,t){if(e){const i=ne.getBuffered(e);for(let s=i.length;s--;)if(t>=i.start(s)&&t<=i.end(s))return!0}return!1}static bufferedRanges(e){if(e){const t=ne.getBuffered(e);return ne.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const s=ne.bufferedRanges(e);if(s.length)return ne.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((c,u)=>c.start-u.start||u.end-c.end);let s=-1,r=[];if(i)for(let c=0;c<e.length;c++){t>=e[c].start&&t<=e[c].end&&(s=c);const u=r.length;if(u){const d=r[u-1].end;e[c].start-d<i?e[c].end>d&&(r[u-1].end=e[c].end):r.push(e[c])}else r.push(e[c])}else r=e;let o=0,a,l=t,h=t;for(let c=0;c<r.length;c++){const u=r[c].start,d=r[c].end;if(s===-1&&t>=u&&t<=d&&(s=c),t+i>=u&&t<d)l=u,h=d,o=h-t;else if(t+i<u){a=u;break}}return{len:o,start:l||0,end:h||0,nextStart:a,buffered:e,bufferedIndex:s}}static getBuffered(e){try{return e.buffered||ru}catch(t){return pe.log("failed to get media.buffered",t),ru}}}const Jf=/\{\$([a-zA-Z0-9-_]+)\}/g;function nu(n){return Jf.test(n)}function Dl(n,e){if(n.variableList!==null||n.hasVariableRefs){const t=n.variableList;return e.replace(Jf,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function ou(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(s))r=o.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(o){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function VT(n,e,t){const i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const WT=/^(\d+)x(\d+)$/,au=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Pe{constructor(e,t){typeof e=="string"&&(e=Pe.parseAttrList(e,t)),Ee(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((s,r)=>(s[r.toLowerCase()]=!0,s),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=WT.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const s={},r='"';for(au.lastIndex=0;(i=au.exec(e))!==null;){const o=i[1].trim();let a=i[2];const l=a.indexOf(r)===0&&a.lastIndexOf(r)===a.length-1;let h=!1;if(l)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":h=!0}if(t&&(l||h))a=Dl(t,a);else if(!h&&!l)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":pe.warn(`${e}: attribute ${o} is missing quotes`)}s[o]=a}return s}}const YT="com.apple.hls.interstitial";function KT(n){return n!=="ID"&&n!=="CLASS"&&n!=="CUE"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function XT(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"||n==="SCTE35-CMD"}class eg{constructor(e,t,i=0){var s;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(t==null?void 0:t.tagAnchor)||null,this.tagOrder=(s=t==null?void 0:t.tagOrder)!=null?s:i,t){const r=t.attr;for(const o in r)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==r[o]){pe.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=Ee(new Pe({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const r=(t==null?void 0:t.endDate)||new Date(this.attr["END-DATE"]);K(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(pe.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(K(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===YT}get isValid(){return!!this.id&&!this._badValueForSameId&&K(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const jT=10;class qT{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}get hasProgramDateTime(){return this.fragments.length?K(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||jT}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Ks(n){return n==="AES-128"||n==="AES-256"||n==="AES-256-CTR"}function Dh(n){switch(n){case"AES-128":case"AES-256":return Vi.cbc;case"AES-256-CTR":return Vi.ctr;default:throw new Error(`invalid full segment method ${n}`)}}function Mh(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function Ml(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}function QT(n){const e=Ml(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function ZT(n){const e=function(i,s,r){const o=i[s];i[s]=i[r],i[r]=o};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function JT(n){const e=n.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",o=s[1];r?(i.splice(-1,1),t=Mh(o)):t=QT(o)}}return t}const Uo=typeof self<"u"?self:void 0;var Se={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},at={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function ro(n){switch(n){case at.FAIRPLAY:return Se.FAIRPLAY;case at.PLAYREADY:return Se.PLAYREADY;case at.WIDEVINE:return Se.WIDEVINE;case at.CLEARKEY:return Se.CLEARKEY}}var wn={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Pa(n){if(n===wn.WIDEVINE)return Se.WIDEVINE;if(n===wn.PLAYREADY)return Se.PLAYREADY;if(n===wn.CENC||n===wn.CLEARKEY)return Se.CLEARKEY}function In(n){switch(n){case Se.FAIRPLAY:return at.FAIRPLAY;case Se.PLAYREADY:return at.PLAYREADY;case Se.WIDEVINE:return at.WIDEVINE;case Se.CLEARKEY:return at.CLEARKEY}}function pr(n){const{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[Se.FAIRPLAY,Se.WIDEVINE,Se.PLAYREADY,Se.CLEARKEY].filter(s=>!!e[s]):[];return!i[Se.WIDEVINE]&&t&&i.push(Se.WIDEVINE),i}const tg=function(n){return Uo!=null&&(n=Uo.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function eS(n,e,t,i){let s;switch(n){case Se.FAIRPLAY:s=["cenc","sinf"];break;case Se.WIDEVINE:case Se.PLAYREADY:s=["cenc"];break;case Se.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return tS(s,e,t,i)}function tS(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function iS(n){var e;return n.sessionType==="persistent-license"||!!((e=n.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function ig(n){const e=new Uint16Array(n.buffer,n.byteOffset,n.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const l=Mh(a).subarray(0,16);return ZT(l),l}}return null}let Pn={};class Mr{static clearKeyUriToKeyIdMap(){Pn={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Ks(e)}isSupported(){if(this.method){if(Ks(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case at.FAIRPLAY:case at.WIDEVINE:case at.PLAYREADY:case at.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(Ks(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(pe.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=sS(e);return new Mr(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=JT(this.uri);if(t)switch(this.keyFormat){case at.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case at.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=hT(i,null,t),this.keyId=ig(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=Pn[this.uri];if(!i){const s=Object.keys(Pn).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),Pn[this.uri]=i}this.keyId=i}return this}}function sS(n){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}const lu=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,hu=/#EXT-X-MEDIA:(.*)/g,rS=/^#EXT(?:INF|-X-TARGETDURATION):/m,Da=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),nS=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Wt{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static resolve(e,t){return Rh.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return rS.test(e)}static parseMasterPlaylist(e,t){const i=nu(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];lu.lastIndex=0;let o;for(;(o=lu.exec(e))!=null;)if(o[1]){var a;const h=new Pe(o[1],s),c=Dl(s,o[2]),u={attrs:h,bitrate:h.decimalInteger("BANDWIDTH")||h.decimalInteger("AVERAGE-BANDWIDTH"),name:h.NAME,url:Wt.resolve(c,t)},d=h.decimalResolution("RESOLUTION");d&&(u.width=d.width,u.height=d.height),du(h.CODECS,u);const f=h["SUPPLEMENTAL-CODECS"];f&&(u.supplemental={},du(f,u.supplemental)),(a=u.unknownCodecs)!=null&&a.length||r.push(u),s.levels.push(u)}else if(o[3]){const h=o[3],c=o[4];switch(h){case"SESSION-DATA":{const u=new Pe(c,s),d=u["DATA-ID"];d&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[d]=u);break}case"SESSION-KEY":{const u=cu(c,t,s);u.encrypted&&u.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(u)):pe.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${c}"`);break}case"DEFINE":{{const u=new Pe(c,s);ou(s,u,t)}break}case"CONTENT-STEERING":{const u=new Pe(c,s);s.contentSteering={uri:Wt.resolve(u["SERVER-URI"],t),pathwayId:u["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=uu(c);break}}}const l=r.length>0&&r.length<s.levels.length;return s.levels=l?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},o=i.levels,a={AUDIO:o.map(h=>({id:h.attrs.AUDIO,audioCodec:h.audioCodec})),SUBTITLES:o.map(h=>({id:h.attrs.SUBTITLES,textCodec:h.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(hu.lastIndex=0;(s=hu.exec(e))!==null;){const h=new Pe(s[1],i),c=h.TYPE;if(c){const u=a[c],d=r[c]||[];r[c]=d;const f=h.LANGUAGE,g=h["ASSOC-LANGUAGE"],p=h.CHANNELS,m=h.CHARACTERISTICS,_=h["INSTREAM-ID"],T={attrs:h,bitrate:0,id:l++,groupId:h["GROUP-ID"]||"",name:h.NAME||f||"",type:c,default:h.bool("DEFAULT"),autoselect:h.bool("AUTOSELECT"),forced:h.bool("FORCED"),lang:f,url:h.URI?Wt.resolve(h.URI,t):""};if(g&&(T.assocLang=g),p&&(T.channels=p),m&&(T.characteristics=m),_&&(T.instreamId=_),u!=null&&u.length){const S=Wt.findGroup(u,T.groupId)||u[0];fu(T,S,"audioCodec"),fu(T,S,"textCodec")}d.push(T)}}return r}static parseLevelPlaylist(e,t,i,s,r,o){var a;const l={url:t},h=new qT(t),c=h.fragments,u=[];let d=null,f=0,g=0,p=0,m=0,_=0,T=null,S=new Ca(s,l),v,E,C,b=-1,A=!1,L=null,R;if(Da.lastIndex=0,h.m3u8=e,h.hasVariableRefs=nu(e),((a=Da.exec(e))==null?void 0:a[0])!=="#EXTM3U")return h.playlistParsingError=new Error("Missing format identifier #EXTM3U"),h;for(;(v=Da.exec(e))!==null;){A&&(A=!1,S=new Ca(s,l),S.playlistOffset=p,S.start=p,S.sn=f,S.cc=m,_&&(S.bitrate=_),S.level=i,d&&(S.initSegment=d,d.rawProgramDateTime&&(S.rawProgramDateTime=d.rawProgramDateTime,d.rawProgramDateTime=null),L&&(S.setByteRange(L),L=null)));const G=v[1];if(G){S.duration=parseFloat(G);const k=(" "+v[2]).slice(1);S.title=k||null,S.tagList.push(k?["INF",G,k]:["INF",G])}else if(v[3]){if(K(S.duration)){S.playlistOffset=p,S.start=p,C&&pu(S,C,h),S.sn=f,S.level=i,S.cc=m,c.push(S);const k=(" "+v[3]).slice(1);S.relurl=Dl(h,k),Fl(S,T,u),T=S,p+=S.duration,f++,g=0,A=!0}}else{if(v=v[0].match(nS),!v){pe.warn("No matches on slow regex match for level playlist!");continue}for(E=1;E<v.length&&v[E]===void 0;E++);const k=(" "+v[E]).slice(1),I=(" "+v[E+1]).slice(1),O=v[E+2]?(" "+v[E+2]).slice(1):null;switch(k){case"BYTERANGE":T?S.setByteRange(I,T):S.setByteRange(I);break;case"PROGRAM-DATE-TIME":S.rawProgramDateTime=I,S.tagList.push(["PROGRAM-DATE-TIME",I]),b===-1&&(b=c.length);break;case"PLAYLIST-TYPE":h.type&&jt(h,k,v),h.type=I.toUpperCase();break;case"MEDIA-SEQUENCE":h.startSN!==0?jt(h,k,v):c.length>0&&mu(h,k,v),f=h.startSN=parseInt(I);break;case"SKIP":{h.skippedSegments&&jt(h,k,v);const V=new Pe(I,h),B=V.decimalInteger("SKIPPED-SEGMENTS");if(K(B)){h.skippedSegments+=B;for(let Y=B;Y--;)c.push(null);f+=B}const U=V.enumeratedString("RECENTLY-REMOVED-DATERANGES");U&&(h.recentlyRemovedDateranges=(h.recentlyRemovedDateranges||[]).concat(U.split("	")));break}case"TARGETDURATION":h.targetduration!==0&&jt(h,k,v),h.targetduration=Math.max(parseInt(I),1);break;case"VERSION":h.version!==null&&jt(h,k,v),h.version=parseInt(I);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":h.live||jt(h,k,v),h.live=!1;break;case"#":(I||O)&&S.tagList.push(O?[I,O]:[I]);break;case"DISCONTINUITY":m++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([k]);break;case"BITRATE":S.tagList.push([k,I]),_=parseInt(I)*1e3,K(_)?S.bitrate=_:_=0;break;case"DATERANGE":{const V=new Pe(I,h),B=new eg(V,h.dateRanges[V.ID],h.dateRangeTagCount);h.dateRangeTagCount++,B.isValid||h.skippedSegments?h.dateRanges[B.id]=B:pe.warn(`Ignoring invalid DATERANGE tag: "${I}"`),S.tagList.push(["EXT-X-DATERANGE",I]);break}case"DEFINE":{{const V=new Pe(I,h);"IMPORT"in V?VT(h,V,o):ou(h,V,t)}break}case"DISCONTINUITY-SEQUENCE":h.startCC!==0?jt(h,k,v):c.length>0&&mu(h,k,v),h.startCC=m=parseInt(I);break;case"KEY":{const V=cu(I,t,h);if(V.isSupported()){if(V.method==="NONE"){C=void 0;break}C||(C={}),C[V.keyFormat]&&(C=Ee({},C)),C[V.keyFormat]=V}else pe.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${I}"`);break}case"START":h.startTimeOffset=uu(I);break;case"MAP":{const V=new Pe(I,h);if(S.duration){const B=new Ca(s,l);gu(B,V,i,C),d=B,S.initSegment=d,d.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=d.rawProgramDateTime)}else{const B=S.byteRangeEndOffset;if(B){const U=S.byteRangeStartOffset;L=`${B-U}@${U}`}else L=null;gu(S,V,i,C),d=S,A=!0}d.cc=m;break}case"SERVER-CONTROL":{R&&jt(h,k,v),R=new Pe(I),h.canBlockReload=R.bool("CAN-BLOCK-RELOAD"),h.canSkipUntil=R.optionalFloat("CAN-SKIP-UNTIL",0),h.canSkipDateRanges=h.canSkipUntil>0&&R.bool("CAN-SKIP-DATERANGES"),h.partHoldBack=R.optionalFloat("PART-HOLD-BACK",0),h.holdBack=R.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{h.partTarget&&jt(h,k,v);const V=new Pe(I);h.partTarget=V.decimalFloatingPoint("PART-TARGET");break}case"PART":{let V=h.partList;V||(V=h.partList=[]);const B=g>0?V[V.length-1]:void 0,U=g++,Y=new Pe(I,h),W=new jy(Y,S,l,U,B);V.push(W),S.duration+=W.duration;break}case"PRELOAD-HINT":{const V=new Pe(I,h);h.preloadHint=V;break}case"RENDITION-REPORT":{const V=new Pe(I,h);h.renditionReports=h.renditionReports||[],h.renditionReports.push(V);break}default:pe.warn(`line parsed but not handled: ${v}`);break}}}T&&!T.relurl?(c.pop(),p-=T.duration,h.partList&&(h.fragmentHint=T)):h.partList&&(Fl(S,T,u),S.cc=m,h.fragmentHint=S,C&&pu(S,C,h)),h.targetduration||(h.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const M=c.length,F=c[0],z=c[M-1];if(p+=h.skippedSegments*h.targetduration,p>0&&M&&z){h.averagetargetduration=p/M;const G=z.sn;h.endSN=G!=="initSegment"?G:0,h.live||(z.endList=!0),F&&h.startCC===void 0&&(h.startCC=F.cc),b>0&&(aS(c,b),F&&u.unshift(F))}else h.endSN=0,h.startCC=0;return h.fragmentHint&&(p+=h.fragmentHint.duration),h.totalduration=p,u.length&&h.dateRangeTagCount&&F&&sg(u,h),h.endCC=m,h}}function sg(n,e){const t=n.length;if(!t)return;const i=n[t-1],s=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let o=r.length;o--;){const a=e.dateRanges[r[o]],l=a.startDate.getTime();a.tagAnchor=i.ref;for(let h=t;h--;){const c=oS(e,l,n,h,s);if(c!==-1){a.tagAnchor=e.fragments[c].ref;break}}}}function oS(n,e,t,i,s){const r=t[i];if(r){const a=r.programDateTime;if(e>=a||i===0){var o;const l=(((o=t[i+1])==null?void 0:o.start)||s)-r.start;if(e<=a+l*1e3){const h=t[i].sn-n.startSN,c=n.fragments;if(c.length>t.length){const d=(t[i+1]||c[c.length-1]).sn-n.startSN;for(let f=d;f>h;f--){const g=c[f].programDateTime;if(e>=g&&e<g+c[f].duration*1e3)return f}}return h}}}return-1}function cu(n,e,t){var i,s;const r=new Pe(n,t),o=(i=r.METHOD)!=null?i:"",a=r.URI,l=r.hexadecimalInteger("IV"),h=r.KEYFORMATVERSIONS,c=(s=r.KEYFORMAT)!=null?s:"identity";a&&r.IV&&!l&&pe.error(`Invalid IV: ${r.IV}`);const u=a?Wt.resolve(a,e):"",d=(h||"1").split("/").map(Number).filter(Number.isFinite);return new Mr(o,u,c,d,l)}function uu(n){const t=new Pe(n).decimalFloatingPoint("TIME-OFFSET");return K(t)?t:null}function du(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=t.filter(r=>Hf(r,i));s.length&&(e[`${i}Codec`]=s.map(r=>r.split("/")[0]).join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function fu(n,e,t){const i=e[t];i&&(n[t]=i)}function aS(n,e){let t=n[e];for(let i=e;i--;){const s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function Fl(n,e,t){n.rawProgramDateTime?t.push(n):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime)}function gu(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function pu(n,e,t){n.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}function jt(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function mu(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function Ma(n,e){const t=e.startPTS;if(K(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&s.setDuration(i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.setStart(n.start+(n.minEndPTS-n.start)):e.setStart(n.start+n.duration):e.setStart(Math.max(n.start-e.duration,0))}function rg(n,e,t,i,s,r){i-t<=0&&(pe.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let a=t,l=i;const h=e.startPTS,c=e.endPTS;if(K(h)){const m=Math.abs(h-t);K(e.deltaPTS)?e.deltaPTS=Math.max(m,e.deltaPTS):e.deltaPTS=m,a=Math.max(t,h),t=Math.min(t,h),s=Math.min(s,e.startDTS),l=Math.min(i,c),i=Math.max(i,c),r=Math.max(r,e.endDTS)}const u=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=a,e.startDTS=s,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const d=e.sn;if(!n||d<n.startSN||d>n.endSN)return 0;let f;const g=d-n.startSN,p=n.fragments;for(p[g]=e,f=g;f>0;f--)Ma(p[f],p[f-1]);for(f=g;f<p.length-1;f++)Ma(p[f],p[f+1]);return n.fragmentHint&&Ma(p[p.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,u}function lS(n,e){if(n===e)return;let t=null;const i=n.fragments;for(let h=i.length-1;h>=0;h--){const c=i[h].initSegment;if(c){t=c;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s;uS(n,e,(h,c,u,d)=>{if((!e.startCC||e.skippedSegments)&&c.cc!==h.cc){const f=h.cc-c.cc;for(let g=u;g<d.length;g++)d[g].cc+=f;e.endCC=d[d.length-1].cc}K(h.startPTS)&&K(h.endPTS)&&(c.setStart(c.startPTS=h.startPTS),c.startDTS=h.startDTS,c.maxStartPTS=h.maxStartPTS,c.endPTS=h.endPTS,c.endDTS=h.endDTS,c.minEndPTS=h.minEndPTS,c.setDuration(h.endPTS-h.startPTS),c.duration&&(s=c),e.PTSKnown=e.alignedSliding=!0),h.hasStreams&&(c.elementaryStreams=h.elementaryStreams),c.loader=h.loader,h.hasStats&&(c.stats=h.stats),h.initSegment&&(c.initSegment=h.initSegment,t=h.initSegment)});const r=e.fragments,o=e.fragmentHint?r.concat(e.fragmentHint):r;if(t&&o.forEach(h=>{var c;h&&(!h.initSegment||h.initSegment.relurl===((c=t)==null?void 0:c.relurl))&&(h.initSegment=t)}),e.skippedSegments){if(e.deltaUpdateFailed=r.some(h=>!h),e.deltaUpdateFailed){pe.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let h=e.skippedSegments;h--;)r.shift();e.startSN=r[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=hS(n.dateRanges,e));const h=n.fragments.filter(c=>c.rawProgramDateTime);if(n.hasProgramDateTime&&!e.hasProgramDateTime)for(let c=1;c<o.length;c++)o[c].programDateTime===null&&Fl(o[c],o[c-1],h);sg(h,e)}e.endCC=r[r.length-1].cc}if(!e.startCC){var a;const h=ag(n,e.startSN-1);e.startCC=(a=h==null?void 0:h.cc)!=null?a:r[0].cc}cS(n.partList,e.partList,(h,c)=>{c.elementaryStreams=h.elementaryStreams,c.stats=h.stats}),s?rg(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):ng(n,e),r.length&&(e.totalduration=e.edge-r[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;const l=e.advancedDateTime;if(e.advanced&&l){const h=e.edge;e.driftStart||(e.driftStartTime=l,e.driftStart=h),e.driftEndTime=l,e.driftEnd=h}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=n.requestScheduled)}function hS(n,e){const{dateRanges:t,recentlyRemovedDateranges:i}=e,s=Ee({},n);i&&i.forEach(a=>{delete s[a]});const o=Object.keys(s).length;return o&&Object.keys(t).forEach(a=>{const l=s[a],h=new eg(t[a].attr,l);h.isValid?(s[a]=h,l||(h.tagOrder+=o)):pe.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${we(t[a].attr)}"`)}),s}function cS(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){const o=n[s],a=e[s+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function uS(n,e,t){const i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,o=e.startSN-n.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let h=s;h<=r;h++){const c=l[o+h];let u=a[h];if(i&&!u&&c&&(u=e.fragments[h]=c),c&&u){if(t(c,u,h,a),c.url&&c.url!==u.url){e.playlistParsingError=_u(`media sequence mismatch ${u.sn}:`,n,e,c,u);return}else if(c.cc!==u.cc){e.playlistParsingError=_u(`discontinuity sequence mismatch (${c.cc}!=${u.cc})`,n,e,c,u);return}}}}function _u(n,e,t,i,s){return new Error(`${n} ${s.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function ng(n,e,t=!0){const i=e.startSN+e.skippedSegments-n.startSN,s=n.fragments,r=i>=0;let o=0;if(r&&i<s.length)o=s[i].start;else if(r&&e.startSN===n.endSN+1)o=n.fragmentEnd;else if(r&&t)o=n.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=n.fragmentStart;else return;kl(e,o)}function kl(n,e){if(e){const t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].addStart(e);n.fragmentHint&&n.fragmentHint.addStart(e)}}function og(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function ag(n,e,t){if(!n)return null;let i=n.fragments[e-n.startSN];return i||(i=n.fragmentHint,i&&i.sn===e)?i:e<n.startSN&&t&&t.sn===e?t:null}function xu(n,e,t){return n?lg(n.partList,e,t):null}function lg(n,e,t){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function hg(n){n.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(s=>{s.level=t,s.initSegment&&(s.initSegment.level=t)})})}function Sr(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function dS(n,e){return!!(n&&e.startCC<n.endCC&&e.endCC>n.startCC)}function yu(n,e){if(n){const t=n.start+e;n.start=n.startPTS=t,n.endPTS=t+n.duration}}function cg(n,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)yu(t[i],n);e.fragmentHint&&yu(e.fragmentHint,n),e.alignedSliding=!0}function fS(n,e){n&&(ug(e,n),!e.alignedSliding&&n&&No(e,n),!e.alignedSliding&&n&&!e.skippedSegments&&ng(n,e,!1))}function ug(n,e){if(!dS(e,n))return;const t=Math.min(e.endCC,n.endCC),i=Sr(e.fragments,t),s=Sr(n.fragments,t);if(!i||!s)return;pe.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const r=i.start-s.start;cg(r,n)}function No(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;const t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r;const o=Math.min(e.endCC,n.endCC);e.startCC<o&&n.startCC<o&&(s=Sr(i,o),r=Sr(t,o)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Sr(t,s.cc)||t[Math.floor(t.length/2)]);const a=s.programDateTime,l=r.programDateTime;if(!a||!l)return;const h=(l-a)/1e3-(r.start-s.start);cg(h,n)}const gS={toString:function(n){let e="";const t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},N={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Fh extends Zf{constructor(e,t,i,s,r){super(s,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=N.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:l,mediaBuffer:h,state:c}=this,u=l?l.currentTime:0,d=ne.bufferInfo(h||l,u,o.maxBufferHole);if(this.log(`media seeking to ${K(u)?u.toFixed(3):u}, state: ${c}`),this.state===N.ENDED)this.resetLoadingState();else if(a){const f=o.maxFragLookUpTolerance,g=a.start-f,p=a.start+a.duration+f;if(!d.len||p<d.start||g>d.end){const m=u>p;(u<g||m)&&(m&&a.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(u,1/0,this.playlistType,!0);const f=this.lastCurrentTime;if(u>f&&(this.lastCurrentTime=u),!this.loadingParts){const g=Math.max(d.end,u),p=this.shouldLoadParts(this.getLevelDetails(),g);p&&(this.log(`LL-Part loading ON after seeking to ${u.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=p)}}!this.hls.hasEnoughToStart&&!d.len&&(this.log(`setting startPosition to ${u} because of seek before start`),this.nextLoadPosition=this.startPosition=u),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new GT(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Ih(e.config)}registerListeners(){const{hls:e}=this;e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(x.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===N.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=N.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,s=this.config.timelineOffset||0;if(i<=s)return!1;const r=e.buffered;this.config.maxBufferHole&&r&&r.length>1&&(e=ne.bufferedInfo(r,e.start,0));const o=e.nextStart;if(o&&o>s&&o<t.edge||this.media.currentTime<e.start)return!1;const l=t.partList;if(l!=null&&l.length){const c=l[l.length-1];return ne.isBuffered(this.media,c.start+c.duration/2)}const h=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(h)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const s=this.config;this.levels&&s.autoStartLoad&&this.state===N.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,s=this.media;if(s!==null){if(s.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),s.removeEventListener("seeking",this.onMediaSeeking),s.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=N.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{const o=r.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(o,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const o=this.state,a=r.frag;if(this.fragContextChanged(a)){(o===N.FRAG_LOADING||!this.fragCurrent&&o===N.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=N.IDLE);return}"payload"in r&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(x.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===N.STOPPED||this.state===N.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===$e.APPENDING){const r=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,r),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===$e.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(x.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const s=i==null?void 0:i.frag;if(!s||this.fragContextChanged(s)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{frag:r,payload:o}=i,a=r.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&Ks(a.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,Dh(a.method)).catch(h=>{throw s.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_DECRYPT_ERROR,fatal:!1,error:h,reason:h.message,frag:r}),h}).then(h=>{const c=self.performance.now();return s.trigger(x.FRAG_DECRYPTED,{frag:r,payload:h,stats:{tstart:l,tdecrypt:c}}),i.payload=h,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===N.STOPPED||this.state===N.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==N.STOPPED&&(this.state=N.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?gS.toString(ne.getBuffered(i)):"(detached)"})`),Ve(e)){var s;if(e.type!==q.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=N.IDLE;return}}const r=(s=this.levels)==null?void 0:s[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=N.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,o=!r||r.length===0||r.some(l=>!l),a=new Ph(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;this.fragCurrent=e;const o=t==null?void 0:t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=N.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(u=>{if(!this.fragContextChanged(u.frag))return this.hls.trigger(x.KEY_LOADED,u),this.state===N.KEY_LOADING&&(this.state=N.IDLE),u}),this.hls.trigger(x.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments),a&&this.log("[eme] blocking frag load until media-keys acquired"));const l=this.fragPrevious;if(Ve(e)&&(!l||e.sn!==l.sn)){const u=this.shouldLoadParts(t.details,e.end);u!==this.loadingParts&&(this.log(`LL-Part loading ${u?"ON":"OFF"} loading sn ${l==null?void 0:l.sn}->${e.sn}`),this.loadingParts=u)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ve(e)){const u=o.partList;if(u&&s){i>e.end&&o.fragmentHint&&(e=o.fragmentHint);const d=this.getNextPart(u,e,i);if(d>-1){const f=u[d];e=this.fragCurrent=f.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${f.index} (${d}/${u.length-1}) of ${this.fragInfo(e,!1,f)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=N.FRAG_LOADING;let g;return a?g=a.then(p=>!p||this.fragContextChanged(p.frag)?null:this.doFragPartsLoad(e,f,t,s)).catch(p=>this.handleFragLoadError(p)):g=this.doFragPartsLoad(e,f,t,s).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(x.FRAG_LOADING,{frag:e,part:f,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(u,i))return Promise.resolve(null)}}if(Ve(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${o?"["+o.startSN+"-"+o.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),K(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=N.FRAG_LOADING;const h=this.config.progressive;let c;return h&&a?c=a.then(u=>!u||this.fragContextChanged(u==null?void 0:u.frag)?null:this.fragmentLoader.load(e,s)).catch(u=>this.handleFragLoadError(u)):c=Promise.all([this.fragmentLoader.load(e,h?s:void 0),a]).then(([u])=>(!h&&u&&s&&s(u),u)).catch(u=>this.handleFragLoadError(u)),this.hls.trigger(x.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):c}doFragPartsLoad(e,t,i,s){return new Promise((r,o)=>{var a;const l=[],h=(a=i.details)==null?void 0:a.partList,c=u=>{this.fragmentLoader.loadPart(e,u,s).then(d=>{l[u.index]=d;const f=d.part;this.hls.trigger(x.FRAG_LOADED,d);const g=xu(i.details,e.sn,u.index+1)||lg(h,e.sn,u.index+1);if(g)c(g);else return r({frag:e,part:f,partsLoaded:l})}).catch(o)};c(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===D.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(x.ERROR,t)}else this.hls.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==N.PARSING){!this.fragCurrent&&this.state!==N.STOPPED&&this.state!==N.ERROR&&(this.state=N.IDLE);return}const{frag:i,part:s,level:r}=t,o=self.performance.now();i.stats.parsing.end=o,s&&(s.stats.parsing.end=o);const a=this.getLevelDetails(),h=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);h!==this.loadingParts&&(this.log(`LL-Part loading ${h?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=h),this.updateLevelTiming(i,s,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i;const r=e.partList[0],o=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var s;if((this.hls.hasEnoughToStart?((s=this.media)==null?void 0:s.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:o}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${s}. The current chunk will not be buffered.`),null;const a=t[s],l=a.details,h=o>-1?xu(l,r,o):null,c=h?h.fragment:ag(l,r,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:h,level:a}):null}bufferFragmentData(e,t,i,s,r){var o;if(!e||this.state!==N.PARSING)return;const{data1:a,data2:l}=e;let h=a;if(a&&l&&(h=At(a,l)),!((o=h)!=null&&o.length))return;const c={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:h};if(this.hls.trigger(x.BUFFER_APPENDING,c),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!ne.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=ne.bufferInfo(t,i,0),r=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),a=Math.max(Math.min(e.start-o,s.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const s=this.getLoadPosition();if(!K(s))return null;const o=this.lastCurrentTime>s||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,s,t,o)}getFwdBufferInfoAtPos(e,t,i,s){const r=ne.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(r.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(r.nextStart,o.end)-t,s);return ne.bufferInfo(e,t,a)}}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,s=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,s);return r>=s?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=q.MAIN){var i;const s=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return s&&"fragment"in s?s.fragment:s}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,o=i[0].start,a=r.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const u=r.initialLiveManifestSize;if(s<u)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${u})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var h;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t);const d=this.hls.startPosition,f=this.hls.liveSyncPosition,g=l?(d!==-1&&d>=o?d:f)||l.start:e;this.log(`Setting startPosition to ${g} to match start frag at live edge. mainStart: ${d} liveSyncPosition: ${f} frag.start: ${(h=l)==null?void 0:h.start}`),this.startPosition=this.nextLoadPosition=g}}else e<=o&&(l=i[0]);if(!l){const u=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,u,t)}let c=this.filterReplacedPrimary(l,t);if(!c&&l){const u=l.sn-t.startSN;c=this.filterReplacedPrimary(i[u+1]||null,t)}return this.mapToInitFragWhenRequired(c)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===$e.OK||i===$e.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s,0);if(a!==null&&i.len+a.len>=r){const l=o.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(Tu(this.hls.config)){var e,t;if((e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(Tu(this.hls.config)&&e.type!==q.SUBTITLE){const i=this.hls.interstitialsManager,s=i==null?void 0:i.bufferingItem;if(s){const o=s.event;if(o){if(o.appendInPlace||Math.abs(e.start-s.start)>1||s.start===0)return null}else if(e.end<=s.start&&(t==null?void 0:t.live)===!1||e.start>s.end&&s.nextEvent&&(s.nextEvent.appendInPlace||e.start-s.end>1))return null}const r=i==null?void 0:i.playerQueue;if(r)for(let o=r.length;o--;){const a=r[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,o=!0;for(let a=0,l=e.length;a<l;a++){const h=e[a];if(o=o&&!h.independent,s>-1&&i<h.start)break;const c=h.loaded;c?s=-1:(r||h.independent||o)&&h.fragment===t&&(s=a),r=c}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=IT(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const o=t[r-e.startSN];i.cc===o.cc&&(s=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=Qf(e,i.cc,i.end),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:o,endSN:a}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:h}=s,c=i.partList,u=!!(this.loadingParts&&c!=null&&c.length&&l);u&&l&&!this.bitrateTest&&c[c.length-1].fragment.sn===l.sn&&(o=o.concat(l),a=l.sn);let d;if(e<t){var f;const p=e<this.lastCurrentTime||e>t-h||(f=this.media)!=null&&f.paused||!this.startFragRequested?0:h;d=fs(r,o,e,p)}else d=o[o.length-1];if(d){const g=d.sn-i.startSN,p=this.fragmentTracker.getState(d);if((p===$e.OK||p===$e.PARTIAL&&d.gap)&&(r=d),r&&d.sn===r.sn&&(!u||c[0].fragment.sn>d.sn||!i.live&&!u)&&r&&d.level===r.level){const _=o[g+1];d.sn<a&&this.fragmentTracker.getState(_)!==$e.OK?d=_:d=null}}return d}alignPlaylists(e,t,i){const s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,o=!t,a=e.alignedSliding&&K(r);if(o||!a&&!r){fS(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${s}`),l}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const s=this.timelineOffset;if(i===-1){const r=this.startTimeOffset!==null,o=r?this.startTimeOffset:e.startTimeOffset;o!==null&&K(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+s}this.nextLoadPosition=i+s}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Ve(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==N.FRAG_LOADING_WAITING_RETRY)&&(this.state=N.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const g=this.getCurrentContext(t.chunkMeta);g&&(t.frag=g.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=t.details===D.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const o=t.errorAction,{action:a,flags:l,retryCount:h=0,retryConfig:c}=o||{},u=!!o&&!!c,d=u&&a===Ze.RetryRequest,f=u&&!o.resolved&&l===Ct.MoveAllAlternatesMatchingHost;if(!d&&f&&Ve(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),o.resolved=!0;else if((d||f)&&h<c.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const g=wh(c,h);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${h+1}/${c.maxNumRetry} in ${g}ms`),o.resolved=!0,this.retryDate=self.performance.now()+g,this.state=N.FRAG_LOADING_WAITING_RETRY}else if(c&&o)if(this.resetFragmentErrors(e),h<c.maxNumRetry)!r&&a!==Ze.RemoveAlternatePermanently&&(o.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${h})`);return}else a===Ze.SendAlternateToPenaltyBox?this.state=N.WAITING_LEVEL:this.state=N.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===N.PARSING||this.state===N.PARSED){const t=e.frag,i=e.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,(t==null?void 0:t.duration)||10);const o=!r;return o&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===q.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==N.STOPPED&&(this.state=N.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=ne.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===N.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==N.STOPPED&&(this.state=N.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){const r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,h)=>{const c=e.elementaryStreams[h];if(c){const u=c.endPTS-c.startPTS;if(u<=0)return this.warn(`Could not parse fragment ${e.sn} ${h} duration reliably (${u})`),l||!1;const d=s?0:rg(r,e,c.startPTS,c.endPTS,c.startDTS,c.endDTS);return this.hls.trigger(x.LEVEL_PTS_UPDATED,{details:r,level:i,drift:d,type:h,frag:e,start:c.startPTS,end:c.endPTS}),!0}return l},!1)){var a;if(i.fragmentError===0&&this.treatAsGap(e,i),((a=this.transmuxer)==null?void 0:a.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=N.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(x.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===q.MAIN?"level":"track"}fragInfo(e,t=!0,i){var s,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((s=t&&!i?e.startPTS:(i||e).start)!=null?s:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function Tu(n){return!!n.interstitialsController&&n.enableInterstitialPlayback!==!1}class dg{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=pS(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function pS(n,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<n.length;s++){const r=n[s];t.set(r,i),i+=r.length}return t}var Fa={exports:{}},Su;function mS(){return Su||(Su=1,function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(l,h,c){this.fn=l,this.context=h,this.once=c||!1}function r(l,h,c,u,d){if(typeof c!="function")throw new TypeError("The listener must be a function");var f=new s(c,u||l,d),g=t?t+h:h;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],f]:l._events[g].push(f):(l._events[g]=f,l._eventsCount++),l}function o(l,h){--l._eventsCount===0?l._events=new i:delete l._events[h]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var h=[],c,u;if(this._eventsCount===0)return h;for(u in c=this._events)e.call(c,u)&&h.push(t?u.slice(1):u);return Object.getOwnPropertySymbols?h.concat(Object.getOwnPropertySymbols(c)):h},a.prototype.listeners=function(h){var c=t?t+h:h,u=this._events[c];if(!u)return[];if(u.fn)return[u.fn];for(var d=0,f=u.length,g=new Array(f);d<f;d++)g[d]=u[d].fn;return g},a.prototype.listenerCount=function(h){var c=t?t+h:h,u=this._events[c];return u?u.fn?1:u.length:0},a.prototype.emit=function(h,c,u,d,f,g){var p=t?t+h:h;if(!this._events[p])return!1;var m=this._events[p],_=arguments.length,T,S;if(m.fn){switch(m.once&&this.removeListener(h,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,c),!0;case 3:return m.fn.call(m.context,c,u),!0;case 4:return m.fn.call(m.context,c,u,d),!0;case 5:return m.fn.call(m.context,c,u,d,f),!0;case 6:return m.fn.call(m.context,c,u,d,f,g),!0}for(S=1,T=new Array(_-1);S<_;S++)T[S-1]=arguments[S];m.fn.apply(m.context,T)}else{var v=m.length,E;for(S=0;S<v;S++)switch(m[S].once&&this.removeListener(h,m[S].fn,void 0,!0),_){case 1:m[S].fn.call(m[S].context);break;case 2:m[S].fn.call(m[S].context,c);break;case 3:m[S].fn.call(m[S].context,c,u);break;case 4:m[S].fn.call(m[S].context,c,u,d);break;default:if(!T)for(E=1,T=new Array(_-1);E<_;E++)T[E-1]=arguments[E];m[S].fn.apply(m[S].context,T)}}return!0},a.prototype.on=function(h,c,u){return r(this,h,c,u,!1)},a.prototype.once=function(h,c,u){return r(this,h,c,u,!0)},a.prototype.removeListener=function(h,c,u,d){var f=t?t+h:h;if(!this._events[f])return this;if(!c)return o(this,f),this;var g=this._events[f];if(g.fn)g.fn===c&&(!d||g.once)&&(!u||g.context===u)&&o(this,f);else{for(var p=0,m=[],_=g.length;p<_;p++)(g[p].fn!==c||d&&!g[p].once||u&&g[p].context!==u)&&m.push(g[p]);m.length?this._events[f]=m.length===1?m[0]:m:o(this,f)}return this},a.prototype.removeAllListeners=function(h){var c;return h?(c=t?t+h:h,this._events[c]&&o(this,c)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a}(Fa)),Fa.exports}var _S=mS(),kh=Ky(_S);const Fr="1.6.5",er={};function xS(){return typeof __HLS_WORKER_BUNDLE__=="function"}function yS(){const n=er[Fr];if(n)return n.clientCount++,n;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),s={worker:new self.Worker(t),objectURL:t,clientCount:1};return er[Fr]=s,s}function TS(n){const e=er[n];if(e)return e.clientCount++,e;const t=new self.URL(n,self.location.href).href,s={worker:new self.Worker(t),scriptURL:t,clientCount:1};return er[n]=s,s}function SS(n){const e=er[n||Fr];if(e&&e.clientCount--===1){const{worker:i,objectURL:s}=e;delete er[n||Fr],s&&self.URL.revokeObjectURL(s),i.terminate()}}function fg(n,e){return e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function Oh(n,e){return e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function aa(n,e){let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t}function kr(n,e){const t=e;let i=0;for(;Oh(n,e);){i+=10;const s=aa(n,e+6);i+=s,fg(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)}function vS(n,e,t,i){const s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],o=r>>2&15;if(o>12){const f=new Error(`invalid ADTS sampling index:${o}`);n.emit(x.ERROR,x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!0,error:f,reason:f.message});return}const a=(r>>6&3)+1,l=e[t+3]>>6&3|(r&1)<<2,h="mp4a.40."+a,c=s[o];let u=o;(a===5||a===29)&&(u-=3);const d=[a<<3|(u&14)>>1,(u&1)<<7|l<<3];return pe.log(`manifest codec:${i}, parsed codec:${h}, channels:${l}, rate:${c} (ADTS object type:${a} sampling index:${o})`),{config:d,samplerate:c,channelCount:l,codec:h,parsedCodec:h,manifestCodec:i}}function gg(n,e){return n[e]===255&&(n[e+1]&246)===240}function pg(n,e){return n[e+1]&1?7:9}function Bh(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function ES(n,e){return e+5<n.length}function $o(n,e){return e+1<n.length&&gg(n,e)}function bS(n,e){return ES(n,e)&&gg(n,e)&&Bh(n,e)<=n.length-e}function AS(n,e){if($o(n,e)){const t=pg(n,e);if(e+t>=n.length)return!1;const i=Bh(n,e);if(i<=t)return!1;const s=e+i;return s===n.length||$o(n,s)}return!1}function mg(n,e,t,i,s){if(!n.samplerate){const r=vS(e,t,i,s);if(!r)return;Ee(n,r)}}function _g(n){return 1024*9e4/n}function RS(n,e){const t=pg(n,e);if(e+t<=n.length){const i=Bh(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function xg(n,e,t,i,s){const r=_g(n.samplerate),o=i+s*r,a=RS(e,t);let l;if(a){const{frameLength:u,headerLength:d}=a,f=d+u,g=Math.max(0,t+f-e.length);g?(l=new Uint8Array(f-d),l.set(e.subarray(t+d,e.length),0)):l=e.subarray(t+d,t+f);const p={unit:l,pts:o};return g||n.samples.push(p),{sample:p,length:f,missing:g}}const h=e.length-t;return l=new Uint8Array(h),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:o},length:h,missing:-1}}function CS(n,e){return Oh(n,e)&&aa(n,e+6)+10<=n.length-e}function LS(n){return n instanceof ArrayBuffer?n:n.byteOffset==0&&n.byteLength==n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer}function ka(n,e=0,t=1/0){return wS(n,e,t,Uint8Array)}function wS(n,e,t,i){const s=IS(n);let r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);const o=PS(n)?n.byteOffset:0,a=(o+n.byteLength)/r,l=(o+e)/r,h=Math.floor(Math.max(0,Math.min(l,a))),c=Math.floor(Math.min(h+Math.max(t,0),a));return new i(s,h,c-h)}function IS(n){return n instanceof ArrayBuffer?n:n.buffer}function PS(n){return n&&n.buffer instanceof ArrayBuffer&&n.byteLength!==void 0&&n.byteOffset!==void 0}function DS(n){const e={key:n.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(n.size<2)return;if(n.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=n.data.subarray(1).indexOf(0);if(i===-1)return;const s=mt(ka(n.data,1,i)),r=n.data[2+i],o=n.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=mt(ka(n.data,3+i,o));let l;return s==="-->"?l=mt(ka(n.data,4+i+o)):l=LS(n.data.subarray(4+i+o)),e.mimeType=s,e.pictureType=r,e.description=a,e.data=l,e}function MS(n){if(n.size<2)return;const e=mt(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}}function FS(n){if(n.size<2)return;if(n.type==="TXXX"){let t=1;const i=mt(n.data.subarray(t),!0);t+=i.length+1;const s=mt(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=mt(n.data.subarray(1));return{key:n.type,info:"",data:e}}function kS(n){if(n.type==="WXXX"){if(n.size<2)return;let t=1;const i=mt(n.data.subarray(t),!0);t+=i.length+1;const s=mt(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=mt(n.data);return{key:n.type,info:"",data:e}}function OS(n){return n.type==="PRIV"?MS(n):n.type[0]==="W"?kS(n):n.type==="APIC"?DS(n):FS(n)}function BS(n){const e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=aa(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}}const Dn=10,US=10;function yg(n){let e=0;const t=[];for(;Oh(n,e);){const i=aa(n,e+6);n[e+5]>>6&1&&(e+=Dn),e+=Dn;const s=e+i;for(;e+US<s;){const r=BS(n.subarray(e)),o=OS(r);o&&t.push(o),e+=r.size+Dn}fg(n,e)&&(e+=Dn)}return t}function Tg(n){return n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp"}function NS(n){if(n.data.byteLength===8){const e=new Uint8Array(n.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function Uh(n){const e=yg(n);for(let t=0;t<e.length;t++){const i=e[t];if(Tg(i))return NS(i)}}let dt=function(n){return n.audioId3="org.id3",n.dateRange="com.apple.quicktime.HLS",n.emsg="https://aomedia.org/emsg/ID3",n.misbklv="urn:misb:KLV:bin:1910.1",n}({});function $t(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Nh{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=At(this.cachedData,e),this.cachedData=null);let i=kr(e,0),s=i?i.length:0,r;const o=this._audioTrack,a=this._id3Track,l=i?Uh(i):void 0,h=e.length;for((this.basePTS===null||this.frameIndex===0&&K(l))&&(this.basePTS=$S(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:dt.audioId3,duration:Number.POSITIVE_INFINITY});s<h;){if(this.canParse(e,s)){const c=this.appendFrame(o,e,s);c?(this.frameIndex++,this.lastPTS=c.sample.pts,s+=c.length,r=s):s=h}else CS(e,s)?(i=kr(e,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:dt.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===h&&r!==h){const c=e.slice(r);this.cachedData?this.cachedData=At(this.cachedData,c):this.cachedData=c}}return{audioTrack:o,videoTrack:$t(),id3Track:a,textTrack:$t()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:$t(),id3Track:this._id3Track,textTrack:$t()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const $S=(n,e,t)=>{if(K(n))return n*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let Mn=null;const zS=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],GS=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],HS=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],VS=[0,1,1,4];function Sg(n,e,t,i,s){if(t+24>e.length)return;const r=vg(e,t);if(r&&t+r.frameLength<=e.length){const o=r.samplesPerFrame*9e4/r.sampleRate,a=i+s*o,l={unit:e.subarray(t,t+r.frameLength),pts:a,dts:a};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function vg(n,e){const t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const o=n[e+2]>>1&1,a=n[e+3]>>6,l=t===3?3-i:i===3?3:4,h=zS[l*14+s-1]*1e3,u=GS[(t===3?0:t===2?1:2)*3+r],d=a===3?1:2,f=HS[t][i],g=VS[i],p=f*8*g,m=Math.floor(f*h/u+o)*g;if(Mn===null){const S=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Mn=S?parseInt(S[1]):0}return!!Mn&&Mn<=87&&i===2&&h>=224e3&&a===0&&(n[e+3]=n[e+3]|128),{sampleRate:u,channelCount:d,frameLength:m,samplesPerFrame:p}}}function $h(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function Eg(n,e){return e+1<n.length&&$h(n,e)}function WS(n,e){return $h(n,e)&&4<=n.length-e}function bg(n,e){if(e+1<n.length&&$h(n,e)){const i=vg(n,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===n.length||Eg(n,r)}return!1}class YS extends Nh{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=kr(e,0);let s=(i==null?void 0:i.length)||0;if(bg(e,s))return!1;for(let r=e.length;s<r;s++)if(AS(e,s))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return bS(e,t)}appendFrame(e,t,i){mg(e,this.observer,t,i,e.manifestCodec);const s=xg(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const Ag=(n,e)=>{let t=0,i=5;e+=i;const s=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=n[e];const a=Math.min(i,8),l=8-a;r[0]=4278190080>>>24+l<<l,s[0]=(o[0]&r[0])>>l,t=t?t<<a|s[0]:s[0],e+=1,i-=a}return t};class KS extends Nh{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const s=Rg(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;const t=kr(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&Uh(t)!==void 0&&Ag(e,i)<16}}function Rg(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],l=e[t+4]&63,c=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+r]*2;if(t+c>e.length)return-1;const u=e[t+6]>>5;let d=0;u===2?d+=2:(u&1&&u!==1&&(d+=2),u&4&&(d+=2));const f=(e[t+6]<<8|e[t+7])>>12-d&1,p=[2,1,2,3,3,4,4,5][u]+f,m=e[t+5]>>3,_=e[t+5]&7,T=new Uint8Array([r<<6|m<<1|_>>2,(_&3)<<6|u<<3|f<<2|l>>4,l<<4&224]),S=1536/a*9e4,v=i+s*S,E=e.subarray(t,t+c);return n.config=T,n.channelCount=p,n.samplerate=a,n.samples.push({unit:E,pts:v}),c}class XS extends Nh{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=kr(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&Uh(t)!==void 0&&Ag(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(bg(e,i))return pe.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return WS(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return Sg(e,t,i,this.basePTS,this.frameIndex)}}const jS=/\/emsg[-/]ID3/i;class qS{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=$t("video",1),o=this.audioTrack=$t("audio",1),a=this.txtTrack=$t("text",1);if(this.id3Track=$t("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=Nf(e);if(l.video){const{id:h,timescale:c,codec:u,supplemental:d}=l.video;r.id=h,r.timescale=a.timescale=c,r.codec=u,r.supplemental=d}if(l.audio){const{id:h,timescale:c,codec:u}=l.audio;o.id=h,o.timescale=c,o.codec=u}a.id=Of.text,r.sampleDuration=0,r.duration=o.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return Zy(e)}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=At(this.remainderData,e));const a=nT(i);this.remainderData=a.remainder,s.samples=a.valid||new Uint8Array}else s.samples=i;const o=this.extractID3Track(s,t);return r.samples=Gc(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=Gc(e,t),{videoTrack:t,audioTrack:$t(),id3Track:s,textTrack:$t()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=he(e.samples,["emsg"]);s&&s.forEach(r=>{const o=aT(r);if(jS.test(o.schemeIdUri)){const a=vu(o,t);let l=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const h=o.payload;i.samples.push({data:h,len:h.byteLength,dts:a,pts:a,type:dt.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=vu(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:dt.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function vu(n,e){return K(n.presentationTime)?n.presentationTime/n.timeScale:e+n.presentationTimeDelta/n.timeScale}class QS{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Ih(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Vi.cbc)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(o).then(a=>{const l=new Uint8Array(a);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const o=zf(r.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(o,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const o=r[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,s,o),!this.decrypter.isSync()))return}}}}class Cg{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,s=i.length;if(s){const r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const s=t.byteLength;let r=e.naluState||0;const o=r,a=[];let l=0,h,c,u,d=-1,f=0;for(r===-1&&(d=0,f=this.getNALuType(t,0),r=0,l=1);l<s;){if(h=t[l++],!r){r=h?0:1;continue}if(r===1){r=h?0:2;continue}if(!h)r=3;else if(h===1){if(c=l-r-1,d>=0){const g={data:t.subarray(d,c),type:f};a.push(g)}else{const g=this.getLastNalUnit(e.samples);g&&(o&&l<=4-o&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-o)),c>0&&(g.data=At(g.data,t.subarray(0,c)),g.state=0))}l<s?(u=this.getNALuType(t,l),d=l,f=u,r=0):r=-1}else r=0}if(d>=0&&r>=0){const g={data:t.subarray(d,s),type:f,state:r};a.push(g)}if(a.length===0){const g=this.getLastNalUnit(e.samples);g&&(g.data=At(g.data,t))}return e.naluState=r,a}}class vr{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&pe.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Eu extends Cg{parsePES(e,t,i,s){const r=this.parseNALu(e,i.data,s);let o=this.VideoSample,a,l=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(h=>{var c,u;switch(h.type){case 1:{let p=!1;a=!0;const m=h.data;if(l&&m.length>4){const _=this.readSliceType(m);(_===2||_===4||_===7||_===9)&&(p=!0)}if(p){var d;(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=p;break}case 5:a=!0,(c=o)!=null&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,Lh(h.data,1,i.pts,t.samples);break}case 7:{var f,g;a=!0,l=!0;const p=h.data,m=this.readSPS(p);if(!e.sps||e.width!==m.width||e.height!==m.height||((f=e.pixelRatio)==null?void 0:f[0])!==m.pixelRatio[0]||((g=e.pixelRatio)==null?void 0:g[1])!==m.pixelRatio[1]){e.width=m.width,e.height=m.height,e.pixelRatio=m.pixelRatio,e.sps=[p];const _=p.subarray(1,4);let T="avc1.";for(let S=0;S<3;S++){let v=_[S].toString(16);v.length<2&&(v="0"+v),T+=v}e.codec=T}break}case 8:a=!0,e.pps=[h.data];break;case 9:a=!0,e.audFound=!0,(u=o)!=null&&u.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(h)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new vr(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,s=8,r;for(let o=0;o<e;o++)s!==0&&(r=t.readEG(),s=(i+r+256)%256),i=s===0?i:s}readSPS(e){const t=new vr(e);let i=0,s=0,r=0,o=0,a,l,h;const c=t.readUByte.bind(t),u=t.readBits.bind(t),d=t.readUEG.bind(t),f=t.readBoolean.bind(t),g=t.skipBits.bind(t),p=t.skipEG.bind(t),m=t.skipUEG.bind(t),_=this.skipScalingList.bind(this);c();const T=c();if(u(5),g(3),c(),m(),T===100||T===110||T===122||T===244||T===44||T===83||T===86||T===118||T===128){const A=d();if(A===3&&g(1),m(),m(),g(1),f())for(l=A!==3?8:12,h=0;h<l;h++)f()&&(h<6?_(16,t):_(64,t))}m();const S=d();if(S===0)d();else if(S===1)for(g(1),p(),p(),a=d(),h=0;h<a;h++)p();m(),g(1);const v=d(),E=d(),C=u(1);C===0&&g(1),g(1),f()&&(i=d(),s=d(),r=d(),o=d());let b=[1,1];if(f()&&f())switch(c()){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:{b=[c()<<8|c(),c()<<8|c()];break}}return{width:Math.ceil((v+1)*16-i*2-s*2),height:(2-C)*(E+1)*16-(C?2:4)*(r+o),pixelRatio:b}}}class bu extends Cg{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,s){const r=this.parseNALu(e,i.data,s);let o=this.VideoSample,a,l=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(h=>{var c,u;switch(h.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,l){var d;(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(c=o)!=null&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,Lh(h.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=Ee(e.params,this.readVPS(h.data)),this.initVPS=h.data),e.vps=[h.data];break;case 33:if(a=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],h.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const f=this.readSPS(h.data);e.width=f.width,e.height=f.height,e.pixelRatio=f.pixelRatio,e.codec=f.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const g in f.params)e.params[g]=f.params[g]}this.pushParameterSet(e.sps,h.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const f=this.readPPS(h.data);for(const g in f)e.params[g]=f[g]}this.pushParameterSet(e.pps,h.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(u=o)!=null&&u.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(h)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let s=0;s<e.byteLength;s++)s>=2&&e[s]===3&&e[s-1]===0&&e[s-2]===0||(t[i]=e[s],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new vr(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),s=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:s}}readSPS(e){const t=new vr(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const s=t.readBits(2),r=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),l=t.readUByte(),h=t.readUByte(),c=t.readUByte(),u=t.readUByte(),d=t.readUByte(),f=t.readUByte(),g=t.readUByte(),p=t.readUByte(),m=t.readUByte(),_=t.readUByte(),T=[],S=[];for(let de=0;de<i;de++)T.push(t.readBoolean()),S.push(t.readBoolean());if(i>0)for(let de=i;de<8;de++)t.readBits(2);for(let de=0;de<i;de++)T[de]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),S[de]&&t.readUByte();t.readUEG();const v=t.readUEG();v==3&&t.skipBits(1);const E=t.readUEG(),C=t.readUEG(),b=t.readBoolean();let A=0,L=0,R=0,M=0;b&&(A+=t.readUEG(),L+=t.readUEG(),R+=t.readUEG(),M+=t.readUEG());const F=t.readUEG(),z=t.readUEG(),G=t.readUEG(),k=t.readBoolean();for(let de=k?0:i;de<=i;de++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let xe=0;xe<4;xe++)for(let De=0;De<(xe===3?2:6);De++)if(!t.readBoolean())t.readUEG();else{const Ie=Math.min(64,1<<4+(xe<<1));xe>1&&t.readEG();for(let ci=0;ci<Ie;ci++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const V=t.readUEG();let B=0;for(let de=0;de<V;de++){let xe=!1;if(de!==0&&(xe=t.readBoolean()),xe){de===V&&t.readUEG(),t.readBoolean(),t.readUEG();let De=0;for(let et=0;et<=B;et++){const Ie=t.readBoolean();let ci=!1;Ie||(ci=t.readBoolean()),(Ie||ci)&&De++}B=De}else{const De=t.readUEG(),et=t.readUEG();B=De+et;for(let Ie=0;Ie<De;Ie++)t.readUEG(),t.readBoolean();for(let Ie=0;Ie<et;Ie++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const de=t.readUEG();for(let xe=0;xe<de;xe++){for(let De=0;De<G+4;De++)t.readBits(1);t.readBits(1)}}let Y=0,W=1,Q=1,te=!0,re=1,J=0;t.readBoolean(),t.readBoolean();let me=!1;if(t.readBoolean()){if(t.readBoolean()){const Qe=t.readUByte(),Yi=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],ui=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Qe>0&&Qe<16?(W=Yi[Qe-1],Q=ui[Qe-1]):Qe===255&&(W=t.readBits(16),Q=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),me=t.readBoolean(),me&&(A+=t.readUEG(),L+=t.readUEG(),R+=t.readUEG(),M+=t.readUEG()),t.readBoolean()&&(re=t.readBits(32),J=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const ui=t.readBoolean(),Ki=t.readBoolean();let st=!1;(ui||Ki)&&(st=t.readBoolean(),st&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),st&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Wr=0;Wr<=i;Wr++){te=t.readBoolean();const Ft=te||t.readBoolean();let Xi=!1;Ft?t.readEG():Xi=t.readBoolean();const ms=Xi?1:t.readUEG()+1;if(ui)for(let kt=0;kt<ms;kt++)t.readUEG(),t.readUEG(),st&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(Ki)for(let kt=0;kt<ms;kt++)t.readUEG(),t.readUEG(),st&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),Y=t.readUEG())}let Be=E,Ke=C;if(b||me){let de=1,xe=1;v===1?de=xe=2:v==2&&(de=2),Be=E-de*L-de*A,Ke=C-xe*M-xe*R}const ht=s?["A","B","C"][s]:"",_e=a<<24|l<<16|h<<8|c;let Mt=0;for(let de=0;de<32;de++)Mt=(Mt|(_e>>de&1)<<31-de)>>>0;let it=Mt.toString(16);return o===1&&it==="2"&&(it="6"),{codecString:`hvc1.${ht}${o}.${it}.${r?"H":"L"}${_}.B0`,params:{general_tier_flag:r,general_profile_idc:o,general_profile_space:s,general_profile_compatibility_flags:[a,l,h,c],general_constraint_indicator_flags:[u,d,f,g,p,m],general_level_idc:_,bit_depth:F+8,bit_depth_luma_minus8:F,bit_depth_chroma_minus8:z,min_spatial_segmentation_idc:Y,chroma_format_idc:v,frame_rate:{fixed:te,fps:J/re}},width:Be,height:Ke,pixelRatio:[W,Q]}}readPPS(e){const t=new vr(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const s=t.readBoolean(),r=t.readBoolean();let o=1;return r&&s?o=0:r?o=3:s&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Ge=188;class Mi{constructor(e,t,i,s){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=s,this.videoParser=null}static probe(e,t){const i=Mi.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Ge*5,t-Ge)+1,s=0;for(;s<i;){let r=!1,o=-1,a=0;for(let l=s;l<t;l+=Ge)if(e[l]===71&&(t-l===Ge||e[l+Ge]===71)){if(a++,o===-1&&(o=l,o!==0&&(i=Math.min(o+Ge*99,e.length-Ge)+1)),r||(r=Ol(e,l)===0),r&&a>1&&(o===0&&a>2||l+Ge>i))return o}else{if(a)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Of[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Mi.createTrack("video"),this._videoTrack.duration=s,this._audioTrack=Mi.createTrack("audio",s),this._id3Track=Mi.createTrack("id3"),this._txtTrack=Mi.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const o=this._videoTrack,a=this._audioTrack,l=this._id3Track,h=this._txtTrack;let c=o.pid,u=o.pesData,d=a.pid,f=l.pid,g=a.pesData,p=l.pesData,m=null,_=this.pmtParsed,T=this._pmtId,S=e.length;if(this.remainderData&&(e=At(this.remainderData,e),S=e.length,this.remainderData=null),S<Ge&&!s)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:l,textTrack:h};const v=Math.max(0,Mi.syncOffset(e));S-=(S-v)%Ge,S<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,S,e.buffer.byteLength-S));let E=0;for(let b=v;b<S;b+=Ge)if(e[b]===71){const A=!!(e[b+1]&64),L=Ol(e,b),R=(e[b+3]&48)>>4;let M;if(R>1){if(M=b+5+e[b+4],M===b+Ge)continue}else M=b+4;switch(L){case c:if(A){if(u&&(r=Ss(u,this.logger))){if(this.videoParser===null)switch(o.segmentCodec){case"avc":this.videoParser=new Eu;break;case"hevc":this.videoParser=new bu;break}this.videoParser!==null&&this.videoParser.parsePES(o,h,r,!1)}u={data:[],size:0}}u&&(u.data.push(e.subarray(M,b+Ge)),u.size+=b+Ge-M);break;case d:if(A){if(g&&(r=Ss(g,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r);break}g={data:[],size:0}}g&&(g.data.push(e.subarray(M,b+Ge)),g.size+=b+Ge-M);break;case f:A&&(p&&(r=Ss(p,this.logger))&&this.parseID3PES(l,r),p={data:[],size:0}),p&&(p.data.push(e.subarray(M,b+Ge)),p.size+=b+Ge-M);break;case 0:A&&(M+=e[M]+1),T=this._pmtId=ZS(e,M);break;case T:{A&&(M+=e[M]+1);const F=JS(e,M,this.typeSupported,i,this.observer,this.logger);c=F.videoPid,c>0&&(o.pid=c,o.segmentCodec=F.segmentVideoCodec),d=F.audioPid,d>0&&(a.pid=d,a.segmentCodec=F.segmentAudioCodec),f=F.id3Pid,f>0&&(l.pid=f),m!==null&&!_&&(this.logger.warn(`MPEG-TS PMT found at ${b} after unknown PID '${m}'. Backtracking to sync byte @${v} to parse all TS packets.`),m=null,b=v-188),_=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=L;break}}else E++;E>0&&Bl(this.observer,new Error(`Found ${E} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=u,a.pesData=g,l.pesData=p;const C={audioTrack:a,videoTrack:o,id3Track:l,textTrack:h};return s&&this.extractRemainingSamples(C),C}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,o=i.pesData,a=t.pesData,l=s.pesData;let h;if(o&&(h=Ss(o,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new Eu;break;case"hevc":this.videoParser=new bu;break}this.videoParser!==null&&(this.videoParser.parsePES(i,r,h,!0),i.pesData=null)}else i.pesData=o;if(a&&(h=Ss(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,h);break;case"mp3":this.parseMPEGPES(t,h);break;case"ac3":this.parseAC3PES(t,h);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;l&&(h=Ss(l,this.logger))?(this.parseID3PES(s,h),s.pesData=null):s.pesData=l}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new QS(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const u=s.missing,d=s.sample.unit.byteLength;if(u===-1)r=At(s.sample.unit,r);else{const f=d-u;s.sample.unit.set(r.subarray(0,u),f),e.samples.push(s.sample),i=s.missing}}let o,a;for(o=i,a=r.length;o<a-1&&!$o(r,o);o++);if(o!==i){let u;const d=o<a-1;if(d?u=`AAC PES did not start with ADTS header,offset:${o}`:u="No ADTS header found in AAC PES",Bl(this.observer,new Error(u),d,this.logger),!d)return}mg(e,this.observer,r,o,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(s){const u=_g(e.samplerate);l=s.sample.pts+u}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let h=0,c;for(;o<a;)if(c=xg(e,r,o,l,h),o+=c.length,c.missing){this.aacOverFlow=c;break}else for(h++;o<a-1&&!$o(r,o);o++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<s;)if(Eg(i,o)){const l=Sg(e,i,o,a,r);if(l)o+=l.length,r++;else break}else o++}parseAC3PES(e,t){{const i=t.data,s=t.pts;if(s===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let o=0,a=0,l;for(;a<r&&(l=Rg(e,i,a,s,o++))>0;)a+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=Ee({},t,{type:this._videoTrack?dt.emsg:dt.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Ol(n,e){return((n[e+1]&31)<<8)+n[e+2]}function ZS(n,e){return(n[e+10]&31)<<8|n[e+11]}function JS(n,e,t,i,s,r){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(n[e+1]&15)<<8|n[e+2],l=e+3+a-4,h=(n[e+10]&15)<<8|n[e+11];for(e+=12+h;e<l;){const c=Ol(n,e),u=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){Oa("ADTS AAC",r);break}case 15:o.audioPid===-1&&(o.audioPid=c);break;case 21:o.id3Pid===-1&&(o.id3Pid=c);break;case 219:if(!i){Oa("H.264",r);break}case 27:o.videoPid===-1&&(o.videoPid=c);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=c,o.segmentAudioCodec="mp3");break;case 193:if(!i){Oa("AC-3",r);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=c,o.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&u>0){let d=e+5,f=u;for(;f>2;){switch(n[d]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=c,o.segmentAudioCodec="ac3");break}const p=n[d+1]+2;d+=p,f-=p}}break;case 194:case 135:return Bl(s,new Error("Unsupported EC-3 in M2TS found"),void 0,r),o;case 36:o.videoPid===-1&&(o.videoPid=c,o.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=u+5}return o}function Bl(n,e,t,i){i.warn(`parsing error: ${e.message}`),n.emit(x.ERROR,x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Oa(n,e){e.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Ss(n,e){let t=0,i,s,r,o,a;const l=n.data;if(!n||n.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=At(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(s=(i[4]<<8)+i[5],s&&s>n.size-6)return null;const c=i[7];c&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,c&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),r=i[8];let u=r+9;if(n.size<=u)return null;n.size-=u;const d=new Uint8Array(n.size);for(let f=0,g=l.length;f<g;f++){i=l[f];let p=i.byteLength;if(u)if(u>p){u-=p;continue}else i=i.subarray(u),p-=u,u=0;d.set(i,t),t+=p}return s&&(s-=r+3),{data:d,pts:o,dts:a,len:s}}return null}class ev{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ai=Math.pow(2,32)-1;class P{static init(){P.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in P.types)P.types.hasOwnProperty(e)&&(P.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);P.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);P.STTS=P.STSC=P.STCO=r,P.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),P.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),P.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),P.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);P.FTYP=P.box(P.types.ftyp,o,l,o,a),P.DINF=P.box(P.types.dinf,P.box(P.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),s=0,i=8;s<r;s++)o.set(t[s],i),i+=t[s].byteLength;return o}static hdlr(e){return P.box(P.types.hdlr,P.HDLR_TYPES[e])}static mdat(e){return P.box(P.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Ai+1)),s=Math.floor(t%(Ai+1));return P.box(P.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return P.box(P.types.mdia,P.mdhd(e.timescale||0,e.duration||0),P.hdlr(e.type),P.minf(e))}static mfhd(e){return P.box(P.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?P.box(P.types.minf,P.box(P.types.smhd,P.SMHD),P.DINF,P.stbl(e)):P.box(P.types.minf,P.box(P.types.vmhd,P.VMHD),P.DINF,P.stbl(e))}static moof(e,t,i){return P.box(P.types.moof,P.mfhd(e),P.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trak(e[t]);return P.box.apply(null,[P.types.moov,P.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(P.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trex(e[t]);return P.box.apply(null,[P.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Ai+1)),s=Math.floor(t%(Ai+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return P.box(P.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return P.box(P.types.sdtp,i)}static stbl(e){return P.box(P.types.stbl,P.stsd(e),P.box(P.types.stts,P.STTS),P.box(P.types.stsc,P.STSC),P.box(P.types.stsz,P.STSZ),P.box(P.types.stco,P.STCO))}static avc1(e){let t=[],i=[],s,r,o;for(s=0;s<e.sps.length;s++)r=e.sps[s],o=r.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],o=r.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(r));const a=P.box(P.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,h=e.height,c=e.pixelRatio[0],u=e.pixelRatio[1];return P.box(P.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,c&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return P.box(P.types.mp4a,P.audioStsd(e),P.box(P.types.esds,P.esds(e)))}static mp3(e){return P.box(P.types[".mp3"],P.audioStsd(e))}static ac3(e){return P.box(P.types["ac-3"],P.audioStsd(e),P.box(P.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return P.box(P.types.stsd,P.STSD,P.mp4a(e));if(t==="ac3"&&e.config)return P.box(P.types.stsd,P.STSD,P.ac3(e));if(t==="mp3"&&e.codec==="mp3")return P.box(P.types.stsd,P.STSD,P.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return P.box(P.types.stsd,P.STSD,P.avc1(e));if(t==="hevc"&&e.vps)return P.box(P.types.stsd,P.STSD,P.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),s=e.width||0,r=e.height||0,o=Math.floor(i/(Ai+1)),a=Math.floor(i%(Ai+1));return P.box(P.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=P.sdtp(e),s=e.id,r=Math.floor(t/(Ai+1)),o=Math.floor(t%(Ai+1));return P.box(P.types.traf,P.box(P.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),P.box(P.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,o>>24,o>>16&255,o>>8&255,o&255])),P.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,P.box(P.types.trak,P.tkhd(e),P.mdia(e))}static trex(e){const t=e.id;return P.box(P.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,o=new Uint8Array(r);let a,l,h,c,u,d;for(t+=8+r,o.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<s;a++)l=i[a],h=l.duration,c=l.size,u=l.flags,d=l.cts,o.set([h>>>24&255,h>>>16&255,h>>>8&255,h&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*a);return P.box(P.types.trun,o)}static initSegment(e){P.types||P.init();const t=P.moov(e);return At(P.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],s=4,r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),s-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=r.length;for(let g=0;g<i.length;g+=1){o+=3;for(let p=0;p<i[g].length;p+=1)o+=2+i[g][p].length}const a=new Uint8Array(o);a.set(r,0),o=r.length;const l=i.length-1;for(let g=0;g<i.length;g+=1){a.set(new Uint8Array([32+g|(g===l?128:0),0,i[g].length]),o),o+=3;for(let p=0;p<i[g].length;p+=1)a.set(new Uint8Array([i[g][p].length>>8,i[g][p].length&255]),o),o+=2,a.set(i[g][p],o),o+=i[g][p].length}const h=P.box(P.types.hvcC,a),c=e.width,u=e.height,d=e.pixelRatio[0],f=e.pixelRatio[1];return P.box(P.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),h,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,f>>24,f>>16&255,f>>8&255,f&255])))}}P.types=void 0;P.HDLR_TYPES=void 0;P.STTS=void 0;P.STSC=void 0;P.STCO=void 0;P.STSZ=void 0;P.VMHD=void 0;P.SMHD=void 0;P.STSD=void 0;P.FTYP=void 0;P.DINF=void 0;const Lg=9e4;function zh(n,e,t=1,i=!1){const s=n*e*t;return i?Math.round(s):s}function tv(n,e,t=1,i=!1){return zh(n,e,1/t,i)}function or(n,e=!1){return zh(n,1e3,1/Lg,e)}function iv(n,e=1){return zh(n,Lg,1/e)}const sv=10*1e3,rv=1024,nv=1152,ov=1536;let vs=null,Ba=null;function Au(n,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:n?2:1,isNonSync:n?0:1}}}class no{constructor(e,t,i,s){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=s,this.ISGenerated=!1,vs===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);vs=o?parseInt(o[1]):0}if(Ba===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Ba=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,s=e.reduce((r,o)=>{let a=o.pts,l=a-r;return l<-4294967296&&(t=!0,a=St(a,i),l=a-r),l>0?r:a},i);return t&&this.logger.debug("PTS rollover detected"),s}remux(e,t,i,s,r,o,a,l){let h,c,u,d,f,g,p=r,m=r;const _=e.pid>-1,T=t.pid>-1,S=t.samples.length,v=e.samples.length>0,E=a&&S>0||S>1;if((!_||v)&&(!T||E)||this.ISGenerated||a){if(this.ISGenerated){var b,A,L,R;const G=this.videoTrackConfig;(G&&(t.width!==G.width||t.height!==G.height||((b=t.pixelRatio)==null?void 0:b[0])!==((A=G.pixelRatio)==null?void 0:A[0])||((L=t.pixelRatio)==null?void 0:L[1])!==((R=G.pixelRatio)==null?void 0:R[1]))||!G&&E||this.nextAudioPts===null&&v)&&this.resetInitSegment()}this.ISGenerated||(u=this.generateIS(e,t,r,o));const M=this.isVideoContiguous;let F=-1,z;if(E&&(F=av(t.samples),!M&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,F>0){this.logger.warn(`[mp4-remuxer]: Dropped ${F} out of ${S} video samples due to a missing keyframe`);const G=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(F),t.dropped+=F,m+=(t.samples[0].pts-G)/t.inputTimeScale,z=m}else F===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${S} video samples`),g=!1);if(this.ISGenerated){if(v&&E){const G=this.getVideoStartPts(t.samples),I=(St(e.samples[0].pts,G)-G)/t.inputTimeScale;p+=Math.max(0,I),m+=Math.max(0,-I)}if(v){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),u=this.generateIS(e,t,r,o)),c=this.remuxAudio(e,p,this.isAudioContiguous,o,T||E||l===q.AUDIO?m:void 0),E){const G=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),u=this.generateIS(e,t,r,o)),h=this.remuxVideo(t,m,M,G)}}else E&&(h=this.remuxVideo(t,m,M,0));h&&(h.firstKeyFrame=F,h.independent=F!==-1,h.firstKeyFramePTS=z)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(f=wg(i,r,this._initPTS,this._initDTS)),s.samples.length&&(d=Ig(s,r,this._initPTS))),{audio:c,video:h,initSegment:u,independent:g,text:d,id3:f}}generateIS(e,t,i,s){const r=e.samples,o=t.samples,a=this.typeSupported,l={},h=this._initPTS;let c=!h||s,u="audio/mp4",d,f,g,p;if(c&&(d=f=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(u="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:u,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):P.initSegment([e]),metadata:{channelCount:e.channelCount}},c&&(p=e.id,g=e.inputTimeScale,!h||g!==h.timescale?d=f=r[0].pts-Math.round(g*i):c=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:P.initSegment([t]),metadata:{width:t.width,height:t.height}},c)if(p=t.id,g=t.inputTimeScale,!h||g!==h.timescale){const m=this.getVideoStartPts(o),_=Math.round(g*i);f=Math.min(f,St(o[0].dts,m)-_),d=Math.min(d,m-_)}else c=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,c?(this._initPTS={baseTime:d,timescale:g},this._initDTS={baseTime:f,timescale:g}):d=g=void 0,{tracks:l,initPTS:d,timescale:g,trackId:p}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,o=e.samples,a=[],l=o.length,h=this._initPTS;let c=this.nextAvcDts,u=8,d=this.videoSampleDuration,f,g,p=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,_=!1;if(!i||c===null){const B=t*r,U=o[0].pts-St(o[0].dts,o[0].pts);vs&&c!==null&&Math.abs(B-U-c)<15e3?i=!0:c=B-U}const T=h.baseTime*r/h.timescale;for(let B=0;B<l;B++){const U=o[B];U.pts=St(U.pts-T,c),U.dts=St(U.dts-T,c),U.dts<o[B>0?B-1:B].dts&&(_=!0)}_&&o.sort(function(B,U){const Y=B.dts-U.dts,W=B.pts-U.pts;return Y||W}),f=o[0].dts,g=o[o.length-1].dts;const S=g-f,v=S?Math.round(S/(l-1)):d||e.inputTimeScale/30;if(i){const B=f-c,U=B>v,Y=B<-1;if((U||Y)&&(U?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${or(B,!0)} ms (${B}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${or(-B,!0)} ms (${B}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!Y||c>=o[0].pts||vs)){f=c;const W=o[0].pts-B;if(U)o[0].dts=f,o[0].pts=W;else{let Q=!0;for(let te=0;te<o.length&&!(o[te].dts>W&&Q);te++){const re=o[te].pts;if(o[te].dts-=B,o[te].pts-=B,te<o.length-1){const J=o[te+1].pts,me=o[te].pts,ge=J<=me,Be=J<=re;Q=ge==Be}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${or(W,!0)}/${or(f,!0)}, delta: ${or(B,!0)} ms`)}}f=Math.max(0,f);let E=0,C=0,b=f;for(let B=0;B<l;B++){const U=o[B],Y=U.units,W=Y.length;let Q=0;for(let te=0;te<W;te++)Q+=Y[te].data.length;C+=Q,E+=W,U.length=Q,U.dts<b?(U.dts=b,b+=v/4|0||1):b=U.dts,p=Math.min(U.pts,p),m=Math.max(U.pts,m)}g=o[l-1].dts;const A=C+4*E+8;let L;try{L=new Uint8Array(A)}catch(B){this.observer.emit(x.ERROR,x.ERROR,{type:Z.MUX_ERROR,details:D.REMUX_ALLOC_ERROR,fatal:!1,error:B,bytes:A,reason:`fail allocating video mdat ${A}`});return}const R=new DataView(L.buffer);R.setUint32(0,A),L.set(P.types.mdat,4);let M=!1,F=Number.POSITIVE_INFINITY,z=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,k=Number.NEGATIVE_INFINITY;for(let B=0;B<l;B++){const U=o[B],Y=U.units;let W=0;for(let re=0,J=Y.length;re<J;re++){const me=Y[re],ge=me.data,Be=me.data.byteLength;R.setUint32(u,Be),u+=4,L.set(ge,u),u+=Be,W+=4+Be}let Q;if(B<l-1)d=o[B+1].dts-U.dts,Q=o[B+1].pts-U.pts;else{const re=this.config,J=B>0?U.dts-o[B-1].dts:v;if(Q=B>0?U.pts-o[B-1].pts:v,re.stretchShortVideoTrack&&this.nextAudioPts!==null){const me=Math.floor(re.maxBufferHole*r),ge=(s?p+s*r:this.nextAudioPts)-U.pts;ge>me?(d=ge-J,d<0?d=J:M=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${ge/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=J}else d=J}const te=Math.round(U.pts-U.dts);F=Math.min(F,d),G=Math.max(G,d),z=Math.min(z,Q),k=Math.max(k,Q),a.push(Au(U.key,d,W,te))}if(a.length){if(vs){if(vs<70){const B=a[0].flags;B.dependsOn=2,B.isNonSync=0}}else if(Ba&&k-z<G-F&&v/G<.025&&a[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let B=f;for(let U=0,Y=a.length;U<Y;U++){const W=B+a[U].duration,Q=B+a[U].cts;if(U<Y-1){const te=W+a[U+1].cts;a[U].duration=te-Q}else a[U].duration=U?a[U-1].duration:v;a[U].cts=0,B=W}}}d=M||!d?v:d,this.nextAvcDts=c=g+d,this.videoSampleDuration=d,this.isVideoContiguous=!0;const V={data1:P.moof(e.sequenceNumber++,f,Ee(e,{samples:a})),data2:L,startPTS:p/r,endPTS:(m+d)/r,startDTS:f/r,endDTS:c/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,V}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return nv;case"ac3":return ov;default:return rv}}remuxAudio(e,t,i,s,r){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,l=o/a,h=this.getSamplesPerFrame(e),c=h*l,u=this._initPTS,d=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,f=[],g=r!==void 0;let p=e.samples,m=d?0:8,_=this.nextAudioPts||-1;const T=t*o,S=u.baseTime*o/u.timescale;if(this.isAudioContiguous=i=i||p.length&&_>0&&(s&&Math.abs(T-_)<9e3||Math.abs(St(p[0].pts-S,T)-_)<20*c),p.forEach(function(I){I.pts=St(I.pts-S,T)}),!i||_<0){if(p=p.filter(I=>I.pts>=0),!p.length)return;r===0?_=0:s&&!g?_=Math.max(0,T):_=p[0].pts}if(e.segmentCodec==="aac"){const I=this.config.maxAudioFramesDrift;for(let O=0,V=_;O<p.length;O++){const B=p[O],U=B.pts,Y=U-V,W=Math.abs(1e3*Y/o);if(Y<=-I*c&&g)O===0&&(this.logger.warn(`Audio frame @ ${(U/o).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*Y/o)} ms.`),this.nextAudioPts=_=V=U);else if(Y>=I*c&&W<sv&&g){let Q=Math.round(Y/c);V=U-Q*c,V<0&&(Q--,V+=c),O===0&&(this.nextAudioPts=_=V),this.logger.warn(`[mp4-remuxer]: Injecting ${Q} audio frame @ ${(V/o).toFixed(3)}s due to ${Math.round(1e3*Y/o)} ms gap.`);for(let te=0;te<Q;te++){const re=Math.max(V,0);let J=ev.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);J||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),J=B.unit.subarray()),p.splice(O,0,{unit:J,pts:re}),V+=c,O++}}B.pts=V,V+=c}}let v=null,E=null,C,b=0,A=p.length;for(;A--;)b+=p[A].unit.byteLength;for(let I=0,O=p.length;I<O;I++){const V=p[I],B=V.unit;let U=V.pts;if(E!==null){const W=f[I-1];W.duration=Math.round((U-E)/l)}else if(i&&e.segmentCodec==="aac"&&(U=_),v=U,b>0){b+=m;try{C=new Uint8Array(b)}catch(W){this.observer.emit(x.ERROR,x.ERROR,{type:Z.MUX_ERROR,details:D.REMUX_ALLOC_ERROR,fatal:!1,error:W,bytes:b,reason:`fail allocating audio mdat ${b}`});return}d||(new DataView(C.buffer).setUint32(0,b),C.set(P.types.mdat,4))}else return;C.set(B,m);const Y=B.byteLength;m+=Y,f.push(Au(!0,h,Y,0)),E=U}const L=f.length;if(!L)return;const R=f[f.length-1];this.nextAudioPts=_=E+l*R.duration;const M=d?new Uint8Array(0):P.moof(e.sequenceNumber++,v/l,Ee({},e,{samples:f}));e.samples=[];const F=v/o,z=_/o,k={data1:M,data2:C,startPTS:F,endPTS:z,startDTS:F,endDTS:z,type:"audio",hasAudio:!0,hasVideo:!1,nb:L};return this.isAudioContiguous=!0,k}}function St(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function av(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function wg(n,e,t,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let a=0;a<s;a++){const l=n.samples[a];l.pts=St(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=St(l.dts-i.baseTime*r/i.timescale,e*r)/r}const o=n.samples;return n.samples=[],{samples:o}}function Ig(n,e,t){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let o=0;o<i;o++){const a=n.samples[o];a.pts=St(a.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((o,a)=>o.pts-a.pts);const r=n.samples;return n.samples=[],{samples:r}}class lv{constructor(e,t,i,s){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1,this.logger=s}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(iT(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=Nf(e);s.audio&&(t=Ru(s.audio,Re.AUDIO,this.logger)),s.video&&(i=Ru(s.video,Re.VIDEO,this.logger));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:s.video.supplemental,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,supplemental:s.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,o){var a,l;let{initPTS:h,lastEndTime:c}=this;const u={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};K(c)||(c=this.lastEndTime=r||0);const d=t.samples;if(!(d!=null&&d.length))return u;const f={initPTS:void 0,timescale:void 0,trackId:void 0};let g=this.initData;if((a=g)!=null&&a.length||(this.generateInitSegment(d),g=this.initData),!((l=g)!=null&&l.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),u;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);const p=sT(d,g,this.logger),m=g.audio?p[g.audio.id]:null,_=g.video?p[g.video.id]:null,T=Fn(_,1/0),S=Fn(m,1/0),v=Fn(_,0,!0),E=Fn(m,0,!0);let C,b=r,A=0;if(m&&(!_||!h&&S<T||h&&h.trackId===g.audio.id)?(f.trackId=g.audio.id,C=m,A=E-S):_&&(f.trackId=g.video.id,C=_,A=v-T),C){const I=C.timescale;b=C.start/I,f.timescale=I,h||(f.initPTS=C.start-r*I,this.initPTS=h={baseTime:f.initPTS,timescale:I,trackId:f.trackId})}(o||!h)&&(hv(h,b,r,A)||f.timescale!==h.timescale)&&(f.initPTS=b-r,h&&h.timescale===1&&this.logger.warn(`Adjusting initPTS @${r} from ${h.baseTime/h.timescale} to ${f.initPTS}`),this.initPTS=h={baseTime:f.initPTS,timescale:1});const L=e?b-h.baseTime/h.timescale:c;rT(g,d,h.baseTime/h.timescale);const R=L+A;A>0?this.lastEndTime=R:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const M=!!g.audio,F=!!g.video;let z="";M&&(z+="audio"),F&&(z+="video");const G={data1:d,startPTS:L,startDTS:L,endPTS:R,endDTS:R,type:z,hasAudio:M,hasVideo:F,nb:1,dropped:0};u.audio=M&&!F?G:void 0,u.video=F?G:void 0;const k=_==null?void 0:_.sampleCount;if(k){const I=_.keyFrameIndex,O=I!==-1;G.nb=k,G.dropped=I===0||this.isVideoContiguous?0:O?I:k,G.independent=O,G.firstKeyFrame=I,O&&_.keyFrameStart&&(G.firstKeyFramePTS=_.keyFrameStart-h.baseTime/h.timescale),this.isVideoContiguous||(u.independent=O),this.isVideoContiguous||(this.isVideoContiguous=O),G.dropped&&this.logger.warn(`fmp4 does not start with IDR: firstIDR ${I}/${k} dropped: ${G.dropped} pts: ${G.firstKeyFramePTS||"NA"}`)}return u.initSegment=f,u.id3=wg(i,r,h,h),s.samples.length&&(u.text=Ig(s,r,h)),u}}function Fn(n,e,t=!1){return(n==null?void 0:n.start)!==void 0?(n.start+(t?n.duration:0))/n.timescale:e}function hv(n,e,t,i){if(n===null)return!0;const s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function Ru(n,e,t){const i=n==null?void 0:n.codec;return i&&i.length>4?i:e===Re.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?Mo(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let ei;try{ei=self.performance.now.bind(self.performance)}catch{ei=Date.now}const oo=[{demux:qS,remux:lv},{demux:Mi,remux:no},{demux:YS,remux:no},{demux:XS,remux:no}];oo.splice(2,0,{demux:KS,remux:no});class Cu{constructor(e,t,i,s,r,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=ei();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:h,discontinuity:c,trackSwitch:u,accurateTimeOffset:d,timeOffset:f,initSegmentChange:g}=s||a,{audioCodec:p,videoCodec:m,defaultInitPts:_,duration:T,initSegmentData:S}=l,v=cv(o,t);if(v&&Ks(v.method)){const A=this.getDecrypter(),L=Dh(v.method);if(A.isSync()){let R=A.softwareDecrypt(o,v.key.buffer,v.iv.buffer,L);if(i.part>-1){const F=A.flush();R=F&&F.buffer}if(!R)return r.executeEnd=ei(),Ua(i);o=new Uint8Array(R)}else return this.asyncResult=!0,this.decryptionPromise=A.webCryptoDecrypt(o,v.key.buffer,v.iv.buffer,L).then(R=>{const M=this.push(R,null,i);return this.decryptionPromise=null,M}),this.decryptionPromise}const E=this.needsProbing(c,u);if(E){const A=this.configureTransmuxer(o);if(A)return this.logger.warn(`[transmuxer] ${A.message}`),this.observer.emit(x.ERROR,x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,error:A,reason:A.message}),r.executeEnd=ei(),Ua(i)}(c||u||g||E)&&this.resetInitSegment(S,p,m,T,t),(c||g||E)&&this.resetInitialTimestamp(_),h||this.resetContiguity();const C=this.transmux(o,v,f,d,i);this.asyncResult=Or(C);const b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,r.executeEnd=ei(),C}flush(e){const t=e.transmuxing;t.executeStart=ei();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));const o=[],{timeOffset:a}=s;if(i){const u=i.flush();u&&o.push(this.push(u.buffer,null,e))}const{demuxer:l,remuxer:h}=this;if(!l||!h){t.executeEnd=ei();const u=[Ua(e)];return this.asyncResult?Promise.resolve(u):u}const c=l.flush(a);return Or(c)?(this.asyncResult=!0,c.then(u=>(this.flushRemux(o,u,e),o))):(this.flushRemux(o,c,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:o,textTrack:a}=t,{accurateTimeOffset:l,timeOffset:h}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===q.MAIN?"level":"track"} ${i.level}`);const c=this.remuxer.remux(s,r,o,a,h,l,!0,this.id);e.push({remuxResult:c,chunkMeta:i}),i.transmuxing.executeEnd=ei()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,s),a.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,s,r):o=this.transmuxUnencrypted(e,i,s,r),o}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:o,id3Track:a,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,o,a,l,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s}=this;let r;for(let u=0,d=oo.length;u<d;u++){var o;if((o=oo[u].demux)!=null&&o.probe(e,this.logger)){r=oo[u];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,l=this.remuxer,h=r.remux,c=r.demux;(!l||!(l instanceof h))&&(this.remuxer=new h(i,t,s,this.logger)),(!a||!(a instanceof c))&&(this.demuxer=new c(i,t,s,this.logger),this.probe=c.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Ih(this.config)),e}}function cv(n,e){let t=null;return n.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Ua=n=>({remuxResult:{},chunkMeta:n});function Or(n){return"then"in n&&n.then instanceof Function}class uv{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class dv{constructor(e,t,i,s,r,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=o}}let Lu=0;class Pg{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Lu++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const h=l.data,c=this.hls;if(!(!c||!(h!=null&&h.event)||h.instanceNo!==this.instanceNo))switch(h.event){case"init":{var u;const d=(u=this.workerContext)==null?void 0:u.objectURL;d&&self.URL.revokeObjectURL(d);break}case"transmuxComplete":{this.handleTransmuxComplete(h.data);break}case"flush":{this.onFlush(h.data);break}case"workerLog":{c.logger[h.data.logType]&&c.logger[h.data.logType](h.data.message);break}default:{h.data=h.data||{},h.data.frag=this.frag,h.data.part=this.part,h.data.id=this.id,c.trigger(h.event,h.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const h=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:h})};const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const o=(l,h)=>{h=h||{},h.frag=this.frag||void 0,l===x.ERROR&&(h=h,h.parent=this.id,h.part=this.part,this.error=h.error),this.hls.trigger(l,h)};this.observer=new kh,this.observer.on(x.FRAG_DECRYPTED,o),this.observer.on(x.ERROR,o);const a=Vc(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(r.workerPath||xS()){try{r.workerPath?(l.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=TS(r.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=yS());const{worker:c}=this.workerContext;c.addEventListener("message",this.onWorkerMessage),c.addEventListener("error",this.onWorkerError),c.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:we(r)})}catch(c){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,c),this.terminateWorker(),this.error=null,this.transmuxer=new Cu(this.observer,a,r,"",t,e.logger)}return}}this.transmuxer=new Cu(this.observer,a,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Lu++;const t=this.hls.config,i=Vc(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:we(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),SS(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,s,r,o,a,l,h,c){var u,d;h.transmuxing.start=self.performance.now();const{instanceNo:f,transmuxer:g}=this,p=o?o.start:r.start,m=r.decryptdata,_=this.frag,T=!(_&&r.cc===_.cc),S=!(_&&h.level===_.level),v=_?h.sn-_.sn:-1,E=this.part?h.part-this.part.index:-1,C=v===0&&h.id>1&&h.id===(_==null?void 0:_.stats.chunkCount),b=!S&&(v===1||v===0&&(E===1||C&&E<=0)),A=self.performance.now();(S||v||r.stats.parsing.start===0)&&(r.stats.parsing.start=A),o&&(E||!b)&&(o.stats.parsing.start=A);const L=!(_&&((u=r.initSegment)==null?void 0:u.url)===((d=_.initSegment)==null?void 0:d.url)),R=new dv(T,b,l,S,p,L);if(!b||T||L){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${h.sn}${h.part>-1?" part: "+h.part:""} ${this.id===q.MAIN?"level":"track"}: ${h.level} id: ${h.id}
        discontinuity: ${T}
        trackSwitch: ${S}
        contiguous: ${b}
        accurateTimeOffset: ${l}
        timeOffset: ${p}
        initSegmentChange: ${L}`);const M=new uv(i,s,t,a,c);this.configureTransmuxer(M)}if(this.frag=r,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:f,cmd:"demux",data:e,decryptdata:m,chunkMeta:h,state:R},e instanceof ArrayBuffer?[e]:[]);else if(g){const M=g.push(e,m,h,R);Or(M)?M.then(F=>{this.handleTransmuxComplete(F)}).catch(F=>{this.transmuxerError(F,h,"transmuxer-interface push error")}):this.handleTransmuxComplete(M)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const s=i.flush(e);Or(s)?s.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(s,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const wu=100;class fv extends Fh{constructor(e,t,i){super(e,t,i,"audio-stream-controller",q.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(x.LEVEL_LOADED,this.onLevelLoaded,this),e.on(x.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(x.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(x.BUFFER_RESET,this.onBufferReset,this),e.on(x.BUFFER_CREATED,this.onBufferCreated,this),e.on(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(x.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(x.FRAG_LOADING,this.onFragLoading,this),e.on(x.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(x.LEVEL_LOADED,this.onLevelLoaded,this),e.off(x.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(x.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(x.BUFFER_RESET,this.onBufferReset,this),e.off(x.BUFFER_CREATED,this.onBufferCreated,this),e.off(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(x.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(x.FRAG_LOADING,this.onFragLoading,this),e.off(x.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i===q.MAIN){const o=t.cc,a=this.fragCurrent;if(this.initPTS[o]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${o} found from main: ${s}/${r}`),this.mainAnchor=t,this.state===N.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==o)&&this.syncWithAnchor(t,l==null?void 0:l.frag)}else!this.hls.hasEnoughToStart&&a&&a.cc!==o?(a.abortRequests(),this.syncWithAnchor(t,a)):this.state===N.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const s=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&(s==null?void 0:s.cc)===t.cc)return;const r=(s||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),l=Qf(o,r,a);l&&(this.log(`Waiting fragment cc (${t==null?void 0:t.cc}) cancelled because video is at cc ${e.cc}`),this.startFragRequested=!1,this.nextLoadPosition=l.start,this.resetLoadingState(),this.state===N.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=N.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(wu),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=N.IDLE):this.state=N.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case N.IDLE:this.doTickIdle();break;case N.WAITING_TRACK:{const{levels:t,trackId:i}=this,s=t==null?void 0:t[i],r=s==null?void 0:s.details;if(r&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(r))break;this.state=N.WAITING_INIT_PTS}break}case N.FRAG_LOADING_WAITING_RETRY:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:s,trackId:r}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((s==null?void 0:s[r])||null),this.state=N.IDLE}break}case N.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:i,part:s,cache:r,complete:o}=t,a=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=N.FRAG_LOADING;const l=r.flush().buffer,h={frag:i,part:s,payload:l,networkDetails:null};this._handleFragmentLoadProgress(h),o&&super._handleFragmentLoadComplete(h)}else a&&a.cc!==t.frag.cc&&this.syncWithAnchor(a,t.frag)}else this.state=N.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:s,trackId:r}=this,o=t.config;if(!this.buffering||!s&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[r]))return;const a=i[r],l=a.details;if(!l||this.waitForLive(a)||this.waitForCdnTuneIn(l)){this.state=N.WAITING_TRACK,this.startFragRequested=!1;return}const h=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&h&&(this.bufferFlushed=!1,this.afterBufferFlushed(h,Re.AUDIO,q.AUDIO));const c=this.getFwdBufferInfo(h,q.AUDIO);if(c===null)return;if(!this.switchingTrack&&this._streamEnded(c,l)){t.trigger(x.BUFFER_EOS,{type:"audio"}),this.state=N.ENDED;return}const u=c.len,d=t.maxBufferLength,f=l.fragments,g=f[0].start,p=this.getLoadPosition(),m=this.flushing?p:c.end;if(this.switchingTrack&&s){const S=p;l.PTSKnown&&S<g&&(c.end>g||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),s.currentTime=g+.05)}if(u>=d&&!this.switchingTrack&&m<f[f.length-1].start)return;let _=this.getNextFragment(m,l);if(_&&this.isLoopLoading(_,m)&&(_=this.getNextFragmentLoopLoading(_,l,c,q.MAIN,d)),!_){this.bufferFlushed=!0;return}let T=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&T&&Ve(_)&&!_.endList&&(!l.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(T)===$e.OK&&(this.mainFragLoading=T=null),T&&Ve(T))){if(_.start>T.end){const v=this.fragmentTracker.getFragAtPos(m,q.MAIN);v&&v.end>T.end&&(T=v,this.mainFragLoading={frag:v,targetBufferTime:null})}if(_.start>T.end)return}this.loadFragment(_,a,m)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Pr(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==N.STOPPED&&(this.setInterval(wu),this.state=N.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(x.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:s}=this,{details:r,id:o,groupId:a,track:l}=t;if(!s){this.warn(`Audio tracks reset while loading track ${o} "${l.name}" of "${a}"`);return}const h=this.mainDetails;if(!h||r.endCC>h.endCC||h.expired){this.cachedTrackLoadedData=t,this.state!==N.STOPPED&&(this.state=N.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${l.name}" of "${a}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const c=s[o];let u=0;if(r.live||(i=c.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(c.details){var d;u=this.alignPlaylists(r,c.details,(d=this.levelLastLoaded)==null?void 0:d.details)}r.alignedSliding||(ug(r,h),r.alignedSliding||No(r,h),u=r.fragmentStart)}c.details=r,this.levelLastLoaded=c,this.startFragRequested||this.setStartPosition(h,u),this.hls.trigger(x.AUDIO_TRACK_UPDATED,{details:r,id:o,groupId:t.groupId}),this.state===N.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=N.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:s,payload:r}=e,{config:o,trackId:a,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const h=l[a];if(!h){this.warn("Audio track is undefined on fragment load progress");return}const c=h.details;if(!c){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const u=o.defaultAudioCodec||h.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new Pg(this.hls,q.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const f=this.initPTS[i.cc],g=(t=i.initSegment)==null?void 0:t.data;if(f!==void 0){const m=s?s.index:-1,_=m!==-1,T=new Ph(i.level,i.sn,i.stats.chunkCount,r.byteLength,m,_);d.push(r,g,u,"",i,s,c.totalduration,!1,T,f)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);const{cache:p}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new dg,complete:!1};p.push(new Uint8Array(r)),this.state!==N.STOPPED&&(this.state=N.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===q.MAIN&&Ve(t.frag)&&(this.mainFragLoading=t,this.state===N.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==q.AUDIO){!this.audioOnly&&i.type===q.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Ve(i)){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(x.AUDIO_TRACK_SWITCHED,ye({},r)))}this.fragBufferedComplete(i,s),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=N.ERROR;return}switch(t.details){case D.FRAG_GAP:case D.FRAG_PARSING_ERROR:case D.FRAG_DECRYPT_ERROR:case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(q.AUDIO,t);break;case D.AUDIO_TRACK_LOAD_ERROR:case D.AUDIO_TRACK_LOAD_TIMEOUT:case D.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===N.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===fe.AUDIO_TRACK&&(this.state=N.IDLE);break;case D.BUFFER_ADD_CODEC_ERROR:case D.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case D.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case D.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==Re.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==Re.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===N.ENDED&&(this.state=N.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,q.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:h,level:c}=a,{details:u}=c,{audio:d,text:f,id3:g,initSegment:p}=r;if(this.fragContextChanged(l)||!u){this.fragmentTracker.removeFragment(l);return}if(this.state=N.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),p!=null&&p.tracks){const m=l.initSegment||l;this._bufferInitSegment(c,p.tracks,m,o),s.trigger(x.FRAG_PARSING_INIT_SEGMENT,{frag:m,id:i,tracks:p.tracks})}if(d){const{startPTS:m,endPTS:_,startDTS:T,endDTS:S}=d;h&&(h.elementaryStreams[Re.AUDIO]={startPTS:m,endPTS:_,startDTS:T,endDTS:S}),l.setElementaryStreamInfo(Re.AUDIO,m,_,T,S),this.bufferFragmentData(d,l,h,o)}if(g!=null&&(t=g.samples)!=null&&t.length){const m=Ee({id:i,frag:l,details:u},g);s.trigger(x.FRAG_PARSING_METADATA,m)}if(f){const m=Ee({id:i,frag:l,details:u},f);s.trigger(x.FRAG_PARSING_USERDATA,m)}}_bufferInitSegment(e,t,i,s){if(this.state!==N.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const r=t.audio;r.id=q.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${o}/${r.codec}]`),o&&o.split(",").length===1&&(r.levelCodec=o),this.hls.trigger(x.BUFFER_CODECS,t);const a=r.initSegment;if(a!=null&&a.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:a};this.hls.trigger(x.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.switchingTrack||s===$e.NOT_LOADED||s===$e.PARTIAL){var r;if(!Ve(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=N.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&No(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a}=this.bufferedTrack;cs({name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a},e,ts)||(ko(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(x.AUDIO_TRACK_SWITCHED,ye({},e))}}class Gh extends hi{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const s=t==null?void 0:t.renditionReports;if(s){let r=-1;for(let o=0;o<s.length;o++){const a=s[o];let l;try{l=new self.URL(a.URI,t.url).href}catch(h){this.warn(`Could not construct new URL for Rendition Report: ${h}`),l=a.URI||""}if(l===e){r=o;break}else l===e.substring(0,l.length)&&(r=o)}if(r!==-1){const o=s[r],a=parseInt(o["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let l=parseInt(o["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const c=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&c>t.partTarget&&(l+=1)}const h=i&&Yc(i);return new Kc(a,l>=0?l:void 0,h)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:s,stats:r}=t,o=self.performance.now(),a=r.loading.first?Math.max(0,o-r.loading.first):0;s.advancedDateTime=Date.now()-a;const l=this.hls.config.timelineOffset;if(l!==s.appliedTimelineOffset){const c=Math.max(l||0,0);s.appliedTimelineOffset=c,s.fragments.forEach(u=>{u.start=u.playlistOffset+c})}if(s.live||i!=null&&i.live){const c="levelInfo"in t?t.levelInfo:t.track;if(s.reloaded(i),i&&s.fragments.length>0){lS(i,s);const T=s.playlistParsingError;if(T){this.warn(T);const S=this.hls;if(!S.config.ignorePlaylistParsingErrors){var h;const{networkDetails:v}=t;S.trigger(x.ERROR,{type:Z.NETWORK_ERROR,details:D.LEVEL_PARSING_ERROR,fatal:!1,url:s.url,error:T,reason:T.message,level:t.level||void 0,parent:(h=s.fragments[0])==null?void 0:h.type,networkDetails:v,stats:r});return}s.playlistParsingError=null}}s.requestScheduled===-1&&(s.requestScheduled=r.loading.start);const u=this.hls.mainForwardBufferInfo,d=u?u.end-u.len:0,f=(s.edge-d)*1e3,g=og(s,f);if(s.requestScheduled+g<o?s.requestScheduled=o:s.requestScheduled+=g,this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),!this.canLoad||!s.live)return;let p,m,_;if(s.canBlockReload&&s.endSN&&s.advanced){const T=this.hls.config.lowLatencyMode,S=s.lastPartSn,v=s.endSN,E=s.lastPartIndex,C=E!==-1,b=S===v;C?b?(m=v+1,_=T?0:E):(m=S,_=T?E+1:s.maxPartIndex):m=v+1;const A=s.age,L=A+s.ageHeader;let R=Math.min(L-s.partTarget,s.targetduration*1.5);if(R>0){if(L>s.targetduration*3)this.log(`Playlist last advanced ${A.toFixed(2)}s ago. Omitting segment and part directives.`),m=void 0,_=void 0;else if(i!=null&&i.tuneInGoal&&L-s.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${R} with playlist age: ${s.age}`),R=0;else{const M=Math.floor(R/s.targetduration);if(m+=M,_!==void 0){const F=Math.round(R%s.targetduration/s.partTarget);_+=F}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${A.toFixed(2)}s goal: ${R} skip sn ${M} to part ${_}`)}s.tuneInGoal=R}if(p=this.getDeliveryDirectives(s,t.deliveryDirectives,m,_),T||!b){s.requestScheduled=o,this.loadingPlaylist(c,p);return}}else(s.canBlockReload||s.canSkipUntil)&&(p=this.getDeliveryDirectives(s,t.deliveryDirectives,m,_));p&&m!==void 0&&s.canBlockReload&&(s.requestScheduled=r.loading.first+Math.max(g-a*2,g/2)),this.scheduleLoading(c,p,s)}else this.clearTimer()}scheduleLoading(e,t,i){const s=i||e.details;if(!s){this.loadingPlaylist(e,t);return}const r=self.performance.now(),o=s.requestScheduled;if(r>=o){this.loadingPlaylist(e,t);return}const a=o-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,s){let r=Yc(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=so.No),new Kc(i,s,r)}checkRetry(e){const t=e.details,i=Oo(e),s=e.errorAction,{action:r,retryCount:o=0,retryConfig:a}=s||{},l=!!s&&!!a&&(r===Ze.RetryRequest||!s.resolved&&r===Ze.SendAlternateToPenaltyBox);if(l){var h;if(o>=a.maxNumRetry)return!1;if(i&&(h=e.context)!=null&&h.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const c=wh(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),c),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${c}ms`)}e.levelRetry=!0,s.resolved=!0}return l}}function Dg(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!Br(n[t].attrs,e[t].attrs))return!1;return!0}function Br(n,e,t){const i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function Ul(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}class gv extends Gh{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.LEVEL_LOADING,this.onLevelLoading,this),e.on(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(x.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.LEVEL_LOADING,this.onLevelLoading,this),e.off(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(x.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(x.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(d=>!i||i.indexOf(d.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(d=>d.default)&&(this.selectDefaultTrack=!1),a.forEach((d,f)=>{d.id=f});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const l=this.hls.config.audioPreference;if(!r&&l){const d=Vt(l,a,ts);if(d>-1)r=a[d];else{const f=Vt(l,this.tracks);r=this.tracks[f]}}let h=this.findTrackId(r);h===-1&&r&&(h=this.findTrackId(null));const c={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(x.AUDIO_TRACKS_UPDATED,c);const u=this.trackId;if(h!==-1&&u===-1)this.setAudioTrack(h);else if(a.length&&u===-1){var o;const d=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(d.message),this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:d})}}}onError(e,t){t.fatal||!t.context||t.context.type===fe.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&cs(e,s,ts))return s;const r=Vt(e,this.tracksInGroup,ts);if(r>-1){const o=this.tracksInGroup[r];return this.setAudioTrack(r),o}else if(s){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=LT(e,t.levels,i,o,ts);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=Vt(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(x.AUDIO_TRACK_SWITCHING,ye({},s)),r))return;const o=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||cs(e,s,ts)))return i}if(e){const{name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:l}=e;for(let h=0;h<t.length;h++){const c=t[h];if(cs({name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:l},c,ts))return h}for(let h=0;h<t.length;h++){const c=t[h];if(Br(e.attrs,c.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return h}for(let h=0;h<t.length;h++){const c=t[h];if(Br(e.attrs,c.attrs,["LANGUAGE"]))return h}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&ko(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(x.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}}class pv{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const s=t[0];try{s.execute()}catch(r){var i;if(s.onError(r),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],s=i==null?void 0:i.buffer;return s?`SourceBuffer${s.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const Iu=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Mg="HlsJsTrackRemovedError";class mv extends Error{constructor(e){super(e),this.name=Mg}}class _v extends hi{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var s;this.hls&&((s=this.mediaSource)==null?void 0:s.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:s,mediaSource:r}=this;i&&this.log("Media source opened"),!(!s||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(x.MEDIA_ATTACHED,{media:s,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&this.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=Yy(Hi(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.BUFFER_RESET,this.onBufferReset,this),e.on(x.BUFFER_APPENDING,this.onBufferAppending,this),e.on(x.BUFFER_CODECS,this.onBufferCodecs,this),e.on(x.BUFFER_EOS,this.onBufferEos,this),e.on(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(x.FRAG_PARSED,this.onFragParsed,this),e.on(x.FRAG_CHANGED,this.onFragChanged,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.BUFFER_RESET,this.onBufferReset,this),e.off(x.BUFFER_APPENDING,this.onBufferAppending,this),e.off(x.BUFFER_CODECS,this.onBufferCodecs,this),e.off(x.BUFFER_EOS,this.onBufferEos,this),e.off(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(x.FRAG_PARSED,this.onFragParsed,this),e.off(x.FRAG_CHANGED,this.onFragChanged,this),e.off(x.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const r=this.isUpdating();r||this.operationQueue.removeBlockers();const o=this.isQueued();(r||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const s=this.transferData;return!this.sourceBufferCount&&s&&s.mediaSource===t?Ee(i,s.tracks):this.sourceBuffers.forEach(r=>{const[o]=r;o&&(i[o]=Ee({},this.tracks[o]),this.removeBuffer(o)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let s=2;(t.audio&&!t.video||!t.altAudio)&&(s=1),this.bufferCodecEventsTotal=s,this.log(`${s} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&s&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media,s=Hi(this.appendSource);if(this.transferData=this.overrides=void 0,i&&s){const r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new s;if(this.assignMediaSource(o),r)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&o instanceof l,Pu(i),xv(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,s=t.tracks,r=s?Object.keys(s):null,o=r?r.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(s&&r&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${we(i,(l,h)=>l==="initSegment"?void 0:h)};
transfer tracks: ${we(s,(l,h)=>l==="initSegment"?void 0:h)}}`),!Mf(s,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,h=this.details,c=Math.max(l,(h==null?void 0:h.fragments[0].start)||0);if(c-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${c}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(s)}"->"${Object.keys(i)}") start time: ${c} currentTime: ${l}`),this.onMediaDetaching(x.MEDIA_DETACHING,{}),this.onMediaAttaching(x.MEDIA_ATTACHING,t),e.currentTime=c;return}this.transferData=void 0,r.forEach(l=>{const h=l,c=s[h];if(c){const u=c.buffer;if(u){const d=this.fragmentTracker,f=c.id;if(d.hasFragments(f)||d.hasParts(f)){const m=ne.getBuffered(u);d.detectEvictedFragments(h,m,f,null,!0)}const g=Na(h),p=[h,u];this.sourceBuffers[g]=p,u.updating&&this.operationQueue&&this.operationQueue.prependBlocker(h),this.trackSourceBuffer(h,c)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:s,mediaSource:r,_objectUrl:o}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=r.readyState==="open";try{const l=r.sourceBuffers;for(let h=l.length;h--;)a&&l[h].abort(),r.removeSourceBuffer(l[h]);a&&r.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}s&&(s.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(s.removeAttribute("src"),this.appendSource&&Pu(s),s.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(x.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var s;(s=this.mediaSource)!=null&&s.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Na(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new pv(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,s=Object.keys(t);this.log(`BUFFER_CODECS: "${s}" (current SB count ${this.sourceBufferCount})`);const r="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),o=!r&&this.sourceBufferCount&&this.media&&s.some(a=>!i[a]);if(r||o){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${s}" SourceBuffers`);return}s.forEach(a=>{var l,h,c;const u=t[a],{id:d,codec:f,levelCodec:g,container:p,metadata:m,supplemental:_}=u;let T=i[a];const S=(l=this.transferData)==null||(h=l.tracks)==null?void 0:h[a],v=S!=null&&S.buffer?S:T,E=(v==null?void 0:v.pendingCodec)||(v==null?void 0:v.codec),C=v==null?void 0:v.levelCodec;T||(T=i[a]={buffer:void 0,listeners:[],codec:f,supplemental:_,container:p,levelCodec:g,metadata:m,id:d});const b=io(E,C),A=b==null?void 0:b.replace(Iu,"$1");let L=io(f,g);const R=(c=L)==null?void 0:c.replace(Iu,"$1");L&&b&&A!==R&&(a.slice(0,5)==="audio"&&(L=Mo(L,this.appendSource)),this.log(`switching codec ${E} to ${L}`),L!==(T.pendingCodec||T.codec)&&(T.pendingCodec=L),T.container=p,this.appendChangeType(a,p,L))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const s=`${t};codecs=${i}`,r={label:`change-type=${s}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${s}`),a.changeType(s),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,s=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,q.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const l=this.tracks.video;(this.lastVideoAppendEnd>s||l!=null&&l.buffer&&ne.isBuffered(l.buffer,s)||((a=this.fragmentTracker.getAppendedFrag(s,q.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:s,type:r,parent:o,frag:a,part:l,chunkMeta:h}=t,c=h.buffering[r],u=a.sn,d=self.performance.now();c.start=d;const f=a.stats.buffering,g=l?l.stats.buffering:null;f.start===0&&(f.start=d),g&&g.start===0&&(g.start=d);const p=i.audio;let m=!1;r==="audio"&&(p==null?void 0:p.container)==="audio/mpeg"&&(m=!this.lastMpegAudioChunk||h.id===1||this.lastMpegAudioChunk.sn!==h.sn,this.lastMpegAudioChunk=h);const _=this.tracks.video,T=_==null?void 0:_.buffer;if(T&&u!=="initSegment"){const E=l||a,C=this.blockedAudioAppend;if(r==="audio"&&o!=="main"&&!this.blockedAudioAppend){const A=E.start+E.duration*.05,L=T.buffered,R=this.currentOp("video");!L.length&&!R?this.blockAudio(E):!R&&!ne.isBuffered(T,A)&&this.lastVideoAppendEnd<A&&this.blockAudio(E)}else if(r==="video"){const b=E.end;if(C){const A=C.frag.start;(b>A||b<this.lastVideoAppendEnd||ne.isBuffered(T,A))&&this.unblockAudio()}this.lastVideoAppendEnd=b}}const S=(l||a).start,v={label:`append-${r}`,execute:()=>{if(c.executeStart=self.performance.now(),m){const E=this.tracks[r];if(E){const C=E.buffer;if(C){const b=S-C.timestampOffset;Math.abs(b)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${S} (delta: ${b}) sn: ${u})`),C.timestampOffset=S)}}}this.appendExecutor(s,r)},onStart:()=>{},onComplete:()=>{const E=self.performance.now();c.executeEnd=c.end=E,f.first===0&&(f.first=E),g&&g.first===0&&(g.first=E);const C={};this.sourceBuffers.forEach(([b,A])=>{b&&(C[b]=ne.getBuffered(A))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(x.BUFFER_APPENDED,{type:r,frag:a,part:l,chunkMeta:h,parent:a.type,timeRanges:C})},onError:E=>{var C;const b={type:Z.MEDIA_ERROR,parent:a.type,details:D.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:a,part:l,chunkMeta:h,error:E,err:E,fatal:!1},A=(C=this.media)==null?void 0:C.error;if(E.code===DOMException.QUOTA_EXCEEDED_ERR)b.details=D.BUFFER_FULL_ERROR;else if(E.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!A)b.errorAction=Dr(!0);else if(E.name===Mg&&this.sourceBufferCount===0)b.errorAction=Dr(!0);else{const L=++this.appendErrors[r];this.warn(`Failed ${L}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${A||"no media error"})`),(L>=this.hls.config.appendErrorMaxRetry||A)&&(b.fatal=!0)}this.hls.trigger(x.ERROR,b)}};this.append(v,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(x.BUFFER_FLUSHED,{type:e})},onError:s=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,s)}}}onBufferFlushing(e,t){const{type:i,startOffset:s,endOffset:r}=t;i?this.append(this.getFlushOp(i,s,r),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,s,r),o)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],o=s?s.elementaryStreams:i.elementaryStreams;o[Re.AUDIOVIDEO]?r.push("audiovideo"):(o[Re.AUDIO]&&r.push("audio"),o[Re.VIDEO]&&r.push("video"));const a=()=>{const l=self.performance.now();i.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const h=s?s.stats:i.stats;this.hls.trigger(x.FRAG_BUFFERED,{frag:i,part:s,stats:h,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,r).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!((t=this.tracks[e])!=null&&t.ended)||((i=this.tracks[e])==null?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const s=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})&&(s?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(x.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(x.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===D.BUFFER_APPEND_ERROR&&t.frag){var i;const s=(i=t.errorAction)==null?void 0:i.nextAutoLevel;K(s)&&s!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const s=e.config,r=i.currentTime,o=t.levelTargetDuration,a=t.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(K(a)&&a>=0){const l=Math.max(a,o),h=Math.floor(r/o)*o-l;this.flushBackBuffer(r,o,h)}if(K(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){const l=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),h=Math.max(l,o),c=Math.floor(r/o)*o+h;this.flushFrontBuffer(r,o,c)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){const a=ne.getBuffered(r);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(x.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[s];if((o=this.details)!=null&&o.live)this.hls.trigger(x.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${s} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(x.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:s})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){const o=ne.getBuffered(r),a=o.length;if(a<2)return;const l=o.start(a-1),h=o.end(a-1);if(i>l||e>=l&&e<=h)return;this.hls.trigger(x.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:s})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;const s=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){const h=Math.max(0,t.fragmentStart),c=Math.max(h,s);return{duration:1/0,start:h,end:c}}return{duration:1/0}}const r=(e=this.overrides)==null?void 0:e.duration;if(r)return K(r)?{duration:r}:null;const o=this.media.duration,a=K(i.duration)?i.duration:0;return s>a&&s>o||!K(o)?{duration:s}:null}updateMediaSource({duration:e,start:t,end:i}){const s=this.mediaSource;!this.media||!s||s.readyState!=="open"||(s.duration!==e&&(K(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),s.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${s.duration}. Setting seekable range to ${t}-${i}.`),s.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${we(i)}`),this.tracksReady){var s;const r=(s=this.transferData)==null?void 0:s.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const s=this.tracks[t];e[t]={buffer:i,container:s.container,codec:s.codec,supplemental:s.supplemental,levelCodec:s.levelCodec,id:s.id,metadata:s.metadata}}}),this.hls.trigger(x.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const r in e){const o=r,a=e[o];if(this.isPending(a)){const l=this.getTrackCodec(a,o),h=`${a.container};codecs=${l}`;a.codec=l,this.log(`creating sourceBuffer(${h})${this.currentOp(o)?" Queued":""} ${we(a)}`);try{const c=i.addSourceBuffer(h),u=Na(o),d=[o,c];t[u]=d,a.buffer=c}catch(c){var s;this.error(`error while trying to add sourceBuffer: ${c.message}`),this.shiftAndExecuteNext(o),(s=this.operationQueue)==null||s.removeBlockers(),delete this.tracks[o],this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:c,sourceBufferName:o,mimeType:h,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let s=e.codec;i&&(t==="video"||t==="audiovideo")&&Il(i,"video")&&(s=gT(s,i));const r=io(s,e.levelCodec);return r?t.slice(0,5)==="audio"?Mo(r,this.appendSource):r:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const s=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:s,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(x.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});const r=this.currentOp(e);r&&r.onError(s)}removeExecutor(e,t,i){const{media:s,mediaSource:r}=this,o=this.tracks[e],a=o==null?void 0:o.buffer;if(!s||!r||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=K(s.duration)?s.duration:1/0,h=K(r.duration)?r.duration:1/0,c=Math.max(0,t),u=Math.min(i,l,h);u>c&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${c},${u}] from the ${e} SourceBuffer`),a.remove(c,u)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],s=i==null?void 0:i.buffer;if(!s)throw new mv(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,s.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,s=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(s).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const s=(i=this.tracks[t])==null?void 0:i.buffer;!s||s.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const s=this.tracks[e];if(!s)return;const r=s.buffer;if(!r)return;const o=i.bind(this,e);s.listeners.push({event:t,listener:o}),r.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(s=>{i.removeEventListener(s.event,s.listener)}),t.listeners.length=0)}}function Pu(n){const e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function xv(n,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}function Na(n){return n==="audio"?1:0}class Hh{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(x.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(x.BUFFER_CODECS,this.onBufferCodecs,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(x.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(x.BUFFER_CODECS,this.onBufferCodecs,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&K(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,Hh.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(a,l)=>l?a.width!==l.width||a.height!==l.height:!0;let r=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const l=e[a];if((l.width>=o||l.height>=o)&&s(l,e[a+1])){r=a;break}}return r}}const yv={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},rt=yv,Tv={HLS:"h"},Sv=Tv,vv="CMCD-Object",Ev="CMCD-Request",bv="CMCD-Session",Av="CMCD-Status",mr={OBJECT:vv,REQUEST:Ev,SESSION:bv,STATUS:Av},Rv={[mr.OBJECT]:["br","d","ot","tb"],[mr.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[mr.SESSION]:["cid","pr","sf","sid","st","v"],[mr.STATUS]:["bs","rtp"]};class tr{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof tr?i:new tr(i))),this.value=e,this.params=t}}const Cv="Dict";function Lv(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function wv(n,e,t,i){return new Error(`failed to ${n} "${Lv(e)}" as ${t}`,{cause:i})}function Kt(n,e,t){return wv("serialize",n,e,t)}class Fg{constructor(e){this.description=e}}const Du="Bare Item",Iv="Boolean";function Pv(n){if(typeof n!="boolean")throw Kt(n,Iv);return n?"?1":"?0"}function Dv(n){return btoa(String.fromCharCode(...n))}const Mv="Byte Sequence";function Fv(n){if(ArrayBuffer.isView(n)===!1)throw Kt(n,Mv);return`:${Dv(n)}:`}const kv="Integer";function Ov(n){return n<-999999999999999||999999999999999<n}function kg(n){if(Ov(n))throw Kt(n,kv);return n.toString()}function Bv(n){return`@${kg(n.getTime()/1e3)}`}function Og(n,e){if(n<0)return-Og(-n,e);const t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){const s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}const Uv="Decimal";function Nv(n){const e=Og(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Kt(n,Uv);const t=e.toString();return t.includes(".")?t:`${t}.0`}const $v="String",zv=/[\x00-\x1f\x7f]+/;function Gv(n){if(zv.test(n))throw Kt(n,$v);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function Hv(n){return n.description||n.toString().slice(7,-1)}const Vv="Token";function Mu(n){const e=Hv(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Kt(e,Vv);return e}function Nl(n){switch(typeof n){case"number":if(!K(n))throw Kt(n,Du);return Number.isInteger(n)?kg(n):Nv(n);case"string":return Gv(n);case"symbol":return Mu(n);case"boolean":return Pv(n);case"object":if(n instanceof Date)return Bv(n);if(n instanceof Uint8Array)return Fv(n);if(n instanceof Fg)return Mu(n);default:throw Kt(n,Du)}}const Wv="Key";function $l(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw Kt(n,Wv);return n}function Vh(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${$l(e)}`:`;${$l(e)}=${Nl(t)}`).join("")}function Bg(n){return n instanceof tr?`${Nl(n.value)}${Vh(n.params)}`:Nl(n)}function Yv(n){return`(${n.value.map(Bg).join(" ")})${Vh(n.params)}`}function Kv(n,e={whitespace:!0}){if(typeof n!="object")throw Kt(n,Cv);const t=n instanceof Map?n.entries():Object.entries(n),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof tr||(r=new tr(r));let o=$l(s);return r.value===!0?o+=Vh(r.params):(o+="=",Array.isArray(r.value)?o+=Yv(r):o+=Bg(r)),o}).join(`,${i}`)}function Xv(n,e){return Kv(n,e)}function jv(n){return n==="ot"||n==="sf"||n==="st"}function qv(n){return typeof n=="number"?K(n):n!=null&&n!==""&&n!==!1}function Qv(n,e){const t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;const s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}const ao=n=>Math.round(n),Zv=(n,e)=>(e!=null&&e.baseUrl&&(n=Qv(n,e.baseUrl)),encodeURIComponent(n)),kn=n=>ao(n/100)*100,Jv={br:ao,d:ao,bl:kn,dl:kn,mtp:kn,nor:Zv,rtp:kn,tb:ao};function eE(n,e){const t={};if(n==null||typeof n!="object")return t;const i=Object.keys(n).sort(),s=Ee({},Jv,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(o=>{if(r!=null&&r(o))return;let a=n[o];const l=s[o];l&&(a=l(a,e)),!(o==="v"&&a===1)&&(o=="pr"&&a===1||qv(a)&&(jv(o)&&typeof a=="string"&&(a=new Fg(a)),t[o]=a))}),t}function Ug(n,e={}){return n?Xv(eE(n,e),Ee({whitespace:!1},e)):""}function tE(n,e={}){const t={};if(!n)return t;const i=Object.entries(n),s=Object.entries(Rv).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),r=i.reduce((o,a)=>{var l,h;const[c,u]=a,d=((l=s.find(f=>f[1].includes(c)))===null||l===void 0?void 0:l[0])||mr.REQUEST;return(h=o[d])!==null&&h!==void 0||(o[d]={}),o[d][c]=u,o},{});return Object.entries(r).reduce((o,[a,l])=>(o[a]=Ug(l,e),o),t)}function iE(n,e,t){return Ee(n,tE(e,t))}const sE="CMCD";function rE(n,e={}){if(!n)return"";const t=Ug(n,e);return`${sE}=${encodeURIComponent(t)}`}const Fu=/CMCD=[^&#]+/;function nE(n,e,t){const i=rE(e,t);if(!i)return n;if(Fu.test(n))return n.replace(Fu,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class oE{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:rt.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const{frag:r,part:o}=s,a=this.hls.levels[r.level],l=this.getObjectType(r),h={d:(o||r).duration*1e3,ot:l};(l===rt.VIDEO||l===rt.AUDIO||l==rt.MUXED)&&(h.br=a.bitrate/1e3,h.tb=this.getTopBandwidth(l)/1e3,h.bl=this.getBufferLength(l));const c=o?this.getNextPart(o):this.getNextFrag(r);c!=null&&c.url&&c.url!==r.url&&(h.nor=c.url),this.apply(s,h)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHED,this.onMediaDetached,this),e.on(x.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHED,this.onMediaDetached,this),e.off(x.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:Sv.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Ee(t,this.createData());const i=t.ot===rt.INIT||t.ot===rt.VIDEO||t.ot===rt.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((o,a)=>(s.includes(a)&&(o[a]=t[a]),o),{}));const r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),iE(e.headers,t,r)):e.url=nE(e.url,t,r)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const s=e.sn-i.startSN;return i.fragments[s+1]}}getNextPart(e){var t,i;const{index:s,fragment:r}=e,o=(t=this.hls.levels[r.level])==null||(i=t.details)==null?void 0:i.partList;if(o){const{sn:a}=r;for(let l=o.length-1;l>=0;l--){const h=o[l];if(h.index===s&&h.fragment.sn===a)return o[l+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return rt.TIMED_TEXT;if(e.sn==="initSegment")return rt.INIT;if(t==="audio")return rt.AUDIO;if(t==="main")return this.hls.audioTracks.length?rt.VIDEO:rt.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===rt.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,o=r>-1?r+1:s.levels.length;i=s.levels.slice(0,o)}return i.forEach(r=>{r.bitrate>t&&(t=r.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===rt.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:ne.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}}const aE=3e5;class lE extends hi{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===Ze.SendAlternateToPenaltyBox&&i.flags===Ct.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:l,type:h}=t.context;a&&s?o=this.getPathwayForGroupId(a,h,o):l&&(o=l)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!r&&s&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==o),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${s&&s.length} priorities: ${we(r)} penalized: ${we(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>aE&&delete i[r]});for(let r=0;r<e.length;r++){const o=e[r];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,l=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,hg(t),this.hls.trigger(x.LEVELS_UPDATED,{levels:t});const h=this.hls.levels[a];l&&h&&this.levels&&(h.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&h.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${h.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===fe.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===fe.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":l}=r;if(t.some(c=>c.pathwayId===o))return;const h=this.getLevelsForPathway(a).map(c=>{const u=new Pe(c.attrs);u["PATHWAY-ID"]=o;const d=u.AUDIO&&`${u.AUDIO}_clone_${o}`,f=u.SUBTITLES&&`${u.SUBTITLES}_clone_${o}`;d&&(i[u.AUDIO]=d,u.AUDIO=d),f&&(s[u.SUBTITLES]=f,u.SUBTITLES=f);const g=Ng(c.uri,u["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),p=new Pr({attrs:u,audioCodec:c.audioCodec,bitrate:c.bitrate,height:c.height,name:c.name,url:g,videoCodec:c.videoCodec,width:c.width});if(c.audioGroups)for(let m=1;m<c.audioGroups.length;m++)p.addGroupId("audio",`${c.audioGroups[m]}_clone_${o}`);if(c.subtitleGroups)for(let m=1;m<c.subtitleGroups.length;m++)p.addGroupId("text",`${c.subtitleGroups[m]}_clone_${o}`);return p});t.push(...h),ku(this.audioTracks,i,l,o),ku(this.subtitleTracks,s,l,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const c=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+c)}const r={responseType:"json",url:s.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},h={onSuccess:(c,u,d,f)=>{this.log(`Loaded steering manifest: "${s}"`);const g=c.data;if((g==null?void 0:g.VERSION)!==1){this.log(`Steering VERSION ${g.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=g.TTL;const{"RELOAD-URI":p,"PATHWAY-CLONES":m,"PATHWAY-PRIORITY":_}=g;if(p)try{this.uri=new self.URL(p,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${p}`);return}this.scheduleRefresh(this.uri||d.url),m&&this.clonePathways(m);const T={steeringManifest:g,url:s.toString()};this.hls.trigger(x.STEERING_MANIFEST_LOADED,T),_&&this.updatePathwayPriority(_)},onError:(c,u,d,f)=>{if(this.log(`Error loading steering manifest: ${c.code} ${c.text} (${u.url})`),this.stopLoad(),c.code===410){this.enabled=!1,this.log(`Steering manifest ${u.url} no longer available`);return}let g=this.timeToLoad*1e3;if(c.code===429){const p=this.loader;if(typeof(p==null?void 0:p.getResponseHeader)=="function"){const m=p.getResponseHeader("Retry-After");m&&(g=parseFloat(m)*1e3)}this.log(`Steering manifest ${u.url} rate limited`);return}this.scheduleRefresh(this.uri||u.url,g)},onTimeout:(c,u,d)=>{this.log(`Timeout loading steering manifest (${u.url})`),this.scheduleRefresh(this.uri||u.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,l,h)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function ku(n,e,t,i){n&&Object.keys(e).forEach(s=>{const r=n.filter(o=>o.groupId===s).map(o=>{const a=Ee({},o);return a.details=void 0,a.attrs=new Pe(a.attrs),a.url=a.attrs.URI=Ng(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[s],a.attrs["PATHWAY-ID"]=i,a});n.push(...r)})}function Ng(n,e,t,i){const{HOST:s,PARAMS:r,[t]:o}=i;let a;e&&(a=o==null?void 0:o[e],a&&(n=a));const l=new self.URL(n);return s&&!a&&(l.host=s),r&&Object.keys(r).sort().forEach(h=>{h&&l.searchParams.set(h,r[h])}),l.href}function ft(n,e,t){Et(n,e,t),n.addEventListener(e,t)}function Et(n,e,t){n.removeEventListener(e,t)}class Xs extends hi{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Xs.CDMCleanupPromise?[Xs.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{const{initDataType:i,initData:s}=t,r=`"${t.type}" event: init data type: "${i}"`;if(this.debug(r),s!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=pr(this.config));const a=o.map(In).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=ro(o);let l,h;if(i==="sinf"){if(a!==Se.FAIRPLAY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}const g=Ue(new Uint8Array(s));try{const p=Mh(JSON.parse(g).sinf),m=$f(p);if(!m)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(m.subarray(8,24)),h=Se.FAIRPLAY}catch(p){this.warn(`${r} Failed to parse sinf: ${p}`);return}}else{if(a!==Se.WIDEVINE&&a!==Se.PLAYREADY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}const g=cT(s),p=g.filter(_=>!!_.systemId&&Pa(_.systemId)===a);p.length>1&&this.warn(`${r} Using first of ${p.length} pssh found for selected key-system ${a}`);const m=p[0];if(!m){g.length===0||g.some(_=>!_.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${g.map(_=>Pa(_.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(h=Pa(m.systemId),m.version===0&&m.data)if(h===Se.WIDEVINE){const _=m.data.length-22;l=new Uint8Array(m.data.subarray(_,_+16))}else h===Se.PLAYREADY&&(l=ig(m.data))}if(!h||!l)return;const c=Ut.hexDump(l),{keyIdToKeySessionPromise:u,mediaKeySessions:d}=this;let f=u[c];for(let g=0;g<d.length;g++){const p=d[g],m=p.decryptdata;if(!m.keyId)continue;const _=Ut.hexDump(m.keyId);if(c===_||m.uri.replace(/-/g,"").indexOf(c)!==-1){if(f=u[_],m.pssh)break;delete u[_],m.pssh=new Uint8Array(s),m.keyId=l,f=u[c]=f.then(()=>this.generateRequestWithPreferredKeySession(p,i,s,"encrypted-event-key-match")),f.catch(T=>this.handleError(T));break}}if(!f){if(h!==a){this.log(`Ignoring "${t.type}" event with ${h} init data for selected key-system ${a}`);return}f=u[c]=this.getKeySystemSelectionPromise([h]).then(({keySystem:g,mediaKeys:p})=>{var m;this.throwIfDestroyed();const _=new Mr("ISO-23001-7",c,(m=In(g))!=null?m:"");return _.pssh=new Uint8Array(s),_.keyId=l,this.attemptSetMediaKeys(g,p).then(()=>{this.throwIfDestroyed();const T=this.createMediaKeySessionContext({decryptdata:_,keySystem:g,mediaKeys:p});return this.generateRequestWithPreferredKeySession(T,i,s,"encrypted-event-no-match")})}),f.catch(g=>this.handleError(g))}})}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(x.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(x.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(x.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(x.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(x.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(x.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(x.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(x.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t[e];if(s)return s.licenseUrl;if(e===Se.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,l)=>!!o&&l.indexOf(o)===a,s=t.map(o=>o.audioCodec).filter(i),r=t.map(o=>o.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((o,a)=>{const l=h=>{const c=h.shift();this.getMediaKeysPromise(c,s,r).then(u=>o({keySystem:c,mediaKeys:u})).catch(u=>{h.length?l(h):u instanceof xt?a(u):a(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_ACCESS,error:u,fatal:!0},u.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return tg===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){const s=eS(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let o=r==null?void 0:r.keySystemAccess;if(!o){this.log(`Requesting encrypted media "${e}" key-system access with config: ${we(s)}`),o=this.requestMediaKeySystemAccess(e,s);const a=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),o.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const h=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),a.mediaKeys=l.createMediaKeys().then(c=>(this.log(`Media-keys created for "${e}"`),a.hasMediaKeys=!0,h.then(u=>u?this.setMediaKeysServerCertificate(c,e,u):c))),a.mediaKeys.catch(c=>{this.error(`Failed to create media-keys for "${e}"}: ${c}`)}),a.mediaKeys})}return o.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Ut.hexDump(e.keyId||[])}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return Ut.hexDump(e.keyId)}updateKeySession(e,t){var i;const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${Ut.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),s.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>In(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>this.getKeySystemSelectionPromise(e).then(({keySystem:s})=>{const r=In(s);r?t(r):i(new Error(`Unable to find format for key-system "${s}"`))}).catch(i))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=pr(this.config),i=e.map(ro).filter(s=>!!s&&t.indexOf(s)!==-1);return this.selectKeySystem(i)}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.getKeySystemForKeyPromise(t).then(({keySystem:a,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(a,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:a,mediaKeys:l,decryptdata:t}))))),(this.keyIdToKeySessionPromise[i]=r.then(a=>{const l="cenc",h=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(a,l,h,"playlist-key")})).catch(a=>this.handleError(a))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof xt?this.hls.trigger(x.ERROR,e.data):this.hls.trigger(x.ERROR,{type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=ro(e.keyFormat),r=s?[s]:pr(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=pr(this.config)),e.length===0)throw new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${we({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r,o;const a=(r=this.config.drmSystems)==null||(o=r[e.keySystem])==null?void 0:o.generateRequest;if(a)try{const g=a.call(this.hls,t,i,e);if(!g)throw new Error("Invalid response from configured generateRequest filter");t=g.initDataType,i=g.initData?g.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(g){var l;if(this.warn(g.message),(l=this.hls)!=null&&l.config.debug)throw g}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const h=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${s}": ${h} (init data type: ${t} length: ${i?i.byteLength:null})`);const c=new kh,u=e._onmessage=g=>{const p=e.mediaKeysSession;if(!p){c.emit("error",new Error("invalid state"));return}const{messageType:m,message:_}=g;this.log(`"${m}" message event for session "${p.sessionId}" message size: ${_.byteLength}`),m==="license-request"||m==="license-renewal"?this.renewLicense(e,_).catch(T=>{c.eventNames().length?c.emit("error",T):this.handleError(T)}):m==="license-release"?e.keySystem===Se.FAIRPLAY&&(this.updateKeySession(e,Ml("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${m}"`)},d=e._onkeystatuseschange=g=>{if(!e.mediaKeysSession){c.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const m=e.keyStatus;c.emit("keyStatus",m),m==="expired"&&(this.warn(`${e.keySystem} expired for key ${h}`),this.renewKeySession(e))};ft(e.mediaKeysSession,"message",u),ft(e.mediaKeysSession,"keystatuseschange",d);const f=new Promise((g,p)=>{c.on("error",p),c.on("keyStatus",m=>{m.startsWith("usable")?g():m==="output-restricted"?p(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):m==="internal-error"?p(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${m}"`)):m==="expired"?p(new Error("key expired while generating request")):this.warn(`unhandled key status change "${m}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var g;this.log(`Request generated for key-session "${(g=e.mediaKeysSession)==null?void 0:g.sessionId}" keyId: ${h}`)}).catch(g=>{throw new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_SESSION,error:g,fatal:!1},`Error generating key-session request: ${g}`)}).then(()=>f).catch(g=>{throw c.removeAllListeners(),this.removeSession(e),g}).then(()=>(c.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if(typeof i=="string"&&typeof t=="object"){const s=i;i=t,t=s}this.log(`key status change "${t}" for keyStatuses keyId: ${Ut.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Ut.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const l={responseType:"arraybuffer",url:r},h=t.certLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,f,g,p)=>{o(d.data)},onError:(d,f,g,p)=>{a(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:ye({url:l.url,data:void 0},d)},`"${e}" certificate request failed (${r}). Status: ${d.code} (${d.text})`))},onTimeout:(d,f,g)=>{a(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(d,f,g)=>{a(new Error("aborted"))}};s.load(l,c,u)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),s(e)}).catch(o=>{r(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let c;for(let u=0,d=r.length;u<d;u++){var o,a;c=r[u];const f=(o=c.querySelector("name"))==null?void 0:o.textContent,g=(a=c.querySelector("value"))==null?void 0:a.textContent;f&&g&&e.setRequestHeader(f,g)}}const l=s.querySelector("Challenge"),h=l==null?void 0:l.textContent;if(!h)throw new Error("Cannot find <Challenge> in key message");return Ml(atob(h))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let l=a.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const h=this.config.licenseResponseCallback;if(h)try{l=h.call(this.hls,a,o,e)}catch(c){this.error(c)}s(l)}else{const l=i.errorRetry,h=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>h||a.status>=400&&a.status<500)r(new xt({type:Z.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const c=h-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${c} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:l,licenseChallenge:h})=>{e.keySystem==Se.PLAYREADY&&(h=this.unpackPlayReadyKeyMessage(l,h)),l.send(h)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,ft(i,"encrypted",this.onMediaEncrypted),ft(i,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(Et(e,"encrypted",this.onMediaEncrypted),Et(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,Mr.clearKeyUriToKeyIdMap();const s=i.length;Xs.CDMCleanupPromise=Promise.all(i.map(r=>this.removeSession(r)).concat(t==null||(e=t.setMediaKeys(null))==null?void 0:e.catch(r=>{var o;this.log(`Could not clear media keys: ${r}`),(o=this.hls)==null||o.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${r}`)})}))).catch(r=>{var o;this.log(`Could not close sessions and clear media keys: ${r}`),(o=this.hls)==null||o.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${r}`)})}).then(()=>{s&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);s>-1&&this.mediaKeySessions.splice(s,1);const{drmSystemOptions:r}=this.config;return(iS(r)?new Promise((a,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(a)}):Promise.resolve()).catch(a=>{var l;this.log(`Could not remove session: ${a}`),(l=this.hls)==null||l.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${a}`)})}).then(()=>t.close()).catch(a=>{var l;this.log(`Could not close session: ${a}`),(l=this.hls)==null||l.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${a}`)})})}}}Xs.CDMCleanupPromise=void 0;class xt extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class hE{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(x.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(x.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,l=1e3*o/r,h=this.hls;if(h.trigger(x.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),l>0&&o>h.config.fpsDroppedMonitoringThreshold*a){let c=h.currentLevel;h.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+c),c>0&&(h.autoLevelCapping===-1||h.autoLevelCapping>=c)&&(c=c-1,h.trigger(x.FPS_DROP_LEVEL_CAPPING,{level:c,droppedLevel:h.currentLevel}),h.autoLevelCapping=c,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function $g(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function zg(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){pe.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){pe.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function $s(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues)for(let i=n.cues.length;i--;)e&&n.cues[i].removeEventListener("enter",e),n.removeCue(n.cues[i]);t==="disabled"&&(n.mode=t)}function zl(n,e,t,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=uE(n.cues,e,t);for(let o=0;o<r.length;o++)(!i||i(r[o]))&&n.removeCue(r[o])}s==="disabled"&&(n.mode=s)}function cE(n,e){if(e<=n[0].startTime)return 0;const t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t,r;for(;i<=s;)if(r=Math.floor((s+i)/2),e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r;return n[i].startTime-e<e-n[s].startTime?i:s}function uE(n,e,t){const i=[],s=cE(n,e);if(s>-1)for(let r=s,o=n.length;r<o;r++){const a=n[r];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function lo(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}class dE extends Gh{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=lo(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.LEVEL_LOADING,this.onLevelLoading,this),e.on(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(x.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(x.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.LEVEL_LOADING,this.onLevelLoading,this),e.off(x.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(x.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(x.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const s=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,s)return;lo(i.textTracks).forEach(o=>{$s(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(c=>!i||i.indexOf(c.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(c=>c.default)&&(this.selectDefaultTrack=!1),o.forEach((c,u)=>{c.id=u});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!r&&a){this.selectDefaultTrack=!1;const c=Vt(a,o);if(c>-1)r=o[c];else{const u=Vt(a,this.tracks);r=this.tracks[u]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const h={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(x.SUBTITLE_TRACKS_UPDATED,h),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){const r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||cs(r,e)))return s}if(e){for(let s=0;s<t.length;s++){const r=t[s];if(Br(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const r=t[s];if(Br(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(Ul(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===fe.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&cs(e,i))return i;const s=Vt(e,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=Vt(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(x.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=lo(e.textTracks),i=this.currentTrack;let s;if(i&&(s=t.filter(r=>Ul(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!K(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(x.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:o,groupId:a="",name:l,type:h,url:c}=s;this.hls.trigger(x.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:l,type:h,url:c});const u=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(u)}}function fE(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}function Er(n){let e=5381,t=n.length;for(;t;)e=e*33^n.charCodeAt(--t);return(e>>>0).toString()}const js=.025;let zo=function(n){return n[n.Point=0]="Point",n[n.Range=1]="Range",n}({});function gE(n,e,t){return`${n.identifier}-${t+1}-${Er(e)}`}class pE{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return $a(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=$a(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=K(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return $a(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<js))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?zo.Range:zo.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return mE(this)}}function $a(n,e){return n-e.start<e.duration/2&&!(Math.abs(n-(e.start+e.duration))<js)?e.start:e.start+e.duration}function Gg(n,e,t){const i=new self.URL(n,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function za(n,e){for(;(t=n.assetList[++e])!=null&&t.error;)var t;return e}function mE(n){return`["${n.identifier}" ${n.cue.pre?"<pre>":n.cue.post?"<post>":""}${n.timelineStart.toFixed(2)}-${n.resumeTime.toFixed(2)}]`}function Ds(n){const e=n.timelineStart,t=n.duration||0;return`["${n.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class _E{constructor(e,t,i,s){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(x.PLAYOUT_LIMIT_REACHED,{})};const r=this.hls=new e(t);this.interstitial=i,this.assetItem=s;let o=s.uri;try{o=Gg(o,t.primarySessionId).href}catch{}r.loadSource(o);const a=()=>{this.hasDetails=!0};r.once(x.LEVEL_LOADED,a),r.once(x.AUDIO_TRACK_LOADED,a),r.once(x.SUBTITLE_TRACK_LOADED,a),r.on(x.MEDIA_ATTACHING,(l,{media:h})=>{this.removeMediaListeners(),this.mediaAttached=h,this.interstitial.playoutLimit&&(h.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(x.BUFFER_APPENDED,()=>{const u=this.bufferedEnd;this.reachedPlayout(u)&&(this._bufferedEosTime=u,r.trigger(x.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return((e=this.interstitial)==null?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const i=this.timelineOffset,s=ne.bufferInfo(e,i,0);return this.getAssetTime(s.end)>=this._bufferedEosTime-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=ne.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){const e=this.hls;if(this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${Ds(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const Ou=.033;class xE extends hi{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,s)=>e<=s.startOffset&&t>s.startOffset?(delete s.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const s=this.items;if(s)for(s[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=s[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let s=0;s<i.length;s++){let r=i[s];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return s}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let s=e;s<=t&&i[s];s++){const r=i[s].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return s}return-1}findEventIndex(e){const t=this.items;if(t)for(let s=t.length;s--;){var i;if(((i=t[s].event)==null?void 0:i.identifier)===e)return s}return-1}findAssetIndex(e,t){const i=e.assetList,s=i.length;if(s>1)for(let r=0;r<s;r++){const o=i[r];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&t<a+(o.duration||0))return r}}return 0}get assetIdAtEnd(){var e,t;const i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){const s=i.assetList,r=s[s.length-1];if(r)return r.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:s}=i,r=this.events,o=this.parseDateRanges(s,{url:i.url},t),a=Object.keys(s),l=r?r.filter(h=>!a.includes(h.identifier)):[];o.length&&o.sort((h,c)=>{const u=h.cue.pre,d=h.cue.post,f=c.cue.pre,g=c.cue.post;if(u&&!f)return-1;if(f&&!u||d&&!g)return 1;if(g&&!d)return-1;if(!u&&!f&&!d&&!g){const p=h.startTime,m=c.startTime;if(p!==m)return p-m}return h.dateRange.tagOrder-c.dateRange.tagOrder}),this.events=o,l.forEach(h=>{this.removeEvent(h)}),this.updateSchedule(e,l)}updateSchedule(e,t=[]){const i=this.events||[];if(i.length||t.length||this.length<2){const s=this.items,r=this.parseSchedule(i,e);(t.length||(s==null?void 0:s.length)!==r.length||r.some((a,l)=>Math.abs(a.playout.start-s[l].playout.start)>.005||Math.abs(a.playout.end-s[l].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(t,s))}}parseDateRanges(e,t,i){const s=[],r=Object.keys(e);for(let o=0;o<r.length;o++){const a=r[o],l=e[a];if(l.isInterstitial){let h=this.eventMap[a];h?h.setDateRange(l):(h=new pE(l,t),this.eventMap[a]=h,i===!1&&(h.appendInPlace=i)),s.push(h)}}return s}parseSchedule(e,t){const i=[],s=t.main.details,r=s.live?1/0:s.edge;let o=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,h=0;if(e.forEach((c,u)=>{const d=c.cue.pre,f=c.cue.post,g=e[u-1]||null,p=c.appendInPlace,m=f?r:c.startOffset,_=c.duration,T=c.timelineOccupancy===zo.Range?_:0,S=c.resumptionOffset,v=(g==null?void 0:g.startTime)===m,E=m+c.cumulativeDuration;let C=p?E+_:m+S;if(d||!f&&m<=0){const A=h;h+=T,c.timelineStart=E;const L=o;o+=_,i.push({event:c,start:E,end:C,playout:{start:L,end:o},integrated:{start:A,end:h}})}else if(m<=r){if(!v){const R=m-l;if(R>Ou){const M=l,F=h;h+=R;const z=o;o+=R;const G={previousEvent:e[u-1]||null,nextEvent:c,start:M,end:M+R,playout:{start:z,end:o},integrated:{start:F,end:h}};i.push(G)}else R>0&&g&&(g.cumulativeDuration+=R,i[i.length-1].end=m)}f&&(C=E),c.timelineStart=E;const A=h;h+=T;const L=o;o+=_,i.push({event:c,start:E,end:C,playout:{start:L,end:o},integrated:{start:A,end:h}})}else return;const b=c.resumeTime;f||b>r?l=r:l=b}),l<r){var a;const c=l,u=h,d=r-l;h+=d;const f=o;o+=d,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:l,end:c+d,playout:{start:f,end:o},integrated:{start:u,end:h}})}this.setDurations(r,o,h)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,s=i.live?1/0:i.edge;let r=0,o=-1;e.forEach((a,l)=>{const h=a.cue.pre,c=a.cue.post,u=h?0:c?s:a.startTime;this.updateAssetDurations(a),o===u?a.cumulativeDuration=r:(r=0,o=u),!c&&a.snapOptions.in&&(a.resumeAnchor=fs(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<Ou&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const f=K(a.resumeOffset)?a.resumeOffset:a.duration;r+=f})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,s=e.startTime+e.resumptionOffset;return Math.abs(i-s)>js?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${s}`),!1):t?!Object.keys(t).some(o=>{const a=t[o].details,l=a.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${l}`),!1;const h=fs(null,a.fragments,i);if(!h)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const c=o==="audio"?.175:0;return Math.abs(h.start-i)<js+c||Math.abs(h.end-i)<js+c?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${h.start}-${h.end} sn: ${h.sn} cc: ${h.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,s=!1,r=!1;e.assetList.forEach((o,a)=>{const l=t+i;o.startOffset=i,o.timelineStart=l,s||(s=o.duration===null),r||(r=!!o.error);const h=o.error?0:o.duration||0;i+=h}),s&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Ri(n){return`[${n.event?'"'+n.event.identifier+'"':"primary"}: ${n.start.toFixed(2)}-${n.end.toFixed(2)}]`}class yE{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let s;try{s=Gg(i,this.hls.sessionId,e.baseUrl)}catch(d){const f=this.assignAssetListError(e,D.ASSET_LIST_LOAD_ERROR,d,i);this.hls.trigger(x.ERROR,f);return}t&&s.protocol!=="data:"&&s.searchParams.set("_HLS_start_offset",""+t);const r=this.hls.config,o=r.loader,a=new o(r),l={responseType:"json",url:s.href},h=r.interstitialAssetListLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,f,g,p)=>{const m=d.data,_=m==null?void 0:m.ASSETS;if(!Array.isArray(_)){const T=this.assignAssetListError(e,D.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),g.url,f,p);this.hls.trigger(x.ERROR,T);return}e.assetListResponse=m,this.hls.trigger(x.ASSET_LIST_LOADED,{event:e,assetListResponse:m,networkDetails:p})},onError:(d,f,g,p)=>{const m=this.assignAssetListError(e,D.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${d.code} ${d.text} (${f.url})`),f.url,p,g);this.hls.trigger(x.ERROR,m)},onTimeout:(d,f,g)=>{const p=this.assignAssetListError(e,D.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${f.url})`),f.url,d,g);this.hls.trigger(x.ERROR,p)}};return a.load(l,c,u),this.hls.trigger(x.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,s,r,o){return e.error=i,{type:Z.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:s,error:i,networkDetails:o,stats:r}}}function Bu(n){n==null||n.play().catch(()=>{})}class TE extends hi{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;const s=i-this.timelinePos;if(Math.abs(s)<1/7056e5)return;const o=s<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-s)&&this.updateSchedule(),this.checkBuffer(),o&&i<a.start||i>=a.end){var l;const d=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(a)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!o){const f=this.findItemIndex(a);if(d>f){const g=this.schedule.findJumpRestrictedIndex(f+1,d);if(g>f){this.setSchedulePosition(g);return}}}this.setSchedulePosition(d);return}const h=this.playingAsset;if(!h){if(this.playingLastItem&&this.isInterstitial(a)){const d=a.event.assetList[0];d&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,d))}return}const c=h.timelineStart,u=h.duration||0;(o&&i<c||i>=c+u)&&this.setScheduleToAssetAtTime(i,h)},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const s=this.playingItem;if(!s||this.playingLastItem)return;if(i>=s.end){this.timelinePos=s.end;const a=this.findItemIndex(s);this.setSchedulePosition(a+1)}const r=this.playingAsset;if(!r)return;const o=r.timelineStart+(r.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,s)=>{const r=this.schedule,o=this.playingItem,a=r.events||[],l=r.items||[],h=r.durations,c=i.map(g=>g.identifier),u=!!(a.length||c.length);(u||s)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${l.map(g=>Ri(g))} pos: ${this.timelinePos}`),c.length&&this.log(`Removed events ${c}`),this.playerQueue.forEach(g=>{if(g.interstitial.appendInPlace){const p=g.assetItem.timelineStart,m=g.timelineOffset-p;if(m)try{g.timelineOffset=p}catch(_){Math.abs(m)>js&&this.warn(`${_} ("${g.assetId}" ${g.timelineOffset}->${p})`)}}});let d=null;if(o){const g=this.updateItem(o,this.timelinePos);this.itemsMatch(o,g)&&(this.playingItem=g,this.waitingItem=this.endedItem=null,d=()=>this.trimInPlace(g,o))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f){const g=this.updateItem(f,this.bufferedPos);this.itemsMatch(f,g)?(this.bufferingItem=g,d||(d=()=>this.trimInPlace(g,f))):f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))}if(i.forEach(g=>{g.assetList.forEach(p=>{this.clearAssetPlayer(p.identifier,null)})}),u||s){if(this.hls.trigger(x.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:l.slice(0),durations:h,removedIds:c}),this.isInterstitial(o)&&c.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}d&&d(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new yE(e),this.schedule=new xE(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(x.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(x.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(x.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(x.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(x.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(x.BUFFER_APPENDED,this.onBufferAppended,this),e.on(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(x.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(x.MEDIA_ENDED,this.onMediaEnded,this),e.on(x.ERROR,this.onError,this),e.on(x.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(x.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(x.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(x.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(x.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(x.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(x.BUFFER_CODECS,this.onBufferCodecs,this),e.off(x.BUFFER_APPENDED,this.onBufferAppended,this),e.off(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(x.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(x.MEDIA_ENDED,this.onMediaEnded,this),e.off(x.ERROR,this.onError,this),e.off(x.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Et(e,"play",this.onPlay),Et(e,"pause",this.onPause),Et(e,"seeking",this.onSeeking),Et(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;ft(i,"seeking",this.onSeeking),ft(i,"timeupdate",this.onTimeupdate),ft(i,"play",this.onPlay),ft(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,s=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!s){this.clearScheduleState();const r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,s=this.media;if(this.media=null,!i&&(s&&this.removeMediaListeners(s),this.detachedData)){const r=this.getBufferingPlayer();r&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=u=>u&&e.getAssetPlayer(u.identifier),s=(u,d,f,g,p)=>{if(u){let m=u[d].start;const _=u.event;if(_){if(d==="playout"||_.timelineOccupancy!==zo.Point){const T=i(f);(T==null?void 0:T.interstitial)===_&&(m+=T.assetItem.startOffset+T[p])}}else{const T=g==="bufferedPos"?o():e[g];m+=T-u.start}return m}return 0},r=(u,d)=>{if(u!==0&&d!=="primary"&&e.schedule.length){var f;const g=e.schedule.findItemIndexAtTime(u),p=(f=e.schedule.items)==null?void 0:f[g];if(p){const m=p[d].start-p.start;return u+m}}return u},o=()=>{const u=e.bufferedPos;return u===Number.MAX_VALUE?a("primary"):Math.max(u,0)},a=u=>{var d;return(d=e.primaryDetails)!=null&&d.live?e.primaryDetails.edge:e.schedule.durations[u]},l=(u,d)=>{var f,g;const p=e.effectivePlayingItem;if(p!=null&&(f=p.event)!=null&&f.restrictions.skip)return;e.log(`seek to ${u} "${d}"`);const m=e.effectivePlayingItem,_=e.schedule.findItemIndexAtTime(u,d),T=(g=e.schedule.items)==null?void 0:g[_],S=e.getBufferingPlayer(),v=S==null?void 0:S.interstitial,E=v==null?void 0:v.appendInPlace,C=m&&e.itemsMatch(m,T);if(m&&(E||C)){const A=i(e.playingAsset),L=(A==null?void 0:A.media)||e.primaryMedia;if(L){const R=d==="primary"?L.currentTime:s(m,d,e.playingAsset,"timelinePos","currentTime"),M=u-R,F=(E?R:L.currentTime)+M;if(F>=0&&(!A||E||F<=A.duration)){L.currentTime=F;return}}}if(T){let A=u;if(d!=="primary"){const R=T[d].start,M=u-R;A=T.start+M}const L=!e.isInterstitial(T);if((!e.isInterstitial(m)||m.event.appendInPlace)&&(L||T.event.appendInPlace)){const R=e.media||(E?S==null?void 0:S.media:null);R&&(R.currentTime=A)}else if(m){const R=e.findItemIndex(m);if(_>R){const F=e.schedule.findJumpRestrictedIndex(R+1,_);if(F>R){e.setSchedulePosition(F);return}}let M=0;if(L)e.timelinePos=A,e.checkBuffer();else{var b;const F=T==null||(b=T.event)==null?void 0:b.assetList;if(F){const z=u-(T[d]||T).start;for(let G=F.length;G--;){const k=F[G];if(k.duration&&z>=k.startOffset&&z<k.startOffset+k.duration){M=G;break}}}}e.setSchedulePosition(_,M)}}},h=()=>{const u=e.effectivePlayingItem;if(e.isInterstitial(u))return u;const d=t();return e.isInterstitial(d)?d:null},c={get currentTime(){const u=h(),d=e.effectivePlayingItem;return d&&d===u?s(d,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-d.playout.start:0},set currentTime(u){const d=h(),f=e.effectivePlayingItem;f&&f===d&&l(u+f.playout.start,"playout")},get duration(){const u=h();return u?u.playout.end-u.playout.start:0},get assetPlayers(){var u;const d=(u=h())==null?void 0:u.event.assetList;return d?d.map(f=>e.getAssetPlayer(f.identifier)):[]},get playingIndex(){var u;const d=(u=h())==null?void 0:u.event;return d&&e.effectivePlayingAsset?d.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return h()}};this.manager={get events(){var u,d;return((u=e.schedule)==null||(d=u.events)==null?void 0:d.slice(0))||[]},get schedule(){var u,d;return((u=e.schedule)==null||(d=u.items)==null?void 0:d.slice(0))||[]},get interstitialPlayer(){return h()?c:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const u=t();return e.findItemIndex(u)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const u=e.effectivePlayingItem;return e.findItemIndex(u)},primary:{get bufferedEnd(){return o()},get currentTime(){const u=e.timelinePos;return u>0?u:0},set currentTime(u){l(u,"primary")},get duration(){return a("primary")},get seekableStart(){var u;return((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0}},integrated:{get bufferedEnd(){return s(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return s(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(u){l(u,"integrated")},get duration(){return a("integrated")},get seekableStart(){var u;return r(((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0,"integrated")}},skip:()=>{const u=e.effectivePlayingItem,d=u==null?void 0:u.event;if(d&&!d.restrictions.skip){const f=e.findItemIndex(u);if(d.appendInPlace){const g=u.playout.start+u.event.duration;l(g+.001,"playout")}else e.advanceAfterAssetEnded(d,f,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t,i;if(this.mediaSelection===null)return;const s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let r=this.media;!r&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(r=this.primaryMedia);const o=(i=r)==null?void 0:i.currentTime;if(!(o===void 0||!K(o)))return o}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,s=e.media;if(i&&s===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&s){this.detachedData={media:s};return}const r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${we(r)}`),this.detachedData=r}else t&&s&&(this.shouldPlay||(this.shouldPlay=!s.paused))}transferMediaTo(e,t){var i,s;if(e.media===t)return;let r=null;const o=this.hls,a=e!==o,l=a&&e.interstitial.appendInPlace,h=(i=this.detachedData)==null?void 0:i.mediaSource;let c;if(o.media)l&&(r=o.transferMedia(),this.detachedData=r),c="Primary";else if(h){const f=this.getBufferingPlayer();f?(r=f.transferMedia(),c=`${f}`):c="detached MediaSource"}else c="detached media";if(!r){if(h)r=this.detachedData,this.log(`using detachedData: MediaSource ${we(r)}`);else if(!this.detachedData||o.media===t){const f=this.playerQueue;f.length>1&&f.forEach(g=>{if(a&&g.interstitial.appendInPlace!==l){const p=g.interstitial;this.clearInterstitial(g.interstitial,null),p.appendInPlace=!1,p.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${p}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const u=r&&"mediaSource"in r&&((s=r.mediaSource)==null?void 0:s.readyState)!=="closed",d=u&&r?r:t;if(this.log(`${u?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${c}`),d===r){const f=a&&e.assetId===this.schedule.assetIdAtEnd;d.overrides={duration:this.schedule.duration,endOfStream:!a||f,cueRemoval:!a}}e.attachMedia(d)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,s=this.effectivePlayingItem;if(i===-1){const r=this.hls.startPosition;if(this.timelinePos=r,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(r>=0||!this.primaryLive){const o=this.timelinePos=r>0?r:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(s&&!this.playingItem){const r=e.findItemIndex(s);this.setSchedulePosition(r)}}advanceAfterAssetEnded(e,t,i){const s=za(e,i);if(!e.isAssetPastPlayoutLimit(s))this.setSchedulePosition(t,s);else{const r=this.schedule.items;if(r){const o=t+1,a=r.length;if(o>=a){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.timelinePos=l,this.checkBuffer()),this.setSchedulePosition(o)}}}setScheduleToAssetAtTime(e,t){const i=this.schedule,s=t.parentIdentifier,r=i.getEvent(s);if(r){const o=i.findEventIndex(s),a=i.findAssetIndex(r,e);this.advanceAfterAssetEnded(r,o,a-1)}}setSchedulePosition(e,t){const i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const s=e>=0?i[e]:null,r=this.playingItem,o=this.playingLastItem;if(this.isInterstitial(r)){var a;const h=r.event,c=this.playingAsset,u=c==null?void 0:c.identifier,d=u?this.getAssetPlayer(u):null;if(d&&u&&(!this.eventItemsMatch(r,s)||t!==void 0&&u!==((a=h.assetList)==null?void 0:a[t].identifier))){var l;const f=h.findAssetIndex(c);this.log(`INTERSTITIAL_ASSET_ENDED ${f+1}/${h.assetList.length} ${Ds(c)}`),this.endedAsset=c,this.playingAsset=null,this.hls.trigger(x.INTERSTITIAL_ASSET_ENDED,{asset:c,assetListIndex:f,event:h,schedule:i.slice(0),scheduleIndex:e,player:d}),this.retreiveMediaSource(u,s),d.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&d.detachMedia()}if(!this.eventItemsMatch(r,s)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${h} ${Ri(r)}`),h.hasPlayed=!0,this.hls.trigger(x.INTERSTITIAL_ENDED,{event:h,schedule:i.slice(0),scheduleIndex:e}),h.cue.once)){this.updateSchedule();const f=this.schedule.items;if(s&&f){const g=this.schedule.findItemIndex(s);this.advanceSchedule(g,f,t,r,o)}return}}this.advanceSchedule(e,i,t,r,o)}advanceSchedule(e,t,i,s,r){const o=e>=0?t[e]:null,a=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(h=>{const c=h.interstitial,u=this.schedule.findEventIndex(c.identifier);(u<e||u>e+1)&&this.clearInterstitial(c,o)}),this.isInterstitial(o)){this.timelinePos=Math.min(Math.max(this.timelinePos,o.start),o.end);const h=o.event;if(i===void 0){i=this.schedule.findAssetIndex(h,this.timelinePos);const f=za(h,i-1);if(h.isAssetPastPlayoutLimit(f)){this.advanceAfterAssetEnded(h,e,i);return}i=f}const c=this.waitingItem;this.assetsBuffered(o,a)||this.setBufferingItem(o);let u=this.preloadAssets(h,i);if(this.eventItemsMatch(o,c||s)||(this.waitingItem=o,this.log(`INTERSTITIAL_STARTED ${Ri(o)} ${h.appendInPlace?"append in place":""}`),this.hls.trigger(x.INTERSTITIAL_STARTED,{event:h,schedule:t.slice(0),scheduleIndex:e})),!h.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${h}`);return}if(h.assetListLoader&&(h.assetListLoader.destroy(),h.assetListLoader=void 0),!a){this.log(`Waiting for attachMedia to start Interstitial ${h}`);return}this.waitingItem=this.endedItem=null,this.playingItem=o;const d=h.assetList[i];if(!d){const f=t[e+1],g=this.media;f&&g&&!this.isInterstitial(f)&&g.currentTime<f.start&&(g.currentTime=this.timelinePos=f.start),this.advanceAfterAssetEnded(h,e,i||0);return}if(u||(u=this.getAssetPlayer(d.identifier)),u===null||u.destroyed){const f=h.assetList.length;this.warn(`asset ${i+1}/${f} player destroyed ${h}`),u=this.createAssetPlayer(h,d,i)}if(!this.eventItemsMatch(o,this.bufferingItem)&&h.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(u,i,t,e,a),this.shouldPlay&&Bu(u.media)}else o!==null?(this.resumePrimary(o,e,s),this.shouldPlay&&Bu(this.hls.media)):r&&this.isInterstitial(s)&&(this.endedItem=null,this.playingItem=s,s.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var s;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Ri(e)}`),!((s=this.detachedData)!=null&&s.mediaSource)){let o=this.timelinePos;(o<e.start||o>=e.end)&&(o=this.getPrimaryResumption(e,t),this.timelinePos=o),this.attachPrimary(o,e)}if(!i)return;const r=this.schedule.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Ri(e)}`),this.hls.trigger(x.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const s=this.primaryDetails;if(t===0)return this.hls.startPosition;if(s&&(i<s.fragmentStart||i>s.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:ne.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const s=this.primaryMedia;if(!s)return;const r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,s),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const s=this.hls;!s.loadingEnabled||!s.media||Math.abs((((i=s.mainForwardBufferInfo)==null?void 0:i.start)||s.media.currentTime)-e)>.5?s.startLoad(e,t):s.bufferingEnabled||s.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(x.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(x.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1)return;const i=this.hls.levels[t.level],s=ye(ye({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=s,this.schedule.parseInterstitialDateRanges(s,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=ye(ye({},this.altSelection),{},{audio:i});return}const r=ye(ye({},s),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=ye(ye({},this.altSelection),{},{subtitles:i});return}const r=ye(ye({},s),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){const i=jc(t);this.playerQueue.forEach(s=>s.hls.setAudioOption(t)||s.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){const i=jc(t);this.playerQueue.forEach(s=>s.hls.setSubtitleOption(t)||t.id!==-1&&s.hls.setSubtitleOption(i))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const s=this.timelinePos;this.bufferedPos=s,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let s=0;s<t.length;s++){const r=t[s];if(r.cue.post){var i;const o=this.schedule.findEventIndex(r.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){const i=this.schedule.items;if(e&&i){const s=this.findItemIndex(e,t);return i[s]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((r,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(r.identifier,null)});const i=e.end+.25,s=ne.bufferInfo(this.primaryMedia,i,0);(s.end>i||(s.nextStart||0)>i)&&(this.attachPrimary(i,null),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const i=ne.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){const s=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let l=s.findItemIndexAtTime(e);if(this.bufferedPos<e){var h,c;const u=this.findItemIndex(r),d=Math.min(u+1,t.length-1),f=t[d];if((l===-1&&r&&e>=r.end||(h=f.event)!=null&&h.appendInPlace&&e+.01>=f.start)&&(l=d),d-a>1&&(r==null||(c=r.event)==null?void 0:c.appendInPlace)===!1)return;if(this.bufferedPos=e,l>u&&l>a)this.bufferedToItem(f);else{const g=this.primaryDetails;this.primaryLive&&g&&e>g.edge-g.targetduration&&f.start<g.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(f)&&this.preloadAssets(f.event,0)}}else i&&o&&!this.itemsMatch(o,r)&&(l===a?this.bufferedToItem(o):l===a+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(s=>{const r=this.getAssetPlayer(s.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:s,events:r}=i;if(!s||!r)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const l=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Ri(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),this.playbackDisabled||(o?e.event.assetList.forEach(h=>{const c=this.getAssetPlayer(h.identifier);c&&c.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(h=>h.pauseBuffering()))),this.hls.trigger(x.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:s.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const s=this.detachedData;s?s.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,s=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(s||!r){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=i.assetList[t],l=this.primaryMedia;a&&l&&this.bufferAssetPlayer(o,l)}}}preloadAssets(e,t){const i=e.assetUrl,s=e.assetList.length,r=s===0&&!e.assetListLoader,o=e.cue.once;if(r){const l=e.timelineStart;if(e.appendInPlace){var a;const d=this.playingItem;!this.isInterstitial(d)&&(d==null||(a=d.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let h,c=0;if(!this.playingItem&&this.primaryLive&&(c=this.hls.startPosition,c===-1&&(c=this.hls.liveSyncPosition||0)),c&&!(e.cue.pre||e.cue.post)){const d=c-l;d>0&&(h=Math.round(d*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:s} ${e}${h?` live-start: ${c} start-offset: ${h}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const u=this.assetListLoader.loadAssetList(e,h);u&&(e.assetListLoader=u)}else if(!o&&s){for(let l=t;l<s;l++){const h=e.assetList[l],c=this.getAssetPlayerQueueIndex(h.identifier);(c===-1||this.playerQueue[c].destroyed)&&!h.error&&this.createAssetPlayer(e,h,l)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(s=>{this.hls.trigger(x.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:s})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,s,r,o){const a={parentIdentifier:e.identifier,identifier:gE(e,o,t),duration:r,startOffset:i,timelineStart:s,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const s=this.hls,r=s.userConfig;let o=r.videoPreference;const a=s.loadLevelObj||s.levels[s.currentLevel];(o||a)&&(o=Ee({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const l=s.audioTracks[s.audioTrack],h=s.subtitleTracks[s.subtitleTrack];let c=0;if(this.primaryLive||e.appendInPlace){const S=this.timelinePos-t.timelineStart;if(S>1){const v=t.duration;v&&S<v&&(c=S)}}const u=t.identifier,d=ye(ye({},r),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:s.sessionId,assetPlayerId:u,abrEwmaDefaultEstimate:s.bandwidthEstimate,interstitialsController:void 0,startPosition:c,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:l||r.audioPreference,subtitlePreference:h||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(d.timelineOffset=t.timelineStart));const f=d.cmcd;f!=null&&f.sessionId&&f.contentId&&(d.cmcd=Ee({},f,{contentId:Er(t.uri)})),this.getAssetPlayer(u)&&this.warn(`Duplicate date range identifier ${e} and asset ${u}`);const g=new _E(this.HlsPlayerClass,d,e,t);this.playerQueue.push(g),e.assetList[i]=t;const p=S=>{if(S.live){const C=new Error(`Interstitials MUST be VOD assets ${e}`),b={fatal:!0,type:Z.OTHER_ERROR,details:D.INTERSTITIAL_ASSET_ITEM_ERROR,error:C};this.handleAssetItemError(b,e,this.schedule.findEventIndex(e.identifier),i,C.message);return}const v=S.edge-S.fragmentStart,E=t.duration;(E===null||v>E)&&(this.log(`Interstitial asset "${u}" duration change ${E} > ${v}`),t.duration=v,this.updateSchedule())};g.on(x.LEVEL_UPDATED,(S,{details:v})=>p(v)),g.on(x.LEVEL_PTS_UPDATED,(S,{details:v})=>p(v));const m=(S,v)=>{const E=this.getAssetPlayer(u);if(E&&v.tracks){E.off(x.BUFFER_CODECS,m),E.tracks=v.tracks;const C=this.primaryMedia;this.bufferingAsset===E.assetItem&&C&&!E.media&&this.bufferAssetPlayer(E,C)}};g.on(x.BUFFER_CODECS,m);const _=()=>{var S;const v=this.getAssetPlayer(u);if(this.log(`buffered to end of asset ${v}`),!v)return;const E=this.schedule.findEventIndex(e.identifier),C=(S=this.schedule.items)==null?void 0:S[E];if(this.isInterstitial(C)){const A=e.findAssetIndex(t),L=za(e,A);if(!e.isAssetPastPlayoutLimit(L))this.bufferedToItem(C,L);else{var b;const R=(b=this.schedule.items)==null?void 0:b[E+1];R&&this.bufferedToItem(R)}}};g.on(x.BUFFERED_TO_END,_);const T=S=>()=>{if(!this.getAssetPlayer(u))return;this.shouldPlay=!0;const E=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,E,S)};return g.once(x.MEDIA_ENDED,T(i)),g.once(x.PLAYOUT_LIMIT_REACHED,T(1/0)),g.on(x.ERROR,(S,v)=>{const E=this.getAssetPlayer(u);if(v.details===D.BUFFER_STALLED_ERROR){if(E!=null&&E.media){const C=E.currentTime,b=E.duration-C;C&&e.appendInPlace&&b/E.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${u} ${e} at ${E.media.currentTime}`),_()):(this.warn(`Stalled at ${C} of ${C+b} in asset ${u} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(v,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${v.error} ${e}`)}),g.on(x.DESTROYING,()=>{if(!this.getAssetPlayer(u))return;const v=new Error(`Asset player destroyed unexpectedly ${u}`),E={fatal:!0,type:Z.OTHER_ERROR,details:D.INTERSTITIAL_ASSET_ITEM_ERROR,error:v};this.handleAssetItemError(E,e,this.schedule.findEventIndex(e.identifier),i,v.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${Ds(t)}`),this.hls.trigger(x.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:g}),g}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clear asset player "${e}" toSegment: ${t&&Ri(t)}`);const s=this.playerQueue[i];this.transferMediaFromPlayer(s,t),this.playerQueue.splice(i,1),s.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,s,r){const{interstitial:o,assetItem:a,assetId:l}=e,h=o.assetList.length,c=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!c||c.identifier!==l)&&(c&&(this.clearAssetPlayer(c.identifier,i[s]),delete c.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${h} ${Ds(a)}`),this.hls.trigger(x.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:s,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,s;const{interstitial:r,assetItem:o}=e,a=this.schedule.findEventIndex(r.identifier),l=(i=this.schedule.items)==null?void 0:i[a];if(!l)return;this.setBufferingItem(l),this.bufferingAsset=o;const h=this.getBufferingPlayer();if(h===e)return;const c=r.appendInPlace;if(c&&(h==null?void 0:h.interstitial.appendInPlace)===!1)return;const u=(h==null?void 0:h.tracks)||((s=this.detachedData)==null?void 0:s.tracks)||this.requiredTracks;if(c&&o!==this.playingAsset){if(!e.tracks)return;if(u&&!Mf(u,e.tracks)){const d=new Error(`Asset ${Ds(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(u)}')`),f={fatal:!0,type:Z.OTHER_ERROR,details:D.INTERSTITIAL_ASSET_ITEM_ERROR,error:d},g=r.findAssetIndex(o);this.handleAssetItemError(f,r,a,g,d.message);return}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,s,r){if(e.details===D.BUFFER_STALLED_ERROR)return;const o=t.assetList[s];this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&Ds(o)} ${e.error}`);const a=o==null?void 0:o.identifier,l=this.getAssetPlayerQueueIndex(a),h=this.playerQueue[l]||null,c=this.schedule.items,u=Ee({},e,{fatal:!1,errorAction:Dr(!0),asset:o,assetListIndex:s,event:t,schedule:c,scheduleIndex:i,player:h});if(this.hls.trigger(x.INTERSTITIAL_ASSET_ERROR,u),!e.fatal)return;const d=this.playingAsset,f=new Error(r);if(o&&(this.clearAssetPlayer(a,null),o.error=f),!t.assetList.some(g=>!g.error))t.error=f;else if(t.appendInPlace){for(let g=s;g<t.assetList.length;g++)this.resetAssetPlayer(t.assetList[g].identifier);this.updateSchedule()}t.error?this.primaryFallback(t):d&&d.identifier===a&&this.advanceAfterAssetEnded(t,i,s)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?Ri(i):"<none>"} error: ${e.error}`);let s=this.timelinePos;s===-1&&(s=this.hls.startPosition);const r=this.updateItem(i,s);this.itemsMatch(i,r)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));const o=this.schedule.findItemIndexAtTime(s);this.setSchedulePosition(o)}else this.checkStart()}onAssetListLoaded(e,t){var i;const s=t.event,r=s.identifier,o=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(r))return;const a=s.timelineStart,l=s.duration;let h=0;o.forEach((g,p)=>{const m=parseFloat(g.DURATION);this.createAsset(s,p,h,a+h,m,g.URI),h+=m}),s.duration=h,this.log(`Loaded asset-list with duration: ${h} (was: ${l}) ${s}`);const c=this.waitingItem,u=(c==null?void 0:c.event.identifier)===r;this.updateSchedule();const d=(i=this.bufferingItem)==null?void 0:i.event;if(u){var f;const g=this.schedule.findEventIndex(r),p=(f=this.schedule.items)==null?void 0:f[g];if(p){if(!this.playingItem&&this.timelinePos>p.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){s.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${s}`),this.primaryFallback(s);return}this.setBufferingItem(p)}this.setSchedulePosition(g)}else if((d==null?void 0:d.identifier)===r&&d.appendInPlace){const g=s.assetList[0],p=this.getAssetPlayer(g.identifier),m=this.primaryMedia;g&&p&&m&&this.bufferAssetPlayer(p,m)}}onError(e,t){switch(t.details){case D.ASSET_LIST_PARSING_ERROR:case D.ASSET_LIST_LOAD_ERROR:case D.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&this.primaryFallback(i);break}case D.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}}const Uu=500;class SE extends Fh{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",q.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(x.LEVEL_LOADED,this.onLevelLoaded,this),e.on(x.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(x.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(x.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(x.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(x.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(x.LEVEL_LOADED,this.onLevelLoaded,this),e.off(x.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(x.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(x.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(x.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(x.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=N.IDLE,this.setInterval(Uu),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(Ve(i)&&(this.fragPrevious=i),this.state=N.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let o;const a=i.start;for(let h=0;h<r.length;h++)if(a>=r[h].start&&a<=r[h].end){o=r[h];break}const l=i.start+i.duration;o?o.end=l:(o={start:a,end:l},r.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=r){o.shift();continue}else if(o[a].start<r)o[a].start=r;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,r,q.SUBTITLE)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===q.SUBTITLE&&(t.details===D.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==N.STOPPED&&(this.state=N.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Dg(this.levels,t)){this.levels=t.map(i=>new Pr(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new Pr(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,q.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.state!==N.STOPPED&&this.setInterval(Uu)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:s,levels:r}=this,{details:o,id:a}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const l=r[a];if(a>=r.length||!l)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let h=0;if(o.live||(i=l.details)!=null&&i.live){const u=this.mainDetails;if(o.deltaUpdateFailed||!u)return;const d=u.fragments[0];if(!l.details)o.hasProgramDateTime&&u.hasProgramDateTime?(No(o,u),h=o.fragmentStart):d&&(h=d.start,kl(o,h));else{var c;h=this.alignPlaylists(o,l.details,(c=this.levelLastLoaded)==null?void 0:c.details),h===0&&d&&(h=d.start,kl(o,h))}}l.details=o,this.levelLastLoaded=l,a===s&&(this.hls.trigger(x.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===N.IDLE&&(fs(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&Ks(s.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer,Dh(s.method)).catch(a=>{throw r.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const l=performance.now();r.trigger(x.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:l}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=N.IDLE})}}doTick(){if(!this.media){this.state=N.IDLE;return}if(this.state===N.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:s}=this,r=this.getLoadPosition(),o=ne.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:a,len:l}=o,h=i.details,c=this.hls.maxBufferLength+h.levelTargetDuration;if(l>c)return;const u=h.fragments,d=u.length,f=h.edge;let g=null;const p=this.fragPrevious;if(a<f){const T=s.maxFragLookUpTolerance,S=a>f-T?0:T;g=fs(p,u,Math.max(u[0].start,a),S),!g&&p&&p.start<u[0].start&&(g=u[0])}else g=u[d-1];if(g=this.filterReplacedPrimary(g,i.details),!g)return;const m=g.sn-h.startSN,_=u[m-1];if(_&&_.cc===g.cc&&this.fragmentTracker.getState(_)===$e.NOT_LOADED&&(g=_),this.fragmentTracker.getState(g)===$e.NOT_LOADED){const T=this.mapToInitFragWhenRequired(g);T&&this.loadFragment(T,i,a)}}}loadFragment(e,t,i){Ve(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new vE(this.tracksBuffered[this.currentTrackId]||[])}}class vE{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const EE={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Hg=n=>String.fromCharCode(EE[n]||n),Rt=15,qt=100,bE={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},AE={17:2,18:4,21:6,22:8,23:10,19:13,20:15},RE={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},CE={25:2,26:4,29:6,30:8,31:10,27:13,28:15},LE=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class wE{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;pe.log(`${this.time} [${e}] ${i}`)}}}const Ji=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Vg{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class IE{constructor(){this.uchar=" ",this.penState=new Vg}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class PE{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Vg,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<qt;t++)this.chars.push(new IE);this.logger=e}equals(e){for(let t=0;t<qt;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<qt;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<qt;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>qt&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=qt)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Hg(e);if(this.pos>=qt){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<qt;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<qt;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Ga{constructor(e){this.rows=[],this.currRow=Rt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Rt;t++)this.rows.push(new PE(e));this.logger=e}reset(){for(let e=0;e<Rt;e++)this.rows[e].clear();this.currRow=Rt-1}equals(e){let t=!0;for(let i=0;i<Rt;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Rt;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Rt;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+we(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<Rt;a++)this.rows[a].clear();const r=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[r].cueStartTime,l=this.logger.time;if(a!==null&&l!==null&&a<l)for(let h=0;h<this.nrRollUpRows;h++)this.rows[t-this.nrRollUpRows+h+1].copy(o.rows[r+h])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,o=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+we(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<Rt;r++){const o=this.rows[r].getTextString();o&&(s=r+1,e?t.push("Row "+s+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Nu{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ga(i),this.nonDisplayedMemory=new Ga(i),this.lastOutputScreen=new Ga(i),this.currRollUpRow=this.displayedMemory.rows[Rt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Rt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+we(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class $u{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=ME(),this.logger=void 0;const s=this.logger=new wE;this.channels=[null,new Nu(e,t,s),new Nu(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const s=t[i]&127,r=t[i+1]&127;let o=!1,a=null;if(s===0&&r===0)continue;this.logger.log(3,()=>"["+Ji([t[i],t[i+1]])+"] -> ("+Ji([s,r])+")");const l=this.cmdHistory;if(s>=16&&s<=31){if(DE(s,r,l)){On(null,null,l),this.logger.log(3,()=>"Repeated command ("+Ji([s,r])+") is dropped");continue}On(s,r,this.cmdHistory),o=this.parseCmd(s,r),o||(o=this.parseMidrow(s,r)),o||(o=this.parsePAC(s,r)),o||(o=this.parseBackgroundAttributes(s,r))}else On(null,null,l);if(!o&&(a=this.parseChars(s,r),a)){const c=this.currentChannel;c&&c>0?this.channels[c].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Ji([s,r])+" orig: "+Ji([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=33&&t<=35;if(!(i||s))return!1;const r=e===20||e===21||e===23?1:2,o=this.channels[r];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Ji([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(s||r))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?bE[e]:RE[e]:i=o===1?AE[e]:CE[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let o;r===17?o=t+80:r===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+Hg(o)+"' in channel "+i),s=[o]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);return s&&this.logger.log(3,()=>"Char codes =  "+Ji(s).join(",")),s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const o={};e===16||e===24?(r=Math.floor((t-32)/2),o.background=LE[r],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}On(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function On(n,e,t){t.a=n,t.b=e}function DE(n,e,t){return t.a===n&&t.b===e}function ME(){return{a:null,b:null}}var Wh=function(){if(Uo!=null&&Uo.VTTCue)return self.VTTCue;const n=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,l){if(typeof l!="string"||!Array.isArray(a))return!1;const h=l.toLowerCase();return~a.indexOf(h)?h:!1}function i(a){return t(n,a)}function s(a){return t(e,a)}function r(a,...l){let h=1;for(;h<arguments.length;h++){const c=arguments[h];for(const u in c)a[u]=c[u]}return a}function o(a,l,h){const c=this,u={enumerable:!0};c.hasBeenReset=!1;let d="",f=!1,g=a,p=l,m=h,_=null,T="",S=!0,v="auto",E="start",C=50,b="middle",A=50,L="middle";Object.defineProperty(c,"id",r({},u,{get:function(){return d},set:function(R){d=""+R}})),Object.defineProperty(c,"pauseOnExit",r({},u,{get:function(){return f},set:function(R){f=!!R}})),Object.defineProperty(c,"startTime",r({},u,{get:function(){return g},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");g=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"endTime",r({},u,{get:function(){return p},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");p=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"text",r({},u,{get:function(){return m},set:function(R){m=""+R,this.hasBeenReset=!0}})),Object.defineProperty(c,"region",r({},u,{get:function(){return _},set:function(R){_=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"vertical",r({},u,{get:function(){return T},set:function(R){const M=i(R);if(M===!1)throw new SyntaxError("An invalid or illegal string was specified.");T=M,this.hasBeenReset=!0}})),Object.defineProperty(c,"snapToLines",r({},u,{get:function(){return S},set:function(R){S=!!R,this.hasBeenReset=!0}})),Object.defineProperty(c,"line",r({},u,{get:function(){return v},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");v=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"lineAlign",r({},u,{get:function(){return E},set:function(R){const M=s(R);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");E=M,this.hasBeenReset=!0}})),Object.defineProperty(c,"position",r({},u,{get:function(){return C},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");C=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"positionAlign",r({},u,{get:function(){return b},set:function(R){const M=s(R);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");b=M,this.hasBeenReset=!0}})),Object.defineProperty(c,"size",r({},u,{get:function(){return A},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");A=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"align",r({},u,{get:function(){return L},set:function(R){const M=s(R);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");L=M,this.hasBeenReset=!0}})),c.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o}();class FE{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function Wg(n){function e(i,s,r,o){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(o||0)}const t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class kE{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function Yg(n,e,t,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const o=s[r].split(t);if(o.length!==2)continue;const a=o[0],l=o[1];e(a,l)}}const Gl=new Wh(0,0,""),Bn=Gl.align==="middle"?"middle":"center";function OE(n,e,t){const i=n;function s(){const a=Wg(n);if(a===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),a}function r(a,l){const h=new kE;Yg(a,function(d,f){let g;switch(d){case"region":for(let p=t.length-1;p>=0;p--)if(t[p].id===f){h.set(d,t[p].region);break}break;case"vertical":h.alt(d,f,["rl","lr"]);break;case"line":g=f.split(","),h.integer(d,g[0]),h.percent(d,g[0])&&h.set("snapToLines",!1),h.alt(d,g[0],["auto"]),g.length===2&&h.alt("lineAlign",g[1],["start",Bn,"end"]);break;case"position":g=f.split(","),h.percent(d,g[0]),g.length===2&&h.alt("positionAlign",g[1],["start",Bn,"end","line-left","line-right","auto"]);break;case"size":h.percent(d,f);break;case"align":h.alt(d,f,["start",Bn,"end","left","right"]);break}},/:/,/\s/),l.region=h.get("region",null),l.vertical=h.get("vertical","");let c=h.get("line","auto");c==="auto"&&Gl.line===-1&&(c=-1),l.line=c,l.lineAlign=h.get("lineAlign","start"),l.snapToLines=h.get("snapToLines",!0),l.size=h.get("size",100),l.align=h.get("align",Bn);let u=h.get("position","auto");u==="auto"&&Gl.position===50&&(u=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=u}function o(){n=n.replace(/^\s+/,"")}if(o(),e.startTime=s(),o(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),o(),e.endTime=s(),o(),r(n,e)}function Kg(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class BE{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new FE,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,o=0;for(r=Kg(r);o<r.length&&r[o]!=="\r"&&r[o]!==`
`;)++o;const a=r.slice(0,o);return r[o]==="\r"&&++o,r[o]===`
`&&++o,t.buffer=r.slice(o),a}function s(r){Yg(r,function(o,a){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const a=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new Wh(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{OE(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=r.indexOf("-->")!==-1;if(!r||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const UE=/\r\n|\n\r|\n|\r/g,Ha=function(e,t,i=0){return e.slice(i,i+t.length)===t},NE=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!K(t)||!K(i)||!K(s)||!K(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t};function Yh(n,e,t){return Er(n.toString())+Er(e.toString())+Er(t)}const $E=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(o=r)!=null&&o.new;){var o;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function zE(n,e,t,i,s,r,o){const a=new BE,l=mt(new Uint8Array(n)).trim().replace(UE,`
`).split(`
`),h=[],c=e?iv(e.baseTime,e.timescale):0;let u="00:00.000",d=0,f=0,g,p=!0;a.oncue=function(m){const _=t[i];let T=t.ccOffset;const S=(d-c)/9e4;if(_!=null&&_.new&&(f!==void 0?T=t.ccOffset=_.start:$E(t,i,S)),S){if(!e){g=new Error("Missing initPTS for VTT MPEGTS");return}T=S-t.presentationOffset}const v=m.endTime-m.startTime,E=St((m.startTime+T-f)*9e4,s*9e4)/9e4;m.startTime=Math.max(E,0),m.endTime=Math.max(E+v,0);const C=m.text.trim();m.text=decodeURIComponent(encodeURIComponent(C)),m.id||(m.id=Yh(m.startTime,m.endTime,C)),m.endTime>0&&h.push(m)},a.onparsingerror=function(m){g=m},a.onflush=function(){if(g){o(g);return}r(h)},l.forEach(m=>{if(p)if(Ha(m,"X-TIMESTAMP-MAP=")){p=!1,m.slice(16).split(",").forEach(_=>{Ha(_,"LOCAL:")?u=_.slice(6):Ha(_,"MPEGTS:")&&(d=parseInt(_.slice(7)))});try{f=NE(u)/1e3}catch(_){g=_}return}else m===""&&(p=!1);a.parse(m+`
`)}),a.flush()}const Va="stpp.ttml.im1t",Xg=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,jg=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,GE={left:"start",center:"center",right:"end",start:"start",end:"end"};function zu(n,e,t,i){const s=he(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(a=>mt(a)),o=tv(e.baseTime,1,e.timescale);try{r.forEach(a=>t(HE(a,o)))}catch(a){i(a)}}function HE(n,e){const s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(r).reduce((u,d)=>(u[d]=s.getAttribute(`ttp:${d}`)||r[d],u),{}),a=s.getAttribute("xml:space")!=="preserve",l=Gu(Wa(s,"styling","style")),h=Gu(Wa(s,"layout","region")),c=Wa(s,"body","[begin]");return[].map.call(c,u=>{const d=qg(u,a);if(!d||!u.hasAttribute("begin"))return null;const f=Ka(u.getAttribute("begin"),o),g=Ka(u.getAttribute("dur"),o);let p=Ka(u.getAttribute("end"),o);if(f===null)throw Hu(u);if(p===null){if(g===null)throw Hu(u);p=f+g}const m=new Wh(f-e,p-e,d);m.id=Yh(m.startTime,m.endTime,m.text);const _=h[u.getAttribute("region")],T=l[u.getAttribute("style")],S=VE(_,T,l),{textAlign:v}=S;if(v){const E=GE[v];E&&(m.lineAlign=E),m.align=v}return Ee(m,S),m}).filter(u=>u!==null)}function Wa(n,e,t){const i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function Gu(n){return n.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function qg(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?qg(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function VE(n,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(s=t[o]),r.reduce((a,l)=>{const h=Ya(e,i,l)||Ya(n,i,l)||Ya(s,i,l);return h&&(a[l]=h),a},{})}function Ya(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function Hu(n){return new Error(`Could not parse ttml timestamp ${n}`)}function Ka(n,e){if(!n)return null;let t=Wg(n);return t===null&&(Xg.test(n)?t=WE(n,e):jg.test(n)&&(t=YE(n,e))),t}function WE(n,e){const t=Xg.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function YE(n,e){const t=jg.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class Un{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class KE{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Wu(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(x.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(x.FRAG_LOADING,this.onFragLoading,this),e.on(x.FRAG_LOADED,this.onFragLoaded,this),e.on(x.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(x.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(x.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(x.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(x.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(x.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(x.FRAG_LOADING,this.onFragLoading,this),e.off(x.FRAG_LOADED,this.onFragLoaded,this),e.off(x.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(x.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(x.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(x.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(x.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Un(this,"textTrack1"),t=new Un(this,"textTrack2"),i=new Un(this,"textTrack3"),s=new Un(this,"textTrack4");this.cea608Parser1=new $u(1,e,t),this.cea608Parser2=new $u(3,i,s)}addCues(e,t,i,s,r){let o=!1;for(let a=r.length;a--;){const l=r[a],h=XE(l[0],l[1],t,i);if(h>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),o=!0,h/(i-t)>.5))return}if(o||r.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,s)}else{const a=this.Cues.newCue(null,t,i,s);this.hls.trigger(x.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:o}=this;i===q.MAIN&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),o.length&&(this.unparsedVttFrags=[],o.forEach(a=>{this.onFragLoaded(x.FRAG_LOADED,a)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(Vu(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:o}=t[e],a=this.getExistingTrack(r,o);if(a)i[e]=a,$s(i[e]),$g(i[e],s);else{const l=this.createTextTrack("captions",r,o);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(x.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:s}=this;Object.keys(s).forEach(r=>{$s(s[r]),delete s[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Wu(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)$s(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===Va);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(Dg(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?lo(o.textTracks):null;if(this.tracks.forEach((l,h)=>{let c;if(a){let u=null;for(let d=0;d<a.length;d++)if(a[d]&&Vu(a[d],l)){u=a[d],a[d]=null;break}u&&(c=u)}if(c)$s(c);else{const u=Qg(l);c=this.createTextTrack(u,l.name,l.lang),c&&(c.mode="disabled")}c&&this.textTracks.push(c)}),a!=null&&a.length){const l=a.filter(h=>h!==null).map(h=>h.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(x.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,o=this.captionsProperties[r];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===q.MAIN){var i,s;const{cea608Parser1:r,cea608Parser2:o,lastSn:a}=this,{cc:l,sn:h}=t.frag,c=(i=(s=t.part)==null?void 0:s.index)!=null?i:-1;r&&o&&(h!==a+1||h===a&&c!==this.lastPartIndex+1||l!==this.lastCc)&&(r.reset(),o.reset()),this.lastCc=l,this.lastSn=h,this.lastPartIndex=c}}onFragLoaded(e,t){const{frag:i,payload:s}=t;if(i.type===q.SUBTITLE)if(s.byteLength){const r=i.decryptdata,o="stats"in t;if(r==null||!r.encrypted||o){const a=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Va?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(x.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;zu(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(x.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{i.logger.log(`Failed to parse IMSC1: ${s}`),i.trigger(x.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;const{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:o}=this,a=r.length-1;if(!r[i.cc]&&a===-1){o.push(e);return}const l=this.hls,h=(t=i.initSegment)!=null&&t.data?At(i.initSegment.data,new Uint8Array(s)).buffer:s;zE(h,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,c=>{this._appendCues(c,i.level),l.trigger(x.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},c=>{const u=c.message==="Missing initPTS for VTT MPEGTS";u?o.push(e):this._fallbackToIMSC1(i,s),l.logger.log(`Failed to parse VTT cue: ${c}`),!(u&&a>i.cc)&&l.trigger(x.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:c})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||zu(t,this.initPTS[e.cc],()=>{i.textCodec=Va,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>zg(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(x.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===q.SUBTITLE&&this.onFragLoaded(x.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:s}=t;if(!(i.type===q.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<s.length;r++){const o=s[r].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(s[r].pts,a[0]),this.cea608Parser2.addData(s[r].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!r||r==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(l=>zl(a[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(l=>zl(a[l],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const o=e[s++],a=127&e[s++],l=127&e[s++];if(a===0&&l===0)continue;if((4&o)!==0){const c=3&o;(c===0||c===1)&&(t[c].push(a),t[c].push(l))}}return t}}function Qg(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function Vu(n,e){return!!n&&n.kind===Qg(e)&&Ul(e,n)}function XE(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function Wu(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const jE=/\s/,qE={newCue(n,e,t,i){const s=[];let r,o,a,l,h;const c=self.VTTCue||self.TextTrackCue;for(let d=0;d<i.rows.length;d++)if(r=i.rows[d],a=!0,l=0,h="",!r.isEmpty()){var u;for(let p=0;p<r.chars.length;p++)jE.test(r.chars[p].uchar)&&a?l++:(h+=r.chars[p].uchar,a=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const f=Kg(h.trim()),g=Yh(e,t,f);n!=null&&(u=n.cues)!=null&&u.getCueById(g)||(o=new c(e,t,f),o.id=g,o.line=d+1,o.align="left",o.position=10+Math.min(80,Math.floor(l*8/32)*10),s.push(o))}return n&&s.length&&(s.sort((d,f)=>d.line==="auto"||f.line==="auto"?0:d.line>8&&f.line>8?f.line-d.line:d.line-f.line),s.forEach(d=>zg(n,d))),s}};function QE(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const ZE=/(\d+)-(\d+)\/(\d+)/;class Yu{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||ib,this.controller=new self.AbortController,this.stats=new Ch}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=JE(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:h}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=l&&K(l)?l:h,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},t.timeout),(Or(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(u=>{var d;this.response=this.loader=u;const f=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=h,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},h-(f-s.loading.start)),!u.ok){const{status:p,statusText:m}=u;throw new sb(m||"fetch, bad network response",p,u)}s.loading.first=f,s.total=tb(u.headers)||s.total;const g=(d=this.callbacks)==null?void 0:d.onProgress;return g&&K(t.highWaterMark)?this.loadProgressively(u,s,e,t.highWaterMark,g):o?u.arrayBuffer():e.responseType==="json"?u.json():u.text()}).then(u=>{var d,f;const g=this.response;if(!g)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const p=u[a];p&&(s.loaded=s.total=p);const m={url:g.url,data:u,code:g.status},_=(d=this.callbacks)==null?void 0:d.onProgress;_&&!K(t.highWaterMark)&&_(s,e,u,g),(f=this.callbacks)==null||f.onSuccess(m,s,e,g)}).catch(u=>{var d;if(self.clearTimeout(this.requestTimeout),s.aborted)return;const f=u&&u.code||0,g=u?u.message:null;(d=this.callbacks)==null||d.onError({code:f,text:g},e,u?u.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const o=new dg,a=e.body.getReader(),l=()=>a.read().then(h=>{if(h.done)return o.dataLength&&r(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const c=h.value,u=c.length;return t.loaded+=u,u<s||o.dataLength?(o.push(c),o.dataLength>=s&&r(t,i,o.flush().buffer,e)):r(t,i,c.buffer,e),l()}).catch(()=>Promise.reject());return l()}}function JE(n,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(Ee({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function eb(n){const e=ZE.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function tb(n){const e=n.get("Content-Range");if(e){const i=eb(e);if(K(i))return i}const t=n.get("Content-Length");if(t)return parseInt(t)}function ib(n,e){return new self.Request(n.url,e)}class sb extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const rb=/^age:\s*[\d.]+\s*$/im;class Zg{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Ch,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:o}=i.loadPolicy;if(s)for(const a in s)e.setRequestHeader(a,s[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&K(r)?r:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const h=t.status,c=t.responseType==="text"?t.responseText:null;if(h>=200&&h<300){const g=c??t.response;if(g!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const p=t.responseType==="arraybuffer"?g.byteLength:g.length;i.loaded=i.total=p,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const m=(o=this.callbacks)==null?void 0:o.onProgress;m&&m(i,e,g,t);const _={url:t.responseURL,data:g,code:h};(a=this.callbacks)==null||a.onSuccess(_,i,e,t);return}}const u=r.loadPolicy.errorRetry,d=i.retry,f={url:e.url,data:void 0,code:h};if(Bo(u,d,!1,f))this.retry(u);else{var l;pe.error(`${h} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:h,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Bo(e,t,!0))this.retry(e);else{var i;pe.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=wh(e,i.retry),i.retry++,pe.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&rb.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const nb={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},ob=ye(ye({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Zg,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:wT,bufferController:_v,capLevelController:Hh,errorController:FT,fpsController:hE,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:tg,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:nb},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},ab()),{},{subtitleStreamController:SE,subtitleTrackController:dE,timelineController:KE,audioStreamController:fv,audioTrackController:gv,emeController:Xs,cmcdController:oE,contentSteeringController:lE,interstitialsController:TE});function ab(){return{cueHandler:qE,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function lb(n,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Hl(n),s=["manifest","level","frag"],r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return s.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,l=e[a]===void 0,h=[];r.forEach(c=>{const u=`${o}Loading${c}`,d=e[u];if(d!==void 0&&l){h.push(u);const f=i[a].default;switch(e[a]={default:f},c){case"TimeOut":f.maxLoadTimeMs=d,f.maxTimeToFirstByteMs=d;break;case"MaxRetry":f.errorRetry.maxNumRetry=d,f.timeoutRetry.maxNumRetry=d;break;case"RetryDelay":f.errorRetry.retryDelayMs=d,f.timeoutRetry.retryDelayMs=d;break;case"MaxRetryTimeout":f.errorRetry.maxRetryDelayMs=d,f.timeoutRetry.maxRetryDelayMs=d;break}}}),h.length&&t.warn(`hls.js config: "${h.join('", "')}" setting(s) are deprecated, use "${a}": ${we(e[a])}`)}),ye(ye({},i),e)}function Hl(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(Hl):Object.keys(n).reduce((e,t)=>(e[t]=Hl(n[t]),e),{}):n}function hb(n,e){const t=n.loader;t!==Yu&&t!==Zg?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):QE()&&(n.loader=Yu,n.progressive=!0,n.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const ho=2,cb=.1,ub=.05,db=100;class fb extends Zf{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(x.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(db),this.mediaSource=t.mediaSource;const i=this.media=t.media;ft(i,"playing",this.onMediaPlaying),ft(i,"waiting",this.onMediaWaiting),ft(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(Et(i,"playing",this.onMediaPlaying),Et(i,"waiting",this.onMediaWaiting),Et(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,s;const r=(i=this.hls)==null?void 0:i.config;if(!r)return;const o=this.media;if(!o)return;const{seeking:a}=o,l=this.seeking&&!a,h=!this.seeking&&a,c=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,r.nudgeOnVideoHole&&!c&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(h||l){l&&this.stallResolved(e);return}if(c){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(x.MEDIA_ENDED,{stalled:!1}));return}if(!ne.getBuffered(o).length){this.nudgeRetry=0;return}const u=ne.bufferInfo(o,e,0),d=u.nextStart||0,f=this.fragmentTracker;if(a&&f&&this.hls){const C=Ku(this.hls.inFlightFragments,e),b=u.len>ho,A=!d||C||d-e>ho&&!f.getPartialFragment(e);if(b||A)return;this.moved=!1}const g=(s=this.hls)==null?void 0:s.latestLevelDetails;if(!this.moved&&this.stalled!==null&&f){if(!(u.len>0)&&!d)return;const b=Math.max(d,u.start||0)-e,L=!!(g!=null&&g.live)?g.targetduration*2:ho,R=f.getPartialFragment(e);if(b>0&&(b<=L||R)){o.paused||this._trySkipBufferHole(R);return}}const p=r.detectStallWithCurrentTimeMs,m=self.performance.now(),_=this.waiting;let T=this.stalled;if(T===null)if(_>0&&m-_<p)T=this.stalled=_;else{this.stalled=m;return}const S=m-T;if(!a&&(S>=p||_)&&this.hls){var v;if(((v=this.mediaSource)==null?void 0:v.readyState)==="ended"&&!(g!=null&&g.live)&&Math.abs(e-((g==null?void 0:g.edge)||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(x.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(u),!this.media||!this.hls)return}const E=ne.bufferInfo(o,e,r.maxBufferHole);this._tryFixBufferStall(E,S,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(x.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const s=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&s&&s.length>1&&e>s.end(0)){const r=ne.bufferedInfo(ne.timeRangesToArray(this.buffered.audio),e,0);if(r.len>1&&t>=r.start){const o=ne.timeRangesToArray(s),a=ne.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const l=ne.bufferedInfo(o,e,0).bufferedIndex,h=o[a].end,c=o[a+1].start;if((l===-1||l>a)&&c-h<1&&e-h<2){const u=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${h} -> ${c} buffered index: ${l}`);this.warn(u.message),this.media.currentTime+=1e-6;const d=this.fragmentTracker.getPartialFragment(e)||void 0,f=ne.bufferInfo(this.media,e,0);this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:u,reason:u.message,frag:d,buffer:f.len,bufferInfo:f})}}}}}_tryFixBufferStall(e,t,i){var s,r;const{fragmentTracker:o,media:a}=this,l=(s=this.hls)==null?void 0:s.config;if(!a||!o||!l)return;const h=(r=this.hls)==null?void 0:r.latestLevelDetails,c=o.getPartialFragment(i);if((c||h!=null&&h.live&&i<h.fragmentStart)&&(this._trySkipBufferHole(c)||!this.media))return;const u=e.buffered,d=this.adjacentTraversal(e,i);(u&&u.length>1&&e.len>l.maxBufferHole||e.nextStart&&(e.nextStart-i<l.maxBufferHole||d))&&(t>l.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,s=e.nextStart;if(i&&s){const r=i.getFragAtPos(t,q.MAIN),o=i.getFragAtPos(s,q.MAIN);if(r&&o)return o.sn-r.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:s,stalled:r}=this;if(!s&&r!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${we(e)})`);this.warn(o.message),t.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:r}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:s}=this,r=(t=this.hls)==null?void 0:t.config;if(!s||!i||!r)return 0;const o=s.currentTime,a=ne.bufferInfo(s,o,0),l=o<a.start?a.start:a.nextStart;if(l&&this.hls){const c=a.len<=r.maxBufferHole,u=a.len>0&&a.len<1&&s.readyState<3,d=l-o;if(d>0&&(c||u)){if(d>r.maxBufferHole){let g=!1;if(o===0){const p=i.getAppendedFrag(0,q.MAIN);p&&l<p.end&&(g=!0)}if(!g){const p=e||i.getAppendedFrag(o,q.MAIN);if(p){var h;if(!((h=this.hls.loadLevelObj)!=null&&h.details)||Ku(this.hls.inFlightFragments,l))return 0;let _=!1,T=p.end;for(;T<l;){const S=i.getPartialFragment(T);if(S)T+=S.duration;else{_=!0;break}}if(_)return 0}}}const f=Math.max(l+ub,o+cb);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${f}`),this.moved=!0,s.currentTime=f,!(e!=null&&e.gap)){const g=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${f}`);this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:g,reason:g.message,frag:e||void 0,buffer:a.len,bufferInfo:a})}return f}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:s}=this,r=t==null?void 0:t.config;if(!i||!r)return 0;const o=i.currentTime;if(this.nudgeRetry++,s<r.nudgeMaxRetry){const a=o+(s+1)*r.nudgeOffset,l=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(l.message),i.currentTime=a,t.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_NUDGE_ON_STALL,error:l,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${r.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Ku(n,e){const t=Xu(n.main);if(t&&t.start<=e)return t;const i=Xu(n.audio);return i&&i.start<=e?i:null}function Xu(n){if(!n)return null;switch(n.state){case N.IDLE:case N.STOPPED:case N.ENDED:case N.ERROR:return null}return n.frag}const gb=.25;function Vl(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function ju(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,we(s?ye({type:s},i):i))}return r}const Nn=(()=>{const n=Vl();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function pb(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class mb{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(x.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(x.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(x.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(x.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(x.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&$s(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return $g(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=Vl();if(o)for(let a=0;a<r.length;a++){const l=r[a].type;if(l===dt.emsg&&!i||!s)continue;const h=yg(r[a].data);if(h){const c=r[a].pts;let u=c+r[a].duration;u>Nn&&(u=Nn),u-c<=0&&(u=c+gb);for(let f=0;f<h.length;f++){const g=h[f];if(!Tg(g)){this.updateId3CueEnds(c,l);const p=ju(o,c,u,g,l);p&&this.id3Track.addCue(p)}}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const o=s[r];o.type===t&&o.startTime<e&&o.endTime===Nn&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:l}}=o;if(r&&(a||l)){let h;s==="audio"?h=c=>c.type===dt.audioId3&&l:s==="video"?h=c=>c.type===dt.emsg&&a:h=c=>c.type===dt.audioId3&&l||c.type===dt.emsg&&a,zl(r,t,i,h)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:i}=this,{dateRanges:s}=e,r=Object.keys(s);let o=this.dateRangeCuesAppended;if(i&&t){var a;if((a=i.cues)!=null&&a.length){const c=Object.keys(o).filter(u=>!r.includes(u));for(let u=c.length;u--;){const d=c[u],f=o[d].cues;delete o[d],Object.keys(f).forEach(g=>{try{const p=f[g];p.removeEventListener("enter",this.onEventCueEnter),i.removeCue(p)}catch{}})}}else o=this.dateRangeCuesAppended={}}const l=e.fragments[e.fragments.length-1];if(r.length===0||!K(l==null?void 0:l.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const h=Vl();for(let c=0;c<r.length;c++){const u=r[c],d=s[u],f=d.startTime,g=o[u],p=(g==null?void 0:g.cues)||{};let m=(g==null?void 0:g.durationKnown)||!1,_=Nn;const{duration:T,endDate:S}=d;if(S&&T!==null)_=f+T,m=!0;else if(d.endOnNext&&!m){const E=r.reduce((C,b)=>{if(b!==d.id){const A=s[b];if(A.class===d.class&&A.startDate>d.startDate&&(!C||d.startDate<C.startDate))return A}return C},null);E&&(_=E.startTime,m=!0)}const v=Object.keys(d.attr);for(let E=0;E<v.length;E++){const C=v[E];if(!KT(C))continue;const b=p[C];if(b)m&&!g.durationKnown?b.endTime=_:Math.abs(b.startTime-f)>.01&&(b.startTime=f,b.endTime=_);else if(h){let A=d.attr[C];XT(C)&&(A=pb(A));const R=ju(h,f,_,{key:C,data:A},dt.dateRange);R&&(R.id=u,this.id3Track.addCue(R),p[C]=R,this.hls.config.interstitialsController&&(C==="X-ASSET-LIST"||C==="X-ASSET-URL")&&R.addEventListener("enter",this.onEventCueEnter))}}o[u]={cues:p,dateRange:d,durationKnown:m}}}}class _b{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const s=this.computeLatency();if(s===null)return;this._latency=s;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:o}=this.config;if(!r||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const l=s-a,h=Math.min(this.maxLatency,a+i.targetduration);if(l<h&&l>.05&&this.forwardBufferLength>1){const u=Math.min(2,Math.max(1,o)),d=Math.round(2/(1+Math.exp(-.75*l-this.edgeStalled))*20)/20,f=Math.min(u,Math.max(1,d));this.changeMediaPlaybackRate(t,f)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,l=this.hls.userConfig;let h=a&&i||t;(this._targetLatencyUpdated||l.liveSyncDuration||l.liveSyncDurationCount||h===0)&&(h=r!==void 0?r:o*s);const c=s;return h+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,c)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,o=s-i.totalduration,a=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,r),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(x.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(x.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(x.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(x.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===D.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,s;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(s=this.targetLatency)==null?void 0:s.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class xb extends Gh{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(x.LEVEL_LOADED,this.onLevelLoaded,this),e.on(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(x.FRAG_BUFFERED,this.onFragBuffered,this),e.on(x.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(x.LEVEL_LOADED,this.onLevelLoaded,this),e.off(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(x.FRAG_BUFFERED,this.onFragBuffered,this),e.off(x.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,s=[],r={},o={};let a=!1,l=!1,h=!1;t.levels.forEach(c=>{const u=c.attrs;let{audioCodec:d,videoCodec:f}=c;d&&(c.audioCodec=d=Mo(d,i)||void 0),f&&(f=c.videoCodec=pT(f));const{width:g,height:p,unknownCodecs:m}=c;let _=m?m.length:0;if(m)for(let R=_;R--;){const M=m[R];this.isAudioSupported(M)?(c.audioCodec=d=d?`${d},${M}`:M,_--,Js.audio[d.substring(0,4)]=2):this.isVideoSupported(M)&&(c.videoCodec=f=f?`${f},${M}`:M,_--,Js.video[f.substring(0,4)]=2)}if(a||(a=!!(g&&p)),l||(l=!!f),h||(h=!!d),_||d&&!this.isAudioSupported(d)||f&&!this.isVideoSupported(f)){this.log(`Some or all CODECS not supported "${u.CODECS}"`);return}const{CODECS:T,"FRAME-RATE":S,"HDCP-LEVEL":v,"PATHWAY-ID":E,RESOLUTION:C,"VIDEO-RANGE":b}=u,L=`${`${E||"."}-`}${c.bitrate}-${C}-${S}-${T}-${b}-${v}`;if(r[L])if(r[L].uri!==c.url&&!c.attrs["PATHWAY-ID"]){const R=o[L]+=1;c.attrs["PATHWAY-ID"]=new Array(R+1).join(".");const M=this.createLevel(c);r[L]=M,s.push(M)}else r[L].addGroupId("audio",u.AUDIO),r[L].addGroupId("text",u.SUBTITLES);else{const R=this.createLevel(c);r[L]=R,o[L]=1,s.push(R)}}),this.filterAndSortMediaOptions(s,t,a,l,h)}createLevel(e){const t=new Pr(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const s=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(s.message),t.supportedResult=Kf(s,[])}return t}isAudioSupported(e){return Il(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Il(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,s,r){let o=[],a=[],l=e;if((i||s)&&r&&(l=l.filter(({videoCodec:m,videoRange:_,width:T,height:S})=>(!!m||!!(T&&S))&&TT(_))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let m="no level with compatible codecs found in manifest",_=m;t.levels.length&&(_=`one or more CODECS in variant not supported: ${we(t.levels.map(S=>S.attrs.CODECS).filter((S,v,E)=>E.indexOf(S)===v))}`,this.warn(_),m+=` (${_})`);const T=new Error(m);this.hls.trigger(x.ERROR,{type:Z.MEDIA_ERROR,details:D.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:T,reason:_})}});return}t.audioTracks&&(o=t.audioTracks.filter(m=>!m.audioCodec||this.isAudioSupported(m.audioCodec)),qu(o)),t.subtitles&&(a=t.subtitles,qu(a));const h=l.slice(0);l.sort((m,_)=>{if(m.attrs["HDCP-LEVEL"]!==_.attrs["HDCP-LEVEL"])return(m.attrs["HDCP-LEVEL"]||"")>(_.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&m.height!==_.height)return m.height-_.height;if(m.frameRate!==_.frameRate)return m.frameRate-_.frameRate;if(m.videoRange!==_.videoRange)return Fo.indexOf(m.videoRange)-Fo.indexOf(_.videoRange);if(m.videoCodec!==_.videoCodec){const T=Hc(m.videoCodec),S=Hc(_.videoCodec);if(T!==S)return S-T}if(m.uri===_.uri&&m.codecSet!==_.codecSet){const T=Do(m.codecSet),S=Do(_.codecSet);if(T!==S)return S-T}return m.averageBitrate!==_.averageBitrate?m.averageBitrate-_.averageBitrate:0});let c=h[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==h.length)){for(let m=0;m<h.length;m++)if(h[m].pathwayId===l[0].pathwayId){c=h[m];break}}this._levels=l;for(let m=0;m<l.length;m++)if(l[m]===c){var u;this._firstLevel=m;const _=c.bitrate,T=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${_}`),((u=this.hls.userConfig)==null?void 0:u.abrEwmaDefaultEstimate)===void 0){const S=Math.min(_,this.hls.config.abrEwmaDefaultEstimateMax);S>T&&T===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=S)}break}const d=r&&!s,f=this.hls.config,g=!!(f.audioStreamController&&f.audioTrackController),p={levels:l,audioTracks:o,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:g&&!d&&o.some(m=>!!m.url)};this.hls.trigger(x.MANIFEST_PARSED,p)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const c=new Error("invalid level idx"),u=e<0;if(this.hls.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.LEVEL_SWITCH_ERROR,level:e,fatal:u,error:c,reason:c.message}),u)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&s&&r===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${r?" with Pathway "+r:""}`);const l={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(x.LEVEL_SWITCHING,l);const h=o.details;if(!h||h.live){const c=this.switchParams(o.uri,s==null?void 0:s.details,h);this.loadPlaylist(c)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(s=>t.indexOf(s)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===fe.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===q.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${s}`),(a=t.deliveryDirectives)!=null&&a.skip&&(r.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let l=o.details;l===t.details&&l.advanced&&(l=void 0),this.playlistLoaded(s,t,l)}else(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),s=this.currentLevelIndex,r=e.attrs["PATHWAY-ID"],o=e.details,a=o==null?void 0:o.age;this.log(`Loading level index ${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${r?" Pathway "+r:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(x.LEVEL_LOADING,{url:i,level:s,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((r,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(r),r===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,r.details&&r.details.fragments.forEach(a=>a.level=-1)),!1));hg(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const s=i.length-1;this._firstLevel=Math.min(this._firstLevel,s),this._startLevel&&(this._startLevel=Math.min(this._startLevel,s)),this.hls.trigger(x.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(x.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function qu(n){const e={};n.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function Jg(){return self.SourceBuffer||self.WebKitSourceBuffer}function ep(){if(!Hi())return!1;const e=Jg();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function yb(){if(!ep())return!1;const n=Hi();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(Ir(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(Ir(e,"audio"))))}function Tb(){var n;const e=Jg();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}const Sb=100;class vb extends Fh{constructor(e,t,i){super(e,t,i,"stream-controller",q.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const s=this.media,r=s?s.currentTime:null;if(r===null||!K(r)||(this.log(`Media seeked to ${r.toFixed(3)}`),!this.getBufferedFrag(r)))return;const o=this.getFwdBufferInfoAtPos(s,r,q.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${r} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(x.MANIFEST_PARSED,this.onManifestParsed,this),e.on(x.LEVEL_LOADING,this.onLevelLoading,this),e.on(x.LEVEL_LOADED,this.onLevelLoaded,this),e.on(x.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(x.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(x.BUFFER_CREATED,this.onBufferCreated,this),e.on(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(x.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(x.MANIFEST_PARSED,this.onManifestParsed,this),e.off(x.LEVEL_LOADED,this.onLevelLoaded,this),e.off(x.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(x.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(x.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(x.BUFFER_CREATED,this.onBufferCreated,this),e.off(x.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(x.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(x.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:s}=this;if(this.stopLoad(),this.setInterval(Sb),this.level=-1,!this.startFragRequested){let r=s.startLevel;r===-1&&(s.config.testBandwidth&&this.levels.length>1?(r=0,this.bitrateTest=!0):r=s.firstAutoLevel),s.nextLoadLevel=r,this.level=s.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=N.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=N.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case N.WAITING_LEVEL:{const{levels:t,level:i}=this,s=t==null?void 0:t[i],r=s==null?void 0:s.details;if(r&&(!r.live||this.levelLastLoaded===s&&!this.waitForLive(s))){if(this.waitForCdnTuneIn(r))break;this.state=N.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=N.IDLE;break}break}case N.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:s,level:r}=this,o=s==null?void 0:s[r];this.resetStartWhenNotLoaded(o||null),this.state=N.IDLE}}break}this.state===N.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this;if(t===null||!s&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const r=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[r]))return;const o=i[r],a=this.getMainFwdBufferInfo();if(a===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(a,l)){const p={};this.altAudio===2&&(p.type="video"),this.hls.trigger(x.BUFFER_EOS,p),this.state=N.ENDED;return}if(!this.buffering)return;e.loadLevel!==r&&e.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;const h=o.details;if(!h||this.state===N.WAITING_LEVEL||this.waitForLive(o)){this.level=r,this.state=N.WAITING_LEVEL,this.startFragRequested=!1;return}const c=a.len,u=this.getMaxBufferLength(o.maxBitrate);if(c>=u)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:a.end;let f=this.getNextFragment(d,h);if(this.couldBacktrack&&!this.fragPrevious&&f&&Ve(f)&&this.fragmentTracker.getState(f)!==$e.OK){var g;const m=((g=this.backtrackFragment)!=null?g:f).sn-h.startSN,_=h.fragments[m-1];_&&f.cc===_.cc&&(f=_,this.fragmentTracker.removeFragment(_))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,d)){if(!f.gap){const m=this.audioOnly&&!this.altAudio?Re.AUDIO:Re.VIDEO,_=(m===Re.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;_&&this.afterBufferFlushed(_,m,q.MAIN)}f=this.getNextFragmentLoopLoading(f,h,a,q.MAIN,u)}f&&(f.initSegment&&!f.initSegment.data&&!this.bitrateTest&&(f=f.initSegment),this.loadFragment(f,o,d))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);s===$e.NOT_LOADED||s===$e.PARTIAL?Ve(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,q.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<r.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,l=e[a],h=this.fragLastKbps;h&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*h)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const l=a.maxStartPTS?a.maxStartPTS:a.start,h=a.duration,c=Math.max(o.end,l+Math.min(Math.max(h-this.config.maxFragLookUpTolerance,h*(this.couldBacktrack?.5:.125)),h*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(c,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case N.KEY_LOADING:case N.FRAG_LOADING:case N.FRAG_LOADING_WAITING_RETRY:case N.PARSING:case N.PARSED:this.state=N.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;ft(i,"playing",this.onMediaPlaying),ft(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(Et(i,"playing",this.onMediaPlaying),Et(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(x.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,s=!1;t.levels.forEach(r=>{const o=r.audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,s=s||o.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!Tb(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==N.IDLE)return;const s=t.levelInfo;(!s.details||s.details.live&&(this.levelLastLoaded!==s||s.details.expired)||this.waitForCdnTuneIn(s.details))&&(this.state=N.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s,startFragRequested:r}=this,o=t.level,a=t.details,l=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${l}`);const h=t.levelInfo,c=this.fragCurrent;c&&(this.state===N.FRAG_LOADING||this.state===N.FRAG_LOADING_WAITING_RETRY)&&c.level!==t.level&&c.loader&&this.abortCurrentFrag();let u=0;if(a.live||(i=h.details)!=null&&i.live){var d;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;u=this.alignPlaylists(a,h.details,(d=this.levelLastLoaded)==null?void 0:d.details)}if(h.details=a,this.levelLastLoaded=h,r||this.setStartPosition(a,u),this.hls.trigger(x.LEVEL_UPDATED,{details:a,level:o}),this.state===N.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=N.IDLE}r&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,l=r>=o-t.maxFragLookUpTolerance&&r<=a;if(s!==null&&i.duration>s&&(r<s||!l)){const c=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!l&&i.readyState<4||r<a-c)&&(this._hasEnoughToStart||(this.nextLoadPosition=s),i.readyState))if(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${s.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var h;const u=ne.bufferInfo(i,s,0);if(!(u!=null&&(h=u.buffered)!=null&&h.length)){i.currentTime=s;return}if(u.start<=r){i.currentTime=s;return}const{nextStart:f}=ne.bufferedInfo(u.buffered,r,0);f&&(i.currentTime=f)}else i.currentTime=s}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:s,payload:r}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const l=a.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const h=a.videoCodec,c=l.PTSKnown||!l.live,u=(t=i.initSegment)==null?void 0:t.data,d=this._getAudioCodec(a),f=this.transmuxer=this.transmuxer||new Pg(this.hls,q.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),g=s?s.index:-1,p=g!==-1,m=new Ph(i.level,i.sn,i.stats.chunkCount,r.byteLength,g,p),_=this.initPTS[i.cc];f.push(r,u,d,h,i,s,l.totalduration,c,m,_)}onAudioTrackSwitching(e,t){const i=this.hls,s=this.altAudio===2;if(ko(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(s){this.fragmentTracker.removeAllFragments(),i.once(x.BUFFER_FLUSHED,()=>{var o;(o=this.hls)==null||o.trigger(x.AUDIO_TRACK_SWITCHED,t)}),i.trigger(x.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(x.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=ko(t.url,this.hls);if(i){const s=this.videoBuffer;s&&this.mediaBuffer!==s&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=s)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,o=!1;for(const a in i){const l=i[a];if(l.id==="main"){if(r=a,s=l,a==="video"){const h=i[a];h&&(this.videoBuffer=h.buffer)}}else o=!0}o&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t,r=i.type===q.MAIN;if(r){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===N.PARSED&&(this.state=N.IDLE);return}const a=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),Ve(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}const o=this.media;o&&(!this._hasEnoughToStart&&ne.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),r&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=N.ERROR;return}switch(t.details){case D.FRAG_GAP:case D.FRAG_PARSING_ERROR:case D.FRAG_DECRYPT_ERROR:case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(q.MAIN,t);break;case D.LEVEL_LOAD_ERROR:case D.LEVEL_LOAD_TIMEOUT:case D.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===N.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===fe.LEVEL&&(this.state=N.IDLE);break;case D.BUFFER_ADD_CODEC_ERROR:case D.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.resetLoadingState();break;case D.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case D.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=N.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==Re.AUDIO||!this.altAudio){const i=(t===Re.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,q.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=this.timelineOffset;s&&i&&(i+=s);const r=this.getLevelDetails(),o=ne.getBuffered(e),a=o.length?o.start(0):0,l=a-i,h=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||l>0&&(l<h||this.loadingParts&&l<2*((r==null?void 0:r.partTarget)||0)))&&(this.log(`adjusting start position by ${l} to match buffer start`),i+=l,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this,r=i==null?void 0:i.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=N.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=r.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),s.trigger(x.FRAG_LOADED,i),r.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i=this.playlistType,{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:h,level:c}=a,{video:u,text:d,id3:f,initSegment:g}=r,{details:p}=c,m=this.altAudio?void 0:r.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=N.PARSING,g){if(g!=null&&g.tracks){const S=l.initSegment||l;this._bufferInitSegment(c,g.tracks,S,o),s.trigger(x.FRAG_PARSING_INIT_SEGMENT,{frag:S,id:i,tracks:g.tracks})}const _=g.initPTS,T=g.timescale;K(_)&&(this.initPTS[l.cc]={baseTime:_,timescale:T},s.trigger(x.INIT_PTS_FOUND,{frag:l,id:i,initPTS:_,timescale:T}))}if(u&&p){m&&u.type==="audiovideo"&&this.logMuxedErr(l);const _=p.fragments[l.sn-1-p.startSN],T=l.sn===p.startSN,S=!_||l.cc>_.cc;if(r.independent!==!1){const{startPTS:v,endPTS:E,startDTS:C,endDTS:b}=u;if(h)h.elementaryStreams[u.type]={startPTS:v,endPTS:E,startDTS:C,endDTS:b};else if(u.firstKeyFrame&&u.independent&&o.id===1&&!S&&(this.couldBacktrack=!0),u.dropped&&u.independent){const A=this.getMainFwdBufferInfo(),L=(A?A.end:this.getLoadPosition())+this.config.maxBufferHole,R=u.firstKeyFramePTS?u.firstKeyFramePTS:v;if(!T&&L<R-this.config.maxBufferHole&&!S){this.backtrack(l);return}else S&&(l.gap=!0);l.setElementaryStreamInfo(u.type,l.start,E,l.start,b,!0)}else T&&v-(p.appliedTimelineOffset||0)>ho&&(l.gap=!0);l.setElementaryStreamInfo(u.type,v,E,C,b),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(u,l,h,o,T||S)}else if(T||S)l.gap=!0;else{this.backtrack(l);return}}if(m){const{startPTS:_,endPTS:T,startDTS:S,endDTS:v}=m;h&&(h.elementaryStreams[Re.AUDIO]={startPTS:_,endPTS:T,startDTS:S,endDTS:v}),l.setElementaryStreamInfo(Re.AUDIO,_,T,S,v),this.bufferFragmentData(m,l,h,o)}if(p&&f!=null&&(t=f.samples)!=null&&t.length){const _={id:i,frag:l,details:p,samples:f.samples};s.trigger(x.FRAG_PARSING_METADATA,_)}if(p&&d){const _={id:i,frag:l,details:p,samples:d.samples};s.trigger(x.FRAG_PARSING_USERDATA,_)}}logMuxedErr(e){this.warn(`${Ve(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,s){if(this.state!==N.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:r,video:o,audiovideo:a}=t;if(r){let h=io(r.codec,e.audioCodec);h==="mp4a"&&(h="mp4a.40.5");const c=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){h&&(h.indexOf("mp4a.40.5")!==-1?h="mp4a.40.2":h="mp4a.40.5");const u=r.metadata;u&&"channelCount"in u&&(u.channelCount||1)!==1&&c.indexOf("firefox")===-1&&(h="mp4a.40.5")}h&&h.indexOf("mp4a.40.5")!==-1&&c.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(h="mp4a.40.2",this.log(`Android: force audio codec to ${h}`)),e.audioCodec&&e.audioCodec!==h&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${h}"`),r.levelCodec=h,r.id=q.MAIN,this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${h||""}/${e.audioCodec||""}/${r.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=q.MAIN;const h=o.codec;if((h==null?void 0:h.length)===4)switch(h){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${h}]${o.codec!==h?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const l=Object.keys(t);if(l.length){if(this.hls.trigger(x.BUFFER_CODECS,t),!this.hls)return;l.forEach(h=>{const u=t[h].initSegment;u!=null&&u.byteLength&&this.hls.trigger(x.BUFFER_APPENDING,{type:h,data:u,frag:i,part:null,chunkMeta:s,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,q.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e==null?void 0:e[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=N.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(ne.isBuffered(e,i)?t=this.getAppendedFrag(i):ne.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(x.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(x.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return K(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(K(t)){const i=this.getLevelDetails(),s=this.currentFrag||(i?fs(null,i.fragments,t):null);if(s){const r=s.programDateTime;if(r!==null){const o=r+(t-s.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class Eb{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=D.KEY_LOAD_ERROR,i,s,r){return new Jt({type:Z.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length){const{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){const o=t[r];if(s<=o.cc&&(i==="initSegment"||o.sn==="initSegment"||i<o.sn))return this.emeController.selectKeySystemFormat(o).then(a=>{if(o.setKeyFormat(a),this.emeController&&this.config.requireKeySystemAccessOnStart){const l=ro(a);if(l)return this.emeController.getKeySystemAccess([l])}})}}else if(this.config.requireKeySystemAccessOnStart){const i=pr(this.config);if(i.length)return this.emeController.getKeySystemAccess(i)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const h=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,D.KEY_LOAD_ERROR,h))}const o=r.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,D.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));let a=this.keyUriToKeyInfo[o];if((i=a)!=null&&i.decryptdata.key)return r.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});if((s=a)!=null&&s.keyLoadPromise){var l;switch((l=a.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(h=>(r.key=h.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}}switch(a=this.keyUriToKeyInfo[o]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,D.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((o,a)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},h=i.keyLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,f,g,p)=>{const{frag:m,keyInfo:_,url:T}=g;if(!m.decryptdata||_!==this.keyUriToKeyInfo[T])return a(this.createKeyLoadError(m,D.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),p));_.decryptdata.key=m.decryptdata.key=new Uint8Array(d.data),m.keyLoader=null,_.loader=null,o({frag:m,keyInfo:_})},onError:(d,f,g,p)=>{this.resetLoader(f),a(this.createKeyLoadError(t,D.KEY_LOAD_ERROR,new Error(`HTTP Error ${d.code} loading key ${d.text}`),g,ye({url:l.url,data:void 0},d)))},onTimeout:(d,f,g)=>{this.resetLoader(f),a(this.createKeyLoadError(t,D.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),g))},onAbort:(d,f,g)=>{this.resetLoader(f),a(this.createKeyLoadError(t,D.INTERNAL_ABORTED,new Error("key loading aborted"),g))}};r.load(l,c,u)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function Qu(n){const{type:e}=n;switch(e){case fe.AUDIO_TRACK:return q.AUDIO;case fe.SUBTITLE_TRACK:return q.SUBTITLE;default:return q.MAIN}}function Xa(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class bb{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(x.MANIFEST_LOADING,this.onManifestLoading,this),e.on(x.LEVEL_LOADING,this.onLevelLoading,this),e.on(x.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(x.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(x.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(x.MANIFEST_LOADING,this.onManifestLoading,this),e.off(x.LEVEL_LOADING,this.onLevelLoading,this),e.off(x.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(x.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(x.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,o=new r(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:fe.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:s,pathwayId:r,url:o,deliveryDirectives:a,levelInfo:l}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:fe.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:l})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:fe.AUDIO_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:fe.SUBTITLE_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[fe.LEVEL];if(i){const s=i.context;s&&!t.levels.some(r=>r===s.levelOrTrack)&&(i.abort(),delete this.loaders[fe.LEVEL])}}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const h=this.hls.logger,c=s.context;if(c&&c.levelOrTrack===e.levelOrTrack&&(c.url===e.url||c.deliveryDirectives&&!e.deliveryDirectives)){c.url===e.url?h.log(`[playlist-loader]: ignore ${e.url} ongoing request`):h.log(`[playlist-loader]: ignore ${e.url} in favor of ${c.url}`);return}h.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===fe.MANIFEST?r=i.manifestLoadPolicy.default:r=Ee({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),K((t=e.deliveryDirectives)==null?void 0:t.part)){let h;if(e.type===fe.LEVEL&&e.level!==null?h=this.hls.levels[e.level].details:e.type===fe.AUDIO_TRACK&&e.id!==null?h=this.hls.audioTracks[e.id].details:e.type===fe.SUBTITLE_TRACK&&e.id!==null&&(h=this.hls.subtitleTracks[e.id].details),h){const c=h.partTarget,u=h.targetduration;if(c&&u){const d=Math.max(c*3,u*.8)*1e3;r=Ee({},r,{maxTimeToFirstByteMs:Math.min(d,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(d,r.maxTimeToFirstByteMs)})}}}const o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},l={onSuccess:(h,c,u,d)=>{const f=this.getInternalLoader(u);this.resetInternalLoader(u.type);const g=h.data;if(g.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(h,u,new Error("no EXTM3U delimiter"),d||null,c);return}c.parsing.start=performance.now(),Wt.isMediaPlaylist(g)||u.type!==fe.MANIFEST?this.handleTrackOrLevelPlaylist(h,c,u,d||null,f):this.handleMasterPlaylist(h,c,u,d)},onError:(h,c,u,d)=>{this.handleNetworkError(c,u,!1,h,d)},onTimeout:(h,c,u)=>{this.handleNetworkError(c,u,!0,void 0,h)}};s.load(e,a,l)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,s){const r=this.hls,o=e.data,a=Xa(e,i),l=Wt.parseMasterPlaylist(o,a);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,s,t);return}const{contentSteering:h,levels:c,sessionData:u,sessionKeys:d,startTimeOffset:f,variableList:g}=l;this.variableList=g;const{AUDIO:p=[],SUBTITLES:m,"CLOSED-CAPTIONS":_}=Wt.parseMasterPlaylistMedia(o,a,l);p.length&&!p.some(S=>!S.url)&&c[0].audioCodec&&!c[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Pe({}),bitrate:0,url:""})),r.trigger(x.MANIFEST_LOADED,{levels:c,audioTracks:p,subtitles:m,captions:_,contentSteering:h,url:a,stats:t,networkDetails:s,sessionData:u,sessionKeys:d,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(e,t,i,s,r){const o=this.hls,{id:a,level:l,type:h}=i,c=Xa(e,i),u=K(l)?l:K(a)?a:0,d=Qu(i),f=Wt.parseLevelPlaylist(e.data,c,u,d,0,this.variableList);if(h===fe.MANIFEST){const g={attrs:new Pe({}),bitrate:0,details:f,name:"",url:c};f.requestScheduled=t.loading.start+og(f,0),o.trigger(x.MANIFEST_LOADED,{levels:[g],audioTracks:[],url:c,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=f,this.handlePlaylistLoaded(f,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(x.ERROR,{type:Z.NETWORK_ERROR,details:D.MANIFEST_PARSING_ERROR,fatal:t.type===fe.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let o=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===fe.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===fe.AUDIO_TRACK||e.type===fe.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let l=D.UNKNOWN,h=!1;const c=this.getInternalLoader(e);switch(e.type){case fe.MANIFEST:l=i?D.MANIFEST_LOAD_TIMEOUT:D.MANIFEST_LOAD_ERROR,h=!0;break;case fe.LEVEL:l=i?D.LEVEL_LOAD_TIMEOUT:D.LEVEL_LOAD_ERROR,h=!1;break;case fe.AUDIO_TRACK:l=i?D.AUDIO_TRACK_LOAD_TIMEOUT:D.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case fe.SUBTITLE_TRACK:l=i?D.SUBTITLE_TRACK_LOAD_TIMEOUT:D.SUBTITLE_LOAD_ERROR,h=!1;break}c&&this.resetInternalLoader(e.type);const u={type:Z.NETWORK_ERROR,details:l,fatal:h,url:e.url,loader:c,context:e,error:a,networkDetails:t,stats:r};if(s){const d=(t==null?void 0:t.url)||e.url;u.response=ye({url:d,data:void 0},s)}this.hls.trigger(x.ERROR,u)}handlePlaylistLoaded(e,t,i,s,r,o){const a=this.hls,{type:l,level:h,id:c,groupId:u,deliveryDirectives:d}=s,f=Xa(t,s),g=Qu(s),p=typeof s.level=="number"&&g===q.MAIN?h:void 0;if(!e.fragments.length){const _=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(x.ERROR,{type:Z.NETWORK_ERROR,details:D.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:_,reason:_.message,response:t,context:s,level:p,parent:g,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const m=e.playlistParsingError;if(m){if(this.hls.logger.warn(m),!a.config.ignorePlaylistParsingErrors){a.trigger(x.ERROR,{type:Z.NETWORK_ERROR,details:D.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:m,reason:m.message,response:t,context:s,level:p,parent:g,networkDetails:r,stats:i});return}e.playlistParsingError=null}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case fe.MANIFEST:case fe.LEVEL:a.trigger(x.LEVEL_LOADED,{details:e,levelInfo:s.levelOrTrack||a.levels[0],level:p||0,id:c||0,stats:i,networkDetails:r,deliveryDirectives:d,withoutMultiVariant:l===fe.MANIFEST});break;case fe.AUDIO_TRACK:a.trigger(x.AUDIO_TRACK_LOADED,{details:e,track:s.levelOrTrack,id:c||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break;case fe.SUBTITLE_TRACK:a.trigger(x.SUBTITLE_TRACK_LOADED,{details:e,track:s.levelOrTrack,id:c||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break}}}class Ht{static get version(){return Fr}static isMSESupported(){return ep()}static isSupported(){return yb()}static getMediaSource(){return Hi()}static get Events(){return x}static get MetadataSchema(){return dt}static get ErrorTypes(){return Z}static get ErrorDetails(){return D}static get DefaultConfig(){return Ht.defaultConfig?Ht.defaultConfig:ob}static set DefaultConfig(e){Ht.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new kh,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=Wy(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=lb(Ht.DefaultConfig,e,t);this.userConfig=e,i.progressive&&hb(i,t);const{abrController:s,bufferController:r,capLevelController:o,errorController:a,fpsController:l}=i,h=new a(this),c=this.abrController=new s(this),u=new kT(this),d=i.interstitialsController,f=d?this.interstitialsController=new d(this,Ht):null,g=this.bufferController=new r(this,u),p=this.capLevelController=new o(this),m=new l(this),_=new bb(this),T=i.contentSteeringController,S=T?new T(this):null,v=this.levelController=new xb(this,S),E=new mb(this),C=new Eb(this.config),b=this.streamController=new vb(this,u,C),A=this.gapController=new fb(this,u);p.setStreamController(b),m.setStreamController(b);const L=[_,v,b];f&&L.splice(1,0,f),S&&L.splice(1,0,S),this.networkControllers=L;const R=[c,g,A,p,m,E,u];this.audioTrackController=this.createController(i.audioTrackController,L);const M=i.audioStreamController;M&&L.push(this.audioStreamController=new M(this,u,C)),this.subtitleTrackController=this.createController(i.subtitleTrackController,L);const F=i.subtitleStreamController;F&&L.push(this.subtititleStreamController=new F(this,u,C)),this.createController(i.timelineController,R),C.emeController=this.emeController=this.createController(i.emeController,R),this.cmcdController=this.createController(i.cmcdController,R),this.latencyController=this.createController(_b,R),this.coreComponents=R,L.push(h);const z=h.onErrorOut;typeof z=="function"&&this.on(x.ERROR,z,h),this.on(x.MANIFEST_LOADED,_.onManifestLoaded,_)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=e===x.ERROR;this.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,fatal:s,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(x.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const r=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(x.ERROR,{type:Z.OTHER_ERROR,details:D.ATTACH_MEDIA_ERROR,fatal:!0,error:r});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,s=t?e:{media:i};this._media=i,this.trigger(x.MEDIA_ATTACHING,s)}detachMedia(){this.logger.log("detachMedia"),this.trigger(x.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(x.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,s=this._url=Rh.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(x.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[q.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[q.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[q.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e==null?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=fE()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){yT(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e!=null&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const o=e[r].attrs["HDCP-LEVEL"];if(o&&o<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=jf(t);return Xf(e,i,navigator.mediaCapabilities)}}Ht.defaultConfig=void 0;const Wo=class Wo{constructor(){y(this,"videoPlayer");y(this,"hls");y(this,"initialized");y(this,"opened");y(this,"appInstance");this.videoPlayer=bx,this.hls=null,this.initialized=!1,this.appInstance=null,this.opened=!1}setAppInstance(e){if(this.appInstance=e,e===null){bi.appInstance=void 0;return}bi.appInstance=e;const t=e;t.fire===void 0&&t.$emit!==void 0&&(t.fire=(i,...s)=>{t.$emit(i,...s)}),this.initialized&&this.videoPlayer.consumer(t)}getAppInstance(){return this.appInstance}clearAppInstance(){this.appInstance=null,bi.appInstance=void 0}logVideoElement(){const e=document.querySelector("video");console.debug(e===null?"Video element not found in DOM":"Video element present in DOM")}initialize(e,t){if(console.debug(`VideoPlayerState.initialize: width=${e} height=${t}`),this.appInstance===null){console.warn("VideoPlayerState.initialize skipped: no app instance provided");return}this.initialized||(d_({},{width:e,height:t,textureMode:!1}),bi.log=Te,bi.settings=It,bi.ads=Lx,bi.lightning=Ye,this.appInstance!==null?(bi.appInstance=this.appInstance,this.videoPlayer.consumer(this.appInstance)):console.warn("VideoPlayerState.initialize called without an app instance"),this.videoPlayer.hide(),this.videoPlayer.loader((s,r)=>new Promise(o=>{if(!Ht.isSupported()){console.error("hls.js is not supported in this browser"),o();return}this.hls=new Ht,this.hls.on(Ht.Events.MEDIA_ATTACHED,()=>{var a;(a=this.hls)==null||a.loadSource(s),o()}),this.hls.attachMedia(r)})),this.videoPlayer.unloader(s=>new Promise(r=>{this.hls!==null&&(this.hls.destroy(),this.hls=null),s.removeAttribute("src"),s.load(),r()})),this.logVideoElement(),console.debug("VideoPlayer plugin initialized"),this.initialized=!0);const i=this.videoPlayer._videoEl;if(i!==void 0&&(i.isConnected||document.body.appendChild(i),i.setAttribute("crossorigin","anonymous"),i.setAttribute("muted",""),i.setAttribute("autoplay",""),i.setAttribute("playsinline",""),i.muted=!0,i.style.objectFit="cover"),this.videoPlayer.position(0,0),this.videoPlayer.size(e,t),this.videoPlayer.show(),console.debug("VideoPlayer shown on stage"),!this.opened){const s=Wo.DEMO_URL;this.videoPlayer.mute(!0),this.videoPlayer.open(s);const r=this.videoPlayer._videoEl;r!==void 0?r.play().catch(o=>{console.warn("Autoplay failed",o),this.videoPlayer.play()}):this.videoPlayer.play(),this.videoPlayer.loop(!0),this.opened=!0}if(this.appInstance!==null&&It.get("platform","textureMode")){const s=this.appInstance.tag("VideoTexture"),r=this.appInstance.tag("VideoBackground");s!==void 0&&r!==void 0&&(r.childList.add(s),s.patch({x:0,y:0,w:e,h:t,zIndex:2}),console.debug("Video texture added to stage"))}this.logVideoElement(),console.debug("VideoPlayer initialization complete")}};y(Wo,"DEMO_URL","https://stream.mux.com/7YtWnCpXIt014uMcBK65ZjGfnScdcAneU9TjM9nGAJhk.m3u8");let Wl=Wo;const Go=new Wl,Ab=Jl.Application({state(){return{stageW:window.innerWidth,stageH:window.innerHeight}},methods:{$videoPlayerEvent(n,e,t){console.debug(`VideoPlayer event: ${n} at ${t.toFixed(2)}s`,e)}},components:{Icon:u_},hooks:{init(){const n=this,e=()=>{n.stageW=window.innerWidth,n.stageH=window.innerHeight};n.resizeListener=e,window.addEventListener("resize",e),Go.setAppInstance(n),Go.initialize(n.stageW,n.stageH)},destroy(){const n=this;n.resizeListener&&window.removeEventListener("resize",n.resizeListener)}},code:{render:function(e,t,i,s,r,o,a){const l=[];let h,c,u,d=!1,f=0;const g={};l[0]=this.element({parent:e||"root"},d===!0?u:t),g.w=t.stageW,g.h=t.stageH,l[0].populate(g),d===!0&&(f-=1);const p=i.components&&i.components.Icon||s.Icon;e=l[0];const m={};l[1]=this.element({parent:e||"root"},d===!0?u:t),m.stageW=t.stageW,m.stageH=t.stageH;const _=[];if(typeof p<"u")for(let E in p[Symbol.for("config")].props)delete m[p[Symbol.for("config")].props[E]],_.push(p[Symbol.for("config")].props[E]);l[1].populate(m),d===!0&&(f-=1),e=l[1];const T={};c=t.stageW,Array.isArray(c)===!0&&(c=o(c).slice(0)),T.stageW=c,c=t.stageH,Array.isArray(c)===!0&&(c=o(c).slice(0)),T.stageH=c,h=T.is||"Icon";let S;if(typeof h=="string"){if(S=i.components&&i.components[h]||s[h],!S)throw new Error('Component "Icon" not found')}else typeof h=="function"&&h[Symbol.for("isComponent")]===!0&&(S=h);l[2]=S.call(null,{props:T},l[1],t),l[2][Symbol.for("slots")][0]?(e=l[2][Symbol.for("slots")][0],u=l[2],d=!0):e=l[2][Symbol.for("children")][0],d===!0&&f===0&&(d=!1),e=l[0];const v={};return l[3]=this.element({parent:e||"root"},d===!0?u:t),v.ref="VideoBackground",l[3].populate(v),d===!0&&(f-=1),l},effects:[function(e,t,i,s,r,o){t[0].set("w",e.stageW)},function(e,t,i,s,r,o){t[0].set("h",e.stageH)},function(e,t,i,s,r,o){(typeof skip1>"u"||skip1.indexOf("stageW")===-1)&&t[1].set("stageW",e.stageW)},function(e,t,i,s,r,o){(typeof skip1>"u"||skip1.indexOf("stageH")===-1)&&t[1].set("stageH",e.stageH)},function(e,t,i,s,r,o){t[2][Symbol.for("props")].stageW=e.stageW},function(e,t,i,s,r,o){t[2][Symbol.for("props")].stageH=e.stageH}],context:{}}}),Rb=100;function Cb(n,e){Jl.Launch(Ab,"app",{w:n,h:e})}function Zu(n,e){const i=document.getElementById("app").querySelector("canvas"),s=Go.getAppInstance();if(Cb(n,e),s!==null){const r=s;try{typeof r.quit=="function"?r.quit():typeof r.destroy=="function"&&r.destroy()}catch(o){console.warn("Failed to destroy previous Lightning app",o)}finally{Go.clearAppInstance()}}i!==null&&i.remove()}function Lb(){const n=c_(Zu,Rb);window.addEventListener("resize",()=>{n(window.innerWidth,window.innerHeight)}),Zu(window.innerWidth,window.innerHeight)}Lb();
